<!-- =========================
PART 1/2  (ëª¨ë“œ/ê¶Œí•œ/ê³µí†µìœ í‹¸/DOM ìŠ¤ì¼ˆë ˆí†¤ + Plates êµ¬ì¡° ì¶”ê°€)
â€» ì´ PART1 ëì— PART2ë¥¼ ë°”ë¡œ ì´ì–´ë¶™ì´ë©´ 1ê°œì˜ ì™„ì„± HTMLì´ ë¨
========================= -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#f9f4ff">
  <meta charset="UTF-8" />
  <title>FILM FIND - í•„ë¦„/íŒ ê´€ë¦¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- í°íŠ¸ (Pretendard) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css" />

  <style>
    :root{
      /* ê¸°ë³¸(ë¼ë²¤ë”) */
      --bg-gradient: linear-gradient(145deg, #f9fafb, #f4f0ff, #fdf2f8);
      --card-bg: rgba(255,255,255,0.98);
      --card-border: #e3e6ff;
      --shadow-soft: 0 8px 20px rgba(167, 173, 208, 0.35);

      --text-main: #272a3f;
      --text-sub: #767a98;
      --text-muted: #777b9e;
      --label-color: #8689a5;

      --primary-1: #7f9dff;
      --primary-2: #b38cff;
      --primary-soft: rgba(228,231,255,0.95);

      --chip-bg: #f3e8ff;
      --chip-text: #5f308c;

      --danger-bg: #ff6b81;
      --danger-text: #ffffff;

      --pill-bg: rgba(228,231,255,0.98);
      --pill-border: rgba(129, 140, 248, 0.4);

      --toast-bg: rgba(15,23,42,0.9);
      --toast-text: #f9fafb;

      --spinner-border: rgba(191, 219, 254, 0.9);
      --spinner-glow: rgba(129, 140, 248, 0.7);
    }

    /* ë¯¼íŠ¸ */
    [data-theme="mint"]{
      --bg-gradient: linear-gradient(145deg, #f0fdfa, #e0f2fe, #fefce8);
      --primary-1: #34d399;
      --primary-2: #22c55e;
      --primary-soft: rgba(187,247,208,0.85);
      --chip-bg: #dcfce7;
      --chip-text: #047857;
      --pill-bg: rgba(219, 234, 254, 0.96);
      --pill-border: rgba(45, 212, 191, 0.5);
      --spinner-border: rgba(167, 243, 208, 0.9);
      --spinner-glow: rgba(45, 212, 191, 0.7);
    }

    /* í”¼ì¹˜ */
    [data-theme="peach"]{
      --bg-gradient: linear-gradient(145deg, #fff7ed, #fee2e2, #fef9c3);
      --primary-1: #fb7185;
      --primary-2: #f97316;
      --primary-soft: rgba(254, 226, 226, 0.9);
      --chip-bg: #ffe4e6;
      --chip-text: #be123c;
      --pill-bg: rgba(254, 226, 226, 0.96);
      --pill-border: rgba(248, 113, 113, 0.55);
      --spinner-border: rgba(254, 202, 202, 0.9);
      --spinner-glow: rgba(248, 113, 113, 0.75);
    }

    /* ë‚˜ì´íŠ¸ */
    [data-theme="night"]{
      --bg-gradient: radial-gradient(circle at top, #020617, #020617, #111827);
      --card-bg: rgba(15,23,42,0.98);
      --card-border: #1f2937;
      --shadow-soft: 0 10px 24px rgba(15, 23, 42, 0.75);

      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --text-muted: #9ca3af;
      --label-color: #9ca3af;

      --primary-1: #6366f1;
      --primary-2: #a855f7;
      --primary-soft: rgba(79,70,229,0.22);

      --chip-bg: rgba(79,70,229,0.18);
      --chip-text: #a5b4fc;

      --danger-bg: #f97373;
      --danger-text: #111827;

      --pill-bg: rgba(17,24,39,0.95);
      --pill-border: rgba(129, 140, 248, 0.8);

      --toast-bg: rgba(17,24,39,0.95);
      --toast-text: #e5e7eb;

      --spinner-border: rgba(55, 65, 81, 0.9);
      --spinner-glow: rgba(129, 140, 248, 0.85);
    }

    *{ box-sizing:border-box; font-family:"Pretendard Variable",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; }
    body{ margin:0; min-height:100vh; background:var(--bg-gradient); padding:12px; color:var(--text-main); }
    .app-shell{ max-width:720px; margin:0 auto; }

    .app-header{
      max-width:720px; margin:0 auto 6px;
      display:flex; align-items:center; justify-content:space-between; gap:8px;
    }
    .title-wrap{ display:flex; flex-direction:column; gap:2px; }
    .app-title{ font-size:20px; font-weight:700; letter-spacing:2px; color:var(--text-main); }
    .app-subtitle{ font-size:11px; color:var(--text-sub); }
    .device-badge{
      font-size:11px; padding:4px 12px; border-radius:999px;
      background:var(--pill-bg); color:var(--text-sub);
      white-space:nowrap; max-width:150px; text-overflow:ellipsis; overflow:hidden;
      border:1px solid var(--pill-border);
      box-shadow:0 0 8px rgba(129,140,248,0.28);
      display:flex; align-items:center; gap:4px; justify-content:flex-end;
    }
    .device-dot{ width:6px; height:6px; border-radius:999px; background:var(--primary-1); box-shadow:0 0 6px rgba(129,140,248,0.9); }

    .top-bar{ display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap; }
    .top-bar input[type="text"]{
      flex:1; padding:9px 11px; border-radius:999px; border:1px solid var(--card-border);
      font-size:14px; min-width:0; background:rgba(255,255,255,0.9); color:var(--text-main);
    }
    .top-bar input::placeholder{ color:var(--text-muted); }
    [data-theme="night"] .top-bar input[type="text"]{ background:#020617; border-color:#1f2937; }

    .btn{
      padding:8px 11px; border-radius:999px; border:none; font-size:13px;
      cursor:pointer; white-space:nowrap;
      transition:transform .05s ease, box-shadow .1s ease, background .1s ease, opacity .1s ease;
    }
    .btn:active{ transform:translateY(1px); box-shadow:none; opacity:.92; }
    .btn-primary{ background:linear-gradient(135deg,var(--primary-1),var(--primary-2)); color:#fff; box-shadow:0 4px 10px rgba(127,157,255,.35); }
    .btn-secondary{ background:var(--primary-soft); color:#283252; }
    [data-theme="night"] .btn-secondary{ color:#e5e7eb; }
    .btn-danger{ background:var(--danger-bg); color:var(--danger-text); }
    .btn-small{ font-size:12px; padding:5px 9px; border-radius:999px; }

    .tools-bar{ display:flex; gap:6px; margin-bottom:6px; flex-wrap:wrap; justify-content:flex-end; }

    .count-wrap{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:10px; }
    .count-bar{ font-size:11px; color:var(--text-muted); text-align:left; flex:1; }
    .count-bar strong{ color:var(--primary-1); }

    .tabs-bar{ display:flex; gap:6px; margin:6px 0 10px; flex-wrap:wrap; }
    .tab-btn{
      padding:7px 12px; border-radius:999px; border:1px solid var(--card-border);
      background:rgba(255,255,255,0.85); color:var(--text-main);
      font-size:13px; cursor:pointer;
    }
    [data-theme="night"] .tab-btn{ background:rgba(2,6,23,0.85); }
    .tab-btn.active{
      border-color:var(--primary-1);
      background:linear-gradient(135deg,var(--primary-1),var(--primary-2));
      color:#fff;
    }

    .form-card{
      background:var(--card-bg);
      border-radius:18px;
      padding:12px 14px;
      margin-bottom:12px;
      box-shadow:var(--shadow-soft);
      border:1px solid var(--card-border);
    }
    .form-row{ display:flex; flex-direction:column; margin-bottom:9px; }
    .form-row label{ font-size:12px; margin-bottom:4px; color:var(--label-color); }
    .form-row input[type="text"],
    .form-row input[type="date"],
    .form-row input[type="password"],
    .form-row input[type="number"],
    .form-row select{
      padding:7px 10px;
      border-radius:10px;
      border:1px solid var(--card-border);
      font-size:13px;
      background:#f9f9ff;
      color:var(--text-main);
    }
    [data-theme="night"] .form-row input[type="text"],
    [data-theme="night"] .form-row input[type="date"],
    [data-theme="night"] .form-row input[type="password"],
    [data-theme="night"] .form-row input[type="number"],
    [data-theme="night"] .form-row select{
      background:#020617;
      border-color:#1f2937;
      color:#e5e7eb;
    }
    .form-row input[type="file"]{ font-size:12px; }
    .form-actions{ display:flex; justify-content:flex-end; gap:6px; margin-top:6px; }

    .list{ display:flex; flex-direction:column; gap:10px; margin-bottom:24px; }
    .list.gallery{ display:grid; grid-template-columns:1fr; gap:12px; }
    .list.gallery .card{ flex-direction:column; align-items:stretch; }
    .list.gallery .card img{ width:100%; height:180px; object-fit:cover; }

    .card{
      background:rgba(255,255,255,0.96);
      border-radius:16px;
      padding:10px;
      display:flex;
      gap:10px;
      box-shadow:0 6px 16px rgba(169, 177, 214, 0.35);
      align-items:flex-start;
      border:1px solid var(--card-border);
      animation:cardFadeIn .18s ease-out;
    }
    [data-theme="night"] .card{ background:rgba(15,23,42,0.98); box-shadow:0 8px 22px rgba(15,23,42,0.85); }
    @keyframes cardFadeIn{ from{ opacity:0; transform:translateY(4px);} to{ opacity:1; transform:translateY(0);} }

    .card img{
      width:70px; height:70px; object-fit:cover; border-radius:12px;
      background:#eef1ff; flex-shrink:0; cursor:pointer;
    }
    .card-content{ flex:1; font-size:13px; }
    .card-row-main{ display:flex; justify-content:space-between; gap:6px; margin-bottom:4px; align-items:center; }
    .card-title{ font-weight:600; font-size:14px; color:var(--text-main); }
    .card-tag{ font-size:11px; padding:3px 7px; border-radius:999px; background:var(--chip-bg); color:var(--chip-text); align-self:flex-start; }
    .card-row{ margin-bottom:2px; color:var(--text-main); }
    .label{ color:var(--label-color); font-size:11px; margin-right:4px; }
    .card-footer{ display:flex; justify-content:space-between; align-items:center; margin-top:4px; gap:6px; flex-wrap:wrap; }
    .last-used{ font-size:11px; color:var(--text-muted); }
    .card-buttons{ display:flex; gap:4px; flex-wrap:wrap; }

    .warn-pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:3px 8px; border-radius:999px; font-size:11px;
      border:1px solid rgba(248,113,113,0.35);
      background:rgba(254,202,202,0.45);
      color:#7f1d1d;
    }
    [data-theme="night"] .warn-pill{
      background:rgba(248,113,113,0.18);
      color:#fecaca;
      border-color:rgba(248,113,113,0.35);
    }

    .empty-text{ text-align:center; color:#777; font-size:13px; margin-top:20px; }
    [data-theme="night"] .empty-text{ color:#9ca3af; }

    .toggle-group{ display:flex; gap:6px; margin-bottom:4px; flex-wrap:wrap; }
    .toggle-btn{
      padding:5px 10px; font-size:12px; border-radius:999px;
      border:1px solid var(--card-border);
      background:#f5f3ff; color:#464b73; cursor:pointer;
      transition:background .1s ease, color .1s ease, border .1s ease;
    }
    .toggle-btn.active{ border-color:var(--primary-1); background:var(--primary-1); color:#fff; }

    /* ì ê¸ˆ í™”ë©´ (íŒíŠ¸/ë¬¸êµ¬/ì„¤ëª… ì—†ìŒ) */
    .lock-screen{
      position:fixed; inset:0;
      background:radial-gradient(circle at top, rgba(255,255,255,0.95), rgba(203,213,255,0.96));
      display:flex; align-items:center; justify-content:center;
      padding:16px; z-index:1000;
    }
    .lock-card{
      width:100%; max-width:320px; margin:0 auto;
      background:rgba(255,255,255,0.98);
      border-radius:20px;
      padding:18px 18px 16px;
      box-shadow:0 12px 28px rgba(136, 144, 195, 0.55);
      border:1px solid #dde1ff;
      text-align:center;
    }
    .lock-input-wrap{ display:flex; gap:8px; margin-bottom:0; align-items:center; justify-content:space-between; }
    .lock-input-wrap input{
      flex:1; padding:8px 10px; border-radius:999px;
      border:1px solid #d6d9ff; background:#f7f7ff;
      text-align:center; font-size:14px; letter-spacing:3px; min-width:0;
    }

    .settings-section-title{ font-size:13px; font-weight:600; margin-bottom:4px; color:#3c4266; }
    .settings-help{ font-size:11px; color:#8a8fb0; margin-bottom:6px; }
    [data-theme="night"] .settings-section-title{ color:#e5e7eb; }
    [data-theme="night"] .settings-help{ color:#9ca3af; }

    /* ì´ë¯¸ì§€ ì „ì²´ ë³´ê¸° */
    .image-viewer{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1500; }
    .image-viewer-backdrop{ position:absolute; inset:0; background:rgba(15, 23, 42, 0.75); }
    .image-viewer-inner{ position:relative; max-width:100%; max-height:100%; display:flex; align-items:center; justify-content:center; padding:16px; }
    #viewerImage{ max-width:100%; max-height:100%; border-radius:12px; box-shadow:0 16px 40px rgba(0,0,0,0.5); touch-action:none; transition:transform 0.1s ease-out; }
    .viewer-close-btn{ position:absolute; top:16px; right:16px; border-radius:999px; border:none; padding:6px 10px; font-size:14px; cursor:pointer; background:rgba(15,23,42,0.8); color:#f9fafb; }

    /* ê¸°ê¸° ì´ë¦„ ìµœì´ˆ ì…ë ¥ ëª¨ë‹¬ */
    .device-modal{ position:fixed; inset:0; background:rgba(15,23,42,0.35); display:none; align-items:center; justify-content:center; z-index:1200; padding:16px; }
    .device-modal-card{ background:#fff; border-radius:18px; padding:16px 18px 14px; max-width:320px; width:100%; box-shadow:0 10px 24px rgba(0,0,0,0.25); }
    .device-modal-title{ font-size:15px; font-weight:600; margin-bottom:6px; color:#272a3f; }
    .device-modal-text{ font-size:12px; color:#767a98; margin-bottom:10px; }
    .device-modal-input{ width:100%; padding:7px 10px; border-radius:10px; border:1px solid #d6d9ff; font-size:13px; background:#f9f9ff; margin-bottom:10px; }
    .device-modal-actions{ display:flex; justify-content:flex-end; gap:6px; }

    /* í† ìŠ¤íŠ¸ */
    .toast{
      position:fixed; bottom:16px; left:50%;
      transform:translateX(-50%) translateY(40px);
      background:var(--toast-bg); color:var(--toast-text);
      padding:8px 14px; border-radius:999px; font-size:12px;
      opacity:0; pointer-events:none;
      transition:opacity .2s ease, transform .2s ease;
      z-index:2000; max-width:80%;
      text-align:center; white-space:nowrap; text-overflow:ellipsis; overflow:hidden;
      box-shadow:0 10px 24px rgba(15,23,42,0.6);
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }

    /* íˆìŠ¤í† ë¦¬ íƒ€ì„ë¼ì¸ */
    .history-list{ max-height:280px; overflow-y:auto; padding-right:4px; margin-top:4px; position:relative; }
    .history-list::before{ content:""; position:absolute; left:8px; top:0; bottom:0; width:2px; background:linear-gradient(to bottom, rgba(148,163,184,0.6), rgba(199,210,254,0.2)); }
    .history-row{ font-size:12px; color:#444867; padding:6px 2px 6px 20px; position:relative; }
    [data-theme="night"] .history-row{ color:#e5e7eb; }
    .history-row::before{ content:""; position:absolute; left:4px; top:10px; width:8px; height:8px; border-radius:999px; background:#fff; border:2px solid var(--primary-1); box-shadow:0 0 0 4px rgba(129,140,248,0.15); }
    .history-time{ color:#6b6f90; font-size:11px; }
    [data-theme="night"] .history-time{ color:#9ca3af; }
    .history-device{ color:var(--primary-1); font-size:11px; margin-left:4px; }
    .history-action-chip{ display:inline-block; margin-left:6px; padding:1px 6px; border-radius:999px; font-size:11px; background:var(--chip-bg); color:var(--chip-text); }
    .history-film{ color:#111827; font-weight:500; }
    [data-theme="night"] .history-film{ color:#e5e7eb; }
    .history-changes{ font-size:11px; color:#6b7280; margin-top:2px; }
    [data-theme="night"] .history-changes{ color:#9ca3af; }
    .history-empty{ font-size:12px; color:#6b7280; padding-left:20px; margin-top:6px; }
    [data-theme="night"] .history-empty{ color:#9ca3af; }

    /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
    .spinner-wrapper{ display:none; justify-content:center; align-items:center; padding:4px 0 16px; }
    .spinner-wrapper.show{ display:flex; }
    .spinner-circle{
      width:28px; height:28px; border-radius:999px;
      border:3px solid var(--spinner-border);
      border-top-color:var(--primary-1);
      box-shadow:0 0 12px var(--spinner-glow);
      animation:spin .8s linear infinite;
    }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    /* ë§¨ ìœ„ë¡œ */
    .scroll-top-btn{
      position:fixed; right:16px; bottom:24px;
      width:36px; height:36px; border-radius:999px; border:none;
      font-size:18px; cursor:pointer;
      background:linear-gradient(135deg,var(--primary-1),var(--primary-2));
      color:#fff; display:none; align-items:center; justify-content:center;
      box-shadow:0 10px 24px rgba(107,114,128,0.6);
      z-index:1900;
    }
    .scroll-top-btn.show{ display:flex; }

    @media (min-width:768px){ body{ padding-top:24px; } }
    @media (min-width:600px){ .list.gallery{ grid-template-columns:repeat(2, minmax(0,1fr)); } }
    @media (min-width:1024px){
      .app-shell, .app-header{ max-width:1080px; }
      .list.gallery{ grid-template-columns:repeat(3, minmax(260px,1fr)); }
    }

    /* ====== ë©”ëª¨: ìŠ¬ë¼ì´ë“œ(ë°”í…€ ì‹œíŠ¸) (í•„ë¦„/íŒ ê³µìš©) ====== */
    .memo-sheet{ position:fixed; inset:0; display:none; align-items:flex-end; justify-content:center; z-index:1600; }
    .memo-sheet.show{ display:flex; }
    .memo-sheet-backdrop{ position:absolute; inset:0; background:rgba(15, 23, 42, 0.45); }
    .memo-sheet-panel{
      position:relative; width:100%; max-width:720px;
      background:var(--card-bg); border:1px solid var(--card-border);
      border-radius:18px 18px 0 0;
      box-shadow:0 -12px 28px rgba(0,0,0,0.25);
      padding:12px 14px 14px;
      animation:sheetUp .16s ease-out;
    }
    @keyframes sheetUp{ from{ transform:translateY(14px); opacity:0; } to{ transform:translateY(0); opacity:1; } }
    .memo-sheet-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .memo-sheet-title{ font-size:14px; font-weight:700; color:var(--text-main); }
    .memo-sheet-sub{ font-size:11px; color:var(--text-sub); margin-top:2px; }
    .memo-sheet-textarea{
      width:100%; min-height:120px; resize:vertical;
      padding:10px; border-radius:12px;
      border:1px solid var(--card-border);
      background:#f9f9ff; color:var(--text-main);
      font-size:13px; line-height:1.45;
    }
    [data-theme="night"] .memo-sheet-textarea{ background:#020617; border-color:#1f2937; color:#e5e7eb; }
    .memo-sheet-actions{ display:flex; justify-content:flex-end; gap:6px; margin-top:10px; }
    .btn-memo-has{ box-shadow:0 0 0 2px rgba(127,157,255,0.18) inset; }

    /* ====== íˆìŠ¤í† ë¦¬: ì—°í•„ ë²„íŠ¼ + ë…¸íŠ¸ í‘œì‹œ ====== */
    .history-headline{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .history-pencil{ border:none; cursor:pointer; padding:4px 8px; border-radius:999px; font-size:12px; background:var(--primary-soft); color:var(--text-main); }
    [data-theme="night"] .history-pencil{ color:#e5e7eb; }
    .history-note{
      margin-top:6px; padding:8px 10px; border-radius:12px;
      border:1px solid var(--card-border);
      background:rgba(228,231,255,0.65);
      font-size:12px; color:var(--text-main);
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
    }
    [data-theme="night"] .history-note{ background:rgba(79,70,229,0.18); border-color:#1f2937; }

    /* ====== íˆìŠ¤í† ë¦¬ ë©”ëª¨ ëª¨ë‹¬ ====== */
    .note-modal{ position:fixed; inset:0; background:rgba(15,23,42,0.35); display:none; align-items:center; justify-content:center; z-index:1700; padding:16px; }
    .note-modal.show{ display:flex; }
    .note-modal-card{ background:var(--card-bg); border:1px solid var(--card-border); border-radius:18px; padding:16px 18px 14px; max-width:380px; width:100%; box-shadow:0 10px 24px rgba(0,0,0,0.25); }
    .note-modal-title{ font-size:15px; font-weight:700; margin-bottom:6px; color:var(--text-main); }
    .note-modal-text{ font-size:12px; color:var(--text-sub); margin-bottom:10px; }
    .note-modal-textarea{ width:100%; min-height:120px; resize:vertical; padding:10px; border-radius:12px; border:1px solid var(--card-border); background:#f9f9ff; color:var(--text-main); font-size:13px; line-height:1.45; }
    [data-theme="night"] .note-modal-textarea{ background:#020617; border-color:#1f2937; color:#e5e7eb; }
    .note-modal-actions{ display:flex; justify-content:flex-end; gap:6px; margin-top:10px; }

    /* ====== íŒ ì‚¬ìš©ë“±ë¡ ëª¨ë‹¬ ====== */
    .use-modal{ position:fixed; inset:0; background:rgba(15,23,42,0.35); display:none; align-items:center; justify-content:center; z-index:1750; padding:16px; }
    .use-modal.show{ display:flex; }
    .use-modal-card{ background:var(--card-bg); border:1px solid var(--card-border); border-radius:18px; padding:16px 18px 14px; max-width:420px; width:100%; box-shadow:0 10px 24px rgba(0,0,0,0.25); }
    .use-modal-title{ font-size:15px; font-weight:700; margin-bottom:6px; color:var(--text-main); }
    .use-modal-sub{ font-size:12px; color:var(--text-sub); margin-bottom:10px; }
    .use-modal-actions{ display:flex; justify-content:flex-end; gap:6px; margin-top:10px; }

    /* ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë¬¸êµ¬(1ì¤„) ê¹¨ì§ ë°©ì§€ */
    .admin-pw-line{
      font-size:12px; color:var(--text-sub);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; word-break:keep-all;
    }
  </style>
</head>

<body>
  <!-- ì ê¸ˆ í™”ë©´ -->
  <div id="lockScreen" class="lock-screen">
    <div class="lock-card">
      <div class="lock-input-wrap">
        <input type="password" id="passwordInput" maxlength="20" placeholder="â€¢â€¢â€¢â€¢" />
        <button class="btn btn-primary btn-small" id="passwordBtn">ì…ì¥</button>
      </div>
    </div>
  </div>

  <!-- ê¸°ê¸° ì´ë¦„ ìµœì´ˆ ì…ë ¥ ëª¨ë‹¬ -->
  <div id="deviceModal" class="device-modal">
    <div class="device-modal-card">
      <div class="device-modal-title">ì´ ê¸°ê¸° ì´ë¦„ ì •í•˜ê¸°</div>
      <div class="device-modal-text">
        ì˜ˆ: ê°€ì€í°, ì„±ê·œíŒ¨ë“œ, íšŒì‚¬PC ê°™ì€ ì‹ìœ¼ë¡œ ì ì–´ì¤˜.<br />
        ê¸°ë¡Â·ë™ê¸°í™”í•  ë•Œ ì–´ë””ì—ì„œ ì…ë ¥í–ˆëŠ”ì§€ í™•ì¸í•˜ê¸° ì‰¬ì›Œì ¸.
      </div>
      <input id="deviceModalInput" class="device-modal-input" type="text" placeholder="ì˜ˆ: ê°€ì€í°" />
      <div class="device-modal-actions">
        <button class="btn btn-secondary btn-small" id="deviceModalSkip">ë‚˜ì¤‘ì—</button>
        <button class="btn btn-primary btn-small" id="deviceModalSave">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ì´ë¯¸ì§€ ì „ì²´ë³´ê¸° -->
  <div id="imageViewer" class="image-viewer">
    <div class="image-viewer-backdrop" id="viewerBackdrop"></div>
    <div class="image-viewer-inner">
      <img id="viewerImage" src="" alt="ì´ë¯¸ì§€" />
      <button id="closeViewerBtn" class="viewer-close-btn">âœ•</button>
    </div>
  </div>

  <!-- í† ìŠ¤íŠ¸ -->
  <div id="toast" class="toast"></div>

  <!-- ====== ë©”ëª¨ ìŠ¬ë¼ì´ë“œ ====== -->
  <div id="memoSheet" class="memo-sheet">
    <div id="memoSheetBackdrop" class="memo-sheet-backdrop"></div>
    <div class="memo-sheet-panel">
      <div class="memo-sheet-head">
        <div>
          <div class="memo-sheet-title" id="memoSheetTitle">ë©”ëª¨</div>
          <div class="memo-sheet-sub" id="memoSheetSub"></div>
        </div>
        <button class="btn btn-secondary btn-small" id="memoSheetCloseBtn">ë‹«ê¸°</button>
      </div>
      <textarea id="memoTextarea" class="memo-sheet-textarea" placeholder=""></textarea>
      <div class="memo-sheet-actions">
        <button class="btn btn-secondary btn-small" id="memoSheetCancelBtn">ì·¨ì†Œ</button>
        <button class="btn btn-primary btn-small" id="memoSheetSaveBtn">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ====== íˆìŠ¤í† ë¦¬ ë©”ëª¨ ëª¨ë‹¬ ====== -->
  <div id="historyNoteModal" class="note-modal">
    <div class="note-modal-card">
      <div class="note-modal-title">íˆìŠ¤í† ë¦¬ ë©”ëª¨</div>
      <div class="note-modal-text">ì´ ë³€ê²½ ê¸°ë¡ì— â€œì™œ ë°”ë€Œì—ˆëŠ”ì§€â€ë¥¼ ì ì–´ë‘˜ ìˆ˜ ìˆì–´.</div>
      <textarea id="historyNoteTextarea" class="note-modal-textarea" placeholder="ì˜ˆ: ê²¹ì¹¨ ì´ìŠˆë¡œ 4-2-1.6ë²ˆìœ¼ë¡œ ì´ë™"></textarea>
      <div class="note-modal-actions">
        <button class="btn btn-secondary btn-small" id="historyNoteCancelBtn">ì·¨ì†Œ</button>
        <button class="btn btn-primary btn-small" id="historyNoteSaveBtn">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ====== íŒ ì‚¬ìš©ë“±ë¡ ëª¨ë‹¬ ====== -->
  <div id="plateUseModal" class="use-modal">
    <div class="use-modal-card">
      <div class="use-modal-title" id="plateUseTitle">íŒ ì‚¬ìš©ë“±ë¡</div>
      <div class="use-modal-sub" id="plateUseSub"></div>

      <div class="form-row">
        <label for="useWhoSelect">ì¸ì‡„ê¸°ì‚¬</label>
        <select id="useWhoSelect">
          <option value="">ì„ íƒ ì•ˆ í•¨</option>
          <option value="ì´ì°½ë¯¼ ë¶€ì¥ë‹˜">ì´ì°½ë¯¼ ë¶€ì¥ë‹˜</option>
          <option value="ê³ ê´‘ìš´ ê³¼ì¥ë‹˜">ê³ ê´‘ìš´ ê³¼ì¥ë‹˜</option>
          <option value="ê¹€ê·œí—Œ ì°¨ì¥ë‹˜">ê¹€ê·œí—Œ ì°¨ì¥ë‹˜</option>
          <option value="ë°•ì¬í˜„ ëŒ€ë¦¬ë‹˜">ë°•ì¬í˜„ ëŒ€ë¦¬ë‹˜</option>
          <option value="ì¡°ì˜ë¹ˆ ëŒ€ë¦¬ë‹˜">ì¡°ì˜ë¹ˆ ëŒ€ë¦¬ë‹˜</option>
          <option value="ê¹€í˜„ê·œ ëŒ€ë¦¬ë‹˜">ê¹€í˜„ê·œ ëŒ€ë¦¬ë‹˜</option>
          <option value="ì¥ì§„ìš° ëŒ€ë¦¬ë‹˜">ì¥ì§„ìš° ëŒ€ë¦¬ë‹˜</option>
          <option value="ê¹€ë¯¸ì€ ì£¼ì„ë‹˜">ê¹€ë¯¸ì€ ì£¼ì„ë‹˜</option>
          <option value="ì´ìˆ˜ì•ˆ ì‚¬ì›ë‹˜">ì´ìˆ˜ì•ˆ ì‚¬ì›ë‹˜</option>
          <option value="ë°•ì§€ì•ˆ ì‚¬ì›ë‹˜">ë°•ì§€ì•ˆ ì‚¬ì›ë‹˜</option>
          <option value="ê¹€ì¸ì„  ì‚¬ì›ë‹˜">ê¹€ì¸ì„  ì‚¬ì›ë‹˜</option>
          <option value="ê¹€ìš©ì› ì‚¬ì›ë‹˜">ê¹€ìš©ì› ì‚¬ì›ë‹˜</option>
          <option value="ìµœì„±ê·œ ì‚¬ì›ë‹˜">ìµœì„±ê·œ ì‚¬ì›ë‹˜</option>
        </select>
      </div>

      <div class="form-row">
        <label for="useQtyInput">ì¸ì‡„ ìˆ˜ëŸ‰</label>
        <input type="number" id="useQtyInput" min="0" step="1" placeholder="ì˜ˆ: 1200" />
      </div>

      <div class="form-row">
        <label for="useMemoInput">ë©”ëª¨</label>
        <input type="text" id="useMemoInput" placeholder="ì˜ˆ: 1ì°¨ / ì‰í¬ A / ì£¼ì˜ì‚¬í•­..." />
      </div>

      <div class="use-modal-actions">
        <button class="btn btn-secondary btn-small" id="plateUseCancelBtn">ì·¨ì†Œ</button>
        <button class="btn btn-primary btn-small" id="plateUseSaveBtn">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ì‹¤ì œ ì•± -->
  <div id="appContainer" style="display:none;">
    <div class="app-header">
      <div class="title-wrap">
        <div class="app-title">FILM FIND</div>
        <div class="app-subtitle" id="headerSubtitle">í•„ë¦„/íŒ ê´€ë¦¬</div>
      </div>
      <div id="deviceBadge" class="device-badge">
        <span class="device-dot"></span>
        <span id="deviceBadgeText"></span>
      </div>
    </div>

    <div class="app-shell">
      <div class="top-bar">
        <input type="text" id="searchInput" placeholder="ê²€ìƒ‰" />
        <button class="btn btn-primary" id="newFilmBtn">+ ìƒˆ í•„ë¦„</button>
        <button class="btn btn-primary" id="newPlateFromFilmBtn" style="display:none;">+ ìƒˆ íŒ</button>
      </div>

      <div class="tools-bar">
        <button class="btn btn-secondary btn-small" id="settingsBtn">âš™ ì„¤ì •</button>
        <button class="btn btn-secondary btn-small" id="historyBtn">ğŸ“œ íˆìŠ¤í† ë¦¬</button>
        <button class="btn btn-secondary btn-small" id="exportBtn">ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
        <button class="btn btn-secondary btn-small" id="importBtn">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <input type="file" id="importFile" accept="application/json" style="display:none;" />
      </div>

      <!-- íƒ­ -->
      <div class="tabs-bar" id="tabsBar" style="display:none;">
        <button class="tab-btn" id="tabFilmsBtn">í•„ë¦„</button>
        <button class="tab-btn" id="tabPlatesBtn">íŒ</button>
      </div>

      <div class="count-wrap">
        <div id="countBar" class="count-bar">ì´ 0ê°œ</div>
        <button class="btn btn-secondary btn-small" id="viewToggleBtn">ê°¤ëŸ¬ë¦¬</button>
      </div>

      <!-- ì„¤ì • ì¹´ë“œ -->
      <div class="form-card" id="settingsCard" style="display:none;">
        <div class="form-row">
          <div class="settings-section-title">ì´ ê¸°ê¸° ì´ë¦„</div>
          <div class="settings-help">ì˜ˆ: ê°€ì€í°, ì„±ê·œíŒ¨ë“œ, íšŒì‚¬PC. ì´ ê¸°ê¸°ì—ì„œë§Œ í‘œì‹œë¼.</div>
          <input type="text" id="deviceNameInput" placeholder="ê¸°ê¸° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" />
        </div>

        <div class="form-row">
          <div class="settings-section-title">ê¸°ë³¸ ì •ë ¬ ë°©ì‹</div>
          <div class="settings-help">ë¦¬ìŠ¤íŠ¸ë¥¼ ì–´ë–¤ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í• ì§€ ì„ íƒí•´.</div>
          <select id="sortOptionSelect">
            <option value="updated">ìµœê·¼ ìˆ˜ì •ìˆœ</option>
            <option value="name">ì œí’ˆëª… ê°€ë‚˜ë‹¤ìˆœ</option>
            <option value="number">í•„ë¦„ë²ˆí˜¸ ìˆœ</option>
            <option value="lastUsed">ë§ˆì§€ë§‰ ì‚¬ìš©ì¼ ìµœì‹ ìˆœ</option>
          </select>
        </div>

        <div class="form-row">
          <div class="settings-section-title">í…Œë§ˆ ìƒ‰ìƒ</div>
          <div class="settings-help">ì•±ì˜ ìƒ‰ ë¶„ìœ„ê¸°ë¥¼ ì„ íƒí•´ ì¤˜.</div>
          <select id="themeSelect">
            <option value="default">ë¼ë²¤ë”</option>
            <option value="mint">ë¯¼íŠ¸</option>
            <option value="peach">í”¼ì¹˜</option>
            <option value="night">ë‚˜ì´íŠ¸</option>
          </select>
        </div>

        <!-- ê´€ë¦¬ì ì „ìš©: ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ -->
        <div class="form-row" id="pwSection" style="display:none;">
          <div class="settings-section-title">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</div>
          <div class="settings-help">ê´€ë¦¬ìë§Œ ë³€ê²½ ê°€ëŠ¥</div>
          <div class="admin-pw-line" id="adminPwLine">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸: -</div>

          <input type="password" id="adminPwCurrentInput" placeholder="í˜„ì¬ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸" style="margin-top:8px;" />
          <input type="password" id="adminPwNewInput" placeholder="ìƒˆ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸" style="margin-top:6px;" />
          <input type="password" id="adminPwNewConfirmInput" placeholder="ìƒˆ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ í™•ì¸" style="margin-top:6px;" />

          <div class="settings-help" style="margin-top:10px;">ì¸ì‡„ê¸°ì‚¬/ì¡°íšŒ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</div>
          <input type="password" id="printerPwNewInput" placeholder="ìƒˆ ì¸ì‡„ê¸°ì‚¬ ë¹„ë°€ë²ˆí˜¸" />
          <input type="password" id="viewerPwNewInput" placeholder="ìƒˆ ì¡°íšŒ ë¹„ë°€ë²ˆí˜¸" style="margin-top:6px;" />
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary btn-small" id="closeSettingsBtn">ë‹«ê¸°</button>
          <button type="button" class="btn btn-primary btn-small" id="saveSettingsBtn">ì €ì¥</button>
        </div>
      </div>

      <!-- íˆìŠ¤í† ë¦¬ ì¹´ë“œ -->
      <div class="form-card" id="historyCard" style="display:none;">
        <div class="settings-section-title">ğŸ“œ íˆìŠ¤í† ë¦¬</div>
        <div class="settings-help">
          ë“±ë¡ / ìˆ˜ì • / ì‚­ì œ / ì˜¤ëŠ˜ ì‚¬ìš© ê¸°ë¡ì„ ìµœê·¼ 100ê°œê¹Œì§€ ë³´ì—¬ì¤„ê²Œ.<br>
          (ê¸°ê¸° ì´ë¦„ê³¼ ì–´ë–¤ í•­ëª©ì´ ë°”ë€Œì—ˆëŠ”ì§€ë„ ê°™ì´ í‘œì‹œë¼.)
        </div>
        <div id="historyList" class="history-list"></div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary btn-small" id="closeHistoryBtn">ë‹«ê¸°</button>
        </div>
      </div>

      <!-- í•„ë¦„ ì…ë ¥ í¼ -->
      <div class="form-card" id="formCard" style="display:none;">
        <form id="filmForm">
          <input type="hidden" id="filmId" />
          <div class="form-row">
            <label for="productName">ì œí’ˆ ì´ë¦„ *</label>
            <input type="text" id="productName" required />
          </div>
          <div class="form-row">
            <label for="filmNumber">í•„ë¦„ ë²ˆí˜¸ *</label>
            <input type="text" id="filmNumber" required />
          </div>
          <div class="form-row">
            <label for="method">ì œíŒ íƒ€ì…</label>
            <input type="text" id="method" placeholder="ì˜ˆ: ë°”íƒ•, ë¬¸ì, ìŠ¤ëª¨ê·¸ ë“±" />
          </div>

          <div class="form-row">
            <label for="mesh">MESH</label>
            <input type="text" id="mesh" placeholder="ì˜ˆ: 180T, 200ë©”ì‰¬ ë“±" />
          </div>

          <div class="form-row">
            <label>í•„ë¦„ ì œíŒ ë°©ë²•</label>
            <div class="toggle-group" data-group="frontBack">
              <button type="button" class="toggle-btn" data-value="ì „ë©´">ì „ë©´</button>
              <button type="button" class="toggle-btn" data-value="ë°°ë©´">ë°°ë©´</button>
            </div>
            <div class="toggle-group" data-group="leftRight">
              <button type="button" class="toggle-btn" data-value="ì¢Œ">ì¢Œ</button>
              <button type="button" class="toggle-btn" data-value="ìš°">ìš°</button>
            </div>
            <div class="toggle-group" data-group="upDown">
              <button type="button" class="toggle-btn" data-value="ìƒ">ìƒ</button>
              <button type="button" class="toggle-btn" data-value="í•˜">í•˜</button>
            </div>
            <small style="font-size:11px; color:var(--text-sub);">
              ì „ë©´/ë°°ë©´ + ì¢Œ/ìš° + ìƒ/í•˜ ì¡°í•© (ì˜ˆ: ë°°ë©´ ì¢Œìƒ, ì „ë©´ ìš°í•˜ ë“±)
            </small>
          </div>

          <div class="form-row">
            <label for="location">í•„ë¦„ ìœ„ì¹˜</label>
            <input type="text" id="location" placeholder="ì˜ˆ: A-3 ì„œë, 4ì¸µ ìš°ì¸¡ ë™ ë“±" />
          </div>

          <!-- ìš”ì²­ ì¸ì‡„ì -->
          <div class="form-row">
            <label for="requestPrinter">ìš”ì²­ ì¸ì‡„ì</label>
            <select id="requestPrinter">
              <option value="">ì„ íƒ ì•ˆ í•¨</option>
              <option value="ì´ì°½ë¯¼ ë¶€ì¥ë‹˜">ì´ì°½ë¯¼ ë¶€ì¥ë‹˜</option>
              <option value="ê³ ê´‘ìš´ ê³¼ì¥ë‹˜">ê³ ê´‘ìš´ ê³¼ì¥ë‹˜</option>
              <option value="ê¹€ê·œí—Œ ì°¨ì¥ë‹˜">ê¹€ê·œí—Œ ì°¨ì¥ë‹˜</option>
              <option value="ë°•ì¬í˜„ ëŒ€ë¦¬ë‹˜">ë°•ì¬í˜„ ëŒ€ë¦¬ë‹˜</option>
              <option value="ì¡°ì˜ë¹ˆ ëŒ€ë¦¬ë‹˜">ì¡°ì˜ë¹ˆ ëŒ€ë¦¬ë‹˜</option>
              <option value="ê¹€í˜„ê·œ ëŒ€ë¦¬ë‹˜">ê¹€í˜„ê·œ ëŒ€ë¦¬ë‹˜</option>
              <option value="ì¥ì§„ìš° ëŒ€ë¦¬ë‹˜">ì¥ì§„ìš° ëŒ€ë¦¬ë‹˜</option>
              <option value="ê¹€ë¯¸ì€ ì£¼ì„ë‹˜">ê¹€ë¯¸ì€ ì£¼ì„ë‹˜</option>
              <option value="ì´ìˆ˜ì•ˆ ì‚¬ì›ë‹˜">ì´ìˆ˜ì•ˆ ì‚¬ì›ë‹˜</option>
              <option value="ë°•ì§€ì•ˆ ì‚¬ì›ë‹˜">ë°•ì§€ì•ˆ ì‚¬ì›ë‹˜</option>
              <option value="ê¹€ì¸ì„  ì‚¬ì›ë‹˜">ê¹€ì¸ì„  ì‚¬ì›ë‹˜</option>
              <option value="ê¹€ìš©ì› ì‚¬ì›ë‹˜">ê¹€ìš©ì› ì‚¬ì›ë‹˜</option>
              <option value="ìµœì„±ê·œ ì‚¬ì›ë‹˜">ìµœì„±ê·œ ì‚¬ì›ë‹˜</option>
            </select>
          </div>

          <div class="form-row">
            <label for="lastUsed">ë§ˆì§€ë§‰ ì‚¬ìš©ì¼</label>
            <div style="display:flex; gap:6px;">
              <input type="date" id="lastUsed" style="flex:1;" />
              <button type="button" class="btn btn-secondary btn-small" id="setTodayBtn">ì˜¤ëŠ˜</button>
            </div>
          </div>

          <div class="form-row">
            <label for="imageInput">í•„ë¦„ ì‚¬ì§„ (ì„ íƒ)</label>
            <input type="file" id="imageInput" accept="image/*" />
            <small style="font-size:11px; color:var(--text-sub);">
              Â· ìƒˆ í•„ë¦„ì—ëŠ” ì‚¬ì§„ì„ ì¶”ê°€í•˜ê³ ,<br/>
              Â· ìˆ˜ì • ì‹œ ì‚¬ì§„ì„ ë°”ê¾¸ê³  ì‹¶ì„ ë•Œë§Œ ë‹¤ì‹œ ì„ íƒí•˜ì„¸ìš”.
            </small>

            <div id="imagePreviewWrapper" style="margin-top:8px; display:none; align-items:center; gap:6px;">
              <img id="imagePreview" alt="ë¯¸ë¦¬ë³´ê¸°"
                   style="width:70px; height:70px; border-radius:10px; object-fit:cover; background:#eef1ff;" />
              <button type="button" class="btn btn-secondary btn-small" id="rotateLeftBtn">âŸ² 90Â°</button>
              <button type="button" class="btn btn-secondary btn-small" id="rotateRightBtn">âŸ³ 90Â°</button>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="cancelBtn">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn-primary" id="saveBtn">ì €ì¥</button>
          </div>
        </form>
      </div>

      <!-- íŒ ì…ë ¥ í¼ (í•„ë¦„ ì¹´ë“œ ì˜† ë²„íŠ¼ìœ¼ë¡œë§Œ ì—´ë¦¼) -->
      <div class="form-card" id="plateFormCard" style="display:none;">
        <form id="plateForm">
          <input type="hidden" id="plateId" />
          <input type="hidden" id="plateFilmId" />

          <div class="settings-section-title" style="margin-bottom:10px;">íŒ ë“±ë¡</div>

          <div class="form-row">
            <label>ì›ë³¸ í•„ë¦„</label>
            <input type="text" id="plateFilmLabel" disabled />
          </div>

          <div class="form-row">
            <label for="plateNumberInput">íŒ ë²ˆí˜¸ *</label>
            <input type="text" id="plateNumberInput" required />
            <small style="font-size:11px; color:var(--text-sub);">ìë™ ë„˜ë²„ë§ìœ¼ë¡œ ë“¤ì–´ê°€ê³ , ìˆ˜ì • ê°€ëŠ¥</small>
          </div>

          <div class="form-row">
            <label for="plateTensionInput">í…ì…˜</label>
            <input type="text" id="plateTensionInput" placeholder="ì˜ˆ: 23~25" />
          </div>

          <div class="form-row">
            <label for="plateLocationInput">íŒ ìœ„ì¹˜</label>
            <input type="text" id="plateLocationInput" placeholder="ì˜ˆ: 4ì¸µ ë™ B-2" />
          </div>

          <div class="form-row">
            <label for="plateMeshInput">ë©”ì‰¬</label>
            <input type="text" id="plateMeshInput" placeholder="ì˜ˆ: 180T" />
            <small style="font-size:11px; color:var(--text-sub);">í•„ë¦„ì—ì„œ ìƒì†ë˜ì§€ë§Œ, íŒì—ì„œ ìˆ˜ì • ê°€ëŠ¥</small>
          </div>

          <div class="form-row">
            <label for="plateMaxQtyInput">ìµœëŒ€ ì‚¬ìš© ìˆ˜ëŸ‰</label>
            <input type="number" id="plateMaxQtyInput" min="0" step="1" />
            <small style="font-size:11px; color:var(--text-sub);">ê¸°ë³¸ê°’ 5000 ìë™ ì„¸íŒ…, í•„ìš” ì‹œ ìˆ˜ì •</small>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="plateCancelBtn">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn-primary" id="plateSaveBtn">ì €ì¥</button>
          </div>
        </form>
      </div>

      <!-- ë¦¬ìŠ¤íŠ¸ -->
      <div id="list" class="list"></div>
      <div id="emptyText" class="empty-text" style="display:none;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>

      <div id="loadingSpinner" class="spinner-wrapper">
        <div class="spinner-circle"></div>
      </div>
    </div>
  </div>

  <button id="scrollTopBtn" class="scroll-top-btn">â†‘</button>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <script>
    /* ---------- Firebase ì„¤ì • ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyBrBnVuXca2Ou1oMFOLzq3KGEN8xiK5L_U",
      authDomain: "film-find-5242d.firebaseapp.com",
      projectId: "film-find-5242d",
      storageBucket: "film-find-5242d.firebasestorage.app",
      messagingSenderId: "185123433624",
      appId: "1:185123433624:web:269eb9b4b6437887f2f4ed",
      measurementId: "G-V9KL8XS9KJ"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* ---------- ì»¬ë ‰ì…˜ ---------- */
    const FILM_COLLECTION = "films";
    const PLATE_COLLECTION = "plates";
    const HISTORY_COLLECTION = "history";

    /* ---------- ì•± ì„¤ì •/í‚¤ ---------- */
    const UNLOCK_KEY = "filmAppUnlocked"; // ì„¸ì…˜(ì°½ ë‹«ê¸° ì „ê¹Œì§€ ìœ ì§€)
    const DEVICE_KEY = "filmDeviceLabel";
    const SORT_KEY = "filmSortOption";
    const THEME_KEY = "filmTheme";
    const VIEW_KEY = "filmViewMode";
    const TAB_KEY  = "filmActiveTab";

    /* ---------- ëª¨ë“œ ---------- */
    const MODE_ADMIN   = "admin";
    const MODE_PRINTER = "printer";
    const MODE_VIEWER  = "viewer";

    // í˜„ì¬ ëª¨ë“œ(ë¡œê·¸ì¸ ë¹„ë°€ë²ˆí˜¸ë¡œ ê²°ì •)
    let currentMode = null;

    // ë¹„ë°€ë²ˆí˜¸(ì„œë²„ ì„¤ì •) ë¬¸ì„œ
    const PW_DOC_PATH = "appConfig/passwords";

    // ê¸°ë³¸(ì´ˆê¸°) ë¹„ë°€ë²ˆí˜¸
    const DEFAULT_PASSWORDS = { admin:"0605", printer:"1234", viewer:"0000" };
    let serverPasswords = { ...DEFAULT_PASSWORDS };

    /* ---------- ë°ì´í„° ---------- */
    let films = [];
    let plates = [];
    let currentSearchText = "";
    let unsubscribeFilms = null;
    let unsubscribePlates = null;

    let historyEntries = [];
    let historyLoaded = false;

    const VISIBLE_STEP = 30;
    let visibleCount = VISIBLE_STEP;
    let loadingMore = false;

    let currentViewMode = localStorage.getItem(VIEW_KEY) || "list";
    let activeTab = localStorage.getItem(TAB_KEY) || "films"; // films | plates

    /* ì´ë¯¸ì§€ ì„ íƒ/íšŒì „ ìƒíƒœ */
    let currentSelectedImageDataUrl = null;
    let currentImageRotation = 0;

    /* ë©”ëª¨ ìƒíƒœ(í•„ë¦„/íŒ ê³µìš©) */
    let currentMemoTarget = null; // { type:"film"|"plate", id }
    let currentHistoryNoteId = null;

    /* íŒ ì‚¬ìš©ë“±ë¡ ìƒíƒœ */
    let currentUsePlateId = null;

    /* ---------- ìœ í‹¸ (ì„¤ì •) ---------- */
    function getSortOption(){ return localStorage.getItem(SORT_KEY) || "updated"; }
    function setSortOption(opt){ localStorage.setItem(SORT_KEY, opt); }

    function getDeviceLabel(){ return localStorage.getItem(DEVICE_KEY) || ""; }
    function setDeviceLabel(label){
      localStorage.setItem(DEVICE_KEY, label);
      const badgeText = document.getElementById("deviceBadgeText");
      if (badgeText) badgeText.textContent = label || "ê¸°ê¸° ë¯¸ì§€ì •";
    }

    function getTheme(){ return localStorage.getItem(THEME_KEY) || "default"; }
    function setTheme(theme){
      localStorage.setItem(THEME_KEY, theme);
      const root = document.documentElement;
      if (theme === "default") root.removeAttribute("data-theme");
      else root.setAttribute("data-theme", theme);
    }

    function setViewMode(mode){
      currentViewMode = mode;
      localStorage.setItem(VIEW_KEY, mode);
      applyViewMode();
    }

    function setActiveTab(tab){
      activeTab = tab;
      localStorage.setItem(TAB_KEY, tab);
      applyTabUI();
      renderList(currentSearchText);
    }

    function formatDate(iso){ if(!iso) return "-"; return iso; }

    function formatTs(ts){
      if (!ts) return "-";
      const d = new Date(ts);
      if (isNaN(d.getTime())) return "-";
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `${y}-${m}-${day} ${hh}:${mm}`;
    }

    function showToast(msg){
      const toast = document.getElementById("toast");
      if (!toast) return;
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(()=>toast.classList.remove("show"), 1800);
    }

    /* ---------- ê¶Œí•œ ---------- */
    function canViewFilms(){ return currentMode === MODE_ADMIN || currentMode === MODE_VIEWER; }
    function canViewPlates(){ return currentMode === MODE_ADMIN || currentMode === MODE_VIEWER || currentMode === MODE_PRINTER; }

    function canCreateFilm(){ return currentMode === MODE_ADMIN; }
    function canEditFilm(){ return currentMode === MODE_ADMIN; }
    function canDeleteFilm(){ return currentMode === MODE_ADMIN; }
    function canMemoFilm(){ return currentMode === MODE_ADMIN; } // ê´€ë¦¬ìë§Œ í•„ë¦„ ë©”ëª¨

    function canCreatePlate(){ return currentMode === MODE_ADMIN; } // íŒ ë‹¨ë… ë“±ë¡ ê¸ˆì§€(ë¡œì§ ê°•ì œ)
    function canEditPlate(){ return currentMode === MODE_ADMIN; }
    function canDeletePlate(){ return currentMode === MODE_ADMIN; }

    function canUsePlate(){ return currentMode === MODE_ADMIN || currentMode === MODE_PRINTER; }
    function canViewHistory(){ return currentMode === MODE_ADMIN || currentMode === MODE_PRINTER; } // ì¸ì‡„ê¸°ì‚¬ íˆìŠ¤í† ë¦¬ ì¡°íšŒ ê°€ëŠ¥
    function canOpenSettings(){ return currentMode === MODE_ADMIN; } // ì„¤ì • ì „ì²´ ì ‘ê·¼: ê´€ë¦¬ìë§Œ

    /* ---------- ì„œë²„ ë¹„ë°€ë²ˆí˜¸ ë¡œë“œ/ì´ˆê¸°í™” ---------- */
    async function ensurePasswordDoc(){
      const ref = db.doc(PW_DOC_PATH);
      const snap = await ref.get();
      if (!snap.exists){
        await ref.set({
          admin: DEFAULT_PASSWORDS.admin,
          printer: DEFAULT_PASSWORDS.printer,
          viewer: DEFAULT_PASSWORDS.viewer,
          updatedAt: Date.now()
        }, { merge:true });
        serverPasswords = { ...DEFAULT_PASSWORDS };
        return;
      }
      const data = snap.data() || {};
      serverPasswords = {
        admin: String(data.admin || DEFAULT_PASSWORDS.admin),
        printer: String(data.printer || DEFAULT_PASSWORDS.printer),
        viewer: String(data.viewer || DEFAULT_PASSWORDS.viewer)
      };
    }

    function modeFromPassword(pw){
      if (pw === serverPasswords.admin) return MODE_ADMIN;
      if (pw === serverPasswords.printer) return MODE_PRINTER;
      if (pw === serverPasswords.viewer) return MODE_VIEWER;
      return null;
    }

    /* ---------- ëª¨ë“œ UI ---------- */
    function applyModeUI(){
      const tabsBar = document.getElementById("tabsBar");
      const newFilmBtn = document.getElementById("newFilmBtn");
      const newPlateFromFilmBtn = document.getElementById("newPlateFromFilmBtn");
      const settingsBtn = document.getElementById("settingsBtn");
      const historyBtn = document.getElementById("historyBtn");

      // íƒ­ í‘œì‹œ
      if (currentMode === MODE_PRINTER){
        tabsBar.style.display = "none";
        activeTab = "plates";
        localStorage.setItem(TAB_KEY, "plates");
      } else {
        tabsBar.style.display = "flex";
      }

      // ìƒˆ í•„ë¦„ ë²„íŠ¼
      newFilmBtn.style.display = (canCreateFilm() && canViewFilms()) ? "inline-block" : "none";

      // "+ ìƒˆ íŒ"ì€ íŒ ë‹¨ë… ë“±ë¡ ê¸ˆì§€ ìœ ì§€
      newPlateFromFilmBtn.style.display = "none";

      // ì„¤ì •/íˆìŠ¤í† ë¦¬ ë²„íŠ¼
      settingsBtn.style.display = canOpenSettings() ? "inline-block" : "none";
      historyBtn.style.display = canViewHistory() ? "inline-block" : "none";

      // ë¹„ë²ˆ ì„¹ì…˜(ê´€ë¦¬ìë§Œ)
      const pwSection = document.getElementById("pwSection");
      pwSection.style.display = (currentMode === MODE_ADMIN) ? "block" : "none";

      applyTabUI();
      updateSearchPlaceholder();
    }

    function applyTabUI(){
      const tabFilmsBtn = document.getElementById("tabFilmsBtn");
      const tabPlatesBtn = document.getElementById("tabPlatesBtn");

      if (tabFilmsBtn && tabPlatesBtn){
        tabFilmsBtn.classList.toggle("active", activeTab === "films");
        tabPlatesBtn.classList.toggle("active", activeTab === "plates");
      }

      // ëª¨ë“œë³„ íƒ­ ê°•ì œ
      if (currentMode === MODE_PRINTER){
        activeTab = "plates";
      } else {
        if (activeTab === "films" && !canViewFilms()) activeTab = "plates";
        if (activeTab === "plates" && !canViewPlates()) activeTab = "films";
      }

      updateSearchPlaceholder();
    }

    function updateSearchPlaceholder(){
      const search = document.getElementById("searchInput");
      if (!search) return;
      if (activeTab === "plates"){
        search.placeholder = "ì œí’ˆëª… / í•„ë¦„ë²ˆí˜¸ / íŒë²ˆí˜¸ / ìœ„ì¹˜ / ë©”ì‰¬ / ë§ˆì§€ë§‰ì‚¬ìš©(ëˆ„ê°€/ìˆ˜ëŸ‰) ê²€ìƒ‰";
      } else {
        search.placeholder = "ì œí’ˆëª… / í•„ë¦„ë²ˆí˜¸ / ì œíŒíƒ€ì… / ìœ„ì¹˜ / ì œíŒë°©ë²• / MESH / ìš”ì²­ ì¸ì‡„ì ê²€ìƒ‰";
      }
    }

    /* ---------- Firestore ì‹¤ì‹œê°„ ë™ê¸°í™” ---------- */
    function startFilmsListener(){
      if (unsubscribeFilms) unsubscribeFilms();
      unsubscribeFilms = db.collection(FILM_COLLECTION).onSnapshot(
        (snapshot)=>{
          films = snapshot.docs.map((doc)=>({ id: doc.id, ...doc.data() }));
          renderList(currentSearchText);
        },
        (error)=>{
          console.error("í•„ë¦„ ë™ê¸°í™” ì˜¤ë¥˜:", error);
          showToast("ì„œë²„ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´.");
        }
      );
    }

    function startPlatesListener(){
      if (unsubscribePlates) unsubscribePlates();
      unsubscribePlates = db.collection(PLATE_COLLECTION).onSnapshot(
        (snapshot)=>{
          plates = snapshot.docs.map((doc)=>({ id: doc.id, ...doc.data() }));
          renderList(currentSearchText);
        },
        (error)=>{
          console.error("íŒ ë™ê¸°í™” ì˜¤ë¥˜:", error);
          showToast("ì„œë²„ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´.");
        }
      );
    }

    /* ---------- íˆìŠ¤í† ë¦¬ (ê¸°ì¡´ + í•„ë“œ ì¶”ê°€ë§Œ) ---------- */
    async function addHistory(action, payloadObj, changes = []){
      try{
        const entry = {
          action,
          filmId: payloadObj.filmId || payloadObj.id || null,
          filmNumber: payloadObj.filmNumber || "",
          productName: payloadObj.productName || "",
          deviceName: getDeviceLabel() || "",
          timestamp: Date.now(),
          changes,
          plateId: payloadObj.plateId || null,
          plateNumber: payloadObj.plateNumber || ""
        };
        await db.collection(HISTORY_COLLECTION).add(entry);
        if (historyLoaded) await loadHistory();
      } catch(e){
        console.error("íˆìŠ¤í† ë¦¬ ê¸°ë¡ ì¤‘ ì˜¤ë¥˜:", e);
      }
    }

    async function loadHistory(){
      try{
        const snap = await db.collection(HISTORY_COLLECTION).orderBy("timestamp","desc").limit(100).get();
        historyEntries = snap.docs.map((d)=>({ id: d.id, ...d.data() }));
        historyLoaded = true;
        renderHistory();
      } catch(e){
        console.error("íˆìŠ¤í† ë¦¬ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", e);
        showToast("íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´.");
      }
    }

    function actionLabel(action){
      if (action === "ë“±ë¡") return "í•„ë¦„ ë“±ë¡";
      if (action === "ìˆ˜ì •") return "í•„ë¦„ ìˆ˜ì •";
      if (action === "ì‚­ì œ") return "í•„ë¦„ ì‚­ì œ";
      if (action === "ì˜¤ëŠ˜ ì‚¬ìš©") return "ì˜¤ëŠ˜ ì‚¬ìš© ì²´í¬";
      if (action === "íŒ ë“±ë¡") return "íŒ ë“±ë¡";
      if (action === "íŒ ìˆ˜ì •") return "íŒ ìˆ˜ì •";
      if (action === "íŒ ì‚­ì œ") return "íŒ ì‚­ì œ";
      if (action === "íŒ ì‚¬ìš©ë“±ë¡") return "íŒ ì‚¬ìš©ë“±ë¡";
      return action || "ë³€ê²½";
    }

    function renderHistory(){
      const list = document.getElementById("historyList");
      if (!list) return;
      list.innerHTML = "";

      if (!historyEntries.length){
        const empty = document.createElement("div");
        empty.className = "history-empty";
        empty.innerHTML = "ì•„ì§ ê¸°ë¡ì´ ì—†ì–´.";
        list.appendChild(empty);
        return;
      }

      historyEntries.forEach((entry)=>{
        const row = document.createElement("div");
        row.className = "history-row";

        const ts = formatTs(entry.timestamp || 0);
        const device = entry.deviceName || "ê¸°ê¸° ë¯¸ì§€ì •";

        const filmLabel = (entry.filmNumber || "") + (entry.productName ? ` (${entry.productName})` : "");
        const plateLabel = entry.plateNumber ? ` / ${entry.plateNumber}` : "";

        const changesArr = Array.isArray(entry.changes) ? entry.changes : [];
        const noteText = (entry.note || "").trim();

        row.innerHTML =
          `<div class="history-headline">` +
            `<div>` +
              `<span class="history-time">${ts}</span>` +
              `<span class="history-device">${device}</span>` +
              `<span class="history-action-chip">${actionLabel(entry.action)}</span>` +
            `</div>` +
            `<button class="history-pencil" data-id="${entry.id}">âœï¸</button>` +
          `</div>` +
          `<div class="history-film">${(filmLabel || "ì •ë³´ ì—†ìŒ")}${plateLabel}</div>` +
          (changesArr.length ? `<div class="history-changes">ë³€ê²½ í•­ëª©: ${changesArr.join(", ")}</div>` : "") +
          (noteText ? `<div class="history-note">${noteText}</div>` : "");

        const pencilBtn = row.querySelector(".history-pencil");
        if (pencilBtn) pencilBtn.addEventListener("click", ()=> openHistoryNoteModal(entry.id));
        list.appendChild(row);
      });
    }

    function openHistoryCard(){
      const card = document.getElementById("historyCard");
      const isOpen = card.style.display === "block";
      closeAllPanels();
      if (!isOpen){
        card.style.display = "block";
        if (!historyLoaded) loadHistory();
        else renderHistory();
      }
    }
    function closeHistoryCard(){ document.getElementById("historyCard").style.display = "none"; }

    /* ====== ë©”ëª¨(í•„ë¦„/íŒ ê³µìš©) ====== */
    function openMemoSheetForFilm(filmId){
      const film = films.find((f)=>f.id === filmId);
      if (!film) return;
      currentMemoTarget = { type:"film", id: filmId };

      const title = document.getElementById("memoSheetTitle");
      const sub = document.getElementById("memoSheetSub");
      const ta = document.getElementById("memoTextarea");
      const sheet = document.getElementById("memoSheet");

      if (title) title.textContent = `ë©”ëª¨ Â· ${film.filmNumber || ""}`;
      if (sub) sub.textContent = film.productName || "í•„ë¦„";
      if (ta) ta.value = film.memo || "";
      ta.placeholder = "ì˜ˆ: í…ì…˜ 23 ì´í•˜ì—ì„œ ë²ˆì§ / ìš°ì¸¡ 2mm ë°€ë¦¼ ì£¼ì˜";

      sheet.classList.add("show");
    }

    function openMemoSheetForPlate(plateId){
      const p = plates.find((x)=>x.id === plateId);
      if (!p) return;
      currentMemoTarget = { type:"plate", id: plateId };

      const title = document.getElementById("memoSheetTitle");
      const sub = document.getElementById("memoSheetSub");
      const ta = document.getElementById("memoTextarea");
      const sheet = document.getElementById("memoSheet");

      if (title) title.textContent = `ë©”ëª¨ Â· ${p.plateNumber || ""}`;
      if (sub) sub.textContent = (p.productName || "") ? `${p.productName}` : "íŒ";
      if (ta) ta.value = p.memo || "";
      ta.placeholder = "ì˜ˆ: ë²ˆì§ ìˆì–´ì„œ ì‰í¬ ë†ë„ ì¡°ì ˆ / ë¼ì¸ 0.2 ì–‡ê²Œ";

      sheet.classList.add("show");
    }

    function closeMemoSheet(){
      document.getElementById("memoSheet").classList.remove("show");
      currentMemoTarget = null;
    }

    async function saveMemoSheet(){
      if (!currentMemoTarget) return;
      const ta = document.getElementById("memoTextarea");
      const memo = (ta.value || "").trim();

      try{
        if (currentMemoTarget.type === "film"){
          if (!canMemoFilm()){ showToast("ê¶Œí•œì´ ì—†ì–´."); return; }
          await db.collection(FILM_COLLECTION).doc(currentMemoTarget.id).set({ memo, updatedAt: Date.now() }, { merge:true });
          showToast("ë©”ëª¨ë¥¼ ì €ì¥í–ˆì–´.");
        } else {
          if (!(currentMode === MODE_ADMIN)){ showToast("ê¶Œí•œì´ ì—†ì–´."); return; }
          await db.collection(PLATE_COLLECTION).doc(currentMemoTarget.id).set({ memo, updatedAt: Date.now() }, { merge:true });
          showToast("ë©”ëª¨ë¥¼ ì €ì¥í–ˆì–´.");
        }
        closeMemoSheet();
      } catch(e){
        console.error(e);
        showToast("ë©”ëª¨ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë‚¬ì–´.");
      }
    }

    /* ====== íˆìŠ¤í† ë¦¬ ë©”ëª¨(ëª¨ë‹¬) ====== */
    function openHistoryNoteModal(historyId){
      const entry = historyEntries.find((h)=>h.id === historyId);
      if (!entry) return;
      currentHistoryNoteId = historyId;

      const modal = document.getElementById("historyNoteModal");
      const ta = document.getElementById("historyNoteTextarea");
      if (ta) ta.value = entry.note || "";
      modal.classList.add("show");
    }
    function closeHistoryNoteModal(){
      document.getElementById("historyNoteModal").classList.remove("show");
      currentHistoryNoteId = null;
    }
    async function saveHistoryNoteModal(){
      if (!currentHistoryNoteId) return;
      const ta = document.getElementById("historyNoteTextarea");
      const note = (ta.value || "").trim();

      try{
        await db.collection(HISTORY_COLLECTION).doc(currentHistoryNoteId).set({ note }, { merge:true });
        const idx = historyEntries.findIndex((h)=>h.id === currentHistoryNoteId);
        if (idx >= 0) historyEntries[idx].note = note;
        renderHistory();
        showToast("íˆìŠ¤í† ë¦¬ ë©”ëª¨ ì €ì¥ë¨.");
        closeHistoryNoteModal();
      } catch(e){
        console.error(e);
        showToast("íˆìŠ¤í† ë¦¬ ë©”ëª¨ ì €ì¥ ì¤‘ ì˜¤ë¥˜.");
      }
    }

    /* ---------- ì œíŒ ë°©ë²• í† ê¸€ ---------- */
    function clearPlateInfoForm(){ document.querySelectorAll(".toggle-btn").forEach((btn)=>btn.classList.remove("active")); }
    function setPlateInfoToForm(str){
      clearPlateInfoForm();
      if (!str) return;
      const parts = str.split(" ");
      document.querySelectorAll(".toggle-btn").forEach((btn)=>{ if (parts.includes(btn.dataset.value)) btn.classList.add("active"); });
    }
    function getPlateInfoFromForm(){
      const groups = document.querySelectorAll(".toggle-group");
      const values = [];
      groups.forEach((group)=>{
        const active = group.querySelector(".toggle-btn.active");
        if (active) values.push(active.dataset.value);
      });
      return values.join(" ");
    }

    /* ---------- í¼/ë¦¬ìŠ¤íŠ¸ ìœ í‹¸ ---------- */
    function resetForm(){
      document.getElementById("filmId").value = "";
      document.getElementById("productName").value = "";
      document.getElementById("filmNumber").value = "";
      document.getElementById("method").value = "";
      document.getElementById("mesh").value = "";
      document.getElementById("location").value = "";
      document.getElementById("requestPrinter").value = "";
      document.getElementById("lastUsed").value = "";
      document.getElementById("imageInput").value = "";
      clearPlateInfoForm();
      resetImagePreview();
    }

    function resetPlateForm(){
      document.getElementById("plateId").value = "";
      document.getElementById("plateFilmId").value = "";
      document.getElementById("plateFilmLabel").value = "";
      document.getElementById("plateNumberInput").value = "";
      document.getElementById("plateTensionInput").value = "";
      document.getElementById("plateLocationInput").value = "";
      document.getElementById("plateMeshInput").value = "";
      document.getElementById("plateMaxQtyInput").value = 5000;
    }

    function closeForm(){ document.getElementById("formCard").style.display = "none"; resetForm(); }
    function closePlateForm(){ document.getElementById("plateFormCard").style.display = "none"; resetPlateForm(); }

    function getLastFilmForDefaults(){
      if (!films.length) return null;
      return films.reduce((acc, cur)=>{
        const a = acc.updatedAt || acc.createdAt || 0;
        const b = cur.updatedAt || cur.createdAt || 0;
        return b > a ? cur : acc;
      });
    }

    function openFormNew(){
      if (!canCreateFilm()){ showToast("ê¶Œí•œì´ ì—†ì–´."); return; }
      resetForm();
      const last = getLastFilmForDefaults();
      if (last){
        document.getElementById("method").value = last.method || "";
        document.getElementById("mesh").value = last.mesh || "";
        document.getElementById("location").value = last.location || "";
        document.getElementById("requestPrinter").value = last.requestPrinter || "";
        setPlateInfoToForm(last.plateInfo || "");
      }
      document.getElementById("formCard").style.display = "block";
      document.getElementById("productName").focus();
    }

    function toggleFormNew(){
      const card = document.getElementById("formCard");
      const isOpen = card.style.display === "block";
      closeAllPanels();
      if (!isOpen) openFormNew();
    }

    function openFormCopyFrom(id){
      if (!canCreateFilm()){ showToast("ê¶Œí•œì´ ì—†ì–´."); return; }
      const film = films.find((f)=>f.id === id);
      if (!film) return;
      resetForm();
      document.getElementById("productName").value = film.productName || "";
      document.getElementById("filmNumber").value = "";
      document.getElementById("method").value = film.method || "";
      document.getElementById("mesh").value = film.mesh || "";
      document.getElementById("location").value = film.location || "";
      document.getElementById("requestPrinter").value = film.requestPrinter || "";
      document.getElementById("lastUsed").value = "";
      setPlateInfoToForm(film.plateInfo || "");
      closeAllPanels();
      document.getElementById("formCard").style.display = "block";
      document.getElementById("productName").focus();
    }

    function openFormForEdit(id){
      if (!canEditFilm()){ showToast("ê¶Œí•œì´ ì—†ì–´."); return; }
      const film = films.find((f)=>f.id === id);
      if (!film) return;
      closeAllPanels();
      resetImagePreview();
      document.getElementById("filmId").value = film.id;
      document.getElementById("productName").value = film.productName || "";
      document.getElementById("filmNumber").value = film.filmNumber || "";
      document.getElementById("method").value = film.method || "";
      document.getElementById("mesh").value = film.mesh || "";
      document.getElementById("location").value = film.location || "";
      document.getElementById("requestPrinter").value = film.requestPrinter || "";
      document.getElementById("lastUsed").value = film.lastUsed || "";
      document.getElementById("imageInput").value = "";
      setPlateInfoToForm(film.plateInfo || "");
      document.getElementById("formCard").style.display = "block";
      document.getElementById("productName").focus();
    }

    /* ---------- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° & íšŒì „ ---------- */
    function resetImagePreview(){
      const wrapper = document.getElementById("imagePreviewWrapper");
      const img = document.getElementById("imagePreview");
      currentSelectedImageDataUrl = null;
      currentImageRotation = 0;
      if (img){ img.src = ""; img.style.transform = "rotate(0deg)"; }
      if (wrapper) wrapper.style.display = "none";
    }
    function applyPreviewRotation(){
      const img = document.getElementById("imagePreview");
      if (!img) return;
      img.style.transform = "rotate(" + currentImageRotation + "deg)";
    }

    /* ---------- ì¹´ìš´íŠ¸ ---------- */
    function updateCountBar(filteredLength, totalLength, hasFilter){
      const bar = document.getElementById("countBar");
      if (!bar) return;
      const label = (activeTab === "plates") ? "íŒ" : "í•„ë¦„";
      if (hasFilter) bar.innerHTML = `ê²€ìƒ‰ ê²°ê³¼ <strong>${filteredLength}</strong>ê°œ / ì „ì²´ ${totalLength}ê°œ`;
      else bar.innerHTML = `ì´ <strong>${totalLength}</strong>ê°œ ${label}`;
    }

    /* ---------- ë·° ëª¨ë“œ ---------- */
    function applyViewMode(){
      const list = document.getElementById("list");
      const btn = document.getElementById("viewToggleBtn");
      if (!list || !btn) return;
      if (currentViewMode === "gallery"){ list.classList.add("gallery"); btn.textContent = "ë¦¬ìŠ¤íŠ¸"; }
      else { list.classList.remove("gallery"); btn.textContent = "ê°¤ëŸ¬ë¦¬"; }
    }

    /* ---------- íŒ¨ë„ ê³µí†µ ---------- */
    function closeAllPanels(){
      document.getElementById("settingsCard").style.display = "none";
      document.getElementById("historyCard").style.display = "none";
      document.getElementById("formCard").style.display = "none";
      document.getElementById("plateFormCard").style.display = "none";
    }

    /* ---------- (PART2ì—ì„œ ì´ì–´ì§) ---------- */
  </script><!-- =========================
  PART 2/2  (ì´ë²¤íŠ¸/CRUD/ë Œë”ë§/íŒ ì‚¬ìš©ë“±ë¡/ì¸ì‡„ê¸°ì‚¬ ëª©ë¡ Firebase ì €ì¥ + íœ´ì§€í†µ ì œê±°)
  ========================= -->
  <script>
    /* =========================
       ê³µí†µ: ë¡œë”© í‘œì‹œ / ìŠ¤í¬ë¡¤
    ========================= */
    function showSpinner(show){
      const sp = document.getElementById("loadingSpinner");
      if (!sp) return;
      sp.classList.toggle("show", !!show);
    }

    function setupScrollTop(){
      const btn = document.getElementById("scrollTopBtn");
      window.addEventListener("scroll", ()=>{
        if (window.scrollY > 420) btn.classList.add("show");
        else btn.classList.remove("show");
      });
      btn.addEventListener("click", ()=> window.scrollTo({ top:0, behavior:"smooth" }));
    }

    /* =========================
       ì´ë¯¸ì§€ ë·°ì–´(í•€ì¹˜/ì¤Œì€ ìµœì†Œ, ë“œë˜ê·¸ë§Œ)
    ========================= */
    let viewerScale = 1;
    let viewerX = 0;
    let viewerY = 0;
    let isDragging = false;
    let dragStart = {x:0,y:0};

    function openImageViewer(src){
      const wrap = document.getElementById("imageViewer");
      const img = document.getElementById("viewerImage");
      viewerScale = 1; viewerX = 0; viewerY = 0;
      img.style.transform = "translate(0px,0px) scale(1)";
      img.src = src;
      wrap.style.display = "flex";
    }
    function closeImageViewer(){
      document.getElementById("imageViewer").style.display = "none";
    }
    function applyViewerTransform(){
      const img = document.getElementById("viewerImage");
      img.style.transform = `translate(${viewerX}px,${viewerY}px) scale(${viewerScale})`;
    }
    function setupImageViewer(){
      const backdrop = document.getElementById("viewerBackdrop");
      const closeBtn = document.getElementById("closeViewerBtn");
      const img = document.getElementById("viewerImage");

      backdrop.addEventListener("click", closeImageViewer);
      closeBtn.addEventListener("click", closeImageViewer);

      img.addEventListener("mousedown", (e)=>{
        isDragging = true;
        dragStart = { x: e.clientX - viewerX, y: e.clientY - viewerY };
      });
      window.addEventListener("mousemove", (e)=>{
        if (!isDragging) return;
        viewerX = e.clientX - dragStart.x;
        viewerY = e.clientY - dragStart.y;
        applyViewerTransform();
      });
      window.addEventListener("mouseup", ()=>{ isDragging = false; });

      // ëª¨ë°”ì¼ í„°ì¹˜ ë“œë˜ê·¸
      img.addEventListener("touchstart", (e)=>{
        if (e.touches.length !== 1) return;
        isDragging = true;
        dragStart = { x: e.touches[0].clientX - viewerX, y: e.touches[0].clientY - viewerY };
      }, {passive:true});

      img.addEventListener("touchmove", (e)=>{
        if (!isDragging || e.touches.length !== 1) return;
        viewerX = e.touches[0].clientX - dragStart.x;
        viewerY = e.touches[0].clientY - dragStart.y;
        applyViewerTransform();
      }, {passive:true});

      img.addEventListener("touchend", ()=>{ isDragging = false; });
    }

    /* =========================
       ì¸ì‡„ê¸°ì‚¬ ëª©ë¡: Firebase ì €ì¥(ê³µìœ )
       - platePrinters/list ë¬¸ì„œì— ë°°ì—´ë¡œ ì €ì¥
       - ê´€ë¦¬ìë§Œ ì¶”ê°€/ì‚­ì œ ê°€ëŠ¥
       - íŒ ì‚¬ìš©ë“±ë¡ ëª¨ë‹¬ì€ ì„ íƒ ë°©ì‹
    ========================= */
    const PRINTERS_DOC_PATH = "appConfig/platePrinters";

    let printerList = []; // ë¬¸ìì—´ ë°°ì—´

    async function ensurePrintersDoc(){
      const ref = db.doc(PRINTERS_DOC_PATH);
      const snap = await ref.get();
      if (!snap.exists){
        // ì´ˆê¸°ê°’: ê¸°ì¡´ ì˜µì…˜ë“¤
        const initial = [
          "ì´ì°½ë¯¼ ë¶€ì¥ë‹˜","ê³ ê´‘ìš´ ê³¼ì¥ë‹˜","ê¹€ê·œí—Œ ì°¨ì¥ë‹˜","ë°•ì¬í˜„ ëŒ€ë¦¬ë‹˜","ì¡°ì˜ë¹ˆ ëŒ€ë¦¬ë‹˜",
          "ê¹€í˜„ê·œ ëŒ€ë¦¬ë‹˜","ì¥ì§„ìš° ëŒ€ë¦¬ë‹˜","ê¹€ë¯¸ì€ ì£¼ì„ë‹˜","ì´ìˆ˜ì•ˆ ì‚¬ì›ë‹˜","ë°•ì§€ì•ˆ ì‚¬ì›ë‹˜",
          "ê¹€ì¸ì„  ì‚¬ì›ë‹˜","ê¹€ìš©ì› ì‚¬ì›ë‹˜","ìµœì„±ê·œ ì‚¬ì›ë‹˜"
        ];
        await ref.set({ list: initial, updatedAt: Date.now() }, { merge:true });
        printerList = initial.slice();
        return;
      }
      const data = snap.data() || {};
      const list = Array.isArray(data.list) ? data.list : [];
      printerList = list.map(v => String(v)).filter(v => v.trim());
    }

    function startPrintersListener(){
      db.doc(PRINTERS_DOC_PATH).onSnapshot((snap)=>{
        if (!snap.exists) return;
        const data = snap.data() || {};
        const list = Array.isArray(data.list) ? data.list : [];
        printerList = list.map(v => String(v)).filter(v => v.trim());
        fillPrinterSelects();
      });
    }

    function fillPrinterSelects(){
      // (1) í•„ë¦„ í¼ì˜ ìš”ì²­ ì¸ì‡„ì ì…€ë ‰íŠ¸ëŠ” ê¸°ì¡´ ìœ ì§€(ì›í•˜ë©´ ì´ê²ƒë„ printerListë¡œ í†µì¼ ê°€ëŠ¥)
      // ìš”êµ¬ì‚¬í•­ì€ "íŒ ì‚¬ìš©ë“±ë¡ ì‹œ ì¸ì‡„ê¸°ì‚¬ ì„ íƒ ëª©ë¡ì„ ì¶”ê°€/ì‚­ì œ ê°€ëŠ¥ + Firebase ê³µìœ " ì´ë¯€ë¡œ
      // (2) íŒ ì‚¬ìš©ë“±ë¡ ëª¨ë‹¬ì˜ ì…€ë ‰íŠ¸ë§Œ printerListë¡œ ì±„ì›€
      const sel = document.getElementById("useWhoSelect");
      if (!sel) return;

      const current = sel.value || "";
      sel.innerHTML = `<option value="">ì„ íƒ ì•ˆ í•¨</option>` + printerList
        .map(n => `<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`)
        .join("");
      sel.value = current && printerList.includes(current) ? current : "";
    }

    async function addPrinterName(name){
      name = (name || "").trim();
      if (!name) return;
      if (printerList.includes(name)) { showToast("ì´ë¯¸ ìˆì–´."); return; }
      const next = printerList.concat([name]).sort((a,b)=>a.localeCompare(b,"ko"));
      await db.doc(PRINTERS_DOC_PATH).set({ list: next, updatedAt: Date.now() }, { merge:true });
      showToast("ì¶”ê°€ë¨.");
    }

    async function removePrinterName(name){
      const next = printerList.filter(n => n !== name);
      await db.doc(PRINTERS_DOC_PATH).set({ list: next, updatedAt: Date.now() }, { merge:true });
      showToast("ì‚­ì œë¨.");
    }

    /* =========================
       HTML escape
    ========================= */
    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /* =========================
       ì„¤ì •: ì¸ì‡„ê¸°ì‚¬ ëª©ë¡ ê´€ë¦¬ UI (ê´€ë¦¬ìë§Œ)
       - ì„¤ì • ì¹´ë“œ ì•ˆì— ë™ì ìœ¼ë¡œ ë Œë”
    ========================= */
    function renderPrintersManager(){
      const settingsCard = document.getElementById("settingsCard");
      if (!settingsCard) return;

      let box = document.getElementById("printersManagerBox");
      if (!box){
        box = document.createElement("div");
        box.id = "printersManagerBox";
        box.style.marginTop = "12px";
        settingsCard.insertBefore(box, settingsCard.querySelector(".form-actions"));
      }

      if (currentMode !== MODE_ADMIN){
        box.innerHTML = "";
        return;
      }

      const rows = printerList.map(n => `
        <div style="display:flex; gap:6px; align-items:center; justify-content:space-between; padding:6px 0;">
          <div style="font-size:13px; color:var(--text-main);">${escapeHtml(n)}</div>
          <button class="btn btn-danger btn-small" data-del="${escapeHtml(n)}">ì‚­ì œ</button>
        </div>
      `).join("");

      box.innerHTML = `
        <div class="settings-section-title">íŒ ì‚¬ìš©ë“±ë¡ Â· ì¸ì‡„ê¸°ì‚¬ ëª©ë¡</div>
        <div class="settings-help">ì´ ëª©ë¡ì€ Firebaseì— ì €ì¥ë¼ì„œ ì–´ë–¤ ê¸°ê¸°ì—ì„œë“  ë˜‘ê°™ì´ ë³´ì—¬.</div>

        <div style="display:flex; gap:6px; align-items:center; margin-bottom:8px;">
          <input id="printerAddInput" type="text" placeholder="ì´ë¦„ ì¶”ê°€" style="flex:1; padding:7px 10px; border-radius:10px; border:1px solid var(--card-border); background:#f9f9ff;" />
          <button class="btn btn-primary btn-small" id="printerAddBtn">ì¶”ê°€</button>
        </div>

        <div style="border:1px solid var(--card-border); border-radius:12px; padding:8px 10px; background:rgba(255,255,255,0.7);">
          ${rows || `<div style="font-size:12px; color:var(--text-sub);">ëª©ë¡ì´ ë¹„ì–´ìˆì–´.</div>`}
        </div>
      `;

      const addBtn = document.getElementById("printerAddBtn");
      const addInput = document.getElementById("printerAddInput");
      addBtn?.addEventListener("click", async ()=>{
        await addPrinterName(addInput.value);
        addInput.value = "";
      });
      addInput?.addEventListener("keydown", async (e)=>{
        if (e.key === "Enter"){
          e.preventDefault();
          await addPrinterName(addInput.value);
          addInput.value = "";
        }
      });

      box.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const name = btn.getAttribute("data-del");
          await removePrinterName(name);
        });
      });
    }

    /* =========================
       íŒ ì‚¬ìš©ë“±ë¡(ëª¨ë‹¬)
       - plates ë¬¸ì„œì— useLogs ë°°ì—´ ì €ì¥(ìµœì‹  200ê°œ ì œí•œ)
       - usedQty ëˆ„ì /ìµœì¢… ì‚¬ìš©ëŸ‰ ê³„ì‚°
       - íˆìŠ¤í† ë¦¬ì— "íŒ ì‚¬ìš©ë“±ë¡" ê¸°ë¡ + noteëŠ” ë³„ë„(ì›í•˜ë©´ useMemoë¥¼ changesì— í‘œì‹œ)
    ========================= */
    function openPlateUseModal(plateId){
      if (!canUsePlate()){ showToast("ê¶Œí•œì´ ì—†ì–´."); return; }
      const p = plates.find(x=>x.id === plateId);
      if (!p) return;

      currentUsePlateId = plateId;

      const title = document.getElementById("plateUseTitle");
      const sub = document.getElementById("plateUseSub");
      const qty = document.getElementById("useQtyInput");
      const memo = document.getElementById("useMemoInput");
      const sel = document.getElementById("useWhoSelect");

      title.textContent = "íŒ ì‚¬ìš©ë“±ë¡";
      sub.textContent = `${p.productName || ""} / í•„ë¦„ ${p.filmNumber || ""} / íŒ ${p.plateNumber || ""}`;

      qty.value = "";
      memo.value = "";
      fillPrinterSelects();
      sel.value = "";

      document.getElementById("plateUseModal").classList.add("show");
    }

    function closePlateUseModal(){
      document.getElementById("plateUseModal").classList.remove("show");
      currentUsePlateId = null;
    }

    async function savePlateUseModal(){
      if (!currentUsePlateId) return;
      const p = plates.find(x=>x.id === currentUsePlateId);
      if (!p) return;

      const who = (document.getElementById("useWhoSelect").value || "").trim();
      const qtyRaw = document.getElementById("useQtyInput").value;
      const qty = Math.max(0, parseInt(qtyRaw || "0", 10) || 0);
      const memo = (document.getElementById("useMemoInput").value || "").trim();

      if (!qty){
        showToast("ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì¤˜.");
        return;
      }

      const log = {
        ts: Date.now(),
        who,
        qty,
        memo,
        device: getDeviceLabel() || "",
        byMode: currentMode
      };

      try{
        const ref = db.collection(PLATE_COLLECTION).doc(p.id);
        const snap = await ref.get();
        const data = snap.data() || {};
        const logs = Array.isArray(data.useLogs) ? data.useLogs : [];
        const nextLogs = [log].concat(logs).slice(0, 200);

        const usedQty = Number(data.usedQty || 0) + qty;

        await ref.set({
          useLogs: nextLogs,
          usedQty,
          lastUsedAt: Date.now(),
          updatedAt: Date.now()
        }, { merge:true });

        await addHistory("íŒ ì‚¬ìš©ë“±ë¡", {
          filmId: p.filmId || null,
          filmNumber: p.filmNumber || "",
          productName: p.productName || "",
          plateId: p.id,
          plateNumber: p.plateNumber || ""
        }, [
          `ì¸ì‡„ê¸°ì‚¬:${who || "-"}`,
          `ìˆ˜ëŸ‰:${qty}`,
          memo ? `ë©”ëª¨:${memo}` : "ë©”ëª¨:-"
        ]);

        showToast("ì‚¬ìš©ë“±ë¡ ì™„ë£Œ.");
        closePlateUseModal();
      } catch(e){
        console.error(e);
        showToast("ì‚¬ìš©ë“±ë¡ ì¤‘ ì˜¤ë¥˜.");
      }
    }

    function sumQty(logs){
      if (!Array.isArray(logs)) return 0;
      return logs.reduce((acc, cur)=> acc + (Number(cur.qty)||0), 0);
    }

    function renderUseLogs(p){
      const logs = Array.isArray(p.useLogs) ? p.useLogs : [];
      if (!logs.length) return `<div class="history-empty" style="margin-top:6px;">ì‚¬ìš© ê¸°ë¡ ì—†ìŒ</div>`;

      return logs.slice(0, 8).map(l=>{
        const ts = formatTs(l.ts);
        const who = l.who || "-";
        const qty = l.qty || 0;
        const memo = l.memo ? ` Â· ${escapeHtml(l.memo)}` : "";
        const device = l.device ? ` <span class="history-device">${escapeHtml(l.device)}</span>` : "";
        return `
          <div class="history-row" style="padding-left:20px;">
            <div>
              <span class="history-time">${ts}</span>${device}
              <span class="history-action-chip">ì‚¬ìš©</span>
            </div>
            <div class="history-film">${escapeHtml(who)} <span style="color:var(--text-sub); font-size:11px;">(${qty.toLocaleString()} EA)</span>${memo}</div>
          </div>
        `;
      }).join("");
    }

    /* =========================
       ë¦¬ìŠ¤íŠ¸ ë Œë”ë§: films / plates
       - íœ´ì§€í†µ UI ì—†ìŒ(ì™„ì „ ì œê±°)
       - íŒ ì¹´ë“œì— "ì‚¬ìš©ë“±ë¡" ë²„íŠ¼ + ì‚¬ìš©ê¸°ë¡ íƒ€ì„ë¼ì¸
       - í•„ë¦„/íŒ ëª¨ë‘ ë©”ëª¨ ë²„íŠ¼(í•„ë¦„ì€ ê´€ë¦¬ìë§Œ, íŒì€ ê´€ë¦¬ìë§Œ)
    ========================= */
    function filterFilms(q){
      q = (q || "").trim().toLowerCase();
      if (!q) return films.slice();

      return films.filter(f=>{
        const fields = [
          f.productName, f.filmNumber, f.method, f.location, f.plateInfo, f.mesh, f.requestPrinter
        ].map(v => String(v || "").toLowerCase());
        return fields.some(v => v.includes(q));
      });
    }

    function filterPlates(q){
      q = (q || "").trim().toLowerCase();
      if (!q) return plates.slice();

      return plates.filter(p=>{
        const useLogs = Array.isArray(p.useLogs) ? p.useLogs : [];
        const useText = useLogs.slice(0,15).map(l=>{
          return `${l.who||""} ${l.qty||""} ${l.memo||""}`.toLowerCase();
        }).join(" ");

        const fields = [
          p.productName, p.filmNumber, p.plateNumber, p.location, p.mesh, p.tension,
          String(p.usedQty||""), String(p.maxQty||""), useText
        ].map(v => String(v || "").toLowerCase());

        return fields.some(v => v.includes(q));
      });
    }

    function sortItems(arr){
      const opt = getSortOption();
      const copy = arr.slice();

      if (opt === "name"){
        copy.sort((a,b)=> String(a.productName||"").localeCompare(String(b.productName||""),"ko"));
      } else if (opt === "number"){
        // í•„ë¦„ë²ˆí˜¸/íŒë²ˆí˜¸ëŠ” ë¬¸ìì—´ì´ ì„ì¼ ìˆ˜ ìˆìœ¼ë‹ˆ localeCompareë¡œ
        copy.sort((a,b)=> {
          const aa = activeTab === "plates" ? String(a.plateNumber||"") : String(a.filmNumber||"");
          const bb = activeTab === "plates" ? String(b.plateNumber||"") : String(b.filmNumber||"");
          return aa.localeCompare(bb,"ko");
        });
      } else if (opt === "lastUsed"){
        copy.sort((a,b)=>{
          const aa = activeTab === "plates" ? (a.lastUsedAt||0) : (a.lastUsed||0);
          const bb = activeTab === "plates" ? (b.lastUsedAt||0) : (b.lastUsed||0);
          return (bb||0) - (aa||0);
        });
      } else {
        copy.sort((a,b)=>{
          const aa = a.updatedAt || a.createdAt || 0;
          const bb = b.updatedAt || b.createdAt || 0;
          return bb - aa;
        });
      }
      return copy;
    }

    function renderList(q){
      currentSearchText = q || "";
      const listEl = document.getElementById("list");
      const empty = document.getElementById("emptyText");
      if (!listEl) return;

      // íƒ­ë³„ ê¶Œí•œ
      if (activeTab === "films" && !canViewFilms()){
        listEl.innerHTML = "";
        empty.style.display = "block";
        empty.textContent = "í•„ë¦„ íƒ­ì€ ì¡°íšŒ ê¶Œí•œì´ ì—†ì–´.";
        updateCountBar(0,0,false);
        return;
      }
      if (activeTab === "plates" && !canViewPlates()){
        listEl.innerHTML = "";
        empty.style.display = "block";
        empty.textContent = "íŒ íƒ­ì€ ì¡°íšŒ ê¶Œí•œì´ ì—†ì–´.";
        updateCountBar(0,0,false);
        return;
      }

      let items = (activeTab === "plates") ? filterPlates(q) : filterFilms(q);
      const totalLength = (activeTab === "plates") ? plates.length : films.length;
      const hasFilter = (q || "").trim().length > 0;

      items = sortItems(items);

      updateCountBar(items.length, totalLength, hasFilter);

      // ë¬´í•œ ìŠ¤í¬ë¡¤ìš©: visibleCount
      const shown = items.slice(0, visibleCount);

      listEl.innerHTML = "";
      applyViewMode();

      if (!shown.length){
        empty.style.display = "block";
        empty.textContent = "ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
        return;
      } else empty.style.display = "none";

      shown.forEach(item=>{
        if (activeTab === "plates") listEl.appendChild(renderPlateCard(item));
        else listEl.appendChild(renderFilmCard(item));
      });

      // ë” ë‚¨ì•„ìˆìœ¼ë©´ ìŠ¤í”¼ë„ˆ í‘œì‹œ
      showSpinner(items.length > visibleCount);
    }

    function renderFilmCard(f){
      const card = document.createElement("div");
      card.className = "card";

      const img = document.createElement("img");
      img.src = f.image || "";
      if (!f.image) img.style.display = "none";
      img.addEventListener("click", ()=>{ if (f.image) openImageViewer(f.image); });

      const content = document.createElement("div");
      content.className = "card-content";

      const titleRow = document.createElement("div");
      titleRow.className = "card-row-main";

      const title = document.createElement("div");
      title.className = "card-title";
      title.textContent = f.productName || "(ì œí’ˆëª… ì—†ìŒ)";

      const tag = document.createElement("div");
      tag.className = "card-tag";
      tag.textContent = f.filmNumber || "-";

      titleRow.appendChild(title);
      titleRow.appendChild(tag);

      const row1 = document.createElement("div");
      row1.className = "card-row";
      row1.innerHTML = `<span class="label">ì œíŒ:</span>${escapeHtml(f.method || "-")} Â· <span class="label">ë°©ë²•:</span>${escapeHtml(f.plateInfo || "-")}`;

      const row2 = document.createElement("div");
      row2.className = "card-row";
      row2.innerHTML = `<span class="label">MESH:</span>${escapeHtml(f.mesh || "-")} Â· <span class="label">ìœ„ì¹˜:</span>${escapeHtml(f.location || "-")}`;

      const row3 = document.createElement("div");
      row3.className = "card-row";
      row3.innerHTML = `<span class="label">ìš”ì²­ ì¸ì‡„ì:</span>${escapeHtml(f.requestPrinter || "-")}`;

      const footer = document.createElement("div");
      footer.className = "card-footer";

      const lastUsed = document.createElement("div");
      lastUsed.className = "last-used";
      lastUsed.innerHTML = `<span class="label">ë§ˆì§€ë§‰ ì‚¬ìš©:</span>${escapeHtml(formatDate(f.lastUsed))}`;

      const buttons = document.createElement("div");
      buttons.className = "card-buttons";

      // ë³µì‚¬
      if (canCreateFilm()){
        const copyBtn = document.createElement("button");
        copyBtn.className = "btn btn-secondary btn-small";
        copyBtn.textContent = "ë³µì‚¬";
        copyBtn.addEventListener("click", ()=> openFormCopyFrom(f.id));
        buttons.appendChild(copyBtn);
      }

      // ìˆ˜ì •
      if (canEditFilm()){
        const editBtn = document.createElement("button");
        editBtn.className = "btn btn-secondary btn-small";
        editBtn.textContent = "ìˆ˜ì •";
        editBtn.addEventListener("click", ()=> openFormForEdit(f.id));
        buttons.appendChild(editBtn);
      }

      // ë©”ëª¨(ê´€ë¦¬ìë§Œ)
      if (canMemoFilm()){
        const memoBtn = document.createElement("button");
        memoBtn.className = "btn btn-secondary btn-small";
        memoBtn.textContent = "ë©”ëª¨";
        if ((f.memo || "").trim()) memoBtn.classList.add("btn-memo-has");
        memoBtn.addEventListener("click", ()=> openMemoSheetForFilm(f.id));
        buttons.appendChild(memoBtn);
      }

      // ì˜¤ëŠ˜ ì‚¬ìš©(ê´€ë¦¬ìë§Œ: ê¸°ì¡´ ì •ì±… ìœ ì§€)
      if (canEditFilm()){
        const todayBtn = document.createElement("button");
        todayBtn.className = "btn btn-primary btn-small";
        todayBtn.textContent = "ì˜¤ëŠ˜ ì‚¬ìš©";
        todayBtn.addEventListener("click", ()=> setFilmTodayUsed(f.id));
        buttons.appendChild(todayBtn);
      }

      // ì‚­ì œ
      if (canDeleteFilm()){
        const delBtn = document.createElement("button");
        delBtn.className = "btn btn-danger btn-small";
        delBtn.textContent = "ì‚­ì œ";
        delBtn.addEventListener("click", ()=> deleteFilm(f.id));
        buttons.appendChild(delBtn);
      }

      // í•„ë¦„->íŒ ë“±ë¡(ê´€ë¦¬ìë§Œ, í•„ë¦„ ì¹´ë“œì—ì„œë§Œ)
      if (canCreatePlate()){
        const plateBtn = document.createElement("button");
        plateBtn.className = "btn btn-primary btn-small";
        plateBtn.textContent = "íŒ ë“±ë¡";
        plateBtn.addEventListener("click", ()=> openPlateFormFromFilm(f.id));
        buttons.appendChild(plateBtn);
      }

      footer.appendChild(lastUsed);
      footer.appendChild(buttons);

      content.appendChild(titleRow);
      content.appendChild(row1);
      content.appendChild(row2);
      content.appendChild(row3);
      content.appendChild(footer);

      card.appendChild(img);
      card.appendChild(content);
      return card;
    }

    function renderPlateCard(p){
      const card = document.createElement("div");
      card.className = "card";

      // íŒì€ ì´ë¯¸ì§€ ì—†ìŒ(í•„ë¦„ ì´ë¯¸ì§€ë¡œ ëŒ€ì²´í•˜ë ¤ë©´ film join í•„ìš”. êµ¬ì¡° ë³€ê²½ ì—†ì´ ìƒëµ)
      const content = document.createElement("div");
      content.className = "card-content";

      const titleRow = document.createElement("div");
      titleRow.className = "card-row-main";

      const title = document.createElement("div");
      title.className = "card-title";
      title.textContent = p.productName || "(ì œí’ˆëª… ì—†ìŒ)";

      const tag = document.createElement("div");
      tag.className = "card-tag";
      tag.textContent = p.plateNumber || "-";

      titleRow.appendChild(title);
      titleRow.appendChild(tag);

      const usedQty = Number(p.usedQty || 0);
      const maxQty = Number(p.maxQty || 0);
      const remain = maxQty ? Math.max(0, maxQty - usedQty) : null;

      const row1 = document.createElement("div");
      row1.className = "card-row";
      row1.innerHTML = `<span class="label">í•„ë¦„:</span>${escapeHtml(p.filmNumber || "-")} Â· <span class="label">íŒìœ„ì¹˜:</span>${escapeHtml(p.location || "-")}`;

      const row2 = document.createElement("div");
      row2.className = "card-row";
      row2.innerHTML = `<span class="label">ë©”ì‰¬:</span>${escapeHtml(p.mesh || "-")} Â· <span class="label">í…ì…˜:</span>${escapeHtml(p.tension || "-")}`;

      const row3 = document.createElement("div");
      row3.className = "card-row";
      const remainText = (remain === null) ? "-" : remain.toLocaleString();
      const warn = (maxQty && usedQty >= maxQty) ? `<span class="warn-pill">ìµœëŒ€ìˆ˜ëŸ‰ ì´ˆê³¼</span>` : "";
      row3.innerHTML = `<span class="label">ì‚¬ìš©:</span>${usedQty.toLocaleString()} / ${maxQty ? maxQty.toLocaleString() : "-"} Â· <span class="label">ì”ì—¬:</span>${remainText} ${warn}`;

      const footer = document.createElement("div");
      footer.className = "card-footer";

      const lastUsed = document.createElement("div");
      lastUsed.className = "last-used";
      lastUsed.innerHTML = `<span class="label">ìµœê·¼ ì‚¬ìš©:</span>${escapeHtml(formatTs(p.lastUsedAt || 0))}`;

      const buttons = document.createElement("div");
      buttons.className = "card-buttons";

      // ì‚¬ìš©ë“±ë¡ (ê´€ë¦¬ì/ì¸ì‡„ê¸°ì‚¬)
      if (canUsePlate()){
        const useBtn = document.createElement("button");
        useBtn.className = "btn btn-primary btn-small";
        useBtn.textContent = "ì‚¬ìš©ë“±ë¡";
        useBtn.addEventListener("click", ()=> openPlateUseModal(p.id));
        buttons.appendChild(useBtn);
      }

      // ë©”ëª¨(ê´€ë¦¬ìë§Œ)
      if (currentMode === MODE_ADMIN){
        const memoBtn = document.createElement("button");
        memoBtn.className = "btn btn-secondary btn-small";
        memoBtn.textContent = "ë©”ëª¨";
        if ((p.memo || "").trim()) memoBtn.classList.add("btn-memo-has");
        memoBtn.addEventListener("click", ()=> openMemoSheetForPlate(p.id));
        buttons.appendChild(memoBtn);
      }

      // ìˆ˜ì •/ì‚­ì œ(ê´€ë¦¬ìë§Œ)
      if (canEditPlate()){
        const editBtn = document.createElement("button");
        editBtn.className = "btn btn-secondary btn-small";
        editBtn.textContent = "ìˆ˜ì •";
        editBtn.addEventListener("click", ()=> openPlateEdit(p.id));
        buttons.appendChild(editBtn);
      }
      if (canDeletePlate()){
        const delBtn = document.createElement("button");
        delBtn.className = "btn btn-danger btn-small";
        delBtn.textContent = "ì‚­ì œ";
        delBtn.addEventListener("click", ()=> deletePlate(p.id));
        buttons.appendChild(delBtn);
      }

      footer.appendChild(lastUsed);
      footer.appendChild(buttons);

      // ì‚¬ìš©ê¸°ë¡ íƒ€ì„ë¼ì¸(ì˜ˆì˜ê²Œ)
      const logsBox = document.createElement("div");
      logsBox.className = "history-list";
      logsBox.style.maxHeight = "220px";
      logsBox.style.marginTop = "10px";
      logsBox.innerHTML = renderUseLogs(p);

      content.appendChild(titleRow);
      content.appendChild(row1);
      content.appendChild(row2);
      content.appendChild(row3);
      content.appendChild(footer);
      content.appendChild(logsBox);

      card.appendChild(content);
      return card;
    }

    /* =========================
       ë¬´í•œ ìŠ¤í¬ë¡¤: ë”ë³´ê¸°
    ========================= */
    function setupInfiniteScroll(){
      window.addEventListener("scroll", ()=>{
        if (loadingMore) return;
        const nearBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 260;
        if (!nearBottom) return;

        // í˜„ì¬ í•„í„° ê²°ê³¼ ìˆ˜
        let items = (activeTab === "plates") ? filterPlates(currentSearchText) : filterFilms(currentSearchText);
        items = sortItems(items);
        if (visibleCount >= items.length) return;

        loadingMore = true;
        visibleCount += VISIBLE_STEP;
        renderList(currentSearchText);
        setTimeout(()=> loadingMore = false, 80);
      });
    }

    /* =========================
       CRUD: í•„ë¦„
    ========================= */
    async function saveFilm(e){
      e.preventDefault();
      if (!canEditFilm()) { showToast("ê¶Œí•œì´ ì—†ì–´."); return; }

      const id = document.getElementById("filmId").value || null;
      const productName = document.getElementById("productName").value.trim();
      const filmNumber = document.getElementById("filmNumber").value.trim();
      const method = document.getElementById("method").value.trim();
      const mesh = document.getElementById("mesh").value.trim();
      const location = document.getElementById("location").value.trim();
      const requestPrinter = document.getElementById("requestPrinter").value.trim();
      const lastUsed = document.getElementById("lastUsed").value || "";
      const plateInfo = getPlateInfoFromForm();

      if (!productName || !filmNumber){
        showToast("ì œí’ˆ ì´ë¦„/í•„ë¦„ ë²ˆí˜¸ëŠ” í•„ìˆ˜ì•¼.");
        return;
      }

      // ì´ë¯¸ì§€: ìƒˆë¡œ ì„ íƒí•œ ê²Œ ìˆìœ¼ë©´ currentSelectedImageDataUrl ì‚¬ìš©
      let image = null;
      const original = id ? films.find(f=>f.id===id) : null;

      if (currentSelectedImageDataUrl){
        image = await rotateDataUrl(currentSelectedImageDataUrl, currentImageRotation);
      } else {
        image = original ? (original.image || null) : null;
      }

      const payload = {
        productName, filmNumber, method, mesh, location, requestPrinter, lastUsed,
        plateInfo,
        image,
        updatedAt: Date.now()
      };

      try{
        if (!id){
          payload.createdAt = Date.now();
          const ref = await db.collection(FILM_COLLECTION).add(payload);
          await addHistory("ë“±ë¡", { id: ref.id, filmNumber, productName }, ["ë“±ë¡"]);
          showToast("ì €ì¥ ì™„ë£Œ.");
        } else {
          // changes
          const before = original || {};
          const changes = [];
          if ((before.productName||"") !== productName) changes.push("ì œí’ˆëª…");
          if ((before.filmNumber||"") !== filmNumber) changes.push("í•„ë¦„ë²ˆí˜¸");
          if ((before.method||"") !== method) changes.push("ì œíŒ");
          if ((before.mesh||"") !== mesh) changes.push("MESH");
          if ((before.location||"") !== location) changes.push("ìœ„ì¹˜");
          if ((before.requestPrinter||"") !== requestPrinter) changes.push("ìš”ì²­ì¸ì‡„ì");
          if ((before.lastUsed||"") !== lastUsed) changes.push("ë§ˆì§€ë§‰ì‚¬ìš©ì¼");
          if ((before.plateInfo||"") !== plateInfo) changes.push("ì œíŒë°©ë²•");
          if ((before.image||"") !== (image||"")) changes.push("ì‚¬ì§„");

          await db.collection(FILM_COLLECTION).doc(id).set(payload, { merge:true });
          await addHistory("ìˆ˜ì •", { id, filmNumber, productName }, changes.length ? changes : ["ìˆ˜ì •"]);
          showToast("ìˆ˜ì • ì™„ë£Œ.");
        }
        closeForm();
      } catch(e){
        console.error(e);
        showToast("ì €ì¥ ì¤‘ ì˜¤ë¥˜.");
      }
    }

    async function deleteFilm(id){
      if (!canDeleteFilm()) { showToast("ê¶Œí•œì´ ì—†ì–´."); return; }
      const film = films.find(f=>f.id===id);
      if (!film) return;
      if (!confirm(`ì‚­ì œí• ê¹Œ?\n${film.filmNumber} / ${film.productName}`)) return;

      try{
        // ì—°ê´€ íŒë„ ê°™ì´ ì‚­ì œ(êµ¬ì¡° ìœ ì§€)
        const related = plates.filter(p=>p.filmId === id);
        for (const p of related){
          await db.collection(PLATE_COLLECTION).doc(p.id).delete();
          await addHistory("íŒ ì‚­ì œ", {
            filmId: id, filmNumber: film.filmNumber, productName: film.productName,
            plateId: p.id, plateNumber: p.plateNumber
          }, ["ì—°ê´€ íŒ ì‚­ì œ"]);
        }

        await db.collection(FILM_COLLECTION).doc(id).delete();
        await addHistory("ì‚­ì œ", { id, filmNumber: film.filmNumber, productName: film.productName }, ["ì‚­ì œ"]);
        showToast("ì‚­ì œ ì™„ë£Œ.");
      } catch(e){
        console.error(e);
        showToast("ì‚­ì œ ì¤‘ ì˜¤ë¥˜.");
      }
    }

    async function setFilmTodayUsed(id){
      if (!canEditFilm()) { showToast("ê¶Œí•œì´ ì—†ì–´."); return; }
      const film = films.find(f=>f.id===id);
      if (!film) return;
      const today = new Date();
      const iso = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,"0")}-${String(today.getDate()).padStart(2,"0")}`;

      try{
        await db.collection(FILM_COLLECTION).doc(id).set({ lastUsed: iso, updatedAt: Date.now() }, { merge:true });
        await addHistory("ì˜¤ëŠ˜ ì‚¬ìš©", { id, filmNumber: film.filmNumber, productName: film.productName }, ["ë§ˆì§€ë§‰ì‚¬ìš©ì¼"]);
        showToast("ì˜¤ëŠ˜ ì‚¬ìš© ì²´í¬.");
      } catch(e){
        console.error(e);
        showToast("ì—…ë°ì´íŠ¸ ì˜¤ë¥˜.");
      }
    }

    /* =========================
       CRUD: íŒ (í•„ë¦„ì—ì„œë§Œ ìƒì„±)
    ========================= */
    function nextPlateNumberFromFilm(film){
      // ê·œì¹™: í•„ë¦„ë²ˆí˜¸-1, -2 ... (ê¸°ì¡´ ê·œì¹™ì´ ë‹¤ë¥´ë©´ ì—¬ê¸°ë§Œ ë°”ê¿”)
      const base = (film.filmNumber || "PLATE").trim();
      const related = plates.filter(p=>p.filmId === film.id);
      const nums = related.map(p=>{
        const m = String(p.plateNumber||"").match(/-(\d+)$/);
        return m ? parseInt(m[1],10) : 0;
      });
      const next = (nums.length ? Math.max(...nums) : 0) + 1;
      return `${base}-${next}`;
    }

    function openPlateFormFromFilm(filmId){
      if (!canCreatePlate()){ showToast("ê¶Œí•œì´ ì—†ì–´."); return; }
      const film = films.find(f=>f.id===filmId);
      if (!film) return;

      closeAllPanels();
      resetPlateForm();

      document.getElementById("plateFilmId").value = film.id;
      document.getElementById("plateFilmLabel").value = `${film.filmNumber || "-"} / ${film.productName || "-"}`;
      document.getElementById("plateNumberInput").value = nextPlateNumberFromFilm(film);

      document.getElementById("plateMeshInput").value = film.mesh || "";
      document.getElementById("plateLocationInput").value = film.location || "";

      document.getElementById("plateMaxQtyInput").value = 5000;

      document.getElementById("plateFormCard").style.display = "block";
      document.getElementById("plateNumberInput").focus();
    }

    function openPlateEdit(plateId){
      if (!canEditPlate()){ showToast("ê¶Œí•œì´ ì—†ì–´."); return; }
      const p = plates.find(x=>x.id===plateId);
      if (!p) return;

      closeAllPanels();
      resetPlateForm();

      document.getElementById("plateId").value = p.id;
      document.getElementById("plateFilmId").value = p.filmId || "";
      document.getElementById("plateFilmLabel").value = `${p.filmNumber || "-"} / ${p.productName || "-"}`;
      document.getElementById("plateNumberInput").value = p.plateNumber || "";
      document.getElementById("plateTensionInput").value = p.tension || "";
      document.getElementById("plateLocationInput").value = p.location || "";
      document.getElementById("plateMeshInput").value = p.mesh || "";
      document.getElementById("plateMaxQtyInput").value = Number(p.maxQty || 5000);

      document.getElementById("plateFormCard").style.display = "block";
      document.getElementById("plateNumberInput").focus();
    }

    async function savePlate(e){
      e.preventDefault();
      if (!canEditPlate()) { showToast("ê¶Œí•œì´ ì—†ì–´."); return; }

      const id = document.getElementById("plateId").value || null;
      const filmId = document.getElementById("plateFilmId").value || "";
      const plateNumber = document.getElementById("plateNumberInput").value.trim();
      const tension = document.getElementById("plateTensionInput").value.trim();
      const location = document.getElementById("plateLocationInput").value.trim();
      const mesh = document.getElementById("plateMeshInput").value.trim();
      const maxQty = Math.max(0, parseInt(document.getElementById("plateMaxQtyInput").value || "0", 10) || 0);

      if (!filmId || !plateNumber){
        showToast("ì›ë³¸ í•„ë¦„/íŒ ë²ˆí˜¸ëŠ” í•„ìˆ˜ì•¼.");
        return;
      }

      const film = films.find(f=>f.id===filmId);
      const productName = film ? (film.productName || "") : (plates.find(p=>p.id===id)?.productName || "");
      const filmNumber  = film ? (film.filmNumber  || "") : (plates.find(p=>p.id===id)?.filmNumber  || "");

      const payload = {
        filmId,
        productName,
        filmNumber,
        plateNumber,
        tension,
        location,
        mesh,
        maxQty: maxQty || 0,
        updatedAt: Date.now()
      };

      try{
        if (!id){
          payload.createdAt = Date.now();
          payload.usedQty = 0;
          payload.useLogs = [];
          const ref = await db.collection(PLATE_COLLECTION).add(payload);
          await addHistory("íŒ ë“±ë¡", {
            filmId, filmNumber, productName,
            plateId: ref.id, plateNumber
          }, ["íŒ ë“±ë¡"]);
          showToast("íŒ ì €ì¥ ì™„ë£Œ.");
        } else {
          const before = plates.find(p=>p.id===id) || {};
          const changes = [];
          if ((before.plateNumber||"") !== plateNumber) changes.push("íŒë²ˆí˜¸");
          if ((before.tension||"") !== tension) changes.push("í…ì…˜");
          if ((before.location||"") !== location) changes.push("ìœ„ì¹˜");
          if ((before.mesh||"") !== mesh) changes.push("ë©”ì‰¬");
          if (Number(before.maxQty||0) !== Number(maxQty||0)) changes.push("ìµœëŒ€ìˆ˜ëŸ‰");

          await db.collection(PLATE_COLLECTION).doc(id).set(payload, { merge:true });
          await addHistory("íŒ ìˆ˜ì •", {
            filmId, filmNumber, productName,
            plateId: id, plateNumber
          }, changes.length ? changes : ["íŒ ìˆ˜ì •"]);
          showToast("íŒ ìˆ˜ì • ì™„ë£Œ.");
        }
        closePlateForm();
      } catch(e){
        console.error(e);
        showToast("íŒ ì €ì¥ ì˜¤ë¥˜.");
      }
    }

    async function deletePlate(plateId){
      if (!canDeletePlate()){ showToast("ê¶Œí•œì´ ì—†ì–´."); return; }
      const p = plates.find(x=>x.id===plateId);
      if (!p) return;
      if (!confirm(`íŒ ì‚­ì œí• ê¹Œ?\n${p.plateNumber} / ${p.productName}`)) return;

      try{
        await db.collection(PLATE_COLLECTION).doc(plateId).delete();
        await addHistory("íŒ ì‚­ì œ", {
          filmId: p.filmId, filmNumber: p.filmNumber, productName: p.productName,
          plateId: p.id, plateNumber: p.plateNumber
        }, ["íŒ ì‚­ì œ"]);
        showToast("íŒ ì‚­ì œ ì™„ë£Œ.");
      } catch(e){
        console.error(e);
        showToast("íŒ ì‚­ì œ ì˜¤ë¥˜.");
      }
    }

    /* =========================
       ì´ë¯¸ì§€ íšŒì „(ì„ íƒ ì´ë¯¸ì§€ìš©)
    ========================= */
    function rotateDataUrl(dataUrl, deg){
      return new Promise((resolve)=>{
        deg = ((deg%360)+360)%360;
        if (!deg) return resolve(dataUrl);

        const img = new Image();
        img.onload = ()=>{
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");

          const w = img.width;
          const h = img.height;

          if (deg === 90 || deg === 270){
            canvas.width = h;
            canvas.height = w;
          } else {
            canvas.width = w;
            canvas.height = h;
          }

          ctx.translate(canvas.width/2, canvas.height/2);
          ctx.rotate(deg * Math.PI/180);
          ctx.drawImage(img, -w/2, -h/2);
          resolve(canvas.toDataURL("image/jpeg", 0.9));
        };
        img.src = dataUrl;
      });
    }

    function setupImageInput(){
      const input = document.getElementById("imageInput");
      const wrapper = document.getElementById("imagePreviewWrapper");
      const preview = document.getElementById("imagePreview");

      input.addEventListener("change", (e)=>{
        const file = e.target.files?.[0];
        if (!file) { resetImagePreview(); return; }
        const reader = new FileReader();
        reader.onload = ()=>{
          currentSelectedImageDataUrl = reader.result;
          currentImageRotation = 0;
          preview.src = currentSelectedImageDataUrl;
          preview.style.transform = "rotate(0deg)";
          wrapper.style.display = "flex";
        };
        reader.readAsDataURL(file);
      });

      document.getElementById("rotateLeftBtn").addEventListener("click", ()=>{
        if (!currentSelectedImageDataUrl) return;
        currentImageRotation = (currentImageRotation - 90) % 360;
        applyPreviewRotation();
      });
      document.getElementById("rotateRightBtn").addEventListener("click", ()=>{
        if (!currentSelectedImageDataUrl) return;
        currentImageRotation = (currentImageRotation + 90) % 360;
        applyPreviewRotation();
      });
    }

    /* =========================
       ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸°(JSON)
    ========================= */
    async function exportData(){
      // ê´€ë¦¬ìë§Œ
      if (currentMode !== MODE_ADMIN){ showToast("ê¶Œí•œì´ ì—†ì–´."); return; }

      try{
        const filmsSnap = await db.collection(FILM_COLLECTION).get();
        const platesSnap = await db.collection(PLATE_COLLECTION).get();
        const historySnap = await db.collection(HISTORY_COLLECTION).orderBy("timestamp","desc").limit(200).get();

        const out = {
          exportedAt: Date.now(),
          films: filmsSnap.docs.map(d=>({ id:d.id, ...d.data() })),
          plates: platesSnap.docs.map(d=>({ id:d.id, ...d.data() })),
          history: historySnap.docs.map(d=>({ id:d.id, ...d.data() }))
        };

        const blob = new Blob([JSON.stringify(out, null, 2)], { type:"application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `film_find_export_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showToast("ë‚´ë³´ë‚´ê¸° ì™„ë£Œ.");
      } catch(e){
        console.error(e);
        showToast("ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜.");
      }
    }

    async function importData(file){
      // ê´€ë¦¬ìë§Œ
      if (currentMode !== MODE_ADMIN){ showToast("ê¶Œí•œì´ ì—†ì–´."); return; }
      try{
        const text = await file.text();
        const data = JSON.parse(text);

        if (!data || (!Array.isArray(data.films) && !Array.isArray(data.plates))){
          showToast("í˜•ì‹ì´ ë§ì§€ ì•Šì•„.");
          return;
        }
        if (!confirm("ë¶ˆëŸ¬ì˜¤ë©´ ê¸°ì¡´ ë°ì´í„°ê°€ ë®ì–´ì¨ì§ˆ ìˆ˜ ìˆì–´. ì§„í–‰í• ê¹Œ?")) return;

        // ê°„ë‹¨ ë³‘í•©: id ìˆìœ¼ë©´ set(merge)
        const batch = db.batch();

        if (Array.isArray(data.films)){
          data.films.forEach(f=>{
            const id = f.id || db.collection(FILM_COLLECTION).doc().id;
            const ref = db.collection(FILM_COLLECTION).doc(id);
            const payload = { ...f };
            delete payload.id;
            batch.set(ref, payload, { merge:true });
          });
        }

        if (Array.isArray(data.plates)){
          data.plates.forEach(p=>{
            const id = p.id || db.collection(PLATE_COLLECTION).doc().id;
            const ref = db.collection(PLATE_COLLECTION).doc(id);
            const payload = { ...p };
            delete payload.id;
            batch.set(ref, payload, { merge:true });
          });
        }

        await batch.commit();
        showToast("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ.");
      } catch(e){
        console.error(e);
        showToast("ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜.");
      }
    }

    /* =========================
       ì„¤ì • ì¹´ë“œ ì—´ê¸°/ë‹«ê¸°/ì €ì¥ + ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
    ========================= */
    function toggleSettings(){
      if (!canOpenSettings()){ showToast("ê¶Œí•œì´ ì—†ì–´."); return; }
      const card = document.getElementById("settingsCard");
      const isOpen = card.style.display === "block";
      closeAllPanels();
      if (!isOpen){
        card.style.display = "block";
        // ê°’ ì±„ìš°ê¸°
        document.getElementById("deviceNameInput").value = getDeviceLabel();
        document.getElementById("sortOptionSelect").value = getSortOption();
        document.getElementById("themeSelect").value = getTheme();

        // ê´€ë¦¬ì ë¹„ë²ˆ ë¼ì¸ í‘œì‹œ
        const line = document.getElementById("adminPwLine");
        if (line) line.textContent = `ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸: ${serverPasswords.admin}`;

        renderPrintersManager();
      }
    }

    async function saveSettings(){
      if (!canOpenSettings()){ showToast("ê¶Œí•œì´ ì—†ì–´."); return; }

      const deviceName = document.getElementById("deviceNameInput").value.trim();
      const sortOpt = document.getElementById("sortOptionSelect").value;
      const theme = document.getElementById("themeSelect").value;

      setDeviceLabel(deviceName);
      setSortOption(sortOpt);
      setTheme(theme);

      // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½(ê´€ë¦¬ì)
      const cur = document.getElementById("adminPwCurrentInput").value.trim();
      const newAdmin = document.getElementById("adminPwNewInput").value.trim();
      const newAdmin2 = document.getElementById("adminPwNewConfirmInput").value.trim();

      const newPrinter = document.getElementById("printerPwNewInput").value.trim();
      const newViewer = document.getElementById("viewerPwNewInput").value.trim();

      try{
        // ê´€ë¦¬ì ë¹„ë²ˆ ë³€ê²½
        if (newAdmin || newAdmin2){
          if (cur !== serverPasswords.admin){ showToast("í˜„ì¬ ê´€ë¦¬ì ë¹„ë²ˆì´ í‹€ë ¤."); return; }
          if (!newAdmin || newAdmin !== newAdmin2){ showToast("ìƒˆ ê´€ë¦¬ì ë¹„ë²ˆ í™•ì¸ì´ ë‹¬ë¼."); return; }
          serverPasswords.admin = newAdmin;
        }

        if (newPrinter){
          serverPasswords.printer = newPrinter;
        }
        if (newViewer){
          serverPasswords.viewer = newViewer;
        }

        await db.doc(PW_DOC_PATH).set({
          admin: serverPasswords.admin,
          printer: serverPasswords.printer,
          viewer: serverPasswords.viewer,
          updatedAt: Date.now()
        }, { merge:true });

        // ì…ë ¥ì¹¸ ë¹„ìš°ê¸°
        document.getElementById("adminPwCurrentInput").value = "";
        document.getElementById("adminPwNewInput").value = "";
        document.getElementById("adminPwNewConfirmInput").value = "";
        document.getElementById("printerPwNewInput").value = "";
        document.getElementById("viewerPwNewInput").value = "";

        const line = document.getElementById("adminPwLine");
        if (line) line.textContent = `ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸: ${serverPasswords.admin}`;

        showToast("ì„¤ì • ì €ì¥ ì™„ë£Œ.");
        renderPrintersManager();
        fillPrinterSelects();
      } catch(e){
        console.error(e);
        showToast("ì„¤ì • ì €ì¥ ì˜¤ë¥˜.");
      }
    }

    /* =========================
       ë¹„ë°€ë²ˆí˜¸ ì ê¸ˆ/í•´ì œ
       - ì„¸ì…˜í‚¤(UNLOCK_KEY) ìˆìœ¼ë©´ ì¬ì ê¸ˆ ì•ˆí•¨
    ========================= */
    async function unlockFlow(){
      await ensurePasswordDoc();
      await ensurePrintersDoc();

      const already = sessionStorage.getItem(UNLOCK_KEY);
      if (already){
        currentMode = already; // ì €ì¥ëœ ëª¨ë“œ
        document.getElementById("lockScreen").style.display = "none";
        document.getElementById("appContainer").style.display = "block";
        initAfterUnlock();
        return;
      }

      // ì ê¸ˆ í™”ë©´ì—ì„œ ì…ë ¥
      const btn = document.getElementById("passwordBtn");
      const input = document.getElementById("passwordInput");

      btn.addEventListener("click", tryUnlock);
      input.addEventListener("keydown", (e)=>{ if (e.key === "Enter") tryUnlock(); });

      async function tryUnlock(){
        await ensurePasswordDoc(); // ìµœì‹ 
        const pw = input.value.trim();
        const mode = modeFromPassword(pw);
        if (!mode){
          showToast("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ì–´.");
          input.value = "";
          return;
        }
        currentMode = mode;
        sessionStorage.setItem(UNLOCK_KEY, mode);

        document.getElementById("lockScreen").style.display = "none";
        document.getElementById("appContainer").style.display = "block";
        initAfterUnlock();
      }
    }

    function initAfterUnlock(){
      // í…Œë§ˆ/ë””ë°”ì´ìŠ¤/ë·° ì ìš©
      setTheme(getTheme());
      setDeviceLabel(getDeviceLabel());
      applyViewMode();

      // ëª¨ë“œ UI
      applyModeUI();

      // íƒ­ ì´ˆê¸°
      if (currentMode !== MODE_PRINTER){
        // ì €ì¥ëœ íƒ­ ìš°ì„ 
        activeTab = localStorage.getItem(TAB_KEY) || "films";
      } else {
        activeTab = "plates";
      }
      applyTabUI();

      // ë¦¬ìŠ¤ë„ˆ ì‹œì‘
      startFilmsListener();
      startPlatesListener();
      startPrintersListener();

      // ìµœì´ˆ ê¸°ê¸° ì´ë¦„ ëª¨ë‹¬
      if (!getDeviceLabel()){
        document.getElementById("deviceModal").style.display = "flex";
      }

      // ê´€ë¦¬ì ì„¤ì •ì— ì¸ì‡„ê¸°ì‚¬ ëª©ë¡ UI
      renderPrintersManager();

      // ì´ˆê¸° ë Œë”
      visibleCount = VISIBLE_STEP;
      renderList("");

      // íˆìŠ¤í† ë¦¬ ì´ˆê¸°
      historyLoaded = false;

      // ìŠ¤í¬ë¡¤/ë¬´í•œ ìŠ¤í¬ë¡¤
      setupScrollTop();
      setupInfiniteScroll();
    }

    /* =========================
       ëª¨ë‹¬: ê¸°ê¸° ì´ë¦„
    ========================= */
    function setupDeviceModal(){
      const modal = document.getElementById("deviceModal");
      const input = document.getElementById("deviceModalInput");
      const save = document.getElementById("deviceModalSave");
      const skip = document.getElementById("deviceModalSkip");

      function close(){ modal.style.display = "none"; }

      save.addEventListener("click", ()=>{
        setDeviceLabel(input.value.trim());
        close();
      });
      skip.addEventListener("click", close);
    }

    /* =========================
       ë©”ëª¨ ì‹œíŠ¸ ì´ë²¤íŠ¸
    ========================= */
    function setupMemoSheet(){
      document.getElementById("memoSheetBackdrop").addEventListener("click", closeMemoSheet);
      document.getElementById("memoSheetCloseBtn").addEventListener("click", closeMemoSheet);
      document.getElementById("memoSheetCancelBtn").addEventListener("click", closeMemoSheet);
      document.getElementById("memoSheetSaveBtn").addEventListener("click", saveMemoSheet);
    }

    /* =========================
       íˆìŠ¤í† ë¦¬ ë©”ëª¨ ëª¨ë‹¬ ì´ë²¤íŠ¸
    ========================= */
    function setupHistoryNoteModal(){
      document.getElementById("historyNoteCancelBtn").addEventListener("click", closeHistoryNoteModal);
      document.getElementById("historyNoteSaveBtn").addEventListener("click", saveHistoryNoteModal);
      document.getElementById("historyNoteModal").addEventListener("click", (e)=>{
        if (e.target.id === "historyNoteModal") closeHistoryNoteModal();
      });
    }

    /* =========================
       íŒ ì‚¬ìš©ë“±ë¡ ëª¨ë‹¬ ì´ë²¤íŠ¸
    ========================= */
    function setupPlateUseModal(){
      document.getElementById("plateUseCancelBtn").addEventListener("click", closePlateUseModal);
      document.getElementById("plateUseSaveBtn").addEventListener("click", savePlateUseModal);
      document.getElementById("plateUseModal").addEventListener("click", (e)=>{
        if (e.target.id === "plateUseModal") closePlateUseModal();
      });
    }

    /* =========================
       íƒ­/ê²€ìƒ‰/ë²„íŠ¼ ì´ë²¤íŠ¸
    ========================= */
    function setupUIEvents(){
      // íƒ­
      document.getElementById("tabFilmsBtn").addEventListener("click", ()=>{ visibleCount = VISIBLE_STEP; setActiveTab("films"); });
      document.getElementById("tabPlatesBtn").addEventListener("click", ()=>{ visibleCount = VISIBLE_STEP; setActiveTab("plates"); });

      // ê²€ìƒ‰
      const search = document.getElementById("searchInput");
      search.addEventListener("input", ()=>{
        visibleCount = VISIBLE_STEP;
        renderList(search.value);
      });

      // ìƒˆ í•„ë¦„
      document.getElementById("newFilmBtn").addEventListener("click", toggleFormNew);

      // ë·° í† ê¸€
      document.getElementById("viewToggleBtn").addEventListener("click", ()=>{
        setViewMode(currentViewMode === "gallery" ? "list" : "gallery");
        renderList(currentSearchText);
      });

      // ì„¤ì •/íˆìŠ¤í† ë¦¬
      document.getElementById("settingsBtn").addEventListener("click", toggleSettings);
      document.getElementById("historyBtn").addEventListener("click", ()=>{
        if (!canViewHistory()) { showToast("ê¶Œí•œì´ ì—†ì–´."); return; }
        openHistoryCard();
      });

      document.getElementById("closeSettingsBtn").addEventListener("click", ()=> document.getElementById("settingsCard").style.display = "none");
      document.getElementById("saveSettingsBtn").addEventListener("click", saveSettings);

      document.getElementById("closeHistoryBtn").addEventListener("click", closeHistoryCard);

      // ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸°
      document.getElementById("exportBtn").addEventListener("click", exportData);
      document.getElementById("importBtn").addEventListener("click", ()=> document.getElementById("importFile").click());
      document.getElementById("importFile").addEventListener("change", (e)=>{
        const file = e.target.files?.[0];
        if (file) importData(file);
        e.target.value = "";
      });

      // í•„ë¦„ í¼
      document.getElementById("filmForm").addEventListener("submit", saveFilm);
      document.getElementById("cancelBtn").addEventListener("click", closeForm);

      // ì˜¤ëŠ˜ ë²„íŠ¼(í¼ ì•ˆ)
      document.getElementById("setTodayBtn").addEventListener("click", ()=>{
        const today = new Date();
        const iso = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,"0")}-${String(today.getDate()).padStart(2,"0")}`;
        document.getElementById("lastUsed").value = iso;
      });

      // ì œíŒ í† ê¸€ ë²„íŠ¼ ê·¸ë£¹
      document.querySelectorAll(".toggle-group").forEach(group=>{
        group.addEventListener("click", (e)=>{
          const btn = e.target.closest(".toggle-btn");
          if (!btn) return;
          group.querySelectorAll(".toggle-btn").forEach(b=>b.classList.remove("active"));
          btn.classList.add("active");
        });
      });

      // íŒ í¼
      document.getElementById("plateForm").addEventListener("submit", savePlate);
      document.getElementById("plateCancelBtn").addEventListener("click", closePlateForm);

      // settings í´ë¦­ ë°”ê¹¥ ë‹«ê¸°(ì›í•˜ë©´)
    }

    /* =========================
       í•„ìˆ˜: íŒ ë‹¨ë… ë“±ë¡ ê¸ˆì§€ ìœ ì§€
       - "+ ìƒˆ íŒ" ë²„íŠ¼ì€ ìˆ¨ê¹€(Part1ì—ì„œ ì´ë¯¸ none)
    ========================= */

    /* =========================
       íœ´ì§€í†µ ê¸°ëŠ¥ ì œê±°: ê´€ë ¨ ì½”ë“œ/ë²„íŠ¼ ì—†ìŒ
       (ìš”êµ¬ì‚¬í•­: 'íœ´ì§€í†µ ê¸°ëŠ¥ì€ ì•„ì˜ˆ ì—†ì• ê¸°ë§Œ í•´')
    ========================= */

    /* =========================
       ì´ˆê¸° ì‹¤í–‰
    ========================= */
    (async function main(){
      // theme ë¯¸ë¦¬ ì ìš©(ì ê¸ˆ í™”ë©´ë„ í…Œë§ˆ ë§ì¶”ê³  ì‹¶ìœ¼ë©´)
      setTheme(getTheme());

      setupImageViewer();
      setupDeviceModal();
      setupMemoSheet();
      setupHistoryNoteModal();
      setupPlateUseModal();
      setupImageInput();
      setupUIEvents();

      // ì ê¸ˆ/ì–¸ë½
      await unlockFlow();

      // ì´ˆê¸° íƒ­ ë²„íŠ¼ í…ìŠ¤íŠ¸
      applyViewMode();
    })();
  </script>

</body>
</html>
