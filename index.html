<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í•„ë¦„ ê´€ë¦¬ í”„ë¡œê·¸ë¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(145deg, #f9fafb, #f4f0ff, #fdf2f8);
      padding: 12px;
    }
    h1 {
      font-size: 22px;
      margin: 10px 0 14px;
      text-align: left;
      letter-spacing: 2px;
    }
    .header-row {
      max-width: 720px;
      margin: 0 auto 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .device-badge {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(228,231,255,0.95);
      color: #3f4464;
      white-space: nowrap;
    }

    .app-shell {
      max-width: 720px;
      margin: 0 auto;
    }

    .top-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .top-bar input[type="text"] {
      flex: 1;
      padding: 9px 11px;
      border-radius: 999px;
      border: 1px solid #d6d9ff;
      font-size: 14px;
      min-width: 0;
      background: rgba(255,255,255,0.9);
    }
    .btn {
      padding: 8px 11px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      transition: transform 0.05s ease, box-shadow 0.1s ease, background 0.1s ease;
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    .btn-primary {
      background: linear-gradient(135deg, #7f9dff, #b38cff);
      color: white;
      box-shadow: 0 4px 10px rgba(127,157,255,0.35);
    }
    .btn-secondary {
      background: rgba(228,231,255,0.9);
      color: #283252;
    }
    .btn-danger {
      background: #ff6b81;
      color: white;
    }
    .btn-small {
      font-size: 12px;
      padding: 5px 9px;
      border-radius: 999px;
    }

    .tools-bar {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
      flex-wrap: wrap;
      justify-content: flex-start;
    }

    .form-card {
      background: rgba(255,255,255,0.98);
      border-radius: 18px;
      padding: 12px 14px;
      margin-bottom: 12px;
      box-shadow: 0 8px 20px rgba(167, 173, 208, 0.35);
      border: 1px solid #e3e6ff;
    }
    .form-row {
      display: flex;
      flex-direction: column;
      margin-bottom: 9px;
    }
    .form-row label {
      font-size: 12px;
      margin-bottom: 4px;
      color: #5a5f80;
    }
    .form-row input[type="text"],
    .form-row input[type="date"],
    .form-row input[type="password"],
    .form-row select {
      padding: 7px 10px;
      border-radius: 10px;
      border: 1px solid #d6d9ff;
      font-size: 13px;
      background: #f9f9ff;
    }
    .form-row input[type="file"] {
      font-size: 12px;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 6px;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 40px;
    }

    .card {
      background: rgba(255,255,255,0.96);
      border-radius: 16px;
      padding: 10px;
      display: flex;
      gap: 10px;
      box-shadow: 0 6px 16px rgba(169, 177, 214, 0.35);
      align-items: flex-start;
      border: 1px solid #e3e6ff;
    }
    .card img {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 12px;
      background: #eef1ff;
      flex-shrink: 0;
      cursor: pointer;
    }
    .card-content {
      flex: 1;
      font-size: 13px;
    }
    .card-row-main {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 4px;
      align-items: center;
    }
    .card-title {
      font-weight: 600;
      font-size: 14px;
      color: #2f3559;
    }
    .card-tag {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      background: #f3e8ff;
      color: #5f308c;
      align-self: flex-start;
    }
    .card-row {
      margin-bottom: 2px;
    }
    .label {
      color: #8689a5;
      font-size: 11px;
      margin-right: 4px;
    }
    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
      gap: 6px;
      flex-wrap: wrap;
    }
    .last-used {
      font-size: 11px;
      color: #777b9e;
    }
    .card-buttons {
      display: flex;
      gap: 4px;
    }

    .empty-text {
      text-align: center;
      color: #777;
      font-size: 13px;
      margin-top: 20px;
    }

    .toggle-group {
      display: flex;
      gap: 6px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }
    .toggle-btn {
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid #d6d9ff;
      background: #f5f3ff;
      color: #464b73;
      cursor: pointer;
      transition: background 0.1s ease, color 0.1s ease, border 0.1s ease;
    }
    .toggle-btn.active {
      border-color: #7f9dff;
      background: #7f9dff;
      color: #fff;
    }

    /* ì ê¸ˆ í™”ë©´ */
    .lock-screen {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(255,255,255,0.95), rgba(203,213,255,0.96));
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 1000;
    }
    .lock-card {
      width: 100%;
      max-width: 360px;
      background: rgba(255,255,255,0.98);
      border-radius: 20px;
      padding: 18px 18px 16px;
      box-shadow: 0 12px 28px rgba(136, 144, 195, 0.55);
      border: 1px solid #dde1ff;
      text-align: center;
    }
    .lock-title {
      font-size: 18px;
      margin-bottom: 8px;
      font-weight: 600;
      color: #303656;
    }
    .lock-sub {
      font-size: 12px;
      color: #7b7f9d;
      margin-bottom: 14px;
    }
    .lock-input-wrap {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    .lock-input-wrap input {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #d6d9ff;
      background: #f7f7ff;
      text-align: center;
      font-size: 14px;
      letter-spacing: 3px;
    }
    .lock-info {
      font-size: 11px;
      color: #9296b8;
    }

    .settings-section-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #3c4266;
    }
    .settings-help {
      font-size: 11px;
      color: #8a8fb0;
      margin-bottom: 6px;
    }

    /* ì´ë¯¸ì§€ ì „ì²´ ë³´ê¸° */
    .image-viewer {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1500;
    }
    .image-viewer-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.75);
    }
    .image-viewer-inner {
      position: relative;
      max-width: 100%;
      max-height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    #viewerImage {
      max-width: 100%;
      max-height: 100%;
      border-radius: 12px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.5);
      touch-action: none;
    }
    .viewer-close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      border-radius: 999px;
      border: none;
      padding: 6px 10px;
      font-size: 14px;
      cursor: pointer;
      background: rgba(15,23,42,0.8);
      color: #f9fafb;
    }

    /* ë””ë°”ì´ìŠ¤ ì´ë¦„ ì…ë ¥ ëª¨ë‹¬ */
    .device-modal {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.32);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1200;
      padding: 16px;
    }
    .device-modal-card {
      max-width: 360px;
      width: 100%;
      background: #ffffff;
      border-radius: 18px;
      padding: 14px 16px 12px;
      box-shadow: 0 10px 26px rgba(148, 163, 255, 0.45);
      border: 1px solid #e0e4ff;
    }
    .device-modal-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #262b4a;
    }
    .device-modal-sub {
      font-size: 12px;
      color: #72779a;
      margin-bottom: 10px;
    }

    /* íˆìŠ¤í† ë¦¬ ì¹´ë“œ */
    #historyList {
      max-height: 260px;
      overflow-y: auto;
      padding-right: 4px;
      font-size: 12px;
    }
    .history-item {
      padding: 6px 4px;
      border-bottom: 1px solid #ecefff;
    }
    .history-main {
      font-weight: 500;
      color: #33385c;
      margin-bottom: 2px;
    }
    .history-meta {
      font-size: 11px;
      color: #888db2;
    }

    /* í† ìŠ¤íŠ¸ ì•Œë¦¼ */
    .toast-container {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      z-index: 1600;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      pointer-events: none;
    }
    .toast {
      max-width: 320px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.96);
      color: #f9fafb;
      font-size: 12px;
      box-shadow: 0 8px 18px rgba(30,64,175,0.4);
      opacity: 0;
      transform: translateY(8px);
      animation: toast-in 0.25s forwards, toast-out 0.25s forwards 4s;
    }
    @keyframes toast-in {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @keyframes toast-out {
      to {
        opacity: 0;
        transform: translateY(8px);
      }
    }

    @media (min-width: 768px) {
      body { padding-top: 24px; }
    }
  </style>
</head>
<body>
  <!-- ì ê¸ˆ í™”ë©´ -->
  <div id="lockScreen" class="lock-screen">
    <div class="lock-card">
      <div class="lock-title">í•„ë¦„ ê´€ë¦¬ ì ê¸ˆ</div>
      <div class="lock-sub">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ë©´<br>íƒ­ì„ ë‹«ê¸° ì „ê¹Œì§€ëŠ” ê³„ì† ì—´ë ¤ ìˆì–´.</div>
      <div class="lock-input-wrap">
        <input type="password" id="passwordInput" maxlength="20" placeholder="â€¢â€¢â€¢â€¢" />
        <button class="btn btn-primary btn-small" id="passwordBtn">ì…ì¥</button>
      </div>
      <div class="lock-info">â€» ë¹„ë°€ë²ˆí˜¸ëŠ” ì´ ê¸°ê¸°/ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë˜ëŠ” ê°„ë‹¨ ì ê¸ˆì´ì•¼.</div>
    </div>
  </div>

  <!-- ë””ë°”ì´ìŠ¤ ì´ë¦„ ì…ë ¥ ëª¨ë‹¬ -->
  <div id="deviceModal" class="device-modal">
    <div class="device-modal-card">
      <div class="device-modal-title">ì´ ê¸°ê¸° ì´ë¦„ì„ ì •í•´ì¤˜</div>
      <div class="device-modal-sub">
        ì˜ˆ: <b>ê°€ì€í°</b>, <b>ì„±ê·œí°</b>, <b>íšŒì‚¬ì»´</b> ì²˜ëŸ¼ ì ì–´ë‘ë©´<br>
        íˆìŠ¤í† ë¦¬ë‘ ì•Œë¦¼ì— ì´ ì´ë¦„ì´ ê°™ì´ í‘œì‹œë¼.
      </div>
      <div class="form-row">
        <input type="text" id="deviceNameField" placeholder="ì˜ˆ: ê°€ì€í°" />
      </div>
      <div class="form-actions" style="justify-content:flex-end; margin-top:4px;">
        <button type="button" class="btn btn-secondary btn-small" id="deviceSkipBtn">ë‚˜ì¤‘ì—</button>
        <button type="button" class="btn btn-primary btn-small" id="deviceSaveBtn">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ì´ë¯¸ì§€ ì „ì²´ë³´ê¸° ë·°ì–´ -->
  <div id="imageViewer" class="image-viewer">
    <div class="image-viewer-backdrop" id="viewerBackdrop"></div>
    <div class="image-viewer-inner">
      <img id="viewerImage" src="" alt="í•„ë¦„ ì´ë¯¸ì§€" />
      <button id="closeViewerBtn" class="viewer-close-btn">âœ•</button>
    </div>
  </div>

  <!-- ì‹¤ì œ ì•± ë‚´ìš© -->
  <div id="appContainer" style="display:none;">
    <div class="header-row">
      <h1>í•„ë¦„ ê´€ë¦¬</h1>
      <div id="deviceBadge" class="device-badge"></div>
    </div>

    <div class="app-shell">
      <div class="top-bar">
        <input type="text" id="searchInput" placeholder="ì œí’ˆëª… / í•„ë¦„ë²ˆí˜¸ / ì œíŒë°©ì‹ / ìœ„ì¹˜ / ì œíŒë°©ë²• ê²€ìƒ‰" />
        <button class="btn btn-primary" id="newFilmBtn">+ ìƒˆ í•„ë¦„</button>
      </div>

      <div class="tools-bar">
        <button class="btn btn-secondary btn-small" id="settingsBtn">âš™ ì„¤ì •</button>
        <button class="btn btn-secondary btn-small" id="historyBtn">ğŸ“œ íˆìŠ¤í† ë¦¬</button>
        <button class="btn btn-secondary btn-small" id="exportBtn">ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
        <button class="btn btn-secondary btn-small" id="importBtn">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <input type="file" id="importFile" accept="application/json" style="display:none;" />
      </div>

      <!-- ì„¤ì • ì¹´ë“œ -->
      <div class="form-card" id="settingsCard" style="display:none;">
        <div class="form-row">
          <div class="settings-section-title">ì´ ê¸°ê¸° ì´ë¦„</div>
          <div class="settings-help">ì˜ˆ: ê°€ì€í°, ì„±ê·œí°, íšŒì‚¬ì»´. ì´ ê¸°ê¸°ì—ì„œë§Œ í‘œì‹œë¼.</div>
          <input type="text" id="deviceNameInput" placeholder="ê¸°ê¸° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" />
        </div>
        <div class="form-row">
          <div class="settings-section-title">ê¸°ë³¸ ì •ë ¬ ë°©ì‹</div>
          <div class="settings-help">ë¦¬ìŠ¤íŠ¸ë¥¼ ì–´ë–¤ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í• ì§€ ì„ íƒí•´.</div>
          <select id="sortOptionSelect">
            <option value="updated">ìµœê·¼ ìˆ˜ì •ìˆœ</option>
            <option value="name">ì œí’ˆëª… ê°€ë‚˜ë‹¤ìˆœ</option>
            <option value="number">í•„ë¦„ë²ˆí˜¸ ìˆœ</option>
            <option value="lastUsed">ë§ˆì§€ë§‰ ì‚¬ìš©ì¼ ìµœì‹ ìˆœ</option>
          </select>
        </div>
        <div class="form-row">
          <div class="settings-section-title">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</div>
          <div class="settings-help">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ì™€ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´.</div>
          <input type="password" id="currentPwInput" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸" />
          <input type="password" id="newPwInput" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" style="margin-top:6px;" />
          <input type="password" id="newPwConfirmInput" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸" style="margin-top:6px;" />
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary btn-small" id="closeSettingsBtn">ë‹«ê¸°</button>
          <button type="button" class="btn btn-primary btn-small" id="saveSettingsBtn">ì €ì¥</button>
        </div>
      </div>

      <!-- íˆìŠ¤í† ë¦¬ ì¹´ë“œ -->
      <div class="form-card" id="historyCard" style="display:none;">
        <div class="settings-section-title">ì‘ì—… íˆìŠ¤í† ë¦¬</div>
        <div class="settings-help">ìµœê·¼ 100ê°œì˜ ê¸°ë¡ë§Œ ë³´ì—¬ì¤˜.</div>
        <div id="historyList"></div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary btn-small" id="closeHistoryBtn">ë‹«ê¸°</button>
        </div>
      </div>

      <!-- í•„ë¦„ ì…ë ¥ í¼ -->
      <div class="form-card" id="formCard" style="display:none;">
        <form id="filmForm">
          <input type="hidden" id="filmId" />
          <div class="form-row">
            <label for="productName">ì œí’ˆ ì´ë¦„ *</label>
            <input type="text" id="productName" required />
          </div>
          <div class="form-row">
            <label for="filmNumber">í•„ë¦„ ë²ˆí˜¸ *</label>
            <input type="text" id="filmNumber" required />
          </div>
          <div class="form-row">
            <label for="method">ì œíŒ ë°©ì‹ (ììœ ì…ë ¥)</label>
            <input type="text" id="method" placeholder="ì˜ˆ: ë°”íƒ•, ë¬¸ì, ìŠ¤ëª¨ê·¸ ë“±" />
          </div>

          <div class="form-row">
            <label>í•„ë¦„ ì œíŒ ë°©ë²•</label>
            <div class="toggle-group" data-group="frontBack">
              <button type="button" class="toggle-btn" data-value="ì „ë©´">ì „ë©´</button>
              <button type="button" class="toggle-btn" data-value="ë°°ë©´">ë°°ë©´</button>
            </div>
            <div class="toggle-group" data-group="leftRight">
              <button type="button" class="toggle-btn" data-value="ì¢Œ">ì¢Œ</button>
              <button type="button" class="toggle-btn" data-value="ìš°">ìš°</button>
            </div>
            <div class="toggle-group" data-group="upDown">
              <button type="button" class="toggle-btn" data-value="ìƒ">ìƒ</button>
              <button type="button" class="toggle-btn" data-value="í•˜">í•˜</button>
            </div>
            <small style="font-size:11px; color:#7b7f9d;">
              ì „ë©´/ë°°ë©´ + ì¢Œ/ìš° + ìƒ/í•˜ ì¡°í•© (ì˜ˆ: ë°°ë©´ ì¢Œìƒ, ì „ë©´ ìš°í•˜ ë“±)
            </small>
          </div>

          <div class="form-row">
            <label for="location">í•„ë¦„ ìœ„ì¹˜</label>
            <input type="text" id="location" placeholder="ì˜ˆ: A-3 ì„œë, 4ì¸µ ìš°ì¸¡ ë™ ë“±" />
          </div>
          <div class="form-row">
            <label for="lastUsed">ë§ˆì§€ë§‰ ì‚¬ìš©ì¼</label>
            <div style="display:flex; gap:6px;">
              <input type="date" id="lastUsed" style="flex:1;" />
              <button type="button" class="btn btn-secondary btn-small" id="setTodayBtn">ì˜¤ëŠ˜</button>
            </div>
          </div>
          <div class="form-row">
            <label for="imageInput">í•„ë¦„ ì‚¬ì§„ (ì„ íƒ)</label>
            <input type="file" id="imageInput" accept="image/*" />
            <small style="font-size:11px; color:#7b7f9d;">
              Â· ìƒˆ í•„ë¦„ì—ëŠ” ì‚¬ì§„ì„ ì¶”ê°€í•˜ê³ ,<br/>
              Â· ìˆ˜ì • ì‹œ ì‚¬ì§„ì„ ë°”ê¾¸ê³  ì‹¶ì„ ë•Œë§Œ ë‹¤ì‹œ ì„ íƒí•˜ì„¸ìš”.
            </small>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="cancelBtn">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn-primary" id="saveBtn">ì €ì¥</button>
          </div>
        </form>
      </div>

      <div id="list" class="list"></div>
      <div id="emptyText" class="empty-text" style="display:none;">
        ë“±ë¡ëœ í•„ë¦„ì´ ì—†ìŠµë‹ˆë‹¤.<br/>ì˜¤ë¥¸ìª½ ìœ„ <b>+ ìƒˆ í•„ë¦„</b> ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€í•˜ì„¸ìš”.
      </div>
    </div>
  </div>

  <!-- í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
  <div id="toastContainer" class="toast-container"></div>

  <script type="module">
    // ===== Firebase ë¡œë“œ =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      updateDoc,
      deleteDoc,
      doc,
      onSnapshot,
      getDocs,
      query,
      orderBy,
      limit,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // ---- Firebase ì„¤ì • ----
    const firebaseConfig = {
      apiKey: "AIzaSyBrBnVuXca2Ou1oMFOLzq3KGEN8xiK5L_U",
      authDomain: "film-find-5242d.firebaseapp.com",
      projectId: "film-find-5242d",
      storageBucket: "film-find-5242d.firebasestorage.app",
      messagingSenderId: "185123433624",
      appId: "1:185123433624:web:269eb9b4b6437887f2f4ed",
      measurementId: "G-V9KL8XS9KJ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const filmsCol = collection(db, "films");
    const historyCol = collection(db, "history");

    // ---- í‚¤ ì„¤ì • ----
    const DEFAULT_PASSWORD = "1234";
    const PASSWORD_KEY = "filmAppPassword";
    const UNLOCK_KEY = "filmAppUnlocked";
    const DEVICE_KEY = "filmDeviceLabel";
    const SORT_KEY = "filmSortOption";

    let films = [];
    let editingId = null;
    let currentSearch = "";

    // ---- ë¹„ë°€ë²ˆí˜¸ / ì„¤ì • ìœ í‹¸ ----
    function getCurrentPassword() {
      return localStorage.getItem(PASSWORD_KEY) || DEFAULT_PASSWORD;
    }
    function setCurrentPassword(pw) {
      localStorage.setItem(PASSWORD_KEY, pw);
    }
    function getSortOption() {
      return localStorage.getItem(SORT_KEY) || "updated";
    }
    function setSortOption(opt) {
      localStorage.setItem(SORT_KEY, opt);
    }
    function getDeviceLabel() {
      return localStorage.getItem(DEVICE_KEY) || "";
    }
    function setDeviceLabel(label) {
      localStorage.setItem(DEVICE_KEY, label);
      const badge = document.getElementById("deviceBadge");
      if (badge) badge.textContent = label || "";
    }

    function formatDate(iso) {
      if (!iso) return "-";
      return iso;
    }

    // ìµœê·¼ ìˆ˜ì •ëœ í•„ë¦„ í•˜ë‚˜ ê°€ì ¸ì™€ì„œ ìƒˆ í•„ë¦„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©
    function getLastFilmForDefaults() {
      if (!films.length) return null;
      return films[0]; // Firestore ì •ë ¬ì´ ìµœê·¼ ìˆ˜ì •ìˆœì´ë¼ ë§¨ ì•ì´ ìµœì‹ 
    }

    // ---- ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ ----
    function renderList(filterText = "") {
      const listEl = document.getElementById("list");
      const emptyText = document.getElementById("emptyText");
      listEl.innerHTML = "";

      const text = (filterText || "").trim().toLowerCase();

      let filtered = films.filter(f => {
        if (!text) return true;
        const combined =
          (f.productName || "") + " " +
          (f.filmNumber || "") + " " +
          (f.method || "") + " " +
          (f.location || "") + " " +
          (f.plateInfo || "");
        return combined.toLowerCase().includes(text);
      });

      const sortOpt = getSortOption();
      filtered = filtered.slice().sort((a, b) => {
        if (sortOpt === "name") {
          return (a.productName || "").localeCompare(b.productName || "", "ko");
        } else if (sortOpt === "number") {
          return (a.filmNumber || "").localeCompare(b.filmNumber || "", "ko");
        } else if (sortOpt === "lastUsed") {
          const la = a.lastUsed || "";
          const lb = b.lastUsed || "";
          return (lb || "").localeCompare(la || "");
        } else { // updated
          const atA = a.updatedAt?.seconds || 0;
          const atB = b.updatedAt?.seconds || 0;
          return atB - atA;
        }
      });

      if (filtered.length === 0) {
        emptyText.style.display = "block";
        return;
      } else {
        emptyText.style.display = "none";
      }

      filtered.forEach(film => {
        const card = document.createElement("div");
        card.className = "card";

        const img = document.createElement("img");
        if (film.imageDataUrl) {
          img.src = film.imageDataUrl;
          img.addEventListener("click", () => {
            openImageViewer(film.imageDataUrl);
          });
        } else {
          img.alt = "ì´ë¯¸ì§€ ì—†ìŒ";
        }
        card.appendChild(img);

        const content = document.createElement("div");
        content.className = "card-content";

        const rowMain = document.createElement("div");
        rowMain.className = "card-row-main";
        const title = document.createElement("div");
        title.className = "card-title";
        title.textContent = film.productName || "(ì œí’ˆëª… ì—†ìŒ)";
        const tag = document.createElement("div");
        tag.className = "card-tag";
        tag.textContent = film.filmNumber || "ë²ˆí˜¸ ì—†ìŒ";
        rowMain.appendChild(title);
        rowMain.appendChild(tag);
        content.appendChild(rowMain);

        const rowMethod = document.createElement("div");
        rowMethod.className = "card-row";
        rowMethod.innerHTML = '<span class="label">ì œíŒë°©ì‹</span>' + (film.method || "-");
        content.appendChild(rowMethod);

        const rowPlate = document.createElement("div");
        rowPlate.className = "card-row";
        rowPlate.innerHTML = '<span class="label">ì œíŒ ë°©ë²•</span>' + (film.plateInfo || "-");
        content.appendChild(rowPlate);

        const rowLoc = document.createElement("div");
        rowLoc.className = "card-row";
        rowLoc.innerHTML = '<span class="label">í•„ë¦„ ìœ„ì¹˜</span>' + (film.location || "-");
        content.appendChild(rowLoc);

        const footer = document.createElement("div");
        footer.className = "card-footer";

        const lastUsed = document.createElement("div");
        lastUsed.className = "last-used";
        lastUsed.textContent = "ë§ˆì§€ë§‰ ì‚¬ìš©ì¼: " + formatDate(film.lastUsed || "");
        footer.appendChild(lastUsed);

        const btnWrap = document.createElement("div");
        btnWrap.className = "card-buttons";

        const useTodayBtn = document.createElement("button");
        useTodayBtn.className = "btn btn-secondary btn-small";
        useTodayBtn.textContent = "ì˜¤ëŠ˜ ì‚¬ìš©";
        useTodayBtn.addEventListener("click", () => {
          markFilmUsedToday(film.id);
        });

        const copyBtn = document.createElement("button");
        copyBtn.className = "btn btn-secondary btn-small";
        copyBtn.textContent = "ë³µì‚¬";
        copyBtn.addEventListener("click", () => {
          openFormCopyFrom(film.id);
        });

        const editBtn = document.createElement("button");
        editBtn.className = "btn btn-primary btn-small";
        editBtn.textContent = "ìˆ˜ì •";
        editBtn.addEventListener("click", () => {
          openFormForEdit(film.id);
        });

        const delBtn = document.createElement("button");
        delBtn.className = "btn btn-danger btn-small";
        delBtn.textContent = "ì‚­ì œ";
        delBtn.addEventListener("click", () => {
          if (confirm("ì´ í•„ë¦„ ì •ë³´ë¥¼ ì‚­ì œí• ê¹Œìš”?")) {
            deleteFilm(film.id);
          }
        });

        btnWrap.appendChild(useTodayBtn);
        btnWrap.appendChild(copyBtn);
        btnWrap.appendChild(editBtn);
        btnWrap.appendChild(delBtn);

        footer.appendChild(btnWrap);
        content.appendChild(footer);

        card.appendChild(content);
        listEl.appendChild(card);
      });
    }

    // ---- ì œíŒ ë°©ë²• í† ê¸€ ----
    function clearPlateInfoForm() {
      document.querySelectorAll(".toggle-btn").forEach(btn => {
        btn.classList.remove("active");
      });
    }

    function setPlateInfoToForm(str) {
      clearPlateInfoForm();
      if (!str) return;
      const parts = str.split(" ");
      document.querySelectorAll(".toggle-btn").forEach(btn => {
        if (parts.includes(btn.dataset.value)) {
          btn.classList.add("active");
        }
      });
    }

    function getPlateInfoFromForm() {
      const groups = document.querySelectorAll(".toggle-group");
      const values = [];
      groups.forEach(group => {
        const active = group.querySelector(".toggle-btn.active");
        if (active) values.push(active.dataset.value);
      });
      return values.join(" ");
    }

    // ---- í¼ ----
    function resetForm() {
      document.getElementById("filmId").value = "";
      document.getElementById("productName").value = "";
      document.getElementById("filmNumber").value = "";
      document.getElementById("method").value = "";
      document.getElementById("location").value = "";
      document.getElementById("lastUsed").value = "";
      document.getElementById("imageInput").value = "";
      clearPlateInfoForm();
      editingId = null;
    }

    function openFormNew() {
      resetForm();
      const last = getLastFilmForDefaults();
      if (last) {
        document.getElementById("method").value = last.method || "";
        document.getElementById("location").value = last.location || "";
        setPlateInfoToForm(last.plateInfo || "");
      }
      document.getElementById("formCard").style.display = "block";
      document.getElementById("productName").focus();
    }

    function openFormCopyFrom(id) {
      const film = films.find(f => f.id === id);
      if (!film) return;
      resetForm();
      document.getElementById("productName").value = film.productName || "";
      document.getElementById("filmNumber").value = ""; // ë²ˆí˜¸ëŠ” ìƒˆë¡œ ì“°ë„ë¡
      document.getElementById("method").value = film.method || "";
      document.getElementById("location").value = film.location || "";
      document.getElementById("lastUsed").value = "";
      setPlateInfoToForm(film.plateInfo || "");
      document.getElementById("formCard").style.display = "block";
      document.getElementById("productName").focus();
    }

    function openFormForEdit(id) {
      const film = films.find(f => f.id === id);
      if (!film) return;
      editingId = id;
      document.getElementById("filmId").value = film.id;
      document.getElementById("productName").value = film.productName || "";
      document.getElementById("filmNumber").value = film.filmNumber || "";
      document.getElementById("method").value = film.method || "";
      document.getElementById("location").value = film.location || "";
      document.getElementById("lastUsed").value = film.lastUsed || "";
      document.getElementById("imageInput").value = "";
      setPlateInfoToForm(film.plateInfo || "");
      document.getElementById("formCard").style.display = "block";
      document.getElementById("productName").focus();
    }

    function closeForm() {
      document.getElementById("formCard").style.display = "none";
      resetForm();
    }

    // ---- ì´ë¯¸ì§€ ì••ì¶• ----
    function compressImage(dataUrl, callback) {
      const img = new Image();
      img.onload = function () {
        const maxSize = 700;
        let w = img.width;
        let h = img.height;
        const ratio = Math.min(maxSize / w, maxSize / h, 1);
        w = Math.round(w * ratio);
        h = Math.round(h * ratio);

        const canvas = document.createElement("canvas");
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, w, h);
        const compressed = canvas.toDataURL("image/jpeg", 0.7);
        callback(compressed);
      };
      img.onerror = function () {
        callback(dataUrl);
      };
      img.src = dataUrl;
    }

    // ---- íˆìŠ¤í† ë¦¬ ê¸°ë¡ ----
    async function addHistory(action, filmId, baseData) {
      try {
        await addDoc(historyCol, {
          action,
          filmId,
          productName: baseData.productName || "",
          filmNumber: baseData.filmNumber || "",
          deviceName: getDeviceLabel() || "",
          createdAt: serverTimestamp()
        });
      } catch (e) {
        console.error("íˆìŠ¤í† ë¦¬ ì €ì¥ ì‹¤íŒ¨", e);
      }
    }

    // ---- í•„ë¦„ ì €ì¥/ìˆ˜ì • ----
    async function saveFilmFromForm(event) {
      if (event) event.preventDefault();
      const id = document.getElementById("filmId").value || null;
      const productName = document.getElementById("productName").value.trim();
      const filmNumber = document.getElementById("filmNumber").value.trim();
      const method = document.getElementById("method").value.trim();
      const location = document.getElementById("location").value.trim();
      const lastUsed = document.getElementById("lastUsed").value || "";
      const plateInfo = getPlateInfoFromForm();
      const imageInput = document.getElementById("imageInput");

      if (!productName || !filmNumber) {
        alert("ì œí’ˆ ì´ë¦„ê³¼ í•„ë¦„ ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");
        return;
      }

      const baseData = {
        productName,
        filmNumber,
        method,
        location,
        lastUsed,
        plateInfo
      };

      const saveBtn = document.getElementById("saveBtn");
      saveBtn.disabled = true;
      saveBtn.textContent = "ì €ì¥ ì¤‘...";

      async function finalizeSave(imageDataUrl) {
        try {
          if (id) {
            const ref = doc(db, "films", id);
            await updateDoc(ref, {
              ...baseData,
              imageDataUrl: imageDataUrl === null ? undefined : imageDataUrl,
              updatedAt: serverTimestamp()
            });
            await addHistory("update", id, baseData);
          } else {
            const ref = await addDoc(filmsCol, {
              ...baseData,
              imageDataUrl: imageDataUrl || "",
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp()
            });
            await addHistory("create", ref.id, baseData);
          }

          alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
          const searchInput = document.getElementById("searchInput");
          if (searchInput) searchInput.value = "";
          currentSearch = "";
          closeForm();
        } catch (e) {
          console.error("ì €ì¥ ì‹¤íŒ¨", e);
          alert("ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´.");
        } finally {
          saveBtn.disabled = false;
          saveBtn.textContent = "ì €ì¥";
        }
      }

      if (imageInput.files && imageInput.files[0]) {
        const file = imageInput.files[0];
        const reader = new FileReader();
        reader.onload = function (e) {
          const originalDataUrl = e.target.result;
          compressImage(originalDataUrl, function (compressedDataUrl) {
            finalizeSave(compressedDataUrl);
          });
        };
        reader.readAsDataURL(file);
      } else {
        finalizeSave(id ? null : "");
      }
    }

    // ---- ì˜¤ëŠ˜ ì‚¬ìš© ì²˜ë¦¬ ----
    async function markFilmUsedToday(id) {
      const film = films.find(f => f.id === id);
      if (!film) return;
      const today = new Date().toISOString().slice(0, 10);
      try {
        const ref = doc(db, "films", id);
        await updateDoc(ref, {
          lastUsed: today,
          updatedAt: serverTimestamp()
        });
        await addHistory("useToday", id, film);
      } catch (e) {
        console.error("ì˜¤ëŠ˜ ì‚¬ìš© ì²˜ë¦¬ ì‹¤íŒ¨", e);
        alert("ì˜¤ëŠ˜ ì‚¬ìš© ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´.");
      }
    }

    // ---- í•„ë¦„ ì‚­ì œ ----
    async function deleteFilm(id) {
      const film = films.find(f => f.id === id);
      try {
        const ref = doc(db, "films", id);
        await deleteDoc(ref);
        if (film) {
          await addHistory("delete", id, film);
        }
      } catch (e) {
        console.error("ì‚­ì œ ì‹¤íŒ¨", e);
        alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´.");
      }
    }

    // ---- ë°ì´í„° ë‚´ë³´ë‚´ê¸° / ë¶ˆëŸ¬ì˜¤ê¸° ----
    function exportData() {
      const json = JSON.stringify(films, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const date = new Date().toISOString().slice(0,10).replace(/-/g,"");
      a.href = url;
      a.download = "films_" + date + ".json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    async function importData(file) {
      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (!Array.isArray(data)) {
            alert("í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì€ íŒŒì¼ì…ë‹ˆë‹¤.");
            return;
          }
          // ë‹¨ìˆœíˆ ìƒˆë¡œ ì¶”ê°€ë§Œ (ë®ì–´ì“°ì§€ëŠ” ì•ŠìŒ)
          for (const item of data) {
            const base = {
              productName: item.productName || "",
              filmNumber: item.filmNumber || "",
              method: item.method || "",
              location: item.location || "",
              lastUsed: item.lastUsed || "",
              plateInfo: item.plateInfo || "",
              imageDataUrl: item.imageDataUrl || ""
            };
            const ref = await addDoc(filmsCol, {
              ...base,
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp()
            });
            await addHistory("create", ref.id, base);
          }
          alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
        } catch (err) {
          console.error(err);
          alert("íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      };
      reader.readAsText(file, "utf-8");
    }

    // ---- ì„¤ì • ì²˜ë¦¬ ----
    function openSettings() {
      const card = document.getElementById("settingsCard");
      card.style.display = "block";
      document.getElementById("deviceNameInput").value = getDeviceLabel();
      document.getElementById("sortOptionSelect").value = getSortOption();
      document.getElementById("currentPwInput").value = "";
      document.getElementById("newPwInput").value = "";
      document.getElementById("newPwConfirmInput").value = "";
    }
    function closeSettings() {
      document.getElementById("settingsCard").style.display = "none";
    }

    function saveSettings() {
      const deviceName = document.getElementById("deviceNameInput").value.trim();
      const sortOpt = document.getElementById("sortOptionSelect").value;
      const currentPw = document.getElementById("currentPwInput").value;
      const newPw = document.getElementById("newPwInput").value;
      const newPw2 = document.getElementById("newPwConfirmInput").value;

      setDeviceLabel(deviceName);
      setSortOption(sortOpt);

      if (newPw || newPw2 || currentPw) {
        if (currentPw !== getCurrentPassword()) {
          alert("í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          return;
        }
        if (!newPw) {
          alert("ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
          return;
        }
        if (newPw !== newPw2) {
          alert("ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì„œë¡œ ë‹¤ë¦…ë‹ˆë‹¤.");
          return;
        }
        if (newPw.length < 4) {
          alert("ë¹„ë°€ë²ˆí˜¸ëŠ” 4ê¸€ì ì´ìƒìœ¼ë¡œ ì„¤ì •í•´ ì£¼ì„¸ìš”.");
          return;
        }
        setCurrentPassword(newPw);
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
      } else {
        alert("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }

      closeSettings();
      renderList(currentSearch);
    }

    // ---- íˆìŠ¤í† ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° ----
    async function openHistory() {
      const card = document.getElementById("historyCard");
      card.style.display = "block";
      const listEl = document.getElementById("historyList");
      listEl.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

      try {
        const qHist = query(historyCol, orderBy("createdAt", "desc"), limit(100));
        const snap = await getDocs(qHist);
        if (snap.empty) {
          listEl.innerHTML = '<div class="history-item">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }
        listEl.innerHTML = "";
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const ts = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate() : null;
          const timeStr = ts ? ts.toLocaleString("ko-KR", { month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" }) : "-";
          const actMap = {
            create: "ìƒˆ í•„ë¦„ ë“±ë¡",
            update: "í•„ë¦„ ìˆ˜ì •",
            delete: "í•„ë¦„ ì‚­ì œ",
            useToday: "ì˜¤ëŠ˜ ì‚¬ìš© ì²˜ë¦¬"
          };
          const div = document.createElement("div");
          div.className = "history-item";
          div.innerHTML =
            '<div class="history-main">[' + (d.deviceName || "ì•Œìˆ˜ì—†ìŒ") + '] ' +
            (actMap[d.action] || d.action) + '</div>' +
            '<div class="history-meta">' +
            (timeStr || "-") + " Â· " +
            (d.productName || "(ì œí’ˆëª… ì—†ìŒ)") +
            (d.filmNumber ? " (" + d.filmNumber + ")" : "") +
            "</div>";
          listEl.appendChild(div);
        });
      } catch (e) {
        console.error(e);
        listEl.innerHTML = '<div class="history-item">íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
      }
    }

    function closeHistory() {
      document.getElementById("historyCard").style.display = "none";
    }

    // ---- í† ìŠ¤íŠ¸ ì•Œë¦¼ ----
    function showToast(message) {
      const container = document.getElementById("toastContainer");
      const div = document.createElement("div");
      div.className = "toast";
      div.textContent = message;
      container.appendChild(div);
      setTimeout(() => {
        container.removeChild(div);
      }, 4500);
    }

    let historySubscribeInitialized = false;
    function subscribeHistoryNotifications() {
      const actMap = {
        create: "ìƒˆ í•„ë¦„ ë“±ë¡",
        update: "í•„ë¦„ ìˆ˜ì •",
        delete: "í•„ë¦„ ì‚­ì œ",
        useToday: "ì˜¤ëŠ˜ ì‚¬ìš© ì²˜ë¦¬"
      };
      const qHist = query(historyCol, orderBy("createdAt", "desc"), limit(20));
      onSnapshot(qHist, snapshot => {
        if (!historySubscribeInitialized) {
          historySubscribeInitialized = true;
          return; // ì²˜ìŒ ë¡œë”© ì‹œì—ëŠ” ì•Œë¦¼ ì•ˆ ë„ì›€
        }
        snapshot.docChanges().forEach(change => {
          if (change.type !== "added") return;
          const d = change.doc.data();
          // ê°™ì€ ê¸°ê¸°ì—ì„œ í•œ ì‘ì—…ì€ êµ³ì´ ì•Œë¦¼ ì•ˆ ë„ì›Œë„ ë¨
          if ((d.deviceName || "") === (getDeviceLabel() || "")) return;
          const act = actMap[d.action] || d.action;
          const msg =
            "[" + (d.deviceName || "ë‹¤ë¥¸ ê¸°ê¸°") + "] " +
            act + " - " +
            (d.productName || "") +
            (d.filmNumber ? " (" + d.filmNumber + ")" : "");
          showToast(msg.trim());
        });
      });
    }

    // ---- ì´ë¯¸ì§€ ë·°ì–´(íŒì—… + í•€ì¹˜ ì¤Œ) ----
    let viewerScale = 1;
    let viewerStartDist = 0;
    let viewerLastScale = 1;
    let viewerTransX = 0;
    let viewerTransY = 0;
    let panStartX = 0;
    let panStartY = 0;
    let isPanning = false;

    function resetViewerTransform() {
      viewerScale = 1;
      viewerTransX = 0;
      viewerTransY = 0;
      viewerStartDist = 0;
      viewerLastScale = 1;
      isPanning = false;
      const img = document.getElementById("viewerImage");
      img.style.transform = "translate(0px, 0px) scale(1)";
    }

    function updateViewerTransform() {
      const img = document.getElementById("viewerImage");
      img.style.transform = "translate(" + viewerTransX + "px, " + viewerTransY + "px) scale(" + viewerScale + ")";
    }

    function openImageViewer(src) {
      if (!src) return;
      const viewer = document.getElementById("imageViewer");
      const img = document.getElementById("viewerImage");
      img.src = src;
      resetViewerTransform();
      viewer.style.display = "flex";
    }

    function closeImageViewer() {
      const viewer = document.getElementById("imageViewer");
      viewer.style.display = "none";
    }

    function initImageViewerTouch() {
      const img = document.getElementById("viewerImage");
      const viewer = document.getElementById("imageViewer");

      viewer.addEventListener("click", (e) => {
        if (e.target.id === "viewerBackdrop") {
          closeImageViewer();
        }
      });

      img.addEventListener("touchstart", (e) => {
        if (e.touches.length === 2) {
          e.preventDefault();
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          viewerStartDist = Math.sqrt(dx*dx + dy*dy);
          viewerLastScale = viewerScale;
        } else if (e.touches.length === 1 && viewerScale > 1) {
          isPanning = true;
          panStartX = e.touches[0].clientX - viewerTransX;
          panStartY = e.touches[0].clientY - viewerTransY;
        }
      }, { passive: false });

      img.addEventListener("touchmove", (e) => {
        if (e.touches.length === 2) {
          e.preventDefault();
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          const dist = Math.sqrt(dx*dx + dy*dy);
          if (viewerStartDist > 0) {
            let scale = viewerLastScale * (dist / viewerStartDist);
            if (scale < 1) scale = 1;
            if (scale > 4) scale = 4;
            viewerScale = scale;
            updateViewerTransform();
          }
        } else if (e.touches.length === 1 && isPanning) {
          e.preventDefault();
          viewerTransX = e.touches[0].clientX - panStartX;
          viewerTransY = e.touches[0].clientY - panStartY;
          updateViewerTransform();
        }
      }, { passive: false });

      img.addEventListener("touchend", (e) => {
        if (e.touches.length < 2) {
          viewerStartDist = 0;
          viewerLastScale = viewerScale;
        }
        if (e.touches.length === 0) {
          isPanning = false;
        }
      });
    }

    // ---- Firestore ì‹¤ì‹œê°„ í•„ë¦„ êµ¬ë… ----
    function subscribeFilms() {
      const qFilms = query(filmsCol, orderBy("updatedAt", "desc"));
      onSnapshot(qFilms, snapshot => {
        films = snapshot.docs.map(d => ({
          id: d.id,
          ...d.data()
        }));
        renderList(currentSearch);
      });
    }

    // ---- ë””ë°”ì´ìŠ¤ ì´ë¦„ ëª¨ë‹¬ ----
    function maybeAskDeviceName(onDone) {
      const current = getDeviceLabel();
      setDeviceLabel(current); // ë°°ì§€ ì—…ë°ì´íŠ¸

      if (current) {
        if (onDone) onDone();
        return;
      }

      const modal = document.getElementById("deviceModal");
      const field = document.getElementById("deviceNameField");
      const saveBtn = document.getElementById("deviceSaveBtn");
      const skipBtn = document.getElementById("deviceSkipBtn");

      modal.style.display = "flex";
      field.value = "";
      field.focus();

      function finish() {
        modal.style.display = "none";
        saveBtn.removeEventListener("click", onSave);
        skipBtn.removeEventListener("click", onSkip);
        field.removeEventListener("keydown", onKey);
        if (onDone) onDone();
      }
      function onSave() {
        const v = field.value.trim();
        if (!v) {
          alert("ê¸°ê¸° ì´ë¦„ì„ ì…ë ¥í•´ì¤˜.");
          field.focus();
          return;
        }
        setDeviceLabel(v);
        finish();
      }
      function onSkip() {
        finish();
      }
      function onKey(e) {
        if (e.key === "Enter") onSave();
      }

      saveBtn.addEventListener("click", onSave);
      skipBtn.addEventListener("click", onSkip);
      field.addEventListener("keydown", onKey);
    }

    // ---- ì•± ì´ˆê¸°í™” ----
    function initApp() {
      setDeviceLabel(getDeviceLabel());
      document.getElementById("sortOptionSelect").value = getSortOption();
      renderList();

      document.getElementById("newFilmBtn").addEventListener("click", openFormNew);
      document.getElementById("cancelBtn").addEventListener("click", closeForm);
      document.getElementById("filmForm").addEventListener("submit", saveFilmFromForm);
      document.getElementById("saveBtn").addEventListener("click", saveFilmFromForm);
      document.getElementById("searchInput").addEventListener("input", (e) => {
        currentSearch = e.target.value;
        renderList(currentSearch);
      });
      document.getElementById("setTodayBtn").addEventListener("click", () => {
        const today = new Date().toISOString().slice(0, 10);
        document.getElementById("lastUsed").value = today;
      });

      document.querySelectorAll(".toggle-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const group = btn.closest(".toggle-group");
          group.querySelectorAll(".toggle-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
        });
      });

      document.getElementById("exportBtn").addEventListener("click", exportData);
      document.getElementById("importBtn").addEventListener("click", () => {
        document.getElementById("importFile").click();
      });
      document.getElementById("importFile").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) importData(file);
        e.target.value = "";
      });

      document.getElementById("settingsBtn").addEventListener("click", openSettings);
      document.getElementById("closeSettingsBtn").addEventListener("click", closeSettings);
      document.getElementById("saveSettingsBtn").addEventListener("click", saveSettings);

      document.getElementById("historyBtn").addEventListener("click", openHistory);
      document.getElementById("closeHistoryBtn").addEventListener("click", closeHistory);

      document.getElementById("closeViewerBtn").addEventListener("click", closeImageViewer);
      initImageViewerTouch();

      subscribeFilms();
      subscribeHistoryNotifications();
    }

    // ---- ì ê¸ˆ í™”ë©´ ----
    document.addEventListener("DOMContentLoaded", () => {
      const lockScreen = document.getElementById("lockScreen");
      const appContainer = document.getElementById("appContainer");
      const pwInput = document.getElementById("passwordInput");
      const pwBtn = document.getElementById("passwordBtn");

      function afterUnlock() {
        lockScreen.style.display = "none";
        appContainer.style.display = "block";
        maybeAskDeviceName(initApp);
      }

      function unlock() {
        const v = pwInput.value.trim();
        if (v === getCurrentPassword()) {
          sessionStorage.setItem(UNLOCK_KEY, "true");
          afterUnlock();
        } else {
          alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ì–´.");
          pwInput.focus();
          pwInput.select();
        }
      }

      const unlocked = sessionStorage.getItem(UNLOCK_KEY) === "true";
      if (unlocked) {
        afterUnlock();
      } else {
        lockScreen.style.display = "flex";
        appContainer.style.display = "none";
      }

      pwBtn.addEventListener("click", unlock);
      pwInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          unlock();
        }
      });
    });
  </script>
</body>
</html>
