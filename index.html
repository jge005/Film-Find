<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#f9f4ff">
  <meta charset="UTF-8" />
  <title>FILM FIND - í•„ë¦„/íŒ ê´€ë¦¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- í°íŠ¸ (Pretendard) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css" />

  <style>
    :root {
      /* ê¸°ë³¸(ë¼ë²¤ë”) í…Œë§ˆ */
      --bg-gradient: linear-gradient(145deg, #f9fafb, #f4f0ff, #fdf2f8);
      --card-bg: rgba(255,255,255,0.98);
      --card-border: #e3e6ff;
      --shadow-soft: 0 8px 20px rgba(167, 173, 208, 0.35);

      --text-main: #272a3f;
      --text-sub: #767a98;
      --text-muted: #777b9e;
      --label-color: #8689a5;

      --primary-1: #7f9dff;
      --primary-2: #b38cff;
      --primary-soft: rgba(228,231,255,0.95);

      --chip-bg: #f3e8ff;
      --chip-text: #5f308c;

      --danger-bg: #ff6b81;
      --danger-text: #ffffff;

      --pill-bg: rgba(228,231,255,0.98);
      --pill-border: rgba(129, 140, 248, 0.4);

      --toast-bg: rgba(15,23,42,0.9);
      --toast-text: #f9fafb;

      --spinner-border: rgba(191, 219, 254, 0.9);
      --spinner-glow: rgba(129, 140, 248, 0.7);
    }

    /* ë¯¼íŠ¸ í…Œë§ˆ */
    [data-theme="mint"] {
      --bg-gradient: linear-gradient(145deg, #f0fdfa, #e0f2fe, #fefce8);
      --primary-1: #34d399;
      --primary-2: #22c55e;
      --primary-soft: rgba(187,247,208,0.85);
      --chip-bg: #dcfce7;
      --chip-text: #047857;
      --pill-bg: rgba(219, 234, 254, 0.96);
      --pill-border: rgba(45, 212, 191, 0.5);
      --spinner-border: rgba(167, 243, 208, 0.9);
      --spinner-glow: rgba(45, 212, 191, 0.7);
    }

    /* í”¼ì¹˜ í…Œë§ˆ */
    [data-theme="peach"] {
      --bg-gradient: linear-gradient(145deg, #fff7ed, #fee2e2, #fef9c3);
      --primary-1: #fb7185;
      --primary-2: #f97316;
      --primary-soft: rgba(254, 226, 226, 0.9);
      --chip-bg: #ffe4e6;
      --chip-text: #be123c;
      --pill-bg: rgba(254, 226, 226, 0.96);
      --pill-border: rgba(248, 113, 113, 0.55);
      --spinner-border: rgba(254, 202, 202, 0.9);
      --spinner-glow: rgba(248, 113, 113, 0.75);
    }

    /* ë‚˜ì´íŠ¸(ì–´ë‘ìš´) í…Œë§ˆ */
    [data-theme="night"] {
      --bg-gradient: radial-gradient(circle at top, #020617, #020617, #111827);
      --card-bg: rgba(15,23,42,0.98);
      --card-border: #1f2937;
      --shadow-soft: 0 10px 24px rgba(15, 23, 42, 0.75);

      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --text-muted: #9ca3af;
      --label-color: #9ca3af;

      --primary-1: #6366f1;
      --primary-2: #a855f7;
      --primary-soft: rgba(79,70,229,0.22);

      --chip-bg: rgba(79,70,229,0.18);
      --chip-text: #a5b4fc;

      --danger-bg: #f97373;
      --danger-text: #111827;

      --pill-bg: rgba(17,24,39,0.95);
      --pill-border: rgba(129, 140, 248, 0.8);

      --toast-bg: rgba(17,24,39,0.95);
      --toast-text: #e5e7eb;

      --spinner-border: rgba(55, 65, 81, 0.9);
      --spinner-glow: rgba(129, 140, 248, 0.85);
    }

    * {
      box-sizing: border-box;
      font-family: "Pretendard Variable", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg-gradient);
      padding: 12px;
      color: var(--text-main);
    }

    .app-shell {
      max-width: 720px;
      margin: 0 auto;
    }

    /* ìƒë‹¨ í—¤ë” */
    .app-header {
      max-width: 720px;
      margin: 0 auto 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .title-wrap {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .app-title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 2px;
      color: var(--text-main);
    }
    .app-subtitle {
      font-size: 11px;
      color: var(--text-sub);
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }
    .mode-chip {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--chip-bg);
      color: var(--chip-text);
      border: 1px solid rgba(0,0,0,0.03);
    }

    .device-badge {
      font-size: 11px;
      padding: 4px 12px;
      border-radius: 999px;
      background: var(--pill-bg);
      color: var(--text-sub);
      white-space: nowrap;
      max-width: 170px;
      text-overflow: ellipsis;
      overflow: hidden;
      border: 1px solid var(--pill-border);
      box-shadow: 0 0 8px rgba(129, 140, 248, 0.28);
      display: flex;
      align-items: center;
      gap: 4px;
      justify-content: flex-end;
    }
    .device-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--primary-1);
      box-shadow: 0 0 6px rgba(129, 140, 248, 0.9);
    }

    .top-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .top-bar input[type="text"] {
      flex: 1;
      padding: 9px 11px;
      border-radius: 999px;
      border: 1px solid var(--card-border);
      font-size: 14px;
      min-width: 0;
      background: rgba(255,255,255,0.9);
      color: var(--text-main);
    }
    .top-bar input::placeholder {
      color: var(--text-muted);
    }

    [data-theme="night"] .top-bar input[type="text"] {
      background: #020617;
      border-color: #1f2937;
    }

    .btn {
      padding: 8px 11px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      transition: transform 0.05s ease, box-shadow 0.1s ease, background 0.1s ease, opacity 0.1s ease;
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
      opacity: 0.92;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-1), var(--primary-2));
      color: white;
      box-shadow: 0 4px 10px rgba(127,157,255,0.35);
    }
    .btn-secondary {
      background: var(--primary-soft);
      color: #283252;
    }
    [data-theme="night"] .btn-secondary {
      color: #e5e7eb;
    }
    .btn-danger {
      background: var(--danger-bg);
      color: var(--danger-text);
    }
    .btn-small {
      font-size: 12px;
      padding: 5px 9px;
      border-radius: 999px;
    }

    .tools-bar {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    /* íƒ­(í•„ë¦„/íŒ) */
    .tab-bar {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
      flex-wrap: wrap;
      justify-content: flex-start;
    }
    .tab-btn {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid var(--card-border);
      background: #f5f3ff;
      color: #464b73;
      cursor: pointer;
    }
    .tab-btn.active {
      border-color: var(--primary-1);
      background: var(--primary-1);
      color: #fff;
    }

    /* ì¹´ìš´íŠ¸ + ë·° ì „í™˜ */
    .count-wrap {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }
    .count-bar {
      font-size: 11px;
      color: var(--text-muted);
      text-align: left;
      flex: 1;
    }
    .count-bar strong {
      color: var(--primary-1);
    }

    .form-card {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 12px 14px;
      margin-bottom: 12px;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--card-border);
    }
    .form-row {
      display: flex;
      flex-direction: column;
      margin-bottom: 9px;
    }
    .form-row label {
      font-size: 12px;
      margin-bottom: 4px;
      color: var(--label-color);
    }
    .form-row input[type="text"],
    .form-row input[type="date"],
    .form-row input[type="password"],
    .form-row input[type="number"],
    .form-row textarea,
    .form-row select {
      padding: 7px 10px;
      border-radius: 10px;
      border: 1px solid var(--card-border);
      font-size: 13px;
      background: #f9f9ff;
      color: var(--text-main);
    }
    .form-row textarea { min-height: 90px; resize: vertical; }

    [data-theme="night"] .form-row input[type="text"],
    [data-theme="night"] .form-row input[type="date"],
    [data-theme="night"] .form-row input[type="password"],
    [data-theme="night"] .form-row input[type="number"],
    [data-theme="night"] .form-row textarea,
    [data-theme="night"] .form-row select {
      background: #020617;
      border-color: #1f2937;
      color: #e5e7eb;
    }
    .form-row input[type="file"] {
      font-size: 12px;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 6px;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 24px;
    }

    /* ê°¤ëŸ¬ë¦¬ ëª¨ë“œ (ë°˜ì‘í˜•) */
    .list.gallery {
      display: grid;
      grid-template-columns: 1fr; /* ëª¨ë°”ì¼: 1ì—´ */
      gap: 12px;
    }
    .list.gallery .card {
      flex-direction: column;
      align-items: stretch;
    }
    .list.gallery .card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
    }

    .card {
      background: rgba(255,255,255,0.96);
      border-radius: 16px;
      padding: 10px;
      display: flex;
      gap: 10px;
      box-shadow: 0 6px 16px rgba(169, 177, 214, 0.35);
      align-items: flex-start;
      border: 1px solid var(--card-border);
      animation: cardFadeIn 0.18s ease-out;
    }
    [data-theme="night"] .card {
      background: rgba(15,23,42,0.98);
      box-shadow: 0 8px 22px rgba(15,23,42,0.85);
    }

    @keyframes cardFadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card img {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 12px;
      background: #eef1ff;
      flex-shrink: 0;
      cursor: pointer;
    }
    .card-content { flex: 1; font-size: 13px; }
    .card-row-main {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 4px;
      align-items: center;
    }
    .card-title { font-weight: 600; font-size: 14px; color: var(--text-main); }
    .card-tag {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      background: var(--chip-bg);
      color: var(--chip-text);
      align-self: flex-start;
    }
    .card-row { margin-bottom: 2px; color: var(--text-main); }
    .label { color: var(--label-color); font-size: 11px; margin-right: 4px; }
    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
      gap: 6px;
      flex-wrap: wrap;
    }
    .last-used { font-size: 11px; color: var(--text-muted); }
    .card-buttons { display: flex; gap: 4px; flex-wrap: wrap; }

    .empty-text {
      text-align: center;
      color: #777;
      font-size: 13px;
      margin-top: 20px;
    }
    [data-theme="night"] .empty-text { color: #9ca3af; }

    .toggle-group { display: flex; gap: 6px; margin-bottom: 4px; flex-wrap: wrap; }
    .toggle-btn {
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid var(--card-border);
      background: #f5f3ff;
      color: #464b73;
      cursor: pointer;
      transition: background 0.1s ease, color 0.1s ease, border 0.1s ease;
    }
    .toggle-btn.active {
      border-color: var(--primary-1);
      background: var(--primary-1);
      color: #fff;
    }

    /* ì ê¸ˆ í™”ë©´ */
    .lock-screen {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(255,255,255,0.95), rgba(203,213,255,0.96));
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 1000;
    }
    .lock-card {
      width: 100%;
      max-width: 320px;
      margin: 0 auto;
      background: rgba(255,255,255,0.98);
      border-radius: 20px;
      padding: 18px 18px 16px;
      box-shadow: 0 12px 28px rgba(136, 144, 195, 0.55);
      border: 1px solid #dde1ff;
      text-align: center;
    }
    .lock-title {
      font-size: 18px;
      margin-bottom: 8px;
      font-weight: 600;
      color: #303656;
    }
    .lock-sub {
      font-size: 12px;
      color: #7b7f9d;
      margin-bottom: 14px;
    }
    .lock-input-wrap {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      align-items: center;
      justify-content: space-between;
    }
    .lock-input-wrap input {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #d6d9ff;
      background: #f7f7ff;
      text-align: center;
      font-size: 14px;
      letter-spacing: 3px;
      min-width: 0;
    }

    .settings-section-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #3c4266;
    }
    .settings-help {
      font-size: 11px;
      color: #8a8fb0;
      margin-bottom: 6px;
    }
    [data-theme="night"] .settings-section-title { color: #e5e7eb; }
    [data-theme="night"] .settings-help { color: #9ca3af; }

    /* ì´ë¯¸ì§€ ì „ì²´ ë³´ê¸° */
    .image-viewer {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1500;
    }
    .image-viewer-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.75);
    }
    .image-viewer-inner {
      position: relative;
      max-width: 100%;
      max-height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    #viewerImage {
      max-width: 100%;
      max-height: 100%;
      border-radius: 12px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.5);
      touch-action: none;
      transition: transform 0.1s ease-out;
    }
    .viewer-close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      border-radius: 999px;
      border: none;
      padding: 6px 10px;
      font-size: 14px;
      cursor: pointer;
      background: rgba(15,23,42,0.8);
      color: #f9fafb;
    }

    /* ê¸°ê¸° ì´ë¦„ ìµœì´ˆ ì…ë ¥ ëª¨ë‹¬ */
    .device-modal {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1200;
      padding: 16px;
    }
    .device-modal-card {
      background: #fff;
      border-radius: 18px;
      padding: 16px 18px 14px;
      max-width: 320px;
      width: 100%;
      box-shadow: 0 10px 24px rgba(0,0,0,0.25);
    }
    .device-modal-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #272a3f;
    }
    .device-modal-text {
      font-size: 12px;
      color: #767a98;
      margin-bottom: 10px;
    }
    .device-modal-input {
      width: 100%;
      padding: 7px 10px;
      border-radius: 10px;
      border: 1px solid #d6d9ff;
      font-size: 13px;
      background: #f9f9ff;
      margin-bottom: 10px;
    }
    .device-modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
    }

    /* í† ìŠ¤íŠ¸ */
    .toast {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%) translateY(40px);
      background: var(--toast-bg);
      color: var(--toast-text);
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 2000;
      max-width: 80%;
      text-align: center;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      box-shadow: 0 10px 24px rgba(15,23,42,0.6);
    }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* íˆìŠ¤í† ë¦¬ íƒ€ì„ë¼ì¸ */
    .history-list {
      max-height: 280px;
      overflow-y: auto;
      padding-right: 4px;
      margin-top: 4px;
      position: relative;
    }
    .history-list::before {
      content: "";
      position: absolute;
      left: 8px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: linear-gradient(to bottom, rgba(148,163,184,0.6), rgba(199,210,254,0.2));
    }
    .history-row {
      font-size: 12px;
      color: #444867;
      padding: 6px 2px 6px 20px;
      position: relative;
    }
    [data-theme="night"] .history-row { color: #e5e7eb; }
    .history-row::before {
      content: "";
      position: absolute;
      left: 4px;
      top: 10px;
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #fff;
      border: 2px solid var(--primary-1);
      box-shadow: 0 0 0 4px rgba(129,140,248,0.15);
    }
    .history-time { color: #6b6f90; font-size: 11px; }
    [data-theme="night"] .history-time { color: #9ca3af; }
    .history-device { color: var(--primary-1); font-size: 11px; margin-left: 4px; }
    .history-action-chip {
      display: inline-block;
      margin-left: 6px;
      padding: 1px 6px;
      border-radius: 999px;
      font-size: 11px;
      background: var(--chip-bg);
      color: var(--chip-text);
    }
    .history-film { color: #111827; font-weight: 500; }
    [data-theme="night"] .history-film { color: #e5e7eb; }
    .history-changes { font-size: 11px; color: #6b7280; margin-top: 2px; }
    [data-theme="night"] .history-changes { color: #9ca3af; }
    .history-empty { font-size: 12px; color: #6b7280; padding-left: 20px; margin-top: 6px; }
    [data-theme="night"] .history-empty { color: #9ca3af; }

    /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
    .spinner-wrapper { display: none; justify-content: center; align-items: center; padding: 4px 0 16px; }
    .spinner-wrapper.show { display: flex; }
    .spinner-circle {
      width: 28px; height: 28px;
      border-radius: 999px;
      border: 3px solid var(--spinner-border);
      border-top-color: var(--primary-1);
      box-shadow: 0 0 12px var(--spinner-glow);
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ë§¨ ìœ„ë¡œ ë²„íŠ¼ */
    .scroll-top-btn {
      position: fixed;
      right: 16px;
      bottom: 24px;
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: none;
      font-size: 18px;
      cursor: pointer;
      background: linear-gradient(135deg, var(--primary-1), var(--primary-2));
      color: #fff;
      display: none;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 24px rgba(107,114,128,0.6);
      z-index: 1900;
    }
    .scroll-top-btn.show { display: flex; }

    @media (min-width: 768px) {
      body { padding-top: 24px; }
    }
    @media (min-width: 600px) {
      .list.gallery { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (min-width: 1024px) {
      .app-shell, .app-header { max-width: 1080px; }
      .list.gallery { grid-template-columns: repeat(3, minmax(260px, 1fr)); }
    }

    /* ====== í•„ë¦„ ë©”ëª¨: ìŠ¬ë¼ì´ë“œ(ë°”í…€ ì‹œíŠ¸) ====== */
    .memo-sheet {
      position: fixed;
      inset: 0;
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 1600;
    }
    .memo-sheet.show { display: flex; }
    .memo-sheet-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
    }
    .memo-sheet-panel {
      position: relative;
      width: 100%;
      max-width: 720px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 18px 18px 0 0;
      box-shadow: 0 -12px 28px rgba(0,0,0,0.25);
      padding: 12px 14px 14px;
      animation: sheetUp 0.16s ease-out;
    }
    @keyframes sheetUp {
      from { transform: translateY(14px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .memo-sheet-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .memo-sheet-title { font-size: 14px; font-weight: 700; color: var(--text-main); }
    .memo-sheet-sub { font-size: 11px; color: var(--text-sub); margin-top: 2px; }
    .memo-sheet-textarea {
      width: 100%;
      min-height: 120px;
      resize: vertical;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--card-border);
      background: #f9f9ff;
      color: var(--text-main);
      font-size: 13px;
      line-height: 1.45;
    }
    [data-theme="night"] .memo-sheet-textarea {
      background: #020617;
      border-color: #1f2937;
      color: #e5e7eb;
    }
    .memo-sheet-actions { display: flex; justify-content: flex-end; gap: 6px; margin-top: 10px; }
    .btn-memo-has { box-shadow: 0 0 0 2px rgba(127,157,255,0.18) inset; }

    /* ====== íˆìŠ¤í† ë¦¬: ì—°í•„ ë²„íŠ¼ + ë…¸íŠ¸ í‘œì‹œ ====== */
    .history-headline { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
    .history-pencil {
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      background: var(--primary-soft);
      color: var(--text-main);
    }
    [data-theme="night"] .history-pencil { color: #e5e7eb; }
    .history-note {
      margin-top: 6px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--card-border);
      background: rgba(228,231,255,0.65);
      font-size: 12px;
      color: var(--text-main);

      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    [data-theme="night"] .history-note {
      background: rgba(79,70,229,0.18);
      border-color: #1f2937;
    }

    /* ====== íˆìŠ¤í† ë¦¬ ë©”ëª¨ ëª¨ë‹¬ ====== */
    .note-modal {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1700;
      padding: 16px;
    }
    .note-modal.show { display: flex; }
    .note-modal-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 18px;
      padding: 16px 18px 14px;
      max-width: 380px;
      width: 100%;
      box-shadow: 0 10px 24px rgba(0,0,0,0.25);
    }
    .note-modal-title { font-size: 15px; font-weight: 700; margin-bottom: 6px; color: var(--text-main); }
    .note-modal-text { font-size: 12px; color: var(--text-sub); margin-bottom: 10px; }
    .note-modal-textarea {
      width: 100%;
      min-height: 120px;
      resize: vertical;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--card-border);
      background: #f9f9ff;
      color: var(--text-main);
      font-size: 13px;
      line-height: 1.45;
    }
    [data-theme="night"] .note-modal-textarea {
      background: #020617;
      border-color: #1f2937;
      color: #e5e7eb;
    }
    .note-modal-actions { display: flex; justify-content: flex-end; gap: 6px; margin-top: 10px; }

    /* ====== íŒ ì‚¬ìš©ë“±ë¡ / íŒ íˆìŠ¤í† ë¦¬ (ë°”í…€ ì‹œíŠ¸) ====== */
    .sheet {
      position: fixed;
      inset: 0;
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 1650;
    }
    .sheet.show { display: flex; }
    .sheet-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
    }
    .sheet-panel {
      position: relative;
      width: 100%;
      max-width: 720px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 18px 18px 0 0;
      box-shadow: 0 -12px 28px rgba(0,0,0,0.25);
      padding: 12px 14px 14px;
      animation: sheetUp 0.16s ease-out;
    }
    .sheet-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .sheet-title { font-size: 14px; font-weight: 800; color: var(--text-main); }
    .sheet-sub { font-size: 11px; color: var(--text-sub); margin-top: 2px; }
    .sheet-actions { display: flex; justify-content: flex-end; gap: 6px; margin-top: 10px; }
    .sheet-list {
      max-height: 320px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .sheet-item {
      border: 1px solid var(--card-border);
      border-radius: 14px;
      padding: 10px;
      margin-bottom: 8px;
      background: rgba(255,255,255,0.75);
    }
    [data-theme="night"] .sheet-item { background: rgba(2,6,23,0.6); border-color: #1f2937; }
    .sheet-item-top {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }
    .sheet-item-meta { font-size: 11px; color: var(--text-sub); }
    .sheet-item-strong { font-size: 12px; font-weight: 700; color: var(--text-main); }
    .sheet-item-note { margin-top: 6px; font-size: 12px; color: var(--text-main); opacity: 0.9; white-space: pre-wrap; }
  </style>
</head>
<body>
  <!-- ì ê¸ˆ í™”ë©´ -->
  <div id="lockScreen" class="lock-screen">
    <div class="lock-card">
      <div class="lock-title">FILM FIND ì ê¸ˆ</div>
      <div class="lock-sub">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ë©´<br>íƒ­ì„ ë‹«ê¸° ì „ê¹Œì§€ëŠ” ê³„ì† ì—´ë ¤ ìˆì–´.</div>
      <div class="lock-input-wrap">
        <input type="password" id="passwordInput" maxlength="20" placeholder="â€¢â€¢â€¢â€¢" />
        <button class="btn btn-primary btn-small" id="passwordBtn">ì…ì¥</button>
      </div>
      <!-- âœ… ë¹„ë²ˆ ì•ˆë‚´ ë¬¸êµ¬ ì‚­ì œ (ìš”êµ¬ì‚¬í•­ 1) -->
    </div>
  </div>

  <!-- ê¸°ê¸° ì´ë¦„ ìµœì´ˆ ì…ë ¥ ëª¨ë‹¬ -->
  <div id="deviceModal" class="device-modal">
    <div class="device-modal-card">
      <div class="device-modal-title">ì´ ê¸°ê¸° ì´ë¦„ ì •í•˜ê¸°</div>
      <div class="device-modal-text">
        ì˜ˆ: ê°€ì€í°, ì„±ê·œíŒ¨ë“œ, íšŒì‚¬PC ê°™ì€ ì‹ìœ¼ë¡œ ì ì–´ì¤˜.<br />
        ê¸°ë¡Â·ë™ê¸°í™”í•  ë•Œ ì–´ë””ì—ì„œ ì…ë ¥í–ˆëŠ”ì§€ í™•ì¸í•˜ê¸° ì‰¬ì›Œì ¸.
      </div>
      <input id="deviceModalInput" class="device-modal-input" type="text" placeholder="ì˜ˆ: ê°€ì€í°" />
      <div class="device-modal-actions">
        <button class="btn btn-secondary btn-small" id="deviceModalSkip">ë‚˜ì¤‘ì—</button>
        <button class="btn btn-primary btn-small" id="deviceModalSave">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ì´ë¯¸ì§€ ì „ì²´ë³´ê¸° -->
  <div id="imageViewer" class="image-viewer">
    <div class="image-viewer-backdrop" id="viewerBackdrop"></div>
    <div class="image-viewer-inner">
      <img id="viewerImage" src="" alt="ì´ë¯¸ì§€" />
      <button id="closeViewerBtn" class="viewer-close-btn">âœ•</button>
    </div>
  </div>

  <!-- í† ìŠ¤íŠ¸ -->
  <div id="toast" class="toast"></div>

  <!-- ====== í•„ë¦„ ë©”ëª¨ ìŠ¬ë¼ì´ë“œ ====== -->
  <div id="memoSheet" class="memo-sheet">
    <div id="memoSheetBackdrop" class="memo-sheet-backdrop"></div>
    <div class="memo-sheet-panel">
      <div class="memo-sheet-head">
        <div>
          <div class="memo-sheet-title" id="memoSheetTitle">ë©”ëª¨</div>
          <div class="memo-sheet-sub" id="memoSheetSub">í•„ë¦„ë³„ ë©”ëª¨ë¥¼ ì ê³  ì €ì¥í•  ìˆ˜ ìˆì–´.</div>
        </div>
        <button class="btn btn-secondary btn-small" id="memoSheetCloseBtn">ë‹«ê¸°</button>
      </div>
      <textarea id="memoTextarea" class="memo-sheet-textarea" placeholder="ì˜ˆ: í…ì…˜ 23 ì´í•˜ì—ì„œ ë²ˆì§ / ìš°ì¸¡ 2mm ë°€ë¦¼ ì£¼ì˜"></textarea>
      <div class="memo-sheet-actions">
        <button class="btn btn-secondary btn-small" id="memoSheetCancelBtn">ì·¨ì†Œ</button>
        <button class="btn btn-primary btn-small" id="memoSheetSaveBtn">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ====== íˆìŠ¤í† ë¦¬ ë©”ëª¨ ëª¨ë‹¬ ====== -->
  <div id="historyNoteModal" class="note-modal">
    <div class="note-modal-card">
      <div class="note-modal-title">íˆìŠ¤í† ë¦¬ ë©”ëª¨</div>
      <div class="note-modal-text">ì´ ë³€ê²½ ê¸°ë¡ì— â€œì™œ ë°”ë€Œì—ˆëŠ”ì§€â€ë¥¼ ì ì–´ë‘˜ ìˆ˜ ìˆì–´.</div>
      <textarea id="historyNoteTextarea" class="note-modal-textarea" placeholder="ì˜ˆ: ê²¹ì¹¨ ì´ìŠˆë¡œ 4-2-1.6ë²ˆìœ¼ë¡œ ì´ë™"></textarea>
      <div class="note-modal-actions">
        <button class="btn btn-secondary btn-small" id="historyNoteCancelBtn">ì·¨ì†Œ</button>
        <button class="btn btn-primary btn-small" id="historyNoteSaveBtn">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ====== íŒ ì‚¬ìš© íˆìŠ¤í† ë¦¬ ì‹œíŠ¸ ====== -->
  <div id="plateHistorySheet" class="sheet">
    <div id="plateHistoryBackdrop" class="sheet-backdrop"></div>
    <div class="sheet-panel">
      <div class="sheet-head">
        <div>
          <div class="sheet-title" id="plateHistoryTitle">íŒ íˆìŠ¤í† ë¦¬</div>
          <div class="sheet-sub" id="plateHistorySub">ìµœê·¼ ê¸°ë¡ 100ê°œ</div>
        </div>
        <button class="btn btn-secondary btn-small" id="plateHistoryCloseBtn">ë‹«ê¸°</button>
      </div>
      <div id="plateHistoryList" class="sheet-list"></div>
      <div class="sheet-actions">
        <button class="btn btn-secondary btn-small" id="plateHistoryCloseBtn2">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ====== íŒ ì‚¬ìš©ë“±ë¡ ì‹œíŠ¸ ====== -->
  <div id="plateUseSheet" class="sheet">
    <div id="plateUseBackdrop" class="sheet-backdrop"></div>
    <div class="sheet-panel">
      <div class="sheet-head">
        <div>
          <div class="sheet-title" id="plateUseTitle">íŒ ì‚¬ìš©ë“±ë¡</div>
          <div class="sheet-sub" id="plateUseSub">ëˆ„ê°€ / ëª‡ê°œ / ë©”ëª¨</div>
        </div>
        <button class="btn btn-secondary btn-small" id="plateUseCloseBtn">ë‹«ê¸°</button>
      </div>

      <div class="form-row">
        <label for="plateUseWho">ëˆ„ê°€</label>
        <input type="text" id="plateUseWho" placeholder="ì˜ˆ: ì„±ê·œ / ê°€ì€ / ì¸ì‡„1íŒ€" />
      </div>
      <div class="form-row">
        <label for="plateUseQty">ëª‡ ê°œ ì°ìŒ</label>
        <input type="number" id="plateUseQty" placeholder="ì˜ˆ: 500" min="0" />
      </div>
      <div class="form-row">
        <label for="plateUseMemo">ë©”ëª¨</label>
        <textarea id="plateUseMemo" placeholder="ììœ  ë©”ëª¨"></textarea>
      </div>

      <div class="sheet-actions">
        <button class="btn btn-secondary btn-small" id="plateUseCancelBtn">ì·¨ì†Œ</button>
        <button class="btn btn-primary btn-small" id="plateUseSaveBtn">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ì‹¤ì œ ì•± -->
  <div id="appContainer" style="display:none;">
    <div class="app-header">
      <div class="title-wrap">
        <div class="app-title">FILM FIND</div>
        <div class="app-subtitle">
          <span id="subtitleText">í•„ë¦„/íŒ ê´€ë¦¬</span>
          <span class="mode-chip" id="modeChip">-</span>
        </div>
      </div>
      <div id="deviceBadge" class="device-badge">
        <span class="device-dot"></span>
        <span id="deviceBadgeText"></span>
      </div>
    </div>

    <div class="app-shell">
      <div class="top-bar">
        <input type="text" id="searchInput" placeholder="ê²€ìƒ‰" />
        <button class="btn btn-primary" id="newFilmBtn">+ ìƒˆ í•„ë¦„</button>
        <button class="btn btn-primary" id="newPlateBtn">+ ìƒˆ íŒ</button>
      </div>

      <div class="tools-bar">
        <button class="btn btn-secondary btn-small" id="settingsBtn">âš™ ì„¤ì •</button>
        <button class="btn btn-secondary btn-small" id="historyBtn">ğŸ“œ íˆìŠ¤í† ë¦¬</button>
        <button class="btn btn-secondary btn-small" id="exportBtn">ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
        <button class="btn btn-secondary btn-small" id="importBtn">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <input type="file" id="importFile" accept="application/json" style="display:none;" />
      </div>

      <!-- íƒ­ -->
      <div class="tab-bar" id="tabBar">
        <button class="tab-btn active" id="tabFilms" data-tab="films">í•„ë¦„</button>
        <button class="tab-btn" id="tabPlates" data-tab="plates">íŒ</button>
      </div>

      <div class="count-wrap">
        <div id="countBar" class="count-bar">ì´ 0ê°œ</div>
        <button class="btn btn-secondary btn-small" id="viewToggleBtn">ê°¤ëŸ¬ë¦¬</button>
      </div>

      <!-- ì„¤ì • ì¹´ë“œ -->
      <div class="form-card" id="settingsCard" style="display:none;">
        <div class="form-row">
          <div class="settings-section-title">ì´ ê¸°ê¸° ì´ë¦„</div>
          <div class="settings-help">ì˜ˆ: ê°€ì€í°, ì„±ê·œíŒ¨ë“œ, íšŒì‚¬PC. ì´ ê¸°ê¸°ì—ì„œë§Œ í‘œì‹œë¼.</div>
          <input type="text" id="deviceNameInput" placeholder="ê¸°ê¸° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" />
        </div>

        <div class="form-row">
          <div class="settings-section-title">ê¸°ë³¸ ì •ë ¬ ë°©ì‹</div>
          <div class="settings-help">ë¦¬ìŠ¤íŠ¸ë¥¼ ì–´ë–¤ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í• ì§€ ì„ íƒí•´.</div>
          <select id="sortOptionSelect">
            <option value="updated">ìµœê·¼ ìˆ˜ì •ìˆœ</option>
            <option value="name">ì œí’ˆëª… ê°€ë‚˜ë‹¤ìˆœ</option>
            <option value="number">ë²ˆí˜¸ ìˆœ</option>
            <option value="lastUsed">ë§ˆì§€ë§‰ ì‚¬ìš© ìµœì‹ ìˆœ</option>
          </select>
        </div>

        <div class="form-row">
          <div class="settings-section-title">í…Œë§ˆ ìƒ‰ìƒ</div>
          <div class="settings-help">ì•±ì˜ ìƒ‰ ë¶„ìœ„ê¸°ë¥¼ ì„ íƒí•´ ì¤˜.</div>
          <select id="themeSelect">
            <option value="default">ë¼ë²¤ë”</option>
            <option value="mint">ë¯¼íŠ¸</option>
            <option value="peach">í”¼ì¹˜</option>
            <option value="night">ë‚˜ì´íŠ¸</option>
          </select>
        </div>

        <!-- âœ… ê´€ë¦¬ìë§Œ ë³´ì´ëŠ” ë¹„ë²ˆ ë³€ê²½ -->
        <div class="form-row" id="adminPasswordSection" style="display:none;">
          <div class="settings-section-title">ëª¨ë“œë³„ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ (ê´€ë¦¬ì ì „ìš©)</div>
          <div class="settings-help">ê´€ë¦¬ì/ì¸ì‡„ê¸°ì‚¬/ì¡°íšŒ ë¹„ë°€ë²ˆí˜¸ë¥¼ ê°ê° ë³€ê²½í•  ìˆ˜ ìˆì–´.</div>

          <label style="font-size:12px; color:var(--label-color); margin-top:6px;">í˜„ì¬ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</label>
          <input type="password" id="currentAdminPwInput" placeholder="í˜„ì¬ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸" />

          <label style="font-size:12px; color:var(--label-color); margin-top:10px;">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</label>
          <input type="password" id="newAdminPwInput" placeholder="ì˜ˆ: 0605" />

          <label style="font-size:12px; color:var(--label-color); margin-top:10px;">ì¸ì‡„ê¸°ì‚¬ ë¹„ë°€ë²ˆí˜¸</label>
          <input type="password" id="newPrinterPwInput" placeholder="ì˜ˆ: 1234" />

          <label style="font-size:12px; color:var(--label-color); margin-top:10px;">ì¡°íšŒ ë¹„ë°€ë²ˆí˜¸</label>
          <input type="password" id="newViewerPwInput" placeholder="ì˜ˆ: 0000" />
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary btn-small" id="closeSettingsBtn">ë‹«ê¸°</button>
          <button type="button" class="btn btn-primary btn-small" id="saveSettingsBtn">ì €ì¥</button>
        </div>
      </div>

      <!-- íˆìŠ¤í† ë¦¬ ì¹´ë“œ -->
      <div class="form-card" id="historyCard" style="display:none;">
        <div class="settings-section-title">ğŸ“œ íˆìŠ¤í† ë¦¬</div>
        <div class="settings-help">
          ë“±ë¡ / ìˆ˜ì • / ì‚­ì œ / ì‚¬ìš©ë“±ë¡ê¹Œì§€ ìµœê·¼ 100ê°œ.<br>
          (ê¸°ê¸° ì´ë¦„ + ë³€ê²½ í•­ëª© í‘œì‹œ)
        </div>
        <div id="historyList" class="history-list"></div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary btn-small" id="closeHistoryBtn">ë‹«ê¸°</button>
        </div>
      </div>

      <!-- ====== í•„ë¦„ ì…ë ¥ í¼ ====== -->
      <div class="form-card" id="filmFormCard" style="display:none;">
        <form id="filmForm">
          <input type="hidden" id="filmId" />
          <div class="form-row">
            <label for="productName">ì œí’ˆ ì´ë¦„ *</label>
            <input type="text" id="productName" required />
          </div>
          <div class="form-row">
            <label for="filmNumber">í•„ë¦„ ë²ˆí˜¸ *</label>
            <input type="text" id="filmNumber" required />
          </div>
          <div class="form-row">
            <label for="method">ì œíŒ íƒ€ì…</label>
            <input type="text" id="method" placeholder="ì˜ˆ: ë°”íƒ•, ë¬¸ì, ìŠ¤ëª¨ê·¸ ë“±" />
          </div>

          <div class="form-row">
            <label for="mesh">MESH</label>
            <input type="text" id="mesh" placeholder="ì˜ˆ: 180T, 200ë©”ì‰¬ ë“±" />
          </div>

          <div class="form-row">
            <label>í•„ë¦„ ì œíŒ ë°©ë²•</label>
            <div class="toggle-group" data-group="frontBack">
              <button type="button" class="toggle-btn" data-value="ì „ë©´">ì „ë©´</button>
              <button type="button" class="toggle-btn" data-value="ë°°ë©´">ë°°ë©´</button>
            </div>
            <div class="toggle-group" data-group="leftRight">
              <button type="button" class="toggle-btn" data-value="ì¢Œ">ì¢Œ</button>
              <button type="button" class="toggle-btn" data-value="ìš°">ìš°</button>
            </div>
            <div class="toggle-group" data-group="upDown">
              <button type="button" class="toggle-btn" data-value="ìƒ">ìƒ</button>
              <button type="button" class="toggle-btn" data-value="í•˜">í•˜</button>
            </div>
            <small style="font-size:11px; color:var(--text-sub);">
              ì „ë©´/ë°°ë©´ + ì¢Œ/ìš° + ìƒ/í•˜ ì¡°í•© (ì˜ˆ: ë°°ë©´ ì¢Œìƒ, ì „ë©´ ìš°í•˜ ë“±)
            </small>
          </div>

          <div class="form-row">
            <label for="location">í•„ë¦„ ìœ„ì¹˜</label>
            <input type="text" id="location" placeholder="ì˜ˆ: A-3 ì„œë, 4ì¸µ ìš°ì¸¡ ë™ ë“±" />
          </div>

          <div class="form-row">
            <label for="requestPrinter">ìš”ì²­ ì¸ì‡„ì</label>
            <select id="requestPrinter">
              <option value="">ì„ íƒ ì•ˆ í•¨</option>
              <option value="ì´ì°½ë¯¼ ë¶€ì¥ë‹˜">ì´ì°½ë¯¼ ë¶€ì¥ë‹˜</option>
              <option value="ê³ ê´‘ìš´ ê³¼ì¥ë‹˜">ê³ ê´‘ìš´ ê³¼ì¥ë‹˜</option>
              <option value="ê¹€ê·œí—Œ ì°¨ì¥ë‹˜">ê¹€ê·œí—Œ ì°¨ì¥ë‹˜</option>
              <option value="ë°•ì¬í˜„ ëŒ€ë¦¬ë‹˜">ë°•ì¬í˜„ ëŒ€ë¦¬ë‹˜</option>
              <option value="ì¡°ì˜ë¹ˆ ëŒ€ë¦¬ë‹˜">ì¡°ì˜ë¹ˆ ëŒ€ë¦¬ë‹˜</option>
              <option value="ê¹€í˜„ê·œ ëŒ€ë¦¬ë‹˜">ê¹€í˜„ê·œ ëŒ€ë¦¬ë‹˜</option>
              <option value="ì¥ì§„ìš° ëŒ€ë¦¬ë‹˜">ì¥ì§„ìš° ëŒ€ë¦¬ë‹˜</option>
              <option value="ê¹€ë¯¸ì€ ì£¼ì„ë‹˜">ê¹€ë¯¸ì€ ì£¼ì„ë‹˜</option>
              <option value="ì´ìˆ˜ì•ˆ ì‚¬ì›ë‹˜">ì´ìˆ˜ì•ˆ ì‚¬ì›ë‹˜</option>
              <option value="ë°•ì§€ì•ˆ ì‚¬ì›ë‹˜">ë°•ì§€ì•ˆ ì‚¬ì›ë‹˜</option>
              <option value="ê¹€ì¸ì„  ì‚¬ì›ë‹˜">ê¹€ì¸ì„  ì‚¬ì›ë‹˜</option>
              <option value="ê¹€ìš©ì› ì‚¬ì›ë‹˜">ê¹€ìš©ì› ì‚¬ì›ë‹˜</option>
              <option value="ìµœì„±ê·œ ì‚¬ì›ë‹˜">ìµœì„±ê·œ ì‚¬ì›ë‹˜</option>
            </select>
          </div>

          <div class="form-row">
            <label for="lastUsed">ë§ˆì§€ë§‰ ì‚¬ìš©ì¼</label>
            <div style="display:flex; gap:6px;">
              <input type="date" id="lastUsed" style="flex:1;" />
              <button type="button" class="btn btn-secondary btn-small" id="setTodayBtn">ì˜¤ëŠ˜</button>
            </div>
          </div>

          <div class="form-row">
            <label for="imageInput">í•„ë¦„ ì‚¬ì§„ (ì„ íƒ)</label>
            <input type="file" id="imageInput" accept="image/*" />
            <small style="font-size:11px; color:var(--text-sub);">
              Â· ìƒˆ í•„ë¦„ì—ëŠ” ì‚¬ì§„ì„ ì¶”ê°€í•˜ê³ ,<br/>
              Â· ìˆ˜ì • ì‹œ ì‚¬ì§„ì„ ë°”ê¾¸ê³  ì‹¶ì„ ë•Œë§Œ ë‹¤ì‹œ ì„ íƒí•˜ì„¸ìš”.
            </small>

            <div id="imagePreviewWrapper" style="margin-top:8px; display:none; align-items:center; gap:6px;">
              <img id="imagePreview" alt="ë¯¸ë¦¬ë³´ê¸°"
                   style="width:70px; height:70px; border-radius:10px; object-fit:cover; background:#eef1ff;" />
              <button type="button" class="btn btn-secondary btn-small" id="rotateLeftBtn">âŸ² 90Â°</button>
              <button type="button" class="btn btn-secondary btn-small" id="rotateRightBtn">âŸ³ 90Â°</button>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="cancelFilmBtn">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn-primary" id="saveFilmBtn">ì €ì¥</button>
          </div>
        </form>
      </div>

      <!-- ====== íŒ ì…ë ¥ í¼ (ê´€ë¦¬ìë§Œ ì‚¬ìš©) ====== -->
      <div class="form-card" id="plateFormCard" style="display:none;">
        <form id="plateForm">
          <input type="hidden" id="plateId" />
          <div class="form-row">
            <label for="plateProductName">ì œí’ˆ ì´ë¦„ *</label>
            <input type="text" id="plateProductName" required />
          </div>
          <div class="form-row">
            <label for="plateNumber">íŒ ë²ˆí˜¸ *</label>
            <input type="text" id="plateNumber" required />
          </div>
          <div class="form-row">
            <label for="plateMesh">MESH</label>
            <input type="text" id="plateMesh" placeholder="ì˜ˆ: 300, 180T ë“±" />
          </div>

          <!-- âœ… ìš”ì²­ì‚¬í•­: íŒ ë“±ë¡ ì‹œ í…ì…˜ ì…ë ¥ -->
          <div class="form-row">
            <label for="plateTension">í…ì…˜</label>
            <input type="text" id="plateTension" placeholder="ì˜ˆ: 23~25 / 24.5" />
          </div>

          <div class="form-row">
            <label for="plateLocation">íŒ ìœ„ì¹˜</label>
            <input type="text" id="plateLocation" placeholder="ì˜ˆ: 4ì¸µ ë™ B-2" />
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="cancelPlateBtn">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn-primary" id="savePlateBtn">ì €ì¥</button>
          </div>
        </form>
      </div>

      <div id="list" class="list"></div>
      <div id="emptyText" class="empty-text" style="display:none;">
        ë“±ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
      </div>

      <div id="loadingSpinner" class="spinner-wrapper">
        <div class="spinner-circle"></div>
      </div>
    </div>
  </div>

  <button id="scrollTopBtn" class="scroll-top-btn">â†‘</button>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <!-- âœ… Part 2ëŠ” ì—¬ê¸° ì•„ë˜ì— ì´ì–´ì„œ ë¶™ì—¬ë„£ê¸° -->
  <script>
  /* ---------- Firebase ì„¤ì • ---------- */
  const firebaseConfig = {
    apiKey: "AIzaSyBrBnVuXca2Ou1oMFOLzq3KGEN8xiK5L_U",
    authDomain: "film-find-5242d.firebaseapp.com",
    projectId: "film-find-5242d",
    storageBucket: "film-find-5242d.firebasestorage.app",
    messagingSenderId: "185123433624",
    appId: "1:185123433624:web:269eb9b4b6437887f2f4ed",
    measurementId: "G-V9KL8XS9KJ"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const FILM_COLLECTION = "films";
  const PLATE_COLLECTION = "plates";
  const HISTORY_COLLECTION = "history";

  /* ---------- ëª¨ë“œ/ë¹„ë²ˆ ---------- */
  const MODE_KEY = "filmAppMode";            // sessionStorage
  const UNLOCK_KEY = "filmAppUnlocked";      // sessionStorage

  const ADMIN_PW_KEY = "filmPwAdmin";
  const PRINTER_PW_KEY = "filmPwPrinter";
  const VIEWER_PW_KEY = "filmPwViewer";

  const DEFAULT_ADMIN_PW = "0605";
  const DEFAULT_PRINTER_PW = "1234";
  const DEFAULT_VIEWER_PW = "0000";

  /* ---------- ì•± ì„¤ì •/í‚¤ ---------- */
  const DEVICE_KEY = "filmDeviceLabel";
  const SORT_KEY = "filmSortOption";
  const THEME_KEY = "filmTheme";
  const VIEW_KEY = "filmViewMode";
  const TAB_KEY = "filmCurrentTab"; // localStorage: films/plates

  let currentMode = "viewer"; // admin | printer | viewer
  let currentTab = localStorage.getItem(TAB_KEY) || "films";

  let films = [];
  let plates = [];

  let currentSearchText = "";
  let unsubscribeFilms = null;
  let unsubscribePlates = null;

  let historyEntries = [];
  let historyLoaded = false;

  const VISIBLE_STEP = 30;
  let visibleCount = VISIBLE_STEP;
  let loadingMore = false;

  let currentViewMode = localStorage.getItem(VIEW_KEY) || "list";

  /* ì´ë¯¸ì§€ ì„ íƒ/íšŒì „ ìƒíƒœ (í•„ë¦„) */
  let currentSelectedImageDataUrl = null;
  let currentImageRotation = 0;

  /* ë©”ëª¨ ê¸°ëŠ¥ ìƒíƒœ */
  let currentMemoFilmId = null;
  let currentHistoryNoteId = null;

  /* íŒ ì‹œíŠ¸ ìƒíƒœ */
  let currentPlateIdForHistory = null;
  let currentPlateIdForUse = null;

  /* ---------- ìœ í‹¸ ---------- */
  function showToast(msg) {
    const toast = document.getElementById("toast");
    if (!toast) return;
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 1800);
  }

  function formatDate(iso) {
    if (!iso) return "-";
    return iso;
  }

  function formatTime(ts) {
    const d = new Date(ts || 0);
    if (isNaN(d.getTime())) return "-";
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    const hh = String(d.getHours()).padStart(2, "0");
    const mm = String(d.getMinutes()).padStart(2, "0");
    return `${y}-${m}-${day} ${hh}:${mm}`;
  }

  /* ---------- ì„¤ì •(ë¡œì»¬) ---------- */
  function getDeviceLabel() { return localStorage.getItem(DEVICE_KEY) || ""; }
  function setDeviceLabel(label) {
    localStorage.setItem(DEVICE_KEY, label);
    const badgeText = document.getElementById("deviceBadgeText");
    if (badgeText) badgeText.textContent = label || "ê¸°ê¸° ë¯¸ì§€ì •";
  }

  function getSortOption() { return localStorage.getItem(SORT_KEY) || "updated"; }
  function setSortOption(opt) { localStorage.setItem(SORT_KEY, opt); }

  function getTheme() { return localStorage.getItem(THEME_KEY) || "default"; }
  function setTheme(theme) {
    localStorage.setItem(THEME_KEY, theme);
    const root = document.documentElement;
    if (theme === "default") root.removeAttribute("data-theme");
    else root.setAttribute("data-theme", theme);
  }

  function setViewMode(mode) {
    currentViewMode = mode;
    localStorage.setItem(VIEW_KEY, mode);
    applyViewMode();
  }

  /* ---------- ë¹„ë²ˆ(ëª¨ë“œë³„) ---------- */
  function getAdminPw() { return localStorage.getItem(ADMIN_PW_KEY) || DEFAULT_ADMIN_PW; }
  function getPrinterPw() { return localStorage.getItem(PRINTER_PW_KEY) || DEFAULT_PRINTER_PW; }
  function getViewerPw() { return localStorage.getItem(VIEWER_PW_KEY) || DEFAULT_VIEWER_PW; }

  function setAdminPw(pw) { localStorage.setItem(ADMIN_PW_KEY, pw); }
  function setPrinterPw(pw) { localStorage.setItem(PRINTER_PW_KEY, pw); }
  function setViewerPw(pw) { localStorage.setItem(VIEWER_PW_KEY, pw); }

  function modeLabel(mode) {
    if (mode === "admin") return "ê´€ë¦¬ì";
    if (mode === "printer") return "ì¸ì‡„ê¸°ì‚¬";
    return "ì¡°íšŒ";
  }

  /* ---------- ëª¨ë“œë³„ UI ì ìš© ---------- */
  function applyModeUI() {
    const modeChip = document.getElementById("modeChip");
    if (modeChip) modeChip.textContent = `ëª¨ë“œ: ${modeLabel(currentMode)}`;

    const tabBar = document.getElementById("tabBar");
    const tabFilms = document.getElementById("tabFilms");
    const tabPlates = document.getElementById("tabPlates");

    const newFilmBtn = document.getElementById("newFilmBtn");
    const newPlateBtn = document.getElementById("newPlateBtn");
    const viewToggleBtn = document.getElementById("viewToggleBtn");

    // ì¸ì‡„ê¸°ì‚¬: í•„ë¦„ íƒ­ ìì²´ ìˆ¨ê¹€ + í•„ë¦„ ë²„íŠ¼ ìˆ¨ê¹€
    if (currentMode === "printer") {
      if (tabBar) tabBar.style.display = "none";
      currentTab = "plates";
      localStorage.setItem(TAB_KEY, currentTab);

      if (newFilmBtn) newFilmBtn.style.display = "none";
      if (newPlateBtn) newPlateBtn.style.display = "none"; // íŒ ë“±ë¡ì€ ê´€ë¦¬ìë§Œ
      if (viewToggleBtn) viewToggleBtn.style.display = "none"; // ì¸ì‡„ê¸°ì‚¬ëŠ” ë¦¬ìŠ¤íŠ¸ë§Œìœ¼ë¡œ ê°„ë‹¨íˆ
    } else {
      if (tabBar) tabBar.style.display = "flex";
      if (newFilmBtn) newFilmBtn.style.display = (currentMode === "admin") ? "inline-block" : "none";
      if (newPlateBtn) newPlateBtn.style.display = (currentMode === "admin") ? "inline-block" : "none";
      if (viewToggleBtn) viewToggleBtn.style.display = "inline-block";
    }

    // ì¡°íšŒëª¨ë“œ: ìƒˆ ë“±ë¡ ë²„íŠ¼ ìˆ¨ê¹€
    if (currentMode === "viewer") {
      if (newFilmBtn) newFilmBtn.style.display = "none";
      if (newPlateBtn) newPlateBtn.style.display = "none";
    }

    // íƒ­ í™œì„±í™” í‘œì‹œ
    if (tabFilms && tabPlates) {
      tabFilms.classList.toggle("active", currentTab === "films");
      tabPlates.classList.toggle("active", currentTab === "plates");
    }

    // ê²€ìƒ‰ placeholder
    const searchInput = document.getElementById("searchInput");
    if (searchInput) {
      if (currentTab === "films") {
        searchInput.placeholder = "ì œí’ˆëª… / í•„ë¦„ë²ˆí˜¸ / ì œíŒíƒ€ì… / ìœ„ì¹˜ / ì œíŒë°©ë²• / MESH / ìš”ì²­ ì¸ì‡„ì ê²€ìƒ‰";
      } else {
        searchInput.placeholder = "ì œí’ˆëª… / íŒë²ˆí˜¸ / MESH / í…ì…˜ / ìœ„ì¹˜ ê²€ìƒ‰";
      }
    }
  }

  function switchTab(tab) {
    currentTab = tab;
    localStorage.setItem(TAB_KEY, tab);
    currentSearchText = "";
    const searchInput = document.getElementById("searchInput");
    if (searchInput) searchInput.value = "";
    visibleCount = VISIBLE_STEP;
    applyModeUI();
    renderCurrentList("");
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  /* ---------- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° & íšŒì „ (í•„ë¦„) ---------- */
  function resetImagePreview() {
    const wrapper = document.getElementById("imagePreviewWrapper");
    const img = document.getElementById("imagePreview");
    currentSelectedImageDataUrl = null;
    currentImageRotation = 0;
    if (img) {
      img.src = "";
      img.style.transform = "rotate(0deg)";
    }
    if (wrapper) wrapper.style.display = "none";
  }

  function applyPreviewRotation() {
    const img = document.getElementById("imagePreview");
    if (!img) return;
    img.style.transform = "rotate(" + currentImageRotation + "deg)";
  }

  /* ---------- Firestore ì‹¤ì‹œê°„ ë™ê¸°í™” ---------- */
  function startFilmsListener() {
    if (unsubscribeFilms) unsubscribeFilms();

    // ì¸ì‡„ê¸°ì‚¬ ëª¨ë“œëŠ” í•„ë¦„ ìì²´ë¥¼ ì•„ì˜ˆ ì•ˆ ë´„(ìš”êµ¬ì‚¬í•­)
    if (currentMode === "printer") return;

    unsubscribeFilms = db.collection(FILM_COLLECTION).onSnapshot(
      (snapshot) => {
        films = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
        renderCurrentList(currentSearchText);
      },
      (error) => {
        console.error("films ë™ê¸°í™” ì˜¤ë¥˜:", error);
        showToast("í•„ë¦„ ë™ê¸°í™” ì˜¤ë¥˜");
      }
    );
  }

  function startPlatesListener() {
    if (unsubscribePlates) unsubscribePlates();

    unsubscribePlates = db.collection(PLATE_COLLECTION).onSnapshot(
      (snapshot) => {
        plates = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
        renderCurrentList(currentSearchText);
      },
      (error) => {
        console.error("plates ë™ê¸°í™” ì˜¤ë¥˜:", error);
        showToast("íŒ ë™ê¸°í™” ì˜¤ë¥˜");
      }
    );
  }

  /* ---------- íˆìŠ¤í† ë¦¬ ---------- */
  async function addHistory(action, payload, changes = []) {
    try {
      const entry = {
        action,
        itemType: payload.itemType || "film", // film | plate | plate_use
        itemId: payload.id || null,
        number: payload.number || "",
        name: payload.name || "",
        deviceName: getDeviceLabel() || "",
        timestamp: Date.now(),
        changes,
      };
      await db.collection(HISTORY_COLLECTION).add(entry);
      if (historyLoaded) await loadHistory();
    } catch (e) {
      console.error("íˆìŠ¤í† ë¦¬ ê¸°ë¡ ì˜¤ë¥˜:", e);
    }
  }

  async function loadHistory() {
    try {
      const snap = await db
        .collection(HISTORY_COLLECTION)
        .orderBy("timestamp", "desc")
        .limit(100)
        .get();

      historyEntries = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
      historyLoaded = true;
      renderHistory();
    } catch (e) {
      console.error("íˆìŠ¤í† ë¦¬ ë¡œë“œ ì˜¤ë¥˜:", e);
      showToast("íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨");
    }
  }

  function actionLabel(action) {
    if (action === "ë“±ë¡") return "ë“±ë¡";
    if (action === "ìˆ˜ì •") return "ìˆ˜ì •";
    if (action === "ì‚­ì œ") return "ì‚­ì œ";
    if (action === "ì˜¤ëŠ˜ ì‚¬ìš©") return "ì˜¤ëŠ˜ ì‚¬ìš©";
    if (action === "íŒ ì‚¬ìš©ë“±ë¡") return "íŒ ì‚¬ìš©ë“±ë¡";
    return action || "ë³€ê²½";
  }

  function renderHistory() {
    const list = document.getElementById("historyList");
    if (!list) return;
    list.innerHTML = "";

    if (!historyEntries.length) {
      const empty = document.createElement("div");
      empty.className = "history-empty";
      empty.innerHTML = "ì•„ì§ ê¸°ë¡ì´ ì—†ì–´.";
      list.appendChild(empty);
      return;
    }

    historyEntries.forEach((entry) => {
      const row = document.createElement("div");
      row.className = "history-row";

      const ts = formatTime(entry.timestamp || 0);
      const device = entry.deviceName || "ê¸°ê¸° ë¯¸ì§€ì •";
      const num = entry.number || "";
      const nm = entry.name ? ` (${entry.name})` : "";
      const itemType = entry.itemType === "plate" ? "íŒ" : (entry.itemType === "plate_use" ? "íŒì‚¬ìš©" : "í•„ë¦„");
      const changesArr = Array.isArray(entry.changes) ? entry.changes : [];
      const noteText = (entry.note || "").trim();

      row.innerHTML =
        `<div class="history-headline">` +
          `<div>` +
            `<span class="history-time">${ts}</span>` +
            `<span class="history-device">${device}</span>` +
            `<span class="history-action-chip">${itemType} Â· ${actionLabel(entry.action)}</span>` +
          `</div>` +
          `<button class="history-pencil" data-id="${entry.id}">âœï¸</button>` +
        `</div>` +
        `<div class="history-film">${num || "-"}${nm}</div>` +
        (changesArr.length ? `<div class="history-changes">ë³€ê²½ í•­ëª©: ${changesArr.join(", ")}</div>` : "") +
        (noteText ? `<div class="history-note">${noteText}</div>` : "");

      const pencilBtn = row.querySelector(".history-pencil");
      if (pencilBtn) {
        pencilBtn.addEventListener("click", () => openHistoryNoteModal(entry.id));
      }
      list.appendChild(row);
    });
  }

  function openHistoryCard() {
    const card = document.getElementById("historyCard");
    const isOpen = card.style.display === "block";
    closeAllPanels();
    if (!isOpen) {
      card.style.display = "block";
      if (!historyLoaded) loadHistory();
      else renderHistory();
    }
  }
  function closeHistoryCard() {
    document.getElementById("historyCard").style.display = "none";
  }

  /* ====== íˆìŠ¤í† ë¦¬ ë©”ëª¨ ====== */
  function openHistoryNoteModal(historyId) {
    const entry = historyEntries.find((h) => h.id === historyId);
    if (!entry) return;
    currentHistoryNoteId = historyId;
    const modal = document.getElementById("historyNoteModal");
    const ta = document.getElementById("historyNoteTextarea");
    if (ta) ta.value = entry.note || "";
    modal.classList.add("show");
  }
  function closeHistoryNoteModal() {
    document.getElementById("historyNoteModal").classList.remove("show");
    currentHistoryNoteId = null;
  }
  async function saveHistoryNoteModal() {
    if (!currentHistoryNoteId) return;
    const ta = document.getElementById("historyNoteTextarea");
    const note = (ta.value || "").trim();
    try {
      await db.collection(HISTORY_COLLECTION).doc(currentHistoryNoteId).set({ note }, { merge: true });
      const idx = historyEntries.findIndex((h) => h.id === currentHistoryNoteId);
      if (idx >= 0) historyEntries[idx].note = note;
      renderHistory();
      showToast("íˆìŠ¤í† ë¦¬ ë©”ëª¨ ì €ì¥ë¨.");
      closeHistoryNoteModal();
    } catch (e) {
      console.error(e);
      showToast("íˆìŠ¤í† ë¦¬ ë©”ëª¨ ì €ì¥ ì˜¤ë¥˜");
    }
  }

  /* ====== í•„ë¦„ ë©”ëª¨(ìŠ¬ë¼ì´ë“œ) ====== */
  function openMemoSheet(filmId) {
    const film = films.find((f) => f.id === filmId);
    if (!film) return;

    currentMemoFilmId = filmId;

    const title = document.getElementById("memoSheetTitle");
    const sub = document.getElementById("memoSheetSub");
    const ta = document.getElementById("memoTextarea");
    const sheet = document.getElementById("memoSheet");

    if (title) title.textContent = `ë©”ëª¨ Â· ${film.filmNumber || ""}`;
    if (sub) sub.textContent = (film.productName || "") ? film.productName : "í•„ë¦„ë³„ ë©”ëª¨";
    if (ta) ta.value = film.memo || "";

    sheet.classList.add("show");
  }
  function closeMemoSheet() {
    document.getElementById("memoSheet").classList.remove("show");
    currentMemoFilmId = null;
  }
  async function saveMemoSheet() {
    if (!currentMemoFilmId) return;
    const ta = document.getElementById("memoTextarea");
    const memo = (ta.value || "").trim();

    try {
      await db.collection(FILM_COLLECTION).doc(currentMemoFilmId).set(
        { memo, updatedAt: Date.now() },
        { merge: true }
      );
      showToast("ë©”ëª¨ ì €ì¥ë¨.");
      closeMemoSheet();
    } catch (e) {
      console.error(e);
      showToast("ë©”ëª¨ ì €ì¥ ì˜¤ë¥˜");
    }
  }

  /* ---------- ì œíŒ ë°©ë²• í† ê¸€ ---------- */
  function clearPlateInfoForm() {
    document.querySelectorAll(".toggle-btn").forEach((btn) => btn.classList.remove("active"));
  }
  function setPlateInfoToForm(str) {
    clearPlateInfoForm();
    if (!str) return;
    const parts = str.split(" ");
    document.querySelectorAll(".toggle-btn").forEach((btn) => {
      if (parts.includes(btn.dataset.value)) btn.classList.add("active");
    });
  }
  function getPlateInfoFromForm() {
    const groups = document.querySelectorAll(".toggle-group");
    const values = [];
    groups.forEach((group) => {
      const active = group.querySelector(".toggle-btn.active");
      if (active) values.push(active.dataset.value);
    });
    return values.join(" ");
  }

  /* ---------- ë·° ëª¨ë“œ ---------- */
  function applyViewMode() {
    const list = document.getElementById("list");
    const btn = document.getElementById("viewToggleBtn");
    if (!list || !btn) return;

    if (currentViewMode === "gallery") {
      list.classList.add("gallery");
      btn.textContent = "ë¦¬ìŠ¤íŠ¸";
    } else {
      list.classList.remove("gallery");
      btn.textContent = "ê°¤ëŸ¬ë¦¬";
    }
  }

  /* ---------- íŒ¨ë„ ê³µí†µ ---------- */
  function closeAllPanels() {
    document.getElementById("settingsCard").style.display = "none";
    document.getElementById("historyCard").style.display = "none";
    document.getElementById("filmFormCard").style.display = "none";
    document.getElementById("plateFormCard").style.display = "none";
  }

  /* ---------- ê²€ìƒ‰ + ë Œë” ---------- */
  function updateCountBar(filteredLength, totalLength, hasFilter) {
    const bar = document.getElementById("countBar");
    if (!bar) return;
    if (hasFilter) bar.innerHTML = `ê²€ìƒ‰ ê²°ê³¼ <strong>${filteredLength}</strong>ê°œ / ì „ì²´ ${totalLength}ê°œ`;
    else bar.innerHTML = `ì´ <strong>${totalLength}</strong>ê°œ`;
  }

  function renderCurrentList(filterText = "") {
    if (currentTab === "films") renderFilmList(filterText);
    else renderPlateList(filterText);
  }

  function renderFilmList(filterText = "") {
    const listEl = document.getElementById("list");
    const emptyText = document.getElementById("emptyText");
    if (!listEl || !emptyText) return;

    listEl.innerHTML = "";
    currentSearchText = filterText || "";

    const text = (filterText || "").trim().toLowerCase();

    let filtered = films.filter((f) => {
      if (!text) return true;
      const combined =
        (f.productName || "") + " " +
        (f.filmNumber || "") + " " +
        (f.method || "") + " " +
        (f.mesh || "") + " " +
        (f.location || "") + " " +
        (f.plateInfo || "") + " " +
        (f.requestPrinter || "");
      return combined.toLowerCase().includes(text);
    });

    const sortOpt = getSortOption();
    filtered = filtered.slice().sort((a, b) => {
      if (sortOpt === "name") return (a.productName || "").localeCompare(b.productName || "", "ko");
      if (sortOpt === "number") return (a.filmNumber || "").localeCompare(b.filmNumber || "", "ko");
      if (sortOpt === "lastUsed") return (b.lastUsed || "").localeCompare(a.lastUsed || "");
      const atA = a.updatedAt || a.createdAt || 0;
      const atB = b.updatedAt || b.createdAt || 0;
      return atB - atA;
    });

    updateCountBar(filtered.length, films.length, !!text);

    let toRender = filtered;
    if (!text) {
      visibleCount = Math.min(visibleCount || VISIBLE_STEP, filtered.length);
      toRender = filtered.slice(0, visibleCount);
    }

    if (filtered.length === 0) {
      emptyText.style.display = "block";
      emptyText.innerHTML = "ë“±ë¡ëœ í•„ë¦„ì´ ì—†ìŠµë‹ˆë‹¤.";
      return;
    } else {
      emptyText.style.display = "none";
    }

    // ì¡°íšŒëª¨ë“œ: ë²„íŠ¼ ì „ë¶€ ìˆ¨ê¹€ / ì¸ì‡„ê¸°ì‚¬ ëª¨ë“œì—ì„œëŠ” ì´ íƒ­ ìì²´ë¥¼ ì•ˆ ì”€
    const isReadOnly = (currentMode === "viewer");

    toRender.forEach((film) => {
      const card = document.createElement("div");
      card.className = "card";

      const img = document.createElement("img");
      if (film.imageDataUrl) {
        img.src = film.imageDataUrl;
        img.addEventListener("click", () => openImageViewer(film.imageDataUrl));
      } else {
        img.alt = "ì´ë¯¸ì§€ ì—†ìŒ";
      }
      card.appendChild(img);

      const content = document.createElement("div");
      content.className = "card-content";

      const rowMain = document.createElement("div");
      rowMain.className = "card-row-main";

      const title = document.createElement("div");
      title.className = "card-title";
      title.textContent = film.productName || "(ì œí’ˆëª… ì—†ìŒ)";

      const tag = document.createElement("div");
      tag.className = "card-tag";
      tag.textContent = film.filmNumber || "ë²ˆí˜¸ ì—†ìŒ";

      rowMain.appendChild(title);
      rowMain.appendChild(tag);
      content.appendChild(rowMain);

      const rowMethod = document.createElement("div");
      rowMethod.className = "card-row";
      rowMethod.innerHTML = '<span class="label">ì œíŒ íƒ€ì…</span>' + (film.method || "-");
      content.appendChild(rowMethod);

      const rowMesh = document.createElement("div");
      rowMesh.className = "card-row";
      rowMesh.innerHTML = '<span class="label">MESH</span>' + (film.mesh || "-");
      content.appendChild(rowMesh);

      const rowPlate = document.createElement("div");
      rowPlate.className = "card-row";
      rowPlate.innerHTML = '<span class="label">ì œíŒ ë°©ë²•</span>' + (film.plateInfo || "-");
      content.appendChild(rowPlate);

      const rowLoc = document.createElement("div");
      rowLoc.className = "card-row";
      rowLoc.innerHTML = '<span class="label">í•„ë¦„ ìœ„ì¹˜</span>' + (film.location || "-");
      content.appendChild(rowLoc);

      const rowReq = document.createElement("div");
      rowReq.className = "card-row";
      rowReq.innerHTML = '<span class="label">ìš”ì²­ ì¸ì‡„ì</span>' + (film.requestPrinter || "-");
      content.appendChild(rowReq);

      const footer = document.createElement("div");
      footer.className = "card-footer";

      const lastUsed = document.createElement("div");
      lastUsed.className = "last-used";
      lastUsed.textContent = "ë§ˆì§€ë§‰ ì‚¬ìš©ì¼: " + formatDate(film.lastUsed || "");
      footer.appendChild(lastUsed);

      const btnWrap = document.createElement("div");
      btnWrap.className = "card-buttons";

      // ì¡°íšŒëª¨ë“œ: ë³´ê¸°ë§Œ ê°€ëŠ¥
      if (!isReadOnly && currentMode === "admin") {
        const useTodayBtn = document.createElement("button");
        useTodayBtn.className = "btn btn-secondary btn-small";
        useTodayBtn.textContent = "ì˜¤ëŠ˜ ì‚¬ìš©";
        useTodayBtn.addEventListener("click", async () => {
          const today = new Date().toISOString().slice(0, 10);
          try {
            await db.collection(FILM_COLLECTION).doc(film.id).set(
              { lastUsed: today, updatedAt: Date.now() },
              { merge: true }
            );
            await addHistory("ì˜¤ëŠ˜ ì‚¬ìš©", {
              itemType: "film",
              id: film.id,
              number: film.filmNumber || "",
              name: film.productName || "",
            }, ["ë§ˆì§€ë§‰ ì‚¬ìš©ì¼"]);
            showToast("ì˜¤ëŠ˜ ì‚¬ìš©ìœ¼ë¡œ ê¸°ë¡í–ˆì–´.");
          } catch (e) {
            console.error(e);
            showToast("ì—…ë°ì´íŠ¸ ì˜¤ë¥˜");
          }
        });

        const memoBtn = document.createElement("button");
        memoBtn.className = "btn btn-secondary btn-small";
        memoBtn.textContent = "ë©”ëª¨";
        if ((film.memo || "").trim()) memoBtn.classList.add("btn-memo-has");
        memoBtn.addEventListener("click", () => openMemoSheet(film.id));

        const editBtn = document.createElement("button");
        editBtn.className = "btn btn-primary btn-small";
        editBtn.textContent = "ìˆ˜ì •";
        editBtn.addEventListener("click", () => openFilmFormForEdit(film.id));

        const delBtn = document.createElement("button");
        delBtn.className = "btn btn-danger btn-small";
        delBtn.textContent = "ì‚­ì œ";
        delBtn.addEventListener("click", async () => {
          if (!confirm("ì´ í•„ë¦„ ì •ë³´ë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;
          try {
            await db.collection(FILM_COLLECTION).doc(film.id).delete();
            await addHistory("ì‚­ì œ", {
              itemType: "film",
              id: film.id,
              number: film.filmNumber || "",
              name: film.productName || "",
            }, ["ì‚­ì œ"]);
            showToast("ì‚­ì œí–ˆì–´.");
          } catch (e) {
            console.error(e);
            showToast("ì‚­ì œ ì˜¤ë¥˜");
          }
        });

        btnWrap.appendChild(useTodayBtn);
        btnWrap.appendChild(memoBtn);
        btnWrap.appendChild(editBtn);
        btnWrap.appendChild(delBtn);
      }

      footer.appendChild(btnWrap);
      content.appendChild(footer);

      card.appendChild(content);
      listEl.appendChild(card);
    });

    applyViewMode();
  }

  function renderPlateList(filterText = "") {
    const listEl = document.getElementById("list");
    const emptyText = document.getElementById("emptyText");
    if (!listEl || !emptyText) return;

    listEl.innerHTML = "";
    currentSearchText = filterText || "";
    const text = (filterText || "").trim().toLowerCase();

    let filtered = plates.filter((p) => {
      if (!text) return true;
      const combined =
        (p.productName || "") + " " +
        (p.plateNumber || "") + " " +
        (p.mesh || "") + " " +
        (p.tension || "") + " " +
        (p.location || "");
      return combined.toLowerCase().includes(text);
    });

    const sortOpt = getSortOption();
    filtered = filtered.slice().sort((a, b) => {
      if (sortOpt === "name") return (a.productName || "").localeCompare(b.productName || "", "ko");
      if (sortOpt === "number") return (a.plateNumber || "").localeCompare(b.plateNumber || "", "ko");
      if (sortOpt === "lastUsed") return (b.lastUsedAt || 0) - (a.lastUsedAt || 0);
      const atA = a.updatedAt || a.createdAt || 0;
      const atB = b.updatedAt || b.createdAt || 0;
      return atB - atA;
    });

    updateCountBar(filtered.length, plates.length, !!text);

    let toRender = filtered;
    if (!text) {
      visibleCount = Math.min(visibleCount || VISIBLE_STEP, filtered.length);
      toRender = filtered.slice(0, visibleCount);
    }

    if (filtered.length === 0) {
      emptyText.style.display = "block";
      emptyText.innerHTML = "ë“±ë¡ëœ íŒì´ ì—†ìŠµë‹ˆë‹¤.";
      return;
    } else {
      emptyText.style.display = "none";
    }

    const canEditPlate = (currentMode === "admin");
    const canUseRegister = (currentMode === "admin" || currentMode === "printer");
    const readOnly = (currentMode === "viewer");

    toRender.forEach((plate) => {
      const card = document.createElement("div");
      card.className = "card";

      // íŒì€ ì´ë¯¸ì§€ ì—†ìœ¼ë‹ˆ ë”ë¯¸
      const img = document.createElement("img");
      img.alt = "íŒ";
      img.style.cursor = "default";
      img.src = "data:image/svg+xml;utf8," + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="140" height="140">
          <rect width="140" height="140" rx="24" fill="#eef1ff"/>
          <text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" font-size="34" fill="#7f9dff">íŒ</text>
        </svg>
      `);
      card.appendChild(img);

      const content = document.createElement("div");
      content.className = "card-content";

      const rowMain = document.createElement("div");
      rowMain.className = "card-row-main";

      const title = document.createElement("div");
      title.className = "card-title";
      title.textContent = plate.productName || "(ì œí’ˆëª… ì—†ìŒ)";

      const tag = document.createElement("div");
      tag.className = "card-tag";
      tag.textContent = plate.plateNumber || "ë²ˆí˜¸ ì—†ìŒ";

      rowMain.appendChild(title);
      rowMain.appendChild(tag);
      content.appendChild(rowMain);

      const rowMesh = document.createElement("div");
      rowMesh.className = "card-row";
      rowMesh.innerHTML = '<span class="label">MESH</span>' + (plate.mesh || "-");
      content.appendChild(rowMesh);

      const rowTension = document.createElement("div");
      rowTension.className = "card-row";
      rowTension.innerHTML = '<span class="label">í…ì…˜</span>' + (plate.tension || "-");
      content.appendChild(rowTension);

      const rowLoc = document.createElement("div");
      rowLoc.className = "card-row";
      rowLoc.innerHTML = '<span class="label">íŒ ìœ„ì¹˜</span>' + (plate.location || "-");
      content.appendChild(rowLoc);

      const footer = document.createElement("div");
      footer.className = "card-footer";

      const last = document.createElement("div");
      last.className = "last-used";
      last.textContent = "ë§ˆì§€ë§‰ ì‚¬ìš©: " + (plate.lastUsedAt ? formatTime(plate.lastUsedAt) : "-");
      footer.appendChild(last);

      const btnWrap = document.createElement("div");
      btnWrap.className = "card-buttons";

      // íŒë³„ íˆìŠ¤í† ë¦¬ ë³´ê¸° (ëª¨ë“  ëª¨ë“œì—ì„œ ê°€ëŠ¥)
      const histBtn = document.createElement("button");
      histBtn.className = "btn btn-secondary btn-small";
      histBtn.textContent = "íˆìŠ¤í† ë¦¬";
      histBtn.addEventListener("click", () => openPlateHistorySheet(plate.id));
      btnWrap.appendChild(histBtn);

      // ì¸ì‡„ê¸°ì‚¬/ê´€ë¦¬ì: íŒ ì‚¬ìš©ë“±ë¡ ê°€ëŠ¥
      if (canUseRegister && !readOnly) {
        const useBtn = document.createElement("button");
        useBtn.className = "btn btn-primary btn-small";
        useBtn.textContent = "ì‚¬ìš©ë“±ë¡";
        useBtn.addEventListener("click", () => openPlateUseSheet(plate.id));
        btnWrap.appendChild(useBtn);
      }

      // ê´€ë¦¬ì: ìˆ˜ì •/ì‚­ì œ
      if (canEditPlate) {
        const editBtn = document.createElement("button");
        editBtn.className = "btn btn-primary btn-small";
        editBtn.textContent = "ìˆ˜ì •";
        editBtn.addEventListener("click", () => openPlateFormForEdit(plate.id));

        const delBtn = document.createElement("button");
        delBtn.className = "btn btn-danger btn-small";
        delBtn.textContent = "ì‚­ì œ";
        delBtn.addEventListener("click", async () => {
          if (!confirm("ì´ íŒ ì •ë³´ë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;
          try {
            await db.collection(PLATE_COLLECTION).doc(plate.id).delete();
            await addHistory("ì‚­ì œ", {
              itemType: "plate",
              id: plate.id,
              number: plate.plateNumber || "",
              name: plate.productName || "",
            }, ["ì‚­ì œ"]);
            showToast("ì‚­ì œí–ˆì–´.");
          } catch (e) {
            console.error(e);
            showToast("ì‚­ì œ ì˜¤ë¥˜");
          }
        });

        btnWrap.appendChild(editBtn);
        btnWrap.appendChild(delBtn);
      }

      footer.appendChild(btnWrap);
      content.appendChild(footer);
      card.appendChild(content);
      listEl.appendChild(card);
    });

    // íŒ íƒ­ì—ì„œëŠ” ê°¤ëŸ¬ë¦¬ ì˜ë¯¸ ì—†ìœ¼ë‹ˆ ë¦¬ìŠ¤íŠ¸ ìœ ì§€(ì›í•˜ë©´ ë°”ê¿”ë„ ë¨)
    applyViewMode();
  }

  /* ---------- í•„ë¦„ í¼ ---------- */
  function resetFilmForm() {
    document.getElementById("filmId").value = "";
    document.getElementById("productName").value = "";
    document.getElementById("filmNumber").value = "";
    document.getElementById("method").value = "";
    document.getElementById("mesh").value = "";
    document.getElementById("location").value = "";
    document.getElementById("requestPrinter").value = "";
    document.getElementById("lastUsed").value = "";
    document.getElementById("imageInput").value = "";
    clearPlateInfoForm();
    resetImagePreview();
  }

  function openFilmFormNew() {
    resetFilmForm();
    closeAllPanels();
    document.getElementById("filmFormCard").style.display = "block";
    document.getElementById("productName").focus();
  }

  function openFilmFormForEdit(id) {
    const film = films.find((f) => f.id === id);
    if (!film) return;
    closeAllPanels();
    resetImagePreview();
    document.getElementById("filmId").value = film.id;
    document.getElementById("productName").value = film.productName || "";
    document.getElementById("filmNumber").value = film.filmNumber || "";
    document.getElementById("method").value = film.method || "";
    document.getElementById("mesh").value = film.mesh || "";
    document.getElementById("location").value = film.location || "";
    document.getElementById("requestPrinter").value = film.requestPrinter || "";
    document.getElementById("lastUsed").value = film.lastUsed || "";
    document.getElementById("imageInput").value = "";
    setPlateInfoToForm(film.plateInfo || "");
    document.getElementById("filmFormCard").style.display = "block";
    document.getElementById("productName").focus();
  }

  function closeFilmForm() {
    document.getElementById("filmFormCard").style.display = "none";
    resetFilmForm();
  }

  /* ---------- íŒ í¼ ---------- */
  function resetPlateForm() {
    document.getElementById("plateId").value = "";
    document.getElementById("plateProductName").value = "";
    document.getElementById("plateNumber").value = "";
    document.getElementById("plateMesh").value = "";
    document.getElementById("plateTension").value = "";
    document.getElementById("plateLocation").value = "";
  }

  function openPlateFormNew() {
    resetPlateForm();
    closeAllPanels();
    document.getElementById("plateFormCard").style.display = "block";
    document.getElementById("plateProductName").focus();
  }

  function openPlateFormForEdit(id) {
    const plate = plates.find((p) => p.id === id);
    if (!plate) return;
    resetPlateForm();
    closeAllPanels();
    document.getElementById("plateId").value = plate.id;
    document.getElementById("plateProductName").value = plate.productName || "";
    document.getElementById("plateNumber").value = plate.plateNumber || "";
    document.getElementById("plateMesh").value = plate.mesh || "";
    document.getElementById("plateTension").value = plate.tension || "";
    document.getElementById("plateLocation").value = plate.location || "";
    document.getElementById("plateFormCard").style.display = "block";
    document.getElementById("plateProductName").focus();
  }

  function closePlateForm() {
    document.getElementById("plateFormCard").style.display = "none";
    resetPlateForm();
  }

  /* ---------- ì´ë¯¸ì§€ ì••ì¶• (íšŒì „ í¬í•¨) ---------- */
  function compressImage(dataUrl, rotationDeg, callback) {
    const img = new Image();
    img.onload = function () {
      const maxSize = 700;
      let w = img.width;
      let h = img.height;
      const ratio = Math.min(maxSize / w, maxSize / h, 1);
      let drawW = Math.round(w * ratio);
      let drawH = Math.round(h * ratio);

      const rot = ((rotationDeg % 360) + 360) % 360;
      let canvasW = drawW, canvasH = drawH;
      if (rot === 90 || rot === 270) { canvasW = drawH; canvasH = drawW; }

      const canvas = document.createElement("canvas");
      canvas.width = canvasW;
      canvas.height = canvasH;
      const ctx = canvas.getContext("2d");

      ctx.translate(canvasW / 2, canvasH / 2);
      ctx.rotate((rot * Math.PI) / 180);
      ctx.drawImage(img, -drawW / 2, -drawH / 2, drawW, drawH);

      const compressed = canvas.toDataURL("image/jpeg", 0.7);
      callback(compressed);
    };
    img.onerror = function () { callback(dataUrl); };
    img.src = dataUrl;
  }

  function computeFilmChanges(oldData, newData, imageChanged) {
    const changes = [];
    if (!oldData) return ["ë“±ë¡"];
    if ((oldData.productName || "") !== (newData.productName || "")) changes.push("ì œí’ˆ ì´ë¦„");
    if ((oldData.filmNumber || "") !== (newData.filmNumber || "")) changes.push("í•„ë¦„ ë²ˆí˜¸");
    if ((oldData.method || "") !== (newData.method || "")) changes.push("ì œíŒ íƒ€ì…");
    if ((oldData.mesh || "") !== (newData.mesh || "")) changes.push("MESH");
    if ((oldData.location || "") !== (newData.location || "")) changes.push("í•„ë¦„ ìœ„ì¹˜");
    if ((oldData.lastUsed || "") !== (newData.lastUsed || "")) changes.push("ë§ˆì§€ë§‰ ì‚¬ìš©ì¼");
    if ((oldData.plateInfo || "") !== (newData.plateInfo || "")) changes.push("ì œíŒ ë°©ë²•");
    if ((oldData.requestPrinter || "") !== (newData.requestPrinter || "")) changes.push("ìš”ì²­ ì¸ì‡„ì");
    if (imageChanged) changes.push("ì´ë¯¸ì§€");
    if (!changes.length) changes.push("ê¸°íƒ€ ìˆ˜ì •");
    return changes;
  }

  function computePlateChanges(oldData, newData) {
    const changes = [];
    if (!oldData) return ["ë“±ë¡"];
    if ((oldData.productName || "") !== (newData.productName || "")) changes.push("ì œí’ˆ ì´ë¦„");
    if ((oldData.plateNumber || "") !== (newData.plateNumber || "")) changes.push("íŒ ë²ˆí˜¸");
    if ((oldData.mesh || "") !== (newData.mesh || "")) changes.push("MESH");
    if ((oldData.tension || "") !== (newData.tension || "")) changes.push("í…ì…˜");
    if ((oldData.location || "") !== (newData.location || "")) changes.push("íŒ ìœ„ì¹˜");
    if (!changes.length) changes.push("ê¸°íƒ€ ìˆ˜ì •");
    return changes;
  }

  /* ---------- ì €ì¥(í•„ë¦„) ---------- */
  async function saveFilmFromForm(event) {
    if (event) event.preventDefault();
    if (currentMode !== "admin") return; // í•„ë¦„ ë“±ë¡/ìˆ˜ì •ì€ ê´€ë¦¬ìë§Œ

    const id = document.getElementById("filmId").value || null;
    const productName = document.getElementById("productName").value.trim();
    const filmNumber = document.getElementById("filmNumber").value.trim();
    const method = document.getElementById("method").value.trim();
    const mesh = document.getElementById("mesh").value.trim();
    const location = document.getElementById("location").value.trim();
    const requestPrinter = document.getElementById("requestPrinter").value;
    const lastUsed = document.getElementById("lastUsed").value || "";
    const plateInfo = getPlateInfoFromForm();
    const imageInput = document.getElementById("imageInput");

    if (!productName || !filmNumber) {
      alert("ì œí’ˆ ì´ë¦„ê³¼ í•„ë¦„ ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");
      return;
    }

    const existing = id ? films.find((f) => f.id === id) : null;

    const baseData = {
      productName, filmNumber, method, mesh, location, lastUsed, plateInfo, requestPrinter
    };

    async function finalizeSave(imageDataUrl) {
      try {
        if (id && existing) {
          const payload = { ...baseData, updatedAt: Date.now() };
          let imageChanged = false;
          if (imageDataUrl !== null) { payload.imageDataUrl = imageDataUrl; imageChanged = true; }
          const changes = computeFilmChanges(existing, payload, imageChanged);

          await db.collection(FILM_COLLECTION).doc(id).set(payload, { merge: true });
          await addHistory("ìˆ˜ì •", {
            itemType: "film",
            id,
            number: filmNumber,
            name: productName,
          }, changes);
        } else {
          const payload = {
            ...baseData,
            imageDataUrl: imageDataUrl || "",
            createdAt: Date.now(),
            updatedAt: Date.now(),
            deviceName: getDeviceLabel() || "",
          };
          const ref = await db.collection(FILM_COLLECTION).add(payload);
          await addHistory("ë“±ë¡", {
            itemType: "film",
            id: ref.id,
            number: filmNumber,
            name: productName,
          }, ["ë“±ë¡"]);
        }

        showToast("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        currentSearchText = "";
        const searchInput = document.getElementById("searchInput");
        if (searchInput) searchInput.value = "";
        closeFilmForm();
        visibleCount = VISIBLE_STEP;
        window.scrollTo({ top: 0, behavior: "smooth" });
      } catch (e) {
        console.error(e);
        showToast("ì €ì¥ ì˜¤ë¥˜");
      }
    }

    if (imageInput.files && imageInput.files[0]) {
      if (!currentSelectedImageDataUrl) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const originalDataUrl = e.target.result;
          compressImage(originalDataUrl, currentImageRotation, finalizeSave);
        };
        reader.readAsDataURL(imageInput.files[0]);
      } else {
        compressImage(currentSelectedImageDataUrl, currentImageRotation, finalizeSave);
      }
    } else {
      finalizeSave(id && existing ? null : "");
    }
  }

  /* ---------- ì €ì¥(íŒ) ---------- */
  async function savePlateFromForm(event) {
    if (event) event.preventDefault();
    if (currentMode !== "admin") return; // íŒ ë“±ë¡/ìˆ˜ì •ì€ ê´€ë¦¬ìë§Œ

    const id = document.getElementById("plateId").value || null;
    const productName = document.getElementById("plateProductName").value.trim();
    const plateNumber = document.getElementById("plateNumber").value.trim();
    const mesh = document.getElementById("plateMesh").value.trim();
    const tension = document.getElementById("plateTension").value.trim(); // âœ… í…ì…˜ ì €ì¥
    const location = document.getElementById("plateLocation").value.trim();

    if (!productName || !plateNumber) {
      alert("ì œí’ˆ ì´ë¦„ê³¼ íŒ ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");
      return;
    }

    const existing = id ? plates.find((p) => p.id === id) : null;
    const payloadBase = { productName, plateNumber, mesh, tension, location };

    try {
      if (id && existing) {
        const payload = { ...payloadBase, updatedAt: Date.now() };
        const changes = computePlateChanges(existing, payload);

        await db.collection(PLATE_COLLECTION).doc(id).set(payload, { merge: true });
        await addHistory("ìˆ˜ì •", {
          itemType: "plate",
          id,
          number: plateNumber,
          name: productName,
        }, changes);
      } else {
        const payload = {
          ...payloadBase,
          createdAt: Date.now(),
          updatedAt: Date.now(),
          deviceName: getDeviceLabel() || "",
          lastUsedAt: 0,
        };
        const ref = await db.collection(PLATE_COLLECTION).add(payload);
        await addHistory("ë“±ë¡", {
          itemType: "plate",
          id: ref.id,
          number: plateNumber,
          name: productName,
        }, ["ë“±ë¡"]);
      }

      showToast("íŒ ì €ì¥ë¨.");
      currentSearchText = "";
      const searchInput = document.getElementById("searchInput");
      if (searchInput) searchInput.value = "";
      closePlateForm();
      visibleCount = VISIBLE_STEP;
      window.scrollTo({ top: 0, behavior: "smooth" });
    } catch (e) {
      console.error(e);
      showToast("íŒ ì €ì¥ ì˜¤ë¥˜");
    }
  }

  /* ---------- íŒë³„ íˆìŠ¤í† ë¦¬(ì„œë¸Œì»¬ë ‰ì…˜ usage) ---------- */
  function openPlateHistorySheet(plateId) {
    currentPlateIdForHistory = plateId;
    const plate = plates.find((p) => p.id === plateId);
    if (!plate) return;

    document.getElementById("plateHistoryTitle").textContent = `íŒ íˆìŠ¤í† ë¦¬ Â· ${plate.plateNumber || ""}`;
    document.getElementById("plateHistorySub").textContent = plate.productName || "";

    document.getElementById("plateHistoryList").innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
    document.getElementById("plateHistorySheet").classList.add("show");

    loadPlateUsage(plateId);
  }

  function closePlateHistorySheet() {
    document.getElementById("plateHistorySheet").classList.remove("show");
    currentPlateIdForHistory = null;
  }

  async function loadPlateUsage(plateId) {
    try {
      const usageSnap = await db
        .collection(PLATE_COLLECTION)
        .doc(plateId)
        .collection("usage")
        .orderBy("timestamp", "desc")
        .limit(100)
        .get();

      const listEl = document.getElementById("plateHistoryList");
      listEl.innerHTML = "";

      if (usageSnap.empty) {
        listEl.innerHTML = `<div class="sheet-item"><div class="sheet-item-strong">ê¸°ë¡ ì—†ìŒ</div><div class="sheet-item-meta">ì•„ì§ ì‚¬ìš©ë“±ë¡ì´ ì—†ì–´.</div></div>`;
        return;
      }

      usageSnap.docs.forEach((d) => {
        const u = d.data() || {};
        const item = document.createElement("div");
        item.className = "sheet-item";

        const top = document.createElement("div");
        top.className = "sheet-item-top";

        const left = document.createElement("div");
        left.className = "sheet-item-strong";
        left.textContent = `${u.who || "-"} Â· ${u.qty ?? "-"}ê°œ`;

        const right = document.createElement("div");
        right.className = "sheet-item-meta";
        right.textContent = `${formatTime(u.timestamp)} Â· ${u.deviceName || ""}`;

        top.appendChild(left);
        top.appendChild(right);
        item.appendChild(top);

        if ((u.memo || "").trim()) {
          const note = document.createElement("div");
          note.className = "sheet-item-note";
          note.textContent = u.memo.trim();
          item.appendChild(note);
        }

        listEl.appendChild(item);
      });
    } catch (e) {
      console.error(e);
      document.getElementById("plateHistoryList").innerHTML =
        `<div class="sheet-item"><div class="sheet-item-strong">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div><div class="sheet-item-meta">ì½˜ì†” í™•ì¸</div></div>`;
    }
  }

  /* ---------- íŒ ì‚¬ìš©ë“±ë¡ ---------- */
  function openPlateUseSheet(plateId) {
    currentPlateIdForUse = plateId;
    const plate = plates.find((p) => p.id === plateId);
    if (!plate) return;

    document.getElementById("plateUseTitle").textContent = `íŒ ì‚¬ìš©ë“±ë¡ Â· ${plate.plateNumber || ""}`;
    document.getElementById("plateUseSub").textContent = plate.productName || "";

    document.getElementById("plateUseWho").value = "";
    document.getElementById("plateUseQty").value = "";
    document.getElementById("plateUseMemo").value = "";

    document.getElementById("plateUseSheet").classList.add("show");
  }

  function closePlateUseSheet() {
    document.getElementById("plateUseSheet").classList.remove("show");
    currentPlateIdForUse = null;
  }

  async function savePlateUse() {
    if (!currentPlateIdForUse) return;
    if (!(currentMode === "admin" || currentMode === "printer")) return;

    const who = (document.getElementById("plateUseWho").value || "").trim();
    const qtyRaw = document.getElementById("plateUseQty").value;
    const qty = qtyRaw === "" ? null : Number(qtyRaw);
    const memo = (document.getElementById("plateUseMemo").value || "").trim();

    if (!who) { alert("ëˆ„ê°€ë¥¼ ì…ë ¥í•´ì¤˜."); return; }
    if (qty === null || isNaN(qty) || qty < 0) { alert("ëª‡ ê°œ ì°ì—ˆëŠ”ì§€ ìˆ«ìë¡œ ì…ë ¥í•´ì¤˜."); return; }

    const plate = plates.find((p) => p.id === currentPlateIdForUse);
    if (!plate) return;

    const now = Date.now();

    try {
      // usage ì„œë¸Œì»¬ë ‰ì…˜ì— ê¸°ë¡
      await db
        .collection(PLATE_COLLECTION)
        .doc(currentPlateIdForUse)
        .collection("usage")
        .add({
          who,
          qty,
          memo,
          timestamp: now,
          deviceName: getDeviceLabel() || "",
        });

      // íŒ ë¬¸ì„œì— ë§ˆì§€ë§‰ ì‚¬ìš© ì—…ë°ì´íŠ¸
      await db
        .collection(PLATE_COLLECTION)
        .doc(currentPlateIdForUse)
        .set({ lastUsedAt: now, updatedAt: now }, { merge: true });

      await addHistory("íŒ ì‚¬ìš©ë“±ë¡", {
        itemType: "plate_use",
        id: currentPlateIdForUse,
        number: plate.plateNumber || "",
        name: plate.productName || "",
      }, ["ëˆ„ê°€", "ìˆ˜ëŸ‰", "ì‹œê°„", "ë©”ëª¨"]);

      showToast("ì‚¬ìš©ë“±ë¡ ì™„ë£Œ.");
      closePlateUseSheet();
    } catch (e) {
      console.error(e);
      showToast("ì‚¬ìš©ë“±ë¡ ì˜¤ë¥˜");
    }
  }

  /* ---------- ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸° ---------- */
  function exportData() {
    // ê°„ë‹¨íˆ films + platesë§Œ ë‚´ë³´ëƒ„ (usageëŠ” ì„œë¸Œì»¬ë ‰ì…˜ì´ë¼ ì œì™¸)
    const payload = {
      exportedAt: Date.now(),
      films,
      plates
    };
    const json = JSON.stringify(payload, null, 2);
    const blob = new Blob([json], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    const date = new Date().toISOString().slice(0, 10).replace(/-/g, "");
    a.href = url;
    a.download = "filmfind_export_" + date + ".json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function importData(file) {
    if (currentMode !== "admin") {
      alert("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°ëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•´.");
      return;
    }

    const reader = new FileReader();
    reader.onload = async function (e) {
      try {
        const data = JSON.parse(e.target.result);

        // êµ¬ë²„ì „: ë°°ì—´ì´ë©´ filmsë¡œ ê°„ì£¼
        if (Array.isArray(data)) {
          for (const f of data) {
            const payload = { ...f };
            delete payload.id;
            if (!payload.createdAt) payload.createdAt = Date.now();
            if (!payload.updatedAt) payload.updatedAt = Date.now();
            await db.collection(FILM_COLLECTION).add(payload);
          }
          showToast("í•„ë¦„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ì–´.");
          return;
        }

        // ì‹ ë²„ì „: {films, plates}
        if (data && typeof data === "object") {
          if (Array.isArray(data.films)) {
            for (const f of data.films) {
              const payload = { ...f };
              delete payload.id;
              if (!payload.createdAt) payload.createdAt = Date.now();
              if (!payload.updatedAt) payload.updatedAt = Date.now();
              await db.collection(FILM_COLLECTION).add(payload);
            }
          }
          if (Array.isArray(data.plates)) {
            for (const p of data.plates) {
              const payload = { ...p };
              delete payload.id;
              if (!payload.createdAt) payload.createdAt = Date.now();
              if (!payload.updatedAt) payload.updatedAt = Date.now();
              if (!payload.lastUsedAt) payload.lastUsedAt = 0;
              await db.collection(PLATE_COLLECTION).add(payload);
            }
          }
          showToast("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ì–´.");
          return;
        }

        alert("í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì€ íŒŒì¼ì´ì•¼.");
      } catch (err) {
        console.error(err);
        showToast("íŒŒì¼ ì½ê¸° ì˜¤ë¥˜");
      }
    };
    reader.readAsText(file, "utf-8");
  }

  /* ---------- ì„¤ì • ---------- */
  function openSettings() {
    const card = document.getElementById("settingsCard");
    const isOpen = card.style.display === "block";
    closeAllPanels();
    if (!isOpen) {
      card.style.display = "block";
      document.getElementById("deviceNameInput").value = getDeviceLabel();
      document.getElementById("sortOptionSelect").value = getSortOption();
      document.getElementById("themeSelect").value = getTheme();

      // ê´€ë¦¬ìë§Œ ë¹„ë²ˆ ì„¹ì…˜ ë³´ì´ê¸°
      const pwSec = document.getElementById("adminPasswordSection");
      pwSec.style.display = (currentMode === "admin") ? "block" : "none";

      if (currentMode === "admin") {
        document.getElementById("currentAdminPwInput").value = "";
        document.getElementById("newAdminPwInput").value = "";
        document.getElementById("newPrinterPwInput").value = "";
        document.getElementById("newViewerPwInput").value = "";
      }
    }
  }
  function closeSettings() {
    document.getElementById("settingsCard").style.display = "none";
  }

  function saveSettings() {
    const deviceName = document.getElementById("deviceNameInput").value.trim();
    const sortOpt = document.getElementById("sortOptionSelect").value;
    const theme = document.getElementById("themeSelect").value;

    setDeviceLabel(deviceName);
    setSortOption(sortOpt);
    setTheme(theme);

    // ê´€ë¦¬ìë©´ ëª¨ë“œë³„ ë¹„ë²ˆ ë³€ê²½ ê°€ëŠ¥
    if (currentMode === "admin") {
      const curAdmin = document.getElementById("currentAdminPwInput").value;
      const newA = document.getElementById("newAdminPwInput").value;
      const newP = document.getElementById("newPrinterPwInput").value;
      const newV = document.getElementById("newViewerPwInput").value;

      const anyPw = (curAdmin || newA || newP || newV);
      if (anyPw) {
        if (curAdmin !== getAdminPw()) {
          alert("í˜„ì¬ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•Šì•„.");
          return;
        }

        // ë¹„ì–´ìˆìœ¼ë©´ ê¸°ì¡´ ìœ ì§€
        if (newA && newA.length < 4) { alert("ê´€ë¦¬ì ë¹„ë²ˆì€ 4ê¸€ì ì´ìƒ"); return; }
        if (newP && newP.length < 4) { alert("ì¸ì‡„ê¸°ì‚¬ ë¹„ë²ˆì€ 4ê¸€ì ì´ìƒ"); return; }
        if (newV && newV.length < 4) { alert("ì¡°íšŒ ë¹„ë²ˆì€ 4ê¸€ì ì´ìƒ"); return; }

        if (newA) setAdminPw(newA);
        if (newP) setPrinterPw(newP);
        if (newV) setViewerPw(newV);

        showToast("ì„¤ì •/ë¹„ë²ˆ ì €ì¥ë¨.");
      } else {
        showToast("ì„¤ì • ì €ì¥ë¨.");
      }
    } else {
      showToast("ì„¤ì • ì €ì¥ë¨.");
    }

    closeSettings();
    renderCurrentList(currentSearchText);
  }

  /* ---------- ì´ë¯¸ì§€ ë·°ì–´ (í•€ì¹˜ ì¤Œ + ìŠ¤ì™€ì´í”„ ë‹¤ìš´ ë‹«ê¸°) ---------- */
  let viewerScale = 1;
  let viewerStartDist = 0;
  let viewerLastScale = 1;
  let viewerTransX = 0;
  let viewerTransY = 0;
  let panStartX = 0;
  let panStartY = 0;
  let isPanning = false;
  let swipeStartY = 0;
  let swipeDeltaY = 0;

  function resetViewerTransform() {
    viewerScale = 1;
    viewerTransX = 0;
    viewerTransY = 0;
    viewerStartDist = 0;
    viewerLastScale = 1;
    isPanning = false;
    swipeStartY = 0;
    swipeDeltaY = 0;
    const img = document.getElementById("viewerImage");
    img.style.transform = "translate(0px, 0px) scale(1)";
  }
  function updateViewerTransform() {
    const img = document.getElementById("viewerImage");
    img.style.transform = "translate(" + viewerTransX + "px, " + viewerTransY + "px) scale(" + viewerScale + ")";
  }
  function openImageViewer(src) {
    if (!src) return;
    const viewer = document.getElementById("imageViewer");
    const img = document.getElementById("viewerImage");
    img.src = src;
    resetViewerTransform();
    viewer.style.display = "flex";
  }
  function closeImageViewer() {
    document.getElementById("imageViewer").style.display = "none";
  }
  function initImageViewerTouch() {
    const img = document.getElementById("viewerImage");
    const backdrop = document.getElementById("viewerBackdrop");

    backdrop.addEventListener("click", closeImageViewer);

    img.addEventListener("touchstart", (e) => {
      if (e.touches.length === 2) {
        e.preventDefault();
        const dx = e.touches[0].clientX - e.touches[1].clientX;
        const dy = e.touches[0].clientY - e.touches[1].clientY;
        viewerStartDist = Math.sqrt(dx*dx + dy*dy);
        viewerLastScale = viewerScale;
      } else if (e.touches.length === 1) {
        swipeStartY = e.touches[0].clientY;
        swipeDeltaY = 0;
        if (viewerScale > 1) {
          isPanning = true;
          panStartX = e.touches[0].clientX - viewerTransX;
          panStartY = e.touches[0].clientY - viewerTransY;
        }
      }
    }, { passive: false });

    img.addEventListener("touchmove", (e) => {
      if (e.touches.length === 2) {
        e.preventDefault();
        const dx = e.touches[0].clientX - e.touches[1].clientX;
        const dy = e.touches[0].clientY - e.touches[1].clientY;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (viewerStartDist > 0) {
          let scale = viewerLastScale * (dist / viewerStartDist);
          if (scale < 1) scale = 1;
          if (scale > 4) scale = 4;
          viewerScale = scale;
          updateViewerTransform();
        }
      } else if (e.touches.length === 1) {
        e.preventDefault();
        const touch = e.touches[0];
        swipeDeltaY = touch.clientY - swipeStartY;

        if (viewerScale > 1 && isPanning) {
          viewerTransX = touch.clientX - panStartX;
          viewerTransY = touch.clientY - panStartY;
          updateViewerTransform();
        }
      }
    }, { passive: false });

    img.addEventListener("touchend", (e) => {
      if (e.touches.length < 2) {
        viewerStartDist = 0;
        viewerLastScale = viewerScale;
      }
      if (e.touches.length === 0) {
        isPanning = false;
        if (swipeDeltaY > 80 && Math.abs(swipeDeltaY) > 40) closeImageViewer();
        swipeStartY = 0;
        swipeDeltaY = 0;
      }
    });
  }

  /* ---------- ìŠ¤í¬ë¡¤ ê´€ë ¨ (ë¬´í•œ ìŠ¤í¬ë¡¤ + ë§¨ ìœ„ë¡œ) ---------- */
  function initScrollHandlers() {
    const scrollTopBtn = document.getElementById("scrollTopBtn");
    const spinner = document.getElementById("loadingSpinner");

    window.addEventListener("scroll", () => {
      const scrollY = window.scrollY || window.pageYOffset;
      const vh = window.innerHeight || document.documentElement.clientHeight;
      const fullHeight = document.documentElement.scrollHeight;

      if (scrollY > 200) scrollTopBtn.classList.add("show");
      else scrollTopBtn.classList.remove("show");

      if (currentSearchText || loadingMore) return;

      const total = (currentTab === "films") ? films.length : plates.length;
      if (visibleCount >= total) return;

      if (scrollY + vh >= fullHeight - 80) {
        loadingMore = true;
        spinner.classList.add("show");
        setTimeout(() => {
          visibleCount = Math.min(visibleCount + VISIBLE_STEP, total);
          renderCurrentList(currentSearchText);
          spinner.classList.remove("show");
          loadingMore = false;
        }, 450);
      }
    });

    scrollTopBtn.addEventListener("click", () => {
      window.scrollTo({ top: 0, behavior: "smooth" });
    });
  }

  /* ---------- ì•± ì´ˆê¸°í™” ---------- */
  function initAppAfterUnlock() {
    setTheme(getTheme());
    setDeviceLabel(getDeviceLabel());
    applyModeUI();

    startFilmsListener();
    startPlatesListener();

    renderCurrentList("");

    // íƒ­
    document.getElementById("tabFilms").addEventListener("click", () => switchTab("films"));
    document.getElementById("tabPlates").addEventListener("click", () => switchTab("plates"));

    // ê²€ìƒ‰
    document.getElementById("searchInput").addEventListener("input", (e) => {
      currentSearchText = e.target.value;
      renderCurrentList(e.target.value);
    });

    // ë·° í† ê¸€
    document.getElementById("viewToggleBtn").addEventListener("click", () => {
      setViewMode(currentViewMode === "gallery" ? "list" : "gallery");
    });
    applyViewMode();

    // ì„¤ì •/íˆìŠ¤í† ë¦¬
    document.getElementById("settingsBtn").addEventListener("click", openSettings);
    document.getElementById("closeSettingsBtn").addEventListener("click", closeSettings);
    document.getElementById("saveSettingsBtn").addEventListener("click", saveSettings);

    document.getElementById("historyBtn").addEventListener("click", openHistoryCard);
    document.getElementById("closeHistoryBtn").addEventListener("click", closeHistoryCard);

    // ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸°
    document.getElementById("exportBtn").addEventListener("click", exportData);
    document.getElementById("importBtn").addEventListener("click", () => document.getElementById("importFile").click());
    document.getElementById("importFile").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) importData(file);
      e.target.value = "";
    });

    // ìƒˆ í•„ë¦„/ìƒˆ íŒ (ê´€ë¦¬ìë§Œ)
    document.getElementById("newFilmBtn").addEventListener("click", () => {
      if (currentMode !== "admin") return;
      switchTab("films");
      openFilmFormNew();
    });
    document.getElementById("newPlateBtn").addEventListener("click", () => {
      if (currentMode !== "admin") return;
      switchTab("plates");
      openPlateFormNew();
    });

    // í•„ë¦„ í¼
    document.getElementById("cancelFilmBtn").addEventListener("click", closeFilmForm);
    document.getElementById("filmForm").addEventListener("submit", saveFilmFromForm);
    document.getElementById("saveFilmBtn").addEventListener("click", saveFilmFromForm);
    document.getElementById("setTodayBtn").addEventListener("click", () => {
      const today = new Date().toISOString().slice(0, 10);
      document.getElementById("lastUsed").value = today;
    });

    // í† ê¸€ ë²„íŠ¼
    document.querySelectorAll(".toggle-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const group = btn.closest(".toggle-group");
        group.querySelectorAll(".toggle-btn").forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
      });
    });

    // í•„ë¦„ ì´ë¯¸ì§€ ì„ íƒ & íšŒì „
    const imageInputEl = document.getElementById("imageInput");
    const rotateLeftBtn = document.getElementById("rotateLeftBtn");
    const rotateRightBtn = document.getElementById("rotateRightBtn");
    const previewWrapper = document.getElementById("imagePreviewWrapper");
    const previewImg = document.getElementById("imagePreview");

    if (imageInputEl) {
      imageInputEl.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) { resetImagePreview(); return; }
        const reader = new FileReader();
        reader.onload = function (ev) {
          currentSelectedImageDataUrl = ev.target.result;
          currentImageRotation = 0;
          if (previewImg) {
            previewImg.src = currentSelectedImageDataUrl;
            previewImg.style.transform = "rotate(0deg)";
          }
          if (previewWrapper) previewWrapper.style.display = "flex";
        };
        reader.readAsDataURL(file);
      });
    }

    if (rotateLeftBtn) {
      rotateLeftBtn.addEventListener("click", () => {
        if (!currentSelectedImageDataUrl) { showToast("ë¨¼ì € ì‚¬ì§„ì„ ì„ íƒí•´ ì¤˜."); return; }
        currentImageRotation = (currentImageRotation - 90) % 360;
        applyPreviewRotation();
      });
    }
    if (rotateRightBtn) {
      rotateRightBtn.addEventListener("click", () => {
        if (!currentSelectedImageDataUrl) { showToast("ë¨¼ì € ì‚¬ì§„ì„ ì„ íƒí•´ ì¤˜."); return; }
        currentImageRotation = (currentImageRotation + 90) % 360;
        applyPreviewRotation();
      });
    }

    // íŒ í¼
    document.getElementById("cancelPlateBtn").addEventListener("click", closePlateForm);
    document.getElementById("plateForm").addEventListener("submit", savePlateFromForm);
    document.getElementById("savePlateBtn").addEventListener("click", savePlateFromForm);

    // ë©”ëª¨ ìŠ¬ë¼ì´ë“œ
    document.getElementById("memoSheetBackdrop").addEventListener("click", closeMemoSheet);
    document.getElementById("memoSheetCloseBtn").addEventListener("click", closeMemoSheet);
    document.getElementById("memoSheetCancelBtn").addEventListener("click", closeMemoSheet);
    document.getElementById("memoSheetSaveBtn").addEventListener("click", saveMemoSheet);

    // íˆìŠ¤í† ë¦¬ ë©”ëª¨ ëª¨ë‹¬
    document.getElementById("historyNoteCancelBtn").addEventListener("click", closeHistoryNoteModal);
    document.getElementById("historyNoteSaveBtn").addEventListener("click", saveHistoryNoteModal);

    // ì´ë¯¸ì§€ ë·°ì–´
    document.getElementById("closeViewerBtn").addEventListener("click", closeImageViewer);
    initImageViewerTouch();

    // ìŠ¤í¬ë¡¤
    initScrollHandlers();

    // íŒ íˆìŠ¤í† ë¦¬ ì‹œíŠ¸
    document.getElementById("plateHistoryBackdrop").addEventListener("click", closePlateHistorySheet);
    document.getElementById("plateHistoryCloseBtn").addEventListener("click", closePlateHistorySheet);
    document.getElementById("plateHistoryCloseBtn2").addEventListener("click", closePlateHistorySheet);

    // íŒ ì‚¬ìš©ë“±ë¡ ì‹œíŠ¸
    document.getElementById("plateUseBackdrop").addEventListener("click", closePlateUseSheet);
    document.getElementById("plateUseCloseBtn").addEventListener("click", closePlateUseSheet);
    document.getElementById("plateUseCancelBtn").addEventListener("click", closePlateUseSheet);
    document.getElementById("plateUseSaveBtn").addEventListener("click", savePlateUse);
  }

  /* ---------- ì ê¸ˆ/ì–¸ë½ ---------- */
  document.addEventListener("DOMContentLoaded", () => {
    const lockScreen = document.getElementById("lockScreen");
    const appContainer = document.getElementById("appContainer");
    const pwInput = document.getElementById("passwordInput");
    const pwBtn = document.getElementById("passwordBtn");

    setTheme(getTheme());

    function unlock() {
      const v = pwInput.value.trim();
      let mode = null;

      if (v === getAdminPw()) mode = "admin";
      else if (v === getPrinterPw()) mode = "printer";
      else if (v === getViewerPw()) mode = "viewer";

      if (mode) {
        currentMode = mode;
        sessionStorage.setItem(UNLOCK_KEY, "true");
        sessionStorage.setItem(MODE_KEY, mode);

        lockScreen.style.display = "none";
        appContainer.style.display = "block";

        if (!window._filmAppInitialized) {
          window._filmAppInitialized = true;
          initAppAfterUnlock();

          // ê¸°ê¸° ì´ë¦„ ëª¨ë‹¬
          if (!getDeviceLabel()) {
            document.getElementById("deviceModal").style.display = "flex";
          }
        } else {
          // ì´ë¯¸ ì´ˆê¸°í™”ëœ ìƒíƒœë©´ UIë§Œ ì ìš©
          applyModeUI();
          renderCurrentList(currentSearchText);
        }
      } else {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ì–´.");
        pwInput.focus();
        pwInput.select();
      }
    }

    const unlocked = sessionStorage.getItem(UNLOCK_KEY) === "true";
    const savedMode = sessionStorage.getItem(MODE_KEY);

    if (unlocked && savedMode) {
      currentMode = savedMode;
      lockScreen.style.display = "none";
      appContainer.style.display = "block";

      if (!window._filmAppInitialized) {
        window._filmAppInitialized = true;
        initAppAfterUnlock();

        if (!getDeviceLabel()) {
          document.getElementById("deviceModal").style.display = "flex";
        }
      } else {
        applyModeUI();
        renderCurrentList(currentSearchText);
      }
    } else {
      lockScreen.style.display = "flex";
      appContainer.style.display = "none";
    }

    pwBtn.addEventListener("click", unlock);
    pwInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") unlock();
    });

    // ê¸°ê¸° ì´ë¦„ ëª¨ë‹¬
    const deviceModal = document.getElementById("deviceModal");
    const deviceInput = document.getElementById("deviceModalInput");
    const deviceSkip = document.getElementById("deviceModalSkip");
    const deviceSave = document.getElementById("deviceModalSave");

    deviceSkip.addEventListener("click", () => {
      deviceModal.style.display = "none";
      showToast("ì–¸ì œë“  ì„¤ì •ì—ì„œ ê¸°ê¸° ì´ë¦„ì„ ë°”ê¿€ ìˆ˜ ìˆì–´.");
    });
    deviceSave.addEventListener("click", () => {
      const name = deviceInput.value.trim();
      if (!name) { alert("ê¸°ê¸° ì´ë¦„ì„ ì…ë ¥í•´ ì¤˜."); return; }
      setDeviceLabel(name);
      deviceModal.style.display = "none";
      showToast("ê¸°ê¸° ì´ë¦„ ì €ì¥ë¨.");
    });
  });
</script>
</body>
</html>
