<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#f9f4ff">
  <meta charset="UTF-8" />
  <title>FILM FIND - í•„ë¦„/íŒ ê´€ë¦¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css" />

  <style>
    :root {
      /* ê¸°ë³¸(ë¼ë²¤ë”) í…Œë§ˆ */
      --bg-gradient: linear-gradient(145deg, #f9fafb, #f4f0ff, #fdf2f8);
      --card-bg: rgba(255,255,255,0.98);
      --card-border: #e3e6ff;
      --shadow-soft: 0 8px 20px rgba(167, 173, 208, 0.35);
      --text-main: #272a3f;
      --text-sub: #767a98;
      --text-muted: #777b9e;
      --label-color: #8689a5;
      --primary-1: #7f9dff;
      --primary-2: #b38cff;
      --primary-soft: rgba(228,231,255,0.95);
      --chip-bg: #f3e8ff;
      --chip-text: #5f308c;
      --danger-bg: #ff6b81;
      --danger-text: #ffffff;
      --pill-bg: rgba(228,231,255,0.98);
      --pill-border: rgba(129, 140, 248, 0.4);
      --toast-bg: rgba(15,23,42,0.9);
      --toast-text: #f9fafb;
      --spinner-border: rgba(191, 219, 254, 0.9);
      --spinner-glow: rgba(129, 140, 248, 0.7);
    }

    /* ë¯¼íŠ¸/í”¼ì¹˜/ë‚˜ì´íŠ¸ í…Œë§ˆ (ê¸°ì¡´ ìœ ì§€) */
    [data-theme="mint"] { --bg-gradient: linear-gradient(145deg, #f0fdfa, #e0f2fe, #fefce8); --primary-1: #34d399; --primary-2: #22c55e; --primary-soft: rgba(187,247,208,0.85); --chip-bg: #dcfce7; --chip-text: #047857; }
    [data-theme="peach"] { --bg-gradient: linear-gradient(145deg, #fff7ed, #fee2e2, #fef9c3); --primary-1: #fb7185; --primary-2: #f97316; --primary-soft: rgba(254, 226, 226, 0.9); --chip-bg: #ffe4e6; --chip-text: #be123c; }
    [data-theme="night"] {
      --bg-gradient: radial-gradient(circle at top, #020617, #020617, #111827);
      --card-bg: rgba(15,23,42,0.98); --card-border: #1f2937; --shadow-soft: 0 10px 24px rgba(15, 23, 42, 0.75);
      --text-main: #e5e7eb; --text-sub: #9ca3af; --text-muted: #9ca3af; --label-color: #9ca3af;
      --primary-1: #6366f1; --primary-2: #a855f7; --primary-soft: rgba(79,70,229,0.22);
      --chip-bg: rgba(79,70,229,0.18); --chip-text: #a5b4fc; --danger-bg: #f97373;
      --pill-bg: rgba(17,24,39,0.95); --pill-border: rgba(129, 140, 248, 0.8);
    }

    * { box-sizing: border-box; font-family: "Pretendard Variable", system-ui, sans-serif; }
    body { margin: 0; min-height: 100vh; background: var(--bg-gradient); padding: 12px; color: var(--text-main); }
    .app-shell { max-width: 720px; margin: 0 auto; }
    .app-header { max-width: 720px; margin: 0 auto 6px; display: flex; align-items: center; justify-content: space-between; gap: 8px; }
    .app-title { font-size: 20px; font-weight: 700; letter-spacing: 2px; color: var(--text-main); }
    .device-badge { font-size: 11px; padding: 4px 12px; border-radius: 999px; background: var(--pill-bg); color: var(--text-sub); border: 1px solid var(--pill-border); display: flex; align-items: center; gap: 6px; }
    .device-dot { width: 6px; height: 6px; border-radius: 999px; background: var(--primary-1); }
    
    .top-bar { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
    .top-bar input[type="text"] { flex: 1; padding: 9px 11px; border-radius: 999px; border: 1px solid var(--card-border); font-size: 14px; background: rgba(255,255,255,0.9); color: var(--text-main); }
    
    .btn { padding: 8px 11px; border-radius: 999px; border: none; font-size: 13px; cursor: pointer; white-space: nowrap; transition: 0.1s; }
    .btn-primary { background: linear-gradient(135deg, var(--primary-1), var(--primary-2)); color: white; box-shadow: 0 4px 10px rgba(127,157,255,0.35); }
    .btn-secondary { background: var(--primary-soft); color: #283252; }
    .btn-danger { background: var(--danger-bg); color: var(--danger-text); }
    .btn-small { font-size: 12px; padding: 5px 9px; }

    .tabbar { display: flex; gap: 8px; align-items: center; margin: 8px 0 10px; }
    .tab-btn { padding: 7px 12px; border-radius: 999px; border: 1px solid var(--card-border); background: rgba(255,255,255,0.7); color: var(--text-main); font-size: 13px; cursor: pointer; }
    .tab-btn.active { border-color: var(--primary-1); background: linear-gradient(135deg, var(--primary-1), var(--primary-2)); color: #fff; }

    .form-card { background: var(--card-bg); border-radius: 18px; padding: 12px 14px; margin-bottom: 12px; box-shadow: var(--shadow-soft); border: 1px solid var(--card-border); }
    .form-row { display: flex; flex-direction: column; margin-bottom: 9px; }
    .form-row label { font-size: 12px; margin-bottom: 4px; color: var(--label-color); }
    .form-row input, .form-row select, .form-row textarea { padding: 7px 10px; border-radius: 10px; border: 1px solid var(--card-border); font-size: 13px; background: #f9f9ff; color: var(--text-main); }

    .card { background: rgba(255,255,255,0.96); border-radius: 16px; padding: 10px; display: flex; gap: 10px; box-shadow: 0 6px 16px rgba(169, 177, 214, 0.35); border: 1px solid var(--card-border); margin-bottom: 10px; animation: cardFadeIn 0.18s ease-out; }
    @keyframes cardFadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
    .card img { width: 70px; height: 70px; object-fit: cover; border-radius: 12px; background: #eef1ff; cursor: pointer; }
    .card-content { flex: 1; font-size: 13px; }
    .card-title { font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
    .card-tag { font-size: 11px; padding: 3px 7px; border-radius: 999px; background: var(--chip-bg); color: var(--chip-text); }
    .label { color: var(--label-color); font-size: 11px; margin-right: 4px; }
    .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 6px; gap: 6px; flex-wrap: wrap; }
    
    .toast { position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%) translateY(40px); background: var(--toast-bg); color: var(--toast-text); padding: 8px 14px; border-radius: 999px; font-size: 12px; opacity: 0; transition: 0.3s; z-index: 2000; }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    .lock-screen { position: fixed; inset: 0; background: radial-gradient(circle at top, rgba(255,255,255,0.95), rgba(203,213,255,0.96)); display: flex; align-items: center; justify-content: center; z-index: 10000; }
    .status-pill { padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: bold; color: white; }

    /* íˆìŠ¤í† ë¦¬ íƒ€ì„ë¼ì¸ */
    .history-list { max-height: 280px; overflow-y: auto; padding-right: 4px; margin-top: 4px; position: relative; }
    .history-row { font-size: 12px; color: #444867; padding: 6px 20px; position: relative; border-bottom: 1px solid #eee; }
    .history-time { color: #6b6f90; font-size: 11px; }

    /* ì‹œíŠ¸ (ë°”í…€ ì‹œíŠ¸) */
    .sheet { position: fixed; inset: 0; display: none; align-items: flex-end; justify-content: center; z-index: 1600; }
    .sheet.show { display: flex; }
    .sheet-backdrop { position: absolute; inset: 0; background: rgba(15, 23, 42, 0.45); }
    .sheet-panel { position: relative; width: 100%; max-width: 720px; background: var(--card-bg); border-radius: 18px 18px 0 0; padding: 15px; animation: sheetUp 0.16s ease-out; }
    @keyframes sheetUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  </style>
</head>

<body>
  <div id="lockScreen" class="lock-screen">
    <div class="form-card" style="width: 300px; text-align: center;">
      <h3 style="margin-top:0;">FILM FIND</h3>
      <input type="password" id="passwordInput" placeholder="ë¹„ë°€ë²ˆí˜¸" style="width:100%; text-align:center; margin-bottom:10px;">
      <button class="btn btn-primary" id="passwordBtn" style="width:100%;">ì…ì¥í•˜ê¸°</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <div id="imageViewer" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center;" onclick="this.style.display='none'">
    <img id="viewerImage" src="" style="max-width:90%; max-height:90%; border-radius:10px;">
  </div>

  <div id="appContainer" style="display:none;">
    <div class="app-shell">
      <div class="app-header">
        <div class="app-title">FILM FIND</div>
        <div id="modeChip" class="device-badge">
          <span class="device-dot"></span>
          <span id="modeChipText">ëª¨ë“œ</span>
        </div>
      </div>

      <div class="top-bar">
        <input type="text" id="searchInput" placeholder="ì œí’ˆëª…, ë²ˆí˜¸ ê²€ìƒ‰...">
        <button class="btn btn-primary" id="newFilmBtn">+ ìƒˆ í•„ë¦„</button>
      </div>

      <div class="tabbar">
        <button class="tab-btn active" id="tabFilmsBtn">í•„ë¦„</button>
        <button class="tab-btn" id="tabPlatesBtn">íŒ</button>
      </div>

      <div style="display:flex; justify-content:flex-end; gap:6px; margin-bottom:10px;">
        <button class="btn btn-secondary btn-small" id="historyBtn">ğŸ“œ ì „ì²´ íˆìŠ¤í† ë¦¬</button>
        <button class="btn btn-secondary btn-small" id="settingsBtn">âš™ ì„¤ì •</button>
      </div>

      <div id="formCard" class="form-card" style="display:none;">
        <h4 style="margin:0 0 10px 0;">í•„ë¦„ ë“±ë¡/ìˆ˜ì •</h4>
        <input type="hidden" id="filmId">
        <div class="form-row"><label>ì œí’ˆëª… *</label><input type="text" id="productName"></div>
        <div class="form-row"><label>í•„ë¦„ë²ˆí˜¸ *</label><input type="text" id="filmNumber"></div>
        <div class="form-row"><label>ì œíŒíƒ€ì…</label><input type="text" id="method"></div>
        <div class="form-row"><label>MESH</label><input type="text" id="mesh"></div>
        <div class="form-row"><label>ìœ„ì¹˜</label><input type="text" id="location"></div>
        <div class="form-row"><label>ìš”ì²­ ì¸ì‡„ì</label><select id="requestPrinter"></select></div>
        <div class="form-row"><label>ì‚¬ì§„</label><input type="file" id="imageInput" accept="image/*"></div>
        <div style="display:flex; gap:6px; justify-content:flex-end; margin-top:10px;">
          <button class="btn btn-secondary" onclick="closeForm()">ì·¨ì†Œ</button>
          <button class="btn btn-primary" id="saveFilmBtn">ì €ì¥</button>
        </div>
      </div>

      <div id="plateFormCard" class="form-card" style="display:none;">
        <h4 style="margin:0 0 10px 0;">íŒ ë“±ë¡</h4>
        <input type="hidden" id="p_filmId">
        <div class="form-row"><label>íŒ ë²ˆí˜¸ *</label><input type="text" id="p_plateNumber"></div>
        <div class="form-row"><label>í…ì…˜</label><input type="text" id="p_tension"></div>
        <div class="form-row"><label>MESH</label><input type="text" id="p_mesh"></div>
        <div class="form-row"><label>ìµœëŒ€ ì‚¬ìš©ìˆ˜ëŸ‰</label><input type="number" id="p_maxQty" value="5000"></div>
        <div style="display:flex; gap:6px; justify-content:flex-end; margin-top:10px;">
          <button class="btn btn-secondary" onclick="this.parentElement.parentElement.style.display='none'">ì·¨ì†Œ</button>
          <button class="btn btn-primary" id="savePlateBtn">ë“±ë¡</button>
        </div>
      </div>

      <div id="settingsCard" class="form-card" style="display:none;">
        <h4>âš™ ì„¤ì •</h4>
        <div class="form-row"><label>ì´ ê¸°ê¸° ì´ë¦„</label><input type="text" id="deviceNameInput"></div>
        <div class="form-row"><label>í…Œë§ˆ ì„ íƒ</label>
          <select id="themeSelect">
            <option value="default">ë¼ë²¤ë”</option>
            <option value="mint">ë¯¼íŠ¸</option>
            <option value="peach">í”¼ì¹˜</option>
            <option value="night">ë‚˜ì´íŠ¸</option>
          </select>
        </div>
        <div style="display:flex; gap:6px; justify-content:flex-end;">
          <button class="btn btn-secondary" onclick="this.parentElement.parentElement.style.display='none'">ë‹«ê¸°</button>
          <button class="btn btn-primary" id="saveSettingsBtn">ì €ì¥</button>
        </div>
      </div>

      <div id="list"></div>
    </div>
  </div>

  <div id="historySheet" class="sheet">
    <div class="sheet-backdrop" onclick="this.parentElement.classList.remove('show')"></div>
    <div class="sheet-panel">
      <h4>ğŸ“œ ì „ì²´ íˆìŠ¤í† ë¦¬ (ìµœê·¼ 50ê±´)</h4>
      <div id="historyList" class="history-list"></div>
      <button class="btn btn-secondary" style="width:100%; margin-top:10px;" onclick="this.parentElement.parentElement.classList.remove('show')">ë‹«ê¸°</button>
    </div>
  </div>

  <div id="plateUseSheet" class="sheet">
    <div class="sheet-backdrop" onclick="this.parentElement.classList.remove('show')"></div>
    <div class="sheet-panel">
      <h4 id="useTitle">íŒ ì‚¬ìš© ë“±ë¡</h4>
      <input type="hidden" id="usePlateId">
      <div class="form-row"><label>ì¸ì‡„ê¸°ì‚¬</label><select id="useWhoSelect"></select></div>
      <div class="form-row"><label>ì¸ì‡„ ìˆ˜ëŸ‰</label><input type="number" id="useQtyInput"></div>
      <div class="form-row"><label>ë©”ëª¨</label><textarea id="useMemoInput" rows="2"></textarea></div>
      <div style="display:flex; gap:6px; margin-top:10px;">
        <button class="btn btn-secondary" style="flex:1;" onclick="this.parentElement.parentElement.parentElement.classList.remove('show')">ì·¨ì†Œ</button>
        <button class="btn btn-primary" style="flex:1;" id="confirmUseBtn">ë“±ë¡ ì™„ë£Œ</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBrBnVuXca2Ou1oMFOLzq3KGEN8xiK5L_U",
      authDomain: "film-find-5242d.firebaseapp.com",
      projectId: "film-find-5242d",
      storageBucket: "film-find-5242d.firebasestorage.app",
      messagingSenderId: "185123433624",
      appId: "1:185123433624:web:269eb9b4b6437887f2f4ed",
      measurementId: "G-V9KL8XS9KJ"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* 2. ê³µí†µ ì¸ì‡„ê¸°ì‚¬ ë¦¬ìŠ¤íŠ¸ */
    const PRINTER_LIST = ["ì´ì°½ë¯¼ ë¶€ì¥ë‹˜", "ê³ ê´‘ìš´ ê³¼ì¥ë‹˜", "ê¹€ê·œí—Œ ì°¨ì¥ë‹˜", "ë°•ì¬í˜„ ëŒ€ë¦¬ë‹˜", "ì¡°ì˜ë¹ˆ ëŒ€ë¦¬ë‹˜", "ê¹€í˜„ê·œ ëŒ€ë¦¬ë‹˜", "ì¥ì§„ìš° ëŒ€ë¦¬ë‹˜", "ê¹€ë¯¸ì€ ì£¼ì„ë‹˜", "ì´ìˆ˜ì•ˆ ì‚¬ì›ë‹˜", "ë°•ì§€ì•ˆ ì‚¬ì›ë‹˜", "ê¹€ì¸ì„  ì‚¬ì›ë‹˜", "ê¹€ìš©ì› ì‚¬ì›ë‹˜", "ìµœì„±ê·œ ì‚¬ì›ë‹˜"];
    
    let films = [];
    let plates = [];
    let currentMode = null;
    let currentTab = "films";
    let authConfig = { adminPw: "0605", printerPw: "1234", viewerPw: "0000" };

    /* 1. ì„¸ì…˜ ê¸°ë°˜ ë¡œê·¸ì¸ (íƒ­ ë‹«ìœ¼ë©´ ë¡œê·¸ì•„ì›ƒ) */
    async function initAuth() {
      const authSnap = await db.collection("appConfig").doc("auth").get();
      if(authSnap.exists) authConfig = authSnap.data();

      const sessionMode = sessionStorage.getItem("filmAppMode");
      if(sessionStorage.getItem("filmAppUnlocked") === "1" && sessionMode) {
        loginSuccess(sessionMode);
      }
    }

    document.getElementById("passwordBtn").onclick = () => {
      const pw = document.getElementById("passwordInput").value;
      let mode = null;
      if(pw === authConfig.adminPw) mode = "admin";
      else if(pw === authConfig.printerPw) mode = "printer";
      else if(pw === authConfig.viewerPw) mode = "viewer";

      if(mode) {
        sessionStorage.setItem("filmAppUnlocked", "1");
        sessionStorage.setItem("filmAppMode", mode);
        loginSuccess(mode);
      } else {
        showToast("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      }
    };

    function loginSuccess(mode) {
      currentMode = mode;
      document.getElementById("lockScreen").style.display = "none";
      document.getElementById("appContainer").style.display = "block";
      document.getElementById("modeChipText").textContent = mode.toUpperCase();
      
      // ì¸ì‡„ê¸°ì‚¬ ê³µí†µ ë¦¬ìŠ¤íŠ¸ ì ìš©
      const selects = [document.getElementById("requestPrinter"), document.getElementById("useWhoSelect")];
      selects.forEach(s => {
        s.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
        PRINTER_LIST.forEach(p => s.innerHTML += `<option value="${p}">${p}</option>`);
      });

      if(mode === "printer") {
        currentTab = "plates";
        document.getElementById("newFilmBtn").style.display = "none";
        document.getElementById("tabFilmsBtn").style.display = "none";
        document.getElementById("tabPlatesBtn").classList.add("active");
      }

      applyTheme(localStorage.getItem("filmTheme") || "default");
      startSync();
    }

    function startSync() {
      db.collection("films").onSnapshot(s => {
        films = s.docs.map(d => ({id:d.id, ...d.data()}));
        if(currentTab === "films") render();
      });
      db.collection("plates").onSnapshot(s => {
        plates = s.docs.map(d => ({id:d.id, ...d.data()}));
        if(currentTab === "plates") render();
      });
    }

    /* 3. íˆìŠ¤í† ë¦¬ ê¸°ë¡ (íŒ ë“±ë¡/ìˆ˜ì • í¬í•¨) */
    async function addHistory(action, title, detail) {
      await db.collection("history").add({
        action, title, detail,
        device: localStorage.getItem("filmDeviceLabel") || "ë¯¸ì§€ì •",
        timestamp: Date.now()
      });
    }

    /* 4. ì‚¬ìš©ëŸ‰ ë±ƒì§€ ë° ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ */
    function render() {
      const list = document.getElementById("list");
      list.innerHTML = "";
      const search = document.getElementById("searchInput").value.toLowerCase();

      if(currentTab === "films") {
        const filtered = films.filter(f => (f.productName+f.filmNumber).toLowerCase().includes(search));
        filtered.forEach(f => {
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <img src="${f.imageDataUrl || ''}" onclick="showViewer('${f.imageDataUrl}')">
            <div class="card-content">
              <div class="card-title">${f.productName} <span class="card-tag">${f.filmNumber}</span></div>
              <div class="card-row"><span class="label">MESH</span>${f.mesh || '-'}</div>
              <div class="card-row"><span class="label">ìœ„ì¹˜</span>${f.location || '-'}</div>
              <div class="card-footer">
                <div style="font-size:11px; color:#999;">${f.method || ''}</div>
                <div>
                  <button class="btn btn-secondary btn-small" onclick="openPlateForm('${f.id}')">íŒ ë“±ë¡</button>
                  ${currentMode==='admin' ? `<button class="btn btn-primary btn-small" onclick="editFilm('${f.id}')">ìˆ˜ì •</button>` : ''}
                </div>
              </div>
            </div>
          `;
          list.appendChild(card);
        });
      } else {
        const filtered = plates.filter(p => (p.productName+p.plateNumber).toLowerCase().includes(search));
        filtered.forEach(p => {
          const total = p.totalQty || 0;
          const max = p.maxQty || 5000;
          const rate = Math.floor((total/max)*100);
          
          let color = "#22c55e"; let status = "ì ì ˆ";
          if(rate >= 100) { color = "#ef4444"; status = "ê²½ê³ "; }
          else if(rate >= 90) { color = "#f97316"; status = "ì£¼ì˜"; }
          else if(rate >= 70) { color = "#eab308"; status = "ìœ ì˜"; }

          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <img src="${p.imageDataUrl || ''}" onclick="showViewer('${p.imageDataUrl}')">
            <div class="card-content">
              <div class="card-title">${p.productName} <span class="status-pill" style="background:${color}">${status} ${rate}%</span></div>
              <div class="card-row"><strong>${p.plateNumber}</strong></div>
              <div class="card-row"><span class="label">ì‚¬ìš©ëŸ‰</span>${total.toLocaleString()} / ${max.toLocaleString()}</div>
              <div class="card-row"><span class="label">ì •ë³´</span>${p.mesh || '-'} | ${p.tension || '-'}</div>
              <div class="card-footer">
                <div style="font-size:10px; color:#999;">í•„ë¦„: ${p.filmNumber}</div>
                <div>
                  ${currentMode !== 'viewer' ? `<button class="btn btn-primary btn-small" onclick="openUseSheet('${p.id}')">ì‚¬ìš©ë“±ë¡</button>` : ''}
                  ${currentMode === 'admin' ? `<button class="btn btn-danger btn-small" onclick="deletePlate('${p.id}')">ì‚­ì œ</button>` : ''}
                </div>
              </div>
            </div>
          `;
          list.appendChild(card);
        });
      }
    }

    /* ì´ë²¤íŠ¸ ë°”ì¸ë”© */
    document.getElementById("tabFilmsBtn").onclick = () => { currentTab="films"; render(); document.getElementById("tabPlatesBtn").classList.remove("active"); document.getElementById("tabFilmsBtn").classList.add("active"); };
    document.getElementById("tabPlatesBtn").onclick = () => { currentTab="plates"; render(); document.getElementById("tabFilmsBtn").classList.remove("active"); document.getElementById("tabPlatesBtn").classList.add("active"); };
    document.getElementById("searchInput").oninput = render;

    document.getElementById("newFilmBtn").onclick = () => { closeForm(); document.getElementById("formCard").style.display="block"; };
    
    document.getElementById("saveFilmBtn").onclick = async () => {
      const id = document.getElementById("filmId").value;
      const data = {
        productName: document.getElementById("productName").value,
        filmNumber: document.getElementById("filmNumber").value,
        method: document.getElementById("method").value,
        mesh: document.getElementById("mesh").value,
        location: document.getElementById("location").value,
        requestPrinter: document.getElementById("requestPrinter").value,
        updatedAt: Date.now()
      };
      const file = document.getElementById("imageInput").files[0];
      if(file) {
        const reader = new FileReader();
        reader.onload = async (e) => { data.imageDataUrl = e.target.result; save(); };
        reader.readAsDataURL(file);
      } else save();

      async function save() {
        if(id) { await db.collection("films").doc(id).update(data); addHistory("í•„ë¦„ ìˆ˜ì •", data.productName, "ì •ë³´ ìˆ˜ì •ë¨"); }
        else { await db.collection("films").add(data); addHistory("í•„ë¦„ ë“±ë¡", data.productName, "ì‹ ê·œ ë“±ë¡"); }
        closeForm(); showToast("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }
    };

    function openPlateForm(filmId) {
      const f = films.find(x => x.id === filmId);
      document.getElementById("p_filmId").value = filmId;
      document.getElementById("p_plateNumber").value = f.filmNumber + "-";
      document.getElementById("p_mesh").value = f.mesh;
      document.getElementById("plateFormCard").style.display = "block";
    }

    document.getElementById("savePlateBtn").onclick = async () => {
      const f = films.find(x => x.id === document.getElementById("p_filmId").value);
      const data = {
        filmId: f.id, productName: f.productName, filmNumber: f.filmNumber,
        plateNumber: document.getElementById("p_plateNumber").value,
        tension: document.getElementById("p_tension").value,
        mesh: document.getElementById("p_mesh").value,
        maxQty: Number(document.getElementById("p_maxQty").value),
        totalQty: 0, imageDataUrl: f.imageDataUrl || "", createdAt: Date.now()
      };
      await db.collection("plates").add(data);
      addHistory("íŒ ë“±ë¡", data.productName, `ë²ˆí˜¸: ${data.plateNumber}`);
      document.getElementById("plateFormCard").style.display = "none";
      showToast("íŒì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
    };

    function openUseSheet(id) {
      const p = plates.find(x => x.id === id);
      document.getElementById("usePlateId").value = id;
      document.getElementById("useTitle").textContent = p.plateNumber + " ì‚¬ìš© ë“±ë¡";
      document.getElementById("plateUseSheet").classList.add("show");
    }

    document.getElementById("confirmUseBtn").onclick = async () => {
      const id = document.getElementById("usePlateId").value;
      const qty = Number(document.getElementById("useQtyInput").value);
      const who = document.getElementById("useWhoSelect").value;
      const memo = document.getElementById("useMemoInput").value;
      if(!who || qty <= 0) return alert("ê¸°ì‚¬ì™€ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.");

      const ref = db.collection("plates").doc(id);
      await db.runTransaction(async (t) => {
        const doc = await t.get(ref);
        const newTotal = (doc.data().totalQty || 0) + qty;
        t.update(ref, { totalQty: newTotal });
        t.set(ref.collection("usage").doc(), { who, qty, memo, timestamp: Date.now(), device: localStorage.getItem("filmDeviceLabel") });
      });
      showToast("ì‚¬ìš©ëŸ‰ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
      document.getElementById("plateUseSheet").classList.remove("show");
    };

    document.getElementById("historyBtn").onclick = async () => {
      const snap = await db.collection("history").orderBy("timestamp", "desc").limit(50).get();
      const hList = document.getElementById("historyList");
      hList.innerHTML = "";
      snap.forEach(d => {
        const h = d.data();
        hList.innerHTML += `<div class="history-row"><div class="history-time">${new Date(h.timestamp).toLocaleString()}</div><strong>[${h.action}]</strong> ${h.title} - ${h.detail}</div>`;
      });
      document.getElementById("historySheet").classList.add("show");
    };

    document.getElementById("settingsBtn").onclick = () => {
      document.getElementById("deviceNameInput").value = localStorage.getItem("filmDeviceLabel") || "";
      document.getElementById("settingsCard").style.display = "block";
    };
    document.getElementById("saveSettingsBtn").onclick = () => {
      localStorage.setItem("filmDeviceLabel", document.getElementById("deviceNameInput").value);
      const theme = document.getElementById("themeSelect").value;
      localStorage.setItem("filmTheme", theme);
      applyTheme(theme);
      showToast("ì„¤ì • ì €ì¥ë¨");
      document.getElementById("settingsCard").style.display = "none";
    };

    function applyTheme(t) { document.documentElement.setAttribute("data-theme", t === "default" ? "" : t); }
    function closeForm() { document.getElementById("formCard").style.display="none"; document.getElementById("filmId").value=""; }
    function showViewer(src) { if(!src) return; document.getElementById("viewerImage").src = src; document.getElementById("imageViewer").style.display = "flex"; }
    function showToast(m) { const t = document.getElementById("toast"); t.textContent = m; t.classList.add("show"); setTimeout(() => t.classList.remove("show"), 2000); }
    function editFilm(id) {
      const f = films.find(x => x.id === id);
      document.getElementById("filmId").value = f.id;
      document.getElementById("productName").value = f.productName;
      document.getElementById("filmNumber").value = f.filmNumber;
      document.getElementById("method").value = f.method || "";
      document.getElementById("mesh").value = f.mesh || "";
      document.getElementById("location").value = f.location || "";
      document.getElementById("requestPrinter").value = f.requestPrinter || "";
      document.getElementById("formCard").style.display = "block";
    }
    async function deletePlate(id) { if(confirm("íŒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { await db.collection("plates").doc(id).delete(); showToast("ì‚­ì œë¨"); } }

    initAuth();
  </script>
</body>
</html>
