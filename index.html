<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#f9f4ff">
  <meta charset="UTF-8" />
  <title>FILM FIND - í•„ë¦„/íŒ ê´€ë¦¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- í°íŠ¸ (Pretendard) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css" />

  <style>
    :root {
      /* ê¸°ë³¸(ë¼ë²¤ë”) í…Œë§ˆ */
      --bg-gradient: linear-gradient(145deg, #f9fafb, #f4f0ff, #fdf2f8);
      --card-bg: rgba(255,255,255,0.98);
      --card-border: #e3e6ff;
      --shadow-soft: 0 8px 20px rgba(167, 173, 208, 0.35);

      --text-main: #272a3f;
      --text-sub: #767a98;
      --text-muted: #777b9e;
      --label-color: #8689a5;

      --primary-1: #7f9dff;
      --primary-2: #b38cff;
      --primary-soft: rgba(228,231,255,0.95);

      --chip-bg: #f3e8ff;
      --chip-text: #5f308c;

      --danger-bg: #ff6b81;
      --danger-text: #ffffff;

      --pill-bg: rgba(228,231,255,0.98);
      --pill-border: rgba(129, 140, 248, 0.4);

      --toast-bg: rgba(15,23,42,0.9);
      --toast-text: #f9fafb;

      --spinner-border: rgba(191, 219, 254, 0.9);
      --spinner-glow: rgba(129, 140, 248, 0.7);
    }

    /* ë¯¼íŠ¸ í…Œë§ˆ */
    [data-theme="mint"] {
      --bg-gradient: linear-gradient(145deg, #f0fdfa, #e0f2fe, #fefce8);
      --primary-1: #34d399;
      --primary-2: #22c55e;
      --primary-soft: rgba(187,247,208,0.85);
      --chip-bg: #dcfce7;
      --chip-text: #047857;
      --pill-bg: rgba(219, 234, 254, 0.96);
      --pill-border: rgba(45, 212, 191, 0.5);
      --spinner-border: rgba(167, 243, 208, 0.9);
      --spinner-glow: rgba(45, 212, 191, 0.7);
    }

    /* í”¼ì¹˜ í…Œë§ˆ */
    [data-theme="peach"] {
      --bg-gradient: linear-gradient(145deg, #fff7ed, #fee2e2, #fef9c3);
      --primary-1: #fb7185;
      --primary-2: #f97316;
      --primary-soft: rgba(254, 226, 226, 0.9);
      --chip-bg: #ffe4e6;
      --chip-text: #be123c;
      --pill-bg: rgba(254, 226, 226, 0.96);
      --pill-border: rgba(248, 113, 113, 0.55);
      --spinner-border: rgba(254, 202, 202, 0.9);
      --spinner-glow: rgba(248, 113, 113, 0.75);
    }

    /* ë‚˜ì´íŠ¸(ì–´ë‘ìš´) í…Œë§ˆ */
    [data-theme="night"] {
      --bg-gradient: radial-gradient(circle at top, #020617, #020617, #111827);
      --card-bg: rgba(15,23,42,0.98);
      --card-border: #1f2937;
      --shadow-soft: 0 10px 24px rgba(15, 23, 42, 0.75);

      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --text-muted: #9ca3af;
      --label-color: #9ca3af;

      --primary-1: #6366f1;
      --primary-2: #a855f7;
      --primary-soft: rgba(79,70,229,0.22);

      --chip-bg: rgba(79,70,229,0.18);
      --chip-text: #a5b4fc;

      --danger-bg: #f97373;
      --danger-text: #111827;

      --pill-bg: rgba(17,24,39,0.95);
      --pill-border: rgba(129, 140, 248, 0.8);

      --toast-bg: rgba(17,24,39,0.95);
      --toast-text: #e5e7eb;

      --spinner-border: rgba(55, 65, 81, 0.9);
      --spinner-glow: rgba(129, 140, 248, 0.85);
    }

    * { box-sizing: border-box; font-family: "Pretendard Variable", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin: 0; min-height: 100vh; background: var(--bg-gradient); padding: 12px; color: var(--text-main); }

    .app-shell { max-width: 720px; margin: 0 auto; }

    .app-header {
      max-width: 720px; margin: 0 auto 6px;
      display: flex; align-items: center; justify-content: space-between; gap: 8px;
    }
    .title-wrap { display:flex; flex-direction:column; gap:2px; }
    .app-title { font-size:20px; font-weight:700; letter-spacing:2px; color: var(--text-main); }
    .app-subtitle { font-size:11px; color: var(--text-sub); }

    .device-badge{
      font-size: 11px; padding: 4px 12px; border-radius: 999px;
      background: var(--pill-bg); color: var(--text-sub);
      white-space: nowrap; max-width: 160px; text-overflow: ellipsis; overflow: hidden;
      border: 1px solid var(--pill-border);
      box-shadow: 0 0 8px rgba(129, 140, 248, 0.28);
      display:flex; align-items:center; gap:6px; justify-content:flex-end;
    }
    .device-dot{ width:6px; height:6px; border-radius:999px; background: var(--primary-1); box-shadow: 0 0 6px rgba(129, 140, 248, 0.9); }

    .mode-chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 10px; border-radius:999px;
      border:1px solid var(--pill-border); background: var(--pill-bg);
      font-size:11px; color: var(--text-sub);
      max-width:140px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .mode-dot{ width:6px; height:6px; border-radius:999px; background: var(--primary-2); box-shadow: 0 0 6px rgba(179, 140, 255, 0.8); }

    .top-bar { display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap; }
    .top-bar input[type="text"]{
      flex: 1; padding: 9px 11px; border-radius:999px; border: 1px solid var(--card-border);
      font-size:14px; min-width: 0; background: rgba(255,255,255,0.9); color: var(--text-main);
    }
    .top-bar input::placeholder{ color: var(--text-muted); }
    [data-theme="night"] .top-bar input[type="text"] { background: #020617; border-color: #1f2937; }

    .btn{
      padding:8px 11px; border-radius:999px; border:none;
      font-size:13px; cursor:pointer; white-space:nowrap;
      transition: transform 0.05s ease, box-shadow 0.1s ease, background 0.1s ease, opacity 0.1s ease;
    }
    .btn:active{ transform: translateY(1px); box-shadow:none; opacity:0.92; }
    .btn-primary{ background: linear-gradient(135deg, var(--primary-1), var(--primary-2)); color:white; box-shadow: 0 4px 10px rgba(127,157,255,0.35); }
    .btn-secondary{ background: var(--primary-soft); color: #283252; }
    [data-theme="night"] .btn-secondary{ color:#e5e7eb; }
    .btn-danger{ background: var(--danger-bg); color: var(--danger-text); }
    .btn-small{ font-size:12px; padding:5px 9px; border-radius:999px; }
    .btn-ghost{ background: rgba(255,255,255,0.55); border: 1px solid var(--card-border); color: var(--text-main); }
    [data-theme="night"] .btn-ghost { background: rgba(2,6,23,0.55); border-color: #1f2937; color:#e5e7eb; }

    .tools-bar{ display:flex; gap:6px; margin-bottom:6px; flex-wrap:wrap; justify-content:flex-end; }

    .tabbar{
      display:flex; gap:8px; align-items:center; justify-content:flex-start;
      margin: 8px 0 10px; flex-wrap:wrap;
    }
    .tab-btn{
      padding:7px 12px; border-radius:999px; border:1px solid var(--card-border);
      background: rgba(255,255,255,0.7); color: var(--text-main);
      font-size:13px; cursor:pointer; display:inline-flex; align-items:center; gap:6px;
    }
    [data-theme="night"] .tab-btn{ background: rgba(2,6,23,0.55); border-color:#1f2937; }
    .tab-btn.active{
      border-color: var(--primary-1);
      background: linear-gradient(135deg, var(--primary-1), var(--primary-2));
      color:#fff; box-shadow: 0 6px 16px rgba(127,157,255,0.25);
    }

    .count-wrap{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:10px; }
    .count-bar{ font-size:11px; color: var(--text-muted); text-align:left; flex:1; }
    .count-bar strong{ color: var(--primary-1); }

    .form-card{
      background: var(--card-bg); border-radius:18px; padding:12px 14px; margin-bottom:12px;
      box-shadow: var(--shadow-soft); border: 1px solid var(--card-border);
    }
    .form-row{ display:flex; flex-direction:column; margin-bottom:9px; }
    .form-row label{ font-size:12px; margin-bottom:4px; color: var(--label-color); }
    .form-row input[type="text"], .form-row input[type="date"], .form-row input[type="password"], .form-row input[type="number"], .form-row select, .form-row textarea{
      padding:7px 10px; border-radius:10px; border: 1px solid var(--card-border);
      font-size:13px; background:#f9f9ff; color: var(--text-main);
    }
    [data-theme="night"] .form-row input[type="text"],
    [data-theme="night"] .form-row input[type="date"],
    [data-theme="night"] .form-row input[type="password"],
    [data-theme="night"] .form-row input[type="number"],
    [data-theme="night"] .form-row select,
    [data-theme="night"] .form-row textarea { background:#020617; border-color:#1f2937; color:#e5e7eb; }

    .form-actions{ display:flex; justify-content:flex-end; gap:6px; margin-top:6px; }

    .list{ display:flex; flex-direction:column; gap:10px; margin-bottom:24px; }

    .list.gallery{ display:grid; grid-template-columns: 1fr; gap:12px; }
    .list.gallery .card{ flex-direction:column; align-items:stretch; }
    .list.gallery .card img{ width:100%; height:180px; object-fit:cover; }

    .card{
      background: rgba(255,255,255,0.96); border-radius:16px; padding:10px;
      display:flex; gap:10px; box-shadow: 0 6px 16px rgba(169, 177, 214, 0.35);
      align-items:flex-start; border: 1px solid var(--card-border);
      animation: cardFadeIn 0.18s ease-out; position:relative;
    }
    [data-theme="night"] .card{ background: rgba(15,23,42,0.98); box-shadow: 0 8px 22px rgba(15,23,42,0.85); }

    @keyframes cardFadeIn { from { opacity:0; transform: translateY(4px); } to { opacity:1; transform: translateY(0);} }

    .warn-badge{
  position: relative;      /* âœ… absolute -> relative */
  top:auto; left:auto;     /* âœ… í˜¹ì‹œ ë‚¨ì•„ìˆìœ¼ë©´ ë¬´ë ¥í™” */
  font-size:12px;
  padding:3px 8px;
  border-radius:999px;
  display:none;

  white-space:nowrap;      /* âœ… ì¤„ë°”ê¿ˆ ë°©ì§€ */
  max-width:100%;
  overflow:hidden;
  text-overflow:ellipsis;
}
.warn-badge.ok{
  background: rgba(120, 210, 140, 0.14);
  border: 1px solid rgba(120, 210, 140, 0.35);
  color: #1e7a3a;
}
.warn-badge.warn{
  background: rgba(255, 200, 90, 0.18);
  border: 1px solid rgba(255, 200, 90, 0.45);
  color: #8a5a00;
}
.warn-badge.danger{
  background: rgba(255, 140, 140, 0.14);
  border: 1px solid rgba(255, 140, 140, 0.35);
  color: #b12b2b;
}
.warn-badge.over{
  background: rgba(170, 110, 255, 0.14);
  border: 1px solid rgba(170, 110, 255, 0.35);
  color: #5a2bb1;
}
    [data-theme="night"] .warn-badge{
      color:#ffd2d8; background: rgba(249,115,115,0.14); border-color: rgba(249,115,115,0.28);
    }
    .warn-badge.show{ display:inline-flex; align-items:center; gap:6px; }

    .card img{
      width:70px; height:70px; object-fit:cover; border-radius:12px;
      background:#eef1ff; flex-shrink:0; cursor:pointer;
    }
    .card-content{ flex:1; font-size:13px; }
    .card-row-main{ display:flex; justify-content:space-between; gap:6px; margin-bottom:4px; align-items:center; }
    .card-title{ font-weight:600; font-size:14px; color: var(--text-main); display:inline-flex; align-items:center; gap:6px; flex-wrap:wrap; }
    .card-tag{ font-size:11px; padding:3px 7px; border-radius:999px; background: var(--chip-bg); color: var(--chip-text); align-self:flex-start; display:inline-flex; align-items:center; gap:6px; }
    .card-row{ margin-bottom:2px; color: var(--text-main); }
    .label{ color: var(--label-color); font-size:11px; margin-right:4px; }
    .card-footer{ display:flex; justify-content:space-between; align-items:center; margin-top:6px; gap:6px; flex-wrap:wrap; }
    .last-used{ font-size:11px; color: var(--text-muted); }
    .card-buttons{ display:flex; gap:4px; flex-wrap:wrap; justify-content:flex-end; }

    .empty-text{ text-align:center; color:#777; font-size:13px; margin-top:20px; }
    [data-theme="night"] .empty-text{ color:#9ca3af; }

    .toggle-group{ display:flex; gap:6px; margin-bottom:4px; flex-wrap:wrap; }
    .toggle-btn{
      padding:5px 10px; font-size:12px; border-radius:999px;
      border: 1px solid var(--card-border); background:#f5f3ff; color:#464b73; cursor:pointer;
      transition: background 0.1s ease, color 0.1s ease, border 0.1s ease;
    }
    .toggle-btn.active{ border-color: var(--primary-1); background: var(--primary-1); color:#fff; }

    /* ì ê¸ˆ í™”ë©´ */
    .lock-screen{
      position:fixed; inset:0;
      background: radial-gradient(circle at top, rgba(255,255,255,0.95), rgba(203,213,255,0.96));
      display:flex; align-items:center; justify-content:center; padding:16px;
      z-index:1000;
    }
    .lock-card{
      width:100%; max-width:320px; margin:0 auto;
      background: rgba(255,255,255,0.98); border-radius:20px; padding:16px 18px;
      box-shadow: 0 12px 28px rgba(136, 144, 195, 0.55);
      border: 1px solid #dde1ff; text-align:center;
    }
    .lock-input-wrap{ display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .lock-input-wrap input{
      flex:1; padding:10px 10px; border-radius:999px; border:1px solid #d6d9ff;
      background:#f7f7ff; text-align:center; font-size:14px; letter-spacing:3px; min-width:0;
    }

    .settings-section-title{ font-size:13px; font-weight:600; margin-bottom:4px; color:#3c4266; }
    .settings-help{ font-size:11px; color:#8a8fb0; margin-bottom:6px; line-height:1.4; }
    [data-theme="night"] .settings-section-title{ color:#e5e7eb; }
    [data-theme="night"] .settings-help{ color:#9ca3af; }

    /* ì´ë¯¸ì§€ ì „ì²´ë³´ê¸° */
    .image-viewer{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1500; }
    .image-viewer-backdrop{ position:absolute; inset:0; background: rgba(15, 23, 42, 0.75); }
    .image-viewer-inner{ position:relative; max-width:100%; max-height:100%; display:flex; align-items:center; justify-content:center; padding:16px; }
    #viewerImage{ max-width:100%; max-height:100%; border-radius:12px; box-shadow: 0 16px 40px rgba(0,0,0,0.5); touch-action:none; transition: transform 0.1s ease-out; }
    .viewer-close-btn{ position:absolute; top:16px; right:16px; border-radius:999px; border:none; padding:6px 10px; font-size:14px; cursor:pointer; background: rgba(15,23,42,0.8); color:#f9fafb; }

    /* ê¸°ê¸° ì´ë¦„ ëª¨ë‹¬ */
    .device-modal{ position:fixed; inset:0; background: rgba(15,23,42,0.35); display:none; align-items:center; justify-content:center; z-index:1200; padding:16px; }
    .device-modal-card{ background:#fff; border-radius:18px; padding:16px 18px 14px; max-width:320px; width:100%; box-shadow: 0 10px 24px rgba(0,0,0,0.25); }
    .device-modal-title{ font-size:15px; font-weight:600; margin-bottom:6px; color:#272a3f; }
    .device-modal-text{ font-size:12px; color:#767a98; margin-bottom:10px; line-height:1.45; }
    .device-modal-input{ width:100%; padding:7px 10px; border-radius:10px; border:1px solid #d6d9ff; font-size:13px; background:#f9f9ff; margin-bottom:10px; }
    .device-modal-actions{ display:flex; justify-content:flex-end; gap:6px; }

    /* í† ìŠ¤íŠ¸ */
    .toast{
      position:fixed; bottom:16px; left:50%; transform: translateX(-50%) translateY(40px);
      background: var(--toast-bg); color: var(--toast-text);
      padding:8px 14px; border-radius:999px; font-size:12px; opacity:0;
      pointer-events:none; transition: opacity 0.2s ease, transform 0.2s ease;
      z-index:2000; max-width:80%; text-align:center; white-space:nowrap; text-overflow:ellipsis; overflow:hidden;
      box-shadow: 0 10px 24px rgba(15,23,42,0.6);
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(0); }

    /* íˆìŠ¤í† ë¦¬ íƒ€ì„ë¼ì¸ */
    .history-list{ max-height:280px; overflow-y:auto; padding-right:4px; margin-top:4px; position:relative; }
    .history-list::before{
      content:""; position:absolute; left:8px; top:0; bottom:0; width:2px;
      background: linear-gradient(to bottom, rgba(148,163,184,0.6), rgba(199,210,254,0.2));
    }
    .history-row{ font-size:12px; color:#444867; padding:6px 2px 6px 20px; position:relative; }
    [data-theme="night"] .history-row{ color:#e5e7eb; }
    .history-row::before{
      content:""; position:absolute; left:4px; top:10px; width:8px; height:8px; border-radius:999px;
      background:#fff; border:2px solid var(--primary-1); box-shadow: 0 0 0 4px rgba(129,140,248,0.15);
    }
    .history-time{ color:#6b6f90; font-size:11px; }
    [data-theme="night"] .history-time{ color:#9ca3af; }
    .history-device{ color: var(--primary-1); font-size:11px; margin-left:4px; }
    .history-action-chip{ display:inline-block; margin-left:6px; padding:1px 6px; border-radius:999px; font-size:11px; background: var(--chip-bg); color: var(--chip-text); }
    .history-film{ color:#111827; font-weight:500; }
    [data-theme="night"] .history-film{ color:#e5e7eb; }
    .history-changes{ font-size:11px; color:#6b7280; margin-top:2px; }
    [data-theme="night"] .history-changes{ color:#9ca3af; }
    .history-empty{ font-size:12px; color:#6b7280; padding-left:20px; margin-top:6px; }
    [data-theme="night"] .history-empty{ color:#9ca3af; }

    /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
    .spinner-wrapper{ display:none; justify-content:center; align-items:center; padding:4px 0 16px; }
    .spinner-wrapper.show{ display:flex; }
    .spinner-circle{
      width:28px; height:28px; border-radius:999px;
      border:3px solid var(--spinner-border);
      border-top-color: var(--primary-1);
      box-shadow: 0 0 12px var(--spinner-glow);
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    /* ë§¨ ìœ„ë¡œ ë²„íŠ¼ */
    .scroll-top-btn{
      position:fixed; right:16px; bottom:24px;
      width:36px; height:36px; border-radius:999px; border:none;
      font-size:18px; cursor:pointer;
      background: linear-gradient(135deg, var(--primary-1), var(--primary-2));
      color:#fff; display:none; align-items:center; justify-content:center;
      box-shadow: 0 10px 24px rgba(107,114,128,0.6);
      z-index:1900;
    }
    .scroll-top-btn.show{ display:flex; }

    @media (min-width: 768px){ body{ padding-top:24px; } }
    @media (min-width: 600px){ .list.gallery{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (min-width: 1024px){
      .app-shell, .app-header{ max-width:1080px; }
      .list.gallery{ grid-template-columns: repeat(3, minmax(260px, 1fr)); }
    }

    /* ====== ë©”ëª¨: ë°”í…€ì‹œíŠ¸ ====== */
    .memo-sheet{ position:fixed; inset:0; display:none; align-items:flex-end; justify-content:center; z-index:1600; }
    .memo-sheet.show{ display:flex; }
    .memo-sheet-backdrop{ position:absolute; inset:0; background: rgba(15, 23, 42, 0.45); }
    .memo-sheet-panel{
      position:relative; width:100%; max-width:720px;
      background: var(--card-bg); border:1px solid var(--card-border);
      border-radius:18px 18px 0 0; box-shadow: 0 -12px 28px rgba(0,0,0,0.25);
      padding:12px 14px 14px; animation: sheetUp 0.16s ease-out;
    }
    @keyframes sheetUp{ from{ transform: translateY(14px); opacity:0; } to{ transform: translateY(0); opacity:1; } }
    .memo-sheet-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .memo-sheet-title{ font-size:14px; font-weight:700; color: var(--text-main); }
    .memo-sheet-sub{ font-size:11px; color: var(--text-sub); margin-top:2px; }
    .memo-sheet-textarea{
      width:100%; min-height:120px; resize:vertical; padding:10px;
      border-radius:12px; border:1px solid var(--card-border);
      background:#f9f9ff; color: var(--text-main); font-size:13px; line-height:1.45;
    }
    [data-theme="night"] .memo-sheet-textarea{ background:#020617; border-color:#1f2937; color:#e5e7eb; }
    .memo-sheet-actions{ display:flex; justify-content:flex-end; gap:6px; margin-top:10px; }
    .btn-memo-has{ box-shadow: 0 0 0 2px rgba(127,157,255,0.18) inset; }

    /* ====== íˆìŠ¤í† ë¦¬: ì—°í•„ ë²„íŠ¼ + ë…¸íŠ¸ ====== */
    .history-headline{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .history-pencil{ border:none; cursor:pointer; padding:4px 8px; border-radius:999px; font-size:12px; background: var(--primary-soft); color: var(--text-main); }
    [data-theme="night"] .history-pencil{ color:#e5e7eb; }
    .history-note{
      margin-top:6px; padding:8px 10px; border-radius:12px; border:1px solid var(--card-border);
      background: rgba(228,231,255,0.65); font-size:12px; color: var(--text-main);
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
    }
    [data-theme="night"] .history-note{ background: rgba(79,70,229,0.18); border-color:#1f2937; }

    /* ====== íˆìŠ¤í† ë¦¬ ë©”ëª¨ ëª¨ë‹¬ ====== */
    .note-modal{ position:fixed; inset:0; background: rgba(15,23,42,0.35); display:none; align-items:center; justify-content:center; z-index:1700; padding:16px; }
    .note-modal.show{ display:flex; }
    .note-modal-card{ background: var(--card-bg); border:1px solid var(--card-border); border-radius:18px; padding:16px 18px 14px; max-width:380px; width:100%; box-shadow: 0 10px 24px rgba(0,0,0,0.25); }
    .note-modal-title{ font-size:15px; font-weight:700; margin-bottom:6px; color: var(--text-main); }
    .note-modal-text{ font-size:12px; color: var(--text-sub); margin-bottom:10px; }
    .note-modal-textarea{
      width:100%; min-height:120px; resize:vertical; padding:10px;
      border-radius:12px; border:1px solid var(--card-border);
      background:#f9f9ff; color: var(--text-main); font-size:13px; line-height:1.45;
    }
    [data-theme="night"] .note-modal-textarea{ background:#020617; border-color:#1f2937; color:#e5e7eb; }
    .note-modal-actions{ display:flex; justify-content:flex-end; gap:6px; margin-top:10px; }

    /* ====== íŒ ì‚¬ìš©/íˆìŠ¤í† ë¦¬ ì‹œíŠ¸ ====== */
    .sheet{ position:fixed; inset:0; display:none; align-items:flex-end; justify-content:center; z-index:1650; }
    .sheet.show{ display:flex; }
    .sheet-backdrop{ position:absolute; inset:0; background: rgba(15,23,42,0.45); }
    .sheet-panel{
      position:relative; width:100%; max-width:720px;
      background: var(--card-bg); border:1px solid var(--card-border);
      border-radius:18px 18px 0 0; box-shadow: 0 -12px 28px rgba(0,0,0,0.25);
      padding:12px 14px 14px; animation: sheetUp 0.16s ease-out;
    }
    .sheet-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .sheet-title{ font-size:14px; font-weight:700; color: var(--text-main); }
    .sheet-sub{ font-size:11px; color: var(--text-sub); margin-top:2px; }
    .sheet-actions{ display:flex; justify-content:flex-end; gap:6px; margin-top:10px; }

    .usage-meta{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
    .usage-chip{
      font-size:11px; padding:4px 10px; border-radius:999px;
      background: var(--chip-bg); color: var(--chip-text);
      border:1px solid rgba(0,0,0,0.03);
      display:inline-flex; align-items:center; gap:6px;
    }
    .progress-pill{
      font-size:11px; padding:3px 8px; border-radius:999px;
      border:1px solid var(--card-border); background: rgba(255,255,255,0.6);
      color: var(--text-main); display:inline-flex; align-items:center; gap:6px;
    }
    [data-theme="night"] .progress-pill{ background: rgba(2,6,23,0.55); border-color:#1f2937; color:#e5e7eb; }

    .usage-list{
      max-height:300px; overflow-y:auto; padding-right:4px; margin-top:8px;
      border-top: 1px dashed rgba(148,163,184,0.45); padding-top:10px;
    }
    .usage-row{
      font-size:12px; padding:8px 10px; border:1px solid var(--card-border);
      border-radius:12px; margin-bottom:8px; background: rgba(255,255,255,0.65);
    }
    [data-theme="night"] .usage-row{ background: rgba(2,6,23,0.45); border-color:#1f2937; }
    .usage-row .u-top{ display:flex; justify-content:space-between; gap:8px; align-items:baseline; flex-wrap:wrap; }
    .usage-row .u-time{ font-size:11px; color: var(--text-muted); }
    .usage-row .u-who{ font-weight:600; color: var(--text-main); }
    .usage-row .u-qty{ font-weight:700; color: var(--primary-1); }
    .usage-row .u-memo{ margin-top:6px; color: var(--text-main); opacity:0.9; }
   
 /* [ìˆ˜ì •] ì´ë¯¸ì§€ ì „ì²´ë³´ê¸° (ì¤Œ/ì´ë™ ê¸°ëŠ¥ ì¶”ê°€) */
    .image-viewer{ 
      position:fixed; inset:0; display:none; 
      align-items:center; justify-content:center; 
      z-index:1500; overflow:hidden; 
    }
    .image-viewer-backdrop{ position:absolute; inset:0; background: rgba(0, 0, 0, 0.85); }
    
    /* [ìˆ˜ì •] ì´ë¯¸ì§€ ë·°ì–´ ì»¨í…Œì´ë„ˆ */
.image-viewer-container {
  position: relative;
  width: 100%; height: 100%;
  display: flex; align-items: center; justify-content: center;
  overflow: hidden; 
  /* í„°ì¹˜ ë™ì‘ì´ ë¸Œë¼ìš°ì € ìŠ¤í¬ë¡¤ë¡œ ê°€ì§€ ì•Šë„ë¡ ë°©ì§€ */
  touch-action: none; 
}

/* [ìˆ˜ì •] ì´ë¯¸ì§€ ìì²´ */
#viewerImage { 
  max-width: 100%; max-height: 100%; 
  object-fit: contain; 
  
  /* ì¤Œ/ì´ë™ì˜ ê¸°ì¤€ì ì„ ì¤‘ì•™ìœ¼ë¡œ ì„¤ì • */
  transform-origin: center center;
  
  /* ì„±ëŠ¥ ìµœì í™” */
  will-change: transform;
  
  /* ë“œë˜ê·¸ ì‹œ ë§ˆìš°ìŠ¤ ì»¤ì„œ ë³€ê²½ */
  cursor: grab;
}
#viewerImage:active { cursor: grabbing; }

    /* í•˜ë‹¨ ì¤Œ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ */
    .viewer-controls {
      position: absolute; bottom: 30px; left: 50%;
      transform: translateX(-50%);
      display: flex; align-items: center; gap: 8px;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(4px);
      padding: 8px 16px; border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      z-index: 1510;
    }
    .viewer-controls button {
      background: rgba(255,255,255,0.9);
      color: #333; font-weight:bold;
      width: 32px; height: 32px; padding:0; 
      border:none; border-radius:50%; cursor:pointer;
      display:flex; align-items:center; justify-content:center;
    }
    
    /* ë‹«ê¸° ë²„íŠ¼ */
    .viewer-close-btn{ 
      position:absolute; top:20px; right:20px; 
      border-radius:999px; border:none; width:36px; height:36px;
      font-size:18px; cursor:pointer; 
      background: rgba(255,255,255,0.2); color:#fff; 
      z-index:1520; display:flex; align-items:center; justify-content:center;
    }
	/* [ì¶”ê°€] ëŒ€ì‹œë³´ë“œ ìŠ¤íƒ€ì¼ */
    .dashboard-wrap { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 12px; animation: cardFadeIn 0.3s ease; }
    /* [ìˆ˜ì •] ëŒ€ì‹œë³´ë“œ ì¹´ë“œ: í´ë¦­ ê°€ëŠ¥í•˜ê²Œ ë³€ê²½ */
    .dash-card { 
      background: rgba(255,255,255,0.8); 
      border: 1px solid var(--card-border); 
      border-radius: 12px; 
      padding: 10px; 
      text-align: center; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.03); 
      cursor: pointer; /* ì†ê°€ë½ ëª¨ì–‘ */
      transition: all 0.2s ease;
    }
    /* ì„ íƒë˜ì—ˆì„ ë•Œ íš¨ê³¼ */
    .dash-card.selected {
      border: 2px solid var(--primary-1);
      background: #fff;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(127,157,255,0.4);
    }
    /* ë‚˜ì´íŠ¸ ëª¨ë“œ ëŒ€ì‘ */
    [data-theme="night"] .dash-card.selected {
      background: rgba(30,41,59,1);
      border-color: var(--primary-1);
    }
    .dash-card.warning { background: #fff0f0; border-color: #ffcccc; }
    .dash-card.warning .dash-value { color: #d32f2f; }
    .dash-title { font-size: 11px; color: var(--text-sub); margin-bottom: 4px; }
    .dash-value { font-size: 20px; font-weight: 800; color: var(--text-main); }
    .dash-desc { font-size: 10px; color: var(--text-muted); margin-top: 2px; }
    
    [data-theme="night"] .dash-card { background: rgba(30,41,59,0.8); }
    [data-theme="night"] .dash-card.warning { background: rgba(69, 10, 10, 0.5); border-color: #7f1d1d; }
    [data-theme="night"] .dash-card.warning .dash-value { color: #fca5a5; }


  </style>

 <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>
  <!-- ì ê¸ˆ í™”ë©´ (íŒíŠ¸/ë¬¸êµ¬/ì„¤ëª… ì—†ìŒ) -->
  <div id="lockScreen" class="lock-screen">
    <div class="lock-card">
      <div class="lock-input-wrap">
        <input type="password" id="passwordInput" maxlength="20" />
        <button class="btn btn-primary btn-small" id="passwordBtn">ì…ì¥</button>
      </div>
    </div>
  </div>

  <!-- ê¸°ê¸° ì´ë¦„ ìµœì´ˆ ì…ë ¥ ëª¨ë‹¬ -->
  <div id="deviceModal" class="device-modal">
    <div class="device-modal-card">
      <div class="device-modal-title">ì´ ê¸°ê¸° ì´ë¦„ ì •í•˜ê¸°</div>
      <div class="device-modal-text">
        ì˜ˆ: ê°€ì€í°, ì„±ê·œíŒ¨ë“œ, íšŒì‚¬PC<br />
        (ê¸°ê¸° ì´ë¦„ì€ ì´ ê¸°ê¸°ì—ì„œë§Œ í‘œì‹œë¼)
      </div>
      <input id="deviceModalInput" class="device-modal-input" type="text" placeholder="ì˜ˆ: ê°€ì€í°" />
      <div class="device-modal-actions">
        <button class="btn btn-secondary btn-small" id="deviceModalSkip">ë‚˜ì¤‘ì—</button>
        <button class="btn btn-primary btn-small" id="deviceModalSave">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ì´ë¯¸ì§€ ì „ì²´ë³´ê¸° -->
    <div id="imageViewer" class="image-viewer">
    <div class="image-viewer-backdrop" id="viewerBackdrop"></div>
    
    <div class="image-viewer-container" id="viewerContainer">
      <img id="viewerImage" src="" alt="ì´ë¯¸ì§€" />
    </div>

    <div class="viewer-controls">
      <button class="btn btn-secondary btn-small" id="btnZoomOut">ï¼</button>
      <span id="zoomLevelDisplay" style="font-size:12px; color:#fff; font-weight:600; min-width:40px; text-align:center;">100%</span>
      <button class="btn btn-secondary btn-small" id="btnZoomIn">ï¼‹</button>
      <button class="btn btn-secondary btn-small" id="btnZoomReset" style="margin-left:8px;">ì´ˆê¸°í™”</button>
    </div>

    <button id="closeViewerBtn" class="viewer-close-btn">âœ•</button>
  </div>


  <!-- í† ìŠ¤íŠ¸ -->
  <div id="toast" class="toast"></div>
  
  <div id="emptyPlateModal" class="device-modal">
  <div class="device-modal-card" style="max-width:400px">
    <div class="device-modal-title">ë¹ˆ íŒ ê°€ì ¸ì˜¤ê¸°</div>
    <div class="device-modal-text">í˜„ì¬ ëŒ€ê¸° ì¤‘ì¸ ë¹ˆ íŒ ëª©ë¡ì´ì•¼. ì‚¬ìš©í•  íŒì„ ì„ íƒí•´.</div>
    
    <div id="emptyPlateList" style="max-height:200px; overflow-y:auto; margin-bottom:10px; border:1px solid #eee; border-radius:8px; padding:4px;">
      </div>

    <div class="device-modal-actions" style="justify-content:space-between">
      <button class="btn btn-secondary btn-small" id="btnMakeNewPlate">â• ìƒˆ íŒ ë§Œë“¤ê¸°</button>
      <button class="btn btn-ghost btn-small" onclick="document.getElementById('emptyPlateModal').style.display='none'">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<div id="reuseModal" class="device-modal">
  <div class="device-modal-card">
    <div class="device-modal-title">ì¬ì‚¬ìš© ì„¤ì •</div>
    <div class="device-modal-text" id="reuseModalTitle">-</div>
    
    <div class="form-row">
      <label>ìƒˆë¡œ ì° í…ì…˜</label>
      <input type="text" id="reuseTension" placeholder="ì˜ˆ: 23.5">
    </div>
    <div class="form-row">
      <label>ì´ë²ˆ ì‘ì—… ìµœëŒ€ìˆ˜ëŸ‰</label>
      <input type="number" id="reuseMaxQty" value="5000">
    </div>

    <div class="device-modal-actions">
      <button class="btn btn-secondary btn-small" onclick="document.getElementById('reuseModal').style.display='none'">ì·¨ì†Œ</button>
      <button class="btn btn-primary btn-small" id="btnConfirmReuse">í™•ì¸</button>
    </div>
  </div>
</div>

  <!-- ====== í•„ë¦„ ë©”ëª¨ ìŠ¬ë¼ì´ë“œ ====== -->
  <div id="memoSheet" class="memo-sheet">
    <div id="memoSheetBackdrop" class="memo-sheet-backdrop"></div>
    <div class="memo-sheet-panel">
      <div class="memo-sheet-head">
        <div>
          <div class="memo-sheet-title" id="memoSheetTitle">ë©”ëª¨</div>
          <div class="memo-sheet-sub" id="memoSheetSub">í•„ë¦„ë³„ ë©”ëª¨</div>
        </div>
        <button class="btn btn-secondary btn-small" id="memoSheetCloseBtn">ë‹«ê¸°</button>
      </div>
      <textarea id="memoTextarea" class="memo-sheet-textarea" placeholder="ì˜ˆ: í…ì…˜ 23 ì´í•˜ì—ì„œ ë²ˆì§ / ìš°ì¸¡ 2mm ë°€ë¦¼ ì£¼ì˜"></textarea>
      <div class="memo-sheet-actions">
        <button class="btn btn-secondary btn-small" id="memoSheetCancelBtn">ì·¨ì†Œ</button>
        <button class="btn btn-primary btn-small" id="memoSheetSaveBtn">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ====== íŒ ë©”ëª¨ ìŠ¬ë¼ì´ë“œ ====== -->
  <div id="plateMemoSheet" class="memo-sheet">
    <div id="plateMemoBackdrop" class="memo-sheet-backdrop"></div>
    <div class="memo-sheet-panel">
      <div class="memo-sheet-head">
        <div>
          <div class="memo-sheet-title" id="plateMemoTitle">íŒ ë©”ëª¨</div>
          <div class="memo-sheet-sub" id="plateMemoSub">íŒë³„ ë©”ëª¨</div>
        </div>
        <button class="btn btn-secondary btn-small" id="plateMemoCloseBtn">ë‹«ê¸°</button>
      </div>
      <textarea id="plateMemoTextarea" class="memo-sheet-textarea" placeholder="ì˜ˆ: 3êµ¬ì—­ ëŠ˜ì–´ì§ / ì¢Œì¸¡ 1mm ë°€ë¦¼"></textarea>
      <div class="memo-sheet-actions">
        <button class="btn btn-secondary btn-small" id="plateMemoCancelBtn">ì·¨ì†Œ</button>
        <button class="btn btn-primary btn-small" id="plateMemoSaveBtn">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ====== íŒ ì‚¬ìš© ë“±ë¡ ì‹œíŠ¸ ====== -->
  <div id="plateUseSheet" class="sheet">
    <div id="plateUseBackdrop" class="sheet-backdrop"></div>
    <div class="sheet-panel">
      <div class="sheet-head">
        <div>
          <div class="sheet-title" id="plateUseTitle">íŒ ì‚¬ìš©ë“±ë¡</div>
          <div class="sheet-sub" id="plateUseSub">ì‹œê°„ì€ ìë™ ê¸°ë¡</div>
        </div>
        <button class="btn btn-secondary btn-small" id="plateUseCloseBtn">ë‹«ê¸°</button>
      </div>

      <div class="usage-meta" id="plateUseMeta"></div>

      <div class="form-row">
        <label for="plateUseWho">ì¸ì‡„ê¸°ì‚¬</label>
        <select id="plateUseWho"></select>
      </div>
      <div class="form-row">
        <label for="plateUseQty">ì¸ì‡„ ìˆ˜ëŸ‰</label>
        <input type="number" id="plateUseQty" min="1" step="1" />
        <small style="font-size:11px; color:var(--text-sub); margin-top:6px;">
          íŒ ê¸°ë³¸ ìµœëŒ€ ì‚¬ìš© ìˆ˜ëŸ‰ì€ 5000 (í•„ìš” ì‹œ ê´€ë¦¬ìë§Œ ìˆ˜ì •)
        </small>
      </div>
      <div class="form-row">
        <label for="plateUseMemo">ë©”ëª¨</label>
        <textarea id="plateUseMemo" rows="3" placeholder="ì˜ˆ: 2mm ë°€ë¦¼ ì¡ìŒ / í…ì…˜ 24"></textarea>
      </div>

      <div class="sheet-actions">
        <button class="btn btn-secondary btn-small" id="plateUseCancelBtn">ì·¨ì†Œ</button>
        <button class="btn btn-primary btn-small" id="plateUseSaveBtn">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ====== íŒ íˆìŠ¤í† ë¦¬ ì‹œíŠ¸ ====== -->
  <div id="plateHistorySheet" class="sheet">
    <div id="plateHistoryBackdrop" class="sheet-backdrop"></div>
    <div class="sheet-panel">
      <div class="sheet-head">
        <div>
          <div class="sheet-title" id="plateHistoryTitle">íŒ íˆìŠ¤í† ë¦¬</div>
          <div class="sheet-sub" id="plateHistorySub">ì–¸ì œ / ëˆ„ê°€ / ëª‡ ê°œ / ë©”ëª¨</div>
        </div>
        <button class="btn btn-secondary btn-small" id="plateHistoryCloseBtn">ë‹«ê¸°</button>
      </div>

      <div class="usage-meta" id="plateHistoryMeta"></div>

    <div id="plateUsageList" class="usage-list"></div>
      <div class="sheet-actions">
        <button class="btn btn-secondary btn-small" id="plateHistoryCloseBtn2">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ====== íˆìŠ¤í† ë¦¬ ë©”ëª¨ ëª¨ë‹¬ ====== -->
  <div id="historyNoteModal" class="note-modal">
    <div class="note-modal-card">
      <div class="note-modal-title">íˆìŠ¤í† ë¦¬ ë©”ëª¨</div>
      <div class="note-modal-text">ì´ ë³€ê²½ ê¸°ë¡ì— â€œì™œ ë°”ë€Œì—ˆëŠ”ì§€â€ë¥¼ ì ì–´ë‘˜ ìˆ˜ ìˆì–´.</div>
      <textarea id="historyNoteTextarea" class="note-modal-textarea" placeholder="ì˜ˆ: ê²¹ì¹¨ ì´ìŠˆë¡œ 4-2-1.6ë²ˆìœ¼ë¡œ ì´ë™"></textarea>
      <div class="note-modal-actions">
        <button class="btn btn-secondary btn-small" id="historyNoteCancelBtn">ì·¨ì†Œ</button>
        <button class="btn btn-primary btn-small" id="historyNoteSaveBtn">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ì‹¤ì œ ì•± -->
  <div id="appContainer" style="display:none;">
    <div class="app-header">
      <div class="title-wrap">
        <div class="app-title">FILM FIND</div>
        <div class="app-subtitle" id="subtitleText">í•„ë¦„/íŒ ê´€ë¦¬</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <div id="modeChip" class="mode-chip">
          <span class="mode-dot"></span>
          <span id="modeChipText">-</span>
        </div>
        <div id="deviceBadge" class="device-badge">
          <span class="device-dot"></span>
          <span id="deviceBadgeText"></span>
        </div>
      </div>
    </div>

    <div class="app-shell">
	<div id="dashboardSection" class="dashboard-wrap" style="display:none;">
      <div class="dash-card" id="cardActive" onclick="filterByDash('active')">
        <div class="dash-title">í™œì„± íŒ</div>
        <div class="dash-value" id="dashActive">-</div>
        <div class="dash-desc">í˜„ì¬ ì‘ì—… ì¤‘</div>
      </div>
      
      <div class="dash-card" id="cardEmpty" onclick="filterByDash('empty')">
        <div class="dash-title">ë¹ˆ íŒ (ëŒ€ê¸°)</div>
        <div class="dash-value" id="dashEmpty">-</div>
        <div class="dash-desc">ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥</div>
      </div>
      
      <div class="dash-card warning" id="cardWarn" onclick="filterByDash('warn')">
        <div class="dash-title">ìˆ˜ëª… ì£¼ì˜</div>
        <div class="dash-value" id="dashWarn">-</div>
        <div class="dash-desc">90% ì´ìƒ ì‚¬ìš©</div>
      </div>
    </div>

      <div class="top-bar">
        <input type="text" id="searchInput" placeholder="ê²€ìƒ‰" />
        <button class="btn btn-primary" id="newFilmBtn">+ ìƒˆ í•„ë¦„</button>
      </div>

      <!-- íƒ­ -->
      <div class="tabbar">
        <button class="tab-btn active" id="tabFilmsBtn">í•„ë¦„</button>
        <button class="tab-btn" id="tabPlatesBtn">íŒ</button>
      </div>

      <div class="tools-bar">
        <button class="btn btn-secondary btn-small" id="settingsBtn">âš™ ì„¤ì •</button>
        <button class="btn btn-secondary btn-small" id="historyBtn">ğŸ“œ íˆìŠ¤í† ë¦¬</button>
        <button class="btn btn-secondary btn-small" id="exportBtn">ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
        <button class="btn btn-secondary btn-small" id="importBtn">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <input type="file" id="importFile" accept="application/json" style="display:none;" />
      </div>

      <div class="count-wrap">
        <div id="countBar" class="count-bar">-</div>
        <button class="btn btn-secondary btn-small" id="viewToggleBtn">ê°¤ëŸ¬ë¦¬</button>
      </div>

      <!-- ì„¤ì • ì¹´ë“œ -->
      <div class="form-card" id="settingsCard" style="display:none;">
        <div class="form-row">
          <div class="settings-section-title">ì´ ê¸°ê¸° ì´ë¦„</div>
          <div class="settings-help">ì˜ˆ: ê°€ì€í°, ì„±ê·œíŒ¨ë“œ, íšŒì‚¬PC. ì´ ê¸°ê¸°ì—ì„œë§Œ í‘œì‹œë¼.</div>
          <input type="text" id="deviceNameInput" placeholder="ê¸°ê¸° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" />
        </div>

        <div class="form-row">
          <div class="settings-section-title">ê¸°ë³¸ ì •ë ¬ ë°©ì‹</div>
          <div class="settings-help">ë¦¬ìŠ¤íŠ¸ë¥¼ ì–´ë–¤ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í• ì§€ ì„ íƒí•´.</div>
          <select id="sortOptionSelect">
            <option value="updated">ìµœê·¼ ìˆ˜ì •ìˆœ</option>
            <option value="name">ì œí’ˆëª… ê°€ë‚˜ë‹¤ìˆœ</option>
            <option value="number">í•„ë¦„ë²ˆí˜¸ ìˆœ</option>
            <option value="lastUsed">ë§ˆì§€ë§‰ ì‚¬ìš©ì¼ ìµœì‹ ìˆœ</option>
          </select>
        </div>

        <div class="form-row">
          <div class="settings-section-title">í…Œë§ˆ ìƒ‰ìƒ</div>
          <div class="settings-help">ì•±ì˜ ìƒ‰ ë¶„ìœ„ê¸°ë¥¼ ì„ íƒí•´ ì¤˜.</div>
          <select id="themeSelect">
            <option value="default">ë¼ë²¤ë”</option>
            <option value="mint">ë¯¼íŠ¸</option>
            <option value="peach">í”¼ì¹˜</option>
            <option value="night">ë‚˜ì´íŠ¸</option>
          </select>
        </div>

        <!-- âœ… ê´€ë¦¬ì: ì¸ì‡„ê¸°ì‚¬ ëª©ë¡ ê´€ë¦¬(íŒŒì´ì–´ë² ì´ìŠ¤ ê³µìœ ) -->
        <div class="form-row" id="printerListSection" style="display:none;">
          <div class="settings-section-title">ì¸ì‡„ê¸°ì‚¬ ëª©ë¡ ê´€ë¦¬</div>
          <div class="settings-help">íŒ ì‚¬ìš©ë“±ë¡ì—ì„œ ì„ íƒë˜ëŠ” ëª©ë¡ì´ì•¼. (ì¶”ê°€/ì‚­ì œí•˜ë©´ ëª¨ë“  ê¸°ê¸°ì— ë™ê¸°í™”)</div>
          <div style="display:flex; gap:8px;">
            <input type="text" id="printerNameNew" placeholder="ì˜ˆ: ìµœì„±ê·œ" style="flex:1;">
            <button class="btn btn-primary btn-small" id="addPrinterBtn" type="button">ì¶”ê°€</button>
          </div>
          <div id="printerListWrap" style="margin-top:10px; display:flex; gap:6px; flex-wrap:wrap;"></div>
        </div>

        <!-- ê´€ë¦¬ìë§Œ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ê°€ëŠ¥ -->
        <div class="form-row" id="pwSection" style="display:none;">
          <div class="settings-section-title">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</div>
          <div class="settings-help">
            ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ / ì¸ì‡„ê¸°ì‚¬ ë¹„ë°€ë²ˆí˜¸ / ì¡°íšŒ ë¹„ë°€ë²ˆí˜¸
          </div>
          <input type="password" id="pwAdminNew" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸" />
          <input type="password" id="pwPrinterNew" placeholder="ì¸ì‡„ê¸°ì‚¬ ë¹„ë°€ë²ˆí˜¸" style="margin-top:6px;" />
          <input type="password" id="pwViewerNew" placeholder="ì¡°íšŒ ë¹„ë°€ë²ˆí˜¸" style="margin-top:6px;" />
          <input type="password" id="pwAdminCurrent" placeholder="í˜„ì¬ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸" style="margin-top:10px;" />
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary btn-small" id="closeSettingsBtn">ë‹«ê¸°</button>
          <button type="button" class="btn btn-primary btn-small" id="saveSettingsBtn">ì €ì¥</button>
        </div>
      </div>

      <!-- íˆìŠ¤í† ë¦¬ ì¹´ë“œ (ì‚­ì œ ê¸ˆì§€) -->
      <div class="form-card" id="historyCard" style="display:none;">
        <div class="settings-section-title">ğŸ“œ íˆìŠ¤í† ë¦¬</div>
        <div class="settings-help">
          ë“±ë¡ / ìˆ˜ì • / ì‚­ì œ / ì˜¤ëŠ˜ ì‚¬ìš© ê¸°ë¡ì„ ìµœê·¼ 100ê°œê¹Œì§€ ë³´ì—¬ì¤„ê²Œ.<br>
          (ê¸°ê¸° ì´ë¦„ê³¼ ì–´ë–¤ í•­ëª©ì´ ë°”ë€Œì—ˆëŠ”ì§€ë„ ê°™ì´ í‘œì‹œë¼.)
        </div>
        <div id="historyList" class="history-list"></div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary btn-small" id="closeHistoryBtn">ë‹«ê¸°</button>
        </div>
      </div>

      <!-- ====== í•„ë¦„ ì…ë ¥ í¼ ====== -->
      <div class="form-card" id="formCard" style="display:none;">
        <form id="filmForm">
          <input type="hidden" id="filmId" />
          <div class="form-row">
            <label for="productName">ì œí’ˆ ì´ë¦„ *</label>
            <input type="text" id="productName" required />
          </div>
          <div class="form-row">
            <label for="filmNumber">í•„ë¦„ ë²ˆí˜¸ *</label>
            <input type="text" id="filmNumber" required />
          </div>
          <div class="form-row">
            <label for="method">ì œíŒ íƒ€ì…</label>
            <input type="text" id="method" placeholder="ì˜ˆ: ë°”íƒ•, ë¬¸ì, ìŠ¤ëª¨ê·¸ ë“±" />
          </div>

          <div class="form-row">
            <label for="mesh">MESH</label>
            <input type="text" id="mesh" placeholder="ì˜ˆ: 180T, 200ë©”ì‰¬ ë“±" />
          </div>

          <div class="form-row">
            <label>í•„ë¦„ ì œíŒ ë°©ë²•</label>
            <div class="toggle-group" data-group="frontBack">
              <button type="button" class="toggle-btn" data-value="ì „ë©´">ì „ë©´</button>
              <button type="button" class="toggle-btn" data-value="ë°°ë©´">ë°°ë©´</button>
            </div>
            <div class="toggle-group" data-group="leftRight">
              <button type="button" class="toggle-btn" data-value="ì¢Œ">ì¢Œ</button>
              <button type="button" class="toggle-btn" data-value="ìš°">ìš°</button>
            </div>
            <div class="toggle-group" data-group="upDown">
              <button type="button" class="toggle-btn" data-value="ìƒ">ìƒ</button>
              <button type="button" class="toggle-btn" data-value="í•˜">í•˜</button>
            </div>
            <small style="font-size:11px; color:var(--text-sub);">
              ì „ë©´/ë°°ë©´ + ì¢Œ/ìš° + ìƒ/í•˜ ì¡°í•© (ì˜ˆ: ë°°ë©´ ì¢Œìƒ, ì „ë©´ ìš°í•˜ ë“±)
            </small>
          </div>

          <div class="form-row">
            <label for="location">í•„ë¦„ ìœ„ì¹˜</label>
            <input type="text" id="location" placeholder="ì˜ˆ: A-3 ì„œë, 4ì¸µ ìš°ì¸¡ ë™ ë“±" />
          </div>

          <div class="form-row">
            <label for="requestPrinter">ìš”ì²­ ì¸ì‡„ì</label>
            <select id="requestPrinter">
              <option value="">ì„ íƒ ì•ˆ í•¨</option>
              <option value="ì´ì°½ë¯¼ ë¶€ì¥ë‹˜">ì´ì°½ë¯¼ ë¶€ì¥ë‹˜</option>
              <option value="ê³ ê´‘ìš´ ê³¼ì¥ë‹˜">ê³ ê´‘ìš´ ê³¼ì¥ë‹˜</option>
              <option value="ê¹€ê·œí—Œ ì°¨ì¥ë‹˜">ê¹€ê·œí—Œ ì°¨ì¥ë‹˜</option>
              <option value="ë°•ì¬í˜„ ëŒ€ë¦¬ë‹˜">ë°•ì¬í˜„ ëŒ€ë¦¬ë‹˜</option>
              <option value="ì¡°ì˜ë¹ˆ ëŒ€ë¦¬ë‹˜">ì¡°ì˜ë¹ˆ ëŒ€ë¦¬ë‹˜</option>
              <option value="ê¹€í˜„ê·œ ëŒ€ë¦¬ë‹˜">ê¹€í˜„ê·œ ëŒ€ë¦¬ë‹˜</option>
              <option value="ì¥ì§„ìš° ëŒ€ë¦¬ë‹˜">ì¥ì§„ìš° ëŒ€ë¦¬ë‹˜</option>
              <option value="ê¹€ë¯¸ì€ ì£¼ì„ë‹˜">ê¹€ë¯¸ì€ ì£¼ì„ë‹˜</option>
              <option value="ì´ìˆ˜ì•ˆ ì‚¬ì›ë‹˜">ì´ìˆ˜ì•ˆ ì‚¬ì›ë‹˜</option>
              <option value="ë°•ì§€ì•ˆ ì‚¬ì›ë‹˜">ë°•ì§€ì•ˆ ì‚¬ì›ë‹˜</option>
              <option value="ê¹€ì¸ì„  ì‚¬ì›ë‹˜">ê¹€ì¸ì„  ì‚¬ì›ë‹˜</option>
              <option value="ê¹€ìš©ì› ì‚¬ì›ë‹˜">ê¹€ìš©ì› ì‚¬ì›ë‹˜</option>
              <option value="ìµœì„±ê·œ ì‚¬ì›ë‹˜">ìµœì„±ê·œ ì‚¬ì›ë‹˜</option>
            </select>
          </div>

          <div class="form-row">
            <label for="lastUsed">ë§ˆì§€ë§‰ ì‚¬ìš©ì¼</label>
            <div style="display:flex; gap:6px;">
              <input type="date" id="lastUsed" style="flex:1;" />
              <button type="button" class="btn btn-secondary btn-small" id="setTodayBtn">ì˜¤ëŠ˜</button>
            </div>
          </div>

          <div class="form-row">
            <label for="imageInput">í•„ë¦„ ì‚¬ì§„ (ì„ íƒ)</label>
            <input type="file" id="imageInput" accept="image/*" />
            <small style="font-size:11px; color:var(--text-sub);">
              Â· ìƒˆ í•„ë¦„ì—ëŠ” ì‚¬ì§„ì„ ì¶”ê°€í•˜ê³ ,<br/>
              Â· ìˆ˜ì • ì‹œ ì‚¬ì§„ì„ ë°”ê¾¸ê³  ì‹¶ì„ ë•Œë§Œ ë‹¤ì‹œ ì„ íƒí•˜ì„¸ìš”.</small>

            <div id="imagePreviewWrapper" style="margin-top:8px; display:none; align-items:center; gap:6px;">
              <img id="imagePreview" alt="ë¯¸ë¦¬ë³´ê¸°"
                   style="width:70px; height:70px; border-radius:10px; object-fit:cover; background:#eef1ff;" />
              <button type="button" class="btn btn-secondary btn-small" id="rotateLeftBtn">âŸ² 90Â°</button>
              <button type="button" class="btn btn-secondary btn-small" id="rotateRightBtn">âŸ³ 90Â°</button>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="cancelBtn">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn-primary" id="saveBtn">ì €ì¥</button>
          </div>
        </form>
      </div>

      <!-- ====== íŒ ì…ë ¥ í¼ ====== -->
      <div class="form-card" id="plateFormCard" style="display:none;">
        <form id="plateForm">
          <input type="hidden" id="plateId" />
          <input type="hidden" id="plateFilmId" />
          <div class="settings-section-title">íŒ ë“±ë¡/ìˆ˜ì •</div>
          <div class="settings-help">í•„ë¦„ì—ì„œ ìƒì†ëœ ì •ë³´ëŠ” ìë™ ì…ë ¥ë¨ (ì‚¬ì§„/ì œí’ˆëª…/í•„ë¦„ë²ˆí˜¸/ë©”ì‰¬)</div>

          <div class="form-row">
            <label>ì œí’ˆ ì´ë¦„</label>
            <input type="text" id="plateProductName" readonly />
          </div>
          <div class="form-row">
            <label>í•„ë¦„ ë²ˆí˜¸</label>
            <input type="text" id="plateFilmNumber" readonly />
          </div>

          <div class="form-row">
            <label>íŒ ë²ˆí˜¸ *</label>
            <input type="text" id="plateNumber" required />
            <small style="font-size:11px; color:var(--text-sub); margin-top:6px;">
              ê¸°ë³¸: í•„ë¦„ë²ˆí˜¸-1, í•„ë¦„ë²ˆí˜¸-2 ... (ìë™ ë„˜ë²„ë§, ìˆ˜ì • ê°€ëŠ¥)
            </small>
          </div>

          <div class="form-row">
            <label>í…ì…˜</label>
            <input type="text" id="plateTension" placeholder="ì˜ˆ: 23~25" />
          </div>

          <div class="form-row">
            <label>íŒ ìœ„ì¹˜</label>
            <input type="text" id="plateLocation" placeholder="ì˜ˆ: 3ì¸µ íŒë™ 2ë²ˆ" />
          </div>

          <div class="form-row">
            <label>MESH (ìˆ˜ì • ê°€ëŠ¥)</label>
            <input type="text" id="plateMesh" placeholder="ì˜ˆ: 180T, 200ë©”ì‰¬" />
          </div>

          <div class="form-row">
            <label>íŒ ìµœëŒ€ ì‚¬ìš© ìˆ˜ëŸ‰</label>
            <input type="number" id="plateMaxQty" min="1" step="1" />
            <small style="font-size:11px; color:var(--text-sub); margin-top:6px;">
              ê¸°ë³¸ê°’ 5000
            </small>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="plateCancelBtn">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn-primary" id="plateSaveBtn">ì €ì¥</button>
          </div>
        </form>
      </div>

      <!-- ë¦¬ìŠ¤íŠ¸ -->
      <div id="list" class="list"></div>
      <div id="emptyText" class="empty-text" style="display:none;">-</div>

      <div id="loadingSpinner" class="spinner-wrapper">
        <div class="spinner-circle"></div>
      </div>
    </div>
  </div>

  <button id="scrollTopBtn" class="scroll-top-btn">â†‘</button>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <script>
    /* ---------- Firebase ì„¤ì • ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyBrBnVuXca2Ou1oMFOLzq3KGEN8xiK5L_U",
      authDomain: "film-find-5242d.firebaseapp.com",
      projectId: "film-find-5242d",
      storageBucket: "film-find-5242d.firebasestorage.app",
      messagingSenderId: "185123433624",
      appId: "1:185123433624:web:269eb9b4b6437887f2f4ed",
      measurementId: "G-V9KL8XS9KJ"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const FILM_COLLECTION = "films";
    const HISTORY_COLLECTION = "history";

    const PLATE_COLLECTION = "plates";
    const PLATE_USAGE_SUB = "usage";
    const CONFIG_COLLECTION = "appConfig";
    const AUTH_DOC = "auth";

    /* ---------- ëª¨ë“œ/ë¡œê·¸ì¸ ---------- */
    const MODE_ADMIN = "admin";
    const MODE_PRINTER = "printer";
    const MODE_VIEWER = "viewer";

    const DEFAULT_ADMIN_PW = "0605";
    const DEFAULT_PRINTER_PW = "1234";
    const DEFAULT_VIEWER_PW = "0000";

    /* âœ… ë¡œê·¸ì¸ ìœ ì§€ ê·œì¹™:
       - ì•±/ë¸Œë¼ìš°ì € ì°½ ì™„ì „ ì¢…ë£Œ í›„ ì¬ì ‘ì† ì‹œ ì¬ë¡œê·¸ì¸
       -> localStorage ê¸ˆì§€ / sessionStorage ì‚¬ìš© */
    const UNLOCK_KEY = "filmAppUnlocked";
    const UNLOCK_MODE_KEY = "filmAppMode";

    /* ---------- ì•± ì„¤ì •/í‚¤ ---------- */
    const DEVICE_KEY = "filmDeviceLabel";
    const SORT_KEY = "filmSortOption";
    const THEME_KEY = "filmTheme";
    const VIEW_KEY = "filmViewMode";

    let films = [];
    let plates = [];

    let currentSearchText = "";
    let unsubscribeFilms = null;
    let unsubscribePlates = null;

    let historyEntries = [];
    let historyLoaded = false;

    const VISIBLE_STEP = 30;
    let visibleCount = VISIBLE_STEP;
    let loadingMore = false;

    let currentViewMode = localStorage.getItem(VIEW_KEY) || "list";

    let currentSelectedImageDataUrl = null;
    let currentImageRotation = 0;

    let currentMemoFilmId = null;
    let currentHistoryNoteId = null;

    let currentTab = "films";
    let currentMode = null;

    let authConfig = { adminPw: DEFAULT_ADMIN_PW, printerPw: DEFAULT_PRINTER_PW, viewerPw: DEFAULT_VIEWER_PW };

    let currentPlateMemoId = null;
    let currentPlateUseId = null;
    let currentPlateHistoryId = null;

    /* ---------- ìœ í‹¸ ---------- */
    function showToast(msg) {
      const toast = document.getElementById("toast");
      if (!toast) return;
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 1800);
    }

    function formatDate(iso) { return iso ? iso : "-"; }

    function formatTs(ts) {
      const d = new Date(ts || 0);
      if (isNaN(d.getTime())) return "-";
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return `${y}-${m}-${day} ${hh}:${mm}`;
    }

    function safeStr(v){ return String(v ?? "").trim(); }

    /* ---------- ë¡œì»¬ ì„¤ì • ---------- */
    function getSortOption(){ return localStorage.getItem(SORT_KEY) || "updated"; }
    function setSortOption(opt){ localStorage.setItem(SORT_KEY, opt); }

    function getDeviceLabel(){ return localStorage.getItem(DEVICE_KEY) || ""; }
    function setDeviceLabel(label){
      localStorage.setItem(DEVICE_KEY, label);
      const badgeText = document.getElementById("deviceBadgeText");
      if (badgeText) badgeText.textContent = label || "ê¸°ê¸° ë¯¸ì§€ì •";
    }

    function getTheme(){ return localStorage.getItem(THEME_KEY) || "default"; }
    function setTheme(theme){
      localStorage.setItem(THEME_KEY, theme);
      const root = document.documentElement;
      if (theme === "default") root.removeAttribute("data-theme");
      else root.setAttribute("data-theme", theme);
    }

    function setViewMode(mode){
      currentViewMode = mode;
      localStorage.setItem(VIEW_KEY, mode);
      applyViewMode();
    }

    function applyViewMode(){
      const list = document.getElementById("list");
      const btn = document.getElementById("viewToggleBtn");
      if (!list || !btn) return;
      if (currentViewMode === "gallery"){
        list.classList.add("gallery");
        btn.textContent = "ë¦¬ìŠ¤íŠ¸";
      } else {
        list.classList.remove("gallery");
        btn.textContent = "ê°¤ëŸ¬ë¦¬";
      }
    }

    /* ---------- íŒ¨ë„ ë‹«ê¸° ---------- */
    function closeAllPanels(){
      const ids = ["settingsCard","historyCard","formCard","plateFormCard"];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = "none";
      });
    }

    /* ---------- ì´ë¯¸ì§€ ë·°ì–´ ---------- */
        /* [ìˆ˜ì •] ì´ë¯¸ì§€ ë·°ì–´ ì—´ê¸° (ì´ˆê¸°í™” ë¡œì§ ì¶”ê°€ë¨) */
    function openImageViewer(src){
      const viewer = document.getElementById("imageViewer");
      const img = document.getElementById("viewerImage");
      if (!viewer || !img) return;
      
      img.src = src || "";
      
      // â˜… ë·°ì–´ ì—´ ë•Œ ìœ„ì¹˜/ë°°ìœ¨ ì´ˆê¸°í™” â˜…
      viewerState.scale = 1;
      viewerState.pointX = 0;
      viewerState.pointY = 0;
      updateViewerTransform(); 
      
      viewer.style.display = "flex";
    }

    function closeImageViewer(){
      const viewer = document.getElementById("imageViewer");
      const img = document.getElementById("viewerImage");
      if (!viewer || !img) return;
      viewer.style.display = "none";
      img.src = "";
    }

    /* ---------- ê²€ìƒ‰ placeholder ---------- */
    function updateSearchPlaceholder(){
      const searchInput = document.getElementById("searchInput");
      if (!searchInput) return;
      if (currentTab === "films") {
        searchInput.placeholder = "ì œí’ˆëª… / í•„ë¦„ë²ˆí˜¸ / ì œíŒíƒ€ì… / ìœ„ì¹˜ / ì œíŒë°©ë²• / MESH / ìš”ì²­ ì¸ì‡„ì ê²€ìƒ‰";
      } else {
        searchInput.placeholder = "ì œí’ˆëª… / í•„ë¦„ë²ˆí˜¸ / íŒë²ˆí˜¸ / í…ì…˜ / íŒìœ„ì¹˜ / MESH ê²€ìƒ‰";
      }
    }

    function setActiveTabUI(){
      const tabFilmsBtn = document.getElementById("tabFilmsBtn");
      const tabPlatesBtn = document.getElementById("tabPlatesBtn");
      if (tabFilmsBtn) tabFilmsBtn.classList.toggle("active", currentTab === "films");
      if (tabPlatesBtn) tabPlatesBtn.classList.toggle("active", currentTab === "plates");

      updateSearchPlaceholder();
      closeAllPanels();

      const si = document.getElementById("searchInput");
      if (si) si.value = "";
      currentSearchText = "";
      visibleCount = VISIBLE_STEP;

      renderCurrentTab();
    }

    function switchToTab(tab){
      if (currentMode === MODE_PRINTER && tab !== "plates") return;
      currentTab = tab;
      setActiveTabUI();
    }

    /* ---------- ëª¨ë“œ UI ---------- */
    function applyModeUI(){
      const modeText = document.getElementById("modeChipText");
      const subtitle = document.getElementById("subtitleText");
      const settingsBtn = document.getElementById("settingsBtn");
      const historyBtn = document.getElementById("historyBtn");
      const exportBtn = document.getElementById("exportBtn");
      const importBtn = document.getElementById("importBtn");
      const newFilmBtn = document.getElementById("newFilmBtn");
      const viewToggleBtn = document.getElementById("viewToggleBtn");
      const pwSection = document.getElementById("pwSection");
      const printerListSection = document.getElementById("printerListSection");

      const tabFilmsBtn = document.getElementById("tabFilmsBtn");
      const tabPlatesBtn = document.getElementById("tabPlatesBtn");

      if (currentMode === MODE_ADMIN){
        if (modeText) modeText.textContent = "ê´€ë¦¬ì";
        if (subtitle) subtitle.textContent = "í•„ë¦„/íŒ ê´€ë¦¬";
        if (settingsBtn) settingsBtn.style.display = "inline-block";
        if (historyBtn) historyBtn.style.display = "inline-block";
        if (exportBtn) exportBtn.style.display = "inline-block";
        if (importBtn) importBtn.style.display = "inline-block";
        if (newFilmBtn) newFilmBtn.style.display = "inline-block";
        if (viewToggleBtn) viewToggleBtn.style.display = "inline-block";
        if (pwSection) pwSection.style.display = "block";
        if (printerListSection) printerListSection.style.display = "block";

        if (tabFilmsBtn) tabFilmsBtn.style.display = "inline-flex";
        if (tabPlatesBtn) tabPlatesBtn.style.display = "inline-flex";
      }

      if (currentMode === MODE_PRINTER){
        if (modeText) modeText.textContent = "ì¸ì‡„ê¸°ì‚¬";
        if (subtitle) subtitle.textContent = "íŒ ì „ìš©";
        if (settingsBtn) settingsBtn.style.display = "none";
        if (historyBtn) historyBtn.style.display = "none";
        if (exportBtn) exportBtn.style.display = "none";
        if (importBtn) importBtn.style.display = "none";
        if (newFilmBtn) newFilmBtn.style.display = "none";
        if (viewToggleBtn) viewToggleBtn.style.display = "none";
        if (pwSection) pwSection.style.display = "none";
        if (printerListSection) printerListSection.style.display = "none";

        if (tabFilmsBtn) tabFilmsBtn.style.display = "none";
        if (tabPlatesBtn) tabPlatesBtn.style.display = "inline-flex";

        currentTab = "plates";
        setActiveTabUI();
      }

      if (currentMode === MODE_VIEWER){
        if (modeText) modeText.textContent = "ì¡°íšŒ";
        if (subtitle) subtitle.textContent = "ì¡°íšŒ ì „ìš©";
        if (settingsBtn) settingsBtn.style.display = "none";
        if (historyBtn) historyBtn.style.display = "none";
        if (exportBtn) exportBtn.style.display = "none";
        if (importBtn) importBtn.style.display = "none";
        if (newFilmBtn) newFilmBtn.style.display = "none";
        if (viewToggleBtn) viewToggleBtn.style.display = "inline-block";
        if (pwSection) pwSection.style.display = "none";
        if (printerListSection) printerListSection.style.display = "none";

        if (tabFilmsBtn) tabFilmsBtn.style.display = "inline-flex";
        if (tabPlatesBtn) tabPlatesBtn.style.display = "inline-flex";
      }

      updateSearchPlaceholder();
    }

    /* ---------- Firestore: ì¸ì¦ ì„¤ì • ---------- */
    async function loadAuthConfig(){
      try{
        const ref = db.collection(CONFIG_COLLECTION).doc(AUTH_DOC);
        const snap = await ref.get();
        if (snap.exists){
          const data = snap.data() || {};
          authConfig.adminPw = data.adminPw || DEFAULT_ADMIN_PW;
          authConfig.printerPw = data.printerPw || DEFAULT_PRINTER_PW;
          authConfig.viewerPw = data.viewerPw || DEFAULT_VIEWER_PW;
        } else {
          await ref.set({
            adminPw: DEFAULT_ADMIN_PW,
            printerPw: DEFAULT_PRINTER_PW,
            viewerPw: DEFAULT_VIEWER_PW,
            updatedAt: Date.now()
          }, { merge:true });
          authConfig.adminPw = DEFAULT_ADMIN_PW;
          authConfig.printerPw = DEFAULT_PRINTER_PW;
          authConfig.viewerPw = DEFAULT_VIEWER_PW;
        }
      } catch(e){
        console.error("authConfig ë¡œë“œ ì˜¤ë¥˜:", e);
        authConfig.adminPw = DEFAULT_ADMIN_PW;
        authConfig.printerPw = DEFAULT_PRINTER_PW;
        authConfig.viewerPw = DEFAULT_VIEWER_PW;
      }
    }

    async function saveAuthConfig(newAdminPw, newPrinterPw, newViewerPw){
      const ref = db.collection(CONFIG_COLLECTION).doc(AUTH_DOC);
      await ref.set({
        adminPw: newAdminPw,
        printerPw: newPrinterPw,
        viewerPw: newViewerPw,
        updatedAt: Date.now()
      }, { merge:true });

      authConfig.adminPw = newAdminPw;
      authConfig.printerPw = newPrinterPw;
      authConfig.viewerPw = newViewerPw;
    }

    function detectModeByPassword(pw){
      if (pw === authConfig.adminPw) return MODE_ADMIN;
      if (pw === authConfig.printerPw) return MODE_PRINTER;
      if (pw === authConfig.viewerPw) return MODE_VIEWER;
      return null;
    }

    /* ---------- ì‹¤ì‹œê°„ ë™ê¸°í™” ---------- */
    function startFilmsListener(){
      if (unsubscribeFilms) unsubscribeFilms();
      unsubscribeFilms = db.collection(FILM_COLLECTION).onSnapshot(
        (snapshot) => {
          films = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          if (currentTab === "films") renderList(currentSearchText);
        },
        (error) => {
          console.error("í•„ë¦„ ì‹¤ì‹œê°„ ë™ê¸°í™” ì˜¤ë¥˜:", error);
          showToast("ì„œë²„ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´.");
        }
      );
    }

    function startPlatesListener(){
      if (unsubscribePlates) unsubscribePlates();
      unsubscribePlates = db.collection(PLATE_COLLECTION).onSnapshot(
        (snapshot) => {
          plates = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
		  updateDashboard();
          if (currentTab === "plates") renderPlatesList(currentSearchText);
        },
        (error) => {
          console.error("íŒ ì‹¤ì‹œê°„ ë™ê¸°í™” ì˜¤ë¥˜:", error);
          showToast("íŒ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´.");
        }
      );
    }

    /* ---------- íˆìŠ¤í† ë¦¬ ---------- */
    async function addHistory(action, filmLike, changes = []){
      try{
        const entry = {
          action,
          filmId: filmLike?.id || filmLike?.filmId || null,
          filmNumber: safeStr(filmLike?.filmNumber || filmLike?.plateNumber || filmLike?.plateNumber || filmLike?.plateNumber || filmLike?.plateNumber || filmLike?.plateNumber || filmLike?.plateNumber || filmLike?.plateNumber || filmLike?.plateNumber || filmLike?.plateNumber || filmLike?.plateNumber) || safeStr(filmLike?.filmNumber) || "",
          productName: safeStr(filmLike?.productName) || "",
          deviceName: getDeviceLabel() || "",
          timestamp: Date.now(),
          changes: Array.isArray(changes) ? changes : [],
        };
        // ìœ„ filmNumber ë¼ì¸ ë„ˆë¬´ ê¸¸ê²Œ ë³´ì´ë‹ˆê¹Œ ì •ë¦¬(ì‹¤ì œ ê°’ì€ ì•„ë˜ì—ì„œ ì¬ì„¸íŒ…)
        entry.filmNumber = safeStr(filmLike?.filmNumber || filmLike?.plateNumber || "");
        await db.collection(HISTORY_COLLECTION).add(entry);
        if (historyLoaded) await loadHistory();
      } catch(e){
        console.error("íˆìŠ¤í† ë¦¬ ê¸°ë¡ ì¤‘ ì˜¤ë¥˜:", e);
      }
    }

    async function loadHistory(){
      try{
        const snap = await db.collection(HISTORY_COLLECTION).orderBy("timestamp","desc").limit(100).get();
        historyEntries = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        historyLoaded = true;
        renderHistory();
      } catch(e){
        console.error("íˆìŠ¤í† ë¦¬ ë¡œë“œ ì˜¤ë¥˜:", e);
        showToast("íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´.");
      }
    }

    function actionLabel(action){
      if (action === "ë“±ë¡") return "í•„ë¦„ ë“±ë¡";
      if (action === "ìˆ˜ì •") return "í•„ë¦„ ìˆ˜ì •";
      if (action === "ì‚­ì œ") return "í•„ë¦„ ì‚­ì œ";
      if (action === "ì˜¤ëŠ˜ ì‚¬ìš©") return "ì˜¤ëŠ˜ ì‚¬ìš© ì²´í¬";
      if (action === "íŒ ë“±ë¡") return "íŒ ë“±ë¡";
      if (action === "íŒ ìˆ˜ì •") return "íŒ ìˆ˜ì •";
      if (action === "íŒ ì‚­ì œ") return "íŒ ì‚­ì œ";
      return action || "ë³€ê²½";
    }

    function renderHistory(){
      const list = document.getElementById("historyList");
      if (!list) return;
      list.innerHTML = "";

      if (!historyEntries.length){
        const empty = document.createElement("div");
        empty.className = "history-empty";
        empty.innerHTML = "ì•„ì§ ê¸°ë¡ì´ ì—†ì–´.";
        list.appendChild(empty);
        return;
      }

      historyEntries.forEach((entry) => {
        const row = document.createElement("div");
        row.className = "history-row";

        const ts = formatTs(entry.timestamp || 0);
        const device = entry.deviceName || "ê¸°ê¸° ë¯¸ì§€ì •";
        const filmLabel =
          (safeStr(entry.filmNumber) ? safeStr(entry.filmNumber) : "") +
          (safeStr(entry.productName) ? ` (${safeStr(entry.productName)})` : "");

        const changesArr = Array.isArray(entry.changes) ? entry.changes : [];
        const noteText = safeStr(entry.note);

        row.innerHTML =
          `<div class="history-headline">` +
            `<div>` +
              `<span class="history-time">${ts}</span>` +
              `<span class="history-device">${device}</span>` +
              `<span class="history-action-chip">${actionLabel(entry.action)}</span>` +
            `</div>` +
            `<button class="history-pencil" data-id="${entry.id}">âœï¸</button>` +
          `</div>` +
          `<div class="history-film">${filmLabel || "ì •ë³´ ì—†ìŒ"}</div>` +
          (changesArr.length ? `<div class="history-changes">ë³€ê²½ í•­ëª©: ${changesArr.join(", ")}</div>` : "") +
          (noteText ? `<div class="history-note">${noteText}</div>` : "");

        const pencilBtn = row.querySelector(".history-pencil");
        if (pencilBtn) pencilBtn.addEventListener("click", () => openHistoryNoteModal(entry.id));

        list.appendChild(row);
      });
    }

    function openHistoryCard(){
      const card = document.getElementById("historyCard");
      const isOpen = card.style.display === "block";
      closeAllPanels();
      if (!isOpen){
        card.style.display = "block";
        if (!historyLoaded) loadHistory(); else renderHistory();
      }
    }
    function closeHistoryCard(){ document.getElementById("historyCard").style.display = "none"; }

    /* ---------- íˆìŠ¤í† ë¦¬ ë©”ëª¨ ëª¨ë‹¬ ---------- */
    function openHistoryNoteModal(historyId){
      const entry = historyEntries.find(h => h.id === historyId);
      if (!entry) return;
      currentHistoryNoteId = historyId;
      const modal = document.getElementById("historyNoteModal");
      const ta = document.getElementById("historyNoteTextarea");
      if (ta) ta.value = entry.note || "";
      modal.classList.add("show");
    }
    function closeHistoryNoteModal(){
      const modal = document.getElementById("historyNoteModal");
      modal.classList.remove("show");
      currentHistoryNoteId = null;
    }
    async function saveHistoryNoteModal(){
      if (!currentHistoryNoteId) return;
      const ta = document.getElementById("historyNoteTextarea");
      const note = safeStr(ta.value);
      try{
        await db.collection(HISTORY_COLLECTION).doc(currentHistoryNoteId).set({ note }, { merge:true });
        const idx = historyEntries.findIndex(h => h.id === currentHistoryNoteId);
        if (idx >= 0) historyEntries[idx].note = note;
        renderHistory();
        showToast("íˆìŠ¤í† ë¦¬ ë©”ëª¨ ì €ì¥ë¨.");
        closeHistoryNoteModal();
      } catch(e){
        console.error(e);
        showToast("íˆìŠ¤í† ë¦¬ ë©”ëª¨ ì €ì¥ ì¤‘ ì˜¤ë¥˜.");
      }
    }

    /* ---------- í•„ë¦„ ë©”ëª¨ ---------- */
    function openMemoSheet(filmId){
      const film = films.find(f => f.id === filmId);
      if (!film) return;
      currentMemoFilmId = filmId;

      const title = document.getElementById("memoSheetTitle");
      const sub = document.getElementById("memoSheetSub");
      const ta = document.getElementById("memoTextarea");
      const sheet = document.getElementById("memoSheet");

      if (title) title.textContent = `ë©”ëª¨ Â· ${film.filmNumber || ""}`;
      if (sub) sub.textContent = film.productName ? film.productName : "í•„ë¦„ë³„ ë©”ëª¨";
      if (ta) ta.value = film.memo || "";

      // ì¡°íšŒ ëª¨ë“œë©´ ì €ì¥ ë²„íŠ¼ ë¹„í™œì„±(ë³´ê¸°ë§Œ)
      const saveBtn = document.getElementById("memoSheetSaveBtn");
      if (saveBtn) saveBtn.style.display = (currentMode === MODE_ADMIN) ? "inline-block" : "none";

      sheet.classList.add("show");
    }
    function closeMemoSheet(){
      document.getElementById("memoSheet").classList.remove("show");
      currentMemoFilmId = null;
    }
    async function saveMemoSheet(){
      if (currentMode !== MODE_ADMIN) return;
      if (!currentMemoFilmId) return;
      const ta = document.getElementById("memoTextarea");
      const memo = safeStr(ta.value);
      try{
        await db.collection(FILM_COLLECTION).doc(currentMemoFilmId).set({ memo, updatedAt: Date.now() }, { merge:true });
        showToast("ë©”ëª¨ë¥¼ ì €ì¥í–ˆì–´.");
        closeMemoSheet();
      } catch(e){
        console.error(e);
        showToast("ë©”ëª¨ ì €ì¥ ì¤‘ ì˜¤ë¥˜.");
      }
    }

    /* ---------- íŒ ë©”ëª¨ ---------- */
    function openPlateMemoSheet(plateId){
      const plate = plates.find(p => p.id === plateId);
      if (!plate) return;
      currentPlateMemoId = plateId;

      const title = document.getElementById("plateMemoTitle");
      const sub = document.getElementById("plateMemoSub");
      const ta = document.getElementById("plateMemoTextarea");
      const sheet = document.getElementById("plateMemoSheet");

      const label = plate.plateNumber || "";
      if (title) title.textContent = `íŒ ë©”ëª¨ Â· ${label}`;
      if (sub) sub.textContent = plate.productName ? plate.productName : "íŒë³„ ë©”ëª¨";
      if (ta) ta.value = plate.memo || "";

      const saveBtn = document.getElementById("plateMemoSaveBtn");
      if (saveBtn) saveBtn.style.display = (currentMode === MODE_ADMIN) ? "inline-block" : "none";

      sheet.classList.add("show");
    }
    function closePlateMemoSheet(){
      document.getElementById("plateMemoSheet").classList.remove("show");
      currentPlateMemoId = null;
    }
    async function savePlateMemoSheet(){
      if (currentMode !== MODE_ADMIN) return;
      if (!currentPlateMemoId) return;
      const ta = document.getElementById("plateMemoTextarea");
      const memo = safeStr(ta.value);
      try{
        await db.collection(PLATE_COLLECTION).doc(currentPlateMemoId).set({ memo, updatedAt: Date.now() }, { merge:true });
        showToast("íŒ ë©”ëª¨ ì €ì¥ë¨.");
        closePlateMemoSheet();
      } catch(e){
        console.error(e);
        showToast("íŒ ë©”ëª¨ ì €ì¥ ì¤‘ ì˜¤ë¥˜.");
      }
    }

    /* ---------- ì œíŒ ë°©ë²• í† ê¸€ ---------- */
    function clearPlateInfoForm(){ document.querySelectorAll(".toggle-btn").forEach(btn => btn.classList.remove("active")); }
    function setPlateInfoToForm(str){
      clearPlateInfoForm();
      if (!str) return;
      const parts = str.split(" ");
      document.querySelectorAll(".toggle-btn").forEach(btn => {
        if (parts.includes(btn.dataset.value)) btn.classList.add("active");
      });
    }
    function getPlateInfoFromForm(){
      const groups = document.querySelectorAll(".toggle-group");
      const values = [];
      groups.forEach(group => {
        const active = group.querySelector(".toggle-btn.active");
        if (active) values.push(active.dataset.value);
      });
      return values.join(" ");
    }

    /* ---------- í•„ë¦„ í¼ ---------- */
    function resetImagePreview(){
      const wrapper = document.getElementById("imagePreviewWrapper");
      const img = document.getElementById("imagePreview");
      currentSelectedImageDataUrl = null;
      currentImageRotation = 0;
      if (img){
        img.src = "";
        img.style.transform = "rotate(0deg)";
      }
      if (wrapper) wrapper.style.display = "none";
    }
    function applyPreviewRotation(){
      const img = document.getElementById("imagePreview");
      if (!img) return;
      img.style.transform = "rotate(" + currentImageRotation + "deg)";
    }

    function resetForm(){
      document.getElementById("filmId").value = "";
      document.getElementById("productName").value = "";
      document.getElementById("filmNumber").value = "";
      document.getElementById("method").value = "";
      document.getElementById("mesh").value = "";
      document.getElementById("location").value = "";
      document.getElementById("requestPrinter").value = "";
      document.getElementById("lastUsed").value = "";
      document.getElementById("imageInput").value = "";
      clearPlateInfoForm();
      resetImagePreview();
    }

    function getLastFilmForDefaults(){
      if (!films.length) return null;
      return films.reduce((acc, cur) => {
        const a = acc.updatedAt || acc.createdAt || 0;
        const b = cur.updatedAt || cur.createdAt || 0;
        return b > a ? cur : acc;
      });
    }

    function openFormNew(){
      if (currentMode !== MODE_ADMIN) return;
      resetForm();
      const last = getLastFilmForDefaults();
      if (last){
        document.getElementById("method").value = last.method || "";
        document.getElementById("mesh").value = last.mesh || "";
        document.getElementById("location").value = last.location || "";
        document.getElementById("requestPrinter").value = last.requestPrinter || "";
        setPlateInfoToForm(last.plateInfo || "");
      }
      document.getElementById("formCard").style.display = "block";
      document.getElementById("productName").focus();
    }

    function toggleFormNew(){
      if (currentMode !== MODE_ADMIN) return;
      const card = document.getElementById("formCard");
      const isOpen = card.style.display === "block";
      closeAllPanels();
      if (!isOpen) openFormNew();
    }

    function openFormCopyFrom(id){
      if (currentMode !== MODE_ADMIN) return;
      const film = films.find(f => f.id === id);
      if (!film) return;
      resetForm();
      document.getElementById("productName").value = film.productName || "";
      document.getElementById("filmNumber").value = "";
      document.getElementById("method").value = film.method || "";
      document.getElementById("mesh").value = film.mesh || "";
      document.getElementById("location").value = film.location || "";
      document.getElementById("requestPrinter").value = film.requestPrinter || "";
      document.getElementById("lastUsed").value = "";
      setPlateInfoToForm(film.plateInfo || "");
      closeAllPanels();
      document.getElementById("formCard").style.display = "block";
      document.getElementById("productName").focus();
    }

    function openFormForEdit(id){
      if (currentMode !== MODE_ADMIN) return;
      const film = films.find(f => f.id === id);
      if (!film) return;
      closeAllPanels();
      resetImagePreview();

      document.getElementById("filmId").value = film.id;
      document.getElementById("productName").value = film.productName || "";
      document.getElementById("filmNumber").value = film.filmNumber || "";
      document.getElementById("method").value = film.method || "";
      document.getElementById("mesh").value = film.mesh || "";
      document.getElementById("location").value = film.location || "";
      document.getElementById("requestPrinter").value = film.requestPrinter || "";
      document.getElementById("lastUsed").value = film.lastUsed || "";
      document.getElementById("imageInput").value = "";
      setPlateInfoToForm(film.plateInfo || "");

      // ê¸°ì¡´ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°ëŠ” "ì„ íƒí•˜ë©´" ëœ¨ê²Œ ìœ ì§€
      document.getElementById("formCard").style.display = "block";
      document.getElementById("productName").focus();
    }

    function closeForm(){
      document.getElementById("formCard").style.display = "none";
      resetForm();
    }

    function updateCountBar(filteredLength, totalLength, hasFilter){
      const bar = document.getElementById("countBar");
      if (!bar) return;
      if (hasFilter) bar.innerHTML = `ê²€ìƒ‰ ê²°ê³¼ <strong>${filteredLength}</strong>ê°œ / ì „ì²´ ${totalLength}ê°œ`;
      else bar.innerHTML = (currentTab === "films") ? `ì´ <strong>${totalLength}</strong>ê°œ í•„ë¦„` : `ì´ <strong>${totalLength}</strong>ê°œ íŒ`;
    }

    async function readFileAsDataURL(file){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    function rotateDataURL90(dataUrl, dir){
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          const w = img.width;
          const h = img.height;

          const cw = h;
          const ch = w;
          canvas.width = cw;
          canvas.height = ch;

          ctx.translate(cw / 2, ch / 2);
          ctx.rotate((dir === "left" ? -90 : 90) * Math.PI / 180);
          ctx.drawImage(img, -w/2, -h/2);
          resolve(canvas.toDataURL("image/jpeg", 0.92));
        };
        img.src = dataUrl;
      });
    }
        /* ---------- [ì¶”ê°€] ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì§•(ì••ì¶•) í•¨ìˆ˜ ---------- */
    function compressImage(file, maxWidth, quality) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
          const img = new Image();
          img.src = event.target.result;
          img.onload = () => {
            let width = img.width;
            let height = img.height;

            // ê°€ë¡œ í¬ê¸°ê°€ maxWidthë³´ë‹¤ í¬ë©´ ì¤„ì´ê¸° (ë¹„ìœ¨ ìœ ì§€)
            if (width > maxWidth) {
              height = Math.round((height * maxWidth) / width);
              width = maxWidth;
            }

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            // JPGë¡œ ë³€í™˜ ë° ì••ì¶• (quality: 0.1 ~ 1.0)
            // 0.7 ì •ë„ë©´ í™”ì§ˆì€ ì¢‹ê³  ìš©ëŸ‰ì€ í™• ì¤„ì–´ë“¦
            resolve(canvas.toDataURL('image/jpeg', quality));
          };
          img.onerror = (err) => reject(err);
        };
        reader.onerror = (err) => reject(err);
      });
    }


        async function saveFilm(e){
      e.preventDefault();
      if (currentMode !== MODE_ADMIN) return;

      const id = safeStr(document.getElementById("filmId").value);
      const productName = safeStr(document.getElementById("productName").value);
      const filmNumber = safeStr(document.getElementById("filmNumber").value);
      const method = safeStr(document.getElementById("method").value);
      const mesh = safeStr(document.getElementById("mesh").value);
      const location = safeStr(document.getElementById("location").value);
      const requestPrinter = safeStr(document.getElementById("requestPrinter").value);
      const lastUsed = safeStr(document.getElementById("lastUsed").value);
      const plateInfo = getPlateInfoFromForm();

      if (!productName || !filmNumber){
        showToast("ì œí’ˆ ì´ë¦„/í•„ë¦„ ë²ˆí˜¸ëŠ” í•„ìˆ˜ì•¼.");
        return;
      }

      let imageDataUrl = "";
      const file = document.getElementById("imageInput").files?.[0];
      
      // âœ… [ìˆ˜ì •ëœ ë¶€ë¶„] ì‚¬ì§„ì´ ìˆìœ¼ë©´ ì••ì¶• ë¨¼ì € ì§„í–‰!
      if (file){
        try {
          // 1. ì••ì¶• ì‹¤í–‰ (ê°€ë¡œ ìµœëŒ€ 1000px, í€„ë¦¬í‹° 0.7)
          // 1000pxì´ë©´ í°ì¹´ ì›ë³¸ë³´ë‹¤ í›¨ì”¬ ì‘ì•„ì ¸ì„œ íŒŒì´ì–´ë² ì´ìŠ¤ì— ì˜ ë“¤ì–´ê°
          imageDataUrl = await compressImage(file, 1000, 0.7);

          // 2. íšŒì „ ìƒíƒœ ë°˜ì˜ (ì••ì¶•ëœ ì´ë¯¸ì§€ë¡œ íšŒì „)
          let rot = ((currentImageRotation % 360) + 360) % 360;
          if (rot === 90) imageDataUrl = await rotateDataURL90(imageDataUrl, "right");
          if (rot === 180){ imageDataUrl = await rotateDataURL90(await rotateDataURL90(imageDataUrl, "right"), "right"); }
          if (rot === 270) imageDataUrl = await rotateDataURL90(imageDataUrl, "left");
          
        } catch(err) {
          console.error("ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", err);
          alert("ì‚¬ì§„ ì²˜ë¦¬ ì˜¤ë¥˜: " + err.message); // ì˜¤ë¥˜ ë‚´ìš© í°ì— ë„ìš°ê¸°
          return;
        }
      }

      const payload = {
        productName, filmNumber, method, mesh, location, requestPrinter, lastUsed, plateInfo,
        updatedAt: Date.now(),
      };
      if (!id) payload.createdAt = Date.now();
      
      // íŒŒì¼ì´ ì„ íƒë˜ì—ˆì„ ë•Œë§Œ ì´ë¯¸ì§€ ë°ì´í„° ì—…ë°ì´íŠ¸
      if (file) payload.imageDataUrl = imageDataUrl;

      try{
        if (id){
          await db.collection(FILM_COLLECTION).doc(id).set(payload, { merge:true });
          await addHistory("ìˆ˜ì •", { id, productName, filmNumber }, ["í•„ë¦„ ìˆ˜ì •"]);
          showToast("ìˆ˜ì • ì €ì¥ë¨.");
        } else {
          const ref = await db.collection(FILM_COLLECTION).add(payload);
          await addHistory("ë“±ë¡", { id: ref.id, productName, filmNumber }, ["í•„ë¦„ ë“±ë¡"]);
          showToast("ë“±ë¡ë¨.");
        }
        closeForm();
      } catch(e){
        console.error(e);
        // ì €ì¥ ì‹¤íŒ¨ ì‹œ ë©”ì‹œì§€ (ë³´í†µ ìš©ëŸ‰ ë¬¸ì œ)
        alert("ì €ì¥ ì‹¤íŒ¨: " + e.message);
        showToast("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë‚¬ì–´.");
      }
    }

    /* ---------- í•„ë¦„ ë¦¬ìŠ¤íŠ¸ ---------- */
    function renderList(filterText = ""){
      const listEl = document.getElementById("list");
      const emptyText = document.getElementById("emptyText");
      if (!listEl || !emptyText) return;

      listEl.innerHTML = "";
      currentSearchText = filterText || "";

      // ì¸ì‡„ê¸°ì‚¬ ëª¨ë“œ: í•„ë¦„ ë¦¬ìŠ¤íŠ¸ ì•„ì˜ˆ ì•ˆ ë³´ì„
      if (currentMode === MODE_PRINTER){
        emptyText.style.display = "block";
        emptyText.innerHTML = "í•„ë¦„ íƒ­ì€ ì¸ì‡„ê¸°ì‚¬ ëª¨ë“œì—ì„œ ë³´ì´ì§€ ì•Šì•„.";
        updateCountBar(0, 0, false);
        return;
      }

      const text = safeStr(filterText).toLowerCase();

      let filtered = films.filter(f => {
        if (!text) return true;
        const combined =
          (f.productName || "") + " " +
          (f.filmNumber || "") + " " +
          (f.method || "") + " " +
          (f.mesh || "") + " " +
          (f.location || "") + " " +
          (f.plateInfo || "") + " " +
          (f.requestPrinter || "");
        return combined.toLowerCase().includes(text);
      });

      const sortOpt = getSortOption();
      filtered = filtered.slice().sort((a,b) => {
        if (sortOpt === "name") return (a.productName || "").localeCompare(b.productName || "", "ko");
        if (sortOpt === "number") return (a.filmNumber || "").localeCompare(b.filmNumber || "", "ko");
        if (sortOpt === "lastUsed") return (b.lastUsed || "").localeCompare(a.lastUsed || "");
        const atA = a.updatedAt || a.createdAt || 0;
        const atB = b.updatedAt || b.createdAt || 0;
        return atB - atA;
      });

      updateCountBar(filtered.length, films.length, !!text);

      let toRender = filtered;
      if (!text){
        visibleCount = Math.min(visibleCount || VISIBLE_STEP, filtered.length);
        toRender = filtered.slice(0, visibleCount);
      }

      if (filtered.length === 0){
        emptyText.style.display = "block";
        emptyText.innerHTML = "ë“±ë¡ëœ í•„ë¦„ì´ ì—†ìŠµë‹ˆë‹¤.<br/>ì˜¤ë¥¸ìª½ ìœ„ <b>+ ìƒˆ í•„ë¦„</b> ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€í•˜ì„¸ìš”.";
        return;
      } else {
        emptyText.style.display = "none";
      }

      toRender.forEach((film) => {
        const card = document.createElement("div");
        card.className = "card";

        const img = document.createElement("img");
        if (film.imageDataUrl){
          img.src = film.imageDataUrl;
          img.addEventListener("click", () => openImageViewer(film.imageDataUrl));
        } else {
          img.alt = "ì´ë¯¸ì§€ ì—†ìŒ";
        }
        card.appendChild(img);

        const content = document.createElement("div");
        content.className = "card-content";

        const rowMain = document.createElement("div");
        rowMain.className = "card-row-main";
        const title = document.createElement("div");
        title.className = "card-title";
        title.textContent = film.productName || "(ì œí’ˆëª… ì—†ìŒ)";

        const tag = document.createElement("div");
        tag.className = "card-tag";
        tag.textContent = film.filmNumber || "ë²ˆí˜¸ ì—†ìŒ";

        rowMain.appendChild(title);
        rowMain.appendChild(tag);
        content.appendChild(rowMain);

        const rowMethod = document.createElement("div");
        rowMethod.className = "card-row";
        rowMethod.innerHTML = '<span class="label">ì œíŒ íƒ€ì…</span>' + (film.method || "-");
        content.appendChild(rowMethod);

        const rowMesh = document.createElement("div");
        rowMesh.className = "card-row";
        rowMesh.innerHTML = '<span class="label">MESH</span>' + (film.mesh || "-");
        content.appendChild(rowMesh);

        const rowPlate = document.createElement("div");
        rowPlate.className = "card-row";
        rowPlate.innerHTML = '<span class="label">ì œíŒ ë°©ë²•</span>' + (film.plateInfo || "-");
        content.appendChild(rowPlate);

        const rowLoc = document.createElement("div");
        rowLoc.className = "card-row";
        rowLoc.innerHTML = '<span class="label">í•„ë¦„ ìœ„ì¹˜</span>' + (film.location || "-");
        content.appendChild(rowLoc);

        const rowReq = document.createElement("div");
        rowReq.className = "card-row";
        rowReq.innerHTML = '<span class="label">ìš”ì²­ ì¸ì‡„ì</span>' + (film.requestPrinter || "-");
        content.appendChild(rowReq);

        const footer = document.createElement("div");
        footer.className = "card-footer";

        const lastUsed = document.createElement("div");
        lastUsed.className = "last-used";
        lastUsed.textContent = "ë§ˆì§€ë§‰ ì‚¬ìš©ì¼: " + formatDate(film.lastUsed || "");
        footer.appendChild(lastUsed);

        const btnWrap = document.createElement("div");
        btnWrap.className = "card-buttons";

        const canEditFilms = (currentMode === MODE_ADMIN);
        const canViewOnly = (currentMode === MODE_VIEWER);

        if (canEditFilms){
          const useTodayBtn = document.createElement("button");
          useTodayBtn.className = "btn btn-secondary btn-small";
          useTodayBtn.textContent = "ì˜¤ëŠ˜ ì‚¬ìš©";
          useTodayBtn.addEventListener("click", async () => {
            const today = new Date().toISOString().slice(0,10);
            try{
              await db.collection(FILM_COLLECTION).doc(film.id).set({ lastUsed: today, updatedAt: Date.now() }, { merge:true });
              await addHistory("ì˜¤ëŠ˜ ì‚¬ìš©", { id: film.id, productName: film.productName, filmNumber: film.filmNumber }, ["ë§ˆì§€ë§‰ ì‚¬ìš©ì¼"]);
              showToast("ì˜¤ëŠ˜ ì‚¬ìš©ìœ¼ë¡œ ê¸°ë¡í–ˆì–´.");
            } catch(e){
              console.error(e);
              showToast("ì˜¤ëŠ˜ ì‚¬ìš© ê¸°ë¡ ì¤‘ ì˜¤ë¥˜.");
            }
          });
          btnWrap.appendChild(useTodayBtn);

          const editBtn = document.createElement("button");editBtn.className = "btn btn-secondary btn-small";
          editBtn.textContent = "ìˆ˜ì •";
          editBtn.addEventListener("click", () => openFormForEdit(film.id));
          btnWrap.appendChild(editBtn);

          const copyBtn = document.createElement("button");
          copyBtn.className = "btn btn-ghost btn-small";
          copyBtn.textContent = "ë³µì‚¬";
          copyBtn.addEventListener("click", () => openFormCopyFrom(film.id));
          btnWrap.appendChild(copyBtn);

          const memoBtn = document.createElement("button");
          memoBtn.className = "btn btn-ghost btn-small" + (safeStr(film.memo) ? " btn-memo-has" : "");
          memoBtn.textContent = "ë©”ëª¨";
          memoBtn.addEventListener("click", () => openMemoSheet(film.id));
          btnWrap.appendChild(memoBtn);

          const plateNewBtn = document.createElement("button");
          plateNewBtn.className = "btn btn-primary btn-small";
          plateNewBtn.textContent = "íŒ ë“±ë¡";
          plateNewBtn.addEventListener("click", () => openPlateFormFromFilm(film.id));
          btnWrap.appendChild(plateNewBtn);

          const delBtn = document.createElement("button");
          delBtn.className = "btn btn-danger btn-small";
          delBtn.textContent = "ì‚­ì œ";
          delBtn.addEventListener("click", async () => {
            if (!confirm("ì´ í•„ë¦„ì„ ì‚­ì œí• ê¹Œ? (ì—°ê²°ëœ íŒ ë°ì´í„°ëŠ” ë‚¨ì•„ìˆì„ ìˆ˜ ìˆì–´)")) return;
            try{
              await db.collection(FILM_COLLECTION).doc(film.id).delete();
              await addHistory("ì‚­ì œ", { id: film.id, productName: film.productName, filmNumber: film.filmNumber }, ["ì‚­ì œ"]);
              showToast("ì‚­ì œí–ˆì–´.");
            } catch(e){
              console.error(e);
              showToast("ì‚­ì œ ì¤‘ ì˜¤ë¥˜.");
            }
          });
          btnWrap.appendChild(delBtn);
        } else if (canViewOnly){
          const memoBtn = document.createElement("button");
          memoBtn.className = "btn btn-ghost btn-small";
          memoBtn.textContent = "ë©”ëª¨";
          memoBtn.addEventListener("click", () => openMemoSheet(film.id));
          btnWrap.appendChild(memoBtn);

          const plateHint = document.createElement("button");
          plateHint.className = "btn btn-secondary btn-small";
          plateHint.textContent = "ì—°ê²° íŒ ë³´ê¸°";
          plateHint.addEventListener("click", () => {
            currentTab = "plates";
            setActiveTabUI();
            const si = document.getElementById("searchInput");
            if (si) si.value = (film.filmNumber || "");
            currentSearchText = (film.filmNumber || "");
            renderPlatesList(currentSearchText);
          });
          btnWrap.appendChild(plateHint);
        }

        footer.appendChild(btnWrap);
        content.appendChild(footer);
        card.appendChild(content);

        listEl.appendChild(card);
      });

      applyViewMode();
    }

    /* ---------- ì¸ì‡„ê¸°ì‚¬ ëª©ë¡ (íŒŒì´ì–´ë² ì´ìŠ¤ ê³µìœ ) ---------- */
    async function loadPrinterList(){
      try{
        const ref = db.collection(CONFIG_COLLECTION).doc("printers");
        const snap = await ref.get();
        if (!snap.exists){
          await ref.set({ names: ["ìµœì„±ê·œ"], updatedAt: Date.now() }, { merge:true });
          return ["ìµœì„±ê·œ"];
        }
        const data = snap.data() || {};
        const names = Array.isArray(data.names) ? data.names : [];
        return names.length ? names : ["ìµœì„±ê·œ"];
      } catch(e){
        console.error("ì¸ì‡„ê¸°ì‚¬ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:", e);
        return ["ìµœì„±ê·œ"];
      }
    }

    async function savePrinterList(names){
      const clean = (names || [])
        .map(s => safeStr(s))
        .filter(Boolean)
        .filter((v,i,arr) => arr.indexOf(v) === i);
      await db.collection(CONFIG_COLLECTION).doc("printers").set({ names: clean, updatedAt: Date.now() }, { merge:true });
    }

    async function fillPrinterSelect(selectEl){
      const names = await loadPrinterList();
      selectEl.innerHTML = "";
      names.forEach(n => {
        const opt = document.createElement("option");
        opt.value = n;
        opt.textContent = n;
        selectEl.appendChild(opt);
      });
    }

    async function refreshPrinterManagerUI(){
      const wrap = document.getElementById("printerListWrap");
      if (!wrap) return;
      wrap.innerHTML = "";
      const names = await loadPrinterList();
      names.forEach((n) => {
        const chip = document.createElement("button");
        chip.type = "button";
        chip.className = "btn btn-ghost btn-small";
        chip.textContent = `âœ– ${n}`;
        chip.addEventListener("click", async () => {
          if (!confirm(`"${n}" ì‚­ì œí• ê¹Œ?`)) return;
          const cur = await loadPrinterList();
          await savePrinterList(cur.filter(x => x !== n));
          await refreshPrinterManagerUI();
          showToast("ëª©ë¡ ì—…ë°ì´íŠ¸ë¨.");
        });
        wrap.appendChild(chip);
      });
    }

    /* ---------- íŒ í¼ ---------- */
    /* ---------- íŒ í¼ (ì¬í™œìš© ë¡œì§ í¬í•¨) ---------- */
    
    /* ---------- íŒ í¼ (ì¬í™œìš© + ì„¤ì • íŒì—… ë¡œì§) ---------- */
    
    let reuseTarget = null; // ì¬ì‚¬ìš©í•  ëŒ€ìƒ ì„ì‹œ ì €ì¥ìš©

    /* [1] íŒ ë“±ë¡ ë²„íŠ¼ í´ë¦­ */
    function openPlateFormFromFilm(filmId){
      if (currentMode !== MODE_ADMIN) return;
      const film = films.find(f => f.id === filmId);
      if (!film) return;

      const emptyPlates = plates.filter(p => p.status === 'empty');

      if (emptyPlates.length === 0) {
        openNewPlateForm(film); 
      } else {
        showEmptyPlatePicker(film, emptyPlates);
      }
    }

    /* [2] ë¹ˆ íŒ ëª©ë¡ ë³´ì—¬ì£¼ê¸° */
    function showEmptyPlatePicker(film, emptyList) {
      const modal = document.getElementById("emptyPlateModal");
      const listEl = document.getElementById("emptyPlateList");
      const newBtn = document.getElementById("btnMakeNewPlate");

      listEl.innerHTML = "";
      emptyList.forEach(p => {
        const row = document.createElement("div");
        row.style.padding = "8px"; row.style.borderBottom = "1px solid #f0f0f0"; row.style.cursor = "pointer";
        row.style.fontSize = "13px"; row.style.display = "flex"; row.style.justifyContent = "space-between";
        
        const isSameMesh = (p.mesh == film.mesh);
        const meshStyle = isSameMesh ? "color:var(--primary-1);font-weight:bold" : "color:#999";
        
        row.innerHTML = `<div><strong>${p.plateNumber}</strong> <span style="${meshStyle}">(${p.mesh||"-"}ëª©)</span></div><div style="font-size:11px;color:#777">ëˆ„ì : ${(p.totalUsedQty||0).toLocaleString()}</div>`;
        
        // â˜… í´ë¦­ ì‹œ ë°”ë¡œ ì €ì¥ì´ ì•„ë‹ˆë¼ 'ì„¤ì • íŒì—…'ì„ ë„ì›€
        row.onclick = () => openReuseModal(film, p);
        listEl.appendChild(row);
      });

      newBtn.onclick = () => { modal.style.display = "none"; openNewPlateForm(film); };
      closeAllPanels();
      modal.style.display = "flex";
    }

    /* [3] ì¬ì‚¬ìš© ì„¤ì • íŒì—… ì—´ê¸° (í…ì…˜/ìˆ˜ëŸ‰ ì…ë ¥) */
    function openReuseModal(film, plate) {
      document.getElementById("emptyPlateModal").style.display = "none"; // ëª©ë¡ ì°½ ë‹«ê¸°
      
      reuseTarget = { film, plate }; // ëŒ€ìƒ ì €ì¥
      
      document.getElementById("reuseModalTitle").textContent = `${plate.plateNumber} íŒì„ ë‹¤ì‹œ ì‚¬ìš©í• ê²Œ.`;
      document.getElementById("reuseTension").value = ""; // í…ì…˜ì€ ë§¤ë²ˆ ìƒˆë¡œ ì…ë ¥
      document.getElementById("reuseMaxQty").value = "5000"; // ê¸°ë³¸ê°’
      
      document.getElementById("reuseModal").style.display = "flex"; // ì„¤ì • ì°½ ì—´ê¸°
    }

    /* [4] ìµœì¢… ì €ì¥ (ì„¤ì •ê°’ ì ìš©) */
    document.getElementById("btnConfirmReuse").onclick = async () => {
      if(!reuseTarget) return;
      const { film, plate } = reuseTarget;
      const tension = safeStr(document.getElementById("reuseTension").value);
      const maxQty = Number(document.getElementById("reuseMaxQty").value);

      try {
        await db.collection(PLATE_COLLECTION).doc(plate.id).set({
          status: 'active',
          filmId: film.id, 
          productName: film.productName, 
          filmNumber: film.filmNumber,
          tension: tension,   // â˜… ì…ë ¥í•œ í…ì…˜ ì ìš©
          maxQty: maxQty,     // â˜… ì…ë ¥í•œ ìµœëŒ€ìˆ˜ëŸ‰ ì ìš©
          usedQty: 0, 
          updatedAt: Date.now()
        }, { merge: true });
        
        await addHistory("ì¬ì‚¬ìš©", { id: plate.id, plateNumber: plate.plateNumber, productName: film.productName }, ["ë¹ˆ íŒ ì¬í• ë‹¹", `í…ì…˜: ${tension}`]);
        
        document.getElementById("reuseModal").style.display = "none";
        showToast("íŒ ì„¸íŒ… ì™„ë£Œ! ì‘ì—… ì‹œì‘í•´.");
      } catch(e) { console.error(e); showToast("ì˜¤ë¥˜ ë°œìƒ"); }
    };

    /* [5] ìƒˆ íŒ ë“±ë¡ í¼ (ê¸°ì¡´ ìœ ì§€) */
    function openNewPlateForm(film) {
      document.getElementById("plateId").value = "";
      document.getElementById("plateFilmId").value = film.id;
      document.getElementById("plateProductName").value = film.productName || "";
      document.getElementById("plateFilmNumber").value = film.filmNumber || "";
      
      const meshVal = film.mesh || "";
      document.getElementById("plateMesh").value = meshVal;
      document.getElementById("plateNumber").value = meshVal ? `${meshVal}-1` : `PLATE-1`; 

      document.getElementById("plateTension").value = "";
      document.getElementById("plateLocation").value = "";
      document.getElementById("plateMaxQty").value = 5000;

      document.getElementById("plateFormCard").style.display = "block";
      document.getElementById("plateNumber").focus();
    }

    function closePlateForm(){
      document.getElementById("plateFormCard").style.display = "none";
      ["plateId","plateFilmId","plateProductName","plateFilmNumber","plateNumber","plateTension","plateLocation","plateMesh"].forEach(id => document.getElementById(id).value = "");
      document.getElementById("plateMaxQty").value = 5000;
    }

    /* [ìˆ˜ì •] íŒ ì €ì¥ (í‰ìƒ ëˆ„ì  ë³€ìˆ˜ ì´ˆê¸°í™” í¬í•¨) */
    async function savePlate(e){
      e.preventDefault();
      if (currentMode !== MODE_ADMIN) return;

      const id = safeStr(document.getElementById("plateId").value);
      const filmId = safeStr(document.getElementById("plateFilmId").value);
      const pn = safeStr(document.getElementById("plateProductName").value);
      const fn = safeStr(document.getElementById("plateFilmNumber").value);
      const plateNumber = safeStr(document.getElementById("plateNumber").value);
      const tension = safeStr(document.getElementById("plateTension").value);
      const location = safeStr(document.getElementById("plateLocation").value);
      const mesh = safeStr(document.getElementById("plateMesh").value);
      const maxQty = Number(document.getElementById("plateMaxQty").value || 5000);

      if (!plateNumber){ showToast("íŒ ë²ˆí˜¸ëŠ” í•„ìˆ˜ì•¼."); return; }

      const payload = {
        filmId, productName: pn, filmNumber: fn, plateNumber,
        tension, location, mesh, maxQty: maxQty > 0 ? maxQty : 5000,
        updatedAt: Date.now(),
      };
      
      if (!id) {
        payload.createdAt = Date.now();
        payload.usedQty = 0;      
        payload.totalUsedQty = 0; 
        payload.status = pn ? 'active' : 'empty';
      }

      try{
        if (id){
          await db.collection(PLATE_COLLECTION).doc(id).set(payload, { merge:true });
          await addHistory("íŒ ìˆ˜ì •", { id, productName: pn, filmNumber: fn, plateNumber }, ["íŒ ìˆ˜ì •"]);
          showToast("ìˆ˜ì • ì €ì¥ë¨.");
        } else {
          const ref = await db.collection(PLATE_COLLECTION).add(payload);
          await addHistory("íŒ ë“±ë¡", { id: ref.id, productName: pn, filmNumber: fn, plateNumber }, ["íŒ ë“±ë¡"]);
          showToast("ë“±ë¡ë¨.");
        }
        closePlateForm();
      } catch(e){ console.error(e); showToast("ì˜¤ë¥˜ ë°œìƒ"); }
    }

    /* ---------- íŒ ì‚¬ìš©ë“±ë¡ / íˆìŠ¤í† ë¦¬ ---------- */
     /* [ìˆ˜ì • 2ë‹¨ê³„] ë±ƒì§€ìš© ë¹„ìœ¨ ê³„ì‚° (í˜„ì¬ ì‘ì—… ìˆ˜ëŸ‰ ê¸°ì¤€) */
    /* [ìˆ˜ì •] ì‚¬ìš©ëŸ‰ ë¹„ìœ¨ ê³„ì‚° (ì´ë²ˆ ì‘ì—… ëª©í‘œëŸ‰ ê¸°ì¤€) */
    function getPlateUsedRatio(plate){
      // ë±ƒì§€ ìƒ‰ê¹”ê³¼ %ëŠ” 'í˜„ì¬ ì‘ì—… ìˆ˜ëŸ‰(usedQty)' vs 'ìµœëŒ€ ìˆ˜ëŸ‰(maxQty)' ìœ¼ë¡œ ê³„ì‚°
      const current = Number(plate?.usedQty || 0);
      const max = Number(plate?.maxQty || 5000);
      
      if (!max) return { pct: 0, used: current, max };
      
      const pct = (current / max) * 100;
      return { pct, used: current, max };
    }
  // âœ… 4) ì‚¬ìš©ëŸ‰ ë±ƒì§€(ì ì •/ìœ ì˜/ì£¼ì˜/ê²½ê³ ) + ìƒ‰ í´ë˜ìŠ¤ ì¶”ê°€
  function getUsageBadgeInfo(plate){
      const { pct } = getPlateUsedRatio(plate);
      // í¼ì„¼íŠ¸ì— ë”°ë¼ ë±ƒì§€ ìƒ‰ê¹” ê²°ì •
      if (pct > 100) return { label: "ì´ˆê³¼", show: true, cls: "over" };
      if (pct >= 90) return { label: "ì£¼ì˜", show: true, cls: "danger" };
      if (pct >= 70) return { label: "ìœ ì˜", show: true, cls: "warn" };
      return { label: "ì ì •", show: true, cls: "ok" };
        }

    function openPlateUseSheet(plateId){
      if (currentMode !== MODE_ADMIN && currentMode !== MODE_PRINTER) return;

      const plate = plates.find(p => p.id === plateId);
      if (!plate) return;
      currentPlateUseId = plateId;

      const sheet = document.getElementById("plateUseSheet");
      const meta = document.getElementById("plateUseMeta");
      const title = document.getElementById("plateUseTitle");
      const sub = document.getElementById("plateUseSub");
      const qtyInput = document.getElementById("plateUseQty");
      const memoInput = document.getElementById("plateUseMemo");
      const whoSelect = document.getElementById("plateUseWho");

      if (title) title.textContent = `íŒ ì‚¬ìš©ë“±ë¡ Â· ${plate.plateNumber || ""}`;
      if (sub) sub.textContent = "ì‹œê°„ì€ ìë™ ê¸°ë¡";

      if (qtyInput) qtyInput.value = "";
      if (memoInput) memoInput.value = "";

      // âœ… 2) í•„ë¦„ ë“±ë¡ì˜ ìš”ì²­ì¸ì‡„ì ë°©ì‹ì²˜ëŸ¼: íŒŒì´ì–´ë² ì´ìŠ¤ ê³µìœ  ëª©ë¡ select ì±„ìš°ê¸°
      if (whoSelect) fillPrinterSelect(whoSelect);

      // meta í‘œì‹œ
      if (meta){
        const r = getPlateUsedRatio(plate);
        const pct = Math.round(r.pct);
        meta.innerHTML = "";
        const chip1 = document.createElement("div");
        chip1.className = "usage-chip";
        chip1.textContent = `ì œí’ˆ: ${plate.productName || "-"}`;
        const chip2 = document.createElement("div");
        chip2.className = "usage-chip";
        chip2.textContent = `í•„ë¦„: ${plate.filmNumber || "-"}`;
        const chip3 = document.createElement("div");
        chip3.className = "progress-pill";
        chip3.textContent = `ì‚¬ìš©ëŸ‰: ${r.used}/${r.max} (${isFinite(pct)?pct:0}%)`;
        meta.appendChild(chip1);
        meta.appendChild(chip2);
        meta.appendChild(chip3);
      }

      sheet.classList.add("show");
    }

    function closePlateUseSheet(){
      const sheet = document.getElementById("plateUseSheet");
      if (sheet) sheet.classList.remove("show");
      currentPlateUseId = null;
    }

   /* [ìˆ˜ì • 3ë‹¨ê³„] ì‚¬ìš©ë“±ë¡ ì €ì¥ (í˜„ì¬ìˆ˜ëŸ‰ + í‰ìƒìˆ˜ëŸ‰ ë™ì‹œ ì¦ê°€) */
    async function savePlateUse(){
      if (!currentPlateUseId) return;
      if (currentMode !== MODE_ADMIN && currentMode !== MODE_PRINTER) return;

      const plate = plates.find(p => p.id === currentPlateUseId);
      if (!plate) return;

      const who = safeStr(document.getElementById("plateUseWho").value);
      const qty = Number(document.getElementById("plateUseQty").value || 0);
      const memo = safeStr(document.getElementById("plateUseMemo").value);

      if (!who){ showToast("ì¸ì‡„ê¸°ì‚¬ë¥¼ ì„ íƒí•´ì¤˜."); return; }
      if (!qty || qty <= 0){ showToast("ì¸ì‡„ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì¤˜."); return; }

      const entry = { who, qty, memo, timestamp: Date.now(), deviceName: getDeviceLabel() || "" };

      try{
        const plateRef = db.collection(PLATE_COLLECTION).doc(plate.id);
        const usageRef = plateRef.collection(PLATE_USAGE_SUB);

        await db.runTransaction(async (tx) => {
          const snap = await tx.get(plateRef);
          const cur = snap.exists ? (snap.data() || {}) : {};
          
          const curCurrent = Number(cur.usedQty || 0);
          // í‰ìƒ ëˆ„ì ëŸ‰ì´ ì—†ìœ¼ë©´(ì˜›ë‚  ë°ì´í„°) í˜„ì¬ ìˆ˜ëŸ‰ê³¼ ê°™ë‹¤ê³  ê°€ì •
          const curTotal = (cur.totalUsedQty !== undefined) ? Number(cur.totalUsedQty) : curCurrent;

          tx.set(plateRef, { 
            usedQty: curCurrent + qty,      // í˜„ì¬ ì‘ì—… ëˆ„ì 
            totalUsedQty: curTotal + qty,   // í‰ìƒ ëˆ„ì  (ê³„ì† ìŒ“ì„)
            updatedAt: Date.now() 
          }, { merge:true });
          
          const newUsageDoc = usageRef.doc();
          tx.set(newUsageDoc, entry);
        });

        showToast("ì‚¬ìš©ë“±ë¡ ì €ì¥ë¨.");
        closePlateUseSheet();
      } catch(e){
        console.error(e);
        showToast("ì‚¬ìš©ë“±ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜.");
      }
    }
	/* [ì¶”ê°€ 4ë‹¨ê³„] íŒ íƒˆë§‰(ì´ˆê¸°í™”) ê¸°ëŠ¥ */
   /* [ìˆ˜ì •] íƒˆë§‰ ê¸°ëŠ¥ (ìƒì„¸ ê¸°ë¡ ì €ì¥) */
   /* [ìˆ˜ì •] íƒˆë§‰ ê¸°ëŠ¥ (ì „ì²´ íˆìŠ¤í† ë¦¬ + ê°œë³„ íŒ íˆìŠ¤í† ë¦¬ ëª¨ë‘ ê¸°ë¡) */
    async function reclaimPlate(plate) {
      if(!confirm(`[íƒˆë§‰] ${plate.plateNumber} íŒì„ ì´ˆê¸°í™”í• ê¹Œ?\ní˜„ì¬ ìˆ˜ëŸ‰ì€ 0ì´ ë˜ì§€ë§Œ, ì´ ëˆ„ì ì€ ìœ ì§€ë¼.`)) return;
      
      try {
        // 1. ê¸°ë¡í•  í…ìŠ¤íŠ¸ ë§Œë“¤ê¸° (ì œí’ˆëª… + í…ì…˜)
        const info = `[${plate.productName||"ì œí’ˆì—†ìŒ"}] ì‘ì—…ì¢…ë£Œ (í…ì…˜: ${plate.tension||"-"})`;

        // 2. íŒ ìƒíƒœ ì´ˆê¸°í™” (DB ì—…ë°ì´íŠ¸)
        await db.collection(PLATE_COLLECTION).doc(plate.id).set({
          status: 'empty',
          filmId: null, productName: null, filmNumber: null,
          usedQty: 0, updatedAt: Date.now()
        }, { merge: true });
        
        // 3. â˜… [ì¶”ê°€ëœ ê¸°ëŠ¥] ê°œë³„ íŒ íˆìŠ¤í† ë¦¬(Usage)ì— 'íƒˆë§‰ ê¸°ë¡' ë‚¨ê¸°ê¸°
        // (ì´ê²Œ ë“¤ì–´ê°€ì•¼ íŒë³„ íˆìŠ¤í† ë¦¬ì—ì„œë„ ë³´ì…ë‹ˆë‹¤!)
        await db.collection(PLATE_COLLECTION).doc(plate.id).collection(PLATE_USAGE_SUB).add({
            who: "ì‹œìŠ¤í…œ(íƒˆë§‰)",  // ëˆ„ê°€
            qty: 0,              // ìˆ˜ëŸ‰ (0)
            memo: info,          // ë‚´ìš© (ì œí’ˆëª…+í…ì…˜)
            timestamp: Date.now(),
            deviceName: getDeviceLabel() || ""
        });

        // 4. ì „ì²´ íˆìŠ¤í† ë¦¬ì— ê¸°ë¡ (ê¸°ì¡´ ê¸°ëŠ¥)
        await addHistory("íƒˆë§‰", { 
          id: plate.id, plateNumber: plate.plateNumber, productName: plate.productName 
        }, ["ì´ˆê¸°í™”", info]);
        
        showToast("íƒˆë§‰ ì™„ë£Œ! ê°œë³„ ê¸°ë¡ì—ë„ ì €ì¥ëì–´.");
      } catch(e) {
        console.error(e);
        showToast("ì˜¤ë¥˜ ë°œìƒ");
      }
    }
        

   /* [ìˆ˜ì •] íŒ íˆìŠ¤í† ë¦¬ (ìˆ˜ëŸ‰ ë§‰ëŒ€ + í…ì…˜ êº¾ì€ì„  ê·¸ë˜í”„ ì ìš©) */
    let myChart = null; // ì°¨íŠ¸ ë‹´ì„ ê·¸ë¦‡

    async function openPlateHistorySheet(plateId){
      const plate = plates.find(p => p.id === plateId);
      if (!plate) return;
      currentPlateHistoryId = plateId;

      const sheet = document.getElementById("plateHistorySheet");
      const list = document.getElementById("plateUsageList");
      const meta = document.getElementById("plateHistoryMeta");

      // 1. ì œëª© ë° ìƒë‹¨ ì •ë³´
      document.getElementById("plateHistoryTitle").textContent = `íŒ íˆìŠ¤í† ë¦¬ Â· ${plate.plateNumber}`;
      
      if(meta) {
         const r = getPlateUsedRatio(plate);
         meta.innerHTML = `<div class="usage-chip">${plate.productName||"-"}</div><div class="progress-pill">í˜„ì¬ í…ì…˜: ${plate.tension||"-"}</div>`;
      }

      // 2. ê·¸ë˜í”„ ì˜ì—­ ë§Œë“¤ê¸° (ì—†ìœ¼ë©´ ìƒì„±, ë¦¬ìŠ¤íŠ¸ ìœ„ì— ì‚½ì…)
      // ê¸°ì¡´ì— ì°¨íŠ¸ ìº”ë²„ìŠ¤ê°€ ì—†ìœ¼ë©´ ì—¬ê¸°ì„œ ê°•ì œë¡œ ë§Œë“­ë‹ˆë‹¤.
      let chartContainer = sheet.querySelector(".chart-container");
      if(!chartContainer) {
          chartContainer = document.createElement("div");
          chartContainer.className = "chart-container";
          chartContainer.style.cssText = "padding:10px; background:#f8f9fa; border-radius:12px; margin-bottom:10px; border:1px solid #eee;";
          chartContainer.innerHTML = '<canvas id="plateUsageChart" style="width:100%; height:180px;"></canvas>';
          // ë¦¬ìŠ¤íŠ¸(plateUsageList) ë°”ë¡œ ìœ„ì— ë¼ì›Œë„£ê¸°
          if(list) list.parentNode.insertBefore(chartContainer, list);
      }

      if (list) list.innerHTML = "<div style='padding:20px;text-align:center;color:#999'>ë°ì´í„° ë¡œë”© ì¤‘...</div>";

      try {
        // 3. ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ìµœê·¼ 30ê°œ)
        const snap = await db.collection(PLATE_COLLECTION).doc(plate.id)
          .collection(PLATE_USAGE_SUB).orderBy("timestamp", "desc").limit(30).get();
        
        const rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));

        // 4. ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ê¸°
        if (list) list.innerHTML = "";
        if (!rows.length && list) list.innerHTML = "<div class='history-empty'>ê¸°ë¡ì´ ì—†ì–´.</div>";
        
        rows.forEach(r => {
            const div = document.createElement("div");
            div.className = "usage-row";
            div.innerHTML = `<div class="u-top"><div class="u-who">${r.who||"-"}</div><div class="u-time">${formatTs(r.timestamp)}</div></div>
                             <div style="margin-top:4px">ìˆ˜ëŸ‰: <b>${(r.qty||0).toLocaleString()}</b> <span style="color:#888;font-size:11px;margin-left:8px">${r.memo||""}</span></div>`;
            list.appendChild(div);
        });

        // 5. â˜… ì°¨íŠ¸ ê·¸ë¦¬ê¸° (í•µì‹¬!)
        const ctx = document.getElementById('plateUsageChart');
        if(ctx) {
          if(myChart) myChart.destroy(); // ê¸°ì¡´ ì°¨íŠ¸ ì‚­ì œ (ì•ˆ í•˜ë©´ ê²¹ì³ ë³´ì„)
          
          // ì‹œê°„ ìˆœì„œëŒ€ë¡œ ë’¤ì§‘ê¸° (ê³¼ê±° -> í˜„ì¬)
          const chartData = rows.slice().reverse();
          
          const labels = chartData.map(d => { 
             const dt = new Date(d.timestamp); 
             return `${dt.getMonth()+1}/${dt.getDate()}`; 
          });
          
          const qtyData = chartData.map(d => d.qty || 0);
          
          // [ì¤‘ìš”] ë©”ëª¨ì—ì„œ 'í…ì…˜: ìˆ«ì' ë˜ëŠ” 'í…ì…˜ ìˆ«ì'ë¥¼ ì°¾ì•„ì„œ ë½‘ì•„ëƒ„
          const tensionData = chartData.map(d => {
             const txt = d.memo || "";
             const match = txt.match(/í…ì…˜[:\s]*([\d\.]+)/); // "í…ì…˜ 23" ë˜ëŠ” "í…ì…˜: 23.5" ì°¾ê¸°
             return match ? parseFloat(match[1]) : null;
          });

          myChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [
                { 
                  label: 'ì‘ì—… ìˆ˜ëŸ‰', 
                  data: qtyData, 
                  backgroundColor: 'rgba(127, 157, 255, 0.5)', 
                  yAxisID: 'y', 
                  order: 2 
                },
                { 
                  type: 'line', 
                  label: 'í…ì…˜', 
                  data: tensionData, 
                  borderColor: '#ff6b81', // ë¹¨ê°„ìƒ‰ ì„ 
                  backgroundColor: '#ff6b81', 
                  borderWidth: 2, 
                  pointRadius: 4, 
                  spanGaps: true, // ì¤‘ê°„ì— ê°’ ì—†ì–´ë„ ì„  ì´ì–´ì£¼ê¸°
                  yAxisID: 'y1', 
                  order: 1 
                }
              ]
            },
            options: {
              responsive: true, 
              maintainAspectRatio: false,
              interaction: { mode: 'index', intersect: false },
              scales: {
                y: { beginAtZero: true, display: false }, // ì™¼ìª½ ì¶•(ìˆ˜ëŸ‰) ìˆ¨ê¹€
                y1: { 
                    type: 'linear', 
                    display: true, 
                    position: 'right', 
                    grid: { drawOnChartArea: false }, 
                    min: 10, // í…ì…˜ ê·¸ë˜í”„ ë²”ìœ„ ì„¤ì • (ì˜ˆì˜ê²Œ ë³´ì´ê²Œ)
                    title: { display: true, text: 'í…ì…˜' } 
                },
                x: { grid: { display: false } }
              }
            }
          });
        }
        sheet.classList.add("show");

      } catch(e){ console.error(e);
        showToast("íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨");
      }
    }

    function closePlateHistorySheet(){
      const sheet = document.getElementById("plateHistorySheet");
      if (sheet) sheet.classList.remove("show");
      currentPlateHistoryId = null;
    }

    /* ---------- íŒ ë¦¬ìŠ¤íŠ¸ ---------- */
    /* [ìˆ˜ì • 5ë‹¨ê³„] íŒ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (íŒ ë²ˆí˜¸ ë©”ì¸ + íƒˆë§‰/íê¸° + ì´ëˆ„ì ) */
  /* [ìˆ˜ì •] ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (ì´ ëˆ„ì ì€ ìˆ«ìë§Œ í‘œì‹œ) */
   /* [ìˆ˜ì •] ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (ëŒ€ì‹œë³´ë“œ í•„í„° ì ìš©ë¨) */
    function renderPlatesList(filterText = ""){
      const listEl = document.getElementById("list");
      const emptyText = document.getElementById("emptyText");
      if (!listEl || !emptyText) return;

      listEl.innerHTML = "";
      currentSearchText = filterText || "";

      const text = safeStr(filterText).toLowerCase();

      // 1. í…ìŠ¤íŠ¸ ê²€ìƒ‰ í•„í„°
      let filtered = plates.filter(p => {
        if (!text) return true;
        const combined = (p.plateNumber||"")+(p.productName||"")+(p.filmNumber||"")+(p.tension||"")+(p.location||"")+(p.mesh||"");
        return combined.toLowerCase().includes(text);
      });

      // 2. â˜… [ì¶”ê°€ë¨] ëŒ€ì‹œë³´ë“œ í´ë¦­ í•„í„° ì ìš©
      if(dashboardFilter === 'active'){
        // í™œì„± íŒë§Œ (statusê°€ emptyê°€ ì•„ë‹Œ ê²ƒ)
        filtered = filtered.filter(p => p.status !== 'empty');
      } 
      else if(dashboardFilter === 'empty'){
        // ë¹ˆ íŒë§Œ
        filtered = filtered.filter(p => p.status === 'empty');
      }
      else if(dashboardFilter === 'warn'){
        // ìˆ˜ëª… ì£¼ì˜ë§Œ (90% ì´ìƒ)
        filtered = filtered.filter(p => {
           if(p.status === 'empty') return false;
           const r = getPlateUsedRatio(p);
           return r.pct >= 90;
        });
      }

      // 3. ì •ë ¬
      const sortOpt = getSortOption();
      filtered.sort((a,b) => {
        if (sortOpt === "name") return (a.productName||"").localeCompare(b.productName||"", "ko");
        if (sortOpt === "number") return (a.plateNumber||"").localeCompare(b.plateNumber||"", "ko"); 
        return (b.updatedAt||0) - (a.updatedAt||0);
      });

      updateCountBar(filtered.length, plates.length, !!text || !!dashboardFilter);
      let toRender = (!text && !dashboardFilter) ? filtered.slice(0, visibleCount) : filtered;

      if (!filtered.length){ 
          emptyText.style.display = "block"; 
          if(dashboardFilter) emptyText.textContent = "í•´ë‹¹í•˜ëŠ” íŒì´ ì—†ì–´.";
          else emptyText.textContent = "ë“±ë¡ëœ íŒì´ ì—†ì–´.";
          return; 
      } else { 
          emptyText.style.display = "none"; 
      }

      toRender.forEach((plate) => {
        // ... (ì´ ì•„ë˜ ì¹´ë“œ ê·¸ë¦¬ëŠ” ì½”ë“œëŠ” ê¸°ì¡´ê³¼ ë™ì¼í•©ë‹ˆë‹¤. ê·¸ëŒ€ë¡œ ë‘ì…”ë„ ë˜ê³  ë³µë¶™í•˜ì…”ë„ ë©ë‹ˆë‹¤) ...
        const card = document.createElement("div"); card.className = "card";
        const isEmpty = (plate.status === 'empty');
        const r = getPlateUsedRatio(plate); 

        const badge = document.createElement("div");
        if(isEmpty) {
             badge.className = "warn-badge ok show"; badge.textContent = "ë¹ˆ íŒ (ëŒ€ê¸°)";
             badge.style.background = "#f3f4f6"; badge.style.color = "#374151"; badge.style.border = "1px solid #d1d5db";
        } else {
             const b = getUsageBadgeInfo(plate);
             badge.className = `warn-badge ${b.cls} show`; badge.textContent = `${b.label} Â· ${Math.round(r.pct)}%`;
        }
        card.appendChild(badge);

        const content = document.createElement("div"); content.className = "card-content";
        let film = null;
        if (!isEmpty) film = films.find(f => f.id === plate.filmId) || films.find(f => f.filmNumber && f.filmNumber === plate.filmNumber);
        
        if (film && film.imageDataUrl) {
          const img = document.createElement("img"); img.src = film.imageDataUrl;
          img.style.width = "70px"; img.style.height = "70px"; img.style.objectFit = "cover"; img.style.borderRadius = "12px"; 
          img.style.flexShrink = "0"; img.style.marginRight="10px"; img.style.cursor = "pointer"; img.style.background = "#eef1ff";
          img.addEventListener("click", () => openImageViewer(film.imageDataUrl));
          card.appendChild(img);
        }
        card.appendChild(content);

        const pn = plate.plateNumber || "(ë²ˆí˜¸ ì—†ìŒ)";
        const pd = isEmpty ? "-" : (plate.productName || "ì œí’ˆëª… ì—†ìŒ");
        
        let html = `<div class="card-row-main">
                      <div style="display:flex;align-items:center;gap:6px">
                        <div class="card-title" style="font-size:17px">${pn}</div>
                        <button class="btn btn-ghost btn-small" style="padding:2px 6px;font-size:10px" onclick="showPlateQR('${pn}')">QR</button>
                      </div>
                      <div class="card-tag">${pd}</div>
                    </div>`;
        html += `<div class="card-row"><span class="label">MESH</span>${plate.mesh||"-"}</div>`;
        
        if(!isEmpty){
            html += `<div class="card-row"><span class="label">í•„ë¦„</span>${plate.filmNumber||"-"}</div>`;
            html += `<div class="card-row"><span class="label">í˜„ì¬ì‘ì—…</span><strong style="color:var(--primary-1)">${(plate.usedQty||0).toLocaleString()}</strong> / ${r.max.toLocaleString()}ì¥</div>`;
            html += `<div class="card-row"><span class="label">í…ì…˜</span>${plate.tension||"-"}</div>`;
            html += `<div class="card-row"><span class="label">ìœ„ì¹˜</span>${plate.location||"-"}</div>`;
        } else {
            html += `<div class="card-row"><span class="label">ìƒíƒœ</span><span style="color:#9ca3af">ëŒ€ê¸° ì¤‘ (ì‘ì—… ê°€ëŠ¥)</span></div>`;
        }
        content.innerHTML = html;

        const footer = document.createElement("div"); footer.className = "card-footer";
        const totalQty = (plate.totalUsedQty !== undefined) ? plate.totalUsedQty : (plate.usedQty || 0);
        footer.innerHTML = `<div class="last-used" style="color:#6b7280;font-weight:500">ì´ ëˆ„ì : <span style="color:${currentMode==='night'?'#fff':'#374151'}">${Number(totalQty).toLocaleString()}ì¥</span></div><div class="card-buttons"></div>`;
        content.appendChild(footer);

        const btnWrap = footer.querySelector(".card-buttons");
        // ë²„íŠ¼ ë¡œì§ (ê¸°ì¡´ê³¼ ë™ì¼)
        if (currentMode === MODE_PRINTER){
           if(!isEmpty) btnWrap.innerHTML += `<button class="btn btn-primary btn-small" onclick="openPlateUseSheet('${plate.id}')">ì‚¬ìš©ë“±ë¡</button>`;
           btnWrap.innerHTML += `<button class="btn btn-secondary btn-small" onclick="openPlateHistorySheet('${plate.id}')">íˆìŠ¤í† ë¦¬</button>`;
           btnWrap.innerHTML += `<button class="btn btn-ghost btn-small" onclick="openPlateMemoSheet('${plate.id}')">ë©”ëª¨</button>`;
        }
        else if (currentMode === MODE_VIEWER){
           btnWrap.innerHTML += `<button class="btn btn-secondary btn-small" onclick="openPlateHistorySheet('${plate.id}')">íˆìŠ¤í† ë¦¬</button>`;
           btnWrap.innerHTML += `<button class="btn btn-ghost btn-small" onclick="openPlateMemoSheet('${plate.id}')">ë©”ëª¨</button>`;
        }
        else if (currentMode === MODE_ADMIN){
          if(!isEmpty){
              btnWrap.innerHTML += `<button class="btn btn-primary btn-small" onclick="openPlateUseSheet('${plate.id}')">ì‚¬ìš©</button>`;
              const recBtn = document.createElement("button"); recBtn.className = "btn btn-secondary btn-small";
              recBtn.style.background = "#fef08a"; recBtn.style.color = "#854d0e"; recBtn.innerText = "âœ¨ íƒˆë§‰";
              recBtn.onclick = () => reclaimPlate(plate);
              btnWrap.appendChild(recBtn);
          }
          btnWrap.innerHTML += `<button class="btn btn-secondary btn-small" onclick="openPlateHistorySheet('${plate.id}')">ê¸°ë¡</button>`;
          btnWrap.innerHTML += `<button class="btn btn-ghost btn-small" onclick="openPlateMemoSheet('${plate.id}')">ë©”ëª¨</button>`;
          btnWrap.innerHTML += `<button class="btn btn-ghost btn-small" onclick="openPlateFormForEdit('${plate.id}')">ìˆ˜ì •</button>`;
          const delBtn = document.createElement("button"); delBtn.className = "btn btn-danger btn-small"; delBtn.innerText = "íê¸°";
          delBtn.onclick = async () => {
            if (!confirm(`[ì£¼ì˜] ${plate.plateNumber} íŒì„ íê¸°í• ê¹Œ?`)) return;
            await db.collection(PLATE_COLLECTION).doc(plate.id).delete();
            addHistory("íŒ íê¸°", { plateNumber: plate.plateNumber }, ["ì˜êµ¬ ì‚­ì œ"]);
            showToast("íê¸°ë¨");
          };
          btnWrap.appendChild(delBtn);
        }
        listEl.appendChild(card);
      });
      applyViewMode();
      updateDashboard();
    }
	/* [ì¶”ê°€] ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ */
    function updateDashboard(){
      // ê´€ë¦¬ìë‚˜ ì¸ì‡„ê¸°ì‚¬ë§Œ ë´„
      if(currentMode === MODE_VIEWER) {
        document.getElementById("dashboardSection").style.display = "none";
        return;
      }
      document.getElementById("dashboardSection").style.display = "grid";

      // 1. í™œì„± íŒ (ì œí’ˆì´ ê±¸ë ¤ìˆëŠ” íŒ)
      const activeCount = plates.filter(p => p.status !== 'empty').length;
      
      // 2. ë¹ˆ íŒ
      const emptyCount = plates.filter(p => p.status === 'empty').length;
      
      // 3. ìˆ˜ëª… ì£¼ì˜ (90% ì´ìƒ ì“´ íŒ)
      const warnCount = plates.filter(p => {
        if(p.status === 'empty') return false;
        const r = getPlateUsedRatio(p);
        return r.pct >= 90;
      }).length;

      document.getElementById("dashActive").textContent = activeCount + "ê°œ";
      document.getElementById("dashEmpty").textContent = emptyCount + "ê°œ";
      document.getElementById("dashWarn").textContent = warnCount + "ê°œ";
    }
    function renderCurrentTab(){
      if (currentTab === "films") renderList(currentSearchText);
      else renderPlatesList(currentSearchText);
    }

    /* ---------- ì„¤ì • ---------- */
    function openSettingsCard(){
      if (currentMode !== MODE_ADMIN) return;
      const card = document.getElementById("settingsCard");
      const isOpen = card.style.display === "block";
      closeAllPanels();
      if (!isOpen){
        card.style.display = "block";
        // í˜„ì¬ ê°’ ì„¸íŒ…
        const deviceInput = document.getElementById("deviceNameInput");
        if (deviceInput) deviceInput.value = getDeviceLabel();

        const sortSel = document.getElementById("sortOptionSelect");
        if (sortSel) sortSel.value = getSortOption();

        const themeSel = document.getElementById("themeSelect");
        if (themeSel) themeSel.value = getTheme();

        // ì¸ì‡„ê¸°ì‚¬ ëª©ë¡ ê´€ë¦¬ì UI ê°±ì‹ 
        refreshPrinterManagerUI().catch(()=>{});
      }
    }

    function closeSettingsCard(){
      const card = document.getElementById("settingsCard");
      if (card) card.style.display = "none";
    }

    async function saveSettingsCard(){
      if (currentMode !== MODE_ADMIN) return;

      const deviceInput = document.getElementById("deviceNameInput");
      const sortSel = document.getElementById("sortOptionSelect");
      const themeSel = document.getElementById("themeSelect");

      if (deviceInput) setDeviceLabel(safeStr(deviceInput.value));
      if (sortSel) setSortOption(sortSel.value);
      if (themeSel) setTheme(themeSel.value);

      // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
      const adminNew = safeStr(document.getElementById("pwAdminNew")?.value);
      const printerNew = safeStr(document.getElementById("pwPrinterNew")?.value);
      const viewerNew = safeStr(document.getElementById("pwViewerNew")?.value);
      const adminCur = safeStr(document.getElementById("pwAdminCurrent")?.value);

      // ì¼ë¶€ë§Œ ì…ë ¥í–ˆìœ¼ë©´ ê¸°ì¡´ ìœ ì§€
      const nextAdmin = adminNew || authConfig.adminPw;
      const nextPrinter = printerNew || authConfig.printerPw;
      const nextViewer = viewerNew || authConfig.viewerPw;

      // ë¹„ë²ˆ ë³€ê²½í•˜ë ¤ë©´ í˜„ì¬ ê´€ë¦¬ì ë¹„ë²ˆ í™•ì¸
      const wantsPwChange = !!(adminNew || printerNew || viewerNew);
      if (wantsPwChange){
        if (!adminCur || adminCur !== authConfig.adminPw){
          showToast("í˜„ì¬ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ë§ì§€ ì•Šì•„.");
          return;
        }
        try{
          await saveAuthConfig(nextAdmin, nextPrinter, nextViewer);
          showToast("ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ë¨.");
          document.getElementById("pwAdminNew").value = "";
          document.getElementById("pwPrinterNew").value = "";
          document.getElementById("pwViewerNew").value = "";
          document.getElementById("pwAdminCurrent").value = "";
        } catch(e){
          console.error(e);
          showToast("ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜.");
          return;
        }
      } else {
        showToast("ì„¤ì • ì €ì¥ë¨.");
      }

      closeSettingsCard();
      renderCurrentTab();
    }

    /* ---------- ì¸ì‡„ê¸°ì‚¬ ëª©ë¡ ê´€ë¦¬ ë²„íŠ¼ ---------- */
    async function onAddPrinter(){
      if (currentMode !== MODE_ADMIN) return;
      const input = document.getElementById("printerNameNew");
      const name = safeStr(input.value);
      if (!name){
        showToast("ì´ë¦„ì„ ì…ë ¥í•´ì¤˜.");
        return;
      }
      try{
        const cur = await loadPrinterList();
        cur.push(name);
        await savePrinterList(cur);
        input.value = "";
        await refreshPrinterManagerUI();
        showToast("ëª©ë¡ ì¶”ê°€ë¨.");
      } catch(e){
        console.error(e);
        showToast("ëª©ë¡ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜.");
      }
    }

    /* ---------- ë¡œê·¸ì¸/ì ê¸ˆ ---------- */
    function isUnlocked(){
      // âœ… 1) sessionStorage ê¸°ë°˜ ìœ ì§€ (ì°½ ë„ë©´ í’€ë¦¼)
      return sessionStorage.getItem(UNLOCK_KEY) === "1" && !!sessionStorage.getItem(UNLOCK_MODE_KEY);
    }

    function lock(){
      sessionStorage.removeItem(UNLOCK_KEY);
      sessionStorage.removeItem(UNLOCK_MODE_KEY);
      currentMode = null;

      document.getElementById("appContainer").style.display = "none";
      document.getElementById("lockScreen").style.display = "flex";
      const pwInput = document.getElementById("passwordInput");
      if (pwInput) pwInput.value = "";
    }

    function unlock(mode){
      sessionStorage.setItem(UNLOCK_KEY, "1");
      sessionStorage.setItem(UNLOCK_MODE_KEY, mode);

      currentMode = mode;
      document.getElementById("lockScreen").style.display = "none";
      document.getElementById("appContainer").style.display = "block";

      applyModeUI();
      setTheme(getTheme());
      applyViewMode();

      // ë¦¬ìŠ¤ë„ˆ ì‹œì‘
      startFilmsListener();
      startPlatesListener();
	  updateDashboard();

      // ê¸°ë³¸ íƒ­
      if (currentMode === MODE_PRINTER) currentTab = "plates";
      else currentTab = "films";
      setActiveTabUI();
    }

    async function handleLogin(){
      const pw = safeStr(document.getElementById("passwordInput").value);
      if (!pw) return;

      await loadAuthConfig();
      const mode = detectModeByPassword(pw);
      if (!mode){
        showToast("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ì–´.");
        return;
      }
      unlock(mode);

      // ê¸°ê¸° ì´ë¦„
      const label = getDeviceLabel();
      if (!label){
        // ìµœì´ˆ 1íšŒ ëª¨ë‹¬
        const modal = document.getElementById("deviceModal");
        modal.style.display = "flex";
      } else {
        setDeviceLabel(label);
      }
    }

    /* ---------- ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸° ---------- */
    async function exportData(){
      if (currentMode !== MODE_ADMIN) return;

      try{
        const filmsSnap = await db.collection(FILM_COLLECTION).get();
        const platesSnap = await db.collection(PLATE_COLLECTION).get();
        const historySnap = await db.collection(HISTORY_COLLECTION).orderBy("timestamp","desc").limit(100).get();
        const printers = await loadPrinterList();
        const authSnap = await db.collection(CONFIG_COLLECTION).doc(AUTH_DOC).get();
        const auth = authSnap.exists ? (authSnap.data()||{}) : {};

        const payload = {
          exportedAt: Date.now(),
          films: filmsSnap.docs.map(d => ({ id: d.id, ...d.data() })),
          plates: platesSnap.docs.map(d => ({ id: d.id, ...d.data() })),
          history: historySnap.docs.map(d => ({ id: d.id, ...d.data() })),
          config: {
            printers,
            auth: {
              adminPw: auth.adminPw || DEFAULT_ADMIN_PW,
              printerPw: auth.printerPw || DEFAULT_PRINTER_PW,
              viewerPw: auth.viewerPw || DEFAULT_VIEWER_PW,
            }
          }
        };

        const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `film-find-export-${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showToast("ë‚´ë³´ë‚´ê¸° ì™„ë£Œ.");
      } catch(e){
        console.error(e);
        showToast("ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜.");
      }
    }

    async function importDataFromFile(file){
      if (currentMode !== MODE_ADMIN) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);

        if (!confirm("ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ ì‹¤í–‰í• ê¹Œ? (í˜„ì¬ ë°ì´í„°ì— ë®ì–´ì“°ê¸°/ì¶”ê°€ë  ìˆ˜ ìˆì–´)")) return;

        const filmsArr = Array.isArray(data.films) ? data.films : [];
        const platesArr = Array.isArray(data.plates) ? data.plates : [];
        const historyArr = Array.isArray(data.history) ? data.history : [];
        const printersArr = Array.isArray(data?.config?.printers) ? data.config.printers : null;
        const authObj = data?.config?.auth || null;

        // films upsert
        for (const f of filmsArr){
          const id = safeStr(f.id);
          const copy = { ...f };
          delete copy.id;
          if (id) await db.collection(FILM_COLLECTION).doc(id).set(copy, { merge:true });
        }

        // plates upsert
        for (const p of platesArr){
          const id = safeStr(p.id);
          const copy = { ...p };
          delete copy.id;
          if (id) await db.collection(PLATE_COLLECTION).doc(id).set(copy, { merge:true });
        }

        // history upsert(ì„ íƒ)
        for (const h of historyArr){
          const id = safeStr(h.id);
          const copy = { ...h };
          delete copy.id;
          if (id) await db.collection(HISTORY_COLLECTION).doc(id).set(copy, { merge:true });
        }

        if (printersArr){
          await savePrinterList(printersArr);
        }
        if (authObj){
          await db.collection(CONFIG_COLLECTION).doc(AUTH_DOC).set({
            adminPw: authObj.adminPw || DEFAULT_ADMIN_PW,
            printerPw: authObj.printerPw || DEFAULT_PRINTER_PW,
            viewerPw: authObj.viewerPw || DEFAULT_VIEWER_PW,
            updatedAt: Date.now()
          }, { merge:true });
        }

        showToast("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ.");
      } catch(e){
        console.error(e);
        showToast("ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜.");
      }
    }

    /* ---------- ì´ë²¤íŠ¸ ë°”ì¸ë”© ---------- */
    function bindEvents(){
      // ì œíŒ ë°©ë²•(ì „ë©´/ë°°ë©´, ì¢Œ/ìš°, ìƒ/í•˜) í† ê¸€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
document.querySelectorAll('.toggle-group .toggle-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    // ê°™ì€ ê·¸ë£¹ ë‚´ì˜ ë‹¤ë¥¸ ë²„íŠ¼ë“¤ì˜ active í´ë˜ìŠ¤ë¥¼ ì œê±° (ë¼ë””ì˜¤ ë²„íŠ¼ ë°©ì‹)
    const group = this.closest('.toggle-group');
    group.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
    
    // í´ë¦­í•œ ë²„íŠ¼ì—ë§Œ active í´ë˜ìŠ¤ ì¶”ê°€
    this.classList.add('active');
  });
});
      // ë¡œê·¸ì¸
      document.getElementById("passwordBtn").addEventListener("click", handleLogin);
      document.getElementById("passwordInput").addEventListener("keydown", (e) => {
        if (e.key === "Enter") handleLogin();
      });

      // ê¸°ê¸° ëª¨ë‹¬
      document.getElementById("deviceModalSave").addEventListener("click", () => {
        const v = safeStr(document.getElementById("deviceModalInput").value);
        setDeviceLabel(v);
        document.getElementById("deviceModal").style.display = "none";
      });
      document.getElementById("deviceModalSkip").addEventListener("click", () => {
        setDeviceLabel(getDeviceLabel());
        document.getElementById("deviceModal").style.display = "none";
      });

      // ì´ë¯¸ì§€ ë·°ì–´
      document.getElementById("viewerBackdrop").addEventListener("click", closeImageViewer);
      document.getElementById("closeViewerBtn").addEventListener("click", closeImageViewer);

      // íƒ­
      document.getElementById("tabFilmsBtn").addEventListener("click", () => switchToTab("films"));
      document.getElementById("tabPlatesBtn").addEventListener("click", () => switchToTab("plates"));

      // ê²€ìƒ‰
      document.getElementById("searchInput").addEventListener("input", (e) => {
        currentSearchText = e.target.value;
        visibleCount = VISIBLE_STEP;
        renderCurrentTab();
      });

      // ë³´ê¸° ì „í™˜
      document.getElementById("viewToggleBtn").addEventListener("click", () => {
        setViewMode(currentViewMode === "gallery" ? "list" : "gallery");
      });

      // ìƒˆ í•„ë¦„
      document.getElementById("newFilmBtn").addEventListener("click", toggleFormNew);

      // ì„¤ì •/íˆìŠ¤í† ë¦¬
      document.getElementById("settingsBtn").addEventListener("click", openSettingsCard);
      document.getElementById("closeSettingsBtn").addEventListener("click", closeSettingsCard);
      document.getElementById("saveSettingsBtn").addEventListener("click", saveSettingsCard);

      document.getElementById("historyBtn").addEventListener("click", openHistoryCard);
      document.getElementById("closeHistoryBtn").addEventListener("click", closeHistoryCard);

      // ì¸ì‡„ê¸°ì‚¬ ëª©ë¡ ì¶”ê°€
      const addPrinterBtn = document.getElementById("addPrinterBtn");
      if (addPrinterBtn) addPrinterBtn.addEventListener("click", onAddPrinter);

      // ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸°
     document.getElementById("exportBtn").textContent = "ì—‘ì…€ ì €ì¥"; // ë²„íŠ¼ ì´ë¦„ë„ ë³€ê²½
document.getElementById("exportBtn").onclick = downloadExcelReport;
      document.getElementById("importBtn").addEventListener("click", () => document.getElementById("importFile").click());
      document.getElementById("importFile").addEventListener("change", (e) => {
        const file = e.target.files?.[0];
        if (file) importDataFromFile(file);
        e.target.value = "";
      });

      // í•„ë¦„ í¼
      document.getElementById("filmForm").addEventListener("submit", saveFilm);
      document.getElementById("cancelBtn").addEventListener("click", closeForm);
      document.getElementById("setTodayBtn").addEventListener("click", () => {
        document.getElementById("lastUsed").value = new Date().toISOString().slice(0,10);
      });

      // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° íšŒì „
      document.getElementById("imageInput").addEventListener("change", async (e) => {
        const file = e.target.files?.[0];
        if (!file){
          resetImagePreview();
          return;
        }
        const dataUrl = await readFileAsDataURL(file);
        currentSelectedImageDataUrl = dataUrl;
        currentImageRotation = 0;

        const wrapper = document.getElementById("imagePreviewWrapper");
        const img = document.getElementById("imagePreview");
        if (img) img.src = dataUrl;
        if (wrapper) wrapper.style.display = "flex";
        applyPreviewRotation();
      });
      document.getElementById("rotateLeftBtn").addEventListener("click", () => {
        if (!currentSelectedImageDataUrl) return;
        currentImageRotation = (currentImageRotation - 90) % 360;
        applyPreviewRotation();
      });
      document.getElementById("rotateRightBtn").addEventListener("click", () => {
        if (!currentSelectedImageDataUrl) return;
        currentImageRotation = (currentImageRotation + 90) % 360;
        applyPreviewRotation();
      });

      // íŒ í¼
      document.getElementById("plateForm").addEventListener("submit", savePlate);
      document.getElementById("plateCancelBtn").addEventListener("click", closePlateForm);

      // í•„ë¦„ ë©”ëª¨
      document.getElementById("memoSheetBackdrop").addEventListener("click", closeMemoSheet);
      document.getElementById("memoSheetCloseBtn").addEventListener("click", closeMemoSheet);
      document.getElementById("memoSheetCancelBtn").addEventListener("click", closeMemoSheet);
      document.getElementById("memoSheetSaveBtn").addEventListener("click", saveMemoSheet);

      // íŒ ë©”ëª¨
      document.getElementById("plateMemoBackdrop").addEventListener("click", closePlateMemoSheet);
      document.getElementById("plateMemoCloseBtn").addEventListener("click", closePlateMemoSheet);
      document.getElementById("plateMemoCancelBtn").addEventListener("click", closePlateMemoSheet);
      document.getElementById("plateMemoSaveBtn").addEventListener("click", savePlateMemoSheet);

      // íŒ ì‚¬ìš©ë“±ë¡
      document.getElementById("plateUseBackdrop").addEventListener("click", closePlateUseSheet);
      document.getElementById("plateUseCloseBtn").addEventListener("click", closePlateUseSheet);
      document.getElementById("plateUseCancelBtn").addEventListener("click", closePlateUseSheet);
      document.getElementById("plateUseSaveBtn").addEventListener("click", savePlateUse);

      // íŒ íˆìŠ¤í† ë¦¬
      document.getElementById("plateHistoryBackdrop").addEventListener("click", closePlateHistorySheet);
      document.getElementById("plateHistoryCloseBtn").addEventListener("click", closePlateHistorySheet);
      document.getElementById("plateHistoryCloseBtn2").addEventListener("click", closePlateHistorySheet);

      // íˆìŠ¤í† ë¦¬ ë©”ëª¨ ëª¨ë‹¬
      document.getElementById("historyNoteCancelBtn").addEventListener("click", closeHistoryNoteModal);
      document.getElementById("historyNoteSaveBtn").addEventListener("click", saveHistoryNoteModal);

                  // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ (ë§¨ ìœ„ë¡œ ë²„íŠ¼ + ë¬´í•œ ìŠ¤í¬ë¡¤ - ê°•ë ¥í•œ ë²„ì „)
      const scrollBtn = document.getElementById("scrollTopBtn");
      const spinner = document.getElementById("loadingSpinner");

      window.addEventListener("scroll", () => {
        // 1. ë§¨ ìœ„ë¡œ ê°€ê¸° ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
        if (scrollBtn) {
          if (window.scrollY > 600) scrollBtn.classList.add("show");
          else scrollBtn.classList.remove("show");
        }

        // 2. ë¬´í•œ ìŠ¤í¬ë¡¤ (ë°”ë‹¥ ê°ì§€)
        if (loadingMore) return; // ì´ë¯¸ ë¡œë”© ì¤‘ì´ë©´ ì‹¤í–‰ ì•ˆ í•¨

        // [ìˆ˜ì •] ëª¨ë°”ì¼/PC ëª¨ë“  ë¸Œë¼ìš°ì € í˜¸í™˜ì„±ì„ ìœ„í•œ ë†’ì´ ê³„ì‚°
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
        const windowHeight = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight || 0;
        const docHeight = document.documentElement.scrollHeight || document.body.scrollHeight || 0;

        // ë°”ë‹¥ì—ì„œ 100px ì •ë„ ë‚¨ì•˜ì„ ë•Œ ë¯¸ë¦¬ ë¡œë”© (ê°ë„ ë†’ì„)
        if (scrollTop + windowHeight >= docHeight - 100) {
          
          // í˜„ì¬ íƒ­ì— ë§ëŠ” ì „ì²´ ë°ì´í„° ê°œìˆ˜ í™•ì¸
          let totalLen = 0;
          if (currentTab === "films") totalLen = films.length;
          else totalLen = plates.length;

          // ê²€ìƒ‰ ì¤‘ì´ ì•„ë‹ ë•Œ, ì´ë¯¸ ë‹¤ ë³´ì—¬ì¤¬ìœ¼ë©´ ì¤‘ë‹¨
          if (visibleCount >= totalLen && currentSearchText === "") return;

          loadingMore = true;
          if (spinner) spinner.classList.add("show");

          // ìŠ¤í”¼ë„ˆ ë³´ì—¬ì£¼ê¸° (0.5ì´ˆ ë”œë ˆì´)
          setTimeout(() => {
            visibleCount += VISIBLE_STEP; // ê°œìˆ˜ ëŠ˜ë¦¬ê¸°
            renderCurrentTab(); // í™”ë©´ ê°±ì‹ 
            
            if (spinner) spinner.classList.remove("show");
            loadingMore = false;
          }, 500);
        }
      });

      // ë§¨ ìœ„ë¡œ ê°€ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      if (scrollBtn) {
        scrollBtn.addEventListener("click", () => {
          window.scrollTo({ top: 0, behavior: "smooth" });
        });
      }



      // âœ… (ì„ íƒ) í˜ì´ì§€ê°€ ì‚´ì•„ìˆì„ ë•Œë§Œ ìœ ì§€ / ì°½ ì™„ì „ ì¢…ë£Œë©´ sessionStorage ìë™ ì´ˆê¸°í™”
      // (ì¶”ê°€ ì‚­ì œ ì—†ìŒ)
 bindViewerGestures(); 
     }
    /* =========================================
   [ì¶”ê°€] ì´ë¯¸ì§€ ë·°ì–´ ì¤Œ/ì´ë™(Pan & Zoom) ë¡œì§
   ========================================= */

// 1. ìƒíƒœ ë³€ìˆ˜
let viewerState = {
  scale: 1,       // í˜„ì¬ ë°°ìœ¨
  panning: false, // ë“œë˜ê·¸ ì¤‘ì¸ì§€ ì—¬ë¶€
  pointX: 0,      // í˜„ì¬ X ìœ„ì¹˜
  pointY: 0,      // í˜„ì¬ Y ìœ„ì¹˜
  startX: 0,      // í„°ì¹˜ ì‹œì‘ X ì¢Œí‘œ
  startY: 0,      // í„°ì¹˜ ì‹œì‘ Y ì¢Œí‘œ
  startDist: 0    // ë‘ ì†ê°€ë½ ì‚¬ì´ ê±°ë¦¬
};

// 2. í™”ë©´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateViewerTransform() {
  const img = document.getElementById("viewerImage");
  const display = document.getElementById("zoomLevelDisplay");
  if (!img) return;
  
  // ìœ„ì¹˜ ì´ë™(X,Y)ê³¼ í™•ëŒ€(Scale) ì ìš©
  img.style.transform = `translate(${viewerState.pointX}px, ${viewerState.pointY}px) scale(${viewerState.scale})`;
  
  // í™”ë©´ í•˜ë‹¨ì— ì¤Œ ë ˆë²¨ í‘œì‹œ (ì˜ˆ: 150%)
  if (display) display.textContent = Math.round(viewerState.scale * 100) + "%";
}

// 3. ë‘ ì†ê°€ë½ ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜
function getDistance(touches) {
  const dx = touches[0].clientX - touches[1].clientX;
  const dy = touches[0].clientY - touches[1].clientY;
  return Math.hypot(dx, dy); 
}

// 4. í„°ì¹˜ ì´ë²¤íŠ¸ ì—°ê²° í•¨ìˆ˜
function bindViewerGestures() {
  const container = document.getElementById("viewerContainer"); 
  const img = document.getElementById("viewerImage");
  
  if (!container || !img) return;

  // (1) í„°ì¹˜ ì‹œì‘
  container.addEventListener("touchstart", (e) => {
    if (e.touches.length === 2) {
      // ë‘ ì†ê°€ë½ -> ì¤Œ ì‹œì‘
      viewerState.panning = false;
      viewerState.startDist = getDistance(e.touches);
    } else if (e.touches.length === 1) {
      // í•œ ì†ê°€ë½ -> ì´ë™ ì¤€ë¹„
      viewerState.panning = true;
      viewerState.startX = e.touches[0].clientX - viewerState.pointX;
      viewerState.startY = e.touches[0].clientY - viewerState.pointY;
    }
  }, { passive: false });

  // (2) í„°ì¹˜ ì´ë™
  container.addEventListener("touchmove", (e) => {
    e.preventDefault(); // í™”ë©´ ìŠ¤í¬ë¡¤ ë°©ì§€

    if (e.touches.length === 2) {
      // ë‘ ì†ê°€ë½ -> í•€ì¹˜ ì¤Œ
      const newDist = getDistance(e.touches);
      const ratio = newDist / viewerState.startDist;
      
      // ë°°ìœ¨ ì œí•œ (0.5ë°° ~ 5ë°°)
      viewerState.scale = Math.max(0.5, Math.min(5, viewerState.scale * ratio));
      viewerState.startDist = newDist;
      
      updateViewerTransform();

    } else if (e.touches.length === 1 && viewerState.panning) {
      // í•œ ì†ê°€ë½ -> ì´ë¯¸ì§€ ì´ë™
      viewerState.pointX = e.touches[0].clientX - viewerState.startX;
      viewerState.pointY = e.touches[0].clientY - viewerState.startY;
      updateViewerTransform();
    }
  }, { passive: false });

  // (3) í„°ì¹˜ ë
  container.addEventListener("touchend", () => {
    viewerState.panning = false;
  });
}
/* [ì¶”ê°€] ëŒ€ì‹œë³´ë“œ ìˆ«ì ê³„ì‚° í•¨ìˆ˜ */
    function updateDashboard(){
      const dashSection = document.getElementById("dashboardSection");
      if(!dashSection) return;

      // 1. í™œì„± íŒ
      const activeCount = plates.filter(p => p.status !== 'empty').length;
      
      // 2. ë¹ˆ íŒ
      const emptyCount = plates.filter(p => p.status === 'empty').length;
      
      // 3. ìˆ˜ëª… ì£¼ì˜
      const warnCount = plates.filter(p => {
        if(p.status === 'empty') return false;
        const r = getPlateUsedRatio(p);
        return r.pct >= 90;
      }).length;

      document.getElementById("dashActive").textContent = activeCount + "ê°œ";
      document.getElementById("dashEmpty").textContent = emptyCount + "ê°œ";
      document.getElementById("dashWarn").textContent = warnCount + "ê°œ";
      
      dashSection.style.display = (currentMode === MODE_VIEWER) ? "none" : "grid";
    }
// ğŸ‘†ğŸ‘†ğŸ‘† ì—¬ê¸°ê¹Œì§€ ë¶™ì—¬ë„£ê¸° ğŸ‘†ğŸ‘†ğŸ‘†
/* [ì¶”ê°€] ì—‘ì…€ ë³´ê³ ì„œ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ */
    async function downloadExcelReport() {
      if(!confirm("ì „ì²´ ë°ì´í„°ë¥¼ ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œí• ê¹Œ?")) return;

      try {
        const wb = XLSX.utils.book_new();

        // 1. í•„ë¦„ ëª©ë¡ ì‹œíŠ¸
        const filmData = films.map(f => ({
          "ì œí’ˆëª…": f.productName,
          "í•„ë¦„ë²ˆí˜¸": f.filmNumber,
          "íƒ€ì…": f.method,
          "MESH": f.mesh,
          "ìœ„ì¹˜": f.location,
          "ìš”ì²­ì": f.requestPrinter,
          "ë§ˆì§€ë§‰ì‚¬ìš©": f.lastUsed,
          "ë©”ëª¨": f.memo
        }));
        const ws1 = XLSX.utils.json_to_sheet(filmData);
        XLSX.utils.book_append_sheet(wb, ws1, "í•„ë¦„ ëª©ë¡");

        // 2. íŒ ëª©ë¡ ì‹œíŠ¸
        const plateData = plates.map(p => ({
          "íŒë²ˆí˜¸": p.plateNumber,
          "ìƒíƒœ": p.status === 'empty' ? 'ë¹ˆ íŒ' : 'ì‚¬ìš© ì¤‘',
          "í˜„ì¬ì œí’ˆ": p.productName || "-",
          "í˜„ì¬í•„ë¦„": p.filmNumber || "-",
          "MESH": p.mesh,
          "í…ì…˜": p.tension,
          "ìœ„ì¹˜": p.location,
          "í˜„ì¬ì‘ì—…ëŸ‰": p.usedQty || 0,
          "ì´ëˆ„ì ìˆ˜ëŸ‰": p.totalUsedQty || 0
        }));
        const ws2 = XLSX.utils.json_to_sheet(plateData);
        XLSX.utils.book_append_sheet(wb, ws2, "íŒ(Frame) í˜„í™©");

        // 3. ì‘ì—… íˆìŠ¤í† ë¦¬ ì‹œíŠ¸ (ìµœê·¼ 500ê°œë§Œ)
        // (ì£¼ì˜: ë°ì´í„°ê°€ ë§ìœ¼ë©´ ë¡œë”©ì´ ê±¸ë¦´ ìˆ˜ ìˆì–´ 500ê°œë¡œ ì œí•œ)
        const histSnap = await db.collection(HISTORY_COLLECTION).orderBy("timestamp","desc").limit(500).get();
        const histData = histSnap.docs.map(doc => {
            const d = doc.data();
            const date = new Date(d.timestamp);
            return {
                "ì‹œê°„": `${date.getFullYear()}-${date.getMonth()+1}-${date.getDate()} ${date.getHours()}:${date.getMinutes()}`,
                "êµ¬ë¶„": d.action,
                "ê¸°ê¸°": d.deviceName,
                "ë‚´ìš©": d.filmNumber + " " + (d.productName||""),
                "ë³€ê²½ì‚¬í•­": (d.changes || []).join(", "),
                "ë©”ëª¨": d.note || ""
            };
        });
        const ws3 = XLSX.utils.json_to_sheet(histData);
        XLSX.utils.book_append_sheet(wb, ws3, "ì‘ì—… ê¸°ë¡");

        // íŒŒì¼ ì €ì¥
        const dateStr = new Date().toISOString().slice(0,10);
        XLSX.writeFile(wb, `FILM_FIND_ë³´ê³ ì„œ_${dateStr}.xlsx`);
        
        showToast("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!");
      } catch(e) {
        console.error(e);
        showToast("ì—‘ì…€ ë³€í™˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
      }
    }
	/* [ì¶”ê°€] ëŒ€ì‹œë³´ë“œ í´ë¦­ í•„í„° ë³€ìˆ˜ ë° í•¨ìˆ˜ */
    let dashboardFilter = null; // í˜„ì¬ ì–´ë–¤ í•„í„°ì¸ì§€ ì €ì¥ (nullì´ë©´ ì „ì²´ë³´ê¸°)

    function filterByDash(type){
      // ì´ë¯¸ ëˆŒë ¤ìˆëŠ” ê±¸ ë˜ ëˆ„ë¥´ë©´ -> í•„í„° í•´ì œ (í† ê¸€)
      if(dashboardFilter === type){
        dashboardFilter = null;
      } else {
        dashboardFilter = type; // í•„í„° ì„¤ì •
      }
      
      // ë””ìì¸ ì—…ë°ì´íŠ¸ (ì„ íƒëœ ì¹´ë“œë§Œ ì§„í•˜ê²Œ)
      document.querySelectorAll('.dash-card').forEach(el => el.classList.remove('selected'));
      if(dashboardFilter === 'active') document.getElementById('cardActive').classList.add('selected');
      if(dashboardFilter === 'empty') document.getElementById('cardEmpty').classList.add('selected');
      if(dashboardFilter === 'warn') document.getElementById('cardWarn').classList.add('selected');

      // ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
      renderPlatesList(currentSearchText);
    }


    /* ---------- ì´ˆê¸°í™” ---------- */
    async function init(){
      bindEvents();
      setTheme(getTheme());
      applyViewMode();

      // mode ë³µêµ¬(ì„¸ì…˜)
      await loadAuthConfig();

      if (isUnlocked()){
        const mode = sessionStorage.getItem(UNLOCK_MODE_KEY);
        if (mode === MODE_ADMIN || mode === MODE_PRINTER || mode === MODE_VIEWER){
          unlock(mode);
        } else {
          lock();
        }
      } else {
        lock();
      }

      // ê¸°ê¸° ë°°ì§€
      setDeviceLabel(getDeviceLabel());

      // ì¸ì‡„ê¸°ì‚¬ ëª©ë¡ ê´€ë¦¬ì UIëŠ” ì„¤ì • ì—´ ë•Œ ê°±ì‹ ë¨
    }

    init().catch(console.error);

  </script>
</body>
  </html>
