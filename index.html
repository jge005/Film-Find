<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>필름 관리 프로그램</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(145deg, #f9fafb, #f4f0ff, #fdf2f8);
      padding: 12px;
    }
    h1 {
      font-size: 22px;
      margin: 10px 0 14px;
      text-align: left;
      letter-spacing: 2px;
    }
    .header-row {
      max-width: 720px;
      margin: 0 auto 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .device-badge {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(228,231,255,0.95);
      color: #3f4464;
      white-space: nowrap;
    }

    .app-shell {
      max-width: 720px;
      margin: 0 auto;
    }

    .top-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .top-bar input[type="text"] {
      flex: 1;
      padding: 9px 11px;
      border-radius: 999px;
      border: 1px solid #d6d9ff;
      font-size: 14px;
      min-width: 0;
      background: rgba(255,255,255,0.9);
    }
    .btn {
      padding: 8px 11px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      transition: transform 0.05s ease, box-shadow 0.1s ease, background 0.1s ease;
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    .btn-primary {
      background: linear-gradient(135deg, #7f9dff, #b38cff);
      color: white;
      box-shadow: 0 4px 10px rgba(127,157,255,0.35);
    }
    .btn-secondary {
      background: rgba(228,231,255,0.9);
      color: #283252;
    }
    .btn-danger {
      background: #ff6b81;
      color: white;
    }
    .btn-small {
      font-size: 12px;
      padding: 5px 9px;
      border-radius: 999px;
    }

    .tools-bar {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
      flex-wrap: wrap;
      justify-content: flex-start;
    }

    .form-card {
      background: rgba(255,255,255,0.98);
      border-radius: 18px;
      padding: 12px 14px;
      margin-bottom: 12px;
      box-shadow: 0 8px 20px rgba(167, 173, 208, 0.35);
      border: 1px solid #e3e6ff;
    }
    .form-row {
      display: flex;
      flex-direction: column;
      margin-bottom: 9px;
    }
    .form-row label {
      font-size: 12px;
      margin-bottom: 4px;
      color: #5a5f80;
    }
    .form-row input[type="text"],
    .form-row input[type="date"],
    .form-row select {
      padding: 7px 10px;
      border-radius: 10px;
      border: 1px solid #d6d9ff;
      font-size: 13px;
      background: #f9f9ff;
    }
    .form-row input[type="file"] {
      font-size: 12px;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 6px;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 40px;
    }

    .card {
      background: rgba(255,255,255,0.96);
      border-radius: 16px;
      padding: 10px;
      display: flex;
      gap: 10px;
      box-shadow: 0 6px 16px rgba(169, 177, 214, 0.35);
      align-items: flex-start;
      border: 1px solid #e3e6ff;
    }
    .card img {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 12px;
      background: #eef1ff;
      flex-shrink: 0;
      cursor: pointer;
    }
    .card-content {
      flex: 1;
      font-size: 13px;
    }
    .card-row-main {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 4px;
      align-items: center;
    }
    .card-title {
      font-weight: 600;
      font-size: 14px;
      color: #2f3559;
    }
    .card-tag {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      background: #f3e8ff;
      color: #5f308c;
      align-self: flex-start;
    }
    .card-row {
      margin-bottom: 2px;
    }
    .label {
      color: #8689a5;
      font-size: 11px;
      margin-right: 4px;
    }
    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
      gap: 6px;
      flex-wrap: wrap;
    }
    .last-used {
      font-size: 11px;
      color: #777b9e;
    }
    .card-buttons {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }
    .history-text {
      font-size: 11px;
      color: #a0a4c2;
      margin-top: 2px;
    }

    .empty-text {
      text-align: center;
      color: #777;
      font-size: 13px;
      margin-top: 20px;
    }

    .toggle-group {
      display: flex;
      gap: 6px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }
    .toggle-btn {
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid #d6d9ff;
      background: #f5f3ff;
      color: #464b73;
      cursor: pointer;
      transition: background 0.1s ease, color 0.1s ease, border 0.1s ease;
    }
    .toggle-btn.active {
      border-color: #7f9dff;
      background: #7f9dff;
      color: #fff;
    }

    /* 이미지 전체 보기 */
    .image-viewer {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1500;
    }
    .image-viewer-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.75);
    }
    .image-viewer-inner {
      position: relative;
      max-width: 100%;
      max-height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    #viewerImage {
      max-width: 100%;
      max-height: 100%;
      border-radius: 12px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.5);
      touch-action: none;
    }
    .viewer-close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      border-radius: 999px;
      border: none;
      padding: 6px 10px;
      font-size: 14px;
      cursor: pointer;
      background: rgba(15,23,42,0.8);
      color: #f9fafb;
    }

    /* 설정 카드 제목 */
    .settings-section-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #3c4266;
    }
    .settings-help {
      font-size: 11px;
      color: #8a8fb0;
      margin-bottom: 6px;
    }

    /* 토스트 */
    #toast {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%) translateY(80px);
      background: rgba(30, 41, 59, 0.95);
      color: #f9fafb;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 2000;
      white-space: nowrap;
    }
    #toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* 히스토리 모달 */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2500;
    }
    .modal-inner {
      width: min(90vw, 480px);
      max-height: 80vh;
      background: #f9fafb;
      border-radius: 16px;
      box-shadow: 0 18px 40px rgba(15,23,42,0.45);
      padding: 14px 16px;
      display: flex;
      flex-direction: column;
    }
    .modal-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .modal-sub {
      font-size: 11px;
      color: #8c90b2;
      margin-bottom: 10px;
    }
    .history-list {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
    }
    .history-item {
      font-size: 12px;
      padding: 5px 0;
      border-bottom: 1px solid #e3e5f2;
    }
    .history-item:last-child {
      border-bottom: none;
    }
    .history-time {
      color: #63699a;
      margin-right: 6px;
    }
    .history-device {
      color: #8b91c0;
      margin-right: 4px;
    }
    .history-action {
      color: #3a3f66;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 10px;
      gap: 6px;
    }

    /* 잠금 화면 */
    #lockScreen {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #fef3ff, #d3d4ff);
      z-index: 3000;
    }
    .lock-inner {
      background: rgba(255,255,255,0.96);
      border-radius: 20px;
      padding: 18px 20px;
      width: min(90vw, 360px);
      box-shadow: 0 18px 40px rgba(148, 163, 233, 0.6);
    }
    .lock-inner h2 {
      font-size: 18px;
      margin: 0 0 6px;
    }
    .lock-inner p {
      font-size: 12px;
      color: #6b7280;
      margin: 0 0 12px;
    }
    .lock-inner input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #d6d9ff;
      margin-bottom: 12px;
      font-size: 14px;
    }

    @media (min-width: 900px) {
      .card img {
        width: 90px;
        height: 90px;
      }
      .card {
        padding: 14px;
      }
    }
  </style>
</head>
<body>
  <!-- 잠금 화면 -->
  <div id="lockScreen">
    <div class="lock-inner">
      <h2>필름 관리 잠금</h2>
      <p>비밀번호를 입력해야 열 수 있어.</p>
      <input type="password" id="lockInput" placeholder="비밀번호" />
      <button id="lockSubmitBtn" class="btn btn-primary" style="width:100%;">열기</button>
    </div>
  </div>

  <!-- 이미지 전체보기 뷰어 -->
  <div id="imageViewer" class="image-viewer">
    <div class="image-viewer-backdrop" id="viewerBackdrop"></div>
    <div class="image-viewer-inner">
      <img id="viewerImage" src="" alt="필름 이미지" />
      <button id="closeViewerBtn" class="viewer-close-btn">✕</button>
    </div>
  </div>

  <!-- 히스토리 모달 -->
  <div id="historyModal" class="modal-overlay">
    <div class="modal-inner">
      <div class="modal-title" id="historyTitle">히스토리</div>
      <div class="modal-sub" id="historySub"></div>
      <div class="history-list" id="historyList"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary btn-small" id="closeHistoryBtn">닫기</button>
      </div>
    </div>
  </div>

  <!-- 실제 앱 내용 -->
  <div id="appContainer" style="visibility:hidden; pointer-events:none;">
    <div class="header-row">
      <h1>필름 관리</h1>
      <div id="deviceBadge" class="device-badge"></div>
    </div>

    <div class="app-shell">
      <div class="top-bar">
        <input type="text" id="searchInput"
               placeholder="제품명 / 필름번호 / 제판방식 / 위치 / 제판방법 검색" />
        <button class="btn btn-primary" id="newFilmBtn">+ 새 필름</button>
      </div>

      <div class="tools-bar">
        <button class="btn btn-secondary btn-small" id="settingsBtn">⚙ 설정</button>
        <button class="btn btn-secondary btn-small" id="exportBtn">데이터 내보내기</button>
        <button class="btn btn-secondary btn-small" id="importBtn">데이터 불러오기</button>
        <input type="file" id="importFile" accept="application/json" style="display:none;" />
      </div>

      <!-- 설정 카드 -->
      <div class="form-card" id="settingsCard" style="display:none;">
        <div class="form-row">
          <div class="settings-section-title">이 기기 이름</div>
          <div class="settings-help">예: 가은폰, 성규패드, 회사PC. 히스토리에 기록돼.</div>
          <input type="text" id="deviceNameInput" placeholder="기기 이름을 입력하세요" />
        </div>

        <div class="form-row">
          <div class="settings-section-title">앱 잠금 비밀번호</div>
          <div class="settings-help">
            비밀번호를 설정하면 앱 접속 시 먼저 물어봐. 비밀번호를 지우면 잠금이 해제돼.
          </div>
          <input type="password" id="oldPasswordInput" placeholder="현재 비밀번호 (있을 때만)" />
          <input type="password" id="newPasswordInput" placeholder="새 비밀번호 (비워두면 잠금 해제)" />
        </div>

        <div class="form-row">
          <div class="settings-section-title">정렬 방식</div>
          <div class="settings-help">목록 기본 정렬 기준을 선택해.</div>
          <div style="display:flex; gap:6px; flex-wrap:wrap;">
            <select id="sortKeySelect" style="flex:1; min-width:120px; padding:6px 8px; border-radius:10px; border:1px solid #d6d9ff; background:#f9f9ff; font-size:13px;">
              <option value="updatedAt">최근 수정순</option>
              <option value="lastUsed">마지막 사용일</option>
              <option value="productName">제품명</option>
              <option value="filmNumber">필름 번호</option>
            </select>
            <select id="sortDirSelect" style="width:110px; padding:6px 8px; border-radius:10px; border:1px solid #d6d9ff; background:#f9f9ff; font-size:13px;">
              <option value="desc">내림차순</option>
              <option value="asc">오름차순</option>
            </select>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary btn-small" id="closeSettingsBtn">닫기</button>
          <button type="button" class="btn btn-primary btn-small" id="saveSettingsBtn">저장</button>
        </div>
      </div>

      <!-- 필름 입력 폼 -->
      <div class="form-card" id="formCard" style="display:none;">
        <form id="filmForm">
          <input type="hidden" id="filmId" />
          <div class="form-row">
            <label for="productName">제품 이름 *</label>
            <input type="text" id="productName" required />
          </div>
          <div class="form-row">
            <label for="filmNumber">필름 번호 *</label>
            <input type="text" id="filmNumber" required />
          </div>
          <div class="form-row">
            <label for="plateType">제판 방식 (자유입력)</label>
            <input type="text" id="plateType" placeholder="예: 바탕, 문자, 스모그 등" />
          </div>

          <div class="form-row">
            <label>필름 제판 방법</label>
            <div class="toggle-group" data-group="frontBack">
              <button type="button" class="toggle-btn" data-value="전면">전면</button>
              <button type="button" class="toggle-btn" data-value="배면">배면</button>
            </div>
            <div class="toggle-group" data-group="leftRight">
              <button type="button" class="toggle-btn" data-value="좌">좌</button>
              <button type="button" class="toggle-btn" data-value="우">우</button>
            </div>
            <div class="toggle-group" data-group="upDown">
              <button type="button" class="toggle-btn" data-value="상">상</button>
              <button type="button" class="toggle-btn" data-value="하">하</button>
            </div>
            <small style="font-size:11px; color:#7b7f9d;">
              전면/배면 + 좌/우 + 상/하 조합 (예: 배면 좌상, 전면 우하 등)
            </small>
          </div>

          <div class="form-row">
            <label for="location">필름 위치</label>
            <input type="text" id="location" placeholder="예: A-3 서랍, 4층 우측 랙 등" />
          </div>
          <div class="form-row">
            <label for="lastUsed">마지막 사용일</label>
            <div style="display:flex; gap:6px;">
              <input type="date" id="lastUsed" style="flex:1;" />
              <button type="button" class="btn btn-secondary btn-small" id="setTodayBtn">오늘</button>
            </div>
          </div>
          <div class="form-row">
            <label for="imageInput">필름 사진 (선택)</label>
            <input type="file" id="imageInput" accept="image/*" />
            <small style="font-size:11px; color:#7b7f9d;">
              · 새 필름에는 사진을 추가하고,<br/>
              · 수정 시 사진을 바꾸고 싶을 때만 다시 선택하세요.
            </small>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="cancelBtn">취소</button>
            <button type="submit" class="btn btn-primary" id="saveBtn">저장</button>
          </div>
        </form>
      </div>

      <div id="list" class="list"></div>
      <div id="emptyText" class="empty-text" style="display:none;">
        등록된 필름이 없습니다.<br/>오른쪽 위 <b>+ 새 필름</b> 버튼으로 추가하세요.
      </div>
    </div>
  </div>

  <div id="toast"></div>

  <script type="module">
    // -------- Firebase 초기화 --------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      setDoc,
      deleteDoc,
      doc,
      onSnapshot,
      query,
      orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBrBnVuXca2Ou1oMFOLzq3KGEN8xiK5L_U",
      authDomain: "film-find-5242d.firebaseapp.com",
      projectId: "film-find-5242d",
      storageBucket: "film-find-5242d.firebasestorage.app",
      messagingSenderId: "185123433624",
      appId: "1:185123433624:web:269eb9b4b6437887f2f4ed",
      measurementId: "G-V9KL8XS9KJ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const filmsCol = collection(db, "films");

    // -------- 전역 상태 --------
    let films = [];
    let currentFilterText = "";
    let deviceName = "";
    const DEVICE_KEY = "filmDeviceName";
    const PASSWORD_KEY = "filmPassword";
    const SETTINGS_KEY = "filmSortSettings";

    let sortSettings = { key: "updatedAt", dir: "desc" };

    // -------- 유틸 --------
    function showToast(message) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.classList.add("show");
      setTimeout(() => {
        toast.classList.remove("show");
      }, 1800);
    }

    function getDeviceName() {
      if (deviceName) return deviceName;
      const saved = localStorage.getItem(DEVICE_KEY) || "";
      if (saved) {
        deviceName = saved;
        return deviceName;
      }
      const input = prompt("이 기기 이름을 입력해 주세요.\n예: 가은폰, 성규패드, 회사PC");
      const finalName = (input || "").trim() || "미지정 기기";
      localStorage.setItem(DEVICE_KEY, finalName);
      deviceName = finalName;
      return deviceName;
    }

    function updateDeviceBadge() {
      const badge = document.getElementById("deviceBadge");
      badge.textContent = getDeviceName();
    }

    function formatDate(iso) {
      if (!iso) return "-";
      return iso;
    }

    function buildPlateInfoFromForm() {
      const groups = document.querySelectorAll(".toggle-group");
      const values = [];
      groups.forEach(group => {
        const active = group.querySelector(".toggle-btn.active");
        if (active) values.push(active.dataset.value);
      });
      return values.join(" ");
    }

    function setPlateInfoToForm(str) {
      document.querySelectorAll(".toggle-btn").forEach(btn => {
        btn.classList.remove("active");
      });
      if (!str) return;
      const parts = str.split(" ");
      document.querySelectorAll(".toggle-btn").forEach(btn => {
        if (parts.includes(btn.dataset.value)) {
          btn.classList.add("active");
        }
      });
    }

    function clearForm() {
      document.getElementById("filmId").value = "";
      document.getElementById("productName").value = "";
      document.getElementById("filmNumber").value = "";
      document.getElementById("plateType").value = "";
      document.getElementById("location").value = "";
      document.getElementById("lastUsed").value = "";
      document.getElementById("imageInput").value = "";
      document.querySelectorAll(".toggle-btn").forEach(btn => btn.classList.remove("active"));
    }

    function openFormNew() {
      clearForm();
      if (films.length) {
        const last = films[0];
        document.getElementById("plateType").value = last.plateType || "";
        document.getElementById("location").value = last.location || "";
        setPlateInfoToForm(last.plateInfo || "");
      }
      document.getElementById("formCard").style.display = "block";
      document.getElementById("productName").focus();
    }

    function openFormForEdit(id) {
      const film = films.find(f => f.id === id);
      if (!film) return;
      document.getElementById("filmId").value = film.id;
      document.getElementById("productName").value = film.productName || "";
      document.getElementById("filmNumber").value = film.filmNumber || "";
      document.getElementById("plateType").value = film.plateType || "";
      document.getElementById("location").value = film.location || "";
      document.getElementById("lastUsed").value = film.lastUsed || "";
      document.getElementById("imageInput").value = "";
      setPlateInfoToForm(film.plateInfo || "");
      document.getElementById("formCard").style.display = "block";
      document.getElementById("productName").focus();
    }

    function closeForm() {
      document.getElementById("formCard").style.display = "none";
      clearForm();
    }

    // 이미지 압축
    function compressImage(dataUrl) {
      return new Promise(resolve => {
        const img = new Image();
        img.onload = function () {
          const maxSize = 700;
          let w = img.width;
          let h = img.height;
          const ratio = Math.min(maxSize / w, maxSize / h, 1);
          w = Math.round(w * ratio);
          h = Math.round(h * ratio);

          const canvas = document.createElement("canvas");
          canvas.width = w;
          canvas.height = h;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, w, h);
          const compressed = canvas.toDataURL("image/jpeg", 0.7);
          resolve(compressed);
        };
        img.onerror = function () {
          resolve(dataUrl);
        };
        img.src = dataUrl;
      });
    }

    function buildHistoryEntry(action) {
      return {
        time: new Date().toISOString(),
        action,
        device: getDeviceName()
      };
    }

    // -------- Firestore write 함수 --------
    async function createFilm(data, imageDataUrl) {
      const history = [buildHistoryEntry("생성")];
      const payload = {
        ...data,
        imageDataUrl: imageDataUrl || "",
        createdAt: Date.now(),
        updatedAt: Date.now(),
        history
      };
      await addDoc(filmsCol, payload);
    }

    async function updateFilm(id, data, imageDataUrl, historyAction = "수정") {
      const film = films.find(f => f.id === id);
      const oldHistory = (film && film.history) || [];
      const newHistory = [...oldHistory, buildHistoryEntry(historyAction)];

      const payload = {
        ...data,
        updatedAt: Date.now(),
        history: newHistory
      };
      if (imageDataUrl !== null) {
        payload.imageDataUrl = imageDataUrl;
      }

      const ref = doc(db, "films", id);
      await setDoc(ref, payload, { merge: true });
    }

    async function deleteFilm(id) {
      const ref = doc(db, "films", id);
      await deleteDoc(ref);
    }

    // -------- 정렬 --------
    function loadSortSettings() {
      const saved = localStorage.getItem(SETTINGS_KEY);
      if (saved) {
        try {
          const obj = JSON.parse(saved);
          if (obj.key) sortSettings.key = obj.key;
          if (obj.dir) sortSettings.dir = obj.dir;
        } catch {}
      }
      document.getElementById("sortKeySelect").value = sortSettings.key;
      document.getElementById("sortDirSelect").value = sortSettings.dir;
    }

    function saveSortSettingsFromUI() {
      sortSettings = {
        key: document.getElementById("sortKeySelect").value,
        dir: document.getElementById("sortDirSelect").value
      };
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(sortSettings));
    }

    function sortFilms(arr) {
      const { key, dir } = sortSettings;
      const mul = dir === "asc" ? 1 : -1;
      return arr.slice().sort((a, b) => {
        let va, vb;
        if (key === "updatedAt") {
          va = a.updatedAt || 0;
          vb = b.updatedAt || 0;
        } else if (key === "lastUsed") {
          va = a.lastUsed || "";
          vb = b.lastUsed || "";
        } else if (key === "productName") {
          va = (a.productName || "").toLowerCase();
          vb = (b.productName || "").toLowerCase();
        } else if (key === "filmNumber") {
          va = (a.filmNumber || "").toLowerCase();
          vb = (b.filmNumber || "").toLowerCase();
        } else {
          va = a.updatedAt || 0;
          vb = b.updatedAt || 0;
        }
        if (va < vb) return -1 * mul;
        if (va > vb) return 1 * mul;
        return 0;
      });
    }

    // -------- 리스트 렌더링 --------
    function renderList(filterText = "") {
      const listEl = document.getElementById("list");
      const emptyText = document.getElementById("emptyText");
      listEl.innerHTML = "";

      const text = filterText.trim().toLowerCase();

      const sorted = sortFilms(films);

      let filtered = sorted.filter(f => {
        if (!text) return true;
        const combined =
          (f.productName || "") + " " +
          (f.filmNumber || "") + " " +
          (f.plateType || "") + " " +
          (f.location || "") + " " +
          (f.plateInfo || "");
        return combined.toLowerCase().includes(text);
      });

      if (filtered.length === 0) {
        emptyText.style.display = "block";
        return;
      } else {
        emptyText.style.display = "none";
      }

      filtered.forEach(film => {
        const card = document.createElement("div");
        card.className = "card";

        const img = document.createElement("img");
        if (film.imageDataUrl) {
          img.src = film.imageDataUrl;
          img.addEventListener("click", () => openImageViewer(film.imageDataUrl));
        } else {
          img.alt = "이미지 없음";
        }
        card.appendChild(img);

        const content = document.createElement("div");
        content.className = "card-content";

        const rowMain = document.createElement("div");
        rowMain.className = "card-row-main";
        const title = document.createElement("div");
        title.className = "card-title";
        title.textContent = film.productName || "(제품명 없음)";
        const tag = document.createElement("div");
        tag.className = "card-tag";
        tag.textContent = film.filmNumber || "번호 없음";
        rowMain.appendChild(title);
        rowMain.appendChild(tag);
        content.appendChild(rowMain);

        const rowType = document.createElement("div");
        rowType.className = "card-row";
        rowType.innerHTML =
          '<span class="label">제판방식</span>' + (film.plateType || "-");
        content.appendChild(rowType);

        const rowPlate = document.createElement("div");
        rowPlate.className = "card-row";
        rowPlate.innerHTML =
          '<span class="label">제판 방법</span>' + (film.plateInfo || "-");
        content.appendChild(rowPlate);

        const rowLoc = document.createElement("div");
        rowLoc.className = "card-row";
        rowLoc.innerHTML =
          '<span class="label">필름 위치</span>' + (film.location || "-");
        content.appendChild(rowLoc);

        const footer = document.createElement("div");
        footer.className = "card-footer";

        const lastUsed = document.createElement("div");
        lastUsed.className = "last-used";
        lastUsed.textContent =
          "마지막 사용일: " + formatDate(film.lastUsed || "");
        footer.appendChild(lastUsed);

        const btnWrap = document.createElement("div");
        btnWrap.className = "card-buttons";

        const useTodayBtn = document.createElement("button");
        useTodayBtn.className = "btn btn-secondary btn-small";
        useTodayBtn.textContent = "오늘 사용";
        useTodayBtn.addEventListener("click", async () => {
          try {
            const today = new Date().toISOString().slice(0, 10);
            await updateFilm(
              film.id,
              {
                productName: film.productName || "",
                filmNumber: film.filmNumber || "",
                plateType: film.plateType || "",
                plateInfo: film.plateInfo || "",
                location: film.location || "",
                lastUsed: today
              },
              null,
              "오늘 사용"
            );
            showToast("오늘 사용으로 기록했어.");
          } catch (e) {
            alert("오늘 사용으로 저장하는 중 오류가 발생했어.");
          }
        });

        const copyBtn = document.createElement("button");
        copyBtn.className = "btn btn-secondary btn-small";
        copyBtn.textContent = "복사";
        copyBtn.addEventListener("click", () => openFormCopyFrom(film.id));

        const historyBtn = document.createElement("button");
        historyBtn.className = "btn btn-secondary btn-small";
        historyBtn.textContent = "기록";
        historyBtn.addEventListener("click", () => openHistoryModal(film.id));

        const editBtn = document.createElement("button");
        editBtn.className = "btn btn-primary btn-small";
        editBtn.textContent = "수정";
        editBtn.addEventListener("click", () => openFormForEdit(film.id));

        const delBtn = document.createElement("button");
        delBtn.className = "btn btn-danger btn-small";
        delBtn.textContent = "삭제";
        delBtn.addEventListener("click", async () => {
          if (!confirm("이 필름 정보를 삭제할까요?")) return;
          try {
            await deleteFilm(film.id);
            showToast("삭제했어.");
          } catch (e) {
            alert("삭제하는 중 오류가 발생했어.");
          }
        });

        btnWrap.appendChild(useTodayBtn);
        btnWrap.appendChild(copyBtn);
        btnWrap.appendChild(historyBtn);
        btnWrap.appendChild(editBtn);
        btnWrap.appendChild(delBtn);

        footer.appendChild(btnWrap);
        content.appendChild(footer);

        if (film.history && film.history.length) {
          const last = film.history[film.history.length - 1];
          const his = document.createElement("div");
          his.className = "history-text";
          const when = (last.time || "").slice(0, 16).replace("T", " ");
          his.textContent =
            `최근 기록: ${when} · ${last.device || ""} · ${last.action || ""}`;
          content.appendChild(his);
        }

        card.appendChild(content);
        listEl.appendChild(card);
      });
    }

    function openFormCopyFrom(id) {
      const film = films.find(f => f.id === id);
      if (!film) return;
      clearForm();
      document.getElementById("productName").value = film.productName || "";
      document.getElementById("filmNumber").value = "";
      document.getElementById("plateType").value = film.plateType || "";
      document.getElementById("location").value = film.location || "";
      document.getElementById("lastUsed").value = "";
      setPlateInfoToForm(film.plateInfo || "");
      document.getElementById("formCard").style.display = "block";
      document.getElementById("productName").focus();
    }

    // -------- 히스토리 모달 --------
    function openHistoryModal(id) {
      const film = films.find(f => f.id === id);
      if (!film) return;
      const modal = document.getElementById("historyModal");
      const title = document.getElementById("historyTitle");
      const sub = document.getElementById("historySub");
      const list = document.getElementById("historyList");
      title.textContent = `${film.productName || ""} (${film.filmNumber || ""}) 히스토리`;
      sub.textContent = "최근 기록 순서대로 보여줘.";
      list.innerHTML = "";

      const history = (film.history || []).slice().sort((a, b) => {
        return (a.time || "").localeCompare(b.time || "");
      });

      if (!history.length) {
        const empty = document.createElement("div");
        empty.className = "history-item";
        empty.textContent = "기록이 아직 없어.";
        list.appendChild(empty);
      } else {
        history.forEach(h => {
          const item = document.createElement("div");
          item.className = "history-item";
          const t = (h.time || "").slice(0, 16).replace("T", " ");
          const timeSpan = document.createElement("span");
          timeSpan.className = "history-time";
          timeSpan.textContent = t;
          const devSpan = document.createElement("span");
          devSpan.className = "history-device";
          devSpan.textContent = h.device || "";
          const actSpan = document.createElement("span");
          actSpan.className = "history-action";
          actSpan.textContent = h.action || "";
          item.appendChild(timeSpan);
          item.appendChild(devSpan);
          item.appendChild(actSpan);
          list.appendChild(item);
        });
      }
      modal.style.display = "flex";
    }

    function closeHistoryModal() {
      document.getElementById("historyModal").style.display = "none";
    }

    // -------- 이미지 뷰어 (핀치줌) --------
    let viewerScale = 1;
    let viewerStartDist = 0;
    let viewerLastScale = 1;
    let viewerTransX = 0;
    let viewerTransY = 0;
    let panStartX = 0;
    let panStartY = 0;
    let isPanning = false;

    function resetViewerTransform() {
      viewerScale = 1;
      viewerTransX = 0;
      viewerTransY = 0;
      viewerStartDist = 0;
      viewerLastScale = 1;
      isPanning = false;
      const img = document.getElementById("viewerImage");
      img.style.transform = "translate(0px, 0px) scale(1)";
    }

    function updateViewerTransform() {
      const img = document.getElementById("viewerImage");
      img.style.transform =
        "translate(" + viewerTransX + "px, " + viewerTransY + "px) scale(" + viewerScale + ")";
    }

    function openImageViewer(src) {
      if (!src) return;
      const viewer = document.getElementById("imageViewer");
      const img = document.getElementById("viewerImage");
      img.src = src;
      resetViewerTransform();
      viewer.style.display = "flex";
    }

    function closeImageViewer() {
      const viewer = document.getElementById("imageViewer");
      viewer.style.display = "none";
    }

    function initImageViewerTouch() {
      const img = document.getElementById("viewerImage");
      const viewer = document.getElementById("imageViewer");

      viewer.addEventListener("click", (e) => {
        if (e.target.id === "viewerBackdrop") {
          closeImageViewer();
        }
      });

      img.addEventListener("touchstart", (e) => {
        if (e.touches.length === 2) {
          e.preventDefault();
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          viewerStartDist = Math.sqrt(dx * dx + dy * dy);
          viewerLastScale = viewerScale;
        } else if (e.touches.length === 1 && viewerScale > 1) {
          isPanning = true;
          panStartX = e.touches[0].clientX - viewerTransX;
          panStartY = e.touches[0].clientY - viewerTransY;
        }
      }, { passive: false });

      img.addEventListener("touchmove", (e) => {
        if (e.touches.length === 2) {
          e.preventDefault();
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (viewerStartDist > 0) {
            let scale = viewerLastScale * (dist / viewerStartDist);
            if (scale < 1) scale = 1;
            if (scale > 4) scale = 4;
            viewerScale = scale;
            updateViewerTransform();
          }
        } else if (e.touches.length === 1 && isPanning) {
          e.preventDefault();
          viewerTransX = e.touches[0].clientX - panStartX;
          viewerTransY = e.touches[0].clientY - panStartY;
          updateViewerTransform();
        }
      }, { passive: false });

      img.addEventListener("touchend", (e) => {
        if (e.touches.length < 2) {
          viewerStartDist = 0;
          viewerLastScale = viewerScale;
        }
        if (e.touches.length === 0) {
          isPanning = false;
        }
      });
    }

    // -------- 폼 저장 핸들러 --------
    async function saveFilmFromForm(event) {
      event.preventDefault();
      const id = document.getElementById("filmId").value || null;
      const productName = document.getElementById("productName").value.trim();
      const filmNumber = document.getElementById("filmNumber").value.trim();
      const plateType = document.getElementById("plateType").value.trim();
      const location = document.getElementById("location").value.trim();
      const lastUsed = document.getElementById("lastUsed").value || "";
      const plateInfo = buildPlateInfoFromForm();
      const imageInput = document.getElementById("imageInput");

      if (!productName || !filmNumber) {
        alert("제품 이름과 필름 번호는 필수입니다.");
        return;
      }

      const baseData = {
        productName,
        filmNumber,
        plateType,
        plateInfo,
        location,
        lastUsed
      };

      try {
        let imageDataUrlToUse = null;

        if (imageInput.files && imageInput.files[0]) {
          const file = imageInput.files[0];
          const reader = new FileReader();
          const loadPromise = new Promise(resolve => {
            reader.onload = async (e) => {
              const original = e.target.result;
              const compressed = await compressImage(original);
              resolve(compressed);
            };
          });
          reader.readAsDataURL(file);
          imageDataUrlToUse = await loadPromise;
        }

        if (id) {
          await updateFilm(id, baseData, imageDataUrlToUse);
          showToast("수정 완료!");
        } else {
          await createFilm(baseData, imageDataUrlToUse || "");
          showToast("저장 완료!");
        }

        closeForm();
      } catch (e) {
        console.error(e);
        alert("저장하는 중 오류가 발생했어.");
      }
    }

    // -------- 데이터 내보내기 / 불러오기 --------
    function exportData() {
      const json = JSON.stringify(films, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const date = new Date().toISOString().slice(0, 10).replace(/-/g, "");
      a.href = url;
      a.download = "films_" + date + ".json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function importData(file) {
      const reader = new FileReader();
      reader.onload = async function (e) {
        try {
          const data = JSON.parse(e.target.result);
          if (!Array.isArray(data)) {
            alert("형식이 올바르지 않은 파일입니다.");
            return;
          }
          for (const f of data) {
            const payload = {
              productName: f.productName || "",
              filmNumber: f.filmNumber || "",
              plateType: f.plateType || "",
              plateInfo: f.plateInfo || "",
              location: f.location || "",
              lastUsed: f.lastUsed || "",
              imageDataUrl: f.imageDataUrl || "",
              createdAt: f.createdAt || Date.now(),
              updatedAt: Date.now(),
              history: f.history || [buildHistoryEntry("가져오기")]
            };
            await addDoc(filmsCol, payload);
          }
          alert("데이터를 불러왔습니다.");
        } catch (err) {
          console.error(err);
          alert("파일을 읽는 중 오류가 발생했습니다.");
        }
      };
      reader.readAsText(file, "utf-8");
    }

    // -------- 설정 --------
    function openSettings() {
      document.getElementById("settingsCard").style.display = "block";
      document.getElementById("deviceNameInput").value = getDeviceName();
      loadSortSettings();
      const currentPw = localStorage.getItem(PASSWORD_KEY) || "";
      document.getElementById("oldPasswordInput").value = "";
      document.getElementById("newPasswordInput").value = "";
      if (!currentPw) {
        document.getElementById("oldPasswordInput").placeholder = "현재 비밀번호 (없음)";
      } else {
        document.getElementById("oldPasswordInput").placeholder = "현재 비밀번호";
      }
    }
    function closeSettings() {
      document.getElementById("settingsCard").style.display = "none";
    }
    function saveSettings() {
      const name = document.getElementById("deviceNameInput").value.trim() || "미지정 기기";
      localStorage.setItem(DEVICE_KEY, name);
      deviceName = name;
      updateDeviceBadge();

      // 정렬
      saveSortSettingsFromUI();

      // 비밀번호
      const currentPw = localStorage.getItem(PASSWORD_KEY) || "";
      const oldPwInput = document.getElementById("oldPasswordInput").value;
      const newPwInput = document.getElementById("newPasswordInput").value.trim();

      let toStore = currentPw;

      if (currentPw) {
        if (oldPwInput || newPwInput) {
          if (oldPwInput !== currentPw) {
            alert("현재 비밀번호가 틀렸어.");
            return;
          }
          toStore = newPwInput;
        }
      } else {
        if (newPwInput) {
          toStore = newPwInput;
        } else {
          toStore = "";
        }
      }

      if (toStore) {
        localStorage.setItem(PASSWORD_KEY, toStore);
      } else {
        localStorage.removeItem(PASSWORD_KEY);
      }

      showToast("설정을 저장했어.");
      closeSettings();
      initLockScreen();
      renderList(currentFilterText);
    }

    // -------- 잠금 화면 --------
    function initLockScreen() {
      const app = document.getElementById("appContainer");
      const lock = document.getElementById("lockScreen");
      const savedPw = localStorage.getItem(PASSWORD_KEY) || "";

      if (!savedPw) {
        lock.style.display = "none";
        app.style.visibility = "visible";
        app.style.pointerEvents = "auto";
        return;
      }

      lock.style.display = "flex";
      app.style.visibility = "hidden";
      app.style.pointerEvents = "none";

      const input = document.getElementById("lockInput");
      input.value = "";
      input.focus();

      document.getElementById("lockSubmitBtn").onclick = () => {
        const val = input.value;
        if (val === savedPw) {
          lock.style.display = "none";
          app.style.visibility = "visible";
          app.style.pointerEvents = "auto";
          input.value = "";
        } else {
          alert("비밀번호가 틀렸어.");
        }
      };
    }

    // -------- Firebase 리스너 초기화 --------
    function initFirebaseListener() {
      const q = query(filmsCol, orderBy("updatedAt", "desc"));
      onSnapshot(q, (snapshot) => {
        const arr = [];
        snapshot.forEach(docSnap => {
          arr.push({ id: docSnap.id, ...docSnap.data() });
        });
        films = arr;
        renderList(currentFilterText);
      });
    }

    // -------- 초기화 --------
    function initApp() {
      updateDeviceBadge();
      loadSortSettings();
      initFirebaseListener();
      initImageViewerTouch();
      initLockScreen();

      document.getElementById("newFilmBtn").addEventListener("click", openFormNew);
      document.getElementById("cancelBtn").addEventListener("click", closeForm);
      document.getElementById("filmForm").addEventListener("submit", saveFilmFromForm);
      document.getElementById("saveBtn").addEventListener("click", saveFilmFromForm);
      document.getElementById("searchInput").addEventListener("input", (e) => {
        currentFilterText = e.target.value;
        renderList(currentFilterText);
      });
      document.getElementById("setTodayBtn").addEventListener("click", () => {
        const today = new Date().toISOString().slice(0, 10);
        document.getElementById("lastUsed").value = today;
      });

      document.querySelectorAll(".toggle-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const group = btn.closest(".toggle-group");
          group.querySelectorAll(".toggle-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
        });
      });

      document.getElementById("exportBtn").addEventListener("click", exportData);
      document.getElementById("importBtn").addEventListener("click", () => {
        document.getElementById("importFile").click();
      });
      document.getElementById("importFile").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) importData(file);
        e.target.value = "";
      });

      document.getElementById("settingsBtn").addEventListener("click", openSettings);
      document.getElementById("closeSettingsBtn").addEventListener("click", closeSettings);
      document.getElementById("saveSettingsBtn").addEventListener("click", saveSettings);

      document.getElementById("closeViewerBtn").addEventListener("click", closeImageViewer);
      document.getElementById("closeHistoryBtn").addEventListener("click", closeHistoryModal);

      // 앱 컨테이너는 잠금 여부 상관없이 일단 렌더 준비
      const app = document.getElementById("appContainer");
      if (!localStorage.getItem(PASSWORD_KEY)) {
        app.style.visibility = "visible";
        app.style.pointerEvents = "auto";
      }
    }

    document.addEventListener("DOMContentLoaded", initApp);
  </script>
</body>
</html>
