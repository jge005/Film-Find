<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#f9f4ff">
  <meta charset="UTF-8" />
  <title>FILM FIND - í•„ë¦„/íŒ ê´€ë¦¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- í°íŠ¸ (Pretendard) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css" />

  <style>
    :root {
      /* ê¸°ë³¸(ë¼ë²¤ë”) í…Œë§ˆ */
      --bg-gradient: linear-gradient(145deg, #f9fafb, #f4f0ff, #fdf2f8);
      --card-bg: rgba(255,255,255,0.98);
      --card-border: #e3e6ff;
      --shadow-soft: 0 8px 20px rgba(167, 173, 208, 0.35);

      --text-main: #272a3f;
      --text-sub: #767a98;
      --text-muted: #777b9e;
      --label-color: #8689a5;

      --primary-1: #7f9dff;
      --primary-2: #b38cff;
      --primary-soft: rgba(228,231,255,0.95);

      --chip-bg: #f3e8ff;
      --chip-text: #5f308c;

      --danger-bg: #ff6b81;
      --danger-text: #ffffff;

      --pill-bg: rgba(228,231,255,0.98);
      --pill-border: rgba(129, 140, 248, 0.4);

      --toast-bg: rgba(15,23,42,0.9);
      --toast-text: #f9fafb;

      --spinner-border: rgba(191, 219, 254, 0.9);
      --spinner-glow: rgba(129, 140, 248, 0.7);
    }

    /* ë¯¼íŠ¸ í…Œë§ˆ */
    [data-theme="mint"] {
      --bg-gradient: linear-gradient(145deg, #f0fdfa, #e0f2fe, #fefce8);
      --primary-1: #34d399;
      --primary-2: #22c55e;
      --primary-soft: rgba(187,247,208,0.85);
      --chip-bg: #dcfce7;
      --chip-text: #047857;
      --pill-bg: rgba(219, 234, 254, 0.96);
      --pill-border: rgba(45, 212, 191, 0.5);
      --spinner-border: rgba(167, 243, 208, 0.9);
      --spinner-glow: rgba(45, 212, 191, 0.7);
    }

    /* í”¼ì¹˜ í…Œë§ˆ */
    [data-theme="peach"] {
      --bg-gradient: linear-gradient(145deg, #fff7ed, #fee2e2, #fef9c3);
      --primary-1: #fb7185;
      --primary-2: #f97316;
      --primary-soft: rgba(254, 226, 226, 0.9);
      --chip-bg: #ffe4e6;
      --chip-text: #be123c;
      --pill-bg: rgba(254, 226, 226, 0.96);
      --pill-border: rgba(248, 113, 113, 0.55);
      --spinner-border: rgba(254, 202, 202, 0.9);
      --spinner-glow: rgba(248, 113, 113, 0.75);
    }

    /* ë‚˜ì´íŠ¸(ì–´ë‘ìš´) í…Œë§ˆ */
    [data-theme="night"] {
      --bg-gradient: radial-gradient(circle at top, #020617, #020617, #111827);
      --card-bg: rgba(15,23,42,0.98);
      --card-border: #1f2937;
      --shadow-soft: 0 10px 24px rgba(15, 23, 42, 0.75);

      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --text-muted: #9ca3af;
      --label-color: #9ca3af;

      --primary-1: #6366f1;
      --primary-2: #a855f7;
      --primary-soft: rgba(79,70,229,0.22);

      --chip-bg: rgba(79,70,229,0.18);
      --chip-text: #a5b4fc;

      --danger-bg: #f97373;
      --danger-text: #111827;

      --pill-bg: rgba(17,24,39,0.95);
      --pill-border: rgba(129, 140, 248, 0.8);

      --toast-bg: rgba(17,24,39,0.95);
      --toast-text: #e5e7eb;

      --spinner-border: rgba(55, 65, 81, 0.9);
      --spinner-glow: rgba(129, 140, 248, 0.85);
    }

    * {
      box-sizing: border-box;
      font-family: "Pretendard Variable", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg-gradient);
      padding: 12px;
      color: var(--text-main);
    }
    .app-shell { max-width: 720px; margin: 0 auto; }

    .app-header {
      max-width: 720px;
      margin: 0 auto 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .title-wrap { display: flex; flex-direction: column; gap: 2px; }
    .app-title { font-size: 20px; font-weight: 700; letter-spacing: 2px; color: var(--text-main); }
    .app-subtitle { font-size: 11px; color: var(--text-sub); }

    .device-badge {
      font-size: 11px;
      padding: 4px 12px;
      border-radius: 999px;
      background: var(--pill-bg);
      color: var(--text-sub);
      white-space: nowrap;
      max-width: 160px;
      text-overflow: ellipsis;
      overflow: hidden;
      border: 1px solid var(--pill-border);
      box-shadow: 0 0 8px rgba(129, 140, 248, 0.28);
      display: flex;
      align-items: center;
      gap: 6px;
      justify-content: flex-end;
    }
    .device-dot { width: 6px; height: 6px; border-radius: 999px; background: var(--primary-1); box-shadow: 0 0 6px rgba(129, 140, 248, 0.9); }
    .mode-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--pill-border);
      background: var(--pill-bg);
      font-size: 11px;
      color: var(--text-sub);
      max-width: 140px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .mode-dot { width: 6px; height: 6px; border-radius: 999px; background: var(--primary-2); box-shadow: 0 0 6px rgba(179, 140, 255, 0.8); }

    .top-bar { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
    .top-bar input[type="text"] {
      flex: 1;
      padding: 9px 11px;
      border-radius: 999px;
      border: 1px solid var(--card-border);
      font-size: 14px;
      min-width: 0;
      background: rgba(255,255,255,0.9);
      color: var(--text-main);
    }
    .top-bar input::placeholder { color: var(--text-muted); }
    [data-theme="night"] .top-bar input[type="text"] { background: #020617; border-color: #1f2937; }

    .btn {
      padding: 8px 11px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      transition: transform 0.05s ease, box-shadow 0.1s ease, background 0.1s ease, opacity 0.1s ease;
    }
    .btn:active { transform: translateY(1px); box-shadow: none; opacity: 0.92; }
    .btn-primary { background: linear-gradient(135deg, var(--primary-1), var(--primary-2)); color: white; box-shadow: 0 4px 10px rgba(127,157,255,0.35); }
    .btn-secondary { background: var(--primary-soft); color: #283252; }
    [data-theme="night"] .btn-secondary { color: #e5e7eb; }
    .btn-danger { background: var(--danger-bg); color: var(--danger-text); }
    .btn-small { font-size: 12px; padding: 5px 9px; border-radius: 999px; }
    .btn-ghost { background: rgba(255,255,255,0.55); border: 1px solid var(--card-border); color: var(--text-main); }
    [data-theme="night"] .btn-ghost { background: rgba(2,6,23,0.55); border-color: #1f2937; color: #e5e7eb; }

    .tools-bar { display: flex; gap: 6px; margin-bottom: 6px; flex-wrap: wrap; justify-content: flex-end; }

    .tabbar { display: flex; gap: 8px; align-items: center; justify-content: flex-start; margin: 8px 0 10px; flex-wrap: wrap; }
    .tab-btn {
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--card-border);
      background: rgba(255,255,255,0.7);
      color: var(--text-main);
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    [data-theme="night"] .tab-btn { background: rgba(2,6,23,0.55); border-color: #1f2937; }
    .tab-btn.active {
      border-color: var(--primary-1);
      background: linear-gradient(135deg, var(--primary-1), var(--primary-2));
      color: #fff;
      box-shadow: 0 6px 16px rgba(127,157,255,0.25);
    }

    .count-wrap { display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 10px; }
    .count-bar { font-size: 11px; color: var(--text-muted); text-align: left; flex: 1; }
    .count-bar strong { color: var(--primary-1); }

    .form-card {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 12px 14px;
      margin-bottom: 12px;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--card-border);
    }
    .form-row { display: flex; flex-direction: column; margin-bottom: 9px; }
    .form-row label { font-size: 12px; margin-bottom: 4px; color: var(--label-color); }
    .form-row input[type="text"],
    .form-row input[type="date"],
    .form-row input[type="password"],
    .form-row input[type="number"],
    .form-row select,
    .form-row textarea {
      padding: 7px 10px;
      border-radius: 10px;
      border: 1px solid var(--card-border);
      font-size: 13px;
      background: #f9f9ff;
      color: var(--text-main);
    }
    [data-theme="night"] .form-row input[type="text"],
    [data-theme="night"] .form-row input[type="date"],
    [data-theme="night"] .form-row input[type="password"],
    [data-theme="night"] .form-row input[type="number"],
    [data-theme="night"] .form-row select,
    [data-theme="night"] .form-row textarea {
      background: #020617;
      border-color: #1f2937;
      color: #e5e7eb;
    }
    .form-actions { display: flex; justify-content: flex-end; gap: 6px; margin-top: 6px; }

    .list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 24px; }
    .list.gallery { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .list.gallery .card { flex-direction: column; align-items: stretch; }
    .list.gallery .card img { width: 100%; height: 180px; object-fit: cover; }

    .card {
      background: rgba(255,255,255,0.96);
      border-radius: 16px;
      padding: 10px;
      display: flex;
      gap: 10px;
      box-shadow: 0 6px 16px rgba(169, 177, 214, 0.35);
      align-items: flex-start;
      border: 1px solid var(--card-border);
      animation: cardFadeIn 0.18s ease-out;
      position: relative;
    }
    [data-theme="night"] .card { background: rgba(15,23,42,0.98); box-shadow: 0 8px 22px rgba(15,23,42,0.85); }
    @keyframes cardFadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

    .card img {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 12px;
      background: #eef1ff;
      flex-shrink: 0;
      cursor: pointer;
    }
    .card-content { flex: 1; font-size: 13px; }
    .card-row-main { display: flex; justify-content: space-between; gap: 6px; margin-bottom: 4px; align-items: center; }
    .card-title { font-weight: 600; font-size: 14px; color: var(--text-main); display: inline-flex; align-items: center; gap: 6px; flex-wrap: wrap; }
    .card-tag { font-size: 11px; padding: 3px 7px; border-radius: 999px; background: var(--chip-bg); color: var(--chip-text); align-self: flex-start; display: inline-flex; align-items: center; gap: 6px; }
    .card-row { margin-bottom: 2px; color: var(--text-main); }
    .label { color: var(--label-color); font-size: 11px; margin-right: 4px; }
    .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 6px; gap: 6px; flex-wrap: wrap; }
    .last-used { font-size: 11px; color: var(--text-muted); }
    .card-buttons { display: flex; gap: 4px; flex-wrap: wrap; justify-content: flex-end; }

    .empty-text { text-align: center; color: #777; font-size: 13px; margin-top: 20px; }
    [data-theme="night"] .empty-text { color: #9ca3af; }

    .toggle-group { display: flex; gap: 6px; margin-bottom: 4px; flex-wrap: wrap; }
    .toggle-btn {
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid var(--card-border);
      background: #f5f3ff;
      color: #464b73;
      cursor: pointer;
      transition: background 0.1s ease, color 0.1s ease, border 0.1s ease;
    }
    .toggle-btn.active { border-color: var(--primary-1); background: var(--primary-1); color: #fff; }

    /* ì ê¸ˆ í™”ë©´ */
    .lock-screen {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(255,255,255,0.95), rgba(203,213,255,0.96));
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 1000;
    }
    .lock-card {
      width: 100%;
      max-width: 320px;
      margin: 0 auto;
      background: rgba(255,255,255,0.98);
      border-radius: 20px;
      padding: 16px 18px;
      box-shadow: 0 12px 28px rgba(136, 144, 195, 0.55);
      border: 1px solid #dde1ff;
      text-align: center;
    }
    .lock-input-wrap { display: flex; gap: 8px; align-items: center; justify-content: space-between; }
    .lock-input-wrap input {
      flex: 1;
      padding: 10px 10px;
      border-radius: 999px;
      border: 1px solid #d6d9ff;
      background: #f7f7ff;
      text-align: center;
      font-size: 14px;
      letter-spacing: 3px;
      min-width: 0;
    }

    .settings-section-title { font-size: 13px; font-weight: 600; margin-bottom: 4px; color: #3c4266; }
    .settings-help { font-size: 11px; color: #8a8fb0; margin-bottom: 6px; line-height: 1.4; }
    [data-theme="night"] .settings-section-title { color: #e5e7eb; }
    [data-theme="night"] .settings-help { color: #9ca3af; }

    /* ì´ë¯¸ì§€ ì „ì²´ ë³´ê¸° */
    .image-viewer { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 1500; }
    .image-viewer-backdrop { position: absolute; inset: 0; background: rgba(15, 23, 42, 0.75); }
    .image-viewer-inner { position: relative; max-width: 100%; max-height: 100%; display: flex; align-items: center; justify-content: center; padding: 16px; }
    #viewerImage { max-width: 100%; max-height: 100%; border-radius: 12px; box-shadow: 0 16px 40px rgba(0,0,0,0.5); touch-action: none; transition: transform 0.1s ease-out; }
    .viewer-close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      border-radius: 999px;
      border: none;
      padding: 6px 10px;
      font-size: 14px;
      cursor: pointer;
      background: rgba(15,23,42,0.8);
      color: #f9fafb;
    }

    /* ê¸°ê¸° ì´ë¦„ ìµœì´ˆ ì…ë ¥ ëª¨ë‹¬ */
    .device-modal {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1200;
      padding: 16px;
    }
    .device-modal-card { background: #fff; border-radius: 18px; padding: 16px 18px 14px; max-width: 320px; width: 100%; box-shadow: 0 10px 24px rgba(0,0,0,0.25); }
    .device-modal-title { font-size: 15px; font-weight: 600; margin-bottom: 6px; color: #272a3f; }
    .device-modal-text { font-size: 12px; color: #767a98; margin-bottom: 10px; line-height: 1.45; }
    .device-modal-input { width: 100%; padding: 7px 10px; border-radius: 10px; border: 1px solid #d6d9ff; font-size: 13px; background: #f9f9ff; margin-bottom: 10px; }
    .device-modal-actions { display: flex; justify-content: flex-end; gap: 6px; }

    /* í† ìŠ¤íŠ¸ */
    .toast {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%) translateY(40px);
      background: var(--toast-bg);
      color: var(--toast-text);
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 2000;
      max-width: 80%;
      text-align: center;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      box-shadow: 0 10px 24px rgba(15,23,42,0.6);
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* íˆìŠ¤í† ë¦¬ íƒ€ì„ë¼ì¸ */
    .history-list { max-height: 280px; overflow-y: auto; padding-right: 4px; margin-top: 4px; position: relative; }
    .history-list::before { content: ""; position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: linear-gradient(to bottom, rgba(148,163,184,0.6), rgba(199,210,254,0.2)); }
    .history-row { font-size: 12px; color: #444867; padding: 6px 2px 6px 20px; position: relative; }
    [data-theme="night"] .history-row { color: #e5e7eb; }
    .history-row::before { content: ""; position: absolute; left: 4px; top: 10px; width: 8px; height: 8px; border-radius: 999px; background: #fff; border: 2px solid var(--primary-1); box-shadow: 0 0 0 4px rgba(129,140,248,0.15); }
    .history-time { color: #6b6f90; font-size: 11px; }
    [data-theme="night"] .history-time { color: #9ca3af; }
    .history-device { color: var(--primary-1); font-size: 11px; margin-left: 4px; }
    .history-action-chip { display: inline-block; margin-left: 6px; padding: 1px 6px; border-radius: 999px; font-size: 11px; background: var(--chip-bg); color: var(--chip-text); }
    .history-film { color: #111827; font-weight: 500; }
    [data-theme="night"] .history-film { color: #e5e7eb; }
    .history-changes { font-size: 11px; color: #6b7280; margin-top: 2px; }
    [data-theme="night"] .history-changes { color: #9ca3af; }
    .history-empty { font-size: 12px; color: #6b7280; padding-left: 20px; margin-top: 6px; }
    [data-theme="night"] .history-empty { color: #9ca3af; }

    /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
    .spinner-wrapper { display: none; justify-content: center; align-items: center; padding: 4px 0 16px; }
    .spinner-wrapper.show { display: flex; }
    .spinner-circle {
      width: 28px; height: 28px; border-radius: 999px;
      border: 3px solid var(--spinner-border);
      border-top-color: var(--primary-1);
      box-shadow: 0 0 12px var(--spinner-glow);
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ë§¨ ìœ„ë¡œ ë²„íŠ¼ */
    .scroll-top-btn {
      position: fixed;
      right: 16px;
      bottom: 24px;
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: none;
      font-size: 18px;
      cursor: pointer;
      background: linear-gradient(135deg, var(--primary-1), var(--primary-2));
      color: #fff;
      display: none;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 24px rgba(107,114,128,0.6);
      z-index: 1900;
    }
    .scroll-top-btn.show { display: flex; }

    @media (min-width: 768px) { body { padding-top: 24px; } }
    @media (min-width: 600px) { .list.gallery { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (min-width: 1024px) {
      .app-shell, .app-header { max-width: 1080px; }
      .list.gallery { grid-template-columns: repeat(3, minmax(260px, 1fr)); }
    }

    /* ====== í•„ë¦„/íŒ ë©”ëª¨: ìŠ¬ë¼ì´ë“œ ====== */
    .memo-sheet { position: fixed; inset: 0; display: none; align-items: flex-end; justify-content: center; z-index: 1600; }
    .memo-sheet.show { display: flex; }
    .memo-sheet-backdrop { position: absolute; inset: 0; background: rgba(15, 23, 42, 0.45); }
    .memo-sheet-panel {
      position: relative;
      width: 100%;
      max-width: 720px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 18px 18px 0 0;
      box-shadow: 0 -12px 28px rgba(0,0,0,0.25);
      padding: 12px 14px 14px;
      animation: sheetUp 0.16s ease-out;
    }
    @keyframes sheetUp { from { transform: translateY(14px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .memo-sheet-head { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 10px; }
    .memo-sheet-title { font-size: 14px; font-weight: 700; color: var(--text-main); }
    .memo-sheet-sub { font-size: 11px; color: var(--text-sub); margin-top: 2px; }
    .memo-sheet-textarea {
      width: 100%;
      min-height: 120px;
      resize: vertical;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--card-border);
      background: #f9f9ff;
      color: var(--text-main);
      font-size: 13px;
      line-height: 1.45;
    }
    [data-theme="night"] .memo-sheet-textarea { background: #020617; border-color: #1f2937; color: #e5e7eb; }
    .memo-sheet-actions { display: flex; justify-content: flex-end; gap: 6px; margin-top: 10px; }
    .btn-memo-has { box-shadow: 0 0 0 2px rgba(127,157,255,0.18) inset; }

    /* ====== íˆìŠ¤í† ë¦¬: ì—°í•„ ë²„íŠ¼ + ë…¸íŠ¸ í‘œì‹œ ====== */
    .history-headline { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
    .history-pencil { border: none; cursor: pointer; padding: 4px 8px; border-radius: 999px; font-size: 12px; background: var(--primary-soft); color: var(--text-main); }
    [data-theme="night"] .history-pencil { color: #e5e7eb; }
    .history-note {
      margin-top: 6px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--card-border);
      background: rgba(228,231,255,0.65);
      font-size: 12px;
      color: var(--text-main);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    [data-theme="night"] .history-note { background: rgba(79,70,229,0.18); border-color: #1f2937; }

    /* ====== íˆìŠ¤í† ë¦¬ ë©”ëª¨ ëª¨ë‹¬ ====== */
    .note-modal { position: fixed; inset: 0; background: rgba(15,23,42,0.35); display: none; align-items: center; justify-content: center; z-index: 1700; padding: 16px; }
    .note-modal.show { display: flex; }
    .note-modal-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 18px;
      padding: 16px 18px 14px;
      max-width: 380px;
      width: 100%;
      box-shadow: 0 10px 24px rgba(0,0,0,0.25);
    }
    .note-modal-title { font-size: 15px; font-weight: 700; margin-bottom: 6px; color: var(--text-main); }
    .note-modal-text { font-size: 12px; color: var(--text-sub); margin-bottom: 10px; }
    .note-modal-textarea {
      width: 100%;
      min-height: 120px;
      resize: vertical;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--card-border);
      background: #f9f9ff;
      color: var(--text-main);
      font-size: 13px;
      line-height: 1.45;
    }
    [data-theme="night"] .note-modal-textarea { background: #020617; border-color: #1f2937; color: #e5e7eb; }
    .note-modal-actions { display: flex; justify-content: flex-end; gap: 6px; margin-top: 10px; }

    /* ====== íŒ ì‚¬ìš©/íˆìŠ¤í† ë¦¬ ì‹œíŠ¸ ====== */
    .sheet { position: fixed; inset: 0; display: none; align-items: flex-end; justify-content: center; z-index: 1650; }
    .sheet.show { display: flex; }
    .sheet-backdrop { position: absolute; inset: 0; background: rgba(15,23,42,0.45); }
    .sheet-panel {
      position: relative;
      width: 100%;
      max-width: 720px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 18px 18px 0 0;
      box-shadow: 0 -12px 28px rgba(0,0,0,0.25);
      padding: 12px 14px 14px;
      animation: sheetUp 0.16s ease-out;
    }
    .sheet-head { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 10px; }
    .sheet-title { font-size: 14px; font-weight: 700; color: var(--text-main); }
    .sheet-sub { font-size: 11px; color: var(--text-sub); margin-top: 2px; }
    .sheet-actions { display: flex; justify-content: flex-end; gap: 6px; margin-top: 10px; }

    .usage-meta { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
    .usage-chip {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--chip-bg);
      color: var(--chip-text);
      border: 1px solid rgba(0,0,0,0.03);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .progress-pill {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--card-border);
      background: rgba(255,255,255,0.6);
      color: var(--text-main);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    [data-theme="night"] .progress-pill {
      background: rgba(2,6,23,0.55);
      border-color: #1f2937;
      color: #e5e7eb;
    }
    .usage-list {
      max-height: 300px;
      overflow-y: auto;
      padding-right: 4px;
      margin-top: 8px;
      border-top: 1px dashed rgba(148,163,184,0.45);
      padding-top: 10px;
    }
    .usage-row {
      font-size: 12px;
      padding: 8px 10px;
      border: 1px solid var(--card-border);
      border-radius: 12px;
      margin-bottom: 8px;
      background: rgba(255,255,255,0.65);
    }
    [data-theme="night"] .usage-row { background: rgba(2,6,23,0.45); border-color: #1f2937; }
    .usage-row .u-top { display: flex; justify-content: space-between; gap: 8px; align-items: baseline; flex-wrap: wrap; }
    .usage-row .u-time { font-size: 11px; color: var(--text-muted); }
    .usage-row .u-who { font-weight: 600; color: var(--text-main); }
    .usage-row .u-qty { font-weight: 700; color: var(--primary-1); }
    .usage-row .u-memo { margin-top: 6px; color: var(--text-main); opacity: 0.9; }
  </style>
</head>

<body>
  <!-- ì ê¸ˆ í™”ë©´ (íŒíŠ¸/ë¬¸êµ¬/ì„¤ëª… ì—†ìŒ) -->
  <div id="lockScreen" class="lock-screen">
    <div class="lock-card">
      <div class="lock-input-wrap">
        <input type="password" id="passwordInput" maxlength="20" />
        <button class="btn btn-primary btn-small" id="passwordBtn">ì…ì¥</button>
      </div>
    </div>
  </div>

  <!-- ê¸°ê¸° ì´ë¦„ ìµœì´ˆ ì…ë ¥ ëª¨ë‹¬ -->
  <div id="deviceModal" class="device-modal">
    <div class="device-modal-card">
      <div class="device-modal-title">ì´ ê¸°ê¸° ì´ë¦„ ì •í•˜ê¸°</div>
      <div class="device-modal-text">
        ì˜ˆ: ê°€ì€í°, ì„±ê·œíŒ¨ë“œ, íšŒì‚¬PC<br />
        (ê¸°ê¸° ì´ë¦„ì€ ì´ ê¸°ê¸°ì—ì„œë§Œ í‘œì‹œë¼)
      </div>
      <input id="deviceModalInput" class="device-modal-input" type="text" placeholder="ì˜ˆ: ê°€ì€í°" />
      <div class="device-modal-actions">
        <button class="btn btn-secondary btn-small" id="deviceModalSkip">ë‚˜ì¤‘ì—</button>
        <button class="btn btn-primary btn-small" id="deviceModalSave">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ì´ë¯¸ì§€ ì „ì²´ë³´ê¸° -->
  <div id="imageViewer" class="image-viewer">
    <div class="image-viewer-backdrop" id="viewerBackdrop"></div>
    <div class="image-viewer-inner">
      <img id="viewerImage" src="" alt="ì´ë¯¸ì§€" />
      <button id="closeViewerBtn" class="viewer-close-btn">âœ•</button>
    </div>
  </div>

  <!-- í† ìŠ¤íŠ¸ -->
  <div id="toast" class="toast"></div>

  <!-- ====== í•„ë¦„ ë©”ëª¨ ìŠ¬ë¼ì´ë“œ ====== -->
  <div id="memoSheet" class="memo-sheet">
    <div id="memoSheetBackdrop" class="memo-sheet-backdrop"></div>
    <div class="memo-sheet-panel">
      <div class="memo-sheet-head">
        <div>
          <div class="memo-sheet-title" id="memoSheetTitle">ë©”ëª¨</div>
          <div class="memo-sheet-sub" id="memoSheetSub">í•„ë¦„ë³„ ë©”ëª¨</div>
        </div>
        <button class="btn btn-secondary btn-small" id="memoSheetCloseBtn">ë‹«ê¸°</button>
      </div>
      <textarea id="memoTextarea" class="memo-sheet-textarea" placeholder="ì˜ˆ: í…ì…˜ 23 ì´í•˜ì—ì„œ ë²ˆì§ / ìš°ì¸¡ 2mm ë°€ë¦¼ ì£¼ì˜"></textarea>
      <div class="memo-sheet-actions">
        <button class="btn btn-secondary btn-small" id="memoSheetCancelBtn">ì·¨ì†Œ</button>
        <button class="btn btn-primary btn-small" id="memoSheetSaveBtn">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ====== íŒ ë©”ëª¨ ìŠ¬ë¼ì´ë“œ ====== -->
  <div id="plateMemoSheet" class="memo-sheet">
    <div id="plateMemoBackdrop" class="memo-sheet-backdrop"></div>
    <div class="memo-sheet-panel">
      <div class="memo-sheet-head">
        <div>
          <div class="memo-sheet-title" id="plateMemoTitle">íŒ ë©”ëª¨</div>
          <div class="memo-sheet-sub" id="plateMemoSub">íŒë³„ ë©”ëª¨</div>
        </div>
        <button class="btn btn-secondary btn-small" id="plateMemoCloseBtn">ë‹«ê¸°</button>
      </div>
      <textarea id="plateMemoTextarea" class="memo-sheet-textarea" placeholder="ì˜ˆ: 3êµ¬ì—­ ëŠ˜ì–´ì§ / ì¢Œì¸¡ 1mm ë°€ë¦¼"></textarea>
      <div class="memo-sheet-actions">
        <button class="btn btn-secondary btn-small" id="plateMemoCancelBtn">ì·¨ì†Œ</button>
        <button class="btn btn-primary btn-small" id="plateMemoSaveBtn">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ====== íŒ ì‚¬ìš© ë“±ë¡ ì‹œíŠ¸ ====== -->
  <div id="plateUseSheet" class="sheet">
    <div id="plateUseBackdrop" class="sheet-backdrop"></div>
    <div class="sheet-panel">
      <div class="sheet-head">
        <div>
          <div class="sheet-title" id="plateUseTitle">íŒ ì‚¬ìš©ë“±ë¡</div>
          <div class="sheet-sub" id="plateUseSub">ì‹œê°„ì€ ìë™ ê¸°ë¡</div>
        </div>
        <button class="btn btn-secondary btn-small" id="plateUseCloseBtn">ë‹«ê¸°</button>
      </div>

      <div class="usage-meta" id="plateUseMeta"></div>

      <div class="form-row">
        <label for="plateUseWho">ì¸ì‡„ê¸°ì‚¬</label>
        <select id="plateUseWho"></select>
        <div style="display:flex; gap:6px; margin-top:6px;">
          <button class="btn btn-ghost btn-small" id="printerAddBtn" type="button">+ ì¶”ê°€</button>
          <button class="btn btn-ghost btn-small" id="printerDelBtn" type="button">- ì‚­ì œ</button>
        </div>
      </div>

      <div class="form-row">
        <label for="plateUseQty">ì¸ì‡„ ìˆ˜ëŸ‰</label>
        <input type="number" id="plateUseQty" min="1" step="1" />
        <small style="font-size:11px; color:var(--text-sub); margin-top:6px;">
          íŒ ê¸°ë³¸ ìµœëŒ€ ì‚¬ìš© ìˆ˜ëŸ‰ì€ 5000 (í•„ìš” ì‹œ ê´€ë¦¬ìë§Œ ìˆ˜ì •)
        </small>
      </div>
      <div class="form-row">
        <label for="plateUseMemo">ë©”ëª¨</label>
        <textarea id="plateUseMemo" rows="3" placeholder="ì˜ˆ: 2mm ë°€ë¦¼ ì¡ìŒ / í…ì…˜ 24"></textarea>
      </div>

      <div class="sheet-actions">
        <button class="btn btn-secondary btn-small" id="plateUseCancelBtn">ì·¨ì†Œ</button>
        <button class="btn btn-primary btn-small" id="plateUseSaveBtn">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ====== íŒ íˆìŠ¤í† ë¦¬ ì‹œíŠ¸ ====== -->
  <div id="plateHistorySheet" class="sheet">
    <div id="plateHistoryBackdrop" class="sheet-backdrop"></div>
    <div class="sheet-panel">
      <div class="sheet-head">
        <div>
          <div class="sheet-title" id="plateHistoryTitle">íŒ íˆìŠ¤í† ë¦¬</div>
          <div class="sheet-sub" id="plateHistorySub">ì–¸ì œ / ëˆ„ê°€ / ëª‡ ê°œ / ë©”ëª¨</div>
        </div>
        <button class="btn btn-secondary btn-small" id="plateHistoryCloseBtn">ë‹«ê¸°</button>
      </div>

      <div class="usage-meta" id="plateHistoryMeta"></div>
      <div id="plateUsageList" class="usage-list"></div>

      <div class="sheet-actions">
        <button class="btn btn-secondary btn-small" id="plateHistoryCloseBtn2">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ====== íˆìŠ¤í† ë¦¬ ë©”ëª¨ ëª¨ë‹¬ ====== -->
  <div id="historyNoteModal" class="note-modal">
    <div class="note-modal-card">
      <div class="note-modal-title">íˆìŠ¤í† ë¦¬ ë©”ëª¨</div>
      <div class="note-modal-text">ì´ ë³€ê²½ ê¸°ë¡ì— â€œì™œ ë°”ë€Œì—ˆëŠ”ì§€â€ë¥¼ ì ì–´ë‘˜ ìˆ˜ ìˆì–´.</div>
      <textarea id="historyNoteTextarea" class="note-modal-textarea" placeholder="ì˜ˆ: ê²¹ì¹¨ ì´ìŠˆë¡œ 4-2-1.6ë²ˆìœ¼ë¡œ ì´ë™"></textarea>
      <div class="note-modal-actions">
        <button class="btn btn-secondary btn-small" id="historyNoteCancelBtn">ì·¨ì†Œ</button>
        <button class="btn btn-primary btn-small" id="historyNoteSaveBtn">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ì‹¤ì œ ì•± -->
  <div id="appContainer" style="display:none;">
    <div class="app-header">
      <div class="title-wrap">
        <div class="app-title">FILM FIND</div>
        <div class="app-subtitle" id="subtitleText">í•„ë¦„/íŒ ê´€ë¦¬</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <div id="modeChip" class="mode-chip">
          <span class="mode-dot"></span>
          <span id="modeChipText">-</span>
        </div>
        <div id="deviceBadge" class="device-badge">
          <span class="device-dot"></span>
          <span id="deviceBadgeText"></span>
        </div>
      </div>
    </div>

    <div class="app-shell">
      <div class="top-bar">
        <input type="text" id="searchInput" placeholder="ê²€ìƒ‰" />
        <button class="btn btn-primary" id="newFilmBtn">+ ìƒˆ í•„ë¦„</button>
      </div>

      <!-- íƒ­ (í•„ë¦„/íŒ ë¶„ë¦¬) -->
      <div class="tabbar">
        <button class="tab-btn active" id="tabFilmsBtn">í•„ë¦„</button>
        <button class="tab-btn" id="tabPlatesBtn">íŒ</button>
      </div>

      <div class="tools-bar">
        <button class="btn btn-secondary btn-small" id="settingsBtn">âš™ ì„¤ì •</button>
        <button class="btn btn-secondary btn-small" id="historyBtn">ğŸ“œ íˆìŠ¤í† ë¦¬</button>
        <button class="btn btn-secondary btn-small" id="exportBtn">ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
        <button class="btn btn-secondary btn-small" id="importBtn">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <input type="file" id="importFile" accept="application/json" style="display:none;" />
      </div>

      <div class="count-wrap">
        <div id="countBar" class="count-bar">-</div>
        <button class="btn btn-secondary btn-small" id="viewToggleBtn">ê°¤ëŸ¬ë¦¬</button>
      </div>

      <!-- ì„¤ì • ì¹´ë“œ -->
      <div class="form-card" id="settingsCard" style="display:none;">
        <div class="form-row">
          <div class="settings-section-title">ì´ ê¸°ê¸° ì´ë¦„</div>
          <div class="settings-help">ì˜ˆ: ê°€ì€í°, ì„±ê·œíŒ¨ë“œ, íšŒì‚¬PC. ì´ ê¸°ê¸°ì—ì„œë§Œ í‘œì‹œë¼.</div>
          <input type="text" id="deviceNameInput" placeholder="ê¸°ê¸° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" />
        </div>

        <div class="form-row">
          <div class="settings-section-title">ê¸°ë³¸ ì •ë ¬ ë°©ì‹</div>
          <div class="settings-help">ë¦¬ìŠ¤íŠ¸ë¥¼ ì–´ë–¤ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í• ì§€ ì„ íƒí•´.</div>
          <select id="sortOptionSelect">
            <option value="updated">ìµœê·¼ ìˆ˜ì •ìˆœ</option>
            <option value="name">ì œí’ˆëª… ê°€ë‚˜ë‹¤ìˆœ</option>
            <option value="number">í•„ë¦„ë²ˆí˜¸ ìˆœ</option>
            <option value="lastUsed">ë§ˆì§€ë§‰ ì‚¬ìš©ì¼ ìµœì‹ ìˆœ</option>
          </select>
        </div>

        <div class="form-row">
          <div class="settings-section-title">í…Œë§ˆ ìƒ‰ìƒ</div>
          <div class="settings-help">ì•±ì˜ ìƒ‰ ë¶„ìœ„ê¸°ë¥¼ ì„ íƒí•´ ì¤˜.</div>
          <select id="themeSelect">
            <option value="default">ë¼ë²¤ë”</option>
            <option value="mint">ë¯¼íŠ¸</option>
            <option value="peach">í”¼ì¹˜</option>
            <option value="night">ë‚˜ì´íŠ¸</option>
          </select>
        </div>

        <!-- ê´€ë¦¬ìë§Œ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ê°€ëŠ¥ -->
        <div class="form-row" id="pwSection" style="display:none;">
          <div class="settings-section-title">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</div>
          <div class="settings-help">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ / ì¸ì‡„ê¸°ì‚¬ ë¹„ë°€ë²ˆí˜¸ / ì¡°íšŒ ë¹„ë°€ë²ˆí˜¸</div>
          <input type="password" id="pwAdminNew" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸" />
          <input type="password" id="pwPrinterNew" placeholder="ì¸ì‡„ê¸°ì‚¬ ë¹„ë°€ë²ˆí˜¸" style="margin-top:6px;" />
          <input type="password" id="pwViewerNew" placeholder="ì¡°íšŒ ë¹„ë°€ë²ˆí˜¸" style="margin-top:6px;" />
          <input type="password" id="pwAdminCurrent" placeholder="í˜„ì¬ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸" style="margin-top:10px;" />
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary btn-small" id="closeSettingsBtn">ë‹«ê¸°</button>
          <button type="button" class="btn btn-primary btn-small" id="saveSettingsBtn">ì €ì¥</button>
        </div>
      </div>

      <!-- íˆìŠ¤í† ë¦¬ ì¹´ë“œ (ì‚­ì œ ê¸ˆì§€) -->
      <div class="form-card" id="historyCard" style="display:none;">
        <div class="settings-section-title">ğŸ“œ íˆìŠ¤í† ë¦¬</div>
        <div class="settings-help">
          ë“±ë¡ / ìˆ˜ì • / ì‚­ì œ / ì˜¤ëŠ˜ ì‚¬ìš© ê¸°ë¡ì„ ìµœê·¼ 100ê°œê¹Œì§€ ë³´ì—¬ì¤„ê²Œ.<br>
          (ê¸°ê¸° ì´ë¦„ê³¼ ì–´ë–¤ í•­ëª©ì´ ë°”ë€Œì—ˆëŠ”ì§€ë„ ê°™ì´ í‘œì‹œë¼.)
        </div>
        <div id="historyList" class="history-list"></div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary btn-small" id="closeHistoryBtn">ë‹«ê¸°</button>
        </div>
      </div>

      <!-- ====== í•„ë¦„ ì…ë ¥ í¼ ====== -->
      <div class="form-card" id="formCard" style="display:none;">
        <form id="filmForm">
          <input type="hidden" id="filmId" />
          <div class="form-row">
            <label for="productName">ì œí’ˆ ì´ë¦„ *</label>
            <input type="text" id="productName" required />
          </div>
          <div class="form-row">
            <label for="filmNumber">í•„ë¦„ ë²ˆí˜¸ *</label>
            <input type="text" id="filmNumber" required />
          </div>
          <div class="form-row">
            <label for="method">ì œíŒ íƒ€ì…</label>
            <input type="text" id="method" placeholder="ì˜ˆ: ë°”íƒ•, ë¬¸ì, ìŠ¤ëª¨ê·¸ ë“±" />
          </div>

          <div class="form-row">
            <label for="mesh">MESH</label>
            <input type="text" id="mesh" placeholder="ì˜ˆ: 180T, 200ë©”ì‰¬ ë“±" />
          </div>

          <div class="form-row">
            <label>í•„ë¦„ ì œíŒ ë°©ë²•</label>
            <div class="toggle-group" data-group="frontBack">
              <button type="button" class="toggle-btn" data-value="ì „ë©´">ì „ë©´</button>
              <button type="button" class="toggle-btn" data-value="ë°°ë©´">ë°°ë©´</button>
            </div>
            <div class="toggle-group" data-group="leftRight">
              <button type="button" class="toggle-btn" data-value="ì¢Œ">ì¢Œ</button>
              <button type="button" class="toggle-btn" data-value="ìš°">ìš°</button>
            </div>
            <div class="toggle-group" data-group="upDown">
              <button type="button" class="toggle-btn" data-value="ìƒ">ìƒ</button>
              <button type="button" class="toggle-btn" data-value="í•˜">í•˜</button>
            </div>
            <small style="font-size:11px; color:var(--text-sub);">
              ì „ë©´/ë°°ë©´ + ì¢Œ/ìš° + ìƒ/í•˜ ì¡°í•© (ì˜ˆ: ë°°ë©´ ì¢Œìƒ, ì „ë©´ ìš°í•˜ ë“±)
            </small>
          </div>

          <div class="form-row">
            <label for="location">í•„ë¦„ ìœ„ì¹˜</label>
            <input type="text" id="location" placeholder="ì˜ˆ: A-3 ì„œë, 4ì¸µ ìš°ì¸¡ ë™ ë“±" />
          </div>

          <div class="form-row">
            <label for="requestPrinter">ìš”ì²­ ì¸ì‡„ì</label>
            <select id="requestPrinter">
              <option value="">ì„ íƒ ì•ˆ í•¨</option>
              <option value="ì´ì°½ë¯¼ ë¶€ì¥ë‹˜">ì´ì°½ë¯¼ ë¶€ì¥ë‹˜</option>
              <option value="ê³ ê´‘ìš´ ê³¼ì¥ë‹˜">ê³ ê´‘ìš´ ê³¼ì¥ë‹˜</option>
              <option value="ê¹€ê·œí—Œ ì°¨ì¥ë‹˜">ê¹€ê·œí—Œ ì°¨ì¥ë‹˜</option>
              <option value="ë°•ì¬í˜„ ëŒ€ë¦¬ë‹˜">ë°•ì¬í˜„ ëŒ€ë¦¬ë‹˜</option>
              <option value="ì¡°ì˜ë¹ˆ ëŒ€ë¦¬ë‹˜">ì¡°ì˜ë¹ˆ ëŒ€ë¦¬ë‹˜</option>
              <option value="ê¹€í˜„ê·œ ëŒ€ë¦¬ë‹˜">ê¹€í˜„ê·œ ëŒ€ë¦¬ë‹˜</option>
              <option value="ì¥ì§„ìš° ëŒ€ë¦¬ë‹˜">ì¥ì§„ìš° ëŒ€ë¦¬ë‹˜</option>
              <option value="ê¹€ë¯¸ì€ ì£¼ì„ë‹˜">ê¹€ë¯¸ì€ ì£¼ì„ë‹˜</option>
              <option value="ì´ìˆ˜ì•ˆ ì‚¬ì›ë‹˜">ì´ìˆ˜ì•ˆ ì‚¬ì›ë‹˜</option>
              <option value="ë°•ì§€ì•ˆ ì‚¬ì›ë‹˜">ë°•ì§€ì•ˆ ì‚¬ì›ë‹˜</option>
              <option value="ê¹€ì¸ì„  ì‚¬ì›ë‹˜">ê¹€ì¸ì„  ì‚¬ì›ë‹˜</option>
              <option value="ê¹€ìš©ì› ì‚¬ì›ë‹˜">ê¹€ìš©ì› ì‚¬ì›ë‹˜</option>
              <option value="ìµœì„±ê·œ ì‚¬ì›ë‹˜">ìµœì„±ê·œ ì‚¬ì›ë‹˜</option>
            </select>
          </div>

          <div class="form-row">
            <label for="lastUsed">ë§ˆì§€ë§‰ ì‚¬ìš©ì¼</label>
            <div style="display:flex; gap:6px;">
              <input type="date" id="lastUsed" style="flex:1;" />
              <button type="button" class="btn btn-secondary btn-small" id="setTodayBtn">ì˜¤ëŠ˜</button>
            </div>
          </div>

          <div class="form-row">
            <label for="imageInput">í•„ë¦„ ì‚¬ì§„ (ì„ íƒ)</label>
            <input type="file" id="imageInput" accept="image/*" />
            <small style="font-size:11px; color:var(--text-sub);">
              Â· ìƒˆ í•„ë¦„ì—ëŠ” ì‚¬ì§„ì„ ì¶”ê°€í•˜ê³ ,<br/>
              Â· ìˆ˜ì • ì‹œ ì‚¬ì§„ì„ ë°”ê¾¸ê³  ì‹¶ì„ ë•Œë§Œ ë‹¤ì‹œ ì„ íƒí•˜ì„¸ìš”.
            </small>

            <div id="imagePreviewWrapper" style="margin-top:8px; display:none; align-items:center; gap:6px;">
              <img id="imagePreview" alt="ë¯¸ë¦¬ë³´ê¸°"
                   style="width:70px; height:70px; border-radius:10px; object-fit:cover; background:#eef1ff;" />
              <button type="button" class="btn btn-secondary btn-small" id="rotateLeftBtn">âŸ² 90Â°</button>
              <button type="button" class="btn btn-secondary btn-small" id="rotateRightBtn">âŸ³ 90Â°</button>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="cancelBtn">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn-primary" id="saveBtn">ì €ì¥</button>
          </div>
        </form>
      </div>

      <!-- ====== íŒ ì…ë ¥ í¼ ====== -->
      <div class="form-card" id="plateFormCard" style="display:none;">
        <form id="plateForm">
          <input type="hidden" id="plateId" />
          <input type="hidden" id="plateFilmId" />
          <div class="settings-section-title">íŒ ë“±ë¡/ìˆ˜ì •</div>
          <div class="settings-help">í•„ë¦„ì—ì„œ ìƒì†ëœ ì •ë³´ëŠ” ìë™ ì…ë ¥ë¨ (ì œí’ˆëª…/í•„ë¦„ë²ˆí˜¸/ë©”ì‰¬)</div>

          <div class="form-row">
            <label>ì œí’ˆ ì´ë¦„</label>
            <input type="text" id="plateProductName" readonly />
          </div>
          <div class="form-row">
            <label>í•„ë¦„ ë²ˆí˜¸</label>
            <input type="text" id="plateFilmNumber" readonly />
          </div>

          <div class="form-row">
            <label>íŒ ë²ˆí˜¸ *</label>
            <input type="text" id="plateNumber" required />
            <small style="font-size:11px; color:var(--text-sub); margin-top:6px;">
              ê¸°ë³¸: í•„ë¦„ë²ˆí˜¸-1, í•„ë¦„ë²ˆí˜¸-2 ... (ìë™ ë„˜ë²„ë§, ìˆ˜ì • ê°€ëŠ¥)
            </small>
          </div>

          <div class="form-row">
            <label>í…ì…˜</label>
            <input type="text" id="plateTension" placeholder="ì˜ˆ: 23~25" />
          </div>

          <div class="form-row">
            <label>íŒ ìœ„ì¹˜</label>
            <input type="text" id="plateLocation" placeholder="ì˜ˆ: 3ì¸µ íŒë™ 2ë²ˆ" />
          </div>

          <div class="form-row">
            <label>MESH (ìˆ˜ì • ê°€ëŠ¥)</label>
            <input type="text" id="plateMesh" placeholder="ì˜ˆ: 180T, 200ë©”ì‰¬" />
          </div>

          <div class="form-row">
            <label>íŒ ìµœëŒ€ ì‚¬ìš© ìˆ˜ëŸ‰</label>
            <input type="number" id="plateMaxQty" min="1" step="1" />
            <small style="font-size:11px; color:var(--text-sub); margin-top:6px;">
              ê¸°ë³¸ê°’ 5000
            </small>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="plateCancelBtn">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn-primary" id="plateSaveBtn">ì €ì¥</button>
          </div>
        </form>
      </div>

      <!-- ë¦¬ìŠ¤íŠ¸ -->
      <div id="list" class="list"></div>
      <div id="emptyText" class="empty-text" style="display:none;">-</div>

      <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
      <div id="loadingSpinner" class="spinner-wrapper">
        <div class="spinner-circle"></div>
      </div>
    </div>
  </div>

  <button id="scrollTopBtn" class="scroll-top-btn">â†‘</button>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <script>
    /* ---------- Firebase ì„¤ì • ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyBrBnVuXca2Ou1oMFOLzq3KGEN8xiK5L_U",
      authDomain: "film-find-5242d.firebaseapp.com",
      projectId: "film-find-5242d",
      storageBucket: "film-find-5242d.firebasestorage.app",
      messagingSenderId: "185123433624",
      appId: "1:185123433624:web:269eb9b4b6437887f2f4ed",
      measurementId: "G-V9KL8XS9KJ"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const FILM_COLLECTION = "films";
    const HISTORY_COLLECTION = "history";

    const PLATE_COLLECTION = "plates";
    const PLATE_USAGE_SUB = "usage";
    const CONFIG_COLLECTION = "appConfig";
    const AUTH_DOC = "auth";

    const MODE_ADMIN = "admin";
    const MODE_PRINTER = "printer";
    const MODE_VIEWER = "viewer";

    const DEFAULT_ADMIN_PW = "0605";
    const DEFAULT_PRINTER_PW = "1234";
    const DEFAULT_VIEWER_PW = "0000";

    const UNLOCK_KEY = "filmAppUnlocked";
    const UNLOCK_MODE_KEY = "filmAppMode";

    const DEVICE_KEY = "filmDeviceLabel";
    const SORT_KEY = "filmSortOption";
    const THEME_KEY = "filmTheme";
    const VIEW_KEY = "filmViewMode";

    let films = [];
    let plates = [];
    let currentSearchText = "";
    let unsubscribeFilms = null;
    let unsubscribePlates = null;

    let historyEntries = [];
    let historyLoaded = false;

    const VISIBLE_STEP = 30;
    let visibleCount = VISIBLE_STEP;
    let currentViewMode = localStorage.getItem(VIEW_KEY) || "list";

    let currentSelectedImageDataUrl = null;
    let currentImageRotation = 0;

    let currentMemoFilmId = null;
    let currentHistoryNoteId = null;

    let currentTab = "films";
    let currentMode = null;

    let authConfig = {
      adminPw: DEFAULT_ADMIN_PW,
      printerPw: DEFAULT_PRINTER_PW,
      viewerPw: DEFAULT_VIEWER_PW
    };

    let currentPlateMemoId = null;
    let currentPlateUseId = null;
    let currentPlateHistoryId = null;

    /* ---------- ìœ í‹¸ ---------- */
    function $(id){ return document.getElementById(id); }

    function showToast(msg) {
      const toast = $("toast");
      if (!toast) return;
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 1800);
    }

    function formatDate(iso) { return iso ? iso : "-"; }

    function formatTs(ts) {
      const d = new Date(ts || 0);
      if (isNaN(d.getTime())) return "-";
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return `${y}-${m}-${day} ${hh}:${mm}`;
    }

    function todayISO(){
      return new Date().toISOString().slice(0,10);
    }

    /* ---------- ë¡œì»¬ ì„¤ì • ---------- */
    function getSortOption() { return localStorage.getItem(SORT_KEY) || "updated"; }
    function setSortOption(opt) { localStorage.setItem(SORT_KEY, opt); }

    function getDeviceLabel() { return localStorage.getItem(DEVICE_KEY) || ""; }
    function setDeviceLabel(label) {
      localStorage.setItem(DEVICE_KEY, label);
      const badgeText = $("deviceBadgeText");
      if (badgeText) badgeText.textContent = label || "ê¸°ê¸° ë¯¸ì§€ì •";
    }

    function getTheme() { return localStorage.getItem(THEME_KEY) || "default"; }
    function setTheme(theme) {
      localStorage.setItem(THEME_KEY, theme);
      const root = document.documentElement;
      if (theme === "default") root.removeAttribute("data-theme");
      else root.setAttribute("data-theme", theme);
    }

    function setViewMode(mode) {
      currentViewMode = mode;
      localStorage.setItem(VIEW_KEY, mode);
      applyViewMode();
    }

    /* ---------- íŒ¨ë„ ë‹«ê¸° ---------- */
    function closeAllPanels() {
      $("settingsCard").style.display = "none";
      $("historyCard").style.display = "none";
      $("formCard").style.display = "none";
      $("plateFormCard").style.display = "none";
    }

    /* ---------- ì´ë¯¸ì§€ ë·°ì–´ ---------- */
    function openImageViewer(src){
      const viewer = $("imageViewer");
      const img = $("viewerImage");
      if (!viewer || !img) return;
      img.src = src;
      img.style.transform = "scale(1)";
      viewer.style.display = "flex";
    }
    function closeImageViewer(){
      const viewer = $("imageViewer");
      const img = $("viewerImage");
      if (viewer) viewer.style.display = "none";
      if (img) img.src = "";
    }

    /* ---------- ëª¨ë“œ UI ---------- */
    function updateSearchPlaceholder() {
      const searchInput = $("searchInput");
      if (!searchInput) return;
      if (currentTab === "films") {
        searchInput.placeholder = "ì œí’ˆëª… / í•„ë¦„ë²ˆí˜¸ / ì œíŒíƒ€ì… / ìœ„ì¹˜ / ì œíŒë°©ë²• / MESH / ìš”ì²­ ì¸ì‡„ì ê²€ìƒ‰";
      } else {
        searchInput.placeholder = "ì œí’ˆëª… / í•„ë¦„ë²ˆí˜¸ / íŒë²ˆí˜¸ / í…ì…˜ / íŒìœ„ì¹˜ / MESH ê²€ìƒ‰";
      }
    }

    function setActiveTabUI() {
      const tabFilmsBtn = $("tabFilmsBtn");
      const tabPlatesBtn = $("tabPlatesBtn");
      if (tabFilmsBtn) tabFilmsBtn.classList.toggle("active", currentTab === "films");
      if (tabPlatesBtn) tabPlatesBtn.classList.toggle("active", currentTab === "plates");
      updateSearchPlaceholder();
      closeAllPanels();
      $("searchInput").value = "";
      currentSearchText = "";
      visibleCount = VISIBLE_STEP;
      renderCurrentTab();
    }

    function switchToTab(tab) {
      if (currentMode === MODE_PRINTER && tab !== "plates") return;
      currentTab = tab;
      setActiveTabUI();
    }

    function applyModeUI() {
      const modeText = $("modeChipText");
      const subtitle = $("subtitleText");
      const settingsBtn = $("settingsBtn");
      const historyBtn = $("historyBtn");
      const exportBtn = $("exportBtn");
      const importBtn = $("importBtn");
      const newFilmBtn = $("newFilmBtn");
      const viewToggleBtn = $("viewToggleBtn");
      const pwSection = $("pwSection");

      const tabFilmsBtn = $("tabFilmsBtn");
      const tabPlatesBtn = $("tabPlatesBtn");

      if (currentMode === MODE_ADMIN) {
        if (modeText) modeText.textContent = "ê´€ë¦¬ì";
        if (subtitle) subtitle.textContent = "í•„ë¦„/íŒ ê´€ë¦¬";
        if (settingsBtn) settingsBtn.style.display = "inline-block";
        if (historyBtn) historyBtn.style.display = "inline-block";
        if (exportBtn) exportBtn.style.display = "inline-block";
        if (importBtn) importBtn.style.display = "inline-block";
        if (newFilmBtn) newFilmBtn.style.display = "inline-block";
        if (viewToggleBtn) viewToggleBtn.style.display = "inline-block";
        if (pwSection) pwSection.style.display = "block";
        if (tabFilmsBtn) tabFilmsBtn.style.display = "inline-flex";
        if (tabPlatesBtn) tabPlatesBtn.style.display = "inline-flex";
      }

      if (currentMode === MODE_PRINTER) {
        if (modeText) modeText.textContent = "ì¸ì‡„ê¸°ì‚¬";
        if (subtitle) subtitle.textContent = "íŒ ì „ìš©";
        if (settingsBtn) settingsBtn.style.display = "none";
        if (historyBtn) historyBtn.style.display = "none";
        if (exportBtn) exportBtn.style.display = "none";
        if (importBtn) importBtn.style.display = "none";
        if (newFilmBtn) newFilmBtn.style.display = "none";
        if (viewToggleBtn) viewToggleBtn.style.display = "none";
        if (pwSection) pwSection.style.display = "none";
        if (tabFilmsBtn) tabFilmsBtn.style.display = "none";
        if (tabPlatesBtn) tabPlatesBtn.style.display = "inline-flex";
        currentTab = "plates";
        setActiveTabUI();
      }

      if (currentMode === MODE_VIEWER) {
        if (modeText) modeText.textContent = "ì¡°íšŒ";
        if (subtitle) subtitle.textContent = "ì¡°íšŒ ì „ìš©";
        if (settingsBtn) settingsBtn.style.display = "none";
        if (historyBtn) historyBtn.style.display = "none";
        if (exportBtn) exportBtn.style.display = "none";
        if (importBtn) importBtn.style.display = "none";
        if (newFilmBtn) newFilmBtn.style.display = "none";
        if (viewToggleBtn) viewToggleBtn.style.display = "inline-block";
        if (pwSection) pwSection.style.display = "none";
        if (tabFilmsBtn) tabFilmsBtn.style.display = "inline-flex";
        if (tabPlatesBtn) tabPlatesBtn.style.display = "inline-flex";
      }

      updateSearchPlaceholder();
    }

    function applyViewMode() {
      const list = $("list");
      const btn = $("viewToggleBtn");
      if (!list || !btn) return;
      if (currentViewMode === "gallery") {
        list.classList.add("gallery");
        btn.textContent = "ë¦¬ìŠ¤íŠ¸";
      } else {
        list.classList.remove("gallery");
        btn.textContent = "ê°¤ëŸ¬ë¦¬";
      }
    }

    function updateCountBar(filteredLength, totalLength, hasFilter) {
      const bar = $("countBar");
      if (!bar) return;
      if (currentTab === "films") {
        bar.innerHTML = hasFilter
          ? `ê²€ìƒ‰ ê²°ê³¼ <strong>${filteredLength}</strong>ê°œ / ì „ì²´ ${totalLength}ê°œ`
          : `ì´ <strong>${totalLength}</strong>ê°œ í•„ë¦„`;
      } else {
        bar.innerHTML = hasFilter
          ? `ê²€ìƒ‰ ê²°ê³¼ <strong>${filteredLength}</strong>ê°œ / ì „ì²´ ${totalLength}ê°œ`
          : `ì´ <strong>${totalLength}</strong>ê°œ íŒ`;
      }
    }

    function renderCurrentTab() {
      if (currentTab === "films") renderFilmsList(currentSearchText);
      else renderPlatesList(currentSearchText);
    }

    /* ---------- Firestore: ì¸ì¦ ì„¤ì • ---------- */
    async function loadAuthConfig() {
      try {
        const ref = db.collection(CONFIG_COLLECTION).doc(AUTH_DOC);
        const snap = await ref.get();
        if (snap.exists) {
          const data = snap.data() || {};
          authConfig.adminPw = data.adminPw || DEFAULT_ADMIN_PW;
          authConfig.printerPw = data.printerPw || DEFAULT_PRINTER_PW;
          authConfig.viewerPw = data.viewerPw || DEFAULT_VIEWER_PW;
        } else {
          await ref.set({
            adminPw: DEFAULT_ADMIN_PW,
            printerPw: DEFAULT_PRINTER_PW,
            viewerPw: DEFAULT_VIEWER_PW,
            updatedAt: Date.now()
          }, { merge: true });
          authConfig.adminPw = DEFAULT_ADMIN_PW;
          authConfig.printerPw = DEFAULT_PRINTER_PW;
          authConfig.viewerPw = DEFAULT_VIEWER_PW;
        }
      } catch (e) {
        console.error("authConfig ë¡œë“œ ì˜¤ë¥˜:", e);
        authConfig.adminPw = DEFAULT_ADMIN_PW;
        authConfig.printerPw = DEFAULT_PRINTER_PW;
        authConfig.viewerPw = DEFAULT_VIEWER_PW;
      }
    }

    async function saveAuthConfig(newAdminPw, newPrinterPw, newViewerPw) {
      const ref = db.collection(CONFIG_COLLECTION).doc(AUTH_DOC);
      await ref.set({
        adminPw: newAdminPw,
        printerPw: newPrinterPw,
        viewerPw: newViewerPw,
        updatedAt: Date.now()
      }, { merge: true });
      authConfig.adminPw = newAdminPw;
      authConfig.printerPw = newPrinterPw;
      authConfig.viewerPw = newViewerPw;
    }

    function detectModeByPassword(pw) {
      if (pw === authConfig.adminPw) return MODE_ADMIN;
      if (pw === authConfig.printerPw) return MODE_PRINTER;
      if (pw === authConfig.viewerPw) return MODE_VIEWER;
      return null;
    }

    /* ---------- ì‹¤ì‹œê°„ ë™ê¸°í™” ---------- */
    function startFilmsListener() {
      if (unsubscribeFilms) unsubscribeFilms();
      unsubscribeFilms = db.collection(FILM_COLLECTION).onSnapshot(
        (snapshot) => {
          films = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
          if (currentTab === "films") renderFilmsList(currentSearchText);
        },
        (error) => {
          console.error("í•„ë¦„ ë™ê¸°í™” ì˜¤ë¥˜:", error);
          showToast("ì„œë²„ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´.");
        }
      );
    }

    function startPlatesListener() {
      if (unsubscribePlates) unsubscribePlates();
      unsubscribePlates = db.collection(PLATE_COLLECTION).onSnapshot(
        (snapshot) => {
          plates = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
          if (currentTab === "plates") renderPlatesList(currentSearchText);
        },
        (error) => {
          console.error("íŒ ë™ê¸°í™” ì˜¤ë¥˜:", error);
          showToast("íŒ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´.");
        }
      );
    }

    /* ---------- íˆìŠ¤í† ë¦¬ (í•„ë¦„) ---------- */
    async function addHistory(action, film, changes = []) {
      try {
        const entry = {
          action,
          filmId: film.id || null,
          filmNumber: film.filmNumber || "",
          productName: film.productName || "",
          deviceName: getDeviceLabel() || "",
          timestamp: Date.now(),
          changes,
        };
        await db.collection(HISTORY_COLLECTION).add(entry);
        if (historyLoaded) await loadHistory();
      } catch (e) {
        console.error("íˆìŠ¤í† ë¦¬ ê¸°ë¡ ì˜¤ë¥˜:", e);
      }
    }

    async function loadHistory() {
      try {
        const snap = await db.collection(HISTORY_COLLECTION).orderBy("timestamp", "desc").limit(100).get();
        historyEntries = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
        historyLoaded = true;
        renderHistory();
      } catch (e) {
        console.error("íˆìŠ¤í† ë¦¬ ë¡œë“œ ì˜¤ë¥˜:", e);
        showToast("íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´.");
      }
    }

    function actionLabel(action) {
      if (action === "ë“±ë¡") return "í•„ë¦„ ë“±ë¡";
      if (action === "ìˆ˜ì •") return "í•„ë¦„ ìˆ˜ì •";
      if (action === "ì‚­ì œ") return "í•„ë¦„ ì‚­ì œ";
      if (action === "ì˜¤ëŠ˜ ì‚¬ìš©") return "ì˜¤ëŠ˜ ì‚¬ìš© ì²´í¬";
      return action || "ë³€ê²½";
    }

    function renderHistory() {
      const list = $("historyList");
      if (!list) return;
      list.innerHTML = "";

      if (!historyEntries.length) {
        const empty = document.createElement("div");
        empty.className = "history-empty";
        empty.innerHTML = "ì•„ì§ ê¸°ë¡ì´ ì—†ì–´.";
        list.appendChild(empty);
        return;
      }

      historyEntries.forEach((entry) => {
        const row = document.createElement("div");
        row.className = "history-row";

        const ts = formatTs(entry.timestamp || 0);
        const device = entry.deviceName || "ê¸°ê¸° ë¯¸ì§€ì •";
        const filmLabel = (entry.filmNumber || "") + (entry.productName ? ` (${entry.productName})` : "");

        const changesArr = Array.isArray(entry.changes) ? entry.changes : [];
        const noteText = (entry.note || "").trim();

        row.innerHTML =
          `<div class="history-headline">` +
            `<div>` +
              `<span class="history-time">${ts}</span>` +
              `<span class="history-device">${device}</span>` +
              `<span class="history-action-chip">${actionLabel(entry.action)}</span>` +
            `</div>` +
            `<button class="history-pencil" data-id="${entry.id}">âœï¸</button>` +
          `</div>` +
          `<div class="history-film">${filmLabel || "í•„ë¦„ ì •ë³´ ì—†ìŒ"}</div>` +
          (changesArr.length ? `<div class="history-changes">ë³€ê²½ í•­ëª©: ${changesArr.join(", ")}</div>` : "") +
          (noteText ? `<div class="history-note">${noteText}</div>` : "");

        const pencilBtn = row.querySelector(".history-pencil");
        if (pencilBtn) pencilBtn.addEventListener("click", () => openHistoryNoteModal(entry.id));

        list.appendChild(row);
      });
    }

    function openHistoryCard() {
      const card = $("historyCard");
      const isOpen = card.style.display === "block";
      closeAllPanels();
      if (!isOpen) {
        card.style.display = "block";
        if (!historyLoaded) loadHistory();
        else renderHistory();
      }
    }

    /* ---------- ë©”ëª¨(í•„ë¦„/íŒ) ---------- */
    function openMemoSheet(filmId) {
      const film = films.find((f) => f.id === filmId);
      if (!film) return;
      currentMemoFilmId = filmId;

      $("memoSheetTitle").textContent = `ë©”ëª¨ Â· ${film.filmNumber || ""}`;
      $("memoSheetSub").textContent = (film.productName || "") ? film.productName : "í•„ë¦„ë³„ ë©”ëª¨";
      $("memoTextarea").value = film.memo || "";

      const isAdmin = currentMode === MODE_ADMIN;
      $("memoTextarea").disabled = !isAdmin;
      $("memoSheetSaveBtn").style.display = isAdmin ? "inline-block" : "none";

      $("memoSheet").classList.add("show");
    }
    function closeMemoSheet() { $("memoSheet").classList.remove("show"); currentMemoFilmId = null; }
    async function saveMemoSheet() {
      if (!currentMemoFilmId) return;
      if (currentMode !== MODE_ADMIN) return;
      const memo = ($("memoTextarea").value || "").trim();
      try {
        await db.collection(FILM_COLLECTION).doc(currentMemoFilmId).set({ memo, updatedAt: Date.now() }, { merge: true });
        showToast("ë©”ëª¨ë¥¼ ì €ì¥í–ˆì–´.");
        closeMemoSheet();
      } catch (e) {
        console.error(e);
        showToast("ë©”ëª¨ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë‚¬ì–´.");
      }
    }

    function openPlateMemoSheet(plateId) {
      const plate = plates.find((p) => p.id === plateId);
      if (!plate) return;
      currentPlateMemoId = plateId;

      $("plateMemoTitle").textContent = `íŒ ë©”ëª¨ Â· ${plate.plateNumber || ""}`;
      $("plateMemoSub").textContent = (plate.productName || "") ? plate.productName : "íŒë³„ ë©”ëª¨";
      $("plateMemoTextarea").value = plate.memo || "";

      const isAdmin = currentMode === MODE_ADMIN;
      $("plateMemoTextarea").disabled = !isAdmin;
      $("plateMemoSaveBtn").style.display = isAdmin ? "inline-block" : "none";

      $("plateMemoSheet").classList.add("show");
    }
    function closePlateMemoSheet() { $("plateMemoSheet").classList.remove("show"); currentPlateMemoId = null; }
    async function savePlateMemoSheet() {
      if (!currentPlateMemoId) return;
      if (currentMode !== MODE_ADMIN) return;
      const memo = ($("plateMemoTextarea").value || "").trim();
      try {
        await db.collection(PLATE_COLLECTION).doc(currentPlateMemoId).set({ memo, updatedAt: Date.now() }, { merge: true });
        showToast("íŒ ë©”ëª¨ ì €ì¥ë¨.");
        closePlateMemoSheet();
      } catch (e) {
        console.error(e);
        showToast("íŒ ë©”ëª¨ ì €ì¥ ì¤‘ ì˜¤ë¥˜.");
      }
    }

    /* ---------- íˆìŠ¤í† ë¦¬ ë©”ëª¨ ëª¨ë‹¬ ---------- */
    function openHistoryNoteModal(historyId) {
      const entry = historyEntries.find((h) => h.id === historyId);
      if (!entry) return;
      currentHistoryNoteId = historyId;
      $("historyNoteTextarea").value = entry.note || "";
      $("historyNoteModal").classList.add("show");
    }
    function closeHistoryNoteModal() { $("historyNoteModal").classList.remove("show"); currentHistoryNoteId = null; }
    async function saveHistoryNoteModal() {
      if (!currentHistoryNoteId) return;
      const note = ($("historyNoteTextarea").value || "").trim();
      try {
        await db.collection(HISTORY_COLLECTION).doc(currentHistoryNoteId).set({ note }, { merge: true });
        const idx = historyEntries.findIndex((h) => h.id === currentHistoryNoteId);
        if (idx >= 0) historyEntries[idx].note = note;
        renderHistory();
        showToast("íˆìŠ¤í† ë¦¬ ë©”ëª¨ ì €ì¥ë¨.");
        closeHistoryNoteModal();
      } catch (e) {
        console.error(e);
        showToast("íˆìŠ¤í† ë¦¬ ë©”ëª¨ ì €ì¥ ì¤‘ ì˜¤ë¥˜.");
      }
    }

    /* ---------- ì œíŒë°©ë²• í† ê¸€ ---------- */
    function clearPlateInfoForm() {
      document.querySelectorAll(".toggle-btn").forEach((btn) => btn.classList.remove("active"));
    }
    function setPlateInfoToForm(str) {
      clearPlateInfoForm();
      if (!str) return;
      const parts = str.split(" ");
      document.querySelectorAll(".toggle-btn").forEach((btn) => {
        if (parts.includes(btn.dataset.value)) btn.classList.add("active");
      });
    }
    function getPlateInfoFromForm() {
      const groups = document.querySelectorAll(".toggle-group");
      const values = [];
      groups.forEach((group) => {
        const active = group.querySelector(".toggle-btn.active");
        if (active) values.push(active.dataset.value);
      });
      return values.join(" ");
    }

    /* ---------- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° & íšŒì „ ---------- */
    function resetImagePreview() {
      const wrapper = $("imagePreviewWrapper");
      const img = $("imagePreview");
      currentSelectedImageDataUrl = null;
      currentImageRotation = 0;
      if (img) { img.src = ""; img.style.transform = "rotate(0deg)"; }
      if (wrapper) wrapper.style.display = "none";
    }
    function applyPreviewRotation() {
      const img = $("imagePreview");
      if (!img) return;
      img.style.transform = "rotate(" + currentImageRotation + "deg)";
    }

    /* ---------- í•„ë¦„ í¼ ---------- */
    function resetFilmForm() {
      $("filmId").value = "";
      $("productName").value = "";
      $("filmNumber").value = "";
      $("method").value = "";
      $("mesh").value = "";
      $("location").value = "";
      $("requestPrinter").value = "";
      $("lastUsed").value = "";
      $("imageInput").value = "";
      clearPlateInfoForm();
      resetImagePreview();
    }

    function getLastFilmForDefaults() {
      if (!films.length) return null;
      return films.reduce((acc, cur) => {
        const a = acc.updatedAt || acc.createdAt || 0;
        const b = cur.updatedAt || cur.createdAt || 0;
        return b > a ? cur : acc;
      });
    }

    function openFilmFormNew() {
      if (currentMode !== MODE_ADMIN) return;
      resetFilmForm();
      const last = getLastFilmForDefaults();
      if (last) {
        $("method").value = last.method || "";
        $("mesh").value = last.mesh || "";
        $("location").value = last.location || "";
        $("requestPrinter").value = last.requestPrinter || "";
        setPlateInfoToForm(last.plateInfo || "");
      }
      $("formCard").style.display = "block";
      $("productName").focus();
    }

    function openFilmFormForEdit(id) {
      if (currentMode !== MODE_ADMIN) return;
      const film = films.find((f) => f.id === id);
      if (!film) return;
      closeAllPanels();
      resetImagePreview();

      $("filmId").value = film.id;
      $("productName").value = film.productName || "";
      $("filmNumber").value = film.filmNumber || "";
      $("method").value = film.method || "";
      $("mesh").value = film.mesh || "";
      $("location").value = film.location || "";
      $("requestPrinter").value = film.requestPrinter || "";
      $("lastUsed").value = film.lastUsed || "";
      $("imageInput").value = "";
      setPlateInfoToForm(film.plateInfo || "");

      $("formCard").style.display = "block";
      $("productName").focus();
    }

    function openFilmFormCopyFrom(id) {
      if (currentMode !== MODE_ADMIN) return;
      const film = films.find((f) => f.id === id);
      if (!film) return;
      resetFilmForm();
      $("productName").value = film.productName || "";
      $("filmNumber").value = "";
      $("method").value = film.method || "";
      $("mesh").value = film.mesh || "";
      $("location").value = film.location || "";
      $("requestPrinter").value = film.requestPrinter || "";
      $("lastUsed").value = "";
      setPlateInfoToForm(film.plateInfo || "");
      closeAllPanels();
      $("formCard").style.display = "block";
      $("productName").focus();
    }

    function closeFilmForm() {
      $("formCard").style.display = "none";
      resetFilmForm();
    }

    /* ---------- íŒ: í”„ë¦°í„° ëª©ë¡ (Firestore ê³µìœ ) ---------- */
    async function loadPrinterList() {
      try {
        const ref = db.collection(CONFIG_COLLECTION).doc("printers");
        const snap = await ref.get();
        if (!snap.exists) {
          await ref.set({ names: ["ìµœì„±ê·œ"], updatedAt: Date.now() }, { merge: true });
          return ["ìµœì„±ê·œ"];
        }
        const data = snap.data() || {};
        const names = Array.isArray(data.names) ? data.names : [];
        return names.length ? names : ["ìµœì„±ê·œ"];
      } catch (e) {
        console.error("ì¸ì‡„ê¸°ì‚¬ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:", e);
        return ["ìµœì„±ê·œ"];
      }
    }

    async function savePrinterList(names) {
      const clean = (names || [])
        .map((s) => String(s || "").trim())
        .filter(Boolean)
        .filter((v, i, arr) => arr.indexOf(v) === i);
      await db.collection(CONFIG_COLLECTION).doc("printers").set(
        { names: clean, updatedAt: Date.now() },
        { merge: true }
      );
    }

    async function fillPrinterSelect(selectEl) {
      const names = await loadPrinterList();
      selectEl.innerHTML = "";
      names.forEach((n) => {
        const opt = document.createElement("option");
        opt.value = n;
        opt.textContent = n;
        selectEl.appendChild(opt);
      });
    }

    /* ---------- íŒ í¼ ---------- */
    function closePlateForm() {
      $("plateFormCard").style.display = "none";
      $("plateId").value = "";
      $("plateFilmId").value = "";
      $("plateProductName").value = "";
      $("plateFilmNumber").value = "";
      $("plateNumber").value = "";
      $("plateTension").value = "";
      $("plateLocation").value = "";
      $("plateMesh").value = "";
      $("plateMaxQty").value = "";
    }

    function openPlateFormFromFilm(filmId) {
      if (currentMode !== MODE_ADMIN) return;
      const film = films.find((f) => f.id === filmId);
      if (!film) return;

      closeAllPanels();

      $("plateId").value = "";
      $("plateFilmId").value = film.id;
      $("plateProductName").value = film.productName || "";
      $("plateFilmNumber").value = film.filmNumber || "";

      // ìë™ ë„˜ë²„ë§: ê°™ì€ filmNumber ê°€ì§„ íŒ ê°œìˆ˜ + 1
      const same = plates.filter(p => (p.filmNumber || "") === (film.filmNumber || ""));
      const nextIdx = same.length + 1;
      $("plateNumber").value = (film.filmNumber ? `${film.filmNumber}-${nextIdx}` : `-${nextIdx}`);

      $("plateTension").value = "";
      $("plateLocation").value = "";
      $("plateMesh").value = film.mesh || "";
      $("plateMaxQty").value = 5000;

      $("plateFormCard").style.display = "block";
      $("plateNumber").focus();
    }

    function openPlateFormForEdit(plateId) {
      if (currentMode !== MODE_ADMIN) return;
      const p = plates.find(x => x.id === plateId);
      if (!p) return;
      closeAllPanels();

      $("plateId").value = p.id;
      $("plateFilmId").value = p.filmId || "";
      $("plateProductName").value = p.productName || "";
      $("plateFilmNumber").value = p.filmNumber || "";
      $("plateNumber").value = p.plateNumber || "";
      $("plateTension").value = p.tension || "";
      $("plateLocation").value = p.location || "";
      $("plateMesh").value = p.mesh || "";
      $("plateMaxQty").value = Number(p.maxQty || 5000);

      $("plateFormCard").style.display = "block";
      $("plateNumber").focus();
    }

    async function savePlateFormSubmit(e){
      e.preventDefault();
      if (currentMode !== MODE_ADMIN) return;

      const plateId = ($("plateId").value || "").trim();
      const filmId = ($("plateFilmId").value || "").trim();
      const productName = ($("plateProductName").value || "").trim();
      const filmNumber = ($("plateFilmNumber").value || "").trim();

      const plateNumber = ($("plateNumber").value || "").trim();
      if (!plateNumber) { showToast("íŒ ë²ˆí˜¸ëŠ” í•„ìˆ˜ì•¼."); return; }

      const tension = ($("plateTension").value || "").trim();
      const location = ($("plateLocation").value || "").trim();
      const mesh = ($("plateMesh").value || "").trim();
      const maxQty = Number($("plateMaxQty").value || 5000) || 5000;

      const payload = {
        filmId,
        productName,
        filmNumber,
        plateNumber,
        tension,
        location,
        mesh,
        maxQty,
        updatedAt: Date.now(),
      };

      try{
        if (plateId) {
          await db.collection(PLATE_COLLECTION).doc(plateId).set(payload, { merge:true });
          showToast("íŒ ìˆ˜ì •ë¨.");
        } else {
          payload.createdAt = Date.now();
          payload.usedTotal = 0;
          await db.collection(PLATE_COLLECTION).add(payload);
          showToast("íŒ ë“±ë¡ë¨.");
        }
        closePlateForm();
        currentTab = "plates";
        setActiveTabUI();
      }catch(err){
        console.error(err);
        showToast("íŒ ì €ì¥ ì¤‘ ì˜¤ë¥˜.");
      }
    }

    /* ---------- íŒ ì‚¬ìš©ë“±ë¡ ---------- */
    async function openPlateUseSheet(plateId){
      if (!(currentMode === MODE_ADMIN || currentMode === MODE_PRINTER)) return;

      const p = plates.find(x => x.id === plateId);
      if (!p) return;

      currentPlateUseId = plateId;

      $("plateUseMeta").innerHTML = `
        <div class="usage-chip">ğŸ“¦ ${p.productName || "-"}</div>
        <div class="usage-chip">ğŸ ${p.filmNumber || "-"}</div>
        <div class="usage-chip">ğŸ§© ${p.plateNumber || "-"}</div>
        <div class="progress-pill">ëˆ„ì  ${Number(p.usedTotal||0)} / ${Number(p.maxQty||5000)}</div>
      `;

      await fillPrinterSelect($("plateUseWho"));
      $("plateUseQty").value = "";
      $("plateUseMemo").value = "";

      $("plateUseSheet").classList.add("show");
    }
    function closePlateUseSheet(){
      $("plateUseSheet").classList.remove("show");
      currentPlateUseId = null;
    }

    async function savePlateUse(){
      if (!currentPlateUseId) return;
      if (!(currentMode === MODE_ADMIN || currentMode === MODE_PRINTER)) return;

      const p = plates.find(x => x.id === currentPlateUseId);
      if (!p) return;

      const who = ($("plateUseWho").value || "").trim();
      const qty = Number($("plateUseQty").value || 0);
      const memo = ($("plateUseMemo").value || "").trim();

      if (!who) { showToast("ì¸ì‡„ê¸°ì‚¬ ì„ íƒí•´ì¤˜."); return; }
      if (!qty || qty <= 0) { showToast("ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì¤˜."); return; }

      try{
        const now = Date.now();
        const usagePayload = {
          who,
          qty,
          memo,
          timestamp: now,
          deviceName: getDeviceLabel() || "",
          mode: currentMode
        };

        // usage ê¸°ë¡
        await db.collection(PLATE_COLLECTION).doc(p.id).collection(PLATE_USAGE_SUB).add(usagePayload);

        // ëˆ„ì  ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸ (ì„œë²„ ì €ì¥)
        const newTotal = Number(p.usedTotal || 0) + qty;
        await db.collection(PLATE_COLLECTION).doc(p.id).set({
          usedTotal: newTotal,
          lastUsedTs: now,
          updatedAt: now
        }, { merge:true });

        showToast("ì‚¬ìš©ë“±ë¡ ì™„ë£Œ.");
        closePlateUseSheet();
      }catch(err){
        console.error(err);
        showToast("ì‚¬ìš©ë“±ë¡ ì¤‘ ì˜¤ë¥˜.");
      }
    }

    /* ---------- íŒ íˆìŠ¤í† ë¦¬ ---------- */
    async function openPlateHistorySheet(plateId){
      const p = plates.find(x => x.id === plateId);
      if (!p) return;

      currentPlateHistoryId = plateId;

      $("plateHistoryMeta").innerHTML = `
        <div class="usage-chip">ğŸ“¦ ${p.productName || "-"}</div>
        <div class="usage-chip">ğŸ ${p.filmNumber || "-"}</div>
        <div class="usage-chip">ğŸ§© ${p.plateNumber || "-"}</div>
        <div class="progress-pill">ëˆ„ì  ${Number(p.usedTotal||0)} / ${Number(p.maxQty||5000)}</div>
      `;

      $("plateUsageList").innerHTML = `<div class="history-empty" style="padding-left:0;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>`;
      $("plateHistorySheet").classList.add("show");

      try{
        const snap = await db.collection(PLATE_COLLECTION).doc(p.id)
          .collection(PLATE_USAGE_SUB)
          .orderBy("timestamp","desc")
          .limit(200)
          .get();

        const rows = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        if (!rows.length){
          $("plateUsageList").innerHTML = `<div class="history-empty" style="padding-left:0;">ì•„ì§ ì‚¬ìš© ê¸°ë¡ì´ ì—†ì–´.</div>`;
          return;
        }

        $("plateUsageList").innerHTML = "";
        rows.forEach(r=>{
          const div = document.createElement("div");
          div.className = "usage-row";
          div.innerHTML = `
            <div class="u-top">
              <div class="u-time">${formatTs(r.timestamp || 0)} ${r.deviceName ? `<span style="color:var(--primary-1); margin-left:6px;">${r.deviceName}</span>` : ""}</div>
              <div style="display:flex; gap:10px; align-items:baseline;">
                <div class="u-who">${r.who || "-"}</div>
                <div class="u-qty">${Number(r.qty||0)}ê°œ</div>
              </div>
            </div>
            ${r.memo ? `<div class="u-memo">${r.memo}</div>` : ""}
          `;
          $("plateUsageList").appendChild(div);
        });
      }catch(err){
        console.error(err);
        $("plateUsageList").innerHTML = `<div class="history-empty" style="padding-left:0;">íˆìŠ¤í† ë¦¬ ë¡œë“œ ì˜¤ë¥˜</div>`;
      }
    }
    function closePlateHistorySheet(){
      $("plateHistorySheet").classList.remove("show");
      currentPlateHistoryId = null;
    }

    /* ---------- í•„ë¦„ ë¦¬ìŠ¤íŠ¸ ë Œë” ---------- */
    function renderFilmsList(filterText=""){
      const listEl = $("list");
      const emptyText = $("emptyText");
      listEl.innerHTML = "";
      currentSearchText = filterText || "";

      if (currentMode === MODE_PRINTER) {
        emptyText.style.display = "block";
        emptyText.innerHTML = "í•„ë¦„ íƒ­ì€ ì¸ì‡„ê¸°ì‚¬ ëª¨ë“œì—ì„œ ë³´ì´ì§€ ì•Šì•„.";
        updateCountBar(0,0,false);
        return;
      }

      const text = (filterText||"").trim().toLowerCase();
      let filtered = films.filter(f=>{
        if (!text) return true;
        const combined =
          (f.productName || "") + " " +
          (f.filmNumber || "") + " " +
          (f.method || "") + " " +
          (f.mesh || "") + " " +
          (f.location || "") + " " +
          (f.plateInfo || "") + " " +
          (f.requestPrinter || "");
        return combined.toLowerCase().includes(text);
      });

      const sortOpt = getSortOption();
      filtered = filtered.slice().sort((a,b)=>{
        if (sortOpt === "name") return (a.productName||"").localeCompare(b.productName||"","ko");
        if (sortOpt === "number") return (a.filmNumber||"").localeCompare(b.filmNumber||"","ko");
        if (sortOpt === "lastUsed") return (b.lastUsed||"").localeCompare(a.lastUsed||"", "ko");
        // ê¸°ë³¸: ìµœê·¼ ìˆ˜ì •ìˆœ
        const at = a.updatedAt || a.createdAt || 0;
        const bt = b.updatedAt || b.createdAt || 0;
        return bt - at;
      });

      // í˜ì´ì§•(ë”ë³´ê¸°) ë°©ì‹ ê°„ë‹¨ ì ìš©: visibleCountê¹Œì§€
      const visible = filtered.slice(0, visibleCount);

      updateCountBar(filtered.length, films.length, !!text);

      if (!visible.length) {
        emptyText.style.display = "block";
        emptyText.innerHTML = text ? "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì–´." : "ì•„ì§ ë“±ë¡ëœ í•„ë¦„ì´ ì—†ì–´.";
        return;
      }
      emptyText.style.display = "none";

      // ê°¤ëŸ¬ë¦¬/ë¦¬ìŠ¤íŠ¸ ëª¨ë“œ ì ìš©
      applyViewMode();

      visible.forEach((f) => {
        const card = document.createElement("div");
        card.className = "card";

        const imgHtml = f.imageDataUrl
          ? `<img src="${f.imageDataUrl}" alt="film" data-img="${f.imageDataUrl}" />`
          : `<img src="data:image/svg+xml;charset=utf-8,${encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120'><rect width='100%' height='100%' fill='#eef1ff'/><text x='50%' y='52%' text-anchor='middle' font-size='14' fill='#7f9dff' font-family='Arial'>NO IMAGE</text></svg>`)}" alt="no" />`;

        const plateInfoText = (f.plateInfo || "").trim();

        card.innerHTML = `
          ${imgHtml}
          <div class="card-content">
            <div class="card-row-main">
              <div class="card-title">
                ${f.productName || "-"}
                <span class="card-tag">ğŸ ${f.filmNumber || "-"}</span>
              </div>
            </div>

            <div class="card-row"><span class="label">ì œíŒíƒ€ì…</span>${f.method || "-"}</div>
            <div class="card-row"><span class="label">MESH</span>${f.mesh || "-"}</div>
            <div class="card-row"><span class="label">ì œíŒë°©ë²•</span>${plateInfoText || "-"}</div>
            <div class="card-row"><span class="label">ìœ„ì¹˜</span>${f.location || "-"}</div>
            <div class="card-row"><span class="label">ìš”ì²­</span>${f.requestPrinter || "-"}</div>

            <div class="card-footer">
              <div class="last-used">ë§ˆì§€ë§‰ ì‚¬ìš©ì¼: ${formatDate(f.lastUsed)}</div>
              <div class="card-buttons" data-id="${f.id}">
                <button class="btn btn-ghost btn-small" data-action="memo">ğŸ“ ë©”ëª¨</button>
                <button class="btn btn-secondary btn-small" data-action="today">ì˜¤ëŠ˜</button>
                <button class="btn btn-secondary btn-small" data-action="plateAdd">+ íŒ</button>
                <button class="btn btn-secondary btn-small" data-action="copy">ë³µì‚¬</button>
                <button class="btn btn-secondary btn-small" data-action="edit">ìˆ˜ì •</button>
                <button class="btn btn-danger btn-small" data-action="del">ì‚­ì œ</button>
              </div>
            </div>
          </div>
        `;

        // ì´ë¯¸ì§€ í´ë¦­ -> ë·°ì–´
        const img = card.querySelector("img");
        if (img) {
          img.addEventListener("click", () => {
            const src = img.getAttribute("data-img") || img.src;
            openImageViewer(src);
          });
        }

        // ë²„íŠ¼ ì´ë²¤íŠ¸
        const btnWrap = card.querySelector(".card-buttons");
        if (btnWrap) {
          btnWrap.addEventListener("click", (e) => {
            const t = e.target;
            if (!(t instanceof HTMLElement)) return;
            const act = t.getAttribute("data-action");
            if (!act) return;

            const id = btnWrap.getAttribute("data-id");
            if (!id) return;

            if (currentMode !== MODE_ADMIN) {
              // ì¡°íšŒ ëª¨ë“œëŠ” ë©”ëª¨ë§Œ ë³´ê¸° í—ˆìš©
              if (currentMode === MODE_VIEWER && act === "memo") openMemoSheet(id);
              return;
            }

            if (act === "edit") openFilmFormForEdit(id);
            if (act === "copy") openFilmFormCopyFrom(id);
            if (act === "del") deleteFilm(id);
            if (act === "today") setFilmToday(id);
            if (act === "memo") openMemoSheet(id);
            if (act === "plateAdd") openPlateFormFromFilm(id);
          });
        }

        listEl.appendChild(card);
      });

      // ë”ë³´ê¸° (ê°„ë‹¨íˆ ìŠ¤í¬ë¡¤ ë°”ë‹¥ì—ì„œ ìë™ í™•ì¥)
      // (ì›í•˜ë©´ ë²„íŠ¼ìœ¼ë¡œ ë°”ê¿€ ìˆ˜ë„ ìˆìŒ)
           }Compare(b.lastUsed||"","ko");
        // updated(ìµœê·¼ ìˆ˜ì •ìˆœ) ê¸°ë³¸
        const ta = (a.updatedAt || a.createdAt || 0);
        const tb = (b.updatedAt || b.createdAt || 0);
        return tb - ta;
      });

      const total = filtered.length;
      const sliced = filtered.slice(0, visibleCount);

      updateCountBar(sliced.length, total, !!text);

      if (!sliced.length) {
        emptyText.style.display = "block";
        emptyText.textContent = text ? "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì–´." : "ì•„ì§ ë“±ë¡ëœ í•„ë¦„ì´ ì—†ì–´.";
        return;
      } else {
        emptyText.style.display = "none";
      }

      sliced.forEach(f => listEl.appendChild(createFilmCard(f)));

      // ë”ë³´ê¸°(ìŠ¤í¬ë¡¤) ëŒ€ë¹„
      if (visibleCount < total) {
        // ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤í•˜ë©´ ë” ë¡œë“œ (ê°„ë‹¨)
        // (ì›í•˜ë©´ ë²„íŠ¼í˜• ë”ë³´ê¸°ë¡œ ë°”ê¿”ì¤„ ìˆ˜ë„ ìˆìŒ)
      }
    }

    function createFilmCard(f) {
      const card = document.createElement("div");
      card.className = "card";

      const imgSrc = f.imageDataUrl || "";
      const plateInfoText = f.plateInfo ? `${f.plateInfo}` : "-";

      const isAdmin = currentMode === MODE_ADMIN;
      const isViewer = currentMode === MODE_VIEWER;

      card.innerHTML = `
        ${imgSrc ? `<img src="${imgSrc}" alt="film" />` : `<img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzAiIGhlaWdodD0iNzAiIHZpZXdCb3g9IjAgMCA3MCA3MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNzAiIGhlaWdodD0iNzAiIHJ4PSIxMiIgZmlsbD0iI2VlZjFmZiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjM1ZW0iIGZvbnQtc2l6ZT0iMTAiIGZpbGw9IiM4MDg1YjQiPk5PIElNQUdFPC90ZXh0Pjwvc3ZnPg=="/>`}
        <div class="card-content">
          <div class="card-row-main">
            <div class="card-title">
              ${escapeHtml(f.productName || "-")}
              <span class="card-tag">${escapeHtml(f.filmNumber || "-")}</span>
            </div>
          </div>

          <div class="card-row"><span class="label">ì œíŒíƒ€ì…</span>${escapeHtml(f.method || "-")}</div>
          <div class="card-row"><span class="label">MESH</span>${escapeHtml(f.mesh || "-")}</div>
          <div class="card-row"><span class="label">ì œíŒë°©ë²•</span>${escapeHtml(plateInfoText)}</div>
          <div class="card-row"><span class="label">ìœ„ì¹˜</span>${escapeHtml(f.location || "-")}</div>
          <div class="card-row"><span class="label">ìš”ì²­</span>${escapeHtml(f.requestPrinter || "-")}</div>

          <div class="card-footer">
            <div class="last-used">ë§ˆì§€ë§‰ ì‚¬ìš©ì¼: ${escapeHtml(formatDate(f.lastUsed))}</div>
            <div class="card-buttons">
              <button class="btn btn-ghost btn-small" data-act="memo">ğŸ“ ë©”ëª¨</button>
              ${isAdmin ? `<button class="btn btn-secondary btn-small" data-act="today">ì˜¤ëŠ˜</button>` : ""}
              ${isAdmin ? `<button class="btn btn-secondary btn-small" data-act="plateNew">+ íŒ</button>` : ""}
              ${isAdmin ? `<button class="btn btn-secondary btn-small" data-act="edit">ìˆ˜ì •</button>` : ""}
              ${isAdmin ? `<button class="btn btn-ghost btn-small" data-act="copy">ë³µì‚¬</button>` : ""}
              ${isAdmin ? `<button class="btn btn-danger btn-small" data-act="del">ì‚­ì œ</button>` : ""}
              ${isViewer ? `<button class="btn btn-secondary btn-small" data-act="toPlates">íŒ ë³´ê¸°</button>` : ""}
            </div>
          </div>
        </div>
      `;

      const img = card.querySelector("img");
      if (img && imgSrc) img.addEventListener("click", () => openImageViewer(imgSrc));

      card.querySelectorAll("button[data-act]").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const act = e.currentTarget.dataset.act;
          if (act === "memo") return openMemoSheet(f.id);
          if (act === "today") return setFilmToday(f);
          if (act === "plateNew") return openPlateFormFromFilm(f.id);
          if (act === "edit") return openFilmFormForEdit(f.id);
          if (act === "copy") return openFilmFormCopyFrom(f.id);
          if (act === "del") return deleteFilm(f.id);
          if (act === "toPlates") {
            currentTab = "plates";
            setActiveTabUI();
            $("searchInput").value = f.filmNumber || "";
            currentSearchText = (f.filmNumber || "");
            renderPlatesList(currentSearchText);
          }
        });
      });

      return card;
    }

    async function setFilmToday(film) {
      if (currentMode !== MODE_ADMIN) return;
      try {
        const iso = todayISO();
        await db.collection(FILM_COLLECTION).doc(film.id).set({ lastUsed: iso, updatedAt: Date.now() }, { merge: true });
        await addHistory("ì˜¤ëŠ˜ ì‚¬ìš©", { ...film, lastUsed: iso }, ["ë§ˆì§€ë§‰ ì‚¬ìš©ì¼"]);
        showToast("ì˜¤ëŠ˜ë¡œ ê¸°ë¡í–ˆì–´.");
      } catch (e) {
        console.error(e);
        showToast("ì˜¤ëŠ˜ ê¸°ë¡ ì¤‘ ì˜¤ë¥˜.");
      }
    }

    async function deleteFilm(id) {
      if (currentMode !== MODE_ADMIN) return;
      const film = films.find(x => x.id === id);
      if (!film) return;
      if (!confirm("ì •ë§ ì‚­ì œí• ê¹Œ?")) return;

      try {
        await db.collection(FILM_COLLECTION).doc(id).delete();
        await addHistory("ì‚­ì œ", film, []);
        showToast("ì‚­ì œí–ˆì–´.");
      } catch (e) {
        console.error(e);
        showToast("ì‚­ì œ ì¤‘ ì˜¤ë¥˜.");
      }
    }

    /* ---------- íŒ ë¦¬ìŠ¤íŠ¸ ë Œë” ---------- */
    function renderPlatesList(filterText="") {
      const listEl = $("list");
      const emptyText = $("emptyText");
      listEl.innerHTML = "";
      currentSearchText = filterText || "";

      const text = (filterText||"").trim().toLowerCase();
      let filtered = plates.filter(p => {
        if (!text) return true;
        const combined =
          (p.productName || "") + " " +
          (p.filmNumber || "") + " " +
          (p.plateNumber || "") + " " +
          (p.tension || "") + " " +
          (p.location || "") + " " +
          (p.mesh || "");
        return combined.toLowerCase().includes(text);
      });

      // íŒì€ ê¸°ë³¸ ìµœê·¼ ìˆ˜ì •ìˆœ
      filtered = filtered.slice().sort((a,b)=>{
        const ta = (a.updatedAt || a.createdAt || 0);
        const tb = (b.updatedAt || b.createdAt || 0);
        return tb - ta;
      });

      const total = filtered.length;
      const sliced = filtered.slice(0, visibleCount);

      updateCountBar(sliced.length, total, !!text);

      if (!sliced.length) {
        emptyText.style.display = "block";
        emptyText.textContent = text ? "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì–´." : "ì•„ì§ ë“±ë¡ëœ íŒì´ ì—†ì–´.";
        return;
      } else {
        emptyText.style.display = "none";
      }

      sliced.forEach(p => listEl.appendChild(createPlateCard(p)));
    }

    function createPlateCard(p) {
      const card = document.createElement("div");
      card.className = "card";

      const isAdmin = currentMode === MODE_ADMIN;
      const isPrinter = currentMode === MODE_PRINTER;
      const isViewer = currentMode === MODE_VIEWER;

      const used = Number(p.usedTotal || 0);
      const max = Number(p.maxQty || 5000);

      card.innerHTML = `
        <div style="width:70px; height:70px; border-radius:12px; background: var(--primary-soft); display:flex; align-items:center; justify-content:center; font-weight:800; color: var(--text-main);">
          ğŸ§©
        </div>
        <div class="card-content">
          <div class="card-row-main">
            <div class="card-title">
              ${escapeHtml(p.productName || "-")}
              <span class="card-tag">${escapeHtml(p.plateNumber || "-")}</span>
            </div>
          </div>

          <div class="card-row"><span class="label">í•„ë¦„</span>${escapeHtml(p.filmNumber || "-")}</div>
          <div class="card-row"><span class="label">í…ì…˜</span>${escapeHtml(p.tension || "-")}</div>
          <div class="card-row"><span class="label">ìœ„ì¹˜</span>${escapeHtml(p.location || "-")}</div>
          <div class="card-row"><span class="label">MESH</span>${escapeHtml(p.mesh || "-")}</div>

          <div class="card-footer">
            <div class="last-used">ëˆ„ì  ì‚¬ìš©: <strong style="color:var(--primary-1)">${used}</strong> / ${max}</div>
            <div class="card-buttons">
              <button class="btn btn-ghost btn-small" data-act="pmemo">ğŸ“ ë©”ëª¨</button>
              <button class="btn btn-primary btn-small" data-act="use">ì‚¬ìš©ë“±ë¡</button>
              <button class="btn btn-secondary btn-small" data-act="phist">íˆìŠ¤í† ë¦¬</button>
              ${isAdmin ? `<button class="btn btn-secondary btn-small" data-act="pedit">ìˆ˜ì •</button>` : ""}
              ${isAdmin ? `<button class="btn btn-danger btn-small" data-act="pdel">ì‚­ì œ</button>` : ""}
            </div>
          </div>
        </div>
      `;

      card.querySelectorAll("button[data-act]").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const act = e.currentTarget.dataset.act;
          if (act === "pmemo") return openPlateMemoSheet(p.id);
          if (act === "use") return openPlateUseSheet(p.id);
          if (act === "phist") return openPlateHistorySheet(p.id);
          if (act === "pedit") return openPlateFormForEdit(p.id);
          if (act === "pdel") return deletePlate(p.id);
        });
      });

      // ì¸ì‡„ê¸°ì‚¬/ì¡°íšŒ ëª¨ë“œì—ì„œ ë©”ëª¨ëŠ” ì½ê¸°ë§Œ ê°€ëŠ¥ (saveë²„íŠ¼/disabledëŠ” openPlateMemoSheetì—ì„œ ì²˜ë¦¬ë¨)
      if (isPrinter || isViewer) {
        // ë²„íŠ¼ì€ ë‚¨ê²¨ë‘  (ë³´ê¸°ìš©)
      }

      return card;
    }

    async function deletePlate(plateId){
      if (currentMode !== MODE_ADMIN) return;
      const p = plates.find(x=>x.id===plateId);
      if (!p) return;
      if (!confirm("ì´ íŒì„ ì‚­ì œí• ê¹Œ?")) return;
      try{
        await db.collection(PLATE_COLLECTION).doc(plateId).delete();
        showToast("íŒ ì‚­ì œë¨.");
      }catch(e){
        console.error(e);
        showToast("íŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜.");
      }
    }

    /* ---------- escape ---------- */
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /* ---------- ì €ì¥(í•„ë¦„) ---------- */
    async function saveFilmFormSubmit(e){
      e.preventDefault();
      if (currentMode !== MODE_ADMIN) return;

      const id = ($("filmId").value || "").trim();
      const productName = ($("productName").value || "").trim();
      const filmNumber = ($("filmNumber").value || "").trim();
      if (!productName || !filmNumber) { showToast("ì œí’ˆ ì´ë¦„/í•„ë¦„ ë²ˆí˜¸ëŠ” í•„ìˆ˜ì•¼."); return; }

      const method = ($("method").value || "").trim();
      const mesh = ($("mesh").value || "").trim();
      const location = ($("location").value || "").trim();
      const requestPrinter = ($("requestPrinter").value || "").trim();
      const lastUsed = ($("lastUsed").value || "").trim();
      const plateInfo = getPlateInfoFromForm();

      const payload = {
        productName, filmNumber, method, mesh, location, requestPrinter, lastUsed, plateInfo,
        updatedAt: Date.now(),
      };

      // ì´ë¯¸ì§€: ìƒˆë¡œ ì„ íƒëœ ê²Œ ìˆìœ¼ë©´ ê·¸ê±¸ ì €ì¥, ì•„ë‹ˆë©´ ê¸°ì¡´ ìœ ì§€
      if (currentSelectedImageDataUrl) {
        payload.imageDataUrl = currentSelectedImageDataUrl;
      }

      try{
        if (id) {
          await db.collection(FILM_COLLECTION).doc(id).set(payload, { merge:true });
          await addHistory("ìˆ˜ì •", { id, ...payload }, detectFilmChanges(id, payload));
          showToast("ìˆ˜ì •í–ˆì–´.");
        } else {
          payload.createdAt = Date.now();
          const ref = await db.collection(FILM_COLLECTION).add(payload);
          await addHistory("ë“±ë¡", { id: ref.id, ...payload }, ["ì‹ ê·œ ë“±ë¡"]);
          showToast("ë“±ë¡í–ˆì–´.");
        }
        closeFilmForm();
      }catch(err){
        console.error(err);
        showToast("ì €ì¥ ì¤‘ ì˜¤ë¥˜.");
      }
    }

    function detectFilmChanges(id, newPayload){
      const old = films.find(f=>f.id===id) || {};
      const changes = [];
      const keys = ["productName","filmNumber","method","mesh","location","requestPrinter","lastUsed","plateInfo"];
      keys.forEach(k=>{
        const a = String(old[k] ?? "");
        const b = String(newPayload[k] ?? "");
        if (a !== b) changes.push(k);
      });
      if (newPayload.imageDataUrl && newPayload.imageDataUrl !== (old.imageDataUrl || "")) changes.push("ì‚¬ì§„");
      return changes;
    }

    /* ---------- ì´ë¯¸ì§€ ì„ íƒ ì²˜ë¦¬ ---------- */
    function handleImageInputChange(file){
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        currentSelectedImageDataUrl = reader.result;
        currentImageRotation = 0;
        const wrapper = $("imagePreviewWrapper");
        const img = $("imagePreview");
        if (img) img.src = currentSelectedImageDataUrl;
        if (img) img.style.transform = "rotate(0deg)";
        if (wrapper) wrapper.style.display = "flex";
      };
      reader.readAsDataURL(file);
    }

    function rotateImage(direction){
      if (!currentSelectedImageDataUrl) return;
      currentImageRotation = (currentImageRotation + (direction === "left" ? -90 : 90) + 360) % 360;
      applyPreviewRotation();

      // ì‹¤ì œ ì €ì¥ë  DataURLë„ íšŒì „ ë°˜ì˜ (ìº”ë²„ìŠ¤)
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        const rad = currentImageRotation * Math.PI / 180;
        const w = img.width, h = img.height;

        if (currentImageRotation % 180 !== 0) {
          canvas.width = h;
          canvas.height = w;
        } else {
          canvas.width = w;
          canvas.height = h;
        }

        ctx.translate(canvas.width/2, canvas.height/2);
        ctx.rotate(rad);
        ctx.drawImage(img, -w/2, -h/2);

        currentSelectedImageDataUrl = canvas.toDataURL("image/jpeg", 0.92);
        const preview = $("imagePreview");
        if (preview) preview.src = currentSelectedImageDataUrl;
      };
      img.src = currentSelectedImageDataUrl;
    }

    /* ---------- í”„ë¦°í„° ëª©ë¡ ì¶”ê°€/ì‚­ì œ ---------- */
    async function addPrinterName(){
      if (currentMode !== MODE_ADMIN) { showToast("ê´€ë¦¬ìë§Œ ê°€ëŠ¥"); return; }
      const name = prompt("ì¶”ê°€í•  ì¸ì‡„ê¸°ì‚¬ ì´ë¦„");
      if (!name) return;
      const names = await loadPrinterList();
      names.push(name.trim());
      await savePrinterList(names);
      await fillPrinterSelect($("plateUseWho"));
      showToast("ì¶”ê°€í–ˆì–´.");
    }

    async function delPrinterName(){
      if (currentMode !== MODE_ADMIN) { showToast("ê´€ë¦¬ìë§Œ ê°€ëŠ¥"); return; }
      const target = ($("plateUseWho").value || "").trim();
      if (!target) return;
      if (!confirm(`"${target}" ì‚­ì œí• ê¹Œ?`)) return;
      const names = await loadPrinterList();
      const next = names.filter(n => n !== target);
      await savePrinterList(next);
      await fillPrinterSelect($("plateUseWho"));
      showToast("ì‚­ì œí–ˆì–´.");
    }

    /* ---------- ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸° ---------- */
    function exportData(){
      if (currentMode !== MODE_ADMIN) return;
      const payload = {
        exportedAt: Date.now(),
        films,
        plates
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `filmfind_export_${todayISO()}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast("ë‚´ë³´ë‚´ê¸° ì™„ë£Œ.");
    }

    async function importDataFile(file){
      if (currentMode !== MODE_ADMIN) return;
      if (!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        const inFilms = Array.isArray(data.films) ? data.films : [];
        const inPlates = Array.isArray(data.plates) ? data.plates : [];

        // ë¬¸ì„œ idê°€ ìˆëŠ” ê²ƒë§Œ upsert
        const batch = db.batch();

        inFilms.forEach(f=>{
          if (!f.id) return;
          const ref = db.collection(FILM_COLLECTION).doc(f.id);
          batch.set(ref, { ...f, updatedAt: Date.now() }, { merge:true });
        });
        inPlates.forEach(p=>{
          if (!p.id) return;
          const ref = db.collection(PLATE_COLLECTION).doc(p.id);
          batch.set(ref, { ...p, updatedAt: Date.now() }, { merge:true });
        });

        await batch.commit();
        showToast("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ.");
      }catch(e){
        console.error(e);
        showToast("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨.");
      }
    }

    /* ---------- ì„¤ì • ì €ì¥ ---------- */
    async function saveSettings(){
      const deviceName = ($("deviceNameInput").value || "").trim();
      setDeviceLabel(deviceName);

      const sortOpt = ($("sortOptionSelect").value || "updated");
      setSortOption(sortOpt);

      const theme = ($("themeSelect").value || "default");
      setTheme(theme);

      // ê´€ë¦¬ìë§Œ ë¹„ë²ˆ ë³€ê²½
      if (currentMode === MODE_ADMIN) {
        const newAdmin = ($("pwAdminNew").value || "").trim() || authConfig.adminPw;
        const newPrinter = ($("pwPrinterNew").value || "").trim() || authConfig.printerPw;
        const newViewer = ($("pwViewerNew").value || "").trim() || authConfig.viewerPw;
        const curAdmin = ($("pwAdminCurrent").value || "").trim();

        // ë¹„ë²ˆ ì…ë ¥ì´ í•˜ë‚˜ë¼ë„ ë°”ë€ŒëŠ” ê²½ìš°ì—ë§Œ í˜„ì¬ ê´€ë¦¬ì ë¹„ë²ˆ í™•ì¸
        const wantsChange = (newAdmin !== authConfig.adminPw) || (newPrinter !== authConfig.printerPw) || (newViewer !== authConfig.viewerPw);
        if (wantsChange) {
          if (!curAdmin || curAdmin !== authConfig.adminPw) {
            showToast("í˜„ì¬ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ë§ì•„ì•¼ ë³€ê²½ë¼.");
            return;
          }
          await saveAuthConfig(newAdmin, newPrinter, newViewer);
          showToast("ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì™„ë£Œ.");
          $("pwAdminNew").value = "";
          $("pwPrinterNew").value = "";
          $("pwViewerNew").value = "";
          $("pwAdminCurrent").value = "";
        }
      }

      showToast("ì„¤ì • ì €ì¥ë¨.");
      closeAllPanels();
      renderCurrentTab();
    }

    /* ---------- ë¡œê·¸ì¸/ì ê¸ˆ ---------- */
    async function unlockWithPassword(pw){
      await loadAuthConfig();
      const mode = detectModeByPassword(pw);
      if (!mode) {
        showToast("ë¹„ë°€ë²ˆí˜¸ê°€ ë§ì§€ ì•Šì•„.");
        return;
      }
      currentMode = mode;
      localStorage.setItem(UNLOCK_KEY, "1");
      localStorage.setItem(UNLOCK_MODE_KEY, mode);

      $("lockScreen").style.display = "none";
      $("appContainer").style.display = "block";

      // í…Œë§ˆ/ê¸°ê¸°ëª… ì ìš©
      setTheme(getTheme());
      setDeviceLabel(getDeviceLabel());

      // ëª¨ë“œ UI ì ìš© + ë¦¬ìŠ¤ë„ˆ ì‹œì‘
      applyModeUI();
      applyViewMode();

      startFilmsListener();
      startPlatesListener();

      // ì¸ì‡„ê¸°ì‚¬ ëª¨ë“œë©´ íŒ íƒ­ìœ¼ë¡œ ê°•ì œ
      if (currentMode === MODE_PRINTER) {
        currentTab = "plates";
        setActiveTabUI();
      } else {
        setActiveTabUI();
      }
    }

    async function tryAutoUnlock(){
      const unlocked = localStorage.getItem(UNLOCK_KEY) === "1";
      if (!unlocked) return;

      await loadAuthConfig();
      const mode = localStorage.getItem(UNLOCK_MODE_KEY);
      if (![MODE_ADMIN, MODE_PRINTER, MODE_VIEWER].includes(mode)) {
        localStorage.removeItem(UNLOCK_KEY);
        localStorage.removeItem(UNLOCK_MODE_KEY);
        return;
      }
      currentMode = mode;

      $("lockScreen").style.display = "none";
      $("appContainer").style.display = "block";

      setTheme(getTheme());
      setDeviceLabel(getDeviceLabel());

      applyModeUI();
      applyViewMode();

      startFilmsListener();
      startPlatesListener();

      if (currentMode === MODE_PRINTER) currentTab = "plates";
      setActiveTabUI();
    }

    /* ---------- ì´ˆê¸°í™” & ì´ë²¤íŠ¸ ì—°ê²° ---------- */
    function bindEvents(){
      // ì ê¸ˆ
      $("passwordBtn").addEventListener("click", () => unlockWithPassword(($("passwordInput").value || "").trim()));
      $("passwordInput").addEventListener("keydown", (e) => {
        if (e.key === "Enter") unlockWithPassword(($("passwordInput").value || "").trim());
      });

      // íƒ­
      $("tabFilmsBtn").addEventListener("click", () => switchToTab("films"));
      $("tabPlatesBtn").addEventListener("click", () => switchToTab("plates"));

      // ê²€ìƒ‰
      $("searchInput").addEventListener("input", (e) => {
        currentSearchText = e.target.value || "";
        visibleCount = VISIBLE_STEP;
        renderCurrentTab();
      });

      // ë·° í† ê¸€
      $("viewToggleBtn").addEventListener("click", () => {
        setViewMode(currentViewMode === "list" ? "gallery" : "list");
      });

      // ìƒˆ í•„ë¦„
      $("newFilmBtn").addEventListener("click", openFilmFormNew);

      // ì„¤ì •
      $("settingsBtn").addEventListener("click", () => {
        const card = $("settingsCard");
        const isOpen = card.style.display === "block";
        closeAllPanels();
        if (!isOpen) {
          card.style.display = "block";
          $("deviceNameInput").value = getDeviceLabel();
          $("sortOptionSelect").value = getSortOption();
          $("themeSelect").value = getTheme();
        }
      });
      $("closeSettingsBtn").addEventListener("click", closeAllPanels);
      $("saveSettingsBtn").addEventListener("click", saveSettings);

      // íˆìŠ¤í† ë¦¬
      $("historyBtn").addEventListener("click", openHistoryCard);
      $("closeHistoryBtn").addEventListener("click", closeAllPanels);

      // ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸°
      $("exportBtn").addEventListener("click", exportData);
      $("importBtn").addEventListener("click", () => $("importFile").click());
      $("importFile").addEventListener("change", (e) => importDataFile(e.target.files?.[0]));

      // í•„ë¦„ í¼
      $("filmForm").addEventListener("submit", saveFilmFormSubmit);
      $("cancelBtn").addEventListener("click", closeFilmForm);
      $("setTodayBtn").addEventListener("click", () => $("lastUsed").value = todayISO());
      $("imageInput").addEventListener("change", (e) => handleImageInputChange(e.target.files?.[0]));
      $("rotateLeftBtn").addEventListener("click", () => rotateImage("left"));
      $("rotateRightBtn").addEventListener("click", () => rotateImage("right"));

      // íŒ í¼
      $("plateForm").addEventListener("submit", savePlateFormSubmit);
      $("plateCancelBtn").addEventListener("click", closePlateForm);

      // ë©”ëª¨ ì‹œíŠ¸(í•„ë¦„)
      $("memoSheetBackdrop").addEventListener("click", closeMemoSheet);
      $("memoSheetCloseBtn").addEventListener("click", closeMemoSheet);
      $("memoSheetCancelBtn").addEventListener("click", closeMemoSheet);
      $("memoSheetSaveBtn").addEventListener("click", saveMemoSheet);

      // ë©”ëª¨ ì‹œíŠ¸(íŒ)
      $("plateMemoBackdrop").addEventListener("click", closePlateMemoSheet);
      $("plateMemoCloseBtn").addEventListener("click", closePlateMemoSheet);
      $("plateMemoCancelBtn").addEventListener("click", closePlateMemoSheet);
      $("plateMemoSaveBtn").addEventListener("click", savePlateMemoSheet);

      // ì´ë¯¸ì§€ ë·°ì–´
      $("viewerBackdrop").addEventListener("click", closeImageViewer);
      $("closeViewerBtn").addEventListener("click", closeImageViewer);

      // íˆìŠ¤í† ë¦¬ ë©”ëª¨ ëª¨ë‹¬
      $("historyNoteCancelBtn").addEventListener("click", closeHistoryNoteModal);
      $("historyNoteSaveBtn").addEventListener("click", saveHistoryNoteModal);
      $("historyNoteModal").addEventListener("click", (e) => {
        if (e.target === $("historyNoteModal")) closeHistoryNoteModal();
      });

      // íŒ ì‚¬ìš© ì‹œíŠ¸
      $("plateUseBackdrop").addEventListener("click", closePlateUseSheet);
      $("plateUseCloseBtn").addEventListener("click", closePlateUseSheet);
      $("plateUseCancelBtn").addEventListener("click", closePlateUseSheet);
      $("plateUseSaveBtn").addEventListener("click", savePlateUse);

      // ì¸ì‡„ê¸°ì‚¬ ëª©ë¡ ì¶”ê°€/ì‚­ì œ (ê´€ë¦¬ìë§Œ)
      $("printerAddBtn").addEventListener("click", addPrinterName);
      $("printerDelBtn").addEventListener("click", delPrinterName);

      // íŒ íˆìŠ¤í† ë¦¬ ì‹œíŠ¸
      $("plateHistoryBackdrop").addEventListener("click", closePlateHistorySheet);
      $("plateHistoryCloseBtn").addEventListener("click", closePlateHistorySheet);
      $("plateHistoryCloseBtn2").addEventListener("click", closePlateHistorySheet);

      // ìŠ¤í¬ë¡¤íƒ‘
      const scrollBtn = $("scrollTopBtn");
      window.addEventListener("scroll", () => {
        if (window.scrollY > 400) scrollBtn.classList.add("show");
        else scrollBtn.classList.remove("show");
      });
      scrollBtn.addEventListener("click", () => window.scrollTo({ top: 0, behavior: "smooth" }));
    }

    async function init(){
      bindEvents();

      // í…Œë§ˆ/ê¸°ê¸°
      setTheme(getTheme());
      setDeviceLabel(getDeviceLabel());

      // ê¸°ê¸° ì´ë¦„ ëª¨ë‹¬(ì„ íƒ) - í˜„ì¬ëŠ” ì•ˆë‚´ë§Œ, ì €ì¥ì€ ì„¤ì •ì—ì„œ
      if (!getDeviceLabel()) {
        // êµ³ì´ ê°•ì œí•˜ì§€ ì•Šê³  í•œ ë²ˆë§Œ ë„ì›€
        const modal = $("deviceModal");
        modal.style.display = "flex";
        $("deviceModalSkip").onclick = () => { modal.style.display = "none"; };
        $("deviceModalSave").onclick = () => {
          const v = ($("deviceModalInput").value || "").trim();
          setDeviceLabel(v);
          modal.style.display = "none";
          showToast("ê¸°ê¸° ì´ë¦„ ì €ì¥ë¨.");
        };
      }

      // ìë™ ë¡œê·¸ì¸
      await tryAutoUnlock();

      // ìë™ ë¡œê·¸ì¸ ì•„ë‹ˆë©´ ì ê¸ˆ í™”ë©´ ìœ ì§€
      if ($("lockScreen").style.display !== "none") {
        $("passwordInput").focus();
      }
    }

    window.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
