<!-- =========================
PART 1/2  (ì‹œì‘ ~  /* ---------- í¼/ë¦¬ìŠ¤íŠ¸ ---------- */  ì§ì „ê¹Œì§€)
â€» PART1 ë§¨ ì•„ë˜ì— PART2ë¥¼ ê·¸ëŒ€ë¡œ ì´ì–´ë¶™ì´ë©´ 1ê°œì˜ ì™„ì„± HTMLì´ ë¨
========================= -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#f9f4ff">
  <meta charset="UTF-8" />
  <title>FILM FIND - í•„ë¦„ ê´€ë¦¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- í°íŠ¸ (Pretendard) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css" />

  <style>
    :root {
      /* ê¸°ë³¸(ë¼ë²¤ë”) í…Œë§ˆ */
      --bg-gradient: linear-gradient(145deg, #f9fafb, #f4f0ff, #fdf2f8);
      --card-bg: rgba(255,255,255,0.98);
      --card-border: #e3e6ff;
      --shadow-soft: 0 8px 20px rgba(167, 173, 208, 0.35);

      --text-main: #272a3f;
      --text-sub: #767a98;
      --text-muted: #777b9e;
      --label-color: #8689a5;

      --primary-1: #7f9dff;
      --primary-2: #b38cff;
      --primary-soft: rgba(228,231,255,0.95);

      --chip-bg: #f3e8ff;
      --chip-text: #5f308c;

      --danger-bg: #ff6b81;
      --danger-text: #ffffff;

      --pill-bg: rgba(228,231,255,0.98);
      --pill-border: rgba(129, 140, 248, 0.4);

      --toast-bg: rgba(15,23,42,0.9);
      --toast-text: #f9fafb;

      --spinner-border: rgba(191, 219, 254, 0.9);
      --spinner-glow: rgba(129, 140, 248, 0.7);
    }

    /* ë¯¼íŠ¸ í…Œë§ˆ */
    [data-theme="mint"] {
      --bg-gradient: linear-gradient(145deg, #f0fdfa, #e0f2fe, #fefce8);
      --primary-1: #34d399;
      --primary-2: #22c55e;
      --primary-soft: rgba(187,247,208,0.85);
      --chip-bg: #dcfce7;
      --chip-text: #047857;
      --pill-bg: rgba(219, 234, 254, 0.96);
      --pill-border: rgba(45, 212, 191, 0.5);
      --spinner-border: rgba(167, 243, 208, 0.9);
      --spinner-glow: rgba(45, 212, 191, 0.7);
    }

    /* í”¼ì¹˜ í…Œë§ˆ */
    [data-theme="peach"] {
      --bg-gradient: linear-gradient(145deg, #fff7ed, #fee2e2, #fef9c3);
      --primary-1: #fb7185;
      --primary-2: #f97316;
      --primary-soft: rgba(254, 226, 226, 0.9);
      --chip-bg: #ffe4e6;
      --chip-text: #be123c;
      --pill-bg: rgba(254, 226, 226, 0.96);
      --pill-border: rgba(248, 113, 113, 0.55);
      --spinner-border: rgba(254, 202, 202, 0.9);
      --spinner-glow: rgba(248, 113, 113, 0.75);
    }

    /* ë‚˜ì´íŠ¸(ì–´ë‘ìš´) í…Œë§ˆ */
    [data-theme="night"] {
      --bg-gradient: radial-gradient(circle at top, #020617, #020617, #111827);
      --card-bg: rgba(15,23,42,0.98);
      --card-border: #1f2937;
      --shadow-soft: 0 10px 24px rgba(15, 23, 42, 0.75);

      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --text-muted: #9ca3af;
      --label-color: #9ca3af;

      --primary-1: #6366f1;
      --primary-2: #a855f7;
      --primary-soft: rgba(79,70,229,0.22);

      --chip-bg: rgba(79,70,229,0.18);
      --chip-text: #a5b4fc;

      --danger-bg: #f97373;
      --danger-text: #111827;

      --pill-bg: rgba(17,24,39,0.95);
      --pill-border: rgba(129, 140, 248, 0.8);

      --toast-bg: rgba(17,24,39,0.95);
      --toast-text: #e5e7eb;

      --spinner-border: rgba(55, 65, 81, 0.9);
      --spinner-glow: rgba(129, 140, 248, 0.85);
    }

    * {
      box-sizing: border-box;
      font-family: "Pretendard Variable", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg-gradient);
      padding: 12px;
      color: var(--text-main);
    }

    .app-shell {
      max-width: 720px;
      margin: 0 auto;
    }

    /* ìƒë‹¨ í—¤ë” */
    .app-header {
      max-width: 720px;
      margin: 0 auto 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .title-wrap {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .app-title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 2px;
      color: var(--text-main);
    }
    .app-subtitle {
      font-size: 11px;
      color: var(--text-sub);
    }
    .device-badge {
      font-size: 11px;
      padding: 4px 12px;
      border-radius: 999px;
      background: var(--pill-bg);
      color: var(--text-sub);
      white-space: nowrap;
      max-width: 180px;
      text-overflow: ellipsis;
      overflow: hidden;
      border: 1px solid var(--pill-border);
      box-shadow: 0 0 8px rgba(129, 140, 248, 0.28);
      display: flex;
      align-items: center;
      gap: 6px;
      justify-content: flex-end;
    }
    .device-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--primary-1);
      box-shadow: 0 0 6px rgba(129, 140, 248, 0.9);
    }
    .mode-pill{
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--pill-border);
      background: var(--pill-bg);
      color: var(--text-sub);
      max-width: 90px;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
    }

    .top-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .top-bar input[type="text"] {
      flex: 1;
      padding: 9px 11px;
      border-radius: 999px;
      border: 1px solid var(--card-border);
      font-size: 14px;
      min-width: 0;
      background: rgba(255,255,255,0.9);
      color: var(--text-main);
    }
    .top-bar input::placeholder {
      color: var(--text-muted);
    }
    [data-theme="night"] .top-bar input[type="text"] {
      background: #020617;
      border-color: #1f2937;
    }

    .btn {
      padding: 8px 11px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      transition: transform 0.05s ease, box-shadow 0.1s ease, background 0.1s ease, opacity 0.1s ease;
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
      opacity: 0.92;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-1), var(--primary-2));
      color: white;
      box-shadow: 0 4px 10px rgba(127,157,255,0.35);
    }
    .btn-secondary {
      background: var(--primary-soft);
      color: #283252;
    }
    [data-theme="night"] .btn-secondary { color: #e5e7eb; }
    .btn-danger {
      background: var(--danger-bg);
      color: var(--danger-text);
    }
    .btn-small {
      font-size: 12px;
      padding: 5px 9px;
      border-radius: 999px;
    }
    .btn-disabled {
      opacity: 0.45;
      pointer-events: none;
      filter: grayscale(0.2);
    }

    .tools-bar {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    /* ===== íƒ­ ===== */
    .tab-bar{
      display:flex;
      gap:8px;
      margin: 6px 0 10px;
      justify-content: flex-start;
      flex-wrap: wrap;
    }
    .tab-btn{
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--card-border);
      background: rgba(255,255,255,0.7);
      color: var(--text-main);
      font-size: 13px;
      cursor: pointer;
      display:flex;
      align-items:center;
      gap:6px;
    }
    [data-theme="night"] .tab-btn{
      background: rgba(2,6,23,0.7);
      border-color:#1f2937;
      color:#e5e7eb;
    }
    .tab-btn.active{
      background: linear-gradient(135deg, var(--primary-1), var(--primary-2));
      color:#fff;
      border-color: transparent;
      box-shadow: 0 6px 16px rgba(127,157,255,0.28);
    }
    .tab-dot{
      width:7px;height:7px;border-radius:999px;background: var(--primary-1);
      box-shadow: 0 0 8px rgba(129,140,248,0.6);
    }
    .tab-btn.active .tab-dot{ background:#fff; box-shadow:none; }

    /* ì¹´ìš´íŠ¸ + ë·° ì „í™˜ */
    .count-wrap {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }
    .count-bar {
      font-size: 11px;
      color: var(--text-muted);
      text-align: left;
      flex: 1;
    }
    .count-bar strong { color: var(--primary-1); }

    .form-card {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 12px 14px;
      margin-bottom: 12px;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--card-border);
    }
    .form-row {
      display: flex;
      flex-direction: column;
      margin-bottom: 9px;
    }
    .form-row label {
      font-size: 12px;
      margin-bottom: 4px;
      color: var(--label-color);
      line-height: 1.2;
      white-space: normal; /* ê¸€ì”¨ ê¹¨ì§ ë°©ì§€ */
      word-break: keep-all;
    }
    .form-row input[type="text"],
    .form-row input[type="date"],
    .form-row input[type="password"],
    .form-row input[type="number"],
    .form-row select {
      padding: 7px 10px;
      border-radius: 10px;
      border: 1px solid var(--card-border);
      font-size: 13px;
      background: #f9f9ff;
      color: var(--text-main);
    }
    [data-theme="night"] .form-row input[type="text"],
    [data-theme="night"] .form-row input[type="date"],
    [data-theme="night"] .form-row input[type="password"],
    [data-theme="night"] .form-row input[type="number"],
    [data-theme="night"] .form-row select {
      background: #020617;
      border-color: #1f2937;
      color: #e5e7eb;
    }
    .form-row input[type="file"] { font-size: 12px; }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 24px;
    }

    /* ê°¤ëŸ¬ë¦¬ ëª¨ë“œ */
    .list.gallery {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .list.gallery .card {
      flex-direction: column;
      align-items: stretch;
    }
    .list.gallery .card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
    }

    .card {
      background: rgba(255,255,255,0.96);
      border-radius: 16px;
      padding: 10px;
      display: flex;
      gap: 10px;
      box-shadow: 0 6px 16px rgba(169, 177, 214, 0.35);
      align-items: flex-start;
      border: 1px solid var(--card-border);
      animation: cardFadeIn 0.18s ease-out;
    }
    [data-theme="night"] .card {
      background: rgba(15,23,42,0.98);
      box-shadow: 0 8px 22px rgba(15,23,42,0.85);
    }

    @keyframes cardFadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card img {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 12px;
      background: #eef1ff;
      flex-shrink: 0;
      cursor: pointer;
    }
    .card-content { flex: 1; font-size: 13px; }
    .card-row-main {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 4px;
      align-items: center;
      flex-wrap: wrap;
    }
    .card-title {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-main);
    }
    .card-tag {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      background: var(--chip-bg);
      color: var(--chip-text);
      align-self: flex-start;
    }
    .warn-tag{
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(251, 191, 36, 0.18);
      color: #b45309;
      border: 1px solid rgba(251, 191, 36, 0.35);
    }
    [data-theme="night"] .warn-tag{
      color: #fbbf24;
      border-color: rgba(251, 191, 36, 0.25);
    }

    .card-row { margin-bottom: 2px; color: var(--text-main); }
    .label { color: var(--label-color); font-size: 11px; margin-right: 4px; }
    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
      gap: 6px;
      flex-wrap: wrap;
    }
    .last-used { font-size: 11px; color: var(--text-muted); }
    .card-buttons { display: flex; gap: 4px; flex-wrap: wrap; }

    .empty-text {
      text-align: center;
      color: #777;
      font-size: 13px;
      margin-top: 20px;
    }

    .toggle-group {
      display: flex;
      gap: 6px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }
    .toggle-btn {
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid var(--card-border);
      background: #f5f3ff;
      color: #464b73;
      cursor: pointer;
      transition: background 0.1s ease, color 0.1s ease, border 0.1s ease;
    }
    .toggle-btn.active {
      border-color: var(--primary-1);
      background: var(--primary-1);
      color: #fff;
    }

    /* ì ê¸ˆ í™”ë©´ (íŒíŠ¸/ì„¤ëª…/ë¬¸êµ¬ ì—†ìŒ) */
    .lock-screen {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(255,255,255,0.95), rgba(203,213,255,0.96));
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 1000;
    }
    .lock-card {
      width: 100%;
      max-width: 320px;
      margin: 0 auto;
      background: rgba(255,255,255,0.98);
      border-radius: 20px;
      padding: 18px 18px 16px;
      box-shadow: 0 12px 28px rgba(136, 144, 195, 0.55);
      border: 1px solid #dde1ff;
      text-align: center;
    }
    .lock-input-wrap {
      display: flex;
      gap: 8px;
      margin-bottom: 0;
      align-items: center;
      justify-content: space-between;
    }
    .lock-input-wrap input {
      flex: 1;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid #d6d9ff;
      background: #f7f7ff;
      text-align: center;
      font-size: 14px;
      letter-spacing: 3px;
      min-width: 0;
    }

    .settings-section-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #3c4266;
    }
    .settings-help {
      font-size: 11px;
      color: #8a8fb0;
      margin-bottom: 6px;
      line-height: 1.35;
      word-break: keep-all;
    }

    [data-theme="night"] .settings-section-title { color: #e5e7eb; }
    [data-theme="night"] .settings-help { color: #9ca3af; }
    [data-theme="night"] .empty-text { color: #9ca3af; }

    /* ì´ë¯¸ì§€ ì „ì²´ ë³´ê¸° */
    .image-viewer {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1500;
    }
    .image-viewer-backdrop { position: absolute; inset: 0; background: rgba(15, 23, 42, 0.75); }
    .image-viewer-inner {
      position: relative;
      max-width: 100%;
      max-height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    #viewerImage {
      max-width: 100%;
      max-height: 100%;
      border-radius: 12px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.5);
      touch-action: none;
      transition: transform 0.1s ease-out;
    }
    .viewer-close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      border-radius: 999px;
      border: none;
      padding: 6px 10px;
      font-size: 14px;
      cursor: pointer;
      background: rgba(15,23,42,0.8);
      color: #f9fafb;
    }

    /* ê¸°ê¸° ì´ë¦„ ìµœì´ˆ ì…ë ¥ ëª¨ë‹¬ */
    .device-modal {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1200;
      padding: 16px;
    }
    .device-modal-card {
      background: #fff;
      border-radius: 18px;
      padding: 16px 18px 14px;
      max-width: 320px;
      width: 100%;
      box-shadow: 0 10px 24px rgba(0,0,0,0.25);
    }
    .device-modal-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #272a3f;
    }
    .device-modal-text {
      font-size: 12px;
      color: #767a98;
      margin-bottom: 10px;
      line-height: 1.35;
    }
    .device-modal-input {
      width: 100%;
      padding: 7px 10px;
      border-radius: 10px;
      border: 1px solid #d6d9ff;
      font-size: 13px;
      background: #f9f9ff;
      margin-bottom: 10px;
    }
    .device-modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
    }

    /* í† ìŠ¤íŠ¸ */
    .toast {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%) translateY(40px);
      background: var(--toast-bg);
      color: var(--toast-text);
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 2000;
      max-width: 80%;
      text-align: center;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      box-shadow: 0 10px 24px rgba(15,23,42,0.6);
    }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* íˆìŠ¤í† ë¦¬ íƒ€ì„ë¼ì¸ */
    .history-list {
      max-height: 280px;
      overflow-y: auto;
      padding-right: 4px;
      margin-top: 4px;
      position: relative;
    }
    .history-list::before {
      content: "";
      position: absolute;
      left: 8px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: linear-gradient(to bottom, rgba(148,163,184,0.6), rgba(199,210,254,0.2));
    }
    .history-row {
      font-size: 12px;
      color: #444867;
      padding: 6px 2px 6px 20px;
      position: relative;
    }
    [data-theme="night"] .history-row { color: #e5e7eb; }
    .history-row::before {
      content: "";
      position: absolute;
      left: 4px;
      top: 10px;
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #fff;
      border: 2px solid var(--primary-1);
      box-shadow: 0 0 0 4px rgba(129,140,248,0.15);
    }
    .history-time { color: #6b6f90; font-size: 11px; }
    [data-theme="night"] .history-time { color: #9ca3af; }
    .history-device { color: var(--primary-1); font-size: 11px; margin-left: 4px; }
    .history-action-chip {
      display: inline-block;
      margin-left: 6px;
      padding: 1px 6px;
      border-radius: 999px;
      font-size: 11px;
      background: var(--chip-bg);
      color: var(--chip-text);
    }
    .history-film { color: #111827; font-weight: 500; }
    [data-theme="night"] .history-film { color: #e5e7eb; }
    .history-changes { font-size: 11px; color: #6b7280; margin-top: 2px; }
    [data-theme="night"] .history-changes { color: #9ca3af; }
    .history-empty { font-size: 12px; color: #6b7280; padding-left: 20px; margin-top: 6px; }
    [data-theme="night"] .history-empty { color: #9ca3af; }

    /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
    .spinner-wrapper {
      display: none;
      justify-content: center;
      align-items: center;
      padding: 4px 0 16px;
    }
    .spinner-wrapper.show { display: flex; }
    .spinner-circle {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 3px solid var(--spinner-border);
      border-top-color: var(--primary-1);
      box-shadow: 0 0 12px var(--spinner-glow);
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ë§¨ ìœ„ë¡œ ë²„íŠ¼ */
    .scroll-top-btn {
      position: fixed;
      right: 16px;
      bottom: 24px;
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: none;
      font-size: 18px;
      cursor: pointer;
      background: linear-gradient(135deg, var(--primary-1), var(--primary-2));
      color: #fff;
      display: none;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 24px rgba(107,114,128,0.6);
      z-index: 1900;
    }
    .scroll-top-btn.show { display: flex; }

    @media (min-width: 768px) { body { padding-top: 24px; } }
    @media (min-width: 600px) {
      .list.gallery { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (min-width: 1024px) {
      .app-shell, .app-header { max-width: 1080px; }
      .list.gallery { grid-template-columns: repeat(3, minmax(260px, 1fr)); }
    }

    /* ====== í•„ë¦„ ë©”ëª¨: ìŠ¬ë¼ì´ë“œ(ë°”í…€ ì‹œíŠ¸) ====== */
    .memo-sheet {
      position: fixed;
      inset: 0;
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 1600;
    }
    .memo-sheet.show { display: flex; }
    .memo-sheet-backdrop { position: absolute; inset: 0; background: rgba(15, 23, 42, 0.45); }
    .memo-sheet-panel {
      position: relative;
      width: 100%;
      max-width: 720px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 18px 18px 0 0;
      box-shadow: 0 -12px 28px rgba(0,0,0,0.25);
      padding: 12px 14px 14px;
      animation: sheetUp 0.16s ease-out;
    }
    @keyframes sheetUp {
      from { transform: translateY(14px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .memo-sheet-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .memo-sheet-title { font-size: 14px; font-weight: 700; color: var(--text-main); }
    .memo-sheet-sub { font-size: 11px; color: var(--text-sub); margin-top: 2px; }
    .memo-sheet-textarea {
      width: 100%;
      min-height: 120px;
      resize: vertical;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--card-border);
      background: #f9f9ff;
      color: var(--text-main);
      font-size: 13px;
      line-height: 1.45;
    }
    [data-theme="night"] .memo-sheet-textarea {
      background: #020617;
      border-color: #1f2937;
      color: #e5e7eb;
    }
    .memo-sheet-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    /* ë©”ëª¨ ë²„íŠ¼: ë©”ëª¨ ìˆìœ¼ë©´ ì‚´ì§ ê°•ì¡° */
    .btn-memo-has { box-shadow: 0 0 0 2px rgba(127,157,255,0.18) inset; }

    /* ====== íˆìŠ¤í† ë¦¬: ì—°í•„ ë²„íŠ¼ + ë…¸íŠ¸ í‘œì‹œ ====== */
    .history-headline {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .history-pencil {
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      background: var(--primary-soft);
      color: var(--text-main);
    }
    [data-theme="night"] .history-pencil { color: #e5e7eb; }
    .history-note {
      margin-top: 6px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--card-border);
      background: rgba(228,231,255,0.65);
      font-size: 12px;
      color: var(--text-main);

      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    [data-theme="night"] .history-note {
      background: rgba(79,70,229,0.18);
      border-color: #1f2937;
    }

    /* ====== íˆìŠ¤í† ë¦¬ ë©”ëª¨ ëª¨ë‹¬ ====== */
    .note-modal {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1700;
      padding: 16px;
    }
    .note-modal.show { display: flex; }
    .note-modal-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 18px;
      padding: 16px 18px 14px;
      max-width: 380px;
      width: 100%;
      box-shadow: 0 10px 24px rgba(0,0,0,0.25);
    }
    .note-modal-title { font-size: 15px; font-weight: 700; margin-bottom: 6px; color: var(--text-main); }
    .note-modal-text { font-size: 12px; color: var(--text-sub); margin-bottom: 10px; }
    .note-modal-textarea {
      width: 100%;
      min-height: 120px;
      resize: vertical;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--card-border);
      background: #f9f9ff;
      color: var(--text-main);
      font-size: 13px;
      line-height: 1.45;
    }
    [data-theme="night"] .note-modal-textarea {
      background: #020617;
      border-color: #1f2937;
      color: #e5e7eb;
    }
    .note-modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    /* ====== íŒ: ì‚¬ìš©/íˆìŠ¤í† ë¦¬ ì‹œíŠ¸ ====== */
    .sheet-small-help{
      font-size: 11px;
      color: var(--text-sub);
      line-height: 1.35;
      word-break: keep-all;
    }
    .usage-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 8px;
    }
    @media (max-width: 520px){
      .usage-grid{ grid-template-columns: 1fr; }
    }
    .usage-chip{
      display:inline-block;
      margin-left: 6px;
      padding: 1px 6px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(148,163,184,0.16);
      border: 1px solid rgba(148,163,184,0.25);
      color: var(--text-main);
    }
    [data-theme="night"] .usage-chip{
      color:#e5e7eb;
      border-color: rgba(148,163,184,0.18);
    }
    .usage-warn-50{ background: rgba(34,197,94,0.14); border-color: rgba(34,197,94,0.25); }
    .usage-warn-70{ background: rgba(251,191,36,0.18); border-color: rgba(251,191,36,0.28); }
    .usage-warn-90{ background: rgba(248,113,113,0.18); border-color: rgba(248,113,113,0.30); }

    /* ====== íŒ ì „ìš© ì»¨í…Œì´ë„ˆ ====== */
    .section-hidden{ display:none !important; }
  </style>
</head>
<body>
  <!-- ì ê¸ˆ í™”ë©´ (íŒíŠ¸/ì„¤ëª…/ë¬¸êµ¬ ì ˆëŒ€ ì—†ìŒ) -->
  <div id="lockScreen" class="lock-screen">
    <div class="lock-card">
      <div class="lock-input-wrap">
        <input type="password" id="passwordInput" maxlength="20" placeholder="â€¢â€¢â€¢â€¢" />
        <button class="btn btn-primary btn-small" id="passwordBtn">ì…ì¥</button>
      </div>
    </div>
  </div>

  <!-- ê¸°ê¸° ì´ë¦„ ìµœì´ˆ ì…ë ¥ ëª¨ë‹¬ -->
  <div id="deviceModal" class="device-modal">
    <div class="device-modal-card">
      <div class="device-modal-title">ì´ ê¸°ê¸° ì´ë¦„ ì •í•˜ê¸°</div>
      <div class="device-modal-text">
        ì˜ˆ: ê°€ì€í°, ì„±ê·œíŒ¨ë“œ, íšŒì‚¬PC
      </div>
      <input id="deviceModalInput" class="device-modal-input" type="text" placeholder="ì˜ˆ: ê°€ì€í°" />
      <div class="device-modal-actions">
        <button class="btn btn-secondary btn-small" id="deviceModalSkip">ë‚˜ì¤‘ì—</button>
        <button class="btn btn-primary btn-small" id="deviceModalSave">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ì´ë¯¸ì§€ ì „ì²´ë³´ê¸° -->
  <div id="imageViewer" class="image-viewer">
    <div class="image-viewer-backdrop" id="viewerBackdrop"></div>
    <div class="image-viewer-inner">
      <img id="viewerImage" src="" alt="í•„ë¦„ ì´ë¯¸ì§€" />
      <button id="closeViewerBtn" class="viewer-close-btn">âœ•</button>
    </div>
  </div>

  <!-- í† ìŠ¤íŠ¸ -->
  <div id="toast" class="toast"></div>

  <!-- ====== í•„ë¦„ ë©”ëª¨ ìŠ¬ë¼ì´ë“œ ====== -->
  <div id="memoSheet" class="memo-sheet">
    <div id="memoSheetBackdrop" class="memo-sheet-backdrop"></div>
    <div class="memo-sheet-panel">
      <div class="memo-sheet-head">
        <div>
          <div class="memo-sheet-title" id="memoSheetTitle">ë©”ëª¨</div>
          <div class="memo-sheet-sub" id="memoSheetSub">í•„ë¦„ë³„ ë©”ëª¨</div>
        </div>
        <button class="btn btn-secondary btn-small" id="memoSheetCloseBtn">ë‹«ê¸°</button>
      </div>
      <textarea id="memoTextarea" class="memo-sheet-textarea" placeholder="ì˜ˆ: í…ì…˜ 23 ì´í•˜ì—ì„œ ë²ˆì§ / ìš°ì¸¡ 2mm ë°€ë¦¼ ì£¼ì˜"></textarea>
      <div class="memo-sheet-actions">
        <button class="btn btn-secondary btn-small" id="memoSheetCancelBtn">ì·¨ì†Œ</button>
        <button class="btn btn-primary btn-small" id="memoSheetSaveBtn">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ====== íŒ ë©”ëª¨ ìŠ¬ë¼ì´ë“œ (í•„ë¦„ ë©”ëª¨ì™€ ë™ì¼ ê°œë…) ====== -->
  <div id="plateMemoSheet" class="memo-sheet">
    <div id="plateMemoSheetBackdrop" class="memo-sheet-backdrop"></div>
    <div class="memo-sheet-panel">
      <div class="memo-sheet-head">
        <div>
          <div class="memo-sheet-title" id="plateMemoSheetTitle">ë©”ëª¨</div>
          <div class="memo-sheet-sub" id="plateMemoSheetSub">íŒë³„ ë©”ëª¨</div>
        </div>
        <button class="btn btn-secondary btn-small" id="plateMemoSheetCloseBtn">ë‹«ê¸°</button>
      </div>
      <textarea id="plateMemoTextarea" class="memo-sheet-textarea" placeholder="ì˜ˆ: 7125J / í…ì…˜ ìœ ì§€ 24~25 / 1ë²ˆ íŒ ìš°ì¸¡ 1mm ì£¼ì˜"></textarea>
      <div class="memo-sheet-actions">
        <button class="btn btn-secondary btn-small" id="plateMemoSheetCancelBtn">ì·¨ì†Œ</button>
        <button class="btn btn-primary btn-small" id="plateMemoSheetSaveBtn">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ====== íŒ ì‚¬ìš©ë“±ë¡ ì‹œíŠ¸ ====== -->
  <div id="plateUseSheet" class="memo-sheet">
    <div id="plateUseSheetBackdrop" class="memo-sheet-backdrop"></div>
    <div class="memo-sheet-panel">
      <div class="memo-sheet-head">
        <div>
          <div class="memo-sheet-title" id="plateUseSheetTitle">íŒ ì‚¬ìš©ë“±ë¡</div>
          <div class="memo-sheet-sub" id="plateUseSheetSub">ëˆ„ê°€/ìˆ˜ëŸ‰/ë©”ëª¨/ì‹œê°„ ìë™ ê¸°ë¡</div>
        </div>
        <button class="btn btn-secondary btn-small" id="plateUseSheetCloseBtn">ë‹«ê¸°</button>
      </div>

      <div class="usage-grid">
        <div class="form-row" style="margin:0;">
          <label for="plateUsePrinterSelect">ì¸ì‡„ê¸°ì‚¬ ì´ë¦„ (ì„ íƒ)</label>
          <select id="plateUsePrinterSelect">
            <option value="">ì„ íƒ ì•ˆ í•¨</option>
          </select>
        </div>
        <div class="form-row" style="margin:0;">
          <label for="plateUseQty">ì¸ì‡„ ìˆ˜ëŸ‰</label>
          <input type="number" id="plateUseQty" min="0" step="1" placeholder="ì˜ˆ: 1200" />
        </div>
      </div>

      <div class="form-row" style="margin-top:10px;">
        <label for="plateUseMemo">ë©”ëª¨</label>
        <textarea id="plateUseMemo" class="memo-sheet-textarea" style="min-height:90px;" placeholder="ì˜ˆ: ì‰í¬ ë¬½ìŒ / ì¢Œì¸¡ ë°€ë¦¼ìœ¼ë¡œ ì••ë ¥ ë‚®ì¶¤"></textarea>
      </div>

      <div class="sheet-small-help">
        Â· ì‹œê°„ì€ ìë™ ê¸°ë¡ë¨<br/>
        Â· ê¸°ë¡ì€ <b>plates/{plateId}/usage</b>ì— ì¶”ê°€ë˜ê³ , ë™ì‹œì— plates ë¬¸ì„œì— ë§ˆì§€ë§‰ ì‚¬ìš© ìš”ì•½ì´ ì €ì¥ë¼.
      </div>

      <div class="memo-sheet-actions">
        <button class="btn btn-secondary btn-small" id="plateUseSheetCancelBtn">ì·¨ì†Œ</button>
        <button class="btn btn-primary btn-small" id="plateUseSheetSaveBtn">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ====== íŒ íˆìŠ¤í† ë¦¬(ìƒì„¸) ì‹œíŠ¸ ====== -->
  <div id="plateHistorySheet" class="memo-sheet">
    <div id="plateHistorySheetBackdrop" class="memo-sheet-backdrop"></div>
    <div class="memo-sheet-panel">
      <div class="memo-sheet-head">
        <div>
          <div class="memo-sheet-title" id="plateHistorySheetTitle">íŒ íˆìŠ¤í† ë¦¬</div>
          <div class="memo-sheet-sub" id="plateHistorySheetSub">ì–¸ì œ / ëˆ„ê°€ / ëª‡ ê°œ / ë©”ëª¨</div>
        </div>
        <button class="btn btn-secondary btn-small" id="plateHistorySheetCloseBtn">ë‹«ê¸°</button>
      </div>
      <div id="plateHistoryList" class="history-list"></div>
      <div class="memo-sheet-actions">
        <button class="btn btn-secondary btn-small" id="plateHistorySheetCloseBtn2">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ====== íˆìŠ¤í† ë¦¬ ë©”ëª¨ ëª¨ë‹¬ ====== -->
  <div id="historyNoteModal" class="note-modal">
    <div class="note-modal-card">
      <div class="note-modal-title">íˆìŠ¤í† ë¦¬ ë©”ëª¨</div>
      <div class="note-modal-text">ì´ ë³€ê²½ ê¸°ë¡ì— â€œì™œ ë°”ë€Œì—ˆëŠ”ì§€â€ë¥¼ ì ì–´ë‘˜ ìˆ˜ ìˆì–´.</div>
      <textarea id="historyNoteTextarea" class="note-modal-textarea" placeholder="ì˜ˆ: ê²¹ì¹¨ ì´ìŠˆë¡œ 4-2-1.6ë²ˆìœ¼ë¡œ ì´ë™"></textarea>
      <div class="note-modal-actions">
        <button class="btn btn-secondary btn-small" id="historyNoteCancelBtn">ì·¨ì†Œ</button>
        <button class="btn btn-primary btn-small" id="historyNoteSaveBtn">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ì‹¤ì œ ì•± -->
  <div id="appContainer" style="display:none;">
    <div class="app-header">
      <div class="title-wrap">
        <div class="app-title">FILM FIND</div>
        <div class="app-subtitle" id="headerSubtitle">í•„ë¦„ ê´€ë¦¬</div>
      </div>
      <div id="deviceBadge" class="device-badge">
        <span class="device-dot"></span>
        <span id="deviceBadgeText"></span>
        <span id="modePill" class="mode-pill"></span>
      </div>
    </div>

    <div class="app-shell">
      <div class="top-bar">
        <input type="text" id="searchInput" placeholder="ì œí’ˆëª… / í•„ë¦„ë²ˆí˜¸ / ì œíŒíƒ€ì… / ìœ„ì¹˜ / ì œíŒë°©ë²• / MESH / ìš”ì²­ ì¸ì‡„ì ê²€ìƒ‰" />
        <button class="btn btn-primary" id="newFilmBtn">+ ìƒˆ í•„ë¦„</button>

        <!-- íŒ íƒ­ì—ì„œë§Œ ë³´ì¼ íŒ ê²€ìƒ‰(í•„ë“œ ê³µìœ ) -->
        <button class="btn btn-primary section-hidden" id="newPlateBtn">+ ìƒˆ íŒ</button>
      </div>

      <div class="tools-bar">
        <button class="btn btn-secondary btn-small" id="settingsBtn">âš™ ì„¤ì •</button>
        <button class="btn btn-secondary btn-small" id="historyBtn">ğŸ“œ íˆìŠ¤í† ë¦¬</button>
        <button class="btn btn-secondary btn-small" id="exportBtn">ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
        <button class="btn btn-secondary btn-small" id="importBtn">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <input type="file" id="importFile" accept="application/json" style="display:none;" />
      </div>

      <!-- íƒ­(í•„ë¦„/íŒ) -->
      <div class="tab-bar">
        <button class="tab-btn" id="tabFilmsBtn"><span class="tab-dot"></span>í•„ë¦„</button>
        <button class="tab-btn" id="tabPlatesBtn"><span class="tab-dot"></span>íŒ</button>
      </div>

      <div class="count-wrap">
        <div id="countBar" class="count-bar">ì´ 0ê°œ</div>
        <button class="btn btn-secondary btn-small" id="viewToggleBtn">ê°¤ëŸ¬ë¦¬</button>
      </div>

      <!-- ì„¤ì • ì¹´ë“œ -->
      <div class="form-card" id="settingsCard" style="display:none;">
        <div class="form-row">
          <div class="settings-section-title">ì´ ê¸°ê¸° ì´ë¦„</div>
          <div class="settings-help">ì˜ˆ: ê°€ì€í°, ì„±ê·œíŒ¨ë“œ, íšŒì‚¬PC. ì´ ê¸°ê¸°ì—ì„œë§Œ í‘œì‹œë¼.</div>
          <input type="text" id="deviceNameInput" placeholder="ê¸°ê¸° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" />
        </div>

        <div class="form-row">
          <div class="settings-section-title">ê¸°ë³¸ ì •ë ¬ ë°©ì‹</div>
          <div class="settings-help">ë¦¬ìŠ¤íŠ¸ë¥¼ ì–´ë–¤ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í• ì§€ ì„ íƒí•´.</div>
          <select id="sortOptionSelect">
            <option value="updated">ìµœê·¼ ìˆ˜ì •ìˆœ</option>
            <option value="name">ì œí’ˆëª… ê°€ë‚˜ë‹¤ìˆœ</option>
            <option value="number">í•„ë¦„ë²ˆí˜¸ ìˆœ</option>
            <option value="lastUsed">ë§ˆì§€ë§‰ ì‚¬ìš©ì¼ ìµœì‹ ìˆœ</option>
          </select>
        </div>

        <div class="form-row">
          <div class="settings-section-title">í…Œë§ˆ ìƒ‰ìƒ</div>
          <div class="settings-help">ì•±ì˜ ìƒ‰ ë¶„ìœ„ê¸°ë¥¼ ì„ íƒí•´ ì¤˜.</div>
          <select id="themeSelect">
            <option value="default">ë¼ë²¤ë”</option>
            <option value="mint">ë¯¼íŠ¸</option>
            <option value="peach">í”¼ì¹˜</option>
            <option value="night">ë‚˜ì´íŠ¸</option>
          </select>
        </div>

        <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½: ê´€ë¦¬ìë§Œ ê°€ëŠ¥ (ë¬¸êµ¬ í•œ ì¤„ ì •ìƒ í‘œì‹œ) -->
        <div class="form-row" id="pwChangeSection">
          <div class="settings-section-title">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</div>
          <div class="settings-help">ê´€ë¦¬ìë§Œ ë³€ê²½ ê°€ëŠ¥</div>

          <label for="adminPwInput">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</label>
          <input type="password" id="adminPwInput" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸" />

          <label for="printerPwInput" style="margin-top:6px;">ì¸ì‡„ê¸°ì‚¬ ë¹„ë°€ë²ˆí˜¸</label>
          <input type="password" id="printerPwInput" placeholder="ì¸ì‡„ê¸°ì‚¬ ë¹„ë°€ë²ˆí˜¸" />

          <label for="viewerPwInput" style="margin-top:6px;">ì¡°íšŒ ë¹„ë°€ë²ˆí˜¸</label>
          <input type="password" id="viewerPwInput" placeholder="ì¡°íšŒ ë¹„ë°€ë²ˆí˜¸" />
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary btn-small" id="closeSettingsBtn">ë‹«ê¸°</button>
          <button type="button" class="btn btn-primary btn-small" id="saveSettingsBtn">ì €ì¥</button>
        </div>
      </div>

      <!-- íˆìŠ¤í† ë¦¬ ì¹´ë“œ(ê¸°ì¡´ í•„ë¦„ íˆìŠ¤í† ë¦¬ ë¡œì§ ìœ ì§€) -->
      <div class="form-card" id="historyCard" style="display:none;">
        <div class="settings-section-title">ğŸ“œ íˆìŠ¤í† ë¦¬</div>
        <div class="settings-help">
          ë“±ë¡ / ìˆ˜ì • / ì‚­ì œ / ì˜¤ëŠ˜ ì‚¬ìš© ê¸°ë¡ì„ ìµœê·¼ 100ê°œê¹Œì§€ ë³´ì—¬ì¤„ê²Œ.<br>
          (ê¸°ê¸° ì´ë¦„ê³¼ ì–´ë–¤ í•­ëª©ì´ ë°”ë€Œì—ˆëŠ”ì§€ë„ ê°™ì´ í‘œì‹œë¼.)
        </div>
        <div id="historyList" class="history-list"></div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary btn-small" id="closeHistoryBtn">ë‹«ê¸°</button>
        </div>
      </div>

      <!-- í•„ë¦„ ì…ë ¥ í¼(ê¸°ì¡´ ìœ ì§€) -->
      <div class="form-card" id="formCard" style="display:none;">
        <form id="filmForm">
          <input type="hidden" id="filmId" />
          <div class="form-row">
            <label for="productName">ì œí’ˆ ì´ë¦„ *</label>
            <input type="text" id="productName" required />
          </div>
          <div class="form-row">
            <label for="filmNumber">í•„ë¦„ ë²ˆí˜¸ *</label>
            <input type="text" id="filmNumber" required />
          </div>
          <div class="form-row">
            <label for="method">ì œíŒ íƒ€ì…</label>
            <input type="text" id="method" placeholder="ì˜ˆ: ë°”íƒ•, ë¬¸ì, ìŠ¤ëª¨ê·¸ ë“±" />
          </div>

          <!-- MESH í•­ëª© -->
          <div class="form-row">
            <label for="mesh">MESH</label>
            <input type="text" id="mesh" placeholder="ì˜ˆ: 180T, 200ë©”ì‰¬ ë“±" />
          </div>

          <div class="form-row">
            <label>í•„ë¦„ ì œíŒ ë°©ë²•</label>
            <div class="toggle-group" data-group="frontBack">
              <button type="button" class="toggle-btn" data-value="ì „ë©´">ì „ë©´</button>
              <button type="button" class="toggle-btn" data-value="ë°°ë©´">ë°°ë©´</button>
            </div>
            <div class="toggle-group" data-group="leftRight">
              <button type="button" class="toggle-btn" data-value="ì¢Œ">ì¢Œ</button>
              <button type="button" class="toggle-btn" data-value="ìš°">ìš°</button>
            </div>
            <div class="toggle-group" data-group="upDown">
              <button type="button" class="toggle-btn" data-value="ìƒ">ìƒ</button>
              <button type="button" class="toggle-btn" data-value="í•˜">í•˜</button>
            </div>
            <small style="font-size:11px; color:var(--text-sub);">
              ì „ë©´/ë°°ë©´ + ì¢Œ/ìš° + ìƒ/í•˜ ì¡°í•© (ì˜ˆ: ë°°ë©´ ì¢Œìƒ, ì „ë©´ ìš°í•˜ ë“±)
            </small>
          </div>

          <div class="form-row">
            <label for="location">í•„ë¦„ ìœ„ì¹˜</label>
            <input type="text" id="location" placeholder="ì˜ˆ: A-3 ì„œë, 4ì¸µ ìš°ì¸¡ ë™ ë“±" />
          </div>

          <!-- ìš”ì²­ ì¸ì‡„ì -->
          <div class="form-row">
            <label for="requestPrinter">ìš”ì²­ ì¸ì‡„ì</label>
            <select id="requestPrinter">
              <option value="">ì„ íƒ ì•ˆ í•¨</option>
              <option value="ì´ì°½ë¯¼ ë¶€ì¥ë‹˜">ì´ì°½ë¯¼ ë¶€ì¥ë‹˜</option>
              <option value="ê³ ê´‘ìš´ ê³¼ì¥ë‹˜">ê³ ê´‘ìš´ ê³¼ì¥ë‹˜</option>
              <option value="ê¹€ê·œí—Œ ì°¨ì¥ë‹˜">ê¹€ê·œí—Œ ì°¨ì¥ë‹˜</option>
              <option value="ë°•ì¬í˜„ ëŒ€ë¦¬ë‹˜">ë°•ì¬í˜„ ëŒ€ë¦¬ë‹˜</option>
              <option value="ì¡°ì˜ë¹ˆ ëŒ€ë¦¬ë‹˜">ì¡°ì˜ë¹ˆ ëŒ€ë¦¬ë‹˜</option>
              <option value="ê¹€í˜„ê·œ ëŒ€ë¦¬ë‹˜">ê¹€í˜„ê·œ ëŒ€ë¦¬ë‹˜</option>
              <option value="ì¥ì§„ìš° ëŒ€ë¦¬ë‹˜">ì¥ì§„ìš° ëŒ€ë¦¬ë‹˜</option>
              <option value="ê¹€ë¯¸ì€ ì£¼ì„ë‹˜">ê¹€ë¯¸ì€ ì£¼ì„ë‹˜</option>
              <option value="ì´ìˆ˜ì•ˆ ì‚¬ì›ë‹˜">ì´ìˆ˜ì•ˆ ì‚¬ì›ë‹˜</option>
              <option value="ë°•ì§€ì•ˆ ì‚¬ì›ë‹˜">ë°•ì§€ì•ˆ ì‚¬ì›ë‹˜</option>
              <option value="ê¹€ì¸ì„  ì‚¬ì›ë‹˜">ê¹€ì¸ì„  ì‚¬ì›ë‹˜</option>
              <option value="ê¹€ìš©ì› ì‚¬ì›ë‹˜">ê¹€ìš©ì› ì‚¬ì›ë‹˜</option>
              <option value="ìµœì„±ê·œ ì‚¬ì›ë‹˜">ìµœì„±ê·œ ì‚¬ì›ë‹˜</option>
            </select>
          </div>

          <div class="form-row">
            <label for="lastUsed">ë§ˆì§€ë§‰ ì‚¬ìš©ì¼</label>
            <div style="display:flex; gap:6px;">
              <input type="date" id="lastUsed" style="flex:1;" />
              <button type="button" class="btn btn-secondary btn-small" id="setTodayBtn">ì˜¤ëŠ˜</button>
            </div>
          </div>

          <div class="form-row">
            <label for="imageInput">í•„ë¦„ ì‚¬ì§„ (ì„ íƒ)</label>
            <input type="file" id="imageInput" accept="image/*" />
            <small style="font-size:11px; color:var(--text-sub);">
              Â· ìƒˆ í•„ë¦„ì—ëŠ” ì‚¬ì§„ì„ ì¶”ê°€í•˜ê³ ,<br/>
              Â· ìˆ˜ì • ì‹œ ì‚¬ì§„ì„ ë°”ê¾¸ê³  ì‹¶ì„ ë•Œë§Œ ë‹¤ì‹œ ì„ íƒí•˜ì„¸ìš”.
            </small>

            <!-- ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° + íšŒì „ ë²„íŠ¼ -->
            <div id="imagePreviewWrapper" style="margin-top:8px; display:none; align-items:center; gap:6px;">
              <img id="imagePreview" alt="ë¯¸ë¦¬ë³´ê¸°"
                   style="width:70px; height:70px; border-radius:10px; object-fit:cover; background:#eef1ff;" />
              <button type="button" class="btn btn-secondary btn-small" id="rotateLeftBtn">âŸ² 90Â°</button>
              <button type="button" class="btn btn-secondary btn-small" id="rotateRightBtn">âŸ³ 90Â°</button>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="cancelBtn">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn-primary" id="saveBtn">ì €ì¥</button>
          </div>
        </form>
      </div>

      <!-- ====== íŒ ì…ë ¥ í¼ (í•„ë¦„ì—ì„œë§Œ ìƒì„± / ê´€ë¦¬ìë§Œ ìˆ˜ì •Â·ì‚­ì œ) ====== -->
      <div class="form-card section-hidden" id="plateFormCard">
        <form id="plateForm">
          <input type="hidden" id="plateId" />
          <input type="hidden" id="plateFilmId" />
          <div class="settings-section-title">íŒ ë“±ë¡/ìˆ˜ì •</div>
          <div class="settings-help">
            íŒì€ <b>í•„ë¦„ ì¹´ë“œì˜ â€œíŒ ë“±ë¡â€</b> ë²„íŠ¼ìœ¼ë¡œë§Œ ìƒì„±ë¼.
          </div>

          <div class="form-row">
            <label for="plateProductName">ì œí’ˆ ì´ë¦„ (ìƒì†)</label>
            <input type="text" id="plateProductName" disabled />
          </div>

          <div class="form-row">
            <label for="plateFilmNumber">í•„ë¦„ ë²ˆí˜¸ (ìƒì†)</label>
            <input type="text" id="plateFilmNumber" disabled />
          </div>

          <div class="form-row">
            <label for="plateNumber">íŒ ë²ˆí˜¸ (ìë™ ë„˜ë²„ë§ + ìˆ˜ì • ê°€ëŠ¥)</label>
            <input type="text" id="plateNumber" />
          </div>

          <div class="form-row">
            <label for="plateTension">í…ì…˜</label>
            <input type="text" id="plateTension" placeholder="ì˜ˆ: 24~25" />
          </div>

          <div class="form-row">
            <label for="plateLocation">íŒ ìœ„ì¹˜</label>
            <input type="text" id="plateLocation" placeholder="ì˜ˆ: 4ì¸µ ìš°ì¸¡ ë™ / B-2 ì„œë" />
          </div>

          <div class="form-row">
            <label for="plateMesh">MESH (ìˆ˜ì • ê°€ëŠ¥)</label>
            <input type="text" id="plateMesh" placeholder="ì˜ˆ: 200ë©”ì‰¬" />
          </div>

          <div class="form-row">
            <label for="plateMaxQty">ê¸°ë³¸ ìµœëŒ€ ì‚¬ìš© ìˆ˜ëŸ‰ (ê¸°ë³¸ 5000)</label>
            <input type="number" id="plateMaxQty" min="0" step="1" />
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="plateCancelBtn">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn-primary" id="plateSaveBtn">ì €ì¥</button>
          </div>
        </form>
      </div>

      <!-- í•„ë¦„ ë¦¬ìŠ¤íŠ¸ -->
      <div id="list" class="list"></div>
      <div id="emptyText" class="empty-text" style="display:none;">
        ë“±ë¡ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.
      </div>

      <!-- íŒ ë¦¬ìŠ¤íŠ¸ -->
      <div id="plateList" class="list section-hidden"></div>
      <div id="plateEmptyText" class="empty-text section-hidden" style="display:none;">
        ë“±ë¡ëœ íŒì´ ì—†ìŠµë‹ˆë‹¤.<br/>í•„ë¦„ ì¹´ë“œì˜ <b>íŒ ë“±ë¡</b>ìœ¼ë¡œ ì¶”ê°€í•˜ì„¸ìš”.
      </div>

      <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
      <div id="loadingSpinner" class="spinner-wrapper">
        <div class="spinner-circle"></div>
      </div>
    </div>
  </div>

  <!-- ë§¨ ìœ„ë¡œ ë²„íŠ¼ -->
  <button id="scrollTopBtn" class="scroll-top-btn">â†‘</button>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <script>
    /* ---------- Firebase ì„¤ì • ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyBrBnVuXca2Ou1oMFOLzq3KGEN8xiK5L_U",
      authDomain: "film-find-5242d.firebaseapp.com",
      projectId: "film-find-5242d",
      storageBucket: "film-find-5242d.firebasestorage.app",
      messagingSenderId: "185123433624",
      appId: "1:185123433624:web:269eb9b4b6437887f2f4ed",
      measurementId: "G-V9KL8XS9KJ"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const FILM_COLLECTION = "films";
    const PLATE_COLLECTION = "plates";
    const HISTORY_COLLECTION = "history";

    /* ---------- ì•± ì„¤ì •/í‚¤ ---------- */
    const UNLOCK_KEY = "filmAppUnlocked";
    const DEVICE_KEY = "filmDeviceLabel";
    const SORT_KEY = "filmSortOption";
    const THEME_KEY = "filmTheme";
    const VIEW_KEY = "filmViewMode";
    const TAB_KEY = "filmTabMode"; // films | plates

    /* ---------- ëª¨ë“œ/ë¹„ë²ˆ(í™•ì •) ---------- */
    const DEFAULT_AUTH = {
      adminPw: "0605",
      printerPw: "1234",
      viewerPw: "0000",
    };
    const AUTH_DOC_PATH = { col: "appSettings", doc: "auth" };

    let currentMode = "viewer"; // admin | printer | viewer
    let authCache = { ...DEFAULT_AUTH };

    let films = [];
    let plates = [];

    let currentSearchText = "";
    let unsubscribeFilms = null;
    let unsubscribePlates = null;

    let historyEntries = [];
    let historyLoaded = false;

    const VISIBLE_STEP = 30;
    let visibleCount = VISIBLE_STEP;
    let loadingMore = false;

    let currentViewMode = localStorage.getItem(VIEW_KEY) || "list";
    let currentTab = localStorage.getItem(TAB_KEY) || "films";

    /* ì´ë¯¸ì§€ ì„ íƒ/íšŒì „ ìƒíƒœ */
    let currentSelectedImageDataUrl = null;
    let currentImageRotation = 0;

    /* ë©”ëª¨/ì‹œíŠ¸ ìƒíƒœ */
    let currentMemoFilmId = null;
    let currentMemoPlateId = null;
    let currentHistoryNoteId = null;

    /* íŒ ì‚¬ìš© ì‹œíŠ¸ ìƒíƒœ */
    let currentUsePlateId = null;
    let currentPlateHistoryId = null;

    /* ---------- ìœ í‹¸ (ì„¤ì •) ---------- */
    function setDeviceLabel(label) {
      localStorage.setItem(DEVICE_KEY, label);
      const badgeText = document.getElementById("deviceBadgeText");
      if (badgeText) badgeText.textContent = label || "ê¸°ê¸° ë¯¸ì§€ì •";
    }
    function getDeviceLabel() { return localStorage.getItem(DEVICE_KEY) || ""; }

    function getSortOption() { return localStorage.getItem(SORT_KEY) || "updated"; }
    function setSortOption(opt) { localStorage.setItem(SORT_KEY, opt); }

    function getTheme() { return localStorage.getItem(THEME_KEY) || "default"; }
    function setTheme(theme) {
      localStorage.setItem(THEME_KEY, theme);
      const root = document.documentElement;
      if (theme === "default") root.removeAttribute("data-theme");
      else root.setAttribute("data-theme", theme);
    }

    function setViewMode(mode) {
      currentViewMode = mode;
      localStorage.setItem(VIEW_KEY, mode);
      applyViewMode();
    }

    function setTab(tab) {
      currentTab = tab;
      localStorage.setItem(TAB_KEY, tab);
      applyTab();
    }

    function showToast(msg) {
      const toast = document.getElementById("toast");
      if (!toast) return;
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 1800);
    }

    function formatDate(iso) {
      if (!iso) return "-";
      return iso;
    }
    function formatTs(ts) {
      const d = new Date(ts || 0);
      if (isNaN(d.getTime())) return "-";
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return `${y}-${m}-${day} ${hh}:${mm}`;
    }

    /* ---------- ê¶Œí•œ ìœ í‹¸ ---------- */
    function isAdmin(){ return currentMode === "admin"; }
    function isPrinter(){ return currentMode === "printer"; }
    function isViewer(){ return currentMode === "viewer"; }

    function setModePill() {
      const pill = document.getElementById("modePill");
      if (!pill) return;
      if (isAdmin()) pill.textContent = "ê´€ë¦¬ì";
      else if (isPrinter()) pill.textContent = "ì¸ì‡„ê¸°ì‚¬";
      else pill.textContent = "ì¡°íšŒ";
    }

    function applyModeVisibility() {
      // ê³µí†µ
      setModePill();

      const settingsBtn = document.getElementById("settingsBtn");
      const historyBtn = document.getElementById("historyBtn");
      const exportBtn = document.getElementById("exportBtn");
      const importBtn = document.getElementById("importBtn");

      const newFilmBtn = document.getElementById("newFilmBtn");
      const viewToggleBtn = document.getElementById("viewToggleBtn");
      const tabFilmsBtn = document.getElementById("tabFilmsBtn");
      const tabPlatesBtn = document.getElementById("tabPlatesBtn");
      const headerSubtitle = document.getElementById("headerSubtitle");

      // ê´€ë¦¬ì
      if (isAdmin()) {
        settingsBtn.classList.remove("btn-disabled");
        historyBtn.classList.remove("btn-disabled");
        exportBtn.classList.remove("btn-disabled");
        importBtn.classList.remove("btn-disabled");
        settingsBtn.style.display = "inline-block";
        historyBtn.style.display = "inline-block";
        exportBtn.style.display = "inline-block";
        importBtn.style.display = "inline-block";
        newFilmBtn.style.display = "inline-block";
        viewToggleBtn.style.display = "inline-block";
        tabFilmsBtn.style.display = "inline-flex";
        tabPlatesBtn.style.display = "inline-flex";
        headerSubtitle.textContent = (currentTab === "plates") ? "íŒ ê´€ë¦¬" : "í•„ë¦„ ê´€ë¦¬";
        return;
      }

      // ì¸ì‡„ê¸°ì‚¬: í•„ë¦„ ë¦¬ìŠ¤íŠ¸ ì•„ì˜ˆ ì•ˆ ë³´ì„ / íŒë§Œ
      if (isPrinter()) {
        // ìƒë‹¨ ë²„íŠ¼ ì œí•œ
        settingsBtn.style.display = "none";
        historyBtn.style.display = "none"; // ê¸°ì¡´ í•„ë¦„ íˆìŠ¤í† ë¦¬ ìˆ¨ê¹€
        exportBtn.style.display = "none";
        importBtn.style.display = "none";
        newFilmBtn.style.display = "none"; // í•„ë¦„ ë“±ë¡ ë¶ˆê°€
        viewToggleBtn.style.display = "none"; // ê°¤ëŸ¬ë¦¬ ì „í™˜ì€ í•„ë¦„ìš©
        tabFilmsBtn.style.display = "none";
        tabPlatesBtn.style.display = "inline-flex";
        setTab("plates"); // ê°•ì œ
        headerSubtitle.textContent = "íŒ ê´€ë¦¬";
        return;
      }

      // ì¡°íšŒ: í•„ë¦„+íŒ ì¡°íšŒë§Œ / ë“±ë¡/ìˆ˜ì •/ì‚­ì œ/ì‚¬ìš©ë“±ë¡ ë¶ˆê°€
      settingsBtn.style.display = "none"; // ì„¤ì • ì „ì²´ ì ‘ê·¼ ë¶ˆê°€
      historyBtn.style.display = "none";  // ê¸°ì¡´ íˆìŠ¤í† ë¦¬(í•„ë¦„ íˆìŠ¤í† ë¦¬)ë„ ìˆ¨ê¹€
      exportBtn.style.display = "none";
      importBtn.style.display = "none";
      newFilmBtn.style.display = "none";
      viewToggleBtn.style.display = "inline-block"; // ë³´ê¸°ì „í™˜ì€ í—ˆìš©(í•„ë¦„ ì‚¬ì§„ ë³¼ ìˆ˜ë„)
      tabFilmsBtn.style.display = "inline-flex";
      tabPlatesBtn.style.display = "inline-flex";
      headerSubtitle.textContent = (currentTab === "plates") ? "íŒ ì¡°íšŒ" : "í•„ë¦„ ì¡°íšŒ";
    }

    /* ---------- ë¹„ë°€ë²ˆí˜¸(Firestore) ---------- */
    async function loadAuthSettings() {
      try {
        const snap = await db.collection(AUTH_DOC_PATH.col).doc(AUTH_DOC_PATH.doc).get();
        if (snap.exists) {
          const d = snap.data() || {};
          authCache = {
            adminPw: (d.adminPw || DEFAULT_AUTH.adminPw) + "",
            printerPw: (d.printerPw || DEFAULT_AUTH.printerPw) + "",
            viewerPw: (d.viewerPw || DEFAULT_AUTH.viewerPw) + "",
          };
        } else {
          // ìµœì´ˆ 1íšŒ ê¸°ë³¸ê°’ ì €ì¥(ê¶Œí•œ ì²´í¬ ì—†ì´ 1íšŒë§Œ)
          authCache = { ...DEFAULT_AUTH };
          await db.collection(AUTH_DOC_PATH.col).doc(AUTH_DOC_PATH.doc).set(authCache, { merge: true });
        }
      } catch (e) {
        // ì‹¤íŒ¨í•´ë„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë™ì‘
        authCache = { ...DEFAULT_AUTH };
      }
    }

    async function saveAuthSettings(adminPw, printerPw, viewerPw) {
      await db.collection(AUTH_DOC_PATH.col).doc(AUTH_DOC_PATH.doc).set(
        { adminPw, printerPw, viewerPw },
        { merge: true }
      );
      authCache = { adminPw, printerPw, viewerPw };
    }

    function resolveModeByPassword(pw) {
      if (pw === authCache.adminPw) return "admin";
      if (pw === authCache.printerPw) return "printer";
      if (pw === authCache.viewerPw) return "viewer";
      return null;
    }

    /* ---------- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° & íšŒì „ ---------- */
    function resetImagePreview() {
      const wrapper = document.getElementById("imagePreviewWrapper");
      const img = document.getElementById("imagePreview");
      currentSelectedImageDataUrl = null;
      currentImageRotation = 0;
      if (img) {
        img.src = "";
        img.style.transform = "rotate(0deg)";
      }
      if (wrapper) wrapper.style.display = "none";
    }
    function applyPreviewRotation() {
      const img = document.getElementById("imagePreview");
      if (!img) return;
      img.style.transform = "rotate(" + currentImageRotation + "deg)";
    }

    /* ---------- Firestore ì‹¤ì‹œê°„ ë™ê¸°í™” ---------- */
    function startFilmsListener() {
      if (unsubscribeFilms) unsubscribeFilms();
      unsubscribeFilms = db.collection(FILM_COLLECTION).onSnapshot(
        (snapshot) => {
          films = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
          if (!currentSearchText && visibleCount < VISIBLE_STEP) {
            visibleCount = Math.min(VISIBLE_STEP, films.length);
          }
          // í•„ë¦„ ë¦¬ìŠ¤íŠ¸ëŠ” ëª¨ë“œ/íƒ­ì— ë”°ë¼ ë Œë”
          renderList(currentSearchText);
          // íŒ ê²½ê³ (ì›ë³¸í•„ë¦„ì—†ìŒ) ìœ„í•´ íŒë„ ë‹¤ì‹œ ë Œë”
          renderPlateList(currentSearchText);
        },
        (error) => {
          console.error("ì‹¤ì‹œê°„ ë™ê¸°í™” ì˜¤ë¥˜:", error);
          showToast("ì„œë²„ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´.");
        }
      );
    }

    function startPlatesListener() {
      if (unsubscribePlates) unsubscribePlates();
      unsubscribePlates = db.collection(PLATE_COLLECTION).onSnapshot(
        (snapshot) => {
          plates = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
          renderPlateList(currentSearchText);
          // í•„ë¦„ ì¹´ë“œì— íŒ ê°œìˆ˜/ë²„íŠ¼ í‘œì‹œ ìœ„í•´ í•„ë¦„ë„ ë‹¤ì‹œ
          renderList(currentSearchText);
        },
        (error) => {
          console.error("íŒ ë™ê¸°í™” ì˜¤ë¥˜:", error);
          showToast("íŒ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´.");
        }
      );
    }

    /* ---------- íˆìŠ¤í† ë¦¬(ê¸°ì¡´ ìœ ì§€) ---------- */
    async function addHistory(action, film, changes = []) {
      try {
        const entry = {
          action,
          filmId: film.id || null,
          filmNumber: film.filmNumber || "",
          productName: film.productName || "",
          deviceName: getDeviceLabel() || "",
          timestamp: Date.now(),
          changes,
        };
        await db.collection(HISTORY_COLLECTION).add(entry);
        if (historyLoaded) {
          await loadHistory();
        }
      } catch (e) {
        console.error("íˆìŠ¤í† ë¦¬ ê¸°ë¡ ì¤‘ ì˜¤ë¥˜:", e);
      }
    }

    async function loadHistory() {
      try {
        const snap = await db
          .collection(HISTORY_COLLECTION)
          .orderBy("timestamp", "desc")
          .limit(100)
          .get();
        historyEntries = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
        historyLoaded = true;
        renderHistory();
      } catch (e) {
        console.error("íˆìŠ¤í† ë¦¬ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", e);
        showToast("íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´.");
      }
    }

    function actionLabel(action) {
      if (action === "ë“±ë¡") return "í•„ë¦„ ë“±ë¡";
      if (action === "ìˆ˜ì •") return "í•„ë¦„ ìˆ˜ì •";
      if (action === "ì‚­ì œ") return "í•„ë¦„ ì‚­ì œ";
      if (action === "ì˜¤ëŠ˜ ì‚¬ìš©") return "ì˜¤ëŠ˜ ì‚¬ìš© ì²´í¬";
      return action || "ë³€ê²½";
    }

    function renderHistory() {
      const list = document.getElementById("historyList");
      if (!list) return;
      list.innerHTML = "";

      if (!historyEntries.length) {
        const empty = document.createElement("div");
        empty.className = "history-empty";
        empty.innerHTML = "ì•„ì§ ê¸°ë¡ì´ ì—†ì–´.";
        list.appendChild(empty);
        return;
      }

      historyEntries.forEach((entry) => {
        const row = document.createElement("div");
        row.className = "history-row";

        const ts = formatTs(entry.timestamp || 0);
        const device = entry.deviceName || "ê¸°ê¸° ë¯¸ì§€ì •";
        const filmLabel =
          (entry.filmNumber || "") +
          (entry.productName ? ` (${entry.productName})` : "");

        const changesArr = Array.isArray(entry.changes) ? entry.changes : [];
        const noteText = (entry.note || "").trim();

        row.innerHTML =
          `<div class="history-headline">` +
            `<div>` +
              `<span class="history-time">${ts}</span>` +
              `<span class="history-device">${device}</span>` +
              `<span class="history-action-chip">${actionLabel(entry.action)}</span>` +
            `</div>` +
            `<button class="history-pencil" data-id="${entry.id}">âœï¸</button>` +
          `</div>` +
          `<div class="history-film">${filmLabel || "í•„ë¦„ ì •ë³´ ì—†ìŒ"}</div>` +
          (changesArr.length
            ? `<div class="history-changes">ë³€ê²½ í•­ëª©: ${changesArr.join(", ")}</div>`
            : "") +
          (noteText ? `<div class="history-note">${noteText}</div>` : "");

        const pencilBtn = row.querySelector(".history-pencil");
        if (pencilBtn) {
          pencilBtn.addEventListener("click", () => {
            openHistoryNoteModal(entry.id);
          });
        }

        list.appendChild(row);
      });
    }

    function openHistoryCard() {
      const card = document.getElementById("historyCard");
      const isOpen = card.style.display === "block";
      closeAllPanels();
      if (!isOpen) {
        card.style.display = "block";
        if (!historyLoaded) loadHistory();
        else renderHistory();
      }
    }
    function closeHistoryCard() {
      document.getElementById("historyCard").style.display = "none";
    }

    /* ====== í•„ë¦„ ë©”ëª¨(ìŠ¬ë¼ì´ë“œ) ====== */
    function openMemoSheet(filmId) {
      const film = films.find((f) => f.id === filmId);
      if (!film) return;

      currentMemoFilmId = filmId;

      const title = document.getElementById("memoSheetTitle");
      const sub = document.getElementById("memoSheetSub");
      const ta = document.getElementById("memoTextarea");
      const sheet = document.getElementById("memoSheet");

      if (title) title.textContent = `ë©”ëª¨ Â· ${film.filmNumber || ""}`;
      if (sub) sub.textContent = (film.productName || "") ? film.productName : "í•„ë¦„ë³„ ë©”ëª¨";
      if (ta) ta.value = film.memo || "";

      sheet.classList.add("show");
    }

    function closeMemoSheet() {
      const sheet = document.getElementById("memoSheet");
      sheet.classList.remove("show");
      currentMemoFilmId = null;
    }

    async function saveMemoSheet() {
      if (!currentMemoFilmId) return;
      const ta = document.getElementById("memoTextarea");
      const memo = (ta.value || "").trim();

      try {
        await db.collection(FILM_COLLECTION).doc(currentMemoFilmId).set(
          { memo, updatedAt: Date.now() },
          { merge: true }
        );
        showToast("ë©”ëª¨ë¥¼ ì €ì¥í–ˆì–´.");
        closeMemoSheet();
      } catch (e) {
        console.error(e);
        showToast("ë©”ëª¨ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë‚¬ì–´.");
      }
    }

    /* ====== íŒ ë©”ëª¨(ìŠ¬ë¼ì´ë“œ) ====== */
    function openPlateMemoSheet(plateId) {
      const plate = plates.find((p) => p.id === plateId);
      if (!plate) return;

      currentMemoPlateId = plateId;

      const title = document.getElementById("plateMemoSheetTitle");
      const sub = document.getElementById("plateMemoSheetSub");
      const ta = document.getElementById("plateMemoTextarea");
      const sheet = document.getElementById("plateMemoSheet");

      const pn = plate.plateNumber || plate.filmNumber || "";
      if (title) title.textContent = `ë©”ëª¨ Â· ${pn}`;
      if (sub) sub.textContent = plate.productName || "íŒë³„ ë©”ëª¨";
      if (ta) ta.value = plate.memo || "";

      sheet.classList.add("show");
    }
    function closePlateMemoSheet() {
      const sheet = document.getElementById("plateMemoSheet");
      sheet.classList.remove("show");
      currentMemoPlateId = null;
    }
    async function savePlateMemoSheet() {
      if (!currentMemoPlateId) return;
      const ta = document.getElementById("plateMemoTextarea");
      const memo = (ta.value || "").trim();
      try {
        await db.collection(PLATE_COLLECTION).doc(currentMemoPlateId).set(
          { memo, updatedAt: Date.now() },
          { merge: true }
        );
        showToast("íŒ ë©”ëª¨ ì €ì¥ë¨.");
        closePlateMemoSheet();
      } catch (e) {
        console.error(e);
        showToast("íŒ ë©”ëª¨ ì €ì¥ ì¤‘ ì˜¤ë¥˜.");
      }
    }

    /* ====== íŒ ì‚¬ìš©/íˆìŠ¤í† ë¦¬ ====== */
    function fillPrinterSelectFromRequestList() {
      const src = document.getElementById("requestPrinter");
      const dst = document.getElementById("plateUsePrinterSelect");
      if (!src || !dst) return;
      dst.innerHTML = "";
      for (const opt of Array.from(src.options)) {
        const o = document.createElement("option");
        o.value = opt.value;
        o.textContent = opt.textContent;
        dst.appendChild(o);
      }
    }

    function openPlateUseSheet(plateId) {
      const plate = plates.find((p) => p.id === plateId);
      if (!plate) return;

      currentUsePlateId = plateId;
      fillPrinterSelectFromRequestList();

      const title = document.getElementById("plateUseSheetTitle");
      const sub = document.getElementById("plateUseSheetSub");
      const qty = document.getElementById("plateUseQty");
      const memo = document.getElementById("plateUseMemo");
      const sheet = document.getElementById("plateUseSheet");

      if (title) title.textContent = `íŒ ì‚¬ìš©ë“±ë¡ Â· ${plate.plateNumber || plate.filmNumber || ""}`;
      if (sub) sub.textContent = plate.productName || "íŒ ì‚¬ìš©ë“±ë¡";
      if (qty) qty.value = "";
      if (memo) memo.value = "";

      sheet.classList.add("show");
    }
    function closePlateUseSheet() {
      const sheet = document.getElementById("plateUseSheet");
      sheet.classList.remove("show");
      currentUsePlateId = null;
    }

    async function savePlateUseSheet() {
      if (!currentUsePlateId) return;
      const plate = plates.find((p) => p.id === currentUsePlateId);
      if (!plate) return;

      const who = (document.getElementById("plateUsePrinterSelect").value || "").trim();
      const qtyRaw = document.getElementById("plateUseQty").value;
      const qty = Math.max(0, parseInt(qtyRaw || "0", 10) || 0);
      const memo = (document.getElementById("plateUseMemo").value || "").trim();

      const ts = Date.now();

      try {
        // usage ê¸°ë¡ ì¶”ê°€
        await db.collection(PLATE_COLLECTION).doc(currentUsePlateId)
          .collection("usage")
          .add({
            who,
            qty,
            memo,
            timestamp: ts,
            deviceName: getDeviceLabel() || "",
          });

        // plates ë¬¸ì„œì— ë§ˆì§€ë§‰ ì‚¬ìš© ìš”ì•½ + ëˆ„ì  ì‚¬ìš©ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸
        const prevTotal = parseInt(plate.totalUsedQty || "0", 10) || 0;
        const nextTotal = prevTotal + qty;

        await db.collection(PLATE_COLLECTION).doc(currentUsePlateId).set({
          lastUsedAt: ts,
          lastUsedWho: who,
          lastUsedQty: qty,
          lastUsedMemo: memo,
          totalUsedQty: nextTotal,
          updatedAt: Date.now(),
        }, { merge: true });

        showToast("ì‚¬ìš© ê¸°ë¡ ì €ì¥ë¨.");
        closePlateUseSheet();
      } catch (e) {
        console.error(e);
        showToast("ì‚¬ìš© ê¸°ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜.");
      }
    }

    function openPlateHistorySheet(plateId) {
      const plate = plates.find((p) => p.id === plateId);
      if (!plate) return;
      currentPlateHistoryId = plateId;

      const title = document.getElementById("plateHistorySheetTitle");
      const sub = document.getElementById("plateHistorySheetSub");
      const sheet = document.getElementById("plateHistorySheet");

      if (title) title.textContent = `íŒ íˆìŠ¤í† ë¦¬ Â· ${plate.plateNumber || plate.filmNumber || ""}`;
      if (sub) sub.textContent = plate.productName || "íŒ íˆìŠ¤í† ë¦¬";

      sheet.classList.add("show");
      loadPlateUsageHistory(plateId);
    }
    function closePlateHistorySheet() {
      const sheet = document.getElementById("plateHistorySheet");
      sheet.classList.remove("show");
      currentPlateHistoryId = null;
    }

    async function loadPlateUsageHistory(plateId) {
      const list = document.getElementById("plateHistoryList");
      if (!list) return;
      list.innerHTML = "";

      try {
        const snap = await db.collection(PLATE_COLLECTION).doc(plateId)
          .collection("usage")
          .orderBy("timestamp", "desc")
          .limit(100)
          .get();

        if (snap.empty) {
          const empty = document.createElement("div");
          empty.className = "history-empty";
          empty.textContent = "ì•„ì§ ì‚¬ìš© ê¸°ë¡ì´ ì—†ì–´.";
          list.appendChild(empty);
          return;
        }

        snap.docs.forEach((d) => {
          const u = d.data() || {};
          const row = document.createElement("div");
          row.className = "history-row";
          const ts = formatTs(u.timestamp || 0);
          const who = (u.who || ""); 
          const qty = (u.qty ?? "-");
          const memo = (u.memo || "").trim();

          row.innerHTML =
            `<div class="history-headline">` +
              `<div>` +
                `<span class="history-time">${ts}</span>` +
                (u.deviceName ? `<span class="history-device">${u.deviceName}</span>` : "") +
                `<span class="history-action-chip">ì‚¬ìš©</span>` +
              `</div>` +
            `</div>` +
            `<div class="history-film">${who ? who : "ì´ë¦„ ë¯¸ì§€ì •"} Â· ${qty}ê°œ</div>` +
            (memo ? `<div class="history-note" style="-webkit-line-clamp:3;">${memo}</div>` : "");

          list.appendChild(row);
        });

      } catch (e) {
        console.error(e);
        const empty = document.createElement("div");
        empty.className = "history-empty";
        empty.textContent = "ì‚¬ìš© ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´.";
        list.appendChild(empty);
      }
    }

    /* ====== íˆìŠ¤í† ë¦¬ ë©”ëª¨(ëª¨ë‹¬) ====== */
    function openHistoryNoteModal(historyId) {
      const entry = historyEntries.find((h) => h.id === historyId);
      if (!entry) return;

      currentHistoryNoteId = historyId;

      const modal = document.getElementById("historyNoteModal");
      const ta = document.getElementById("historyNoteTextarea");
      if (ta) ta.value = entry.note || "";

      modal.classList.add("show");
    }

    function closeHistoryNoteModal() {
      const modal = document.getElementById("historyNoteModal");
      modal.classList.remove("show");
      currentHistoryNoteId = null;
    }

    async function saveHistoryNoteModal() {
      if (!currentHistoryNoteId) return;
      const ta = document.getElementById("historyNoteTextarea");
      const note = (ta.value || "").trim();

      try {
        await db.collection(HISTORY_COLLECTION).doc(currentHistoryNoteId).set(
          { note },
          { merge: true }
        );

        const idx = historyEntries.findIndex((h) => h.id === currentHistoryNoteId);
        if (idx >= 0) historyEntries[idx].note = note;

        renderHistory();
        showToast("íˆìŠ¤í† ë¦¬ ë©”ëª¨ ì €ì¥ë¨.");
        closeHistoryNoteModal();
      } catch (e) {
        console.error(e);
        showToast("íˆìŠ¤í† ë¦¬ ë©”ëª¨ ì €ì¥ ì¤‘ ì˜¤ë¥˜.");
      }
    }

    /* ---------- ì œíŒ ë°©ë²• í† ê¸€ ---------- */
    function clearPlateInfoForm() {
      document.querySelectorAll(".toggle-btn").forEach((btn) => btn.classList.remove("active"));
    }

    function setPlateInfoToForm(str) {
      clearPlateInfoForm();
      if (!str) return;
      const parts = str.split(" ");
      document.querySelectorAll(".toggle-btn").forEach((btn) => {
        if (parts.includes(btn.dataset.value)) btn.classList.add("active");
      });
    }

    function getPlateInfoFromForm() {
      const groups = document.querySelectorAll(".toggle-group");
      const values = [];
      groups.forEach((group) => {
        const active = group.querySelector(".toggle-btn.active");
        if (active) values.push(active.dataset.value);
      });
      return values.join(" ");
    }

    /* ---------- íŒ¨ë„ ê³µí†µ ---------- */
    function closeAllPanels() {
      document.getElementById("settingsCard").style.display = "none";
      document.getElementById("historyCard").style.display = "none";
      document.getElementById("formCard").style.display = "none";
      document.getElementById("plateFormCard").classList.add("section-hidden");
    }

    /* ---------- ë·° ëª¨ë“œ ---------- */
    function applyViewMode() {
      const list = document.getElementById("list");
      const btn = document.getElementById("viewToggleBtn");
      if (!list || !btn) return;

      // íŒ íƒ­ì—ì„œëŠ” ê°¤ëŸ¬ë¦¬ í† ê¸€ ì˜ë¯¸ ì—†ì–´ì„œ ìˆ¨ê¹€(ê´€ë¦¬ì/ì¡°íšŒì—ì„œë§Œ)
      if (currentTab === "plates") {
        btn.classList.add("btn-disabled");
        return;
      } else {
        btn.classList.remove("btn-disabled");
      }

      if (currentViewMode === "gallery") {
        list.classList.add("gallery");
        btn.textContent = "ë¦¬ìŠ¤íŠ¸";
      } else {
        list.classList.remove("gallery");
        btn.textContent = "ê°¤ëŸ¬ë¦¬";
      }
    }

    /* ---------- íƒ­ ì ìš© ---------- */
    function applyTab() {
      const tabFilmsBtn = document.getElementById("tabFilmsBtn");
      const tabPlatesBtn = document.getElementById("tabPlatesBtn");
      const list = document.getElementById("list");
      const plateList = document.getElementById("plateList");
      const emptyText = document.getElementById("emptyText");
      const plateEmptyText = document.getElementById("plateEmptyText");
      const headerSubtitle = document.getElementById("headerSubtitle");

      if (!tabFilmsBtn || !tabPlatesBtn) return;

      tabFilmsBtn.classList.toggle("active", currentTab === "films");
      tabPlatesBtn.classList.toggle("active", currentTab === "plates");

      if (currentTab === "films") {
        list.classList.remove("section-hidden");
        emptyText.classList.remove("section-hidden");
        plateList.classList.add("section-hidden");
        plateEmptyText.classList.add("section-hidden");
        headerSubtitle.textContent = isViewer() ? "í•„ë¦„ ì¡°íšŒ" : "í•„ë¦„ ê´€ë¦¬";
        renderList(currentSearchText);
      } else {
        list.classList.add("section-hidden");
        emptyText.classList.add("section-hidden");
        plateList.classList.remove("section-hidden");
        plateEmptyText.classList.remove("section-hidden");
        headerSubtitle.textContent = isViewer() ? "íŒ ì¡°íšŒ" : "íŒ ê´€ë¦¬";
        renderPlateList(currentSearchText);
      }

      applyViewMode();
      applyModeVisibility();
    }

    /* ---------- ì´ë¯¸ì§€ ì••ì¶• (íšŒì „ í¬í•¨) ---------- */
    function compressImage(dataUrl, rotationDeg, callback) {
      const img = new Image();
      img.onload = function () {
        const maxSize = 700;
        let w = img.width;
        let h = img.height;
        const ratio = Math.min(maxSize / w, maxSize / h, 1);
        let drawW = Math.round(w * ratio);
        let drawH = Math.round(h * ratio);

        const rot = ((rotationDeg % 360) + 360) % 360;
        let canvasW = drawW;
        let canvasH = drawH;
        if (rot === 90 || rot === 270) {
          canvasW = drawH;
          canvasH = drawW;
        }

        const canvas = document.createElement("canvas");
        canvas.width = canvasW;
        canvas.height = canvasH;
        const ctx = canvas.getContext("2d");

        ctx.translate(canvasW / 2, canvasH / 2);
        ctx.rotate((rot * Math.PI) / 180);
        ctx.drawImage(img, -drawW / 2, -drawH / 2, drawW, drawH);

        const compressed = canvas.toDataURL("image/jpeg", 0.7);
        callback(compressed);
      };
      img.onerror = function () { callback(dataUrl); };
      img.src = dataUrl;
    }

    /* ---------- ì´ë¯¸ì§€ ë·°ì–´ (í•€ì¹˜ ì¤Œ + ìŠ¤ì™€ì´í”„ ë‹¤ìš´ ë‹«ê¸°) ---------- */
    let viewerScale = 1;
    let viewerStartDist = 0;
    let viewerLastScale = 1;
    let viewerTransX = 0;
    let viewerTransY = 0;
    let panStartX = 0;
    let panStartY = 0;
    let isPanning = false;
    let swipeStartY = 0;
    let swipeDeltaY = 0;

    function resetViewerTransform() {
      viewerScale = 1;
      viewerTransX = 0;
      viewerTransY = 0;
      viewerStartDist = 0;
      viewerLastScale = 1;
      isPanning = false;
      swipeStartY = 0;
      swipeDeltaY = 0;
      const img = document.getElementById("viewerImage");
      img.style.transform = "translate(0px, 0px) scale(1)";
    }
    function updateViewerTransform() {
      const img = document.getElementById("viewerImage");
      img.style.transform = "translate(" + viewerTransX + "px, " + viewerTransY + "px) scale(" + viewerScale + ")";
    }
    function openImageViewer(src) {
      if (!src) return;
      const viewer = document.getElementById("imageViewer");
      const img = document.getElementById("viewerImage");
      img.src = src;
      resetViewerTransform();
      viewer.style.display = "flex";
    }
    function closeImageViewer() {
      const viewer = document.getElementById("imageViewer");
      viewer.style.display = "none";
    }
    function initImageViewerTouch() {
      const img = document.getElementById("viewerImage");
      const backdrop = document.getElementById("viewerBackdrop");

      backdrop.addEventListener("click", () => closeImageViewer());

      img.addEventListener("touchstart", (e) => {
        if (e.touches.length === 2) {
          e.preventDefault();
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          viewerStartDist = Math.sqrt(dx*dx + dy*dy);
          viewerLastScale = viewerScale;
        } else if (e.touches.length === 1) {
          swipeStartY = e.touches[0].clientY;
          swipeDeltaY = 0;
          if (viewerScale > 1) {
            isPanning = true;
            panStartX = e.touches[0].clientX - viewerTransX;
            panStartY = e.touches[0].clientY - viewerTransY;
          }
        }
      }, { passive: false });

      img.addEventListener("touchmove", (e) => {
        if (e.touches.length === 2) {
          e.preventDefault();
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          const dist = Math.sqrt(dx*dx + dy*dy);
          if (viewerStartDist > 0) {
            let scale = viewerLastScale * (dist / viewerStartDist);
            if (scale < 1) scale = 1;
            if (scale > 4) scale = 4;
            viewerScale = scale;
            updateViewerTransform();
          }
        } else if (e.touches.length === 1) {
          e.preventDefault();
          const touch = e.touches[0];
          swipeDeltaY = touch.clientY - swipeStartY;

          if (viewerScale > 1 && isPanning) {
            viewerTransX = touch.clientX - panStartX;
            viewerTransY = touch.clientY - panStartY;
            updateViewerTransform();
          }
        }
      }, { passive: false });

      img.addEventListener("touchend", (e) => {
        if (e.touches.length < 2) {
          viewerStartDist = 0;
          viewerLastScale = viewerScale;
        }
        if (e.touches.length === 0) {
          isPanning = false;
          if (swipeDeltaY > 80 && Math.abs(swipeDeltaY) > 40) closeImageViewer();
          swipeStartY = 0;
          swipeDeltaY = 0;
        }
      });
    }
    <!-- =========================
PART 2/2  (/* ---------- ìŠ¤í¬ë¡¤ ê´€ë ¨ (ë¬´í•œ ìŠ¤í¬ë¡¤ + ë§¨ ìœ„ë¡œ ë²„íŠ¼) ---------- */ ë¶€í„° ëê¹Œì§€)
â€» PART1 ë§¨ ì•„ë˜ì— ì´ PART2ë¥¼ ê·¸ëŒ€ë¡œ ì´ì–´ë¶™ì´ë©´ 1ê°œì˜ ì™„ì„± HTMLì´ ë¨
========================= -->

    /* ---------- ìŠ¤í¬ë¡¤ ê´€ë ¨ (ë¬´í•œ ìŠ¤í¬ë¡¤ + ë§¨ ìœ„ë¡œ ë²„íŠ¼) ---------- */
    const PLATE_VISIBLE_STEP = 40;
    let plateVisibleCount = PLATE_VISIBLE_STEP;

    function initScrollHandlers() {
      const scrollTopBtn = document.getElementById("scrollTopBtn");
      const spinner = document.getElementById("loadingSpinner");

      window.addEventListener("scroll", () => {
        const scrollY = window.scrollY || window.pageYOffset;
        const vh = window.innerHeight || document.documentElement.clientHeight;
        const fullHeight = document.documentElement.scrollHeight;

        if (scrollY > 200) scrollTopBtn.classList.add("show");
        else scrollTopBtn.classList.remove("show");

        if (currentSearchText || loadingMore) return;

        // íƒ­ë³„ ë¬´í•œìŠ¤í¬ë¡¤
        if (currentTab === "films") {
          if (visibleCount >= films.length) return;
        } else {
          if (plateVisibleCount >= plates.length) return;
        }

        if (scrollY + vh >= fullHeight - 90) {
          loadingMore = true;
          spinner.classList.add("show");
          setTimeout(() => {
            if (currentTab === "films") {
              visibleCount = Math.min(visibleCount + VISIBLE_STEP, films.length);
              renderList(currentSearchText);
            } else {
              plateVisibleCount = Math.min(plateVisibleCount + PLATE_VISIBLE_STEP, plates.length);
              renderPlateList(currentSearchText);
            }
            spinner.classList.remove("show");
            loadingMore = false;
          }, 380);
        }
      });

      scrollTopBtn.addEventListener("click", () => {
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    }

    /* ---------- í”„ë¦°í„°(ì¸ì‡„ê¸°ì‚¬) ì´ë¦„ ëª©ë¡: Firestore ê³µìœ  ---------- */
    const PRINTERS_DOC_PATH = { col: "appSettings", doc: "printers" };
    let printerNamesCache = [];

    function sanitizeName(s) {
      return (s || "").replace(/\s+/g, " ").trim();
    }

    async function loadPrinterNames() {
      try {
        const snap = await db.collection(PRINTERS_DOC_PATH.col).doc(PRINTERS_DOC_PATH.doc).get();
        if (snap.exists) {
          const d = snap.data() || {};
          printerNamesCache = Array.isArray(d.names) ? d.names.map(sanitizeName).filter(Boolean) : [];
        } else {
          printerNamesCache = [];
          await db.collection(PRINTERS_DOC_PATH.col).doc(PRINTERS_DOC_PATH.doc).set({ names: [] }, { merge: true });
        }
      } catch (e) {
        printerNamesCache = [];
      }
      rebuildRequestPrinterSelect();
      // íŒ ì‚¬ìš©ë“±ë¡ selectë„ ìµœì‹ í™”
      fillPrinterSelectFromRequestList();
      // ì„¤ì • UI ë¦¬ìŠ¤íŠ¸ë„ ê°±ì‹ 
      renderPrinterManagerUI();
    }

    async function savePrinterNames(names) {
      const cleaned = (names || []).map(sanitizeName).filter(Boolean);
      // ì¤‘ë³µ ì œê±°
      const uniq = [];
      cleaned.forEach((n) => { if (!uniq.includes(n)) uniq.push(n); });

      await db.collection(PRINTERS_DOC_PATH.col).doc(PRINTERS_DOC_PATH.doc).set(
        { names: uniq, updatedAt: Date.now() },
        { merge: true }
      );
      printerNamesCache = uniq;
      rebuildRequestPrinterSelect();
      fillPrinterSelectFromRequestList();
      renderPrinterManagerUI();
    }

    function rebuildRequestPrinterSelect() {
      const sel = document.getElementById("requestPrinter");
      if (!sel) return;

      const current = sel.value || "";
      sel.innerHTML = "";

      const baseOpt = document.createElement("option");
      baseOpt.value = "";
      baseOpt.textContent = "ì„ íƒ ì•ˆ í•¨";
      sel.appendChild(baseOpt);

      (printerNamesCache || []).forEach((name) => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        sel.appendChild(opt);
      });

      // ê¸°ì¡´ ì„ íƒê°’ ìœ ì§€ ì‹œë„
      sel.value = current;
      if (sel.value !== current) sel.value = "";
    }

    function renderPrinterManagerUI() {
      const box = document.getElementById("printerManagerBox");
      const list = document.getElementById("printerManagerList");
      if (!box || !list) return;

      // ê´€ë¦¬ìë§Œ ë³´ì´ê²Œ
      box.style.display = isAdmin() ? "block" : "none";

      list.innerHTML = "";
      const names = printerNamesCache || [];
      if (!names.length) {
        const empty = document.createElement("div");
        empty.className = "history-empty";
        empty.textContent = "ì•„ì§ ëª©ë¡ì´ ì—†ì–´. ì•„ë˜ì—ì„œ ì¶”ê°€í•´ ì¤˜.";
        list.appendChild(empty);
        return;
      }

      names.forEach((name) => {
        const row = document.createElement("div");
        row.style.display = "flex";
        row.style.alignItems = "center";
        row.style.justifyContent = "space-between";
        row.style.gap = "8px";
        row.style.padding = "6px 2px";

        const left = document.createElement("div");
        left.style.fontSize = "13px";
        left.style.color = "var(--text-main)";
        left.textContent = name;

        const del = document.createElement("button");
        del.className = "btn btn-danger btn-small";
        del.textContent = "ì‚­ì œ";
        del.addEventListener("click", async () => {
          const next = (printerNamesCache || []).filter((n) => n !== name);
          try {
            await savePrinterNames(next);
            showToast("ëª©ë¡ì—ì„œ ì‚­ì œí–ˆì–´.");
          } catch (e) {
            console.error(e);
            showToast("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë‚¬ì–´.");
          }
        });

        row.appendChild(left);
        row.appendChild(del);
        list.appendChild(row);
      });
    }

    /* ---------- ì„¤ì • ---------- */
    function openSettings() {
      if (!isAdmin()) return; // ê´€ë¦¬ìë§Œ
      const card = document.getElementById("settingsCard");
      const isOpen = card.style.display === "block";
      closeAllPanels();
      if (!isOpen) {
        card.style.display = "block";

        // UI ê°’ ì±„ìš°ê¸°
        const deviceNameInput = document.getElementById("deviceNameInput");
        const sortSelect = document.getElementById("sortOptionSelect");
        const themeSelect = document.getElementById("themeSelect");

        if (deviceNameInput) deviceNameInput.value = getDeviceLabel() || "";
        if (sortSelect) sortSelect.value = getSortOption();
        if (themeSelect) themeSelect.value = getTheme();

        // ë¹„ë²ˆ ì…ë ¥(í˜„ì¬ê°’ì„ ë³´ì—¬ì£¼ì§„ ì•ŠìŒ â€” placeholderë§Œ)
        document.getElementById("adminPwInput").value = "";
        document.getElementById("printerPwInput").value = "";
        document.getElementById("viewerPwInput").value = "";

        renderPrinterManagerUI();
      }
    }
    function closeSettings() {
      document.getElementById("settingsCard").style.display = "none";
    }

    async function saveSettings() {
      if (!isAdmin()) return;

      const deviceName = (document.getElementById("deviceNameInput").value || "").trim();
      const sortOpt = document.getElementById("sortOptionSelect").value || "updated";
      const theme = document.getElementById("themeSelect").value || "default";

      setDeviceLabel(deviceName);
      setSortOption(sortOpt);
      setTheme(theme);

      // ë¹„ë²ˆ ë³€ê²½(ê´€ë¦¬ìë§Œ ê°€ëŠ¥): ë¹ˆì¹¸ì´ë©´ ê¸°ì¡´ ìœ ì§€
      const adminPw = (document.getElementById("adminPwInput").value || "").trim();
      const printerPw = (document.getElementById("printerPwInput").value || "").trim();
      const viewerPw = (document.getElementById("viewerPwInput").value || "").trim();

      try {
        const next = {
          adminPw: adminPw || authCache.adminPw,
          printerPw: printerPw || authCache.printerPw,
          viewerPw: viewerPw || authCache.viewerPw,
        };
        // ê°’ì´ í•˜ë‚˜ë¼ë„ ë°”ë€Œë©´ ì €ì¥
        const changed =
          next.adminPw !== authCache.adminPw ||
          next.printerPw !== authCache.printerPw ||
          next.viewerPw !== authCache.viewerPw;

        if (changed) {
          await saveAuthSettings(next.adminPw, next.printerPw, next.viewerPw);
          showToast("ì„¤ì • ì €ì¥ + ë¹„ë°€ë²ˆí˜¸ ë°˜ì˜ë¨.");
        } else {
          showToast("ì„¤ì •ì„ ì €ì¥í–ˆì–´.");
        }

        closeSettings();
        // ì •ë ¬/í…Œë§ˆ ì ìš©
        renderList(currentSearchText);
        renderPlateList(currentSearchText);
      } catch (e) {
        console.error(e);
        showToast("ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë‚¬ì–´.");
      }
    }

    /* ---------- í•„ë¦„ í¼ ì—´ê¸°/ë‹«ê¸° ---------- */
    function toggleFormNew() {
      if (!isAdmin()) return;
      closeAllPanels();
      resetImagePreview();

      document.getElementById("filmId").value = "";
      document.getElementById("productName").value = "";
      document.getElementById("filmNumber").value = "";
      document.getElementById("method").value = "";
      document.getElementById("mesh").value = "";
      document.getElementById("location").value = "";
      document.getElementById("requestPrinter").value = "";
      document.getElementById("lastUsed").value = "";
      clearPlateInfoForm();

      document.getElementById("formCard").style.display = "block";
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function openFormEdit(filmId) {
      if (!isAdmin()) return;
      const film = films.find((f) => f.id === filmId);
      if (!film) return;

      closeAllPanels();
      resetImagePreview();

      document.getElementById("filmId").value = film.id || "";
      document.getElementById("productName").value = film.productName || "";
      document.getElementById("filmNumber").value = film.filmNumber || "";
      document.getElementById("method").value = film.method || "";
      document.getElementById("mesh").value = film.mesh || "";
      document.getElementById("location").value = film.location || "";
      document.getElementById("requestPrinter").value = film.requestPrinter || "";
      document.getElementById("lastUsed").value = film.lastUsed || "";
      setPlateInfoToForm(film.plateInfo || "");

      // ê¸°ì¡´ ì´ë¯¸ì§€ê°€ ìˆì–´ë„ "ìˆ˜ì • ì‹œ ì‚¬ì§„ ë°”ê¾¸ê³  ì‹¶ì„ ë•Œë§Œ" ê·œì¹™ ìœ ì§€ -> ë¯¸ë¦¬ë³´ê¸°ëŠ” ì•ˆ ë„ì›€
      document.getElementById("formCard").style.display = "block";
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function closeForm() {
      document.getElementById("formCard").style.display = "none";
      resetImagePreview();
    }

    /* ---------- í•„ë¦„ ì €ì¥/ì‚­ì œ ---------- */
    async function saveFilmFromForm(e) {
      if (e && typeof e.preventDefault === "function") e.preventDefault();
      if (!isAdmin()) return;

      const id = document.getElementById("filmId").value || "";
      const productName = (document.getElementById("productName").value || "").trim();
      const filmNumber = (document.getElementById("filmNumber").value || "").trim();
      const method = (document.getElementById("method").value || "").trim();
      const mesh = (document.getElementById("mesh").value || "").trim();
      const plateInfo = getPlateInfoFromForm();
      const location = (document.getElementById("location").value || "").trim();
      const requestPrinter = (document.getElementById("requestPrinter").value || "").trim();
      const lastUsed = document.getElementById("lastUsed").value || "";

      if (!productName || !filmNumber) {
        showToast("ì œí’ˆ ì´ë¦„ê³¼ í•„ë¦„ ë²ˆí˜¸ëŠ” í•„ìˆ˜ì•¼.");
        return;
      }

      const base = {
        productName,
        filmNumber,
        method,
        mesh,
        plateInfo,
        location,
        requestPrinter,
        lastUsed,
        updatedAt: Date.now(),
      };

      // ì‚¬ì§„ ì²˜ë¦¬: ìƒˆë¡œ ì„ íƒí•œ ê²½ìš°ì—ë§Œ ì—…ë¡œë“œ(ë°ì´í„°URL ì €ì¥)
      const doSave = async (imageDataUrlFinal) => {
        try {
          if (imageDataUrlFinal) base.imageDataUrl = imageDataUrlFinal;

          if (!id) {
            base.createdAt = Date.now();
            const ref = await db.collection(FILM_COLLECTION).add(base);
            await addHistory("ë“±ë¡", { id: ref.id, ...base }, ["ë“±ë¡"]);
            showToast("ìƒˆ í•„ë¦„ ì €ì¥ ì™„ë£Œ!");
          } else {
            // ë³€ê²½í•­ëª© ê³„ì‚°(ëŒ€ì¶©ì´ë¼ë„)
            const prev = films.find((f) => f.id === id) || {};
            const changes = [];
            ["productName","filmNumber","method","mesh","plateInfo","location","requestPrinter","lastUsed"].forEach((k)=>{
              const pv = (prev[k] ?? "") + "";
              const nv = (base[k] ?? "") + "";
              if (pv !== nv) changes.push(k);
            });
            if (imageDataUrlFinal) changes.push("image");
            await db.collection(FILM_COLLECTION).doc(id).set(base, { merge: true });
            await addHistory("ìˆ˜ì •", { id, ...base }, changes);
            showToast("ìˆ˜ì • ì €ì¥ ì™„ë£Œ!");
          }

          closeForm();
        } catch (err) {
          console.error(err);
          showToast("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë‚¬ì–´.");
        }
      };

      if (currentSelectedImageDataUrl) {
        compressImage(currentSelectedImageDataUrl, currentImageRotation, (compressedUrl) => {
          doSave(compressedUrl);
        });
      } else {
        doSave(null);
      }
    }

    async function deleteFilm(filmId) {
      if (!isAdmin()) return;
      const film = films.find((f) => f.id === filmId);
      if (!film) return;
      if (!confirm(`ì •ë§ ì‚­ì œí• ê¹Œ?\n${film.filmNumber || ""} (${film.productName || ""})`)) return;

      try {
        await db.collection(FILM_COLLECTION).doc(filmId).delete();
        await addHistory("ì‚­ì œ", { id: filmId, ...film }, ["ì‚­ì œ"]);
        showToast("ì‚­ì œí–ˆì–´.");

        // ì´ í•„ë¦„ì— ì—°ê²°ëœ íŒë„ ê°™ì´ ì‚­ì œ(ì •í•©ì„±)
        const qs = await db.collection(PLATE_COLLECTION).where("filmId", "==", filmId).get();
        const batch = db.batch();
        qs.docs.forEach((d) => batch.delete(d.ref));
        if (!qs.empty) await batch.commit();

      } catch (e) {
        console.error(e);
        showToast("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë‚¬ì–´.");
      }
    }

    async function setFilmTodayUsed(filmId) {
      if (!isAdmin()) return;
      const today = new Date().toISOString().slice(0, 10);
      try {
        await db.collection(FILM_COLLECTION).doc(filmId).set(
          { lastUsed: today, updatedAt: Date.now() },
          { merge: true }
        );
        const film = films.find((f) => f.id === filmId) || { id: filmId };
        await addHistory("ì˜¤ëŠ˜ ì‚¬ìš©", { id: filmId, ...film, lastUsed: today }, ["lastUsed"]);
        showToast("ì˜¤ëŠ˜ ì‚¬ìš©ìœ¼ë¡œ ê¸°ë¡í–ˆì–´.");
      } catch (e) {
        console.error(e);
        showToast("ê¸°ë¡ ì¤‘ ì˜¤ë¥˜.");
      }
    }

    /* ---------- íŒ í¼(ë“±ë¡/ìˆ˜ì •) ---------- */
    function openPlateFormNewFromFilm(filmId) {
      if (!isAdmin()) return;
      const film = films.find((f) => f.id === filmId);
      if (!film) return;

      closeAllPanels();

      document.getElementById("plateId").value = "";
      document.getElementById("plateFilmId").value = filmId;

      document.getElementById("plateProductName").value = film.productName || "";
      document.getElementById("plateFilmNumber").value = film.filmNumber || "";

      // ìë™ ë„˜ë²„ë§: ê°™ì€ filmId íŒ ê°œìˆ˜+1
      const same = (plates || []).filter((p) => p.filmId === filmId);
      const nextNo = same.length + 1;
      document.getElementById("plateNumber").value = `${film.filmNumber || ""}-${nextNo}`;
      document.getElementById("plateTension").value = "";
      document.getElementById("plateLocation").value = "";
      document.getElementById("plateMesh").value = film.mesh || "";
      document.getElementById("plateMaxQty").value = 5000;

      document.getElementById("plateFormCard").classList.remove("section-hidden");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function openPlateFormEdit(plateId) {
      if (!isAdmin()) return;
      const plate = plates.find((p) => p.id === plateId);
      if (!plate) return;

      closeAllPanels();

      document.getElementById("plateId").value = plate.id || "";
      document.getElementById("plateFilmId").value = plate.filmId || "";

      document.getElementById("plateProductName").value = plate.productName || "";
      document.getElementById("plateFilmNumber").value = plate.filmNumber || "";
      document.getElementById("plateNumber").value = plate.plateNumber || "";
      document.getElementById("plateTension").value = plate.tension || "";
      document.getElementById("plateLocation").value = plate.location || "";
      document.getElementById("plateMesh").value = plate.mesh || "";
      document.getElementById("plateMaxQty").value = (plate.maxQty ?? 5000);

      document.getElementById("plateFormCard").classList.remove("section-hidden");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function closePlateForm() {
      document.getElementById("plateFormCard").classList.add("section-hidden");
    }

    async function savePlateFromForm(e) {
      if (e && typeof e.preventDefault === "function") e.preventDefault();
      if (!isAdmin()) return;

      const id = document.getElementById("plateId").value || "";
      const filmId = document.getElementById("plateFilmId").value || "";

      const productName = (document.getElementById("plateProductName").value || "").trim();
      const filmNumber = (document.getElementById("plateFilmNumber").value || "").trim();

      const plateNumber = (document.getElementById("plateNumber").value || "").trim();
      const tension = (document.getElementById("plateTension").value || "").trim();
      const location = (document.getElementById("plateLocation").value || "").trim();
      const mesh = (document.getElementById("plateMesh").value || "").trim();
      const maxQty = Math.max(0, parseInt(document.getElementById("plateMaxQty").value || "0", 10) || 0);

      if (!filmId) {
        showToast("í•„ë¦„ ì—°ê²° ì •ë³´ê°€ ì—†ì–´. (filmId)");
        return;
      }
      if (!plateNumber) {
        showToast("íŒ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì¤˜.");
        return;
      }

      const base = {
        filmId,
        productName,
        filmNumber,
        plateNumber,
        tension,
        location,
        mesh,
        maxQty: maxQty || 5000,
        updatedAt: Date.now(),
      };

      try {
        if (!id) {
          base.createdAt = Date.now();
          base.totalUsedQty = 0;
          await db.collection(PLATE_COLLECTION).add(base);
          showToast("íŒì„ ë“±ë¡í–ˆì–´.");
        } else {
          await db.collection(PLATE_COLLECTION).doc(id).set(base, { merge: true });
          showToast("íŒ ìˆ˜ì • ì €ì¥ë¨.");
        }
        closePlateForm();
      } catch (e) {
        console.error(e);
        showToast("íŒ ì €ì¥ ì¤‘ ì˜¤ë¥˜.");
      }
    }

    async function deletePlate(plateId) {
      if (!isAdmin()) return;
      const plate = plates.find((p) => p.id === plateId);
      if (!plate) return;
      if (!confirm(`íŒì„ ì‚­ì œí• ê¹Œ?\n${plate.plateNumber || ""}`)) return;

      try {
        // usage ì„œë¸Œì»¬ë ‰ì…˜ë„ ì‚­ì œ(ìµœì†Œí•œ ë¬¸ì„œ ì‚­ì œ)
        const usageSnap = await db.collection(PLATE_COLLECTION).doc(plateId).collection("usage").get();
        const batch = db.batch();
        usageSnap.docs.forEach((d) => batch.delete(d.ref));
        batch.delete(db.collection(PLATE_COLLECTION).doc(plateId));
        await batch.commit();
        showToast("íŒ ì‚­ì œ ì™„ë£Œ.");
      } catch (e) {
        console.error(e);
        showToast("íŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜.");
      }
    }

    /* ---------- ë¦¬ìŠ¤íŠ¸/ì •ë ¬/í•„í„° ---------- */
    function normalize(s){ return (s || "").toString().toLowerCase(); }

    function filmMatchesSearch(f, q) {
      if (!q) return true;
      const t = normalize(q);
      const pool = [
        f.productName, f.filmNumber, f.method, f.location, f.plateInfo, f.mesh, f.requestPrinter, f.memo
      ].map(normalize).join(" ");
      return pool.includes(t);
    }

    function plateMatchesSearch(p, q) {
      if (!q) return true;
      const t = normalize(q);
      const pool = [
        p.productName, p.filmNumber, p.plateNumber, p.tension, p.location, p.mesh, p.memo,
        p.lastUsedWho, p.lastUsedMemo
      ].map(normalize).join(" ");
      return pool.includes(t);
    }

    function sortFilms(arr) {
      const opt = getSortOption();
      const a = [...arr];

      if (opt === "name") {
        a.sort((x,y)=> (x.productName||"").localeCompare((y.productName||""), "ko"));
      } else if (opt === "number") {
        a.sort((x,y)=> (x.filmNumber||"").localeCompare((y.filmNumber||""), "ko"));
      } else if (opt === "lastUsed") {
        a.sort((x,y)=> (y.lastUsed||"").localeCompare((x.lastUsed||""), "ko"));
      } else {
        // updated
        a.sort((x,y)=> (y.updatedAt||0) - (x.updatedAt||0));
      }
      return a;
    }

    function sortPlates(arr) {
      // íŒì€ ê¸°ë³¸: ìµœê·¼ ì‚¬ìš©/ìˆ˜ì • ìš°ì„ 
      const a = [...arr];
      a.sort((x,y)=>{
        const ax = (x.lastUsedAt||0) || (x.updatedAt||0);
        const ay = (y.lastUsedAt||0) || (y.updatedAt||0);
        return ay - ax;
      });
      return a;
    }

    /* ---------- ë Œë”: í•„ë¦„ ë¦¬ìŠ¤íŠ¸ ---------- */
    function renderList(searchText = "") {
      const list = document.getElementById("list");
      const empty = document.getElementById("emptyText");
      const count = document.getElementById("countBar");
      if (!list || !empty || !count) return;

      // ì¸ì‡„ê¸°ì‚¬ ëª¨ë“œëŠ” í•„ë¦„ ìì²´ê°€ ì•ˆ ë³´ì—¬ì•¼ í•¨
      if (isPrinter()) {
        list.innerHTML = "";
        empty.style.display = "none";
        count.textContent = "";
        return;
      }

      const q = (searchText || "").trim();
      const filtered = sortFilms(films.filter((f) => filmMatchesSearch(f, q)));
      const shown = q ? filtered : filtered.slice(0, visibleCount);

      count.innerHTML = `ì´ <strong>${filtered.length}</strong>ê°œ`;
      list.innerHTML = "";

      if (!filtered.length) {
        empty.style.display = "block";
        return;
      } else {
        empty.style.display = "none";
      }

      shown.forEach((film) => {
        const card = document.createElement("div");
        card.className = "card";

        const img = document.createElement("img");
        img.src = film.imageDataUrl || "";
        img.alt = "í•„ë¦„ ì´ë¯¸ì§€";
        img.style.display = film.imageDataUrl ? "block" : "none";
        img.addEventListener("click", () => {
          if (film.imageDataUrl) openImageViewer(film.imageDataUrl);
        });

        const content = document.createElement("div");
        content.className = "card-content";

        // íŒ ê°œìˆ˜
        const plateCount = (plates || []).filter((p) => p.filmId === film.id).length;

        const top = document.createElement("div");
        top.className = "card-row-main";
        top.innerHTML =
          `<div class="card-title">${(film.filmNumber || "-")} Â· ${(film.productName || "")}</div>` +
          `<div class="card-tag">${plateCount}íŒ</div>`;

        const row1 = document.createElement("div");
        row1.className = "card-row";
        row1.innerHTML = `<span class="label">ì œíŒíƒ€ì…</span>${film.method || "-"}`;

        const row2 = document.createElement("div");
        row2.className = "card-row";
        row2.innerHTML = `<span class="label">ì œíŒë°©ë²•</span>${film.plateInfo || "-"}`;

        const row3 = document.createElement("div");
        row3.className = "card-row";
        row3.innerHTML = `<span class="label">MESH</span>${film.mesh || "-"}`;

        const row4 = document.createElement("div");
        row4.className = "card-row";
        row4.innerHTML = `<span class="label">ìœ„ì¹˜</span>${film.location || "-"}`;

        const row5 = document.createElement("div");
        row5.className = "card-row";
        row5.innerHTML = `<span class="label">ìš”ì²­ ì¸ì‡„ì</span>${film.requestPrinter || "-"}`;

        const footer = document.createElement("div");
        footer.className = "card-footer";

        const last = document.createElement("div");
        last.className = "last-used";
        last.innerHTML = `ë§ˆì§€ë§‰ ì‚¬ìš©: <b>${formatDate(film.lastUsed)}</b>`;

        const btns = document.createElement("div");
        btns.className = "card-buttons";

        // ê³µí†µ(ì¡°íšŒë„ ê°€ëŠ¥): ë©”ëª¨ ë³´ê¸°/ìˆ˜ì •(ì¡°íšŒëŠ” ìˆ˜ì • ë¶ˆê°€)
        const memoBtn = document.createElement("button");
        memoBtn.className = "btn btn-secondary btn-small" + ((film.memo || "").trim() ? " btn-memo-has" : "");
        memoBtn.textContent = "ğŸ“ ë©”ëª¨";
        memoBtn.addEventListener("click", () => {
          if (!isAdmin()) {
            // ì¡°íšŒëŠ” ì½ê¸° ëŠë‚Œìœ¼ë¡œ ì—´ì–´ë„ ì €ì¥ì€ ë§‰ì•„ë„ ë˜ì§€ë§Œ, ì§€ê¸ˆì€ ì €ì¥ ë²„íŠ¼ì´ ìˆìœ¼ë‹ˆ ê·¸ëƒ¥ ë§‰ê¸°
            showToast("ì¡°íšŒ ëª¨ë“œì—ì„œëŠ” ë©”ëª¨ ì €ì¥ì´ ì•ˆ ë¼.");
            return;
          }
          openMemoSheet(film.id);
        });
        btns.appendChild(memoBtn);

        // íŒ ë“±ë¡(ê´€ë¦¬ìë§Œ) / íŒ ë³´ê¸°(ëª¨ë‘)
        const plateAddBtn = document.createElement("button");
        plateAddBtn.className = "btn btn-primary btn-small";
        plateAddBtn.textContent = "â• íŒ ë“±ë¡";
        plateAddBtn.style.display = isAdmin() ? "inline-block" : "none";
        plateAddBtn.addEventListener("click", () => openPlateFormNewFromFilm(film.id));
        btns.appendChild(plateAddBtn);

        const goPlatesBtn = document.createElement("button");
        goPlatesBtn.className = "btn btn-secondary btn-small";
        goPlatesBtn.textContent = "ğŸ“„ íŒ ë³´ê¸°";
        goPlatesBtn.addEventListener("click", () => {
          setTab("plates");
          // í•„ë¦„ë²ˆí˜¸ë¡œ ê²€ìƒ‰(ê°€ë³ê²Œ)
          const s = document.getElementById("searchInput");
          if (s) {
            s.value = film.filmNumber || "";
            currentSearchText = s.value;
          }
          renderPlateList(currentSearchText);
        });
        btns.appendChild(goPlatesBtn);

        // ê´€ë¦¬ìë§Œ: ìˆ˜ì •/ì‚­ì œ/ì˜¤ëŠ˜
        if (isAdmin()) {
          const todayBtn = document.createElement("button");
          todayBtn.className = "btn btn-secondary btn-small";
          todayBtn.textContent = "âœ… ì˜¤ëŠ˜";
          todayBtn.addEventListener("click", () => setFilmTodayUsed(film.id));
          btns.appendChild(todayBtn);

          const editBtn = document.createElement("button");
          editBtn.className = "btn btn-secondary btn-small";
          editBtn.textContent = "ìˆ˜ì •";
          editBtn.addEventListener("click", () => openFormEdit(film.id));
          btns.appendChild(editBtn);

          const delBtn = document.createElement("button");
          delBtn.className = "btn btn-danger btn-small";
          delBtn.textContent = "ì‚­ì œ";
          delBtn.addEventListener("click", () => deleteFilm(film.id));
          btns.appendChild(delBtn);
        }

        footer.appendChild(last);
        footer.appendChild(btns);

        content.appendChild(top);
        content.appendChild(row1);
        content.appendChild(row2);
        content.appendChild(row3);
        content.appendChild(row4);
        content.appendChild(row5);
        content.appendChild(footer);

        if (film.imageDataUrl) card.appendChild(img);
        card.appendChild(content);

        list.appendChild(card);
      });
    }

    /* ---------- ë Œë”: íŒ ë¦¬ìŠ¤íŠ¸ ---------- */
    function plateWarnChip(plate) {
      const maxQty = parseInt(plate.maxQty || "5000", 10) || 5000;
      const used = parseInt(plate.totalUsedQty || "0", 10) || 0;
      if (!maxQty) return "";

      const pct = Math.round((used / maxQty) * 100);
      let cls = "usage-chip";
      if (pct >= 90) cls += " usage-warn-90";
      else if (pct >= 70) cls += " usage-warn-70";
      else if (pct >= 50) cls += " usage-warn-50";

      return `<span class="${cls}">${used}/${maxQty} (${pct}%)</span>`;
    }

    function renderPlateList(searchText = "") {
      const list = document.getElementById("plateList");
      const empty = document.getElementById("plateEmptyText");
      const count = document.getElementById("countBar");
      if (!list || !empty || !count) return;

      const q = (searchText || "").trim();
      const filtered = sortPlates(plates.filter((p) => plateMatchesSearch(p, q)));
      const shown = q ? filtered : filtered.slice(0, plateVisibleCount);

      // countëŠ” ê³µí†µë°”ë¼ì„œ íƒ­ì— ë”°ë¼ í‘œì‹œ
      count.innerHTML = `ì´ <strong>${filtered.length}</strong>ê°œ`;

      list.innerHTML = "";

      if (!filtered.length) {
        empty.style.display = "block";
        return;
      } else {
        empty.style.display = "none";
      }

      shown.forEach((plate) => {
        const card = document.createElement("div");
        card.className = "card";

        const content = document.createElement("div");
        content.className = "card-content";

        const top = document.createElement("div");
        top.className = "card-row-main";

        const filmExist = !!films.find((f) => f.id === plate.filmId);
        const warn = filmExist ? "" : `<span class="warn-tag">ì›ë³¸ í•„ë¦„ ì—†ìŒ</span>`;

        top.innerHTML =
          `<div class="card-title">${(plate.plateNumber || "-")} Â· ${(plate.productName || "")}</div>` +
          `<div style="display:flex; gap:6px; align-items:center;">` +
            warn +
            `<div class="card-tag">íŒ</div>` +
          `</div>`;

        const row1 = document.createElement("div");
        row1.className = "card-row";
        row1.innerHTML = `<span class="label">í•„ë¦„</span>${plate.filmNumber || "-"}`;

        const row2 = document.createElement("div");
        row2.className = "card-row";
        row2.innerHTML = `<span class="label">í…ì…˜</span>${plate.tension || "-"}`;

        const row3 = document.createElement("div");
        row3.className = "card-row";
        row3.innerHTML = `<span class="label">MESH</span>${plate.mesh || "-"}`;

        const row4 = document.createElement("div");
        row4.className = "card-row";
        row4.innerHTML = `<span class="label">ìœ„ì¹˜</span>${plate.location || "-"}`;

        const row5 = document.createElement("div");
        row5.className = "card-row";
        const lastAt = plate.lastUsedAt ? formatTs(plate.lastUsedAt) : "-";
        const lastWho = plate.lastUsedWho || "";
        const lastQty = (plate.lastUsedQty ?? "");
        row5.innerHTML =
          `<span class="label">ë§ˆì§€ë§‰</span>${lastAt}` +
          (lastWho ? ` Â· ${lastWho}` : "") +
          (String(lastQty) ? ` Â· ${lastQty}ê°œ` : "") +
          ` ${plateWarnChip(plate)}`;

        const footer = document.createElement("div");
        footer.className = "card-footer";

        const last = document.createElement("div");
        last.className = "last-used";
        last.textContent = plate.memo ? "ë©”ëª¨ ìˆìŒ" : "";

        const btns = document.createElement("div");
        btns.className = "card-buttons";

        // ë©”ëª¨(ê´€ë¦¬ìë§Œ ì €ì¥)
        const memoBtn = document.createElement("button");
        memoBtn.className = "btn btn-secondary btn-small" + ((plate.memo || "").trim() ? " btn-memo-has" : "");
        memoBtn.textContent = "ğŸ“ ë©”ëª¨";
        memoBtn.addEventListener("click", () => {
          if (!isAdmin()) {
            showToast("ì´ ëª¨ë“œì—ì„œëŠ” ë©”ëª¨ ì €ì¥ì´ ì•ˆ ë¼.");
            return;
          }
          openPlateMemoSheet(plate.id);
        });
        btns.appendChild(memoBtn);

        // ì‚¬ìš©ë“±ë¡: ê´€ë¦¬ì/ì¸ì‡„ê¸°ì‚¬ë§Œ
        if (isAdmin() || isPrinter()) {
          const useBtn = document.createElement("button");
          useBtn.className = "btn btn-primary btn-small";
          useBtn.textContent = "âœ… ì‚¬ìš©ë“±ë¡";
          useBtn.addEventListener("click", () => openPlateUseSheet(plate.id));
          btns.appendChild(useBtn);
        }

        // íˆìŠ¤í† ë¦¬: ëª¨ë‘ ê°€ëŠ¥
        const histBtn = document.createElement("button");
        histBtn.className = "btn btn-secondary btn-small";
        histBtn.textContent = "ğŸ“œ íˆìŠ¤í† ë¦¬";
        histBtn.addEventListener("click", () => openPlateHistorySheet(plate.id));
        btns.appendChild(histBtn);

        // ê´€ë¦¬ìë§Œ ìˆ˜ì •/ì‚­ì œ
        if (isAdmin()) {
          const editBtn = document.createElement("button");
          editBtn.className = "btn btn-secondary btn-small";
          editBtn.textContent = "ìˆ˜ì •";
          editBtn.addEventListener("click", () => openPlateFormEdit(plate.id));
          btns.appendChild(editBtn);

          const delBtn = document.createElement("button");
          delBtn.className = "btn btn-danger btn-small";
          delBtn.textContent = "ì‚­ì œ";
          delBtn.addEventListener("click", () => deletePlate(plate.id));
          btns.appendChild(delBtn);
        }

        footer.appendChild(last);
        footer.appendChild(btns);

        content.appendChild(top);
        content.appendChild(row1);
        content.appendChild(row2);
        content.appendChild(row3);
        content.appendChild(row4);
        content.appendChild(row5);
        content.appendChild(footer);

        card.appendChild(content);
        list.appendChild(card);
      });
    }

    /* ---------- íŒ ì‚¬ìš©/íˆìŠ¤í† ë¦¬ ì‹œíŠ¸: ë‹«ê¸° ë°”ì¸ë”© ---------- */
    function bindPlateSheets() {
      // íŒ ë©”ëª¨
      document.getElementById("plateMemoSheetBackdrop").addEventListener("click", closePlateMemoSheet);
      document.getElementById("plateMemoSheetCloseBtn").addEventListener("click", closePlateMemoSheet);
      document.getElementById("plateMemoSheetCancelBtn").addEventListener("click", closePlateMemoSheet);
      document.getElementById("plateMemoSheetSaveBtn").addEventListener("click", savePlateMemoSheet);

      // íŒ ì‚¬ìš©ë“±ë¡
      document.getElementById("plateUseSheetBackdrop").addEventListener("click", closePlateUseSheet);
      document.getElementById("plateUseSheetCloseBtn").addEventListener("click", closePlateUseSheet);
      document.getElementById("plateUseSheetCancelBtn").addEventListener("click", closePlateUseSheet);
      document.getElementById("plateUseSheetSaveBtn").addEventListener("click", () => {
        if (!(isAdmin() || isPrinter())) {
          showToast("ì´ ëª¨ë“œì—ì„œëŠ” ì‚¬ìš©ë“±ë¡ì´ ì•ˆ ë¼.");
          return;
        }
        savePlateUseSheet();
      });

      // íŒ íˆìŠ¤í† ë¦¬
      document.getElementById("plateHistorySheetBackdrop").addEventListener("click", closePlateHistorySheet);
      document.getElementById("plateHistorySheetCloseBtn").addEventListener("click", closePlateHistorySheet);
      document.getElementById("plateHistorySheetCloseBtn2").addEventListener("click", closePlateHistorySheet);
    }

    /* ---------- ë°ì´í„° ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸° (ê´€ë¦¬ìë§Œ) ---------- */
    function exportData() {
      if (!isAdmin()) return;
      const payload = {
        exportedAt: Date.now(),
        films: films || [],
        plates: plates || [],
        printers: printerNamesCache || [],
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `film-find-export-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast("ë‚´ë³´ë‚´ê¸° ì™„ë£Œ!");
    }

    async function importData(file) {
      if (!isAdmin()) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);

        if (!data || typeof data !== "object") throw new Error("invalid");
        const importFilms = Array.isArray(data.films) ? data.films : [];
        const importPlates = Array.isArray(data.plates) ? data.plates : [];
        const importPrinters = Array.isArray(data.printers) ? data.printers : [];

        // printers ë¨¼ì €
        if (importPrinters.length) {
          await savePrinterNames(importPrinters);
        }

        // films/platesëŠ” idê°€ ìˆìœ¼ë©´ doc(id)ë¡œ upsert, ì—†ìœ¼ë©´ add
        const batch = db.batch();

        importFilms.forEach((f) => {
          if (f && f.id) {
            const ref = db.collection(FILM_COLLECTION).doc(f.id);
            batch.set(ref, { ...f, updatedAt: Date.now() }, { merge: true });
          }
        });

        importPlates.forEach((p) => {
          if (p && p.id) {
            const ref = db.collection(PLATE_COLLECTION).doc(p.id);
            batch.set(ref, { ...p, updatedAt: Date.now() }, { merge: true });
          }
        });

        await batch.commit();

        // id ì—†ëŠ” ì• ë“¤ì€ add
        for (const f of importFilms) {
          if (f && !f.id) await db.collection(FILM_COLLECTION).add({ ...f, updatedAt: Date.now() });
        }
        for (const p of importPlates) {
          if (p && !p.id) await db.collection(PLATE_COLLECTION).add({ ...p, updatedAt: Date.now() });
        }

        showToast("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!");
      } catch (e) {
        console.error(e);
        showToast("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ ì¤˜.");
      }
    }

    /* ---------- ì•± ì´ˆê¸°í™” ---------- */
    function bindCommonEvents() {
      // íƒ­
      document.getElementById("tabFilmsBtn").addEventListener("click", () => setTab("films"));
      document.getElementById("tabPlatesBtn").addEventListener("click", () => setTab("plates"));

      // ê²€ìƒ‰(íƒ­ ê³µìš©)
      document.getElementById("searchInput").addEventListener("input", (e) => {
        currentSearchText = e.target.value;
        if (currentTab === "films") renderList(currentSearchText);
        else renderPlateList(currentSearchText);
      });

      // ìƒˆ í•„ë¦„/íŒ
      document.getElementById("newFilmBtn").addEventListener("click", toggleFormNew);
      document.getElementById("newPlateBtn").addEventListener("click", () => {
        // top-barì˜ +ìƒˆíŒì€ ì“°ì§€ ì•ŠìŒ(ìš”êµ¬ì‚¬í•­: í•„ë¦„ ì¹´ë“œì—ì„œë§Œ ìƒì„±)
        showToast("íŒì€ í•„ë¦„ ì¹´ë“œì—ì„œë§Œ ë“±ë¡ë¼.");
      });

      // í•„ë¦„ í¼
      document.getElementById("cancelBtn").addEventListener("click", closeForm);
      document.getElementById("filmForm").addEventListener("submit", saveFilmFromForm);
      document.getElementById("saveBtn").addEventListener("click", saveFilmFromForm);
      document.getElementById("setTodayBtn").addEventListener("click", () => {
        const today = new Date().toISOString().slice(0, 10);
        document.getElementById("lastUsed").value = today;
      });

      // í† ê¸€(ì œíŒë°©ë²•)
      document.querySelectorAll(".toggle-group").forEach((group) => {
        group.querySelectorAll(".toggle-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            group.querySelectorAll(".toggle-btn").forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
          });
        });
      });

      // ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸°
      document.getElementById("exportBtn").addEventListener("click", exportData);
      document.getElementById("importBtn").addEventListener("click", () => document.getElementById("importFile").click());
      document.getElementById("importFile").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) importData(file);
        e.target.value = "";
      });

      // ì„¤ì •/íˆìŠ¤í† ë¦¬
      document.getElementById("settingsBtn").addEventListener("click", openSettings);
      document.getElementById("closeSettingsBtn").addEventListener("click", closeSettings);
      document.getElementById("saveSettingsBtn").addEventListener("click", saveSettings);

      document.getElementById("historyBtn").addEventListener("click", openHistoryCard);
      document.getElementById("closeHistoryBtn").addEventListener("click", closeHistoryCard);

      // íˆìŠ¤í† ë¦¬ ë©”ëª¨ ëª¨ë‹¬
      document.getElementById("historyNoteCancelBtn").addEventListener("click", closeHistoryNoteModal);
      document.getElementById("historyNoteSaveBtn").addEventListener("click", saveHistoryNoteModal);

      // ì´ë¯¸ì§€ ë·°ì–´
      document.getElementById("closeViewerBtn").addEventListener("click", closeImageViewer);
      initImageViewerTouch();

      // ë·° ëª¨ë“œ í† ê¸€
      document.getElementById("viewToggleBtn").addEventListener("click", () => {
        setViewMode(currentViewMode === "gallery" ? "list" : "gallery");
      });

      // ì´ë¯¸ì§€ ì„ íƒ & íšŒì „
      const imageInputEl = document.getElementById("imageInput");
      const rotateLeftBtn = document.getElementById("rotateLeftBtn");
      const rotateRightBtn = document.getElementById("rotateRightBtn");
      const previewWrapper = document.getElementById("imagePreviewWrapper");
      const previewImg = document.getElementById("imagePreview");

      if (imageInputEl) {
        imageInputEl.addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (!file) {
            resetImagePreview();
            return;
          }
          const reader = new FileReader();
          reader.onload = function (ev) {
            currentSelectedImageDataUrl = ev.target.result;
            currentImageRotation = 0;
            if (previewImg) {
              previewImg.src = currentSelectedImageDataUrl;
              previewImg.style.transform = "rotate(0deg)";
            }
            if (previewWrapper) previewWrapper.style.display = "flex";
          };
          reader.readAsDataURL(file);
        });
      }

      if (rotateLeftBtn) {
        rotateLeftBtn.addEventListener("click", () => {
          if (!currentSelectedImageDataUrl) return showToast("ë¨¼ì € ì‚¬ì§„ì„ ì„ íƒí•´ ì¤˜.");
          currentImageRotation = (currentImageRotation - 90) % 360;
          applyPreviewRotation();
        });
      }
      if (rotateRightBtn) {
        rotateRightBtn.addEventListener("click", () => {
          if (!currentSelectedImageDataUrl) return showToast("ë¨¼ì € ì‚¬ì§„ì„ ì„ íƒí•´ ì¤˜.");
          currentImageRotation = (currentImageRotation + 90) % 360;
          applyPreviewRotation();
        });
      }

      // ë©”ëª¨ ì‹œíŠ¸
      document.getElementById("memoSheetBackdrop").addEventListener("click", closeMemoSheet);
      document.getElementById("memoSheetCloseBtn").addEventListener("click", closeMemoSheet);
      document.getElementById("memoSheetCancelBtn").addEventListener("click", closeMemoSheet);
      document.getElementById("memoSheetSaveBtn").addEventListener("click", () => {
        if (!isAdmin()) return showToast("ì¡°íšŒ ëª¨ë“œì—ì„œëŠ” ì €ì¥ì´ ì•ˆ ë¼.");
        saveMemoSheet();
      });

      // íŒ í¼
      document.getElementById("plateCancelBtn").addEventListener("click", closePlateForm);
      document.getElementById("plateForm").addEventListener("submit", savePlateFromForm);
      document.getElementById("plateSaveBtn").addEventListener("click", savePlateFromForm);

      // íŒ ì‹œíŠ¸ë“¤
      bindPlateSheets();

      // ìŠ¤í¬ë¡¤
      initScrollHandlers();
    }

    function injectPrinterManagerUI() {
      // settingsCard ì•ˆì— "ì¸ì‡„ê¸°ì‚¬ ëª©ë¡ ê´€ë¦¬" ì„¹ì…˜ì„ ì¶”ê°€(ê¸°ì¡´ êµ¬ì¡° ì•ˆ ê±´ë“œë¦¬ê³  ì¶”ê°€ë§Œ)
      const pwSection = document.getElementById("pwChangeSection");
      if (!pwSection) return;

      // ì´ë¯¸ ì¶”ê°€ë˜ì–´ ìˆìœ¼ë©´ ì¤‘ë³µ ë°©ì§€
      if (document.getElementById("printerManagerBox")) return;

      const wrap = document.createElement("div");
      wrap.id = "printerManagerBox";
      wrap.className = "form-row";
      wrap.style.marginTop = "10px";

      wrap.innerHTML = `
        <div class="settings-section-title">ì¸ì‡„ê¸°ì‚¬ ì´ë¦„ ëª©ë¡</div>
        <div class="settings-help">íŒ ì‚¬ìš©ë“±ë¡/ìš”ì²­ ì¸ì‡„ì ì„ íƒ ëª©ë¡ì´ì•¼. (Firebase ê³µìœ )</div>

        <div style="display:flex; gap:6px; align-items:center; margin-bottom:8px; flex-wrap:wrap;">
          <input id="printerManagerInput" type="text" placeholder="ì´ë¦„ ì¶”ê°€ (ì˜ˆ: ì´ì°½ë¯¼ ë¶€ì¥ë‹˜)" style="flex:1; min-width:160px;" />
          <button type="button" class="btn btn-primary btn-small" id="printerManagerAddBtn">ì¶”ê°€</button>
        </div>

        <div id="printerManagerList" class="history-list" style="max-height:220px;"></div>
      `;

      // pwSection ë’¤ì— ì‚½ì…
      pwSection.parentNode.insertBefore(wrap, pwSection.nextSibling);

      // ì´ë²¤íŠ¸ ë°”ì¸ë”©
      const addBtn = wrap.querySelector("#printerManagerAddBtn");
      const input = wrap.querySelector("#printerManagerInput");
      addBtn.addEventListener("click", async () => {
        const name = sanitizeName(input.value);
        if (!name) return showToast("ì´ë¦„ì„ ì…ë ¥í•´ ì¤˜.");
        const next = [...(printerNamesCache || []), name];
        try {
          await savePrinterNames(next);
          input.value = "";
          showToast("ëª©ë¡ì— ì¶”ê°€í–ˆì–´.");
        } catch (e) {
          console.error(e);
          showToast("ì¶”ê°€ ì¤‘ ì˜¤ë¥˜.");
        }
      });
      input.addEventListener("keydown", async (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          addBtn.click();
        }
      });
    }

    async function initAppAfterUnlock() {
      setTheme(getTheme());
      const themeSelect = document.getElementById("themeSelect");
      if (themeSelect) themeSelect.value = getTheme();

      setDeviceLabel(getDeviceLabel());

      // settingsì— ëª©ë¡ UI ì£¼ì…(ì¶”ê°€ë§Œ)
      injectPrinterManagerUI();

      // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ
      startFilmsListener();
      startPlatesListener();

      // í”„ë¦°í„° ëª©ë¡ ë¡œë“œ
      await loadPrinterNames();

      // ê¸°ë³¸ íƒ­/ë·° ì ìš©
      applyTab();
      applyViewMode();

      // ë²„íŠ¼/ê¶Œí•œ ë°˜ì˜
      applyModeVisibility();

      // ì´ë²¤íŠ¸
      bindCommonEvents();

      // ìµœì´ˆ ë Œë”
      renderList(currentSearchText);
      renderPlateList(currentSearchText);
    }

    /* ---------- ì ê¸ˆ/ë¡œê·¸ì¸ ---------- */
    async function unlockWithPassword(pw) {
      const mode = resolveModeByPassword(pw);
      if (!mode) return false;

      currentMode = mode;
      sessionStorage.setItem(UNLOCK_KEY, "true");

      // ëª¨ë“œê°€ ì¸ì‡„ê¸°ì‚¬ë©´ íƒ­ì„ íŒìœ¼ë¡œ ê°•ì œ
      if (isPrinter()) setTab("plates");

      return true;
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const lockScreen = document.getElementById("lockScreen");
      const appContainer = document.getElementById("appContainer");
      const pwInput = document.getElementById("passwordInput");
      const pwBtn = document.getElementById("passwordBtn");

      setTheme(getTheme());

      // auth ë¡œë“œ(ì„œë²„/ê¸°ë³¸)
      await loadAuthSettings();

      async function doUnlock() {
        const v = (pwInput.value || "").trim();
        const ok = await unlockWithPassword(v);
        if (ok) {
          lockScreen.style.display = "none";
          appContainer.style.display = "block";

          if (!window._filmAppInitialized) {
            window._filmAppInitialized = true;
            await initAppAfterUnlock();

            // ê¸°ê¸° ì´ë¦„ ëª¨ë‹¬
            if (!getDeviceLabel()) {
              const dm = document.getElementById("deviceModal");
              dm.style.display = "flex";
            }
          } else {
            applyModeVisibility();
            applyTab();
          }
        } else {
          alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ì–´.");
          pwInput.focus();
          pwInput.select();
        }
      }

      const unlocked = sessionStorage.getItem(UNLOCK_KEY) === "true";
      if (unlocked) {
        // ì´ë¯¸ ì—´ë ¤ ìˆë˜ ì„¸ì…˜ì´ë©´ "ë§ˆì§€ë§‰ ëª¨ë“œ"ê°€ ì—†ìœ¼ë¯€ë¡œ: ë¹„ë²ˆ ë‹¤ì‹œ ì¹˜ê²Œ í•˜ëŠ” ëŒ€ì‹  viewerë¡œ ê¸°ë³¸
        // (ì„¸ì…˜ ì €ì¥ë§Œ í–ˆì„ ë¿ ëª¨ë“œëŠ” ì €ì¥ ì•ˆ í–ˆìœ¼ë‹ˆ, ì•ˆì „í•˜ê²Œ ì¡°íšŒë¡œ ì¬ì§„ì…)
        currentMode = "viewer";
        lockScreen.style.display = "none";
        appContainer.style.display = "block";
        if (!window._filmAppInitialized) {
          window._filmAppInitialized = true;
          await initAppAfterUnlock();

          if (!getDeviceLabel()) {
            const dm = document.getElementById("deviceModal");
            dm.style.display = "flex";
          }
        } else {
          applyModeVisibility();
          applyTab();
        }
      } else {
        lockScreen.style.display = "flex";
        appContainer.style.display = "none";
      }

      pwBtn.addEventListener("click", doUnlock);
      pwInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") doUnlock();
      });

      // ê¸°ê¸° ì´ë¦„ ëª¨ë‹¬
      const deviceModal = document.getElementById("deviceModal");
      const deviceInput = document.getElementById("deviceModalInput");
      const deviceSkip = document.getElementById("deviceModalSkip");
      const deviceSave = document.getElementById("deviceModalSave");

      deviceSkip.addEventListener("click", () => {
        deviceModal.style.display = "none";
        showToast("ì–¸ì œë“  ì„¤ì •ì—ì„œ ê¸°ê¸° ì´ë¦„ì„ ë°”ê¿€ ìˆ˜ ìˆì–´.");
      });
      deviceSave.addEventListener("click", () => {
        const name = deviceInput.value.trim();
        if (!name) {
          alert("ê¸°ê¸° ì´ë¦„ì„ ì…ë ¥í•´ ì¤˜.");
          return;
        }
        setDeviceLabel(name);
        deviceModal.style.display = "none";
        showToast("ê¸°ê¸° ì´ë¦„ì„ ì €ì¥í–ˆì–´.");
      });

      // ìµœì´ˆ ëª¨ë“œ pill ê°±ì‹ 
      setModePill();
    });

  </script>
</body>
</html>
