<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#f9f4ff">
  <meta charset="UTF-8" />
  <title>FILM FIND - í•„ë¦„/íŒ ê´€ë¦¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- í°íŠ¸ (Pretendard) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css" />

  <style>
    :root{
      /* ê¸°ë³¸(ë¼ë²¤ë”) */
      --bg-gradient: linear-gradient(145deg, #f9fafb, #f4f0ff, #fdf2f8);
      --card-bg: rgba(255,255,255,0.98);
      --card-border: #e3e6ff;
      --shadow-soft: 0 8px 20px rgba(167, 173, 208, 0.35);

      --text-main: #272a3f;
      --text-sub: #767a98;
      --text-muted: #777b9e;
      --label-color: #8689a5;

      --primary-1: #7f9dff;
      --primary-2: #b38cff;
      --primary-soft: rgba(228,231,255,0.95);

      --chip-bg: #f3e8ff;
      --chip-text: #5f308c;

      --danger-bg: #ff6b81;
      --danger-text: #ffffff;

      --pill-bg: rgba(228,231,255,0.98);
      --pill-border: rgba(129, 140, 248, 0.4);

      --toast-bg: rgba(15,23,42,0.9);
      --toast-text: #f9fafb;

      --spinner-border: rgba(191, 219, 254, 0.9);
      --spinner-glow: rgba(129, 140, 248, 0.7);

      --warn-1: #f59e0b;
      --warn-2: #ef4444;
      --ok: #10b981;
    }

    [data-theme="mint"] {
      --bg-gradient: linear-gradient(145deg, #f0fdfa, #e0f2fe, #fefce8);
      --primary-1: #34d399;
      --primary-2: #22c55e;
      --primary-soft: rgba(187,247,208,0.85);
      --chip-bg: #dcfce7;
      --chip-text: #047857;
      --pill-bg: rgba(219, 234, 254, 0.96);
      --pill-border: rgba(45, 212, 191, 0.5);
      --spinner-border: rgba(167, 243, 208, 0.9);
      --spinner-glow: rgba(45, 212, 191, 0.7);
    }

    [data-theme="peach"] {
      --bg-gradient: linear-gradient(145deg, #fff7ed, #fee2e2, #fef9c3);
      --primary-1: #fb7185;
      --primary-2: #f97316;
      --primary-soft: rgba(254, 226, 226, 0.9);
      --chip-bg: #ffe4e6;
      --chip-text: #be123c;
      --pill-bg: rgba(254, 226, 226, 0.96);
      --pill-border: rgba(248, 113, 113, 0.55);
      --spinner-border: rgba(254, 202, 202, 0.9);
      --spinner-glow: rgba(248, 113, 113, 0.75);
    }

    [data-theme="night"] {
      --bg-gradient: radial-gradient(circle at top, #020617, #020617, #111827);
      --card-bg: rgba(15,23,42,0.98);
      --card-border: #1f2937;
      --shadow-soft: 0 10px 24px rgba(15, 23, 42, 0.75);

      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --text-muted: #9ca3af;
      --label-color: #9ca3af;

      --primary-1: #6366f1;
      --primary-2: #a855f7;
      --primary-soft: rgba(79,70,229,0.22);

      --chip-bg: rgba(79,70,229,0.18);
      --chip-text: #a5b4fc;

      --danger-bg: #f97373;
      --danger-text: #111827;

      --pill-bg: rgba(17,24,39,0.95);
      --pill-border: rgba(129, 140, 248, 0.8);

      --toast-bg: rgba(17,24,39,0.95);
      --toast-text: #e5e7eb;

      --spinner-border: rgba(55, 65, 81, 0.9);
      --spinner-glow: rgba(129, 140, 248, 0.85);
    }

    * { box-sizing: border-box; font-family: "Pretendard Variable", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin:0; min-height:100vh; background:var(--bg-gradient); padding:12px; color:var(--text-main); }
    .app-shell { max-width: 720px; margin: 0 auto; }

    .app-header {
      max-width: 720px; margin: 0 auto 6px;
      display:flex; align-items:center; justify-content:space-between; gap:8px;
    }
    .title-wrap { display:flex; flex-direction:column; gap:2px; }
    .app-title { font-size:20px; font-weight:700; letter-spacing:2px; color:var(--text-main); }
    .app-subtitle { font-size:11px; color:var(--text-sub); }

    .device-badge {
      font-size:11px; padding:4px 12px; border-radius:999px;
      background:var(--pill-bg); color:var(--text-sub); white-space:nowrap;
      max-width:180px; text-overflow:ellipsis; overflow:hidden;
      border:1px solid var(--pill-border);
      box-shadow:0 0 8px rgba(129, 140, 248, 0.28);
      display:flex; align-items:center; gap:6px; justify-content:flex-end;
    }
    .device-dot { width:6px; height:6px; border-radius:999px; background:var(--primary-1); box-shadow:0 0 6px rgba(129, 140, 248, 0.9); }
    .mode-chip{
      font-size:11px; padding:2px 8px; border-radius:999px;
      background:var(--primary-soft);
      color:var(--text-main);
      border:1px solid var(--card-border);
      white-space:nowrap;
    }
    [data-theme="night"] .mode-chip{ color:#e5e7eb; }

    .top-bar { display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap; }
    .top-bar input[type="text"]{
      flex:1; padding:9px 11px; border-radius:999px; border:1px solid var(--card-border);
      font-size:14px; min-width:0; background:rgba(255,255,255,0.9); color:var(--text-main);
    }
    .top-bar input::placeholder { color:var(--text-muted); }
    [data-theme="night"] .top-bar input[type="text"] { background:#020617; border-color:#1f2937; }

    /* âœ… ë²„íŠ¼ ì¤‘ì•™ì •ë ¬(ìƒˆ í•„ë¦„ í…ìŠ¤íŠ¸ ì¤‘ì•™ ë¬¸ì œ í•´ê²°) */
    .btn {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;

      padding:8px 11px; border-radius:999px; border:none; font-size:13px;
      cursor:pointer; white-space:nowrap;
      transition: transform 0.05s ease, box-shadow 0.1s ease, background 0.1s ease, opacity 0.1s ease;
    }
    .btn:active { transform: translateY(1px); box-shadow:none; opacity:0.92; }
    .btn-primary { background: linear-gradient(135deg, var(--primary-1), var(--primary-2)); color:#fff; box-shadow:0 4px 10px rgba(127,157,255,0.35); }
    .btn-secondary { background: var(--primary-soft); color:#283252; }
    [data-theme="night"] .btn-secondary { color:#e5e7eb; }
    .btn-danger { background: var(--danger-bg); color: var(--danger-text); }
    .btn-small { font-size:12px; padding:5px 9px; border-radius:999px; }

    .tools-bar { display:flex; gap:6px; margin-bottom:6px; flex-wrap:wrap; justify-content:flex-end; }

    /* âœ… íƒ­ ìœ„ì¹˜ ê°œì„ : ê²€ìƒ‰ ì•„ë˜ì— ì„¸ê·¸ë¨¼íŠ¸ ë°” */
    .seg-bar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .seg-left{
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
    }
    .seg-tabs{
      display:flex;
      gap:6px;
      background:rgba(255,255,255,0.65);
      border:1px solid var(--card-border);
      padding:4px;
      border-radius:999px;
    }
    [data-theme="night"] .seg-tabs{
      background: rgba(2,6,23,0.55);
      border-color:#1f2937;
    }
    .seg-tab{
      border:none;
      background:transparent;
      padding:6px 12px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      color:var(--text-main);
      opacity:0.85;
    }
    .seg-tab.active{
      background: linear-gradient(135deg, var(--primary-1), var(--primary-2));
      color:#fff;
      opacity:1;
      box-shadow:0 6px 14px rgba(127,157,255,0.22);
    }

    .count-wrap { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:10px; }
    .count-bar { font-size:11px; color:var(--text-muted); flex:1; }
    .count-bar strong { color: var(--primary-1); }

    .form-card{
      background: var(--card-bg);
      border-radius: 18px;
      padding: 12px 14px;
      margin-bottom: 12px;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--card-border);
    }
    .form-row{ display:flex; flex-direction:column; margin-bottom:9px; }
    .form-row label{ font-size:12px; margin-bottom:4px; color:var(--label-color); }
    .form-row input[type="text"], .form-row input[type="date"], .form-row input[type="password"], .form-row input[type="number"], .form-row select, .form-row textarea{
      padding:7px 10px; border-radius:10px; border:1px solid var(--card-border);
      font-size:13px; background:#f9f9ff; color:var(--text-main);
    }
    [data-theme="night"] .form-row input[type="text"],
    [data-theme="night"] .form-row input[type="date"],
    [data-theme="night"] .form-row input[type="password"],
    [data-theme="night"] .form-row input[type="number"],
    [data-theme="night"] .form-row select,
    [data-theme="night"] .form-row textarea{
      background:#020617; border-color:#1f2937; color:#e5e7eb;
    }
    .form-actions{ display:flex; justify-content:flex-end; gap:6px; margin-top:6px; }

    .settings-section-title{
      font-size:13px; font-weight:600; margin-bottom:4px; color:#3c4266;
      white-space: nowrap;
      word-break: keep-all;
    }
    .settings-help{ font-size:11px; color:#8a8fb0; margin-bottom:6px; }
    [data-theme="night"] .settings-section-title { color:#e5e7eb; }
    [data-theme="night"] .settings-help { color:#9ca3af; }

    .list{ display:flex; flex-direction:column; gap:10px; margin-bottom:24px; }
    .list.gallery{ display:grid; grid-template-columns:1fr; gap:12px; }
    .list.gallery .card{ flex-direction:column; align-items:stretch; }
    .list.gallery .card img{ width:100%; height:180px; object-fit:cover; }

    .card{
      background: rgba(255,255,255,0.96);
      border-radius: 16px;
      padding: 10px;
      display:flex; gap:10px;
      box-shadow: 0 6px 16px rgba(169, 177, 214, 0.35);
      align-items:flex-start;
      border: 1px solid var(--card-border);
      animation: cardFadeIn 0.18s ease-out;
    }
    [data-theme="night"] .card{
      background: rgba(15,23,42,0.98);
      box-shadow: 0 8px 22px rgba(15,23,42,0.85);
    }
    @keyframes cardFadeIn { from{opacity:0; transform:translateY(4px);} to{opacity:1; transform:translateY(0);} }

    .card img{
      width:70px; height:70px; object-fit:cover; border-radius:12px;
      background:#eef1ff; flex-shrink:0; cursor:pointer;
    }
    .card-content{ flex:1; font-size:13px; }
    .card-row-main{ display:flex; justify-content:space-between; gap:6px; margin-bottom:4px; align-items:center; }
    .card-title{ font-weight:600; font-size:14px; color:var(--text-main); display:flex; align-items:center; gap:6px; }
    .card-tag{ font-size:11px; padding:3px 7px; border-radius:999px; background:var(--chip-bg); color:var(--chip-text); align-self:flex-start; }
    .warn-icon{ font-size:14px; line-height:1; }
    .card-row{ margin-bottom:2px; color:var(--text-main); }
    .label{ color:var(--label-color); font-size:11px; margin-right:4px; }
    .card-footer{ display:flex; justify-content:space-between; align-items:center; margin-top:4px; gap:6px; flex-wrap:wrap; }
    .last-used{ font-size:11px; color:var(--text-muted); }
    .card-buttons{ display:flex; gap:4px; flex-wrap:wrap; justify-content:flex-end; }

    .empty-text{ text-align:center; color:#777; font-size:13px; margin-top:20px; }
    [data-theme="night"] .empty-text{ color:#9ca3af; }

    .toggle-group{ display:flex; gap:6px; margin-bottom:4px; flex-wrap:wrap; }
    .toggle-btn{
      padding:5px 10px; font-size:12px; border-radius:999px;
      border:1px solid var(--card-border); background:#f5f3ff; color:#464b73;
      cursor:pointer; transition: background 0.1s ease, color 0.1s ease, border 0.1s ease;
    }
    .toggle-btn.active{ border-color:var(--primary-1); background:var(--primary-1); color:#fff; }

    /* ì ê¸ˆ í™”ë©´ */
    .lock-screen{
      position:fixed; inset:0;
      background: radial-gradient(circle at top, rgba(255,255,255,0.95), rgba(203,213,255,0.96));
      display:flex; align-items:center; justify-content:center;
      padding:16px; z-index:1000;
    }
    .lock-card{
      width:100%; max-width:320px;
      background: rgba(255,255,255,0.98);
      border-radius: 20px;
      padding: 18px 18px 16px;
      box-shadow: 0 12px 28px rgba(136, 144, 195, 0.55);
      border: 1px solid #dde1ff;
      text-align:center;
    }
    .lock-title{ font-size:18px; margin-bottom:12px; font-weight:700; color:#303656; }
    .lock-input-wrap{ display:flex; gap:8px; margin-bottom:10px; align-items:center; justify-content:space-between; }
    .lock-input-wrap input{
      flex:1; padding:10px 10px; border-radius:999px; border:1px solid #d6d9ff;
      background:#f7f7ff; text-align:center; font-size:15px; letter-spacing:3px; min-width:0;
    }
    .lock-mini{ font-size:11px; color:#8a8fb0; margin-top:8px; }

    /* ì´ë¯¸ì§€ ë·°ì–´ */
    .image-viewer{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1500; }
    .image-viewer.show{ display:flex; }
    .image-viewer-backdrop{ position:absolute; inset:0; background:rgba(15, 23, 42, 0.75); }
    .image-viewer-inner{ position:relative; max-width:100%; max-height:100%; display:flex; align-items:center; justify-content:center; padding:16px; }
    #viewerImage{ max-width:100%; max-height:100%; border-radius:12px; box-shadow: 0 16px 40px rgba(0,0,0,0.5); touch-action:none; transition: transform 0.1s ease-out; }
    .viewer-close-btn{
      position:absolute; top:16px; right:16px;
      border-radius:999px; border:none; padding:6px 10px; font-size:14px;
      cursor:pointer; background: rgba(15,23,42,0.8); color:#f9fafb;
    }

    /* í† ìŠ¤íŠ¸ */
    .toast{
      position:fixed; bottom:16px; left:50%;
      transform: translateX(-50%) translateY(40px);
      background:var(--toast-bg); color:var(--toast-text);
      padding:8px 14px; border-radius:999px; font-size:12px;
      opacity:0; pointer-events:none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index:2000; max-width:80%; text-align:center;
      white-space:nowrap; text-overflow:ellipsis; overflow:hidden;
      box-shadow: 0 10px 24px rgba(15,23,42,0.6);
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }

    /* íˆìŠ¤í† ë¦¬ íƒ€ì„ë¼ì¸ */
    .history-list{ max-height:280px; overflow-y:auto; padding-right:4px; margin-top:4px; position:relative; }
    .history-list::before{
      content:""; position:absolute; left:8px; top:0; bottom:0; width:2px;
      background: linear-gradient(to bottom, rgba(148,163,184,0.6), rgba(199,210,254,0.2));
    }
    .history-row{ font-size:12px; color:#444867; padding:6px 2px 6px 20px; position:relative; }
    [data-theme="night"] .history-row{ color:#e5e7eb; }
    .history-row::before{
      content:""; position:absolute; left:4px; top:10px; width:8px; height:8px; border-radius:999px;
      background:#fff; border:2px solid var(--primary-1);
      box-shadow: 0 0 0 4px rgba(129,140,248,0.15);
    }
    .history-time{ color:#6b6f90; font-size:11px; }
    [data-theme="night"] .history-time{ color:#9ca3af; }
    .history-device{ color:var(--primary-1); font-size:11px; margin-left:4px; }
    .history-action-chip{
      display:inline-block; margin-left:6px; padding:1px 6px; border-radius:999px;
      font-size:11px; background:var(--chip-bg); color:var(--chip-text);
    }
    .history-film{ color:#111827; font-weight:500; }
    [data-theme="night"] .history-film{ color:#e5e7eb; }
    .history-changes{ font-size:11px; color:#6b7280; margin-top:2px; }
    [data-theme="night"] .history-changes{ color:#9ca3af; }
    .history-empty{ font-size:12px; color:#6b7280; padding-left:20px; margin-top:6px; }
    [data-theme="night"] .history-empty{ color:#9ca3af; }

    .history-headline{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .history-pencil{
      border:none; cursor:pointer; padding:4px 8px; border-radius:999px;
      font-size:12px; background:var(--primary-soft); color:var(--text-main);
    }
    [data-theme="night"] .history-pencil{ color:#e5e7eb; }
    .history-note{
      margin-top:6px; padding:8px 10px; border-radius:12px; border:1px solid var(--card-border);
      background: rgba(228,231,255,0.65); font-size:12px; color:var(--text-main);
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
    }
    [data-theme="night"] .history-note{ background: rgba(79,70,229,0.18); border-color:#1f2937; }

    .note-modal{
      position:fixed; inset:0; background:rgba(15,23,42,0.35);
      display:none; align-items:center; justify-content:center;
      z-index:1700; padding:16px;
    }
    .note-modal.show{ display:flex; }
    .note-modal-card{
      background: var(--card-bg);
      border:1px solid var(--card-border);
      border-radius:18px; padding:16px 18px 14px;
      max-width:380px; width:100%;
      box-shadow: 0 10px 24px rgba(0,0,0,0.25);
    }
    .note-modal-title{ font-size:15px; font-weight:700; margin-bottom:6px; color:var(--text-main); }
    .note-modal-text{ font-size:12px; color:var(--text-sub); margin-bottom:10px; }
    .note-modal-textarea{
      width:100%; min-height:120px; resize:vertical;
      padding:10px; border-radius:12px; border:1px solid var(--card-border);
      background:#f9f9ff; color:var(--text-main); font-size:13px; line-height:1.45;
    }
    [data-theme="night"] .note-modal-textarea{ background:#020617; border-color:#1f2937; color:#e5e7eb; }
    .note-modal-actions{ display:flex; justify-content:flex-end; gap:6px; margin-top:10px; }

    /* ìŠ¤í”¼ë„ˆ */
    .spinner-wrapper{ display:none; justify-content:center; align-items:center; padding:4px 0 16px; }
    .spinner-wrapper.show{ display:flex; }
    .spinner-circle{
      width:28px; height:28px; border-radius:999px;
      border:3px solid var(--spinner-border);
      border-top-color: var(--primary-1);
      box-shadow: 0 0 12px var(--spinner-glow);
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    /* ë§¨ ìœ„ë¡œ */
    .scroll-top-btn{
      position:fixed; right:16px; bottom:24px;
      width:36px; height:36px; border-radius:999px; border:none;
      font-size:18px; cursor:pointer;
      background: linear-gradient(135deg, var(--primary-1), var(--primary-2));
      color:#fff; display:none; align-items:center; justify-content:center;
      box-shadow: 0 10px 24px rgba(107,114,128,0.6);
      z-index:1900;
    }
    .scroll-top-btn.show{ display:flex; }

    /* ë©”ëª¨(ë°”í…€ ì‹œíŠ¸) */
    .memo-sheet{
      position:fixed; inset:0; display:none; align-items:flex-end; justify-content:center; z-index:1600;
    }
    .memo-sheet.show{ display:flex; }
    .memo-sheet-backdrop{ position:absolute; inset:0; background: rgba(15, 23, 42, 0.45); }
    .memo-sheet-panel{
      position:relative; width:100%; max-width:720px;
      background: var(--card-bg);
      border:1px solid var(--card-border);
      border-radius:18px 18px 0 0;
      box-shadow: 0 -12px 28px rgba(0,0,0,0.25);
      padding: 12px 14px 14px;
      animation: sheetUp 0.16s ease-out;
    }
    @keyframes sheetUp{ from{ transform:translateY(14px); opacity:0; } to{ transform:translateY(0); opacity:1; } }
    .memo-sheet-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .memo-sheet-title{ font-size:14px; font-weight:700; color:var(--text-main); }
    .memo-sheet-sub{ font-size:11px; color:var(--text-sub); margin-top:2px; }
    .memo-sheet-textarea{
      width:100%; min-height:120px; resize:vertical;
      padding:10px; border-radius:12px; border:1px solid var(--card-border);
      background:#f9f9ff; color:var(--text-main); font-size:13px; line-height:1.45;
    }
    [data-theme="night"] .memo-sheet-textarea{ background:#020617; border-color:#1f2937; color:#e5e7eb; }
    .memo-sheet-actions{ display:flex; justify-content:flex-end; gap:6px; margin-top:10px; }
    .btn-memo-has{ box-shadow: 0 0 0 2px rgba(127,157,255,0.18) inset; }

    /* ì‚¬ìš©ë“±ë¡ ì‹œíŠ¸ */
    .usage-sheet{ position:fixed; inset:0; display:none; align-items:flex-end; justify-content:center; z-index:1650; }
    .usage-sheet.show{ display:flex; }
    .usage-panel{ position:relative; width:100%; max-width:720px; background:var(--card-bg); border:1px solid var(--card-border);
      border-radius:18px 18px 0 0; box-shadow:0 -12px 28px rgba(0,0,0,0.25); padding:12px 14px 14px; animation: sheetUp 0.16s ease-out; }

    /* âœ… íœ´ì§€í†µ UX ê°œì„  */
    .trash-box{
      border:1px solid var(--card-border);
      background: rgba(255,255,255,0.6);
      border-radius:14px;
      padding:10px;
      max-height:260px;
      overflow:auto;
    }
    [data-theme="night"] .trash-box{
      background: rgba(2,6,23,0.55);
      border-color:#1f2937;
    }
    .trash-row{ display:flex; gap:8px; align-items:center; justify-content:space-between; padding:10px 0; border-bottom:1px solid rgba(148,163,184,0.2); }
    .trash-row:last-child{ border-bottom:none; }
    .trash-meta{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .trash-title{ font-size:12px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .trash-sub{ font-size:11px; color:var(--text-sub); }

    @media (min-width: 600px) { .list.gallery{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (min-width: 1024px) {
      .app-shell, .app-header{ max-width:1080px; }
      .list.gallery{ grid-template-columns: repeat(3, minmax(260px, 1fr)); }
    }
  </style>
</head>

<body>
  <!-- ì ê¸ˆ í™”ë©´ -->
  <div id="lockScreen" class="lock-screen">
    <div class="lock-card">
      <div class="lock-title">FILM FIND</div>
      <div class="lock-input-wrap">
        <input type="password" id="passwordInput" maxlength="20" placeholder="ë¹„ë°€ë²ˆí˜¸" />
        <button class="btn btn-primary btn-small" id="passwordBtn">ì…ì¥</button>
      </div>
      <div class="lock-mini">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</div>
    </div>
  </div>

  <!-- ì´ë¯¸ì§€ ì „ì²´ë³´ê¸° -->
  <div id="imageViewer" class="image-viewer">
    <div class="image-viewer-backdrop" id="viewerBackdrop"></div>
    <div class="image-viewer-inner">
      <img id="viewerImage" src="" alt="ì´ë¯¸ì§€" />
      <button id="closeViewerBtn" class="viewer-close-btn">âœ•</button>
    </div>
  </div>

  <!-- í† ìŠ¤íŠ¸ -->
  <div id="toast" class="toast"></div>

  <!-- í•„ë¦„ ë©”ëª¨ ì‹œíŠ¸ -->
  <div id="memoSheet" class="memo-sheet">
    <div id="memoSheetBackdrop" class="memo-sheet-backdrop"></div>
    <div class="memo-sheet-panel">
      <div class="memo-sheet-head">
        <div>
          <div class="memo-sheet-title" id="memoSheetTitle">ë©”ëª¨</div>
          <div class="memo-sheet-sub" id="memoSheetSub">ë©”ëª¨ë¥¼ ì ê³  ì €ì¥í•  ìˆ˜ ìˆì–´.</div>
        </div>
        <button class="btn btn-secondary btn-small" id="memoSheetCloseBtn">ë‹«ê¸°</button>
      </div>
      <textarea id="memoTextarea" class="memo-sheet-textarea" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥..."></textarea>
      <div class="memo-sheet-actions">
        <button class="btn btn-secondary btn-small" id="memoSheetCancelBtn">ì·¨ì†Œ</button>
        <button class="btn btn-primary btn-small" id="memoSheetSaveBtn">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- íŒ ë©”ëª¨ ì‹œíŠ¸ -->
  <div id="plateMemoSheet" class="memo-sheet">
    <div id="plateMemoBackdrop" class="memo-sheet-backdrop"></div>
    <div class="memo-sheet-panel">
      <div class="memo-sheet-head">
        <div>
          <div class="memo-sheet-title" id="plateMemoTitle">íŒ ë©”ëª¨</div>
          <div class="memo-sheet-sub" id="plateMemoSub">íŒë³„ ë©”ëª¨ë¥¼ ì ê³  ì €ì¥í•  ìˆ˜ ìˆì–´.</div>
        </div>
        <button class="btn btn-secondary btn-small" id="plateMemoCloseBtn">ë‹«ê¸°</button>
      </div>
      <textarea id="plateMemoTextarea" class="memo-sheet-textarea" placeholder="ì˜ˆ: 70% ë„˜ì–´ê°€ë©´ ê²¹ì¹¨ ì²´í¬ / í…ì…˜ 24 ìœ ì§€"></textarea>
      <div class="memo-sheet-actions">
        <button class="btn btn-secondary btn-small" id="plateMemoCancelBtn">ì·¨ì†Œ</button>
        <button class="btn btn-primary btn-small" id="plateMemoSaveBtn">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ì‚¬ìš©ë“±ë¡ ì‹œíŠ¸ -->
  <div id="usageSheet" class="usage-sheet">
    <div id="usageBackdrop" class="memo-sheet-backdrop"></div>
    <div class="usage-panel">
      <div class="memo-sheet-head">
        <div>
          <div class="memo-sheet-title" id="usageTitle">ì‚¬ìš© ë“±ë¡</div>
          <div class="memo-sheet-sub" id="usageSub">ëˆ„ê°€ / ìˆ˜ëŸ‰ / ë©”ëª¨ë¥¼ ê¸°ë¡í•´.</div>
        </div>
        <button class="btn btn-secondary btn-small" id="usageCloseBtn">ë‹«ê¸°</button>
      </div>

      <!-- âœ… ì¸ì‡„ê¸°ì‚¬ ì´ë¦„: ì…ë ¥ â†’ ì„ íƒ -->
      <div class="form-row">
        <label for="usageBySelect">ì¸ì‡„ê¸°ì‚¬ ì´ë¦„ *</label>
        <div style="display:flex; gap:6px; align-items:center;">
          <select id="usageBySelect" style="flex:1;">
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
          </select>
          <button type="button" class="btn btn-secondary btn-small" id="addPrinterNameBtn">+ ì¶”ê°€</button>
        </div>
        <small style="font-size:11px; color:var(--text-sub);">
          ìì£¼ ì“°ëŠ” ì´ë¦„ì€ â€œì¶”ê°€â€ë¡œ ì €ì¥í•´ë‘ë©´ ë‹¤ìŒë¶€í„° ì„ íƒë§Œ í•˜ë©´ ë¼.
        </small>
      </div>

      <div class="form-row">
        <label for="usageQty">ì¸ì‡„ ìˆ˜ëŸ‰ *</label>
        <input type="number" id="usageQty" min="1" step="1" placeholder="ì˜ˆ: 1200" />
      </div>
      <div class="form-row">
        <label for="usageMemo">ë©”ëª¨</label>
        <textarea id="usageMemo" rows="3" placeholder="ì˜ˆ: 2mm ë°€ë¦¼ ìˆì–´ì„œ 1ì¥ì”© í™•ì¸"></textarea>
      </div>

      <div class="memo-sheet-actions">
        <button class="btn btn-secondary btn-small" id="usageCancelBtn">ì·¨ì†Œ</button>
        <button class="btn btn-primary btn-small" id="usageSaveBtn">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- íˆìŠ¤í† ë¦¬ ë©”ëª¨ ëª¨ë‹¬ -->
  <div id="historyNoteModal" class="note-modal">
    <div class="note-modal-card">
      <div class="note-modal-title">íˆìŠ¤í† ë¦¬ ë©”ëª¨</div>
      <div class="note-modal-text">ì´ ê¸°ë¡ì— â€œì™œ ë°”ë€Œì—ˆëŠ”ì§€â€ë¥¼ ì ì–´ë‘˜ ìˆ˜ ìˆì–´.</div>
      <textarea id="historyNoteTextarea" class="note-modal-textarea" placeholder="ì˜ˆ: ê²¹ì¹¨ ì´ìŠˆë¡œ 4-2-1.6ë²ˆìœ¼ë¡œ ì´ë™"></textarea>
      <div class="note-modal-actions">
        <button class="btn btn-secondary btn-small" id="historyNoteCancelBtn">ì·¨ì†Œ</button>
        <button class="btn btn-primary btn-small" id="historyNoteSaveBtn">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ì‹¤ì œ ì•± -->
  <div id="appContainer" style="display:none;">
    <div class="app-header">
      <div class="title-wrap">
        <div class="app-title">FILM FIND</div>
        <div class="app-subtitle" id="appSubtitle">í•„ë¦„/íŒ ê´€ë¦¬</div>
      </div>
      <div id="deviceBadge" class="device-badge">
        <span class="device-dot"></span>
        <span id="deviceBadgeText"></span>
        <span id="modeChip" class="mode-chip">MODE</span>
      </div>
    </div>

    <div class="app-shell">
      <div class="top-bar">
        <input type="text" id="searchInput" placeholder="ê²€ìƒ‰: ì œí’ˆëª… / í•„ë¦„ë²ˆí˜¸ / íŒë²ˆí˜¸ / ì œíŒíƒ€ì… / ìœ„ì¹˜ / MESH / ì¸ì‡„ì" />
        <button class="btn btn-primary" id="newFilmBtn">+ ìƒˆ í•„ë¦„</button>
      </div>

      <!-- âœ… íƒ­/ë·° í† ê¸€ ë¶„ë¦¬(ê°€ë…ì„± ê°œì„ ) -->
      <div class="seg-bar">
        <div class="seg-left">
          <div class="seg-tabs" id="segTabs">
            <button class="seg-tab" id="tabFilmsBtn">í•„ë¦„</button>
            <button class="seg-tab" id="tabPlatesBtn">íŒ</button>
          </div>
        </div>
        <div style="display:flex; gap:6px; align-items:center;">
          <button class="btn btn-secondary btn-small" id="viewToggleBtn">ê°¤ëŸ¬ë¦¬</button>
        </div>
      </div>

      <div class="tools-bar">
        <button class="btn btn-secondary btn-small" id="settingsBtn">âš™ ì„¤ì •</button>
        <button class="btn btn-secondary btn-small" id="historyBtn">ğŸ“œ íˆìŠ¤í† ë¦¬</button>
        <button class="btn btn-secondary btn-small" id="exportBtn">ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
        <button class="btn btn-secondary btn-small" id="importBtn">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <input type="file" id="importFile" accept="application/json" style="display:none;" />
      </div>

      <div class="count-wrap">
        <div id="countBar" class="count-bar">ì´ 0ê°œ</div>
      </div>

      <!-- ì„¤ì • -->
      <div class="form-card" id="settingsCard" style="display:none;">
        <div class="form-row">
          <div class="settings-section-title">ì´ ê¸°ê¸° ì´ë¦„</div>
          <div class="settings-help">ì˜ˆ: ê°€ì€í°, ì„±ê·œíŒ¨ë“œ, íšŒì‚¬PC. ì´ ê¸°ê¸°ì—ì„œë§Œ í‘œì‹œë¼.</div>
          <input type="text" id="deviceNameInput" placeholder="ê¸°ê¸° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" />
        </div>

        <div class="form-row">
          <div class="settings-section-title">ê¸°ë³¸ ì •ë ¬ ë°©ì‹</div>
          <div class="settings-help">ë¦¬ìŠ¤íŠ¸ë¥¼ ì–´ë–¤ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í• ì§€ ì„ íƒí•´.</div>
          <select id="sortOptionSelect">
            <option value="updated">ìµœê·¼ ìˆ˜ì •ìˆœ</option>
            <option value="name">ì œí’ˆëª… ê°€ë‚˜ë‹¤ìˆœ</option>
            <option value="number">ë²ˆí˜¸(í•„ë¦„/íŒ) ìˆœ</option>
            <option value="lastUsed">ë§ˆì§€ë§‰ ì‚¬ìš© ìµœì‹ ìˆœ</option>
          </select>
        </div>

        <div class="form-row">
          <div class="settings-section-title">í…Œë§ˆ ìƒ‰ìƒ</div>
          <div class="settings-help">ì•±ì˜ ìƒ‰ ë¶„ìœ„ê¸°ë¥¼ ì„ íƒí•´ ì¤˜.</div>
          <select id="themeSelect">
            <option value="default">ë¼ë²¤ë”</option>
            <option value="mint">ë¯¼íŠ¸</option>
            <option value="peach">í”¼ì¹˜</option>
            <option value="night">ë‚˜ì´íŠ¸</option>
          </select>
        </div>

        <!-- ê´€ë¦¬ìë§Œ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ -->
        <div class="form-row" id="pwSection" style="display:none;">
          <div class="settings-section-title">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</div>
          <div class="settings-help">ëª¨ë“œë³„ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆì–´. (ê´€ë¦¬ìë§Œ)</div>

          <input type="password" id="pwAdminNew" placeholder="ê´€ë¦¬ì ëª¨ë“œ ìƒˆ ë¹„ë°€ë²ˆí˜¸" />
          <input type="password" id="pwPrinterNew" placeholder="ì¸ì‡„ê¸°ì‚¬ ëª¨ë“œ ìƒˆ ë¹„ë°€ë²ˆí˜¸" style="margin-top:6px;" />
          <input type="password" id="pwViewerNew" placeholder="ì¡°íšŒ ëª¨ë“œ ìƒˆ ë¹„ë°€ë²ˆí˜¸" style="margin-top:6px;" />
        </div>

        <!-- âœ… ê´€ë¦¬ì ì „ìš©: íœ´ì§€í†µ -->
        <div class="form-row" id="trashSection" style="display:none;">
          <div class="settings-section-title">íœ´ì§€í†µ (íŒ)</div>
          <div class="settings-help">íŒ ì‚­ì œ ì‹œ íœ´ì§€í†µìœ¼ë¡œ ì´ë™í•´. ìµœëŒ€ 50ê°œ ìœ ì§€(ì´ˆê³¼ ì‹œ ì˜¤ë˜ëœ ê²ƒë¶€í„° ìë™ ì‚­ì œ).</div>
          <div class="trash-box" id="trashList"></div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary btn-small" id="closeSettingsBtn">ë‹«ê¸°</button>
          <button type="button" class="btn btn-primary btn-small" id="saveSettingsBtn">ì €ì¥</button>
        </div>
      </div>

      <!-- íˆìŠ¤í† ë¦¬ -->
      <div class="form-card" id="historyCard" style="display:none;">
        <div class="settings-section-title">ğŸ“œ íˆìŠ¤í† ë¦¬</div>
        <div class="settings-help">ë“±ë¡ / ìˆ˜ì • / ì‚­ì œ / ì‚¬ìš©ë“±ë¡ ê¸°ë¡(ìµœê·¼ 100ê°œ)</div>
        <div id="historyList" class="history-list"></div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary btn-small" id="closeHistoryBtn">ë‹«ê¸°</button>
        </div>
      </div>

      <!-- í•„ë¦„ ì…ë ¥ í¼ -->
      <div class="form-card" id="filmFormCard" style="display:none;">
        <form id="filmForm">
          <input type="hidden" id="filmId" />
          <div class="form-row">
            <label for="productName">ì œí’ˆ ì´ë¦„ *</label>
            <input type="text" id="productName" required />
          </div>
          <div class="form-row">
            <label for="filmNumber">í•„ë¦„ ë²ˆí˜¸ *</label>
            <input type="text" id="filmNumber" required />
          </div>
          <div class="form-row">
            <label for="method">ì œíŒ íƒ€ì…</label>
            <input type="text" id="method" placeholder="ì˜ˆ: ë°”íƒ•, ë¬¸ì, ìŠ¤ëª¨ê·¸ ë“±" />
          </div>
          <div class="form-row">
            <label for="mesh">MESH</label>
            <input type="text" id="mesh" placeholder="ì˜ˆ: 180T, 200ë©”ì‰¬ ë“±" />
          </div>

          <div class="form-row">
            <label>í•„ë¦„ ì œíŒ ë°©ë²•</label>
            <div class="toggle-group" data-group="frontBack">
              <button type="button" class="toggle-btn" data-value="ì „ë©´">ì „ë©´</button>
              <button type="button" class="toggle-btn" data-value="ë°°ë©´">ë°°ë©´</button>
            </div>
            <div class="toggle-group" data-group="leftRight">
              <button type="button" class="toggle-btn" data-value="ì¢Œ">ì¢Œ</button>
              <button type="button" class="toggle-btn" data-value="ìš°">ìš°</button>
            </div>
            <div class="toggle-group" data-group="upDown">
              <button type="button" class="toggle-btn" data-value="ìƒ">ìƒ</button>
              <button type="button" class="toggle-btn" data-value="í•˜">í•˜</button>
            </div>
            <small style="font-size:11px; color:var(--text-sub);">
              ì „ë©´/ë°°ë©´ + ì¢Œ/ìš° + ìƒ/í•˜ ì¡°í•© (ì˜ˆ: ë°°ë©´ ì¢Œ ìƒ)
            </small>
          </div>

          <div class="form-row">
            <label for="location">í•„ë¦„ ìœ„ì¹˜</label>
            <input type="text" id="location" placeholder="ì˜ˆ: A-3 ì„œë, 4ì¸µ ìš°ì¸¡ ë™ ë“±" />
          </div>

          <div class="form-row">
            <label for="lastUsed">ë§ˆì§€ë§‰ ì‚¬ìš©ì¼</label>
            <div style="display:flex; gap:6px;">
              <input type="date" id="lastUsed" style="flex:1;" />
              <button type="button" class="btn btn-secondary btn-small" id="setTodayBtn">ì˜¤ëŠ˜</button>
            </div>
          </div>

          <div class="form-row">
            <label for="imageInput">í•„ë¦„ ì‚¬ì§„ (ì„ íƒ)</label>
            <input type="file" id="imageInput" accept="image/*" />
            <small style="font-size:11px; color:var(--text-sub);">
              Â· ìƒˆ í•„ë¦„ì—ëŠ” ì‚¬ì§„ì„ ì¶”ê°€í•˜ê³ ,<br/>
              Â· ìˆ˜ì • ì‹œ ì‚¬ì§„ì„ ë°”ê¾¸ê³  ì‹¶ì„ ë•Œë§Œ ë‹¤ì‹œ ì„ íƒí•˜ì„¸ìš”.
            </small>

            <div id="imagePreviewWrapper" style="margin-top:8px; display:none; align-items:center; gap:6px;">
              <img id="imagePreview" alt="ë¯¸ë¦¬ë³´ê¸°"
                   style="width:70px; height:70px; border-radius:10px; object-fit:cover; background:#eef1ff;" />
              <button type="button" class="btn btn-secondary btn-small" id="rotateLeftBtn">âŸ² 90Â°</button>
              <button type="button" class="btn btn-secondary btn-small" id="rotateRightBtn">âŸ³ 90Â°</button>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="filmCancelBtn">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn-primary" id="filmSaveBtn">ì €ì¥</button>
          </div>
        </form>
      </div>

      <!-- íŒ ë“±ë¡/ìˆ˜ì • í¼ -->
      <div class="form-card" id="plateFormCard" style="display:none;">
        <form id="plateForm">
          <input type="hidden" id="plateId" />
          <input type="hidden" id="plateFilmId" />
          <div class="form-row">
            <div class="settings-section-title">ì›ë³¸ í•„ë¦„</div>
            <div class="settings-help" id="plateInheritText">-</div>
          </div>

          <div class="form-row">
            <label for="plateNumber">íŒ ë²ˆí˜¸ *</label>
            <input type="text" id="plateNumber" required placeholder="ì˜ˆ: 0000-1" />
          </div>
          <div class="form-row">
            <label for="tension">í…ì…˜</label>
            <input type="text" id="tension" placeholder="ì˜ˆ: 23~25" />
          </div>
          <div class="form-row">
            <label for="plateLocation">íŒ ìœ„ì¹˜</label>
            <input type="text" id="plateLocation" placeholder="ì˜ˆ: 4ì¸µ ë™ 2ë²ˆ" />
          </div>
          <div class="form-row">
            <label for="plateMesh">MESH (í•„ìš” ì‹œ ìˆ˜ì •)</label>
            <input type="text" id="plateMesh" placeholder="ì˜ˆ: 180T" />
          </div>

          <div class="form-row">
            <label for="maxUsage">ê¸°ë³¸ ìµœëŒ€ ì‚¬ìš© ìˆ˜ëŸ‰</label>
            <input type="number" id="maxUsage" min="1" step="1" />
            <small style="font-size:11px; color:var(--text-sub);">ê¸°ë³¸ 5000 ìë™ ì„¸íŒ…</small>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="plateCancelBtn">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn-primary" id="plateSaveBtn">ì €ì¥</button>
          </div>
        </form>
      </div>

      <div id="list" class="list"></div>
      <div id="emptyText" class="empty-text" style="display:none;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>

      <div id="loadingSpinner" class="spinner-wrapper">
        <div class="spinner-circle"></div>
      </div>
    </div>
  </div>

  <button id="scrollTopBtn" class="scroll-top-btn">â†‘</button>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <script>
    /* =========================
      Firebase ì„¤ì •
    ========================= */
    const firebaseConfig = {
      apiKey: "AIzaSyBrBnVuXca2Ou1oMFOLzq3KGEN8xiK5L_U",
      authDomain: "film-find-5242d.firebaseapp.com",
      projectId: "film-find-5242d",
      storageBucket: "film-find-5242d.firebasestorage.app",
      messagingSenderId: "185123433624",
      appId: "1:185123433624:web:269eb9b4b6437887f2f4ed",
      measurementId: "G-V9KL8XS9KJ"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const FILM_COLLECTION = "films";
    const PLATE_COLLECTION = "plates";
    const HISTORY_COLLECTION = "history";
    const TRASH_COLLECTION = "trash_plates";

    const MODE = { ADMIN: "admin", PRINTER: "printer", VIEWER: "viewer" };
    const UNLOCK_KEY = "filmAppUnlocked";
    const DEVICE_KEY = "filmDeviceLabel";
    const SORT_KEY = "filmSortOption";
    const THEME_KEY = "filmTheme";
    const VIEW_KEY = "filmViewMode";
    const TAB_KEY = "filmTab";

    const PW_ADMIN_KEY = "pw_admin";
    const PW_PRINTER_KEY = "pw_printer";
    const PW_VIEWER_KEY = "pw_viewer";

    /* âœ… ì¸ì‡„ê¸°ì‚¬ ì´ë¦„ ëª©ë¡(ë¡œì»¬ ì €ì¥) */
    const PRINTER_NAMES_KEY = "filmPrinterNames";

    const DEFAULT_PW = { admin: "0605", printer: "1234", viewer: "0000" };
    function ensureDefaultPasswords() {
      if (!localStorage.getItem(PW_ADMIN_KEY)) localStorage.setItem(PW_ADMIN_KEY, DEFAULT_PW.admin);
      if (!localStorage.getItem(PW_PRINTER_KEY)) localStorage.setItem(PW_PRINTER_KEY, DEFAULT_PW.printer);
      if (!localStorage.getItem(PW_VIEWER_KEY)) localStorage.setItem(PW_VIEWER_KEY, DEFAULT_PW.viewer);
    }
    function getPasswords() {
      return {
        admin: localStorage.getItem(PW_ADMIN_KEY) || DEFAULT_PW.admin,
        printer: localStorage.getItem(PW_PRINTER_KEY) || DEFAULT_PW.printer,
        viewer: localStorage.getItem(PW_VIEWER_KEY) || DEFAULT_PW.viewer,
      };
    }

    function getPrinterNames() {
      try {
        const raw = localStorage.getItem(PRINTER_NAMES_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    }
    function setPrinterNames(arr) {
      const uniq = Array.from(new Set((arr || []).map(x => String(x||"").trim()).filter(Boolean)));
      localStorage.setItem(PRINTER_NAMES_KEY, JSON.stringify(uniq));
    }
    function ensureDefaultPrinterNames() {
      const names = getPrinterNames();
      if (!names.length) setPrinterNames(["ì„±ê·œ"]);
    }

    /* =========================
      ìƒíƒœ
    ========================= */
    let currentMode = MODE.VIEWER;
    let films = [];
    let plates = [];
    let currentSearchText = "";
    let unsubscribeFilms = null;
    let unsubscribePlates = null;

    let historyEntries = [];
    let historyLoaded = false;

    const VISIBLE_STEP = 30;
    let visibleCount = VISIBLE_STEP;

    let currentViewMode = localStorage.getItem(VIEW_KEY) || "list";
    let currentTab = localStorage.getItem(TAB_KEY) || "films"; // films | plates

    // ì´ë¯¸ì§€ ì„ íƒ/íšŒì „
    let currentSelectedImageDataUrl = null;
    let currentImageRotation = 0;

    // ë©”ëª¨ ì‹œíŠ¸
    let currentMemoTarget = null; // {type:'film'|'plate', id}
    let currentHistoryNoteId = null;
    let currentUsagePlateId = null;

    /* =========================
      ìœ í‹¸
    ========================= */
    function showToast(msg) {
      const toast = document.getElementById("toast");
      if (!toast) return;
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 1800);
    }

    function todayISO() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }
    function formatDate(iso) { return iso || "-"; }
    function formatTS(ts) {
      const d = new Date(ts || 0);
      if (isNaN(d.getTime())) return "-";
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return `${y}-${m}-${day} ${hh}:${mm}`;
    }

    function getDeviceLabel() { return localStorage.getItem(DEVICE_KEY) || ""; }
    function setDeviceLabel(label) {
      localStorage.setItem(DEVICE_KEY, label);
      const badgeText = document.getElementById("deviceBadgeText");
      if (badgeText) badgeText.textContent = label || "ê¸°ê¸° ë¯¸ì§€ì •";
    }
    function getTheme() { return localStorage.getItem(THEME_KEY) || "default"; }
    function setTheme(theme) {
      localStorage.setItem(THEME_KEY, theme);
      const root = document.documentElement;
      if (theme === "default") root.removeAttribute("data-theme");
      else root.setAttribute("data-theme", theme);
    }
    function getSortOption() { return localStorage.getItem(SORT_KEY) || "updated"; }
    function setSortOption(opt) { localStorage.setItem(SORT_KEY, opt); }

    function setViewMode(mode) {
      currentViewMode = mode;
      localStorage.setItem(VIEW_KEY, mode);
      applyViewMode();
    }
    function setTab(tab) {
      currentTab = tab;
      localStorage.setItem(TAB_KEY, tab);
      applyTabVisibility();
      renderList(currentSearchText);
    }

    /* =========================
      ê¶Œí•œ
    ========================= */
    function canEditFilms() { return currentMode === MODE.ADMIN; }
    function canViewFilms() { return currentMode === MODE.ADMIN || currentMode === MODE.VIEWER; }
    function canViewPlates() { return true; }
    function canEditPlates() { return currentMode === MODE.ADMIN; }
    function canDeletePlates() { return currentMode === MODE.ADMIN; }
    function canRegisterUsage() { return currentMode === MODE.ADMIN || currentMode === MODE.PRINTER; }
    function canChangePasswords() { return currentMode === MODE.ADMIN; }
    function canAccessTrash() { return currentMode === MODE.ADMIN; }

    function setModeUI() {
      const modeChip = document.getElementById("modeChip");
      const subtitle = document.getElementById("appSubtitle");
      const newFilmBtn = document.getElementById("newFilmBtn");

      if (modeChip) {
        if (currentMode === MODE.ADMIN) modeChip.textContent = "ê´€ë¦¬ì";
        if (currentMode === MODE.PRINTER) modeChip.textContent = "ì¸ì‡„ê¸°ì‚¬";
        if (currentMode === MODE.VIEWER) modeChip.textContent = "ì¡°íšŒ";
      }
      if (subtitle) {
        if (currentMode === MODE.ADMIN) subtitle.textContent = "í•„ë¦„/íŒ ê´€ë¦¬ (ê´€ë¦¬ì)";
        if (currentMode === MODE.PRINTER) subtitle.textContent = "íŒ ê´€ë¦¬ (ì¸ì‡„ê¸°ì‚¬)";
        if (currentMode === MODE.VIEWER) subtitle.textContent = "í•„ë¦„/íŒ ì¡°íšŒ (ê±°ë˜ì²˜)";
      }

      if (newFilmBtn) {
        newFilmBtn.style.display = (currentMode === MODE.ADMIN) ? "inline-flex" : "none";
      }

      applyTabVisibility();
    }

    function applyTabVisibility() {
      const tabFilmsBtn = document.getElementById("tabFilmsBtn");
      const tabPlatesBtn = document.getElementById("tabPlatesBtn");

      // ì¸ì‡„ê¸°ì‚¬: í•„ë¦„ íƒ­ ìˆ¨ê¸°ê³  íŒë§Œ
      if (currentMode === MODE.PRINTER) {
        if (tabFilmsBtn) tabFilmsBtn.style.display = "none";
        if (tabPlatesBtn) tabPlatesBtn.style.display = "inline-flex";
        currentTab = "plates";
        localStorage.setItem(TAB_KEY, "plates");
      } else {
        if (tabFilmsBtn) tabFilmsBtn.style.display = "inline-flex";
        if (tabPlatesBtn) tabPlatesBtn.style.display = "inline-flex";
      }

      // âœ… ì„¸ê·¸ íƒ­ active í‘œì‹œ
      if (tabFilmsBtn) tabFilmsBtn.classList.toggle("active", currentTab === "films");
      if (tabPlatesBtn) tabPlatesBtn.classList.toggle("active", currentTab === "plates");
    }

    /* =========================
      ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°/íšŒì „
    ========================= */
    function resetImagePreview() {
      const wrapper = document.getElementById("imagePreviewWrapper");
      const img = document.getElementById("imagePreview");
      currentSelectedImageDataUrl = null;
      currentImageRotation = 0;
      if (img) { img.src = ""; img.style.transform = "rotate(0deg)"; }
      if (wrapper) wrapper.style.display = "none";
    }
    function applyPreviewRotation() {
      const img = document.getElementById("imagePreview");
      if (!img) return;
      img.style.transform = "rotate(" + currentImageRotation + "deg)";
    }

    /* =========================
      Firestore ë¦¬ìŠ¤ë„ˆ
    ========================= */
    function startFilmsListener() {
      if (unsubscribeFilms) unsubscribeFilms();
      unsubscribeFilms = db.collection(FILM_COLLECTION).onSnapshot(
        (snapshot) => {
          films = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
          renderList(currentSearchText);
        },
        (error) => {
          console.error("films sync error:", error);
          showToast("ì„œë²„ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´.");
        }
      );
    }

    function startPlatesListener() {
      if (unsubscribePlates) unsubscribePlates();
      unsubscribePlates = db.collection(PLATE_COLLECTION).onSnapshot(
        (snapshot) => {
          plates = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
          renderList(currentSearchText);
        },
        (error) => {
          console.error("plates sync error:", error);
          showToast("ì„œë²„ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´.");
        }
      );
    }

    /* =========================
      íˆìŠ¤í† ë¦¬
    ========================= */
    async function addHistory({ type, targetId, label, action, changes = [] }) {
      try {
        const entry = {
          type,
          targetId: targetId || null,
          label: (label || "").trim(),
          action: action || "",
          deviceName: getDeviceLabel() || "",
          timestamp: Date.now(),
          changes,
        };
        await db.collection(HISTORY_COLLECTION).add(entry);
        if (historyLoaded) await loadHistory();
      } catch (e) {
        console.error("history add error:", e);
      }
    }

    async function loadHistory() {
      try {
        const snap = await db.collection(HISTORY_COLLECTION).orderBy("timestamp", "desc").limit(100).get();
        historyEntries = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
        historyLoaded = true;
        renderHistory();
      } catch (e) {
        console.error("history load error:", e);
        showToast("íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´.");
      }
    }

    function actionLabel(action) {
      if (action === "ë“±ë¡") return "ë“±ë¡";
      if (action === "ìˆ˜ì •") return "ìˆ˜ì •";
      if (action === "ì‚­ì œ") return "ì‚­ì œ";
      if (action === "ì‚¬ìš©ë“±ë¡") return "ì‚¬ìš©ë“±ë¡";
      return action || "ë³€ê²½";
    }

    /* âœ… (1) íˆìŠ¤í† ë¦¬ label '-' ë°©ì§€: targetId ê¸°ë°˜ ìë™ ë³´ì • */
    function resolveHistoryLabel(entry) {
      const raw = String(entry.label || "").trim();
      if (raw && raw !== "-") return raw;

      const tid = entry.targetId;
      if (!tid) return "-";

      if (entry.type === "film") {
        const f = films.find(x => x.id === tid);
        if (f) return `${f.filmNumber || "-"} (${f.productName || "-"})`;
      }
      if (entry.type === "plate" || entry.type === "usage") {
        const p = plates.find(x => x.id === tid);
        if (p) return `${p.plateNumber || "-"} (${p.productName || "-"})`;
      }
      return "-";
    }

    function renderHistory() {
      const list = document.getElementById("historyList");
      if (!list) return;
      list.innerHTML = "";

      if (!historyEntries.length) {
        const empty = document.createElement("div");
        empty.className = "history-empty";
        empty.textContent = "ì•„ì§ ê¸°ë¡ì´ ì—†ì–´.";
        list.appendChild(empty);
        return;
      }

      historyEntries.forEach((entry) => {
        const row = document.createElement("div");
        row.className = "history-row";

        const ts = formatTS(entry.timestamp);
        const device = entry.deviceName || "ê¸°ê¸° ë¯¸ì§€ì •";
        const changesArr = Array.isArray(entry.changes) ? entry.changes : [];
        const noteText = (entry.note || "").trim();
        const typeLabel = entry.type === "film" ? "í•„ë¦„" : (entry.type === "plate" ? "íŒ" : "ì‚¬ìš©");

        const label = resolveHistoryLabel(entry);

        row.innerHTML =
          `<div class="history-headline">` +
            `<div>` +
              `<span class="history-time">${ts}</span>` +
              `<span class="history-device">${device}</span>` +
              `<span class="history-action-chip">${typeLabel} Â· ${actionLabel(entry.action)}</span>` +
            `</div>` +
            `<button class="history-pencil" data-id="${entry.id}">âœï¸</button>` +
          `</div>` +
          `<div class="history-film">${label}</div>` +
          (changesArr.length ? `<div class="history-changes">ë³€ê²½ í•­ëª©: ${changesArr.join(", ")}</div>` : "") +
          (noteText ? `<div class="history-note">${noteText}</div>` : "");

        row.querySelector(".history-pencil").addEventListener("click", () => openHistoryNoteModal(entry.id));
        list.appendChild(row);
      });
    }

    function openHistoryCard() {
      const card = document.getElementById("historyCard");
      const isOpen = card.style.display === "block";
      closeAllPanels();
      if (!isOpen) {
        card.style.display = "block";
        if (!historyLoaded) loadHistory(); else renderHistory();
      }
    }
    function closeHistoryCard() { document.getElementById("historyCard").style.display = "none"; }

    function openHistoryNoteModal(historyId) {
      const entry = historyEntries.find((h) => h.id === historyId);
      if (!entry) return;
      currentHistoryNoteId = historyId;
      document.getElementById("historyNoteTextarea").value = entry.note || "";
      document.getElementById("historyNoteModal").classList.add("show");
    }
    function closeHistoryNoteModal() {
      document.getElementById("historyNoteModal").classList.remove("show");
      currentHistoryNoteId = null;
    }
    async function saveHistoryNoteModal() {
      if (!currentHistoryNoteId) return;
      const note = (document.getElementById("historyNoteTextarea").value || "").trim();
      try {
        await db.collection(HISTORY_COLLECTION).doc(currentHistoryNoteId).set({ note }, { merge: true });
        const idx = historyEntries.findIndex((h) => h.id === currentHistoryNoteId);
        if (idx >= 0) historyEntries[idx].note = note;
        renderHistory();
        showToast("íˆìŠ¤í† ë¦¬ ë©”ëª¨ ì €ì¥ë¨.");
        closeHistoryNoteModal();
      } catch (e) {
        console.error(e);
        showToast("íˆìŠ¤í† ë¦¬ ë©”ëª¨ ì €ì¥ ì¤‘ ì˜¤ë¥˜.");
      }
    }

    /* =========================
      í•„ë¦„/íŒ ë©”ëª¨
    ========================= */
    function openMemoSheet(type, id) {
      currentMemoTarget = { type, id };
      const sheet = document.getElementById(type === "film" ? "memoSheet" : "plateMemoSheet");

      if (type === "film") {
        const f = films.find(x => x.id === id);
        if (!f) return;
        document.getElementById("memoSheetTitle").textContent = `ë©”ëª¨ Â· ${f.filmNumber || ""}`;
        document.getElementById("memoSheetSub").textContent = f.productName || "í•„ë¦„ë³„ ë©”ëª¨";
        document.getElementById("memoTextarea").value = f.memo || "";
      } else {
        const p = plates.find(x => x.id === id);
        if (!p) return;
        document.getElementById("plateMemoTitle").textContent = `íŒ ë©”ëª¨ Â· ${p.plateNumber || ""}`;
        document.getElementById("plateMemoSub").textContent = (p.productName || p.filmNumber) ? `${p.productName || ""} ${p.filmNumber ? "(" + p.filmNumber + ")" : ""}` : "íŒë³„ ë©”ëª¨";
        document.getElementById("plateMemoTextarea").value = p.memo || "";
      }

      sheet.classList.add("show");
    }

    function closeMemoSheets() {
      document.getElementById("memoSheet").classList.remove("show");
      document.getElementById("plateMemoSheet").classList.remove("show");
      currentMemoTarget = null;
    }

    async function saveMemoSheet() {
      if (!currentMemoTarget) return;
      const { type, id } = currentMemoTarget;
      const memo = (type === "film"
        ? (document.getElementById("memoTextarea").value || "")
        : (document.getElementById("plateMemoTextarea").value || "")
      ).trim();

      try {
        const col = type === "film" ? FILM_COLLECTION : PLATE_COLLECTION;
        await db.collection(col).doc(id).set({ memo, updatedAt: Date.now() }, { merge: true });
        showToast("ë©”ëª¨ë¥¼ ì €ì¥í–ˆì–´.");
        closeMemoSheets();
      } catch (e) {
        console.error(e);
        showToast("ë©”ëª¨ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë‚¬ì–´.");
      }
    }

    /* =========================
      ì œíŒ ë°©ë²• í† ê¸€
    ========================= */
    function clearPlateInfoForm() { document.querySelectorAll(".toggle-btn").forEach(btn => btn.classList.remove("active")); }
    function setPlateInfoToForm(str) {
      clearPlateInfoForm();
      if (!str) return;
      const parts = str.split(" ");
      document.querySelectorAll(".toggle-btn").forEach(btn => {
        if (parts.includes(btn.dataset.value)) btn.classList.add("active");
      });
    }
    function getPlateInfoFromForm() {
      const groups = document.querySelectorAll(".toggle-group");
      const values = [];
      groups.forEach(group => {
        const active = group.querySelector(".toggle-btn.active");
        if (active) values.push(active.dataset.value);
      });
      return values.join(" ");
    }

    /* =========================
      íŒ¨ë„ ê³µí†µ
    ========================= */
    function closeAllPanels() {
      document.getElementById("settingsCard").style.display = "none";
      document.getElementById("historyCard").style.display = "none";
      document.getElementById("filmFormCard").style.display = "none";
      document.getElementById("plateFormCard").style.display = "none";
    }

    /* =========================
      í•„ë¦„ í¼
    ========================= */
    function resetFilmForm() {
      document.getElementById("filmId").value = "";
      document.getElementById("productName").value = "";
      document.getElementById("filmNumber").value = "";
      document.getElementById("method").value = "";
      document.getElementById("mesh").value = "";
      document.getElementById("location").value = "";
      document.getElementById("lastUsed").value = "";
      document.getElementById("imageInput").value = "";
      clearPlateInfoForm();
      resetImagePreview();
    }

    function openFilmFormNew() {
      if (!canEditFilms()) return;
      resetFilmForm();
      closeAllPanels();
      document.getElementById("filmFormCard").style.display = "block";
      document.getElementById("productName").focus();
    }

    function openFilmFormEdit(id) {
      if (!canEditFilms()) return;
      const film = films.find(f => f.id === id);
      if (!film) return;

      closeAllPanels();
      resetImagePreview();
      document.getElementById("filmId").value = film.id;
      document.getElementById("productName").value = film.productName || "";
      document.getElementById("filmNumber").value = film.filmNumber || "";
      document.getElementById("method").value = film.method || "";
      document.getElementById("mesh").value = film.mesh || "";
      document.getElementById("location").value = film.location || "";
      document.getElementById("lastUsed").value = film.lastUsed || "";
      setPlateInfoToForm(film.plateInfo || "");
      document.getElementById("filmFormCard").style.display = "block";
      document.getElementById("productName").focus();

      // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°(ê¸°ì¡´ ì´ë¯¸ì§€ ë³´ì´ê¸° ì›í•˜ë©´ ì—¬ê¸°ì—ì„œ ë¶™ì¼ ìˆ˜ ìˆëŠ”ë°, í˜„ì¬ êµ¬ì¡°ëŠ” "ìˆ˜ì • ì‹œ ìƒˆ ì„ íƒë§Œ"ì´ë¼ ìœ ì§€)
    }

    function closeFilmForm() {
      document.getElementById("filmFormCard").style.display = "none";
      resetFilmForm();
    }

    /* ì´ë¯¸ì§€ ì••ì¶•(íšŒì „ í¬í•¨) */
    function compressImage(dataUrl, rotationDeg, callback) {
      const img = new Image();
      img.onload = function () {
        const maxSize = 700;
        let w = img.width, h = img.height;
        const ratio = Math.min(maxSize / w, maxSize / h, 1);
        let drawW = Math.round(w * ratio);
        let drawH = Math.round(h * ratio);

        const rot = ((rotationDeg % 360) + 360) % 360;
        let canvasW = drawW, canvasH = drawH;
        if (rot === 90 || rot === 270) { canvasW = drawH; canvasH = drawW; }

        const canvas = document.createElement("canvas");
        canvas.width = canvasW; canvas.height = canvasH;
        const ctx = canvas.getContext("2d");
        ctx.translate(canvasW / 2, canvasH / 2);
        ctx.rotate((rot * Math.PI) / 180);
        ctx.drawImage(img, -drawW / 2, -drawH / 2, drawW, drawH);

        const compressed = canvas.toDataURL("image/jpeg", 0.7);
        callback(compressed);
      };
      img.onerror = () => callback(dataUrl);
      img.src = dataUrl;
    }

    async function saveFilmFromForm(event) {
      if (event) event.preventDefault();
      if (!canEditFilms()) return;

      const id = document.getElementById("filmId").value || null;
      const productName = document.getElementById("productName").value.trim();
      const filmNumber = document.getElementById("filmNumber").value.trim();
      const method = document.getElementById("method").value.trim();
      const mesh = document.getElementById("mesh").value.trim();
      const location = document.getElementById("location").value.trim();
      const lastUsed = document.getElementById("lastUsed").value || "";
      const plateInfo = getPlateInfoFromForm();
      const imageInput = document.getElementById("imageInput");

      if (!productName || !filmNumber) { alert("ì œí’ˆ ì´ë¦„ê³¼ í•„ë¦„ ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }

      const existing = id ? films.find((f) => f.id === id) : null;
      const baseData = { productName, filmNumber, method, mesh, location, lastUsed, plateInfo };

      async function finalizeSave(imageDataUrl) {
        try {
          if (id && existing) {
            const payload = { ...baseData, updatedAt: Date.now() };
            let imageChanged = false;
            if (imageDataUrl !== null) { payload.imageDataUrl = imageDataUrl; imageChanged = true; }

            const changes = [];
            if (existing.productName !== payload.productName) changes.push("ì œí’ˆ ì´ë¦„");
            if (existing.filmNumber !== payload.filmNumber) changes.push("í•„ë¦„ ë²ˆí˜¸");
            if ((existing.method||"") !== (payload.method||"")) changes.push("ì œíŒ íƒ€ì…");
            if ((existing.mesh||"") !== (payload.mesh||"")) changes.push("MESH");
            if ((existing.location||"") !== (payload.location||"")) changes.push("í•„ë¦„ ìœ„ì¹˜");
            if ((existing.lastUsed||"") !== (payload.lastUsed||"")) changes.push("ë§ˆì§€ë§‰ ì‚¬ìš©ì¼");
            if ((existing.plateInfo||"") !== (payload.plateInfo||"")) changes.push("ì œíŒ ë°©ë²•");
            if (imageChanged) changes.push("ì´ë¯¸ì§€");
            if (!changes.length) changes.push("ê¸°íƒ€");

            await db.collection(FILM_COLLECTION).doc(id).set(payload, { merge: true });
            await addHistory({ type:"film", targetId:id, label:`${payload.filmNumber} (${payload.productName})`, action:"ìˆ˜ì •", changes });
          } else {
            const payload = {
              ...baseData,
              imageDataUrl: imageDataUrl || "",
              createdAt: Date.now(),
              updatedAt: Date.now(),
              deviceName: getDeviceLabel() || "",
            };
            const ref = await db.collection(FILM_COLLECTION).add(payload);
            await addHistory({ type:"film", targetId:ref.id, label:`${payload.filmNumber} (${payload.productName})`, action:"ë“±ë¡", changes:["ë“±ë¡"] });
          }

          showToast("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
          document.getElementById("searchInput").value = "";
          currentSearchText = "";
          closeFilmForm();
          visibleCount = VISIBLE_STEP;
          window.scrollTo({ top: 0, behavior: "smooth" });
        } catch (e) {
          console.error(e);
          showToast("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´.");
        }
      }

      if (imageInput.files && imageInput.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
          currentSelectedImageDataUrl = e.target.result;
          compressImage(currentSelectedImageDataUrl, currentImageRotation, finalizeSave);
        };
        reader.readAsDataURL(imageInput.files[0]);
      } else {
        finalizeSave(id && existing ? null : "");
      }
    }

    async function deleteFilm(id) {
      if (!canEditFilms()) return;
      const film = films.find(f => f.id === id);
      if (!film) return;
      if (!confirm("ì´ í•„ë¦„ ì •ë³´ë¥¼ ì‚­ì œí• ê¹Œìš”?\n(ì—°ê²°ëœ íŒì€ ìœ ì§€ë©ë‹ˆë‹¤.)")) return;
      try {
        await db.collection(FILM_COLLECTION).doc(id).delete();
        await addHistory({ type:"film", targetId:id, label:`${film.filmNumber} (${film.productName})`, action:"ì‚­ì œ", changes:["ì‚­ì œ"] });
        showToast("í•„ë¦„ ì‚­ì œ ì™„ë£Œ.");
      } catch (e) {
        console.error(e);
        showToast("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë‚¬ì–´.");
      }
    }

    /* =========================
      íŒ í¼
    ========================= */
    function resetPlateForm() {
      document.getElementById("plateId").value = "";
      document.getElementById("plateFilmId").value = "";
      document.getElementById("plateInheritText").textContent = "-";
      document.getElementById("plateNumber").value = "";
      document.getElementById("tension").value = "";
      document.getElementById("plateLocation").value = "";
      document.getElementById("plateMesh").value = "";
      document.getElementById("maxUsage").value = 5000;
    }

    async function getNextPlateIndex(filmId) {
      const snap = await db.collection(PLATE_COLLECTION).where("filmId", "==", filmId).get();
      let max = 0;
      snap.forEach(doc => {
        const d = doc.data();
        const idx = Number(d.plateIndex || 0);
        if (idx > max) max = idx;
      });
      return max + 1;
    }

    async function openPlateFormNewFromFilm(filmId) {
      if (!canEditPlates()) return;
      const film = films.find(f => f.id === filmId);
      if (!film) return;

      resetPlateForm();
      closeAllPanels();

      const nextIdx = await getNextPlateIndex(filmId);
      const autoPlateNumber = `${film.filmNumber || "FILM"}-${nextIdx}`;

      document.getElementById("plateFilmId").value = filmId;
      document.getElementById("plateNumber").value = autoPlateNumber;
      document.getElementById("plateMesh").value = film.mesh || "";
      document.getElementById("maxUsage").value = 5000;

      document.getElementById("plateInheritText").textContent =
        `ì œí’ˆ: ${film.productName || "-"} / í•„ë¦„: ${film.filmNumber || "-"} / MESH: ${film.mesh || "-"} / ì œíŒ: ${film.method || "-"} / ë°©ë²•: ${film.plateInfo || "-"}`;

      document.getElementById("plateFormCard").style.display = "block";
      document.getElementById("plateNumber").focus();
    }

    function openPlateFormEdit(plateId) {
      if (!canEditPlates()) return;
      const plate = plates.find(p => p.id === plateId);
      if (!plate) return;
      closeAllPanels();

      document.getElementById("plateId").value = plate.id;
      document.getElementById("plateFilmId").value = plate.filmId || "";
      document.getElementById("plateNumber").value = plate.plateNumber || "";
      document.getElementById("tension").value = plate.tension || "";
      document.getElementById("plateLocation").value = plate.plateLocation || "";
      document.getElementById("plateMesh").value = plate.mesh || "";
      document.getElementById("maxUsage").value = Number(plate.maxUsage || 5000);

      document.getElementById("plateInheritText").textContent =
        `ì œí’ˆ: ${plate.productName || "-"} / í•„ë¦„: ${plate.filmNumber || "-"} / (ìƒì† ì •ë³´)`;

      document.getElementById("plateFormCard").style.display = "block";
      document.getElementById("plateNumber").focus();
    }

    function closePlateForm() {
      document.getElementById("plateFormCard").style.display = "none";
      resetPlateForm();
    }

    async function savePlateFromForm(event) {
      if (event) event.preventDefault();
      if (!canEditPlates()) return;

      const plateId = document.getElementById("plateId").value || null;
      const filmId = document.getElementById("plateFilmId").value || "";
      const plateNumber = document.getElementById("plateNumber").value.trim();
      const tension = document.getElementById("tension").value.trim();
      const plateLocation = document.getElementById("plateLocation").value.trim();
      const mesh = document.getElementById("plateMesh").value.trim();
      const maxUsage = Number(document.getElementById("maxUsage").value || 5000);

      if (!filmId) { alert("í•„ë¦„ ì—°ê²° ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
      if (!plateNumber) { alert("íŒ ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }

      const film = films.find(f => f.id === filmId) || null;
      const existing = plateId ? plates.find(p => p.id === plateId) : null;

      const inherited = film ? {
        filmId: film.id,
        filmNumber: film.filmNumber || "",
        productName: film.productName || "",
        imageDataUrl: film.imageDataUrl || "",
        method: film.method || "",
        plateInfo: film.plateInfo || "",
      } : {
        filmId,
        filmNumber: (existing && existing.filmNumber) || "",
        productName: (existing && existing.productName) || "",
        imageDataUrl: (existing && existing.imageDataUrl) || "",
        method: (existing && existing.method) || "",
        plateInfo: (existing && existing.plateInfo) || "",
      };

      let plateIndex = existing ? Number(existing.plateIndex || 0) : 0;
      if (!existing) {
        const m = String(plateNumber).match(/-(\d+)\s*$/);
        plateIndex = m ? Number(m[1]) : 0;
      }

      const payloadBase = {
        ...inherited,
        plateNumber,
        plateIndex,
        tension,
        plateLocation,
        mesh,
        maxUsage: maxUsage > 0 ? maxUsage : 5000,
        updatedAt: Date.now(),
      };

      try {
        if (existing) {
          const changes = [];
          if ((existing.plateNumber||"") !== plateNumber) changes.push("íŒ ë²ˆí˜¸");
          if ((existing.tension||"") !== tension) changes.push("í…ì…˜");
          if ((existing.plateLocation||"") !== plateLocation) changes.push("íŒ ìœ„ì¹˜");
          if ((existing.mesh||"") !== mesh) changes.push("MESH");
          if (Number(existing.maxUsage||5000) !== payloadBase.maxUsage) changes.push("ìµœëŒ€ ì‚¬ìš©");
          if (!changes.length) changes.push("ê¸°íƒ€");

          await db.collection(PLATE_COLLECTION).doc(plateId).set(payloadBase, { merge: true });
          await addHistory({ type:"plate", targetId:plateId, label:`${plateNumber} (${payloadBase.productName || ""})`, action:"ìˆ˜ì •", changes });
        } else {
          const createPayload = {
            ...payloadBase,
            createdAt: Date.now(),
            usedTotal: 0,
            lastUsedAt: 0,
            lastUsedBy: "",
            lastUsedQty: 0,
            lastUsedMemo: "",
          };
          const ref = await db.collection(PLATE_COLLECTION).add(createPayload);
          await addHistory({ type:"plate", targetId:ref.id, label:`${plateNumber} (${createPayload.productName || ""})`, action:"ë“±ë¡", changes:["ë“±ë¡"] });
        }

        showToast("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        closePlateForm();
        visibleCount = VISIBLE_STEP;
        window.scrollTo({ top: 0, behavior: "smooth" });
      } catch (e) {
        console.error(e);
        showToast("íŒ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´.");
      }
    }

    /* =========================
      ì‚¬ìš©ë“±ë¡
    ========================= */
    function refreshPrinterNameSelect() {
      const sel = document.getElementById("usageBySelect");
      if (!sel) return;
      const names = getPrinterNames();
      const cur = sel.value;
      sel.innerHTML = `<option value="">ì„ íƒí•˜ì„¸ìš”</option>` + names.map(n => `<option value="${n}">${n}</option>`).join("");
      if (names.includes(cur)) sel.value = cur;
    }

    function openUsageSheet(plateId) {
      if (!canRegisterUsage()) return;
      const plate = plates.find(p => p.id === plateId);
      if (!plate) return;

      currentUsagePlateId = plateId;

      document.getElementById("usageTitle").textContent = `ì‚¬ìš© ë“±ë¡ Â· ${plate.plateNumber || ""}`;
      document.getElementById("usageSub").textContent = `${plate.productName || ""} ${plate.filmNumber ? "(" + plate.filmNumber + ")" : ""}`;
      document.getElementById("usageQty").value = "";
      document.getElementById("usageMemo").value = "";

      refreshPrinterNameSelect();
      document.getElementById("usageBySelect").value = "";

      document.getElementById("usageSheet").classList.add("show");
    }
    function closeUsageSheet() {
      document.getElementById("usageSheet").classList.remove("show");
      currentUsagePlateId = null;
    }

    async function saveUsage() {
      if (!currentUsagePlateId) return;
      if (!canRegisterUsage()) return;

      const by = (document.getElementById("usageBySelect").value || "").trim();
      const qty = Number(document.getElementById("usageQty").value || 0);
      const memo = (document.getElementById("usageMemo").value || "").trim();

      if (!by) { alert("ì¸ì‡„ê¸°ì‚¬ ì´ë¦„ì„ ì„ íƒí•´ ì£¼ì„¸ìš”."); return; }
      if (!qty || qty <= 0) { alert("ìˆ˜ëŸ‰ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }

      const plate = plates.find(p => p.id === currentUsagePlateId);
      if (!plate) { showToast("íŒ ì •ë³´ë¥¼ ì°¾ì§€ ëª»í–ˆì–´."); return; }

      const now = Date.now();
      const usageRef = db.collection(PLATE_COLLECTION).doc(currentUsagePlateId).collection("usage");
      const plateRef = db.collection(PLATE_COLLECTION).doc(currentUsagePlateId);

      try {
        await usageRef.add({
          by,
          qty,
          memo,
          timestamp: now,
          deviceName: getDeviceLabel() || "",
        });

        const usedTotal = Number(plate.usedTotal || 0) + qty;
        await plateRef.set({
          usedTotal,
          lastUsedAt: now,
          lastUsedBy: by,
          lastUsedQty: qty,
          lastUsedMemo: memo,
          updatedAt: now,
        }, { merge: true });

        // âœ… ì´ë¦„ ì €ì¥(ì„ íƒ ê¸°ë°˜ì´ì§€ë§Œ, í˜¹ì‹œ ëª©ë¡ì— ì—†ìœ¼ë©´ ìë™ ë°˜ì˜)
        const names = getPrinterNames();
        if (!names.includes(by)) {
          names.push(by);
          setPrinterNames(names);
        }

        await addHistory({
          type:"usage",
          targetId: currentUsagePlateId,
          label: `${plate.plateNumber || ""} Â· ${by} Â· ${qty}ê°œ`,
          action:"ì‚¬ìš©ë“±ë¡",
          changes: ["ì‚¬ìš©ë“±ë¡"],
        });

        showToast("ì‚¬ìš© ë“±ë¡ ì™„ë£Œ.");
        closeUsageSheet();
      } catch (e) {
        console.error(e);
        showToast("ì‚¬ìš© ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë‚¬ì–´.");
      }
    }

    async function openPlateUsageHistory(plateId) {
      const plate = plates.find(p => p.id === plateId);
      if (!plate) return;

      try {
        const snap = await db.collection(PLATE_COLLECTION).doc(plateId).collection("usage").orderBy("timestamp", "desc").limit(50).get();
        const arr = snap.docs.map(d => d.data());
        const lines = arr.map(u => `${formatTS(u.timestamp)} / ${u.by} / ${u.qty}ê°œ${u.memo ? " / " + u.memo : ""}`);
        alert(`íŒ ì‚¬ìš© íˆìŠ¤í† ë¦¬ (ìµœê·¼ 50ê°œ)\n\n${plate.plateNumber || ""}\n\n` + (lines.join("\n") || "(ê¸°ë¡ ì—†ìŒ)"));
      } catch (e) {
        console.error(e);
        showToast("ì‚¬ìš© íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´.");
      }
    }

    /* =========================
      íœ´ì§€í†µ (íŒ)
    ========================= */
    async function enforceTrashLimit() {
      try {
        const snap = await db.collection(TRASH_COLLECTION).orderBy("deletedAt", "desc").get();
        const docs = snap.docs;
        if (docs.length <= 50) return;
        const toDelete = docs.slice(50);
        for (const d of toDelete) {
          await db.collection(TRASH_COLLECTION).doc(d.id).delete();
        }
      } catch (e) {
        console.error("trash limit error:", e);
      }
    }

    async function deletePlateToTrash(plateId) {
      if (!canDeletePlates()) return;
      const plate = plates.find(p => p.id === plateId);
      if (!plate) return;
      if (!confirm("ì´ íŒì„ ì‚­ì œí• ê¹Œìš”?\n(íœ´ì§€í†µìœ¼ë¡œ ì´ë™)")) return;

      try {
        await db.collection(TRASH_COLLECTION).add({
          ...plate,
          originalId: plateId,
          deletedAt: Date.now(),
        });

        await db.collection(PLATE_COLLECTION).doc(plateId).delete();

        await addHistory({ type:"plate", targetId:plateId, label:`${plate.plateNumber || ""} (${plate.productName || ""})`, action:"ì‚­ì œ", changes:["íœ´ì§€í†µ ì´ë™"] });
        await enforceTrashLimit();
        showToast("íœ´ì§€í†µìœ¼ë¡œ ì´ë™í–ˆì–´.");
      } catch (e) {
        console.error(e);
        showToast("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë‚¬ì–´.");
      }
    }

    async function loadTrash() {
      if (!canAccessTrash()) return;
      const list = document.getElementById("trashList");
      if (!list) return;
      list.innerHTML = "";

      try {
        const snap = await db.collection(TRASH_COLLECTION).orderBy("deletedAt", "desc").limit(50).get();
        const items = snap.docs.map(d => ({ id:d.id, ...d.data() }));

        if (!items.length) {
          list.innerHTML = `<div class="settings-help" style="margin:0;">íœ´ì§€í†µì´ ë¹„ì–´ìˆì–´.</div>`;
          return;
        }

        items.forEach(item => {
          const row = document.createElement("div");
          row.className = "trash-row";
          const title = `${item.plateNumber || "-"} ${item.productName ? "(" + item.productName + ")" : ""}`;

          row.innerHTML = `
            <div class="trash-meta">
              <div class="trash-title">${title}</div>
              <div class="trash-sub">ì‚­ì œ: ${formatTS(item.deletedAt)} / ì›ë³¸ID: ${item.originalId || "-"}</div>
            </div>
            <div style="display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end;">
              <button class="btn btn-secondary btn-small" data-act="restore">ë³µì›</button>
              <button class="btn btn-danger btn-small" data-act="purge">ì™„ì „ì‚­ì œ</button>
            </div>
          `;

          row.querySelector('[data-act="restore"]').addEventListener("click", async () => {
            try {
              const restorePayload = { ...item };
              delete restorePayload.id;
              delete restorePayload.deletedAt;
              const originalId = restorePayload.originalId || "";
              delete restorePayload.originalId;

              // âœ… (2) ê°€ëŠ¥í•˜ë©´ originalIdë¡œ ë³µì›(â€œì§„ì§œ ë³µêµ¬â€ ëŠë‚Œ)
              if (originalId) {
                await db.collection(PLATE_COLLECTION).doc(originalId).set({
                  ...restorePayload,
                  updatedAt: Date.now(),
                  restoredAt: Date.now(),
                }, { merge: false });
              } else {
                await db.collection(PLATE_COLLECTION).add({
                  ...restorePayload,
                  updatedAt: Date.now(),
                  restoredAt: Date.now(),
                });
              }

              await db.collection(TRASH_COLLECTION).doc(item.id).delete();
              showToast("ë³µì› ì™„ë£Œ.");
              loadTrash();
            } catch (e) {
              console.error(e);
              showToast("ë³µì› ì¤‘ ì˜¤ë¥˜.");
            }
          });

          row.querySelector('[data-act="purge"]').addEventListener("click", async () => {
            if (!confirm("íœ´ì§€í†µì—ì„œ ì™„ì „ì‚­ì œí• ê¹Œìš”?\n(ë³µêµ¬ ë¶ˆê°€)")) return;
            try {
              // âœ… (2) ì™„ì „ì‚­ì œ â€œí™•ì‹¤íˆâ€
              await db.collection(TRASH_COLLECTION).doc(item.id).delete();
              showToast("ì™„ì „ì‚­ì œ ì™„ë£Œ.");
              loadTrash();
            } catch (e) {
              console.error(e);
              showToast("ì™„ì „ì‚­ì œ ì˜¤ë¥˜(ê¶Œí•œ/ë„¤íŠ¸ì›Œí¬ í™•ì¸).");
            }
          });

          list.appendChild(row);
        });
      } catch (e) {
        console.error(e);
        showToast("íœ´ì§€í†µ ë¡œë“œ ì‹¤íŒ¨.");
      }
    }

    /* =========================
      ë Œë”ë§
    ========================= */
    function applyViewMode() {
      const list = document.getElementById("list");
      const btn = document.getElementById("viewToggleBtn");
      if (!list || !btn) return;
      if (currentViewMode === "gallery") {
        list.classList.add("gallery");
        btn.textContent = "ë¦¬ìŠ¤íŠ¸";
      } else {
        list.classList.remove("gallery");
        btn.textContent = "ê°¤ëŸ¬ë¦¬";
      }
    }

    function updateCountBar(filteredLength, totalLength, hasFilter) {
      const bar = document.getElementById("countBar");
      if (!bar) return;

      const tabLabel = currentTab === "films" ? "í•„ë¦„" : "íŒ";
      if (hasFilter) bar.innerHTML = `ê²€ìƒ‰ ê²°ê³¼ <strong>${filteredLength}</strong>ê°œ / ì „ì²´ ${totalLength}ê°œ (${tabLabel})`;
      else bar.innerHTML = `ì´ <strong>${totalLength}</strong>ê°œ (${tabLabel})`;
    }

    function getUsageWarnLevel(plate) {
      const max = Number(plate.maxUsage || 5000);
      const used = Number(plate.usedTotal || 0);
      if (max <= 0) return { pct: 0, level: "ok" };
      const pct = (used / max) * 100;
      if (pct >= 100) return { pct, level: "danger" };
      if (pct >= 90) return { pct, level: "warn2" };
      if (pct >= 70) return { pct, level: "warn1" };
      return { pct, level: "ok" };
    }

    function renderList(filterText = "") {
      const listEl = document.getElementById("list");
      const emptyText = document.getElementById("emptyText");
      if (!listEl || !emptyText) return;

      listEl.innerHTML = "";
      currentSearchText = filterText || "";

      if (currentMode === MODE.PRINTER) currentTab = "plates";
      if (currentTab === "films" && !canViewFilms()) currentTab = "plates";

      applyTabVisibility();

      const text = (filterText || "").trim().toLowerCase();
      const sortOpt = getSortOption();

      let data = (currentTab === "films") ? films.slice() : plates.slice();

      let filtered = data.filter((x) => {
        if (!text) return true;
        const combined = currentTab === "films"
          ? `${x.productName||""} ${x.filmNumber||""} ${x.method||""} ${x.mesh||""} ${x.location||""} ${x.plateInfo||""}`
          : `${x.productName||""} ${x.filmNumber||""} ${x.plateNumber||""} ${x.mesh||""} ${x.plateLocation||""} ${x.tension||""} ${x.lastUsedBy||""}`;
        return combined.toLowerCase().includes(text);
      });

      filtered = filtered.sort((a, b) => {
        const getUpdated = (v) => v.updatedAt || v.createdAt || 0;
        if (sortOpt === "name") return (a.productName||"").localeCompare((b.productName||""), "ko");
        if (sortOpt === "number") {
          const aa = currentTab === "films" ? (a.filmNumber||"") : (a.plateNumber||"");
          const bb = currentTab === "films" ? (b.filmNumber||"") : (b.plateNumber||"");
          return aa.localeCompare(bb, "ko");
        }
        if (sortOpt === "lastUsed") {
          const aa = currentTab === "films" ? (a.lastUsed||"") : (a.lastUsedAt||0);
          const bb = currentTab === "films" ? (b.lastUsed||"") : (b.lastUsedAt||0);
          if (currentTab === "films") return (bb||"").localeCompare(aa||"");
          return (bb||0) - (aa||0);
        }
        return getUpdated(b) - getUpdated(a);
      });

      updateCountBar(filtered.length, data.length, !!text);

      let toRender = filtered;
      if (!text) {
        visibleCount = Math.min(visibleCount || VISIBLE_STEP, filtered.length);
        toRender = filtered.slice(0, visibleCount);
      }

      if (filtered.length === 0) {
        emptyText.style.display = "block";
        emptyText.innerHTML = currentTab === "films"
          ? "ë“±ë¡ëœ í•„ë¦„ì´ ì—†ìŠµë‹ˆë‹¤."
          : "ë“±ë¡ëœ íŒì´ ì—†ìŠµë‹ˆë‹¤.";
        return;
      } else {
        emptyText.style.display = "none";
      }

      if (currentTab === "films") {
        toRender.forEach((film) => {
          const card = document.createElement("div");
          card.className = "card";

          const img = document.createElement("img");
          if (film.imageDataUrl) {
            img.src = film.imageDataUrl;
            img.addEventListener("click", () => openImageViewer(film.imageDataUrl));
          } else { img.alt = "ì´ë¯¸ì§€ ì—†ìŒ"; }
          card.appendChild(img);

          const content = document.createElement("div");
          content.className = "card-content";

          const rowMain = document.createElement("div");
          rowMain.className = "card-row-main";

          const title = document.createElement("div");
          title.className = "card-title";
          title.textContent = film.productName || "(ì œí’ˆëª… ì—†ìŒ)";

          const tag = document.createElement("div");
          tag.className = "card-tag";
          tag.textContent = film.filmNumber || "ë²ˆí˜¸ ì—†ìŒ";

          rowMain.appendChild(title);
          rowMain.appendChild(tag);
          content.appendChild(rowMain);

          const rowMethod = document.createElement("div");
          rowMethod.className = "card-row";
          rowMethod.innerHTML = '<span class="label">ì œíŒ íƒ€ì…</span>' + (film.method || "-");
          content.appendChild(rowMethod);

          const rowMesh = document.createElement("div");
          rowMesh.className = "card-row";
          rowMesh.innerHTML = '<span class="label">MESH</span>' + (film.mesh || "-");
          content.appendChild(rowMesh);

          const rowPlate = document.createElement("div");
          rowPlate.className = "card-row";
          rowPlate.innerHTML = '<span class="label">ì œíŒ ë°©ë²•</span>' + (film.plateInfo || "-");
          content.appendChild(rowPlate);

          const rowLoc = document.createElement("div");
          rowLoc.className = "card-row";
          rowLoc.innerHTML = '<span class="label">í•„ë¦„ ìœ„ì¹˜</span>' + (film.location || "-");
          content.appendChild(rowLoc);

          const footer = document.createElement("div");
          footer.className = "card-footer";

          const lastUsed = document.createElement("div");
          lastUsed.className = "last-used";
          lastUsed.textContent = "ë§ˆì§€ë§‰ ì‚¬ìš©ì¼: " + formatDate(film.lastUsed || "");
          footer.appendChild(lastUsed);

          const btnWrap = document.createElement("div");
          btnWrap.className = "card-buttons";

          if (canEditPlates()) {
            const plateAddBtn = document.createElement("button");
            plateAddBtn.className = "btn btn-secondary btn-small";
            plateAddBtn.textContent = "íŒ ë“±ë¡";
            plateAddBtn.addEventListener("click", () => openPlateFormNewFromFilm(film.id));
            btnWrap.appendChild(plateAddBtn);
          }

          if (canEditFilms()) {
            const memoBtn = document.createElement("button");
            memoBtn.className = "btn btn-secondary btn-small";
            memoBtn.textContent = "ë©”ëª¨";
            if ((film.memo||"").trim()) memoBtn.classList.add("btn-memo-has");
            memoBtn.addEventListener("click", () => openMemoSheet("film", film.id));
            btnWrap.appendChild(memoBtn);

            const editBtn = document.createElement("button");
            editBtn.className = "btn btn-primary btn-small";
            editBtn.textContent = "ìˆ˜ì •";
            editBtn.addEventListener("click", () => openFilmFormEdit(film.id));
            btnWrap.appendChild(editBtn);

            const delBtn = document.createElement("button");
            delBtn.className = "btn btn-danger btn-small";
            delBtn.textContent = "ì‚­ì œ";
            delBtn.addEventListener("click", () => deleteFilm(film.id));
            btnWrap.appendChild(delBtn);
          }

          footer.appendChild(btnWrap);
          content.appendChild(footer);
          card.appendChild(content);
          listEl.appendChild(card);
        });
      } else {
        toRender.forEach((plate) => {
          const card = document.createElement("div");
          card.className = "card";

          const img = document.createElement("img");
          if (plate.imageDataUrl) {
            img.src = plate.imageDataUrl;
            img.addEventListener("click", () => openImageViewer(plate.imageDataUrl));
          } else { img.alt = "ì´ë¯¸ì§€ ì—†ìŒ"; }
          card.appendChild(img);

          const content = document.createElement("div");
          content.className = "card-content";

          const rowMain = document.createElement("div");
          rowMain.className = "card-row-main";

          const title = document.createElement("div");
          title.className = "card-title";

          const filmExists = !!films.find(f => f.id === plate.filmId);
          const warn = (!filmExists) ? "âš ï¸" : "";
          title.innerHTML = `${warn ? `<span class="warn-icon" title="ì›ë³¸ í•„ë¦„ ì—†ìŒ">${warn}</span>` : ""}${plate.productName || "(ì œí’ˆëª… ì—†ìŒ)"}`;

          const tag = document.createElement("div");
          tag.className = "card-tag";
          tag.textContent = plate.plateNumber || "íŒ ë²ˆí˜¸ ì—†ìŒ";

          rowMain.appendChild(title);
          rowMain.appendChild(tag);
          content.appendChild(rowMain);

          const rowFilm = document.createElement("div");
          rowFilm.className = "card-row";
          rowFilm.innerHTML = `<span class="label">í•„ë¦„</span>${plate.filmNumber || "-"}${!filmExists ? ` <span style="color:var(--warn-1); font-size:11px;">(ì›ë³¸ ì—†ìŒ)</span>` : ""}`;
          content.appendChild(rowFilm);

          const rowMesh = document.createElement("div");
          rowMesh.className = "card-row";
          rowMesh.innerHTML = `<span class="label">MESH</span>${plate.mesh || "-"}`;
          content.appendChild(rowMesh);

          const rowTen = document.createElement("div");
          rowTen.className = "card-row";
          rowTen.innerHTML = `<span class="label">í…ì…˜</span>${plate.tension || "-"}`;
          content.appendChild(rowTen);

          const rowLoc = document.createElement("div");
          rowLoc.className = "card-row";
          rowLoc.innerHTML = `<span class="label">íŒ ìœ„ì¹˜</span>${plate.plateLocation || "-"}`;
          content.appendChild(rowLoc);

          const max = Number(plate.maxUsage || 5000);
          const used = Number(plate.usedTotal || 0);
          const warnInfo = getUsageWarnLevel(plate);
          let warnText = "";
          if (warnInfo.level === "warn1") warnText = `<span style="color:var(--warn-1); font-weight:600;">(ìœ ì˜ ${Math.floor(warnInfo.pct)}%)</span>`;
          if (warnInfo.level === "warn2") warnText = `<span style="color:var(--warn-2); font-weight:700;">(ê²½ê³  ${Math.floor(warnInfo.pct)}%)</span>`;
          if (warnInfo.level === "danger") warnText = `<span style="color:var(--warn-2); font-weight:800;">(ì´ˆê³¼ ${Math.floor(warnInfo.pct)}%)</span>`;

          const rowUsage = document.createElement("div");
          rowUsage.className = "card-row";
          rowUsage.innerHTML = `<span class="label">ì‚¬ìš©ëŸ‰</span>${used} / ${max} ${warnText}`;
          content.appendChild(rowUsage);

          const footer = document.createElement("div");
          footer.className = "card-footer";

          const lastUsed = document.createElement("div");
          lastUsed.className = "last-used";
          const lastInfo = (plate.lastUsedAt ? `${formatTS(plate.lastUsedAt)} / ${plate.lastUsedBy || "-"} / ${plate.lastUsedQty || 0}ê°œ` : "-");
          lastUsed.textContent = "ë§ˆì§€ë§‰ ì‚¬ìš©: " + lastInfo;
          footer.appendChild(lastUsed);

          const btnWrap = document.createElement("div");
          btnWrap.className = "card-buttons";

          if (canRegisterUsage()) {
            const useBtn = document.createElement("button");
            useBtn.className = "btn btn-secondary btn-small";
            useBtn.textContent = "ì‚¬ìš©ë“±ë¡";
            useBtn.addEventListener("click", () => openUsageSheet(plate.id));
            btnWrap.appendChild(useBtn);
          }

          const usageHistBtn = document.createElement("button");
          usageHistBtn.className = "btn btn-secondary btn-small";
          usageHistBtn.textContent = "ì‚¬ìš© íˆìŠ¤í† ë¦¬";
          usageHistBtn.addEventListener("click", () => openPlateUsageHistory(plate.id));
          btnWrap.appendChild(usageHistBtn);

          if (canEditPlates()) {
            const memoBtn = document.createElement("button");
            memoBtn.className = "btn btn-secondary btn-small";
            memoBtn.textContent = "ë©”ëª¨";
            if ((plate.memo||"").trim()) memoBtn.classList.add("btn-memo-has");
            memoBtn.addEventListener("click", () => openMemoSheet("plate", plate.id));
            btnWrap.appendChild(memoBtn);

            const editBtn = document.createElement("button");
            editBtn.className = "btn btn-primary btn-small";
            editBtn.textContent = "ìˆ˜ì •";
            editBtn.addEventListener("click", () => openPlateFormEdit(plate.id));
            btnWrap.appendChild(editBtn);
          }

          if (canDeletePlates()) {
            const delBtn = document.createElement("button");
            delBtn.className = "btn btn-danger btn-small";
            delBtn.textContent = "ì‚­ì œ";
            delBtn.addEventListener("click", () => deletePlateToTrash(plate.id));
            btnWrap.appendChild(delBtn);
          }

          footer.appendChild(btnWrap);
          content.appendChild(footer);
          card.appendChild(content);
          listEl.appendChild(card);
        });
      }

      applyViewMode();
    }

    /* =========================
      ì´ë¯¸ì§€ ë·°ì–´
    ========================= */
    let viewerScale = 1;
    let viewerStartDist = 0;
    function openImageViewer(src) {
      const viewer = document.getElementById("imageViewer");
      const img = document.getElementById("viewerImage");
      viewerScale = 1;
      if (img) {
        img.src = src || "";
        img.style.transform = "scale(1)";
      }
      viewer.classList.add("show");
    }
    function closeImageViewer() {
      const viewer = document.getElementById("imageViewer");
      const img = document.getElementById("viewerImage");
      if (img) img.src = "";
      viewer.classList.remove("show");
    }

    /* =========================
      ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸°
    ========================= */
    function exportData() {
      const payload = {
        version: 2,
        exportedAt: Date.now(),
        films,
        plates,
      };
      const json = JSON.stringify(payload, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const date = todayISO().replace(/-/g, "");
      a.href = url;
      a.download = "filmfind_backup_" + date + ".json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast("ë°±ì—… íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ.");
    }

    async function importDataFromFile(file) {
      try {
        const text = await file.text();
        const payload = JSON.parse(text);

        if (!payload || !Array.isArray(payload.films) || !Array.isArray(payload.plates)) {
          alert("ìœ íš¨í•˜ì§€ ì•Šì€ ë°±ì—… íŒŒì¼ì…ë‹ˆë‹¤.");
          return;
        }

        const ok = confirm(
          `ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ ì§„í–‰í• ê¹Œìš”?\n\n` +
          `í•„ë¦„: ${payload.films.length}ê°œ\níŒ: ${payload.plates.length}ê°œ\n\n` +
          `â€» ê°™ì€ ë°ì´í„°ê°€ ì¤‘ë³µ ì €ì¥ë  ìˆ˜ ìˆì–´.\n(í˜„ì¬ëŠ” 'ì¶”ê°€ import' ë°©ì‹)`
        );
        if (!ok) return;

        // "ì¶”ê°€ import" ë°©ì‹: ìƒˆë¡œ add
        const batch = db.batch();

        payload.films.forEach(f => {
          const copy = { ...f };
          delete copy.id;
          copy.importedAt = Date.now();
          batch.set(db.collection(FILM_COLLECTION).doc(), copy);
        });

        payload.plates.forEach(p => {
          const copy = { ...p };
          delete copy.id;
          copy.importedAt = Date.now();
          batch.set(db.collection(PLATE_COLLECTION).doc(), copy);
        });

        await batch.commit();
        showToast("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ.");
      } catch (e) {
        console.error(e);
        showToast("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨(íŒŒì¼ í™•ì¸).");
      }
    }

    /* =========================
      ì„¤ì •
    ========================= */
    function openSettings() {
      const card = document.getElementById("settingsCard");
      const isOpen = card.style.display === "block";
      closeAllPanels();
      if (isOpen) return;
      card.style.display = "block";

      document.getElementById("deviceNameInput").value = getDeviceLabel() || "";
      document.getElementById("sortOptionSelect").value = getSortOption();
      document.getElementById("themeSelect").value = getTheme();

      // ê´€ë¦¬ì ì „ìš© ì„¹ì…˜
      document.getElementById("pwSection").style.display = canChangePasswords() ? "block" : "none";
      document.getElementById("trashSection").style.display = canAccessTrash() ? "block" : "none";
      if (canAccessTrash()) loadTrash();
    }

    async function saveSettings() {
      const device = (document.getElementById("deviceNameInput").value || "").trim();
      const sortOpt = document.getElementById("sortOptionSelect").value || "updated";
      const theme = document.getElementById("themeSelect").value || "default";

      setDeviceLabel(device);
      setSortOption(sortOpt);
      setTheme(theme);

      // ê´€ë¦¬ì ë¹„ë²ˆ ë³€ê²½
      if (canChangePasswords()) {
        const a = (document.getElementById("pwAdminNew").value || "").trim();
        const p = (document.getElementById("pwPrinterNew").value || "").trim();
        const v = (document.getElementById("pwViewerNew").value || "").trim();

        if (a) localStorage.setItem(PW_ADMIN_KEY, a);
        if (p) localStorage.setItem(PW_PRINTER_KEY, p);
        if (v) localStorage.setItem(PW_VIEWER_KEY, v);

        // ì…ë ¥ì¹¸ ë¹„ìš°ê¸°
        document.getElementById("pwAdminNew").value = "";
        document.getElementById("pwPrinterNew").value = "";
        document.getElementById("pwViewerNew").value = "";
      }

      showToast("ì„¤ì • ì €ì¥ë¨.");
      document.getElementById("settingsCard").style.display = "none";
      renderList(currentSearchText);
    }

    /* =========================
      ì ê¸ˆ/ëª¨ë“œ
    ========================= */
    function unlockWithPassword(pw) {
      ensureDefaultPasswords();
      const P = getPasswords();

      if (pw === P.admin) currentMode = MODE.ADMIN;
      else if (pw === P.printer) currentMode = MODE.PRINTER;
      else if (pw === P.viewer) currentMode = MODE.VIEWER;
      else return false;

      localStorage.setItem(UNLOCK_KEY, "1");
      document.getElementById("lockScreen").style.display = "none";
      document.getElementById("appContainer").style.display = "block";
      setModeUI();

      // ê´€ë¦¬ì: films + plates ëª¨ë‘ ë¦¬ìŠ¤ë„ˆ
      // ì¸ì‡„ê¸°ì‚¬/ì¡°íšŒ: plates ë¦¬ìŠ¤ë„ˆëŠ” í•­ìƒ, filmsëŠ” ì¡°íšŒ/ê´€ë¦¬ìë§Œ
      if (currentMode === MODE.ADMIN || currentMode === MODE.VIEWER) startFilmsListener();
      startPlatesListener();

      // ì¸ì‡„ê¸°ì‚¬ ê°•ì œ plates íƒ­
      if (currentMode === MODE.PRINTER) setTab("plates");
      else applyTabVisibility();

      // ê´€ë¦¬ìë§Œ íœ´ì§€í†µ/ë¹„ë²ˆ ë³€ê²½ ê°€ëŠ¥
      return true;
    }

    function restoreUnlockIfPossible() {
      // ë³´ì•ˆìƒ: "ìë™ì ê¸ˆ í•´ì œ"ëŠ” ì›í•˜ë©´ ì¼¤ ìˆ˜ ìˆëŠ”ë°, ì§€ê¸ˆì€ ê¸°ì¡´ êµ¬ì¡° ìœ ì§€(í‚¤ê°€ ìˆìœ¼ë©´ ì ê¸ˆ ìŠ¤í‚µ)
      if (localStorage.getItem(UNLOCK_KEY) !== "1") return false;

      // ë§ˆì§€ë§‰ ëª¨ë“œ ì €ì¥ì€ ì•ˆ í•˜ê³ , ê·¸ëƒ¥ viewerë¡œ ë“¤ì–´ê°€ëŠ”ê²Œ ì•„ë‹ˆë¼
      // ì‹¤ì œë¡œëŠ” ë¹„ë°€ë²ˆí˜¸ ê¸°ë°˜ì´ì–´ì„œ ìë™ ë³µì›ì€ ì• ë§¤í•¨.
      // ê·¸ë˜ì„œ: ìë™ í•´ì œëŠ” í•˜ì§€ ì•Šê³ , ì ê¸ˆ í™”ë©´ ìœ ì§€í•˜ëŠ” ê²Œ ì•ˆì „.
      return false;
    }

    /* =========================
      ì´ë²¤íŠ¸ ë°”ì¸ë”© + ì´ˆê¸°í™”
    ========================= */
    function bindUI() {
      // íƒ­
      document.getElementById("tabFilmsBtn").addEventListener("click", () => setTab("films"));
      document.getElementById("tabPlatesBtn").addEventListener("click", () => setTab("plates"));

      // ê²€ìƒ‰
      document.getElementById("searchInput").addEventListener("input", (e) => {
        visibleCount = VISIBLE_STEP;
        renderList(e.target.value || "");
      });

      // ìƒˆ í•„ë¦„
      document.getElementById("newFilmBtn").addEventListener("click", openFilmFormNew);

      // ì„¤ì •
      document.getElementById("settingsBtn").addEventListener("click", openSettings);
      document.getElementById("closeSettingsBtn").addEventListener("click", () => document.getElementById("settingsCard").style.display = "none");
      document.getElementById("saveSettingsBtn").addEventListener("click", saveSettings);

      // íˆìŠ¤í† ë¦¬
      document.getElementById("historyBtn").addEventListener("click", openHistoryCard);
      document.getElementById("closeHistoryBtn").addEventListener("click", closeHistoryCard);

      // íˆìŠ¤í† ë¦¬ ë©”ëª¨ ëª¨ë‹¬
      document.getElementById("historyNoteCancelBtn").addEventListener("click", closeHistoryNoteModal);
      document.getElementById("historyNoteSaveBtn").addEventListener("click", saveHistoryNoteModal);
      document.getElementById("historyNoteModal").addEventListener("click", (e) => {
        if (e.target.id === "historyNoteModal") closeHistoryNoteModal();
      });

      // ë©”ëª¨ ì‹œíŠ¸
      document.getElementById("memoSheetBackdrop").addEventListener("click", closeMemoSheets);
      document.getElementById("memoSheetCloseBtn").addEventListener("click", closeMemoSheets);
      document.getElementById("memoSheetCancelBtn").addEventListener("click", closeMemoSheets);
      document.getElementById("memoSheetSaveBtn").addEventListener("click", saveMemoSheet);

      document.getElementById("plateMemoBackdrop").addEventListener("click", closeMemoSheets);
      document.getElementById("plateMemoCloseBtn").addEventListener("click", closeMemoSheets);
      document.getElementById("plateMemoCancelBtn").addEventListener("click", closeMemoSheets);
      document.getElementById("plateMemoSaveBtn").addEventListener("click", saveMemoSheet);

      // ì‚¬ìš©ë“±ë¡ ì‹œíŠ¸
      document.getElementById("usageBackdrop").addEventListener("click", closeUsageSheet);
      document.getElementById("usageCloseBtn").addEventListener("click", closeUsageSheet);
      document.getElementById("usageCancelBtn").addEventListener("click", closeUsageSheet);
      document.getElementById("usageSaveBtn").addEventListener("click", saveUsage);

      // âœ… ì¸ì‡„ê¸°ì‚¬ ì´ë¦„ ì¶”ê°€ ë²„íŠ¼
      document.getElementById("addPrinterNameBtn").addEventListener("click", () => {
        const name = prompt("ì¶”ê°€í•  ì¸ì‡„ê¸°ì‚¬ ì´ë¦„ì„ ì…ë ¥í•´ì¤˜ (ì˜ˆ: ì„±ê·œ)");
        const n = (name || "").trim();
        if (!n) return;
        const names = getPrinterNames();
        if (!names.includes(n)) {
          names.push(n);
          setPrinterNames(names);
          refreshPrinterNameSelect();
          document.getElementById("usageBySelect").value = n;
          showToast("ì´ë¦„ì´ ì¶”ê°€ëì–´.");
        } else {
          document.getElementById("usageBySelect").value = n;
          showToast("ì´ë¯¸ ìˆëŠ” ì´ë¦„ì´ì•¼.");
        }
      });

      // í¼ submit
      document.getElementById("filmForm").addEventListener("submit", saveFilmFromForm);
      document.getElementById("plateForm").addEventListener("submit", savePlateFromForm);
      document.getElementById("filmCancelBtn").addEventListener("click", closeFilmForm);
      document.getElementById("plateCancelBtn").addEventListener("click", closePlateForm);

      // ì˜¤ëŠ˜ ë²„íŠ¼
      document.getElementById("setTodayBtn").addEventListener("click", () => {
        document.getElementById("lastUsed").value = todayISO();
      });

      // ì´ë¯¸ì§€ ì„ íƒ í”„ë¦¬ë·°
      document.getElementById("imageInput").addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) { resetImagePreview(); return; }
        const reader = new FileReader();
        reader.onload = (ev) => {
          currentSelectedImageDataUrl = ev.target.result;
          currentImageRotation = 0;
          const img = document.getElementById("imagePreview");
          const wrapper = document.getElementById("imagePreviewWrapper");
          img.src = currentSelectedImageDataUrl;
          img.style.transform = "rotate(0deg)";
          wrapper.style.display = "flex";
        };
        reader.readAsDataURL(file);
      });
      document.getElementById("rotateLeftBtn").addEventListener("click", () => {
        currentImageRotation = (currentImageRotation - 90) % 360;
        applyPreviewRotation();
      });
      document.getElementById("rotateRightBtn").addEventListener("click", () => {
        currentImageRotation = (currentImageRotation + 90) % 360;
        applyPreviewRotation();
      });

      // ì œíŒ í† ê¸€ ë²„íŠ¼
      document.querySelectorAll(".toggle-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const group = btn.closest(".toggle-group");
          group.querySelectorAll(".toggle-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
        });
      });

      // ë·° í† ê¸€
      document.getElementById("viewToggleBtn").addEventListener("click", () => {
        setViewMode(currentViewMode === "gallery" ? "list" : "gallery");
      });

      // ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸°
      document.getElementById("exportBtn").addEventListener("click", exportData);
      document.getElementById("importBtn").addEventListener("click", () => document.getElementById("importFile").click());
      document.getElementById("importFile").addEventListener("change", async (e) => {
        const file = e.target.files && e.target.files[0];
        e.target.value = "";
        if (!file) return;
        await importDataFromFile(file);
      });

      // ì´ë¯¸ì§€ë·°ì–´ ë‹«ê¸°
      document.getElementById("viewerBackdrop").addEventListener("click", closeImageViewer);
      document.getElementById("closeViewerBtn").addEventListener("click", closeImageViewer);

      // ìŠ¤í¬ë¡¤íƒ‘
      const scrollBtn = document.getElementById("scrollTopBtn");
      window.addEventListener("scroll", () => {
        if (window.scrollY > 500) scrollBtn.classList.add("show");
        else scrollBtn.classList.remove("show");
      });
      scrollBtn.addEventListener("click", () => window.scrollTo({ top: 0, behavior: "smooth" }));

      // ë¬´í•œìŠ¤í¬ë¡¤(ê²€ìƒ‰ ì¤‘ ì•„ë‹ˆë©´ step ì¦ê°€)
      window.addEventListener("scroll", () => {
        if (currentSearchText && currentSearchText.trim()) return;
        const nearBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 200;
        if (!nearBottom) return;

        const dataLen = (currentTab === "films") ? films.length : plates.length;
        if (visibleCount >= dataLen) return;
        visibleCount += VISIBLE_STEP;
        renderList(currentSearchText);
      });
    }

    function initApp() {
      ensureDefaultPasswords();
      ensureDefaultPrinterNames();

      // ë¡œì»¬ ì„¤ì • ì ìš©
      setTheme(getTheme());
      setDeviceLabel(getDeviceLabel());
      currentViewMode = localStorage.getItem(VIEW_KEY) || "list";
      currentTab = localStorage.getItem(TAB_KEY) || "films";
      applyViewMode();
      applyTabVisibility();

      bindUI();

      // ì ê¸ˆ í•´ì œ(ë¹„ë°€ë²ˆí˜¸)
      const pwBtn = document.getElementById("passwordBtn");
      const pwInput = document.getElementById("passwordInput");

      const tryUnlock = () => {
        const pw = (pwInput.value || "").trim();
        if (!pw) return;
        const ok = unlockWithPassword(pw);
        if (!ok) {
          showToast("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ì–´.");
          pwInput.value = "";
          pwInput.focus();
        } else {
          pwInput.value = "";
          // ê´€ë¦¬ì/ì¡°íšŒ: ë§ˆì§€ë§‰ íƒ­ ìœ ì§€, ì¸ì‡„ê¸°ì‚¬: plates ê°•ì œëŠ” unlockWithPasswordì—ì„œ ì²˜ë¦¬
          renderList("");
        }
      };

      pwBtn.addEventListener("click", tryUnlock);
      pwInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") tryUnlock();
      });

      // ìë™ ì ê¸ˆ ë³µì›ì€ ë³´ì•ˆìƒ OFF(ì›í•˜ë©´ ì—¬ê¸°ì„œ trueë¡œ êµ¬í˜„ ê°€ëŠ¥)
      restoreUnlockIfPossible();
    }

    initApp();
  </script>
</body>
  </html>
