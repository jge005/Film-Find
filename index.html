<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#f9f4ff">
  <meta charset="UTF-8" />
  <title>FILM FIND - í•„ë¦„/íŒ ê´€ë¦¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- í°íŠ¸ (Pretendard) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css" />

  <style>
    :root {
      /* ê¸°ë³¸(ë¼ë²¤ë”) í…Œë§ˆ */
      --bg-gradient: linear-gradient(145deg, #f9fafb, #f4f0ff, #fdf2f8);
      --card-bg: rgba(255,255,255,0.98);
      --card-border: #e3e6ff;
      --shadow-soft: 0 8px 20px rgba(167, 173, 208, 0.35);

      --text-main: #272a3f;
      --text-sub: #767a98;
      --text-muted: #777b9e;
      --label-color: #8689a5;

      --primary-1: #7f9dff;
      --primary-2: #b38cff;
      --primary-soft: rgba(228,231,255,0.95);

      --chip-bg: #f3e8ff;
      --chip-text: #5f308c;

      --danger-bg: #ff6b81;
      --danger-text: #ffffff;

      --pill-bg: rgba(228,231,255,0.98);
      --pill-border: rgba(129, 140, 248, 0.4);

      --toast-bg: rgba(15,23,42,0.9);
      --toast-text: #f9fafb;

      --spinner-border: rgba(191, 219, 254, 0.9);
      --spinner-glow: rgba(129, 140, 248, 0.7);

      --warn-bg: rgba(250, 204, 21, 0.18);
      --warn-text: #b45309;
      --warn-border: rgba(250, 204, 21, 0.45);
    }

    /* ë¯¼íŠ¸ í…Œë§ˆ */
    [data-theme="mint"] {
      --bg-gradient: linear-gradient(145deg, #f0fdfa, #e0f2fe, #fefce8);
      --primary-1: #34d399;
      --primary-2: #22c55e;
      --primary-soft: rgba(187,247,208,0.85);
      --chip-bg: #dcfce7;
      --chip-text: #047857;
      --pill-bg: rgba(219, 234, 254, 0.96);
      --pill-border: rgba(45, 212, 191, 0.5);
      --spinner-border: rgba(167, 243, 208, 0.9);
      --spinner-glow: rgba(45, 212, 191, 0.7);
    }

    /* í”¼ì¹˜ í…Œë§ˆ */
    [data-theme="peach"] {
      --bg-gradient: linear-gradient(145deg, #fff7ed, #fee2e2, #fef9c3);
      --primary-1: #fb7185;
      --primary-2: #f97316;
      --primary-soft: rgba(254, 226, 226, 0.9);
      --chip-bg: #ffe4e6;
      --chip-text: #be123c;
      --pill-bg: rgba(254, 226, 226, 0.96);
      --pill-border: rgba(248, 113, 113, 0.55);
      --spinner-border: rgba(254, 202, 202, 0.9);
      --spinner-glow: rgba(248, 113, 113, 0.75);
    }

    /* ë‚˜ì´íŠ¸(ì–´ë‘ìš´) í…Œë§ˆ */
    [data-theme="night"] {
      --bg-gradient: radial-gradient(circle at top, #020617, #020617, #111827);
      --card-bg: rgba(15,23,42,0.98);
      --card-border: #1f2937;
      --shadow-soft: 0 10px 24px rgba(15, 23, 42, 0.75);

      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --text-muted: #9ca3af;
      --label-color: #9ca3af;

      --primary-1: #6366f1;
      --primary-2: #a855f7;
      --primary-soft: rgba(79,70,229,0.22);

      --chip-bg: rgba(79,70,229,0.18);
      --chip-text: #a5b4fc;

      --danger-bg: #f97373;
      --danger-text: #111827;

      --pill-bg: rgba(17,24,39,0.95);
      --pill-border: rgba(129, 140, 248, 0.8);

      --toast-bg: rgba(17,24,39,0.95);
      --toast-text: #e5e7eb;

      --spinner-border: rgba(55, 65, 81, 0.9);
      --spinner-glow: rgba(129, 140, 248, 0.85);

      --warn-bg: rgba(250, 204, 21, 0.14);
      --warn-text: #fde68a;
      --warn-border: rgba(250, 204, 21, 0.35);
    }

    * {
      box-sizing: border-box;
      font-family: "Pretendard Variable", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg-gradient);
      padding: 12px;
      color: var(--text-main);
    }

    .app-shell {
      max-width: 720px;
      margin: 0 auto;
    }

    /* ìƒë‹¨ í—¤ë” */
    .app-header {
      max-width: 720px;
      margin: 0 auto 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .title-wrap {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .app-title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 2px;
      color: var(--text-main);
    }
    .app-subtitle {
      font-size: 11px;
      color: var(--text-sub);
    }
    .device-badge {
      font-size: 11px;
      padding: 4px 12px;
      border-radius: 999px;
      background: var(--pill-bg);
      color: var(--text-sub);
      white-space: nowrap;
      max-width: 240px;
      text-overflow: ellipsis;
      overflow: hidden;
      border: 1px solid var(--pill-border);
      box-shadow: 0 0 8px rgba(129, 140, 248, 0.28);
      display: flex;
      align-items: center;
      gap: 6px;
      justify-content: flex-end;
    }
    .device-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--primary-1);
      box-shadow: 0 0 6px rgba(129, 140, 248, 0.9);
    }
    .mode-pill {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--pill-border);
      background: rgba(255,255,255,0.6);
      font-size: 11px;
      color: var(--text-sub);
      white-space: nowrap;
    }
    [data-theme="night"] .mode-pill {
      background: rgba(2,6,23,0.5);
      border-color: #1f2937;
    }

    .top-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .top-bar input[type="text"] {
      flex: 1;
      padding: 9px 11px;
      border-radius: 999px;
      border: 1px solid var(--card-border);
      font-size: 14px;
      min-width: 0;
      background: rgba(255,255,255,0.9);
      color: var(--text-main);
    }
    .top-bar input::placeholder {
      color: var(--text-muted);
    }

    [data-theme="night"] .top-bar input[type="text"] {
      background: #020617;
      border-color: #1f2937;
    }

    .btn {
      padding: 8px 11px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      transition: transform 0.05s ease, box-shadow 0.1s ease, background 0.1s ease, opacity 0.1s ease;
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
      opacity: 0.92;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-1), var(--primary-2));
      color: white;
      box-shadow: 0 4px 10px rgba(127,157,255,0.35);
    }
    .btn-secondary {
      background: var(--primary-soft);
      color: #283252;
    }
    [data-theme="night"] .btn-secondary {
      color: #e5e7eb;
    }
    .btn-danger {
      background: var(--danger-bg);
      color: var(--danger-text);
    }
    .btn-warn {
      background: var(--warn-bg);
      color: var(--warn-text);
      border: 1px solid var(--warn-border);
    }
    .btn-small {
      font-size: 12px;
      padding: 5px 9px;
      border-radius: 999px;
    }

    .tools-bar {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    /* íƒ­ */
    .tabbar {
      display: flex;
      gap: 6px;
      margin: 8px 0 10px;
      flex-wrap: wrap;
    }
    .tab-btn {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--card-border);
      background: rgba(255,255,255,0.65);
      font-size: 12px;
      color: #464b73;
      cursor: pointer;
    }
    .tab-btn.active {
      background: linear-gradient(135deg, var(--primary-1), var(--primary-2));
      color: #fff;
      border-color: transparent;
    }
    [data-theme="night"] .tab-btn {
      background: rgba(2,6,23,0.55);
      border-color: #1f2937;
      color: #e5e7eb;
    }

    /* ì¹´ìš´íŠ¸ + ë·° ì „í™˜ */
    .count-wrap {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }
    .count-bar {
      font-size: 11px;
      color: var(--text-muted);
      text-align: left;
      flex: 1;
    }
    .count-bar strong {
      color: var(--primary-1);
    }

    .form-card {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 12px 14px;
      margin-bottom: 12px;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--card-border);
    }
    .form-row {
      display: flex;
      flex-direction: column;
      margin-bottom: 9px;
    }
    .form-row label {
      font-size: 12px;
      margin-bottom: 4px;
      color: var(--label-color);
    }
    .form-row input[type="text"],
    .form-row input[type="date"],
    .form-row input[type="password"],
    .form-row input[type="number"],
    .form-row select,
    .form-row textarea {
      padding: 7px 10px;
      border-radius: 10px;
      border: 1px solid var(--card-border);
      font-size: 13px;
      background: #f9f9ff;
      color: var(--text-main);
    }
    .form-row textarea {
      min-height: 90px;
      resize: vertical;
      line-height: 1.45;
    }
    [data-theme="night"] .form-row input[type="text"],
    [data-theme="night"] .form-row input[type="date"],
    [data-theme="night"] .form-row input[type="password"],
    [data-theme="night"] .form-row input[type="number"],
    [data-theme="night"] .form-row select,
    [data-theme="night"] .form-row textarea {
      background: #020617;
      border-color: #1f2937;
      color: #e5e7eb;
    }
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 6px;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 24px;
    }

    /* ê°¤ëŸ¬ë¦¬ ëª¨ë“œ (ë°˜ì‘í˜•) */
    .list.gallery {
      display: grid;
      grid-template-columns: 1fr; /* ëª¨ë°”ì¼: 1ì—´ */
      gap: 12px;
    }
    .list.gallery .card {
      flex-direction: column;
      align-items: stretch;
    }
    .list.gallery .card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
    }

    .card {
      background: rgba(255,255,255,0.96);
      border-radius: 16px;
      padding: 10px;
      display: flex;
      gap: 10px;
      box-shadow: 0 6px 16px rgba(169, 177, 214, 0.35);
      align-items: flex-start;
      border: 1px solid var(--card-border);
      animation: cardFadeIn 0.18s ease-out;
      position: relative;
    }
    [data-theme="night"] .card {
      background: rgba(15,23,42,0.98);
      box-shadow: 0 8px 22px rgba(15,23,42,0.85);
    }

    .warn-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: var(--warn-bg);
      color: var(--warn-text);
      border: 1px solid var(--warn-border);
      display: none;
    }
    .warn-badge.show { display: inline-flex; }

    @keyframes cardFadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card img {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 12px;
      background: #eef1ff;
      flex-shrink: 0;
      cursor: pointer;
    }
    .card-content {
      flex: 1;
      font-size: 13px;
    }
    .card-row-main {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 4px;
      align-items: center;
    }
    .card-title {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-main);
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }
    .card-tag {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      background: var(--chip-bg);
      color: var(--chip-text);
      align-self: flex-start;
    }
    .card-row {
      margin-bottom: 2px;
      color: var(--text-main);
    }
    .label {
      color: var(--label-color);
      font-size: 11px;
      margin-right: 4px;
    }
    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
      gap: 6px;
      flex-wrap: wrap;
    }
    .last-used {
      font-size: 11px;
      color: var(--text-muted);
    }
    .card-buttons {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .empty-text {
      text-align: center;
      color: #777;
      font-size: 13px;
      margin-top: 20px;
    }

    /* í† ê¸€ */
    .toggle-group {
      display: flex;
      gap: 6px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }
    .toggle-btn {
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid var(--card-border);
      background: #f5f3ff;
      color: #464b73;
      cursor: pointer;
      transition: background 0.1s ease, color 0.1s ease, border 0.1s ease;
    }
    .toggle-btn.active {
      border-color: var(--primary-1);
      background: var(--primary-1);
      color: #fff;
    }

    /* ì ê¸ˆ í™”ë©´ */
    .lock-screen {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(255,255,255,0.95), rgba(203,213,255,0.96));
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 1000;
    }
    .lock-card {
      width: 100%;
      max-width: 320px;
      margin: 0 auto;
      background: rgba(255,255,255,0.98);
      border-radius: 20px;
      padding: 18px 18px 16px;
      box-shadow: 0 12px 28px rgba(136, 144, 195, 0.55);
      border: 1px solid #dde1ff;
      text-align: center;
    }
    .lock-title {
      font-size: 18px;
      margin-bottom: 8px;
      font-weight: 600;
      color: #303656;
    }
    .lock-sub {
      font-size: 12px;
      color: #7b7f9d;
      margin-bottom: 14px;
    }
    .lock-input-wrap {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      align-items: center;
      justify-content: space-between;
    }
    .lock-input-wrap input {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #d6d9ff;
      background: #f7f7ff;
      text-align: center;
      font-size: 14px;
      letter-spacing: 3px;
      min-width: 0;
    }

    /* ì´ë¯¸ì§€ ì „ì²´ ë³´ê¸° */
    .image-viewer {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1500;
    }
    .image-viewer-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.75);
    }
    .image-viewer-inner {
      position: relative;
      max-width: 100%;
      max-height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    #viewerImage {
      max-width: 100%;
      max-height: 100%;
      border-radius: 12px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.5);
      touch-action: none;
      transition: transform 0.1s ease-out;
    }
    .viewer-close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      border-radius: 999px;
      border: none;
      padding: 6px 10px;
      font-size: 14px;
      cursor: pointer;
      background: rgba(15,23,42,0.8);
      color: #f9fafb;
    }

    /* í† ìŠ¤íŠ¸ */
    .toast {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%) translateY(40px);
      background: var(--toast-bg);
      color: var(--toast-text);
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 2000;
      max-width: 80%;
      text-align: center;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      box-shadow: 0 10px 24px rgba(15,23,42,0.6);
    }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
    .spinner-wrapper {
      display: none;
      justify-content: center;
      align-items: center;
      padding: 4px 0 16px;
    }
    .spinner-wrapper.show {
      display: flex;
    }
    .spinner-circle {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 3px solid var(--spinner-border);
      border-top-color: var(--primary-1);
      box-shadow: 0 0 12px var(--spinner-glow);
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ë§¨ ìœ„ë¡œ ë²„íŠ¼ */
    .scroll-top-btn {
      position: fixed;
      right: 16px;
      bottom: 24px;
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: none;
      font-size: 18px;
      cursor: pointer;
      background: linear-gradient(135deg, var(--primary-1), var(--primary-2));
      color: #fff;
      display: none;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 24px rgba(107,114,128,0.6);
      z-index: 1900;
    }
    .scroll-top-btn.show { display: flex; }

    @media (min-width: 768px) { body { padding-top: 24px; } }
    @media (min-width: 600px) { .list.gallery { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (min-width: 1024px) {
      .app-shell, .app-header { max-width: 1080px; }
      .list.gallery { grid-template-columns: repeat(3, minmax(260px, 1fr)); }
    }

    /* ====== ë©”ëª¨: ë°”í…€ ì‹œíŠ¸ ====== */
    .memo-sheet {
      position: fixed;
      inset: 0;
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 1600;
    }
    .memo-sheet.show { display: flex; }
    .memo-sheet-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
    }
    .memo-sheet-panel {
      position: relative;
      width: 100%;
      max-width: 720px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 18px 18px 0 0;
      box-shadow: 0 -12px 28px rgba(0,0,0,0.25);
      padding: 12px 14px 14px;
      animation: sheetUp 0.16s ease-out;
    }
    @keyframes sheetUp {
      from { transform: translateY(14px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .memo-sheet-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .memo-sheet-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-main);
    }
    .memo-sheet-sub {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 2px;
    }
    .memo-sheet-textarea {
      width: 100%;
      min-height: 120px;
      resize: vertical;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--card-border);
      background: #f9f9ff;
      color: var(--text-main);
      font-size: 13px;
      line-height: 1.45;
    }
    [data-theme="night"] .memo-sheet-textarea {
      background: #020617;
      border-color: #1f2937;
      color: #e5e7eb;
    }
    .memo-sheet-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 10px;
    }
    .btn-memo-has {
      box-shadow: 0 0 0 2px rgba(127,157,255,0.18) inset;
    }

    /* ====== íˆìŠ¤í† ë¦¬/ì‚¬ìš©ê¸°ë¡ ëª¨ë‹¬ ====== */
    .note-modal {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1700;
      padding: 16px;
    }
    .note-modal.show { display: flex; }
    .note-modal-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 18px;
      padding: 16px 18px 14px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 10px 24px rgba(0,0,0,0.25);
    }
    .note-modal-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 6px;
      color: var(--text-main);
    }
    .note-modal-text {
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 10px;
    }
    .note-modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 10px;
    }

    .history-list {
      max-height: 280px;
      overflow-y: auto;
      padding-right: 4px;
      margin-top: 4px;
      position: relative;
    }
    .history-list::before {
      content: "";
      position: absolute;
      left: 8px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: linear-gradient(to bottom, rgba(148,163,184,0.6), rgba(199,210,254,0.2));
    }
    .history-row {
      font-size: 12px;
      color: #444867;
      padding: 6px 2px 6px 20px;
      position: relative;
    }
    [data-theme="night"] .history-row { color: #e5e7eb; }
    .history-row::before {
      content: "";
      position: absolute;
      left: 4px;
      top: 10px;
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #fff;
      border: 2px solid var(--primary-1);
      box-shadow: 0 0 0 4px rgba(129,140,248,0.15);
    }
    .history-time { color: #6b6f90; font-size: 11px; }
    [data-theme="night"] .history-time { color: #9ca3af; }
    .history-device { color: var(--primary-1); font-size: 11px; margin-left: 4px; }
    .history-action-chip {
      display: inline-block;
      margin-left: 6px;
      padding: 1px 6px;
      border-radius: 999px;
      font-size: 11px;
      background: var(--chip-bg);
      color: var(--chip-text);
    }
    .history-film { color: #111827; font-weight: 500; }
    [data-theme="night"] .history-film { color: #e5e7eb; }
    .history-changes { font-size: 11px; color: #6b7280; margin-top: 2px; }
    [data-theme="night"] .history-changes { color: #9ca3af; }
    .history-empty { font-size: 12px; color: #6b7280; padding-left: 20px; margin-top: 6px; }
    [data-theme="night"] .history-empty { color: #9ca3af; }

    /* â€œê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸â€ í•œ ì¤„ ê³ ì •(ê¸€ì”¨ ê¹¨ì§ ë°©ì§€) */
    .nowrap { white-space: nowrap; }

  </style>
</head>
<body>
  <!-- ì ê¸ˆ í™”ë©´ -->
  <div id="lockScreen" class="lock-screen">
    <div class="lock-card">
      <div class="lock-title">FILM FIND</div>
      <div class="lock-sub">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´.</div>
      <div class="lock-input-wrap">
        <input type="password" id="passwordInput" maxlength="20" placeholder="â€¢â€¢â€¢â€¢" />
        <button class="btn btn-primary btn-small" id="passwordBtn">ì…ì¥</button>
      </div>
      <!-- íŒíŠ¸/ë¬¸êµ¬ ì ˆëŒ€ ë…¸ì¶œ X (ìš”êµ¬ì‚¬í•­) -->
    </div>
  </div>

  <!-- ì´ë¯¸ì§€ ì „ì²´ë³´ê¸° -->
  <div id="imageViewer" class="image-viewer">
    <div class="image-viewer-backdrop" id="viewerBackdrop"></div>
    <div class="image-viewer-inner">
      <img id="viewerImage" src="" alt="ì´ë¯¸ì§€" />
      <button id="closeViewerBtn" class="viewer-close-btn">âœ•</button>
    </div>
  </div>

  <!-- í† ìŠ¤íŠ¸ -->
  <div id="toast" class="toast"></div>

  <!-- ====== ë©”ëª¨ ìŠ¬ë¼ì´ë“œ (í•„ë¦„/íŒ ê³µìš©) ====== -->
  <div id="memoSheet" class="memo-sheet">
    <div id="memoSheetBackdrop" class="memo-sheet-backdrop"></div>
    <div class="memo-sheet-panel">
      <div class="memo-sheet-head">
        <div>
          <div class="memo-sheet-title" id="memoSheetTitle">ë©”ëª¨</div>
          <div class="memo-sheet-sub" id="memoSheetSub">ë©”ëª¨ë¥¼ ì €ì¥í•  ìˆ˜ ìˆì–´.</div>
        </div>
        <button class="btn btn-secondary btn-small" id="memoSheetCloseBtn">ë‹«ê¸°</button>
      </div>
      <textarea id="memoTextarea" class="memo-sheet-textarea" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥"></textarea>
      <div class="memo-sheet-actions">
        <button class="btn btn-secondary btn-small" id="memoSheetCancelBtn">ì·¨ì†Œ</button>
        <button class="btn btn-primary btn-small" id="memoSheetSaveBtn">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ====== íˆìŠ¤í† ë¦¬ ë©”ëª¨ ëª¨ë‹¬(ê´€ë¦¬ì/ì¸ì‡„ê¸°ì‚¬ë§Œ ìˆ˜ì • ê°€ëŠ¥, ì¡°íšŒëª¨ë“œì—ì„œëŠ” ë²„íŠ¼ ìˆ¨ê¹€) ====== -->
  <div id="historyNoteModal" class="note-modal">
    <div class="note-modal-card">
      <div class="note-modal-title">íˆìŠ¤í† ë¦¬ ë©”ëª¨</div>
      <div class="note-modal-text">ì´ ë³€ê²½ ê¸°ë¡ì— ë©”ëª¨ë¥¼ ë‚¨ê¸¸ ìˆ˜ ìˆì–´.</div>
      <textarea id="historyNoteTextarea" class="memo-sheet-textarea" placeholder="ì˜ˆ: ê²¹ì¹¨ ì´ìŠˆë¡œ ìœ„ì¹˜ ë³€ê²½"></textarea>
      <div class="note-modal-actions">
        <button class="btn btn-secondary btn-small" id="historyNoteCancelBtn">ì·¨ì†Œ</button>
        <button class="btn btn-primary btn-small" id="historyNoteSaveBtn">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ====== íŒ ì‚¬ìš©ë“±ë¡ ëª¨ë‹¬ ====== -->
  <div id="plateUseModal" class="note-modal">
    <div class="note-modal-card">
      <div class="note-modal-title">íŒ ì‚¬ìš©ë“±ë¡</div>
      <div class="note-modal-text">ì´ íŒì„ ì‚¬ìš©í•œ ê¸°ë¡ì„ ë‚¨ê²¨.</div>

      <div class="form-row">
        <label for="useByInput">ì¸ì‡„ê¸°ì‚¬ ì´ë¦„ *</label>
        <input type="text" id="useByInput" placeholder="ì˜ˆ: í™ê¸¸ë™" />
      </div>
      <div class="form-row">
        <label for="useQtyInput">ì¸ì‡„ ìˆ˜ëŸ‰ *</label>
        <input type="number" id="useQtyInput" placeholder="ì˜ˆ: 1200" />
      </div>
      <div class="form-row">
        <label for="useMemoInput">ë©”ëª¨</label>
        <input type="text" id="useMemoInput" placeholder="ì„ íƒ" />
      </div>

      <div class="note-modal-actions">
        <button class="btn btn-secondary btn-small" id="plateUseCancelBtn">ì·¨ì†Œ</button>
        <button class="btn btn-primary btn-small" id="plateUseSaveBtn">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ====== íŒ íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ ====== -->
  <div id="plateHistoryModal" class="note-modal">
    <div class="note-modal-card">
      <div class="note-modal-title">íŒ ì‚¬ìš© íˆìŠ¤í† ë¦¬</div>
      <div class="note-modal-text">ìµœê·¼ ê¸°ë¡ì„ ë³´ì—¬ì¤˜.</div>
      <div id="plateUsageList" class="history-list"></div>
      <div class="note-modal-actions">
        <button class="btn btn-secondary btn-small" id="plateHistoryCloseBtn">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ì‹¤ì œ ì•± -->
  <div id="appContainer" style="display:none;">
    <div class="app-header">
      <div class="title-wrap">
        <div class="app-title">FILM FIND</div>
        <div class="app-subtitle" id="appSubtitle">í•„ë¦„/íŒ ê´€ë¦¬</div>
      </div>
      <div id="deviceBadge" class="device-badge">
        <span class="device-dot"></span>
        <span id="deviceBadgeText"></span>
        <span id="modePill" class="mode-pill"></span>
      </div>
    </div>

    <div class="app-shell">
      <div class="top-bar">
        <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ (ëª¨ë“œì— ë”°ë¼ í•„ë¦„/íŒì´ ë‹¬ë¼ì§)" />
        <button class="btn btn-primary" id="newFilmBtn">+ ìƒˆ í•„ë¦„</button>
        <button class="btn btn-primary" id="newPlateBtn" style="display:none;">+ ìƒˆ íŒ</button>
      </div>

      <div class="tools-bar">
        <button class="btn btn-secondary btn-small" id="settingsBtn">âš™ ì„¤ì •</button>
        <button class="btn btn-secondary btn-small" id="historyBtn">ğŸ“œ íˆìŠ¤í† ë¦¬</button>
        <button class="btn btn-secondary btn-small" id="trashBtn" style="display:none;">ğŸ—‘ íœ´ì§€í†µ</button>
        <button class="btn btn-secondary btn-small" id="exportBtn">ë‚´ë³´ë‚´ê¸°</button>
        <button class="btn btn-secondary btn-small" id="importBtn">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <input type="file" id="importFile" accept="application/json" style="display:none;" />
      </div>

      <!-- íƒ­ (ê´€ë¦¬ì/ì¡°íšŒëª¨ë“œì—ì„œë§Œ ë…¸ì¶œ, ì¸ì‡„ê¸°ì‚¬ëª¨ë“œì—ì„œëŠ” íŒë§Œ ê°•ì œ) -->
      <div id="tabbar" class="tabbar" style="display:none;">
        <button class="tab-btn active" id="tabFilms">í•„ë¦„</button>
        <button class="tab-btn" id="tabPlates">íŒ</button>
      </div>

      <div class="count-wrap">
        <div id="countBar" class="count-bar">ì´ 0ê°œ</div>
        <button class="btn btn-secondary btn-small" id="viewToggleBtn">ê°¤ëŸ¬ë¦¬</button>
      </div>

      <!-- ì„¤ì • ì¹´ë“œ -->
      <div class="form-card" id="settingsCard" style="display:none;">
        <div class="form-row">
          <div class="settings-section-title">ì´ ê¸°ê¸° ì´ë¦„</div>
          <div class="settings-help">ì´ ê¸°ê¸°ì—ì„œë§Œ í‘œì‹œë¼.</div>
          <input type="text" id="deviceNameInput" placeholder="ì˜ˆ: ê°€ì€í°" />
        </div>

        <div class="form-row" id="filmSortRow">
          <div class="settings-section-title">í•„ë¦„ ì •ë ¬</div>
          <div class="settings-help">í•„ë¦„ ë¦¬ìŠ¤íŠ¸ ì •ë ¬ ê¸°ì¤€.</div>
          <select id="sortOptionSelect">
            <option value="updated">ìµœê·¼ ìˆ˜ì •ìˆœ</option>
            <option value="name">ì œí’ˆëª… ê°€ë‚˜ë‹¤ìˆœ</option>
            <option value="number">í•„ë¦„ë²ˆí˜¸ ìˆœ</option>
            <option value="lastUsed">ë§ˆì§€ë§‰ ì‚¬ìš©ì¼ ìµœì‹ ìˆœ</option>
          </select>
        </div>

        <div class="form-row" id="plateSortRow">
          <div class="settings-section-title">íŒ ì •ë ¬</div>
          <div class="settings-help">íŒ ë¦¬ìŠ¤íŠ¸ ì •ë ¬ ê¸°ì¤€.</div>
          <select id="plateSortSelect">
            <option value="updated">ìµœê·¼ìˆ˜ì •ìˆœ</option>
            <option value="lastUsed">ë§ˆì§€ë§‰ì‚¬ìš©ìˆœ</option>
            <option value="created">ìµœê·¼ì œì‘ìˆœ</option>
          </select>
        </div>

        <div class="form-row">
          <div class="settings-section-title">í…Œë§ˆ ìƒ‰ìƒ</div>
          <div class="settings-help">ì•± ìƒ‰ ë¶„ìœ„ê¸°.</div>
          <select id="themeSelect">
            <option value="default">ë¼ë²¤ë”</option>
            <option value="mint">ë¯¼íŠ¸</option>
            <option value="peach">í”¼ì¹˜</option>
            <option value="night">ë‚˜ì´íŠ¸</option>
          </select>
        </div>

        <!-- ê´€ë¦¬ìë§Œ ë¹„ë²ˆ ë³€ê²½ ê°€ëŠ¥ -->
        <div class="form-row" id="pwAdminOnlyBlock" style="display:none;">
          <div class="settings-section-title nowrap">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ (ê´€ë¦¬ì ì „ìš©)</div>
          <div class="settings-help">ì„¸ ëª¨ë“œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆì–´.</div>

          <label class="nowrap" style="font-size:12px; color:var(--label-color); margin-bottom:4px;">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</label>
          <input type="password" id="pwAdminNew" placeholder="0605 (ìƒˆ ê°’)" />

          <label style="font-size:12px; color:var(--label-color); margin:10px 0 4px;">ì¸ì‡„ê¸°ì‚¬ ë¹„ë°€ë²ˆí˜¸</label>
          <input type="password" id="pwPrintNew" placeholder="1234 (ìƒˆ ê°’)" />

          <label style="font-size:12px; color:var(--label-color); margin:10px 0 4px;">ì¡°íšŒ ë¹„ë°€ë²ˆí˜¸</label>
          <input type="password" id="pwViewNew" placeholder="0000 (ìƒˆ ê°’)" />

          <div style="margin-top:10px; font-size:11px; color:var(--text-sub);">
            â€» ë³€ê²½ í›„ì—ëŠ” ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¡œ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì•¼ í•  ìˆ˜ ìˆì–´.
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary btn-small" id="closeSettingsBtn">ë‹«ê¸°</button>
          <button type="button" class="btn btn-primary btn-small" id="saveSettingsBtn">ì €ì¥</button>
        </div>
      </div>

      <!-- íˆìŠ¤í† ë¦¬ ì¹´ë“œ -->
      <div class="form-card" id="historyCard" style="display:none;">
        <div class="settings-section-title">ğŸ“œ íˆìŠ¤í† ë¦¬</div>
        <div class="settings-help" id="historyHelp">
          ìµœê·¼ ê¸°ë¡ì„ ë³´ì—¬ì¤„ê²Œ.
        </div>
        <div id="historyList" class="history-list"></div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary btn-small" id="closeHistoryBtn">ë‹«ê¸°</button>
        </div>
      </div>

      <!-- íœ´ì§€í†µ ì¹´ë“œ (ê´€ë¦¬ì ì „ìš©) -->
      <div class="form-card" id="trashCard" style="display:none;">
        <div class="settings-section-title">ğŸ—‘ íŒ íœ´ì§€í†µ</div>
        <div class="settings-help">ì‚­ì œëœ íŒì´ ì—¬ê¸°ë¡œ ì´ë™ë¼. 50ê°œê°€ ë„˜ìœ¼ë©´ ì˜¤ë˜ëœ ê²ƒë¶€í„° ìë™ ì‚­ì œë¼.</div>
        <div id="trashList" class="list"></div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary btn-small" id="closeTrashBtn">ë‹«ê¸°</button>
        </div>
      </div>

      <!-- í•„ë¦„ ì…ë ¥ í¼ (ê´€ë¦¬ìë§Œ) -->
      <div class="form-card" id="filmFormCard" style="display:none;">
        <form id="filmForm">
          <input type="hidden" id="filmId" />
          <div class="form-row">
            <label for="productName">ì œí’ˆ ì´ë¦„ *</label>
            <input type="text" id="productName" required />
          </div>
          <div class="form-row">
            <label for="filmNumber">í•„ë¦„ ë²ˆí˜¸ *</label>
            <input type="text" id="filmNumber" required />
          </div>
          <div class="form-row">
            <label for="method">ì œíŒ íƒ€ì…</label>
            <input type="text" id="method" placeholder="ì˜ˆ: ë°”íƒ•, ë¬¸ì, ìŠ¤ëª¨ê·¸ ë“±" />
          </div>
          <div class="form-row">
            <label for="mesh">MESH</label>
            <input type="text" id="mesh" placeholder="ì˜ˆ: 180T, 200ë©”ì‰¬ ë“±" />
          </div>

          <div class="form-row">
            <label>í•„ë¦„ ì œíŒ ë°©ë²•</label>
            <div class="toggle-group" data-group="frontBack">
              <button type="button" class="toggle-btn" data-value="ì „ë©´">ì „ë©´</button>
              <button type="button" class="toggle-btn" data-value="ë°°ë©´">ë°°ë©´</button>
            </div>
            <div class="toggle-group" data-group="leftRight">
              <button type="button" class="toggle-btn" data-value="ì¢Œ">ì¢Œ</button>
              <button type="button" class="toggle-btn" data-value="ìš°">ìš°</button>
            </div>
            <div class="toggle-group" data-group="upDown">
              <button type="button" class="toggle-btn" data-value="ìƒ">ìƒ</button>
              <button type="button" class="toggle-btn" data-value="í•˜">í•˜</button>
            </div>
            <small style="font-size:11px; color:var(--text-sub);">
              ì „ë©´/ë°°ë©´ + ì¢Œ/ìš° + ìƒ/í•˜ ì¡°í•©
            </small>
          </div>

          <div class="form-row">
            <label for="location">í•„ë¦„ ìœ„ì¹˜</label>
            <input type="text" id="location" placeholder="ì˜ˆ: A-3 ì„œë, 4ì¸µ ìš°ì¸¡ ë™ ë“±" />
          </div>

          <div class="form-row">
            <label for="requestPrinter">ìš”ì²­ ì¸ì‡„ì</label>
            <select id="requestPrinter">
              <option value="">ì„ íƒ ì•ˆ í•¨</option>
              <option value="ì´ì°½ë¯¼ ë¶€ì¥ë‹˜">ì´ì°½ë¯¼ ë¶€ì¥ë‹˜</option>
              <option value="ê³ ê´‘ìš´ ê³¼ì¥ë‹˜">ê³ ê´‘ìš´ ê³¼ì¥ë‹˜</option>
              <option value="ê¹€ê·œí—Œ ì°¨ì¥ë‹˜">ê¹€ê·œí—Œ ì°¨ì¥ë‹˜</option>
              <option value="ë°•ì¬í˜„ ëŒ€ë¦¬ë‹˜">ë°•ì¬í˜„ ëŒ€ë¦¬ë‹˜</option>
              <option value="ì¡°ì˜ë¹ˆ ëŒ€ë¦¬ë‹˜">ì¡°ì˜ë¹ˆ ëŒ€ë¦¬ë‹˜</option>
              <option value="ê¹€í˜„ê·œ ëŒ€ë¦¬ë‹˜">ê¹€í˜„ê·œ ëŒ€ë¦¬ë‹˜</option>
              <option value="ì¥ì§„ìš° ëŒ€ë¦¬ë‹˜">ì¥ì§„ìš° ëŒ€ë¦¬ë‹˜</option>
              <option value="ê¹€ë¯¸ì€ ì£¼ì„ë‹˜">ê¹€ë¯¸ì€ ì£¼ì„ë‹˜</option>
              <option value="ì´ìˆ˜ì•ˆ ì‚¬ì›ë‹˜">ì´ìˆ˜ì•ˆ ì‚¬ì›ë‹˜</option>
              <option value="ë°•ì§€ì•ˆ ì‚¬ì›ë‹˜">ë°•ì§€ì•ˆ ì‚¬ì›ë‹˜</option>
              <option value="ê¹€ì¸ì„  ì‚¬ì›ë‹˜">ê¹€ì¸ì„  ì‚¬ì›ë‹˜</option>
              <option value="ê¹€ìš©ì› ì‚¬ì›ë‹˜">ê¹€ìš©ì› ì‚¬ì›ë‹˜</option>
              <option value="ìµœì„±ê·œ ì‚¬ì›ë‹˜">ìµœì„±ê·œ ì‚¬ì›ë‹˜</option>
            </select>
          </div>

          <div class="form-row">
            <label for="lastUsed">ë§ˆì§€ë§‰ ì‚¬ìš©ì¼</label>
            <div style="display:flex; gap:6px;">
              <input type="date" id="lastUsed" style="flex:1;" />
              <button type="button" class="btn btn-secondary btn-small" id="setTodayBtn">ì˜¤ëŠ˜</button>
            </div>
          </div>

          <div class="form-row">
            <label for="imageInput">í•„ë¦„ ì‚¬ì§„ (ì„ íƒ)</label>
            <input type="file" id="imageInput" accept="image/*" />
            <small style="font-size:11px; color:var(--text-sub);">
              Â· ìƒˆ í•„ë¦„ì—ëŠ” ì‚¬ì§„ì„ ì¶”ê°€í•˜ê³ ,<br/>
              Â· ìˆ˜ì • ì‹œ ì‚¬ì§„ì„ ë°”ê¾¸ê³  ì‹¶ì„ ë•Œë§Œ ë‹¤ì‹œ ì„ íƒí•˜ì„¸ìš”.
            </small>

            <div id="imagePreviewWrapper" style="margin-top:8px; display:none; align-items:center; gap:6px;">
              <img id="imagePreview" alt="ë¯¸ë¦¬ë³´ê¸°"
                   style="width:70px; height:70px; border-radius:10px; object-fit:cover; background:#eef1ff;" />
              <button type="button" class="btn btn-secondary btn-small" id="rotateLeftBtn">âŸ² 90Â°</button>
              <button type="button" class="btn btn-secondary btn-small" id="rotateRightBtn">âŸ³ 90Â°</button>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="cancelFilmBtn">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn-primary" id="saveFilmBtn">ì €ì¥</button>
          </div>
        </form>
      </div>

      <!-- íŒ ì…ë ¥ í¼ (ê´€ë¦¬ìë§Œ, â€œí•„ë¦„ì—ì„œ íŒ ë“±ë¡â€ìœ¼ë¡œë§Œ ì—´ë¦¼) -->
      <div class="form-card" id="plateFormCard" style="display:none;">
        <form id="plateForm">
          <input type="hidden" id="plateId" />
          <input type="hidden" id="plateFilmId" />

          <div class="form-row">
            <div class="settings-section-title">ì›ë³¸ í•„ë¦„</div>
            <div class="settings-help" id="plateFilmSummary">-</div>
          </div>

          <div class="form-row">
            <label for="plateNo">íŒ ë²ˆí˜¸ *</label>
            <input type="text" id="plateNo" placeholder="ì˜ˆ: 0000-1" required />
          </div>

          <div class="form-row">
            <label for="plateTension">í…ì…˜</label>
            <input type="text" id="plateTension" placeholder="ì˜ˆ: 23~25" />
          </div>

          <div class="form-row">
            <label for="platePosition">íŒ ìœ„ì¹˜</label>
            <input type="text" id="platePosition" placeholder="ì˜ˆ: 4-2-1.6" />
          </div>

          <div class="form-row">
            <label for="plateMesh">ë©”ì‰¬</label>
            <input type="text" id="plateMesh" placeholder="ì˜ˆ: 200ë©”ì‰¬" />
          </div>

          <div class="form-row">
            <label for="plateMaxQty">ê¸°ë³¸ ìµœëŒ€ ì‚¬ìš© ìˆ˜ëŸ‰</label>
            <input type="number" id="plateMaxQty" />
            <div style="font-size:11px; color:var(--text-sub); margin-top:4px;">ê¸°ë³¸ê°’ 5000, í•„ìš”í•˜ë©´ ìˆ˜ì • ê°€ëŠ¥</div>
          </div>

          <div class="form-row">
            <label for="plateMemo">íŒ ë©”ëª¨</label>
            <textarea id="plateMemo" placeholder="ì˜ˆ: ìš°ì¸¡ 2mm ë°€ë¦¼ ì£¼ì˜"></textarea>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="cancelPlateBtn">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn-primary" id="savePlateBtn">ì €ì¥</button>
          </div>
        </form>
      </div>

      <div id="list" class="list"></div>
      <div id="emptyText" class="empty-text" style="display:none;">
        ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
      </div>

      <div id="loadingSpinner" class="spinner-wrapper">
        <div class="spinner-circle"></div>
      </div>
    </div>
  </div>

  <button id="scrollTopBtn" class="scroll-top-btn">â†‘</button>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <script>
    /* ---------- Firebase ì„¤ì • ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyBrBnVuXca2Ou1oMFOLzq3KGEN8xiK5L_U",
      authDomain: "film-find-5242d.firebaseapp.com",
      projectId: "film-find-5242d",
      storageBucket: "film-find-5242d.firebasestorage.app",
      messagingSenderId: "185123433624",
      appId: "1:185123433624:web:269eb9b4b6437887f2f4ed",
      measurementId: "G-V9KL8XS9KJ"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const FILM_COLLECTION = "films";
    const PLATE_COLLECTION = "plates";
    const HISTORY_COLLECTION = "history";
    const TRASH_COLLECTION = "platesTrash";

    /* ---------- ëª¨ë“œ/ë¹„ë°€ë²ˆí˜¸ ---------- */
    const MODE_ADMIN = "admin";
    const MODE_PRINT = "print";
    const MODE_VIEW  = "view";

    const PW_ADMIN_KEY = "ff_pw_admin";
    const PW_PRINT_KEY = "ff_pw_print";
    const PW_VIEW_KEY  = "ff_pw_view";

    function getPwAdmin() { return localStorage.getItem(PW_ADMIN_KEY) || "0605"; }
    function getPwPrint() { return localStorage.getItem(PW_PRINT_KEY) || "1234"; }
    function getPwView()  { return localStorage.getItem(PW_VIEW_KEY)  || "0000"; }

    function setPwAdmin(v){ localStorage.setItem(PW_ADMIN_KEY, v); }
    function setPwPrint(v){ localStorage.setItem(PW_PRINT_KEY, v); }
    function setPwView(v) { localStorage.setItem(PW_VIEW_KEY, v); }

    const UNLOCK_KEY = "filmAppUnlocked";
    const MODE_KEY   = "filmAppMode";

    function getModeLabel(mode){
      if (mode === MODE_ADMIN) return "ê´€ë¦¬ì";
      if (mode === MODE_PRINT) return "ì¸ì‡„ê¸°ì‚¬";
      return "ì¡°íšŒ";
    }

    let currentMode = MODE_VIEW;

    /* ---------- ì•± ì„¤ì •/í‚¤ ---------- */
    const DEVICE_KEY = "filmDeviceLabel";
    const SORT_KEY = "filmSortOption";      // í•„ë¦„ ì •ë ¬
    const PLATE_SORT_KEY = "plateSortOption"; // íŒ ì •ë ¬
    const THEME_KEY = "filmTheme";
    const VIEW_KEY = "filmViewMode";
    const TAB_KEY  = "ff_active_tab";

    function getDeviceLabel() { return localStorage.getItem(DEVICE_KEY) || ""; }
    function setDeviceLabel(label) {
      localStorage.setItem(DEVICE_KEY, label);
      const badgeText = document.getElementById("deviceBadgeText");
      if (badgeText) badgeText.textContent = label || "ê¸°ê¸° ë¯¸ì§€ì •";
    }

    function getSortOption() { return localStorage.getItem(SORT_KEY) || "updated"; }
    function setSortOption(opt) { localStorage.setItem(SORT_KEY, opt); }

    function getPlateSortOption(){ return localStorage.getItem(PLATE_SORT_KEY) || "updated"; }
    function setPlateSortOption(opt){ localStorage.setItem(PLATE_SORT_KEY, opt); }

    function getTheme() { return localStorage.getItem(THEME_KEY) || "default"; }
    function setTheme(theme) {
      localStorage.setItem(THEME_KEY, theme);
      const root = document.documentElement;
      if (theme === "default") root.removeAttribute("data-theme");
      else root.setAttribute("data-theme", theme);
    }

    let currentViewMode = localStorage.getItem(VIEW_KEY) || "list";
    function setViewMode(mode) {
      currentViewMode = mode;
      localStorage.setItem(VIEW_KEY, mode);
      applyViewMode();
    }

    function showToast(msg) {
      const toast = document.getElementById("toast");
      if (!toast) return;
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 1800);
    }

    function formatDateTime(ts){
      if (!ts) return "-";
      const d = new Date(ts);
      if (isNaN(d.getTime())) return "-";
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `${y}-${m}-${day} ${hh}:${mm}`;
    }

    function formatDate(iso) { return iso || "-"; }

    /* ---------- ìƒíƒœ ---------- */
    let films = [];
    let plates = [];
    let currentSearchText = "";
    let unsubscribeFilms = null;
    let unsubscribePlates = null;

    let historyEntries = [];
    let historyLoaded = false;

    const VISIBLE_STEP = 30;
    let visibleCount = VISIBLE_STEP;
    let loadingMore = false;

    let activeTab = localStorage.getItem(TAB_KEY) || "films"; // films | plates

    /* ì´ë¯¸ì§€ ì„ íƒ/íšŒì „ ìƒíƒœ(í•„ë¦„) */
    let currentSelectedImageDataUrl = null;
    let currentImageRotation = 0; // 0,90,180,270

    /* ë©”ëª¨ ìŠ¬ë¼ì´ë“œ ìƒíƒœ */
    let memoContext = { type: null, id: null }; // type: film|plate
    let currentHistoryNoteId = null;

    /* íŒ ëª¨ë‹¬ ìƒíƒœ */
    let currentUsePlateId = null;
    let currentUsagePlateId = null;

    /* ---------- ê¶Œí•œ ì²´í¬ ---------- */
    const can = {
      get isAdmin(){ return currentMode === MODE_ADMIN; },
      get isPrint(){ return currentMode === MODE_PRINT; },
      get isView(){ return currentMode === MODE_VIEW; },

      // Films
      get canSeeFilms(){ return currentMode !== MODE_PRINT; },           // ì¸ì‡„ê¸°ì‚¬: í•„ë¦„ ë¦¬ìŠ¤íŠ¸ ì•„ì˜ˆ X
      get canEditFilms(){ return currentMode === MODE_ADMIN; },
      get canDeleteFilms(){ return currentMode === MODE_ADMIN; },
      get canCreateFilms(){ return currentMode === MODE_ADMIN; },
      get canMemoFilms(){ return currentMode === MODE_ADMIN; },

      // Plates
      get canSeePlates(){ return true; },
      get canEditPlates(){ return currentMode === MODE_ADMIN; },
      get canDeletePlates(){ return currentMode === MODE_ADMIN; },
      get canCreatePlate(){ return currentMode === MODE_ADMIN; },        // â€œí•„ë¦„ì—ì„œ íŒ ë“±ë¡â€ë§Œ
      get canRegisterUsage(){ return currentMode === MODE_ADMIN || currentMode === MODE_PRINT; },
      get canSeePlateHistory(){ return true; },

      // Settings
      get canChangePasswords(){ return currentMode === MODE_ADMIN; },

      // Trash
      get canSeeTrash(){ return currentMode === MODE_ADMIN; },

      // History note edit
      get canEditHistoryNote(){ return currentMode === MODE_ADMIN || currentMode === MODE_PRINT; }, // ì¡°íšŒëª¨ë“œ: ìš”ì•½ë§Œ
    };

    /* ---------- UI: ëª¨ë“œ/íƒ­ ë°˜ì˜ ---------- */
    function applyModeToUI(){
      const modePill = document.getElementById("modePill");
      if (modePill) modePill.textContent = getModeLabel(currentMode);

      const tabbar = document.getElementById("tabbar");
      const newFilmBtn = document.getElementById("newFilmBtn");
      const newPlateBtn = document.getElementById("newPlateBtn");
      const trashBtn = document.getElementById("trashBtn");
      const viewToggleBtn = document.getElementById("viewToggleBtn");

      // íƒ­
      if (currentMode === MODE_PRINT){
        if (tabbar) tabbar.style.display = "none";
        activeTab = "plates";
        localStorage.setItem(TAB_KEY, activeTab);
      } else {
        if (tabbar) tabbar.style.display = "flex";
      }

      // ìƒˆ í•„ë¦„ ë²„íŠ¼: ê´€ë¦¬ìë§Œ
      if (newFilmBtn) newFilmBtn.style.display = can.canCreateFilms ? "inline-block" : "none";

      // ìƒˆ íŒ ë²„íŠ¼: ë‹¨ë… ìƒì„± X (í•­ìƒ ìˆ¨ê¹€)
      if (newPlateBtn) newPlateBtn.style.display = "none";

      // íœ´ì§€í†µ
      if (trashBtn) trashBtn.style.display = can.canSeeTrash ? "inline-block" : "none";

      // ë·° í† ê¸€(í•„ë¦„ ê°¤ëŸ¬ë¦¬): íŒ íƒ­ì—ì„œëŠ” ìˆ¨ê¹€
      if (viewToggleBtn) {
        viewToggleBtn.style.display = (activeTab === "films") ? "inline-block" : "none";
      }

      // ì„¤ì • ë¹„ë²ˆ ë¸”ë¡
      const pwBlock = document.getElementById("pwAdminOnlyBlock");
      if (pwBlock) pwBlock.style.display = can.canChangePasswords ? "block" : "none";

      // ì…ë ¥ í¼ ë‹«ê¸°
      closeAllPanels();

      // ê²€ìƒ‰ placeholder
      const search = document.getElementById("searchInput");
      if (search){
        if (activeTab === "films") search.placeholder = "ì œí’ˆëª… / í•„ë¦„ë²ˆí˜¸ / ì œíŒíƒ€ì… / ìœ„ì¹˜ / ì œíŒë°©ë²• / MESH / ìš”ì²­ ì¸ì‡„ì";
        else search.placeholder = "íŒë²ˆí˜¸ / ì œí’ˆëª… / í•„ë¦„ë²ˆí˜¸ / ìœ„ì¹˜ / ë©”ì‰¬ / í…ì…˜ / ë§ˆì§€ë§‰ì‚¬ìš©";
      }

      // íƒ­ ë²„íŠ¼ active
      const tabFilms = document.getElementById("tabFilms");
      const tabPlates = document.getElementById("tabPlates");
      if (tabFilms && tabPlates){
        tabFilms.classList.toggle("active", activeTab === "films");
        tabPlates.classList.toggle("active", activeTab === "plates");
      }

      // ë Œë”
      renderActiveList(currentSearchText);
    }

    function setActiveTab(tab){
      if (currentMode === MODE_PRINT) tab = "plates";
      activeTab = tab;
      localStorage.setItem(TAB_KEY, activeTab);
      applyModeToUI();
    }

    /* ---------- Firestore ì‹¤ì‹œê°„ ë™ê¸°í™” ---------- */
    function startFilmsListener() {
      if (unsubscribeFilms) unsubscribeFilms();
      unsubscribeFilms = db.collection(FILM_COLLECTION).onSnapshot(
        (snapshot) => {
          films = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
          renderActiveList(currentSearchText);
        },
        (error) => {
          console.error("í•„ë¦„ ë™ê¸°í™” ì˜¤ë¥˜:", error);
          showToast("í•„ë¦„ ë™ê¸°í™” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´.");
        }
      );
    }

    function startPlatesListener(){
      if (unsubscribePlates) unsubscribePlates();
      unsubscribePlates = db.collection(PLATE_COLLECTION).onSnapshot(
        (snapshot) => {
          plates = snapshot.docs.map((doc)=>({ id: doc.id, ...doc.data() }));
          renderActiveList(currentSearchText);
        },
        (error) => {
          console.error("íŒ ë™ê¸°í™” ì˜¤ë¥˜:", error);
          showToast("íŒ ë™ê¸°í™” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´.");
        }
      );
    }

    /* ---------- íˆìŠ¤í† ë¦¬(í•„ë¦„ ì¤‘ì‹¬) ---------- */
    async function addHistory(action, payload, changes = []) {
      try {
        const entry = {
          action,
          deviceName: getDeviceLabel() || "",
          timestamp: Date.now(),
          changes,
          // film ê´€ë ¨
          filmId: payload.filmId || payload.id || null,
          filmNumber: payload.filmNumber || "",
          productName: payload.productName || "",
          // plate ê´€ë ¨(ìˆìœ¼ë©´ ê¸°ë¡)
          plateId: payload.plateId || null,
          plateNo: payload.plateNo || "",
        };
        await db.collection(HISTORY_COLLECTION).add(entry);
        if (historyLoaded) await loadHistory();
      } catch (e) {
        console.error("íˆìŠ¤í† ë¦¬ ê¸°ë¡ ì˜¤ë¥˜:", e);
      }
    }

    async function loadHistory() {
      try {
        const snap = await db
          .collection(HISTORY_COLLECTION)
          .orderBy("timestamp", "desc")
          .limit(100)
          .get();
        historyEntries = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
        historyLoaded = true;
        renderHistory();
      } catch (e) {
        console.error("íˆìŠ¤í† ë¦¬ ë¡œë“œ ì˜¤ë¥˜:", e);
        showToast("íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´.");
      }
    }
    function actionLabel(action) {
      if (action === "í•„ë¦„ ë“±ë¡") return "í•„ë¦„ ë“±ë¡";
      if (action === "í•„ë¦„ ìˆ˜ì •") return "í•„ë¦„ ìˆ˜ì •";
      if (action === "í•„ë¦„ ì‚­ì œ") return "í•„ë¦„ ì‚­ì œ";
      if (action === "í•„ë¦„ ì˜¤ëŠ˜ì‚¬ìš©") return "í•„ë¦„ ì˜¤ëŠ˜ì‚¬ìš©";
      if (action === "íŒ ë“±ë¡") return "íŒ ë“±ë¡";
      if (action === "íŒ ìˆ˜ì •") return "íŒ ìˆ˜ì •";
      if (action === "íŒ ì‚­ì œ") return "íŒ ì‚­ì œ";
      if (action === "íŒ ì‚¬ìš©ë“±ë¡") return "íŒ ì‚¬ìš©ë“±ë¡";
      return action || "ë³€ê²½";
    }

    function renderHistory() {
      const list = document.getElementById("historyList");
      if (!list) return;
      list.innerHTML = "";

      if (!historyEntries.length) {
        const empty = document.createElement("div");
        empty.className = "history-empty";
        empty.innerHTML = "ì•„ì§ ê¸°ë¡ì´ ì—†ì–´.";
        list.appendChild(empty);
        return;
      }

      const isSummaryOnly = can.isView; // ì¡°íšŒëª¨ë“œ: ìš”ì•½ë§Œ

      historyEntries.forEach((entry) => {
        const row = document.createElement("div");
        row.className = "history-row";

        const ts = formatDateTime(entry.timestamp || 0);
        const device = entry.deviceName || "ê¸°ê¸° ë¯¸ì§€ì •";
        const changesArr = Array.isArray(entry.changes) ? entry.changes : [];
        const noteText = (entry.note || "").trim();

        const filmLabel =
          (entry.filmNumber || "") +
          (entry.productName ? ` (${entry.productName})` : "");

        const plateLabel = entry.plateNo ? ` Â· ${entry.plateNo}` : "";

        // ì¡°íšŒëª¨ë“œì—ì„œëŠ” ì—°í•„ ë²„íŠ¼ ìˆ¨ê¹€ + note ì €ì¥ë„ ê¸ˆì§€
        const pencilHtml = (!isSummaryOnly && can.canEditHistoryNote)
          ? `<button class="btn btn-secondary btn-small" data-id="${entry.id}" style="padding:4px 8px;">âœï¸</button>`
          : "";

        row.innerHTML =
          `<div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">` +
            `<div>` +
              `<span class="history-time">${ts}</span>` +
              `<span class="history-device">${device}</span>` +
              `<span class="history-action-chip">${actionLabel(entry.action)}</span>` +
            `</div>` +
            pencilHtml +
          `</div>` +
          `<div class="history-film">${(filmLabel || "ì •ë³´ ì—†ìŒ")}${plateLabel}</div>` +
          (!isSummaryOnly && changesArr.length
            ? `<div class="history-changes">ë³€ê²½ í•­ëª©: ${changesArr.join(", ")}</div>`
            : "") +
          (!isSummaryOnly && noteText ? `<div style="margin-top:6px; font-size:12px; padding:8px 10px; border-radius:12px; border:1px solid var(--card-border); background: rgba(228,231,255,0.65);">${noteText}</div>` : "");

        const btn = row.querySelector("button[data-id]");
        if (btn) btn.addEventListener("click", () => openHistoryNoteModal(entry.id));

        list.appendChild(row);
      });
    }

    function openHistoryCard() {
      const card = document.getElementById("historyCard");
      const isOpen = card.style.display === "block";
      closeAllPanels();
      if (!isOpen) {
        card.style.display = "block";
        const help = document.getElementById("historyHelp");
        if (help){
          help.innerHTML = can.isView
            ? "ì¡°íšŒ ëª¨ë“œì—ì„œëŠ” ìš”ì•½ë§Œ ë³´ì—¬ì¤˜."
            : "ë“±ë¡/ìˆ˜ì •/ì‚­ì œ/ì‚¬ìš© ê¸°ë¡ì„ ìµœê·¼ 100ê°œê¹Œì§€ ë³´ì—¬ì¤˜.";
        }
        if (!historyLoaded) loadHistory();
        else renderHistory();
      }
    }
    function closeHistoryCard() { document.getElementById("historyCard").style.display = "none"; }

    /* ====== íˆìŠ¤í† ë¦¬ ë©”ëª¨(ëª¨ë‹¬) ====== */
    function openHistoryNoteModal(historyId) {
      if (!can.canEditHistoryNote) return;
      const entry = historyEntries.find((h) => h.id === historyId);
      if (!entry) return;

      currentHistoryNoteId = historyId;
      const modal = document.getElementById("historyNoteModal");
      const ta = document.getElementById("historyNoteTextarea");
      if (ta) ta.value = entry.note || "";
      modal.classList.add("show");
    }

    function closeHistoryNoteModal() {
      document.getElementById("historyNoteModal").classList.remove("show");
      currentHistoryNoteId = null;
    }

    async function saveHistoryNoteModal() {
      if (!currentHistoryNoteId) return;
      if (!can.canEditHistoryNote) return;

      const ta = document.getElementById("historyNoteTextarea");
      const note = (ta.value || "").trim();

      try {
        await db.collection(HISTORY_COLLECTION).doc(currentHistoryNoteId).set(
          { note },
          { merge: true }
        );
        const idx = historyEntries.findIndex((h) => h.id === currentHistoryNoteId);
        if (idx >= 0) historyEntries[idx].note = note;

        renderHistory();
        showToast("íˆìŠ¤í† ë¦¬ ë©”ëª¨ ì €ì¥ë¨.");
        closeHistoryNoteModal();
      } catch (e) {
        console.error(e);
        showToast("íˆìŠ¤í† ë¦¬ ë©”ëª¨ ì €ì¥ ì¤‘ ì˜¤ë¥˜.");
      }
    }

    /* ---------- ì œíŒ ë°©ë²• í† ê¸€(í•„ë¦„) ---------- */
    function clearPlateInfoForm() {
      document.querySelectorAll("#filmFormCard .toggle-btn").forEach((btn) => btn.classList.remove("active"));
    }

    function setPlateInfoToForm(str) {
      clearPlateInfoForm();
      if (!str) return;
      const parts = str.split(" ");
      document.querySelectorAll("#filmFormCard .toggle-btn").forEach((btn) => {
        if (parts.includes(btn.dataset.value)) btn.classList.add("active");
      });
    }

    function getPlateInfoFromForm() {
      const groups = document.querySelectorAll("#filmFormCard .toggle-group");
      const values = [];
      groups.forEach((group) => {
        const active = group.querySelector(".toggle-btn.active");
        if (active) values.push(active.dataset.value);
      });
      return values.join(" ");
    }

    /* ---------- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° & íšŒì „ ---------- */
    function resetImagePreview() {
      const wrapper = document.getElementById("imagePreviewWrapper");
      const img = document.getElementById("imagePreview");
      currentSelectedImageDataUrl = null;
      currentImageRotation = 0;
      if (img) { img.src = ""; img.style.transform = "rotate(0deg)"; }
      if (wrapper) wrapper.style.display = "none";
    }
    function applyPreviewRotation() {
      const img = document.getElementById("imagePreview");
      if (!img) return;
      img.style.transform = "rotate(" + currentImageRotation + "deg)";
    }

    /* ---------- ì´ë¯¸ì§€ ì••ì¶• (íšŒì „ í¬í•¨) ---------- */
    function compressImage(dataUrl, rotationDeg, callback) {
      const img = new Image();
      img.onload = function () {
        const maxSize = 700;
        let w = img.width, h = img.height;
        const ratio = Math.min(maxSize / w, maxSize / h, 1);
        let drawW = Math.round(w * ratio);
        let drawH = Math.round(h * ratio);

        const rot = ((rotationDeg % 360) + 360) % 360;
        let canvasW = drawW, canvasH = drawH;
        if (rot === 90 || rot === 270) { canvasW = drawH; canvasH = drawW; }

        const canvas = document.createElement("canvas");
        canvas.width = canvasW;
        canvas.height = canvasH;
        const ctx = canvas.getContext("2d");

        ctx.translate(canvasW / 2, canvasH / 2);
        ctx.rotate((rot * Math.PI) / 180);
        ctx.drawImage(img, -drawW / 2, -drawH / 2, drawW, drawH);

        const compressed = canvas.toDataURL("image/jpeg", 0.7);
        callback(compressed);
      };
      img.onerror = function () { callback(dataUrl); };
      img.src = dataUrl;
    }

    /* ---------- í•„ë¦„ í¼ ---------- */
    function resetFilmForm() {
      document.getElementById("filmId").value = "";
      document.getElementById("productName").value = "";
      document.getElementById("filmNumber").value = "";
      document.getElementById("method").value = "";
      document.getElementById("mesh").value = "";
      document.getElementById("location").value = "";
      document.getElementById("requestPrinter").value = "";
      document.getElementById("lastUsed").value = "";
      document.getElementById("imageInput").value = "";
      clearPlateInfoForm();
      resetImagePreview();
    }

    function openFilmFormNew(){
      if (!can.canCreateFilms) return;
      resetFilmForm();
      document.getElementById("filmFormCard").style.display = "block";
      document.getElementById("productName").focus();
    }

    function openFilmFormEdit(id){
      if (!can.canEditFilms) return;
      const film = films.find(f=>f.id===id);
      if (!film) return;

      resetImagePreview();
      closeAllPanels();
      document.getElementById("filmId").value = film.id;
      document.getElementById("productName").value = film.productName || "";
      document.getElementById("filmNumber").value = film.filmNumber || "";
      document.getElementById("method").value = film.method || "";
      document.getElementById("mesh").value = film.mesh || "";
      document.getElementById("location").value = film.location || "";
      document.getElementById("requestPrinter").value = film.requestPrinter || "";
      document.getElementById("lastUsed").value = film.lastUsed || "";
      setPlateInfoToForm(film.plateInfo || "");
      document.getElementById("filmFormCard").style.display = "block";
      document.getElementById("productName").focus();
    }

    function closeFilmForm(){
      document.getElementById("filmFormCard").style.display = "none";
      resetFilmForm();
    }

    function computeFilmChanges(oldData, newData, imageChanged) {
      const changes = [];
      if (!oldData) return ["ë“±ë¡"];
      if (oldData.productName !== newData.productName) changes.push("ì œí’ˆ ì´ë¦„");
      if (oldData.filmNumber !== newData.filmNumber) changes.push("í•„ë¦„ ë²ˆí˜¸");
      if (oldData.method !== newData.method) changes.push("ì œíŒ íƒ€ì…");
      if ((oldData.mesh || "") !== (newData.mesh || "")) changes.push("MESH");
      if (oldData.location !== newData.location) changes.push("í•„ë¦„ ìœ„ì¹˜");
      if ((oldData.lastUsed || "") !== (newData.lastUsed || "")) changes.push("ë§ˆì§€ë§‰ ì‚¬ìš©ì¼");
      if ((oldData.plateInfo || "") !== (newData.plateInfo || "")) changes.push("ì œíŒ ë°©ë²•");
      if ((oldData.requestPrinter || "") !== (newData.requestPrinter || "")) changes.push("ìš”ì²­ ì¸ì‡„ì");
      if (imageChanged) changes.push("ì´ë¯¸ì§€");
      return changes;
    }

    async function handleSaveFilm(e){
      e.preventDefault();
      if (!can.canEditFilms && !can.canCreateFilms) return;

      const id = (document.getElementById("filmId").value || "").trim();
      const productName = (document.getElementById("productName").value || "").trim();
      const filmNumber = (document.getElementById("filmNumber").value || "").trim();
      const method = (document.getElementById("method").value || "").trim();
      const mesh = (document.getElementById("mesh").value || "").trim();
      const location = (document.getElementById("location").value || "").trim();
      const requestPrinter = (document.getElementById("requestPrinter").value || "").trim();
      const lastUsed = (document.getElementById("lastUsed").value || "").trim();
      const plateInfo = getPlateInfoFromForm();

      if (!productName || !filmNumber){
        showToast("ì œí’ˆ ì´ë¦„/í•„ë¦„ ë²ˆí˜¸ëŠ” í•„ìˆ˜ì•¼.");
        return;
      }

      // ê¸°ì¡´ ë°ì´í„°
      let oldData = null;
      if (id){
        const old = films.find(f=>f.id===id);
        oldData = old ? { ...old } : null;
      }

      // ì´ë¯¸ì§€: ìƒˆë¡œ ì„ íƒí•œ ê²½ìš°ì—ë§Œ currentSelectedImageDataUrl ì‚¬ìš©
      const imageChanged = !!currentSelectedImageDataUrl;

      const baseData = {
        productName,
        filmNumber,
        method,
        mesh,
        location,
        requestPrinter,
        lastUsed,
        plateInfo,
        updatedAt: Date.now(),
      };

      // ì‹ ê·œë©´ createdAt ì¶”ê°€
      if (!id) baseData.createdAt = Date.now();

      // ì €ì¥
      try {
        showSpinner(true);

        // ì´ë¯¸ì§€ê°€ ìƒˆë¡œ ì„ íƒëìœ¼ë©´ ì••ì¶•+íšŒì „ ë°˜ì˜ í›„ ì €ì¥
        if (imageChanged){
          const compressed = await new Promise((resolve) => {
            compressImage(currentSelectedImageDataUrl, currentImageRotation, resolve);
          });
          baseData.image = compressed;
        }

        let savedId = id;

        if (id){
          await db.collection(FILM_COLLECTION).doc(id).set(baseData, { merge: true });
          const changes = computeFilmChanges(oldData, { ...oldData, ...baseData }, imageChanged);
          await addHistory("í•„ë¦„ ìˆ˜ì •", { filmId: id, filmNumber, productName }, changes);
          showToast("í•„ë¦„ ìˆ˜ì • ì™„ë£Œ.");
        } else {
          const ref = await db.collection(FILM_COLLECTION).add(baseData);
          savedId = ref.id;
          await addHistory("í•„ë¦„ ë“±ë¡", { filmId: savedId, filmNumber, productName }, ["ë“±ë¡"]);
          showToast("í•„ë¦„ ë“±ë¡ ì™„ë£Œ.");
        }

        // í¼ ë‹«ê¸°
        closeFilmForm();
        currentSelectedImageDataUrl = null;
        currentImageRotation = 0;
      } catch (e){
        console.error(e);
        showToast("í•„ë¦„ ì €ì¥ ì¤‘ ì˜¤ë¥˜.");
      } finally {
        showSpinner(false);
      }
    }

    async function deleteFilm(id){
      if (!can.canDeleteFilms) return;
      const film = films.find(f=>f.id===id);
      if (!film) return;

      if (!confirm(`í•„ë¦„ ì‚­ì œí• ê¹Œ?\n${film.filmNumber} (${film.productName})`)) return;

      try {
        showSpinner(true);
        await db.collection(FILM_COLLECTION).doc(id).delete();
        await addHistory("í•„ë¦„ ì‚­ì œ", { filmId: id, filmNumber: film.filmNumber, productName: film.productName }, ["ì‚­ì œ"]);
        showToast("í•„ë¦„ ì‚­ì œë¨.");
      } catch(e){
        console.error(e);
        showToast("í•„ë¦„ ì‚­ì œ ì˜¤ë¥˜.");
      } finally {
        showSpinner(false);
      }
    }

    async function setFilmTodayUsed(id){
      if (!can.canEditFilms) return;
      const film = films.find(f=>f.id===id);
      if (!film) return;
      const today = new Date();
      const iso = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,"0")}-${String(today.getDate()).padStart(2,"0")}`;
      try{
        await db.collection(FILM_COLLECTION).doc(id).set({ lastUsed: iso, updatedAt: Date.now() }, { merge: true });
        await addHistory("í•„ë¦„ ì˜¤ëŠ˜ì‚¬ìš©", { filmId: id, filmNumber: film.filmNumber, productName: film.productName }, ["ë§ˆì§€ë§‰ ì‚¬ìš©ì¼"]);
        showToast("ì˜¤ëŠ˜ë¡œ ê¸°ë¡í–ˆì–´.");
      }catch(e){
        console.error(e);
        showToast("ì €ì¥ ì˜¤ë¥˜.");
      }
    }

    /* ---------- íŒ í¼ ---------- */
    function resetPlateForm(){
      document.getElementById("plateId").value = "";
      document.getElementById("plateFilmId").value = "";
      document.getElementById("plateFilmSummary").textContent = "-";
      document.getElementById("plateNo").value = "";
      document.getElementById("plateTension").value = "";
      document.getElementById("platePosition").value = "";
      document.getElementById("plateMesh").value = "";
      document.getElementById("plateMaxQty").value = 5000;
      document.getElementById("plateMemo").value = "";
    }

    function openPlateFormNewFromFilm(filmId){
      if (!can.canCreatePlate) return;
      const film = films.find(f=>f.id===filmId);
      if (!film) return;

      resetPlateForm();
      closeAllPanels();

      document.getElementById("plateFilmId").value = film.id;
      document.getElementById("plateFilmSummary").textContent =
        `${film.filmNumber || "-"} Â· ${film.productName || "-"}`;

      document.getElementById("plateFormCard").style.display = "block";
      document.getElementById("plateNo").focus();
    }

    function openPlateFormEdit(plateId){
      if (!can.canEditPlates) return;
      const plate = plates.find(p=>p.id===plateId);
      if (!plate) return;

      resetPlateForm();
      closeAllPanels();

      document.getElementById("plateId").value = plate.id;
      document.getElementById("plateFilmId").value = plate.filmId || "";

      const filmLabel = `${plate.filmNumber || "-"} Â· ${plate.productName || "-"}`;
      document.getElementById("plateFilmSummary").textContent = filmLabel;

      document.getElementById("plateNo").value = plate.plateNo || "";
      document.getElementById("plateTension").value = plate.tension || "";
      document.getElementById("platePosition").value = plate.position || "";
      document.getElementById("plateMesh").value = plate.mesh || "";
      document.getElementById("plateMaxQty").value = (plate.maxQty ?? 5000);
      document.getElementById("plateMemo").value = plate.memo || "";

      document.getElementById("plateFormCard").style.display = "block";
      document.getElementById("plateNo").focus();
    }

    function closePlateForm(){
      document.getElementById("plateFormCard").style.display = "none";
      resetPlateForm();
    }

    function computePlateChanges(oldData, newData){
      const changes = [];
      if (!oldData) return ["ë“±ë¡"];
      if ((oldData.plateNo||"") !== (newData.plateNo||"")) changes.push("íŒ ë²ˆí˜¸");
      if ((oldData.tension||"") !== (newData.tension||"")) changes.push("í…ì…˜");
      if ((oldData.position||"") !== (newData.position||"")) changes.push("íŒ ìœ„ì¹˜");
      if ((oldData.mesh||"") !== (newData.mesh||"")) changes.push("ë©”ì‰¬");
      if ((oldData.maxQty??5000) !== (newData.maxQty??5000)) changes.push("ìµœëŒ€ ìˆ˜ëŸ‰");
      if ((oldData.memo||"") !== (newData.memo||"")) changes.push("ë©”ëª¨");
      return changes;
    }

    async function handleSavePlate(e){
      e.preventDefault();
      if (!can.canEditPlates && !can.canCreatePlate) return;

      const id = (document.getElementById("plateId").value || "").trim();
      const filmId = (document.getElementById("plateFilmId").value || "").trim();
      const plateNo = (document.getElementById("plateNo").value || "").trim();
      const tension = (document.getElementById("plateTension").value || "").trim();
      const position = (document.getElementById("platePosition").value || "").trim();
      const mesh = (document.getElementById("plateMesh").value || "").trim();
      const maxQtyRaw = document.getElementById("plateMaxQty").value;
      const maxQty = Number.isFinite(Number(maxQtyRaw)) ? Number(maxQtyRaw) : 5000;
      const memo = (document.getElementById("plateMemo").value || "").trim();

      if (!plateNo){
        showToast("íŒ ë²ˆí˜¸ëŠ” í•„ìˆ˜ì•¼.");
        return;
      }
      if (!filmId){
        showToast("ì›ë³¸ í•„ë¦„ì´ ì—†ì–´. (í•„ë¦„ì—ì„œ íŒ ë“±ë¡ìœ¼ë¡œë§Œ ê°€ëŠ¥)");
        return;
      }

      const film = films.find(f=>f.id===filmId);
      const productName = film?.productName || "";
      const filmNumber = film?.filmNumber || "";

      let oldData = null;
      if (id){
        const old = plates.find(p=>p.id===id);
        oldData = old ? { ...old } : null;
      }

      const data = {
        filmId,
        productName,
        filmNumber,
        plateNo,
        tension,
        position,
        mesh,
        maxQty: Number.isFinite(maxQty) ? maxQty : 5000,
        memo,
        updatedAt: Date.now(),
      };
      if (!id) data.createdAt = Date.now();

      try{
        showSpinner(true);

        if (id){
          await db.collection(PLATE_COLLECTION).doc(id).set(data, { merge: true });
          const changes = computePlateChanges(oldData, { ...oldData, ...data });
          await addHistory("íŒ ìˆ˜ì •", { filmId, filmNumber, productName, plateId: id, plateNo }, changes);
          showToast("íŒ ìˆ˜ì • ì™„ë£Œ.");
        } else {
          const ref = await db.collection(PLATE_COLLECTION).add(data);
          await addHistory("íŒ ë“±ë¡", { filmId, filmNumber, productName, plateId: ref.id, plateNo }, ["ë“±ë¡"]);
          showToast("íŒ ë“±ë¡ ì™„ë£Œ.");
        }

        closePlateForm();
      } catch(e){
        console.error(e);
        showToast("íŒ ì €ì¥ ì˜¤ë¥˜.");
      } finally {
        showSpinner(false);
      }
    }

    /* ---------- íŒ ì‚­ì œ â†’ íœ´ì§€í†µ(ê´€ë¦¬ì) ---------- */
    async function movePlateToTrash(plateId){
      if (!can.canDeletePlates) return;
      const plate = plates.find(p=>p.id===plateId);
      if (!plate) return;

      if (!confirm(`íŒ ì‚­ì œ(íœ´ì§€í†µ ì´ë™)í• ê¹Œ?\n${plate.plateNo} Â· ${plate.productName || ""}`)) return;

      try{
        showSpinner(true);

        const trashData = { ...plate, deletedAt: Date.now() };
        delete trashData.id;

        await db.collection(TRASH_COLLECTION).add(trashData);
        await db.collection(PLATE_COLLECTION).doc(plateId).delete();
        await addHistory("íŒ ì‚­ì œ", {
          filmId: plate.filmId,
          filmNumber: plate.filmNumber,
          productName: plate.productName,
          plateId: plateId,
          plateNo: plate.plateNo
        }, ["ì‚­ì œ"]);

        showToast("íœ´ì§€í†µìœ¼ë¡œ ì´ë™í–ˆì–´.");
        await enforceTrashLimit();
      }catch(e){
        console.error(e);
        showToast("ì‚­ì œ ì˜¤ë¥˜.");
      }finally{
        showSpinner(false);
      }
    }

    async function enforceTrashLimit(){
      try{
        const snap = await db.collection(TRASH_COLLECTION).orderBy("deletedAt","desc").get();
        const docs = snap.docs;
        if (docs.length <= 50) return;

        const toDelete = docs.slice(50);
        const batch = db.batch();
        toDelete.forEach(d=>batch.delete(d.ref));
        await batch.commit();
      }catch(e){
        console.error("íœ´ì§€í†µ ìë™ì •ë¦¬ ì˜¤ë¥˜:", e);
      }
    }

    async function loadTrash(){
      if (!can.canSeeTrash) return;
      const list = document.getElementById("trashList");
      list.innerHTML = "";
      try{
        const snap = await db.collection(TRASH_COLLECTION).orderBy("deletedAt","desc").limit(50).get();
        const trashItems = snap.docs.map(d=>({ id:d.id, ...d.data() }));

        if (!trashItems.length){
          const div = document.createElement("div");
          div.className = "empty-text";
          div.textContent = "íœ´ì§€í†µì´ ë¹„ì–´ìˆì–´.";
          list.appendChild(div);
          return;
        }

        trashItems.forEach(item=>{
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <div class="card-content">
              <div class="card-row-main">
                <div class="card-title">
                  ${escapeHtml(item.plateNo || "-")}
                  <span class="card-tag">ì‚­ì œë¨</span>
                </div>
              </div>
              <div class="card-row"><span class="label">ì œí’ˆ</span>${escapeHtml(item.productName || "-")}</div>
              <div class="card-row"><span class="label">í•„ë¦„</span>${escapeHtml(item.filmNumber || "-")}</div>
              <div class="card-row"><span class="label">ì‚­ì œì‹œê°„</span>${formatDateTime(item.deletedAt || 0)}</div>
              <div class="card-footer">
                <div class="last-used"></div>
                <div class="card-buttons">
                  <button class="btn btn-secondary btn-small" data-act="restore">ë³µêµ¬</button>
                  <button class="btn btn-danger btn-small" data-act="purge">ì˜êµ¬ì‚­ì œ</button>
                </div>
              </div>
            </div>
          `;
          card.querySelector('[data-act="restore"]').addEventListener("click", ()=>restorePlateFromTrash(item.id, item));
          card.querySelector('[data-act="purge"]').addEventListener("click", ()=>purgeTrashItem(item.id));
          list.appendChild(card);
        });
      }catch(e){
        console.error(e);
        showToast("íœ´ì§€í†µ ë¡œë“œ ì˜¤ë¥˜.");
      }
    }

    async function restorePlateFromTrash(trashId, item){
      if (!can.canSeeTrash) return;
      if (!confirm("ì´ íŒì„ ë³µêµ¬í• ê¹Œ?")) return;

      try{
        showSpinner(true);
        const data = { ...item };
        delete data.id;
        delete data.deletedAt;
        data.updatedAt = Date.now();
        if (!data.createdAt) data.createdAt = Date.now();

        await db.collection(PLATE_COLLECTION).add(data);
        await db.collection(TRASH_COLLECTION).doc(trashId).delete();
        showToast("ë³µêµ¬ ì™„ë£Œ.");
        loadTrash();
      }catch(e){
        console.error(e);
        showToast("ë³µêµ¬ ì˜¤ë¥˜.");
      }finally{
        showSpinner(false);
      }
    }

    async function purgeTrashItem(trashId){
      if (!can.canSeeTrash) return;
      if (!confirm("ì˜êµ¬ì‚­ì œí• ê¹Œ? ë˜ëŒë¦´ ìˆ˜ ì—†ì–´.")) return;

      try{
        await db.collection(TRASH_COLLECTION).doc(trashId).delete();
        showToast("ì˜êµ¬ì‚­ì œë¨.");
        loadTrash();
      }catch(e){
        console.error(e);
        showToast("ì‚­ì œ ì˜¤ë¥˜.");
      }
    }

    function openTrashCard(){
      if (!can.canSeeTrash) return;
      const card = document.getElementById("trashCard");
      const isOpen = card.style.display === "block";
      closeAllPanels();
      if (!isOpen){
        card.style.display = "block";
        loadTrash();
      }
    }
    function closeTrashCard(){ document.getElementById("trashCard").style.display = "none"; }

    /* ---------- íŒ ì‚¬ìš©ë“±ë¡ / íˆìŠ¤í† ë¦¬ ---------- */
    function openPlateUseModal(plateId){
      if (!can.canRegisterUsage) return;
      currentUsePlateId = plateId;
      document.getElementById("useByInput").value = (getDeviceLabel() || "").trim(); // ê¸°ë³¸ê°’: ê¸°ê¸°ëª…(ì›í•˜ë©´ ì´ë¦„ìœ¼ë¡œ ì“°ê¸°)
      document.getElementById("useQtyInput").value = "";
      document.getElementById("useMemoInput").value = "";
      document.getElementById("plateUseModal").classList.add("show");
    }
    function closePlateUseModal(){
      document.getElementById("plateUseModal").classList.remove("show");
      currentUsePlateId = null;
    }

    async function savePlateUseModal(){
      if (!currentUsePlateId) return;
      if (!can.canRegisterUsage) return;

      const useBy = (document.getElementById("useByInput").value || "").trim();
      const qtyRaw = document.getElementById("useQtyInput").value;
      const qty = Number(qtyRaw);
      const memo = (document.getElementById("useMemoInput").value || "").trim();

      if (!useBy || !Number.isFinite(qty) || qty <= 0){
        showToast("ì¸ì‡„ê¸°ì‚¬ ì´ë¦„/ìˆ˜ëŸ‰ì„ ì •í™•íˆ ì…ë ¥í•´.");
        return;
      }

      const plate = plates.find(p=>p.id===currentUsePlateId);
      if (!plate){
        showToast("íŒ ì •ë³´ë¥¼ ì°¾ì§€ ëª»í–ˆì–´.");
        return;
      }

      try{
        showSpinner(true);

        // usage subcollection
        const usage = {
          plateId: currentUsePlateId,
          plateNo: plate.plateNo || "",
          filmId: plate.filmId || "",
          filmNumber: plate.filmNumber || "",
          productName: plate.productName || "",
          useBy,
          qty,
          memo,
          deviceName: getDeviceLabel() || "",
          timestamp: Date.now(),
        };

        await db.collection(PLATE_COLLECTION).doc(currentUsePlateId).collection("usages").add(usage);

        // plate ìì²´ lastUsed / usedTotal ì—…ë°ì´íŠ¸(ëˆ„ì )
        const usedTotal = Number(plate.usedTotal || 0) + qty;
        await db.collection(PLATE_COLLECTION).doc(currentUsePlateId).set({
          usedTotal,
          lastUsedAt: Date.now(),
          updatedAt: Date.now(),
        }, { merge:true });

        await addHistory("íŒ ì‚¬ìš©ë“±ë¡", {
          filmId: plate.filmId,
          filmNumber: plate.filmNumber,
          productName: plate.productName,
          plateId: currentUsePlateId,
          plateNo: plate.plateNo
        }, ["ì‚¬ìš©ë“±ë¡"]);

        showToast("ì‚¬ìš©ë“±ë¡ ì™„ë£Œ.");
        closePlateUseModal();
      }catch(e){
        console.error(e);
        showToast("ì‚¬ìš©ë“±ë¡ ì˜¤ë¥˜.");
      }finally{
        showSpinner(false);
      }
    }

    async function openPlateHistoryModal(plateId){
      currentUsagePlateId = plateId;
      const modal = document.getElementById("plateHistoryModal");
      const list = document.getElementById("plateUsageList");
      list.innerHTML = "";

      try{
        const snap = await db
          .collection(PLATE_COLLECTION).doc(plateId)
          .collection("usages")
          .orderBy("timestamp","desc")
          .limit(50)
          .get();

        const rows = snap.docs.map(d=>d.data());
        if (!rows.length){
          const div = document.createElement("div");
          div.className = "history-empty";
          div.textContent = "ê¸°ë¡ì´ ì—†ì–´.";
          list.appendChild(div);
        } else {
          rows.forEach(r=>{
            const row = document.createElement("div");
            row.className = "history-row";
            row.innerHTML = `
              <div>
                <span class="history-time">${formatDateTime(r.timestamp || 0)}</span>
                <span class="history-device">${escapeHtml(r.useBy || "-")}</span>
                <span class="history-action-chip">ìˆ˜ëŸ‰ ${Number(r.qty||0).toLocaleString()}</span>
              </div>
              <div class="history-changes">${escapeHtml(r.memo || "")}</div>
            `;
            list.appendChild(row);
          });
        }
        modal.classList.add("show");
      }catch(e){
        console.error(e);
        showToast("íŒ íˆìŠ¤í† ë¦¬ ë¡œë“œ ì˜¤ë¥˜.");
      }
    }

    function closePlateHistoryModal(){
      document.getElementById("plateHistoryModal").classList.remove("show");
      currentUsagePlateId = null;
    }

    /* ---------- ë©”ëª¨(í•„ë¦„/íŒ ê³µìš©) ---------- */
    function openMemoSheet(type, id){
      // ìš”êµ¬ì‚¬í•­: ë©”ëª¨ ì €ì¥ì€ ê´€ë¦¬ìë§Œ (í•„ë¦„/íŒ ê³µìš©)
      if (!can.isAdmin) return;

      memoContext = { type, id };
      const sheet = document.getElementById("memoSheet");
      const title = document.getElementById("memoSheetTitle");
      const sub = document.getElementById("memoSheetSub");
      const ta = document.getElementById("memoTextarea");

      const item = (type==="film")
        ? films.find(f=>f.id===id)
        : plates.find(p=>p.id===id);

      if (!item) return;

      if (type==="film"){
        title.textContent = "í•„ë¦„ ë©”ëª¨";
        sub.textContent = `${item.filmNumber || "-"} Â· ${item.productName || "-"}`;
        ta.value = item.memo || "";
      } else {
        title.textContent = "íŒ ë©”ëª¨";
        sub.textContent = `${item.plateNo || "-"} Â· ${item.productName || "-"}`;
        ta.value = item.memo || "";
      }

      sheet.classList.add("show");
      setTimeout(()=>ta.focus(), 10);
    }

    function closeMemoSheet(){
      document.getElementById("memoSheet").classList.remove("show");
      memoContext = { type:null, id:null };
    }

    async function saveMemoSheet(){
      if (!can.isAdmin) return;
      const { type, id } = memoContext;
      if (!type || !id) return;
      const ta = document.getElementById("memoTextarea");
      const memo = (ta.value || "").trim();

      try{
        if (type==="film"){
          await db.collection(FILM_COLLECTION).doc(id).set({ memo, updatedAt: Date.now() }, { merge:true });
          showToast("í•„ë¦„ ë©”ëª¨ ì €ì¥ë¨.");
        } else {
          await db.collection(PLATE_COLLECTION).doc(id).set({ memo, updatedAt: Date.now() }, { merge:true });
          showToast("íŒ ë©”ëª¨ ì €ì¥ë¨.");
        }
        closeMemoSheet();
      }catch(e){
        console.error(e);
        showToast("ë©”ëª¨ ì €ì¥ ì˜¤ë¥˜.");
      }
    }

    /* ---------- ë¦¬ìŠ¤íŠ¸ ë Œë” / ê²€ìƒ‰ / ì •ë ¬ ---------- */
    function normalize(s){ return (s||"").toString().toLowerCase(); }

    function applyViewMode(){
      const list = document.getElementById("list");
      const btn = document.getElementById("viewToggleBtn");
      if (!list || !btn) return;

      if (currentViewMode === "gallery"){
        list.classList.add("gallery");
        btn.textContent = "ë¦¬ìŠ¤íŠ¸";
      } else {
        list.classList.remove("gallery");
        btn.textContent = "ê°¤ëŸ¬ë¦¬";
      }
    }

    function sortFilms(arr){
      const opt = getSortOption();
      const copy = [...arr];
      if (opt === "name"){
        copy.sort((a,b)=> (a.productName||"").localeCompare((b.productName||""), "ko"));
      } else if (opt === "number"){
        copy.sort((a,b)=> (a.filmNumber||"").localeCompare((b.filmNumber||""), "ko", { numeric:true }));
      } else if (opt === "lastUsed"){
        copy.sort((a,b)=> (b.lastUsed||"").localeCompare((a.lastUsed||""), "ko"));
      } else {
        copy.sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0));
      }
      return copy;
    }

    function sortPlates(arr){
      const opt = getPlateSortOption();
      const copy = [...arr];
      if (opt === "created"){
        copy.sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
      } else if (opt === "lastUsed"){
        copy.sort((a,b)=> (b.lastUsedAt||0) - (a.lastUsedAt||0));
      } else {
        copy.sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0));
      }
      return copy;
    }

    function filterFilms(arr, q){
      const t = normalize(q);
      if (!t) return arr;
      return arr.filter(f=>{
        const hay = [
          f.productName, f.filmNumber, f.method, f.location, f.plateInfo, f.mesh, f.requestPrinter
        ].map(normalize).join(" ");
        return hay.includes(t);
      });
    }

    function filterPlates(arr, q){
      const t = normalize(q);
      if (!t) return arr;
      return arr.filter(p=>{
        const hay = [
          p.plateNo, p.productName, p.filmNumber, p.position, p.mesh, p.tension
        ].map(normalize).join(" ");
        return hay.includes(t);
      });
    }

    function renderActiveList(searchText){
      currentSearchText = searchText || "";
      const list = document.getElementById("list");
      const empty = document.getElementById("emptyText");
      const count = document.getElementById("countBar");
      const viewToggleBtn = document.getElementById("viewToggleBtn");

      if (!list || !empty || !count) return;

      // íƒ­ë³„ ë·° í† ê¸€ ë…¸ì¶œ
      if (viewToggleBtn){
        viewToggleBtn.style.display = (activeTab==="films") ? "inline-block" : "none";
      }

      list.innerHTML = "";
      empty.style.display = "none";

      // íƒ­: films
      if (activeTab === "films"){
        if (!can.canSeeFilms){
          count.textContent = "í•„ë¦„ì€ ì¸ì‡„ê¸°ì‚¬ ëª¨ë“œì—ì„œ ìˆ¨ê¹€";
          empty.style.display = "block";
          empty.textContent = "ì¸ì‡„ê¸°ì‚¬ ëª¨ë“œì—ì„œëŠ” í•„ë¦„ì„ ë³¼ ìˆ˜ ì—†ì–´.";
          return;
        }

        const filtered = filterFilms(films, currentSearchText);
        const sorted = sortFilms(filtered);

        count.innerHTML = `ì´ <strong>${sorted.length}</strong>ê°œ`;

        if (!sorted.length){
          empty.style.display = "block";
          empty.textContent = "í•„ë¦„ì´ ì—†ì–´.";
          return;
        }

        // ë·° ëª¨ë“œ ì ìš©
        applyViewMode();

        sorted.slice(0, visibleCount).forEach(f=>{
          list.appendChild(renderFilmCard(f));
        });

        return;
      }

      // íƒ­: plates
      const filtered = filterPlates(plates, currentSearchText);
      const sorted = sortPlates(filtered);

      count.innerHTML = `ì´ <strong>${sorted.length}</strong>ê°œ`;

      if (!sorted.length){
        empty.style.display = "block";
        empty.textContent = "íŒì´ ì—†ì–´.";
        return;
      }

      // íŒ íƒ­ì—ì„œëŠ” í•­ìƒ ë¦¬ìŠ¤íŠ¸ ë·°
      list.classList.remove("gallery");

      sorted.slice(0, visibleCount).forEach(p=>{
        list.appendChild(renderPlateCard(p));
      });
    }

    function renderFilmCard(film){
      const card = document.createElement("div");
      card.className = "card";

      // ê²½ê³  ë±ƒì§€: lastUsed ì˜¤ë˜ëìœ¼ë©´ í‘œì‹œ(ì˜ˆ: 180ì¼)
      const warn = document.createElement("div");
      warn.className = "warn-badge";
      warn.textContent = "ì˜¤ë˜ë¨";
      if (film.lastUsed){
        const last = new Date(film.lastUsed);
        if (!isNaN(last.getTime())){
          const days = (Date.now() - last.getTime()) / (1000*60*60*24);
          if (days >= 180) warn.classList.add("show");
        }
      }
      card.appendChild(warn);

      const img = document.createElement("img");
      img.src = film.image || "";
      img.alt = "í•„ë¦„ ì´ë¯¸ì§€";
      img.style.display = film.image ? "block" : "none";
      img.addEventListener("click", ()=> openImageViewer(film.image));
      card.appendChild(img);

      const content = document.createElement("div");
      content.className = "card-content";

      const main = document.createElement("div");
      main.className = "card-row-main";
      main.innerHTML = `
        <div class="card-title">
          ${escapeHtml(film.filmNumber || "-")}
          <span class="card-tag">${escapeHtml(film.productName || "-")}</span>
        </div>
      `;
      content.appendChild(main);

      content.appendChild(makeRow("ì œíŒ íƒ€ì…", film.method || "-"));
      content.appendChild(makeRow("ì œíŒ ë°©ë²•", film.plateInfo || "-"));
      content.appendChild(makeRow("MESH", film.mesh || "-"));
      content.appendChild(makeRow("ìœ„ì¹˜", film.location || "-"));
      content.appendChild(makeRow("ìš”ì²­", film.requestPrinter || "-"));

      const footer = document.createElement("div");
      footer.className = "card-footer";

      const lastUsed = document.createElement("div");
      lastUsed.className = "last-used";
      lastUsed.textContent = `ë§ˆì§€ë§‰ ì‚¬ìš©ì¼: ${formatDate(film.lastUsed)}`;
      footer.appendChild(lastUsed);

      const btns = document.createElement("div");
      btns.className = "card-buttons";

      if (can.isAdmin){
        const btnToday = button("ì˜¤ëŠ˜", "btn btn-secondary btn-small", ()=>setFilmTodayUsed(film.id));
        const btnMemo = button("ë©”ëª¨", "btn btn-secondary btn-small", ()=>openMemoSheet("film", film.id));
        const btnEdit = button("ìˆ˜ì •", "btn btn-secondary btn-small", ()=>openFilmFormEdit(film.id));
        const btnPlate = button("íŒ ë“±ë¡", "btn btn-primary btn-small", ()=>openPlateFormNewFromFilm(film.id));
        const btnDel  = button("ì‚­ì œ", "btn btn-danger btn-small", ()=>deleteFilm(film.id));
        btns.append(btnToday, btnMemo, btnEdit, btnPlate, btnDel);
      }

      footer.appendChild(btns);
      content.appendChild(footer);
      card.appendChild(content);

      // ë©”ëª¨ ìˆìœ¼ë©´ ì¹´ë“œ ê°•ì¡°
      if (can.isAdmin && (film.memo||"").trim()){
        card.classList.add("btn-memo-has");
      }

      return card;
    }

    function renderPlateCard(plate){
      const card = document.createElement("div");
      card.className = "card";

      const content = document.createElement("div");
      content.className = "card-content";

      const main = document.createElement("div");
      main.className = "card-row-main";
      main.innerHTML = `
        <div class="card-title">
          ${escapeHtml(plate.plateNo || "-")}
          <span class="card-tag">${escapeHtml(plate.productName || "-")}</span>
        </div>
      `;
      content.appendChild(main);

      content.appendChild(makeRow("í•„ë¦„", `${plate.filmNumber || "-"}`));
      content.appendChild(makeRow("í…ì…˜", plate.tension || "-"));
      content.appendChild(makeRow("ìœ„ì¹˜", plate.position || "-"));
      content.appendChild(makeRow("ë©”ì‰¬", plate.mesh || "-"));

      const usedTotal = Number(plate.usedTotal || 0);
      const maxQty = Number(plate.maxQty ?? 5000);
      const remain = Math.max(maxQty - usedTotal, 0);

      content.appendChild(makeRow("ëˆ„ì  ì‚¬ìš©", usedTotal ? usedTotal.toLocaleString() : "0"));
      content.appendChild(makeRow("ë‚¨ì€ ìˆ˜ëŸ‰", remain.toLocaleString()));

      const footer = document.createElement("div");
      footer.className = "card-footer";

      const lastUsed = document.createElement("div");
      lastUsed.className = "last-used";
      lastUsed.textContent = `ë§ˆì§€ë§‰ ì‚¬ìš©: ${plate.lastUsedAt ? formatDateTime(plate.lastUsedAt) : "-"}`;
      footer.appendChild(lastUsed);

      const btns = document.createElement("div");
      btns.className = "card-buttons";

      // ì‚¬ìš©ë“±ë¡: ê´€ë¦¬ì/ì¸ì‡„ê¸°ì‚¬
      if (can.canRegisterUsage){
        btns.appendChild(button("ì‚¬ìš©ë“±ë¡", "btn btn-primary btn-small", ()=>openPlateUseModal(plate.id)));
      }

      // íˆìŠ¤í† ë¦¬: ì „ëª¨ë“œ
      btns.appendChild(button("íˆìŠ¤í† ë¦¬", "btn btn-secondary btn-small", ()=>openPlateHistoryModal(plate.id)));

      // ë©”ëª¨: ê´€ë¦¬ìë§Œ
      if (can.isAdmin){
        btns.appendChild(button("ë©”ëª¨", "btn btn-secondary btn-small", ()=>openMemoSheet("plate", plate.id)));
        btns.appendChild(button("ìˆ˜ì •", "btn btn-secondary btn-small", ()=>openPlateFormEdit(plate.id)));
        btns.appendChild(button("ì‚­ì œ", "btn btn-danger btn-small", ()=>movePlateToTrash(plate.id)));
      }

      footer.appendChild(btns);
      content.appendChild(footer);

      card.appendChild(content);

      // ë©”ëª¨ ìˆìœ¼ë©´ ì¹´ë“œ ê°•ì¡°
      if (can.isAdmin && (plate.memo||"").trim()){
        card.classList.add("btn-memo-has");
      }

      return card;
    }

    function makeRow(label, value){
      const div = document.createElement("div");
      div.className = "card-row";
      div.innerHTML = `<span class="label">${escapeHtml(label)}</span>${escapeHtml(value)}`;
      return div;
    }

    function button(text, cls, onClick){
      const b = document.createElement("button");
      b.type = "button";
      b.className = cls;
      b.textContent = text;
      b.addEventListener("click", onClick);
      return b;
    }

    function escapeHtml(str){
      return (str ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /* ---------- ì´ë¯¸ì§€ ë·°ì–´ ---------- */
    function openImageViewer(src){
      if (!src) return;
      const viewer = document.getElementById("imageViewer");
      const img = document.getElementById("viewerImage");
      img.src = src;
      img.style.transform = "scale(1)";
      viewer.style.display = "flex";
    }
    function closeImageViewer(){
      const viewer = document.getElementById("imageViewer");
      const img = document.getElementById("viewerImage");
      img.src = "";
      viewer.style.display = "none";
    }

    /* ---------- ìŠ¤í”¼ë„ˆ ---------- */
    function showSpinner(show){
      const sp = document.getElementById("loadingSpinner");
      if (!sp) return;
      sp.classList.toggle("show", !!show);
    }

    /* ---------- ì„¤ì • ---------- */
    function openSettings(){
      const card = document.getElementById("settingsCard");
      const isOpen = card.style.display === "block";
      closeAllPanels();
      if (isOpen) return;

      card.style.display = "block";

      document.getElementById("deviceNameInput").value = getDeviceLabel();
      document.getElementById("sortOptionSelect").value = getSortOption();
      document.getElementById("plateSortSelect").value = getPlateSortOption();
      document.getElementById("themeSelect").value = getTheme();

      // ê´€ë¦¬ìë§Œ ë¹„ë²ˆ ë³€ê²½ ë¸”ëŸ­ ë…¸ì¶œ(ì´ë¯¸ applyModeToUIì—ì„œ ì²˜ë¦¬)
      if (can.canChangePasswords){
        document.getElementById("pwAdminNew").value = "";
        document.getElementById("pwPrintNew").value = "";
        document.getElementById("pwViewNew").value = "";
      }
    }
    function closeSettings(){ document.getElementById("settingsCard").style.display = "none"; }

    function saveSettings(){
      const label = (document.getElementById("deviceNameInput").value || "").trim();
      setDeviceLabel(label);
      setSortOption(document.getElementById("sortOptionSelect").value);
      setPlateSortOption(document.getElementById("plateSortSelect").value);

      const theme = document.getElementById("themeSelect").value;
      setTheme(theme);

      // ë¹„ë²ˆ ë³€ê²½ì€ ê´€ë¦¬ìë§Œ
      if (can.canChangePasswords){
        const a = (document.getElementById("pwAdminNew").value || "").trim();
        const p = (document.getElementById("pwPrintNew").value || "").trim();
        const v = (document.getElementById("pwViewNew").value || "").trim();

        if (a) setPwAdmin(a);
        if (p) setPwPrint(p);
        if (v) setPwView(v);
      }

      showToast("ì„¤ì • ì €ì¥ë¨.");
      closeSettings();
      applyModeToUI();
    }

    /* ---------- ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸° ---------- */
    async function exportData(){
      try{
        showSpinner(true);

        const filmsSnap = await db.collection(FILM_COLLECTION).get();
        const platesSnap = await db.collection(PLATE_COLLECTION).get();

        const payload = {
          version: 1,
          exportedAt: Date.now(),
          films: filmsSnap.docs.map(d=>({ id:d.id, ...d.data() })),
          plates: platesSnap.docs.map(d=>({ id:d.id, ...d.data() })),
        };

        const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `filmfind_export_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        showToast("ë‚´ë³´ë‚´ê¸° ì™„ë£Œ.");
      }catch(e){
        console.error(e);
        showToast("ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜.");
      }finally{
        showSpinner(false);
      }
    }

    async function importDataFromFile(file){
      if (!can.isAdmin){
        showToast("ë¶ˆëŸ¬ì˜¤ê¸°ëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•´.");
        return;
      }
      try{
        showSpinner(true);
        const text = await file.text();
        const json = JSON.parse(text);

        if (!json || !Array.isArray(json.films) || !Array.isArray(json.plates)){
          showToast("íŒŒì¼ í˜•ì‹ì´ ë‹¬ë¼.");
          return;
        }

        if (!confirm("ë¶ˆëŸ¬ì˜¤ë©´ í˜„ì¬ ë°ì´í„°ì— 'ì¶”ê°€'ë¡œ ë“¤ì–´ê°€. ê³„ì†í• ê¹Œ?")) return;

        // batch insert (idëŠ” ë¬´ì‹œí•˜ê³  ìƒˆë¡œ ìƒì„±)
        const batch = db.batch();
        json.films.forEach(f=>{
          const ref = db.collection(FILM_COLLECTION).doc();
          const data = { ...f };
          delete data.id;
          data.updatedAt = Date.now();
          if (!data.createdAt) data.createdAt = Date.now();
          batch.set(ref, data, { merge:true });
        });
        json.plates.forEach(p=>{
          const ref = db.collection(PLATE_COLLECTION).doc();
          const data = { ...p };
          delete data.id;
          data.updatedAt = Date.now();
          if (!data.createdAt) data.createdAt = Date.now();
          batch.set(ref, data, { merge:true });
        });

        await batch.commit();
        showToast("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ.");
      }catch(e){
        console.error(e);
        showToast("ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜.");
      }finally{
        showSpinner(false);
      }
    }

    /* ---------- ê³µí†µ: íŒ¨ë„ ë‹«ê¸° ---------- */
    function closeAllPanels(){
      closeSettings();
      closeHistoryCard();
      closeTrashCard();
      closeFilmForm();
      closePlateForm();
    }

    /* ---------- ë¬´í•œ ìŠ¤í¬ë¡¤(ê°„ë‹¨) ---------- */
    function handleScrollLoadMore(){
      if (loadingMore) return;
      const nearBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 250;
      if (!nearBottom) return;

      loadingMore = true;
      setTimeout(()=>{
        visibleCount += VISIBLE_STEP;
        renderActiveList(currentSearchText);
        loadingMore = false;
      }, 50);
    }

    /* ---------- ìŠ¤í¬ë¡¤ íƒ‘ ë²„íŠ¼ ---------- */
    function handleScrollTopBtn(){
      const btn = document.getElementById("scrollTopBtn");
      if (!btn) return;
      btn.classList.toggle("show", window.scrollY > 350);
    }

    /* ---------- ì ê¸ˆ/ë¡œê·¸ì¸ ---------- */
    function showLock(){
      document.getElementById("lockScreen").style.display = "flex";
      document.getElementById("appContainer").style.display = "none";
    }
    function showApp(){
      document.getElementById("lockScreen").style.display = "none";
      document.getElementById("appContainer").style.display = "block";
    }

    function doUnlock(pw){
      // íŒíŠ¸/ë¬¸êµ¬ ë…¸ì¶œ ê¸ˆì§€. ì…ë ¥ê°’ìœ¼ë¡œë§Œ íŒë³„.
      const adminPw = getPwAdmin();
      const printPw = getPwPrint();
      const viewPw  = getPwView();

      if (pw === adminPw){
        currentMode = MODE_ADMIN;
      } else if (pw === printPw){
        currentMode = MODE_PRINT;
      } else if (pw === viewPw){
        currentMode = MODE_VIEW;
      } else {
        showToast("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ì–´.");
        return false;
      }

      localStorage.setItem(UNLOCK_KEY, "1");
      localStorage.setItem(MODE_KEY, currentMode);
      return true;
    }

    function tryAutoUnlock(){
      const unlocked = localStorage.getItem(UNLOCK_KEY) === "1";
      const mode = localStorage.getItem(MODE_KEY);
      if (unlocked && mode){
        currentMode = mode;
        return true;
      }
      return false;
    }

    /* ---------- ì´ë²¤íŠ¸ ë°”ì¸ë”© ---------- */
    function bindEvents(){
      // ì ê¸ˆ
      document.getElementById("passwordBtn").addEventListener("click", ()=>{
        const pw = document.getElementById("passwordInput").value || "";
        if (doUnlock(pw)){
          showApp();
          applyModeToUI();
        }
      });
      document.getElementById("passwordInput").addEventListener("keydown", (e)=>{
        if (e.key === "Enter"){
          document.getElementById("passwordBtn").click();
        }
      });

      // ì´ë¯¸ì§€ ë·°ì–´
      document.getElementById("viewerBackdrop").addEventListener("click", closeImageViewer);
      document.getElementById("closeViewerBtn").addEventListener("click", closeImageViewer);

      // íƒ­
      document.getElementById("tabFilms").addEventListener("click", ()=>setActiveTab("films"));
      document.getElementById("tabPlates").addEventListener("click", ()=>setActiveTab("plates"));

      // ê²€ìƒ‰
      document.getElementById("searchInput").addEventListener("input", (e)=>{
        visibleCount = VISIBLE_STEP;
        renderActiveList(e.target.value);
      });

      // ë²„íŠ¼ë“¤
      document.getElementById("newFilmBtn").addEventListener("click", ()=>{
        closeAllPanels();
        openFilmFormNew();
      });

      document.getElementById("settingsBtn").addEventListener("click", openSettings);
      document.getElementById("closeSettingsBtn").addEventListener("click", closeSettings);
      document.getElementById("saveSettingsBtn").addEventListener("click", saveSettings);

      document.getElementById("historyBtn").addEventListener("click", openHistoryCard);
      document.getElementById("closeHistoryBtn").addEventListener("click", closeHistoryCard);

      document.getElementById("trashBtn").addEventListener("click", openTrashCard);
      document.getElementById("closeTrashBtn").addEventListener("click", closeTrashCard);

      document.getElementById("exportBtn").addEventListener("click", exportData);
      document.getElementById("importBtn").addEventListener("click", ()=> document.getElementById("importFile").click());
      document.getElementById("importFile").addEventListener("change", (e)=>{
        const file = e.target.files?.[0];
        if (file) importDataFromFile(file);
        e.target.value = "";
      });

      // ë·° í† ê¸€(í•„ë¦„ë§Œ)
      document.getElementById("viewToggleBtn").addEventListener("click", ()=>{
        setViewMode(currentViewMode === "gallery" ? "list" : "gallery");
        renderActiveList(currentSearchText);
      });

      // í•„ë¦„ í¼
      document.getElementById("filmForm").addEventListener("submit", handleSaveFilm);
      document.getElementById("cancelFilmBtn").addEventListener("click", ()=>{
        closeFilmForm();
      });
      document.getElementById("setTodayBtn").addEventListener("click", ()=>{
        const today = new Date();
        const iso = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,"0")}-${String(today.getDate()).padStart(2,"0")}`;
        document.getElementById("lastUsed").value = iso;
      });

      // í† ê¸€ ë²„íŠ¼ ê·¸ë£¹ (í•„ë¦„)
      document.querySelectorAll("#filmFormCard .toggle-group").forEach(group=>{
        group.addEventListener("click", (e)=>{
          const btn = e.target.closest(".toggle-btn");
          if (!btn) return;
          group.querySelectorAll(".toggle-btn").forEach(b=>b.classList.remove("active"));
          btn.classList.add("active");
        });
      });

      // ì´ë¯¸ì§€ ì„ íƒ
      document.getElementById("imageInput").addEventListener("change", (e)=>{
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ()=>{
          currentSelectedImageDataUrl = reader.result;
          currentImageRotation = 0;

          const wrap = document.getElementById("imagePreviewWrapper");
          const img = document.getElementById("imagePreview");
          img.src = currentSelectedImageDataUrl;
          img.style.transform = "rotate(0deg)";
          wrap.style.display = "flex";
        };
        reader.readAsDataURL(file);
      });

      // íšŒì „
      document.getElementById("rotateLeftBtn").addEventListener("click", ()=>{
        if (!currentSelectedImageDataUrl) return;
        currentImageRotation = (currentImageRotation - 90 + 360) % 360;
        applyPreviewRotation();
      });
      document.getElementById("rotateRightBtn").addEventListener("click", ()=>{
        if (!currentSelectedImageDataUrl) return;
        currentImageRotation = (currentImageRotation + 90) % 360;
        applyPreviewRotation();
      });

      // íŒ í¼
      document.getElementById("plateForm").addEventListener("submit", handleSavePlate);
      document.getElementById("cancelPlateBtn").addEventListener("click", closePlateForm);

      // ë©”ëª¨ ì‹œíŠ¸
      document.getElementById("memoSheetBackdrop").addEventListener("click", closeMemoSheet);
      document.getElementById("memoSheetCloseBtn").addEventListener("click", closeMemoSheet);
      document.getElementById("memoSheetCancelBtn").addEventListener("click", closeMemoSheet);
      document.getElementById("memoSheetSaveBtn").addEventListener("click", saveMemoSheet);

      // íˆìŠ¤í† ë¦¬ ë©”ëª¨
      document.getElementById("historyNoteCancelBtn").addEventListener("click", closeHistoryNoteModal);
      document.getElementById("historyNoteSaveBtn").addEventListener("click", saveHistoryNoteModal);

      // íŒ ì‚¬ìš©ë“±ë¡
      document.getElementById("plateUseCancelBtn").addEventListener("click", closePlateUseModal);
      document.getElementById("plateUseSaveBtn").addEventListener("click", savePlateUseModal);

      // íŒ íˆìŠ¤í† ë¦¬
      document.getElementById("plateHistoryCloseBtn").addEventListener("click", closePlateHistoryModal);

      // ìŠ¤í¬ë¡¤
      window.addEventListener("scroll", ()=>{
        handleScrollTopBtn();
        handleScrollLoadMore();
      });
      document.getElementById("scrollTopBtn").addEventListener("click", ()=>{
        window.scrollTo({ top:0, behavior:"smooth" });
      });
    }

    /* ---------- ì´ˆê¸°í™” ---------- */
    function init(){
      // í…Œë§ˆ/ë·°
      setTheme(getTheme());
      applyViewMode();

      // ê¸°ê¸° ë¼ë²¨
      const badgeText = document.getElementById("deviceBadgeText");
      if (badgeText) badgeText.textContent = getDeviceLabel() || "ê¸°ê¸° ë¯¸ì§€ì •";

      // ìë™ ì ê¸ˆ í•´ì œ(ëª¨ë“œ ê¸°ì–µ) + ë³´ì•ˆìƒ â€œë¹„ë²ˆ ì—†ì´ ë“¤ì–´ê°€ê¸°â€ê°€ ì‹«ìœ¼ë©´ ì´ ë¡œì§ ì§€ì›Œë„ ë¨
      if (tryAutoUnlock()){
        showApp();
      } else {
        showLock();
      }

      // ëª¨ë“œ/íƒ­
      if (currentMode === MODE_PRINT) activeTab = "plates";
      applyModeToUI();

      // ë¦¬ìŠ¤ë„ˆ ì‹œì‘
      startFilmsListener();
      startPlatesListener();

      // ì´ë²¤íŠ¸
      bindEvents();
    }

    // ì‹¤í–‰
    init();
  </script>
</body>
</html>
