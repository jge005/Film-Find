<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#f9f4ff">
  <meta charset="UTF-8" />
  <title>FILM FIND - 필름/판 관리</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- 폰트 (Pretendard) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css" />

  <style>
    :root{
      /* 기본(라벤더) */
      --bg-gradient: linear-gradient(145deg, #f9fafb, #f4f0ff, #fdf2f8);
      --card-bg: rgba(255,255,255,0.98);
      --card-border: #e3e6ff;
      --shadow-soft: 0 8px 20px rgba(167, 173, 208, 0.35);

      --text-main: #272a3f;
      --text-sub: rgba(39,42,63,.72);

      --primary: #7b61ff;
      --primary-soft: rgba(123,97,255,.14);

      --danger: #ff4d6d;
      --danger-soft: rgba(255,77,109,.14);

      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: "Pretendard Variable", Pretendard, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
      color: var(--text-main);
      background: var(--bg-gradient);
      min-height: 100vh;
      padding-bottom: 70px;
    }

    .wrap{
      width: min(980px, 100%);
      margin: 0 auto;
      padding: 14px 12px 24px;
    }

    header{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap: 10px;
      padding: 8px 4px 14px;
    }
    .brand{
      display:flex; flex-direction:column; gap:4px;
    }
    .brand h1{
      margin:0;
      font-size: 18px;
      letter-spacing: -0.2px;
    }
    .brand p{
      margin:0;
      color: var(--text-sub);
      font-size: 12.5px;
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(120,130,170,.18);
      background: rgba(255,255,255,.8);
      box-shadow: 0 8px 18px rgba(0,0,0,.06);
      font-size: 12px;
      white-space: nowrap;
    }
    .dot{
      width: 9px; height:9px; border-radius: 50%;
      background: #bbb;
    }
    .dot.ok{ background: #18c37e; }
    .dot.bad{ background: #ff4d6d; }

    .toolbar{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      padding: 0 4px 12px;
    }

    .filters{
      display:flex; gap: 8px; align-items:center; flex:1;
    }

    .input, .select{
      height: 42px;
      border-radius: 14px;
      border: 1px solid rgba(120,130,170,.20);
      padding: 0 12px;
      outline: none;
      background: rgba(255,255,255,.92);
      box-shadow: 0 6px 14px rgba(0,0,0,.04);
      font-size: 14px;
      width: 100%;
    }
    .select{ width: 150px; }
    .input::placeholder{ color: rgba(39,42,63,.45); }

    .btn{
      height: 42px;
      padding: 0 14px;
      border-radius: 14px;
      border: 1px solid rgba(120,130,170,.18);
      background: rgba(255,255,255,.92);
      box-shadow: 0 6px 14px rgba(0,0,0,.04);
      cursor:pointer;
      font-weight: 700;
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(123,97,255,.95), rgba(123,97,255,.86));
      border-color: rgba(123,97,255,.2);
      color:#fff;
      box-shadow: 0 10px 26px rgba(123,97,255,.22);
    }
    .btn.ghost{
      background: rgba(255,255,255,.65);
    }
    .btn.danger{
      background: rgba(255,77,109,.10);
      border-color: rgba(255,77,109,.24);
      color: #d92d4e;
    }
    .btn:active{ transform: translateY(1px); }

    /* 탭 */
    .tabs{
      display:flex; gap:8px;
      align-items:center;
      padding: 0 4px 12px;
    }
    .tab{
      flex: 0 0 auto;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(120,130,170,.18);
      background: rgba(255,255,255,.70);
      cursor:pointer;
      font-weight: 800;
      font-size: 13px;
      color: rgba(39,42,63,.72);
    }
    .tab.active{
      background: rgba(123,97,255,.14);
      border-color: rgba(123,97,255,.25);
      color: #4b35d6;
    }

    /* 카드 리스트 */
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 10px;
      padding: 0 4px;
    }
    .card{
      grid-column: span 12;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      padding: 12px;
    }
    @media (min-width: 720px){
      .card{ grid-column: span 6; }
    }

    .card-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
    }
    .title{
      font-size: 15px;
      font-weight: 900;
      letter-spacing: -0.2px;
      margin:0;
      line-height: 1.2;
    }
    .sub{
      margin: 4px 0 0;
      font-size: 12.5px;
      color: var(--text-sub);
    }

    .meta{
      display:flex;
      flex-wrap:wrap;
      gap: 6px;
      margin-top: 8px;
    }
    .chip{
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(120,130,170,.18);
      background:#fff;
      color: rgba(39,42,63,.78);
    }

    .actions{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      margin-top: 10px;
    }

    /* 모달 */
    .modal-backdrop{
      position: fixed; inset: 0;
      background: rgba(20, 22, 30, .45);
      display:flex; align-items:flex-end; justify-content:center;
      z-index: 9999;
      padding: 12px;
    }
    .modal-backdrop.hidden{ display:none; }

    .modal-sheet{
      width: min(720px, 100%);
      background: rgba(255,255,255,0.98);
      border: 1px solid var(--card-border);
      border-radius: 18px;
      box-shadow: 0 18px 55px rgba(0,0,0,.20);
      overflow: hidden;
    }

    .modal-head{
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(120,130,170,.18);
    }
    .modal-title{ font-size: 16px; font-weight: 900; }
    .modal-sub{ margin-top: 2px; font-size: 12px; opacity: .65; }

    .btn-icon{
      width: 36px; height: 36px;
      border-radius: 12px;
      border: 1px solid rgba(120,130,170,.18);
      background: #fff;
      cursor:pointer;
      font-weight: 900;
    }

    .modal-body{ padding: 12px 14px 14px; }
    .modal-tools{
      display:flex; gap: 8px;
      margin-bottom: 10px;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    @media (max-width: 520px){
      .row{ grid-template-columns: 1fr; }
    }

    .help{
      font-size: 12px;
      color: rgba(39,42,63,.60);
      margin-top: 6px;
    }

    .modal-foot{
      padding: 12px 14px;
      border-top: 1px solid rgba(120,130,170,.18);
      display:flex; justify-content:flex-end; gap: 8px;
    }

    /* 타임라인 */
    .timeline{
      margin-top: 6px;
      max-height: min(70vh, 520px);
      overflow:auto;
      padding-right: 4px;
    }
    .t-row{
      display:grid;
      grid-template-columns: 22px 1fr;
      gap: 10px;
      padding: 10px 0;
    }
    .t-dot{
      width: 10px; height: 10px;
      border-radius: 50%;
      margin-top: 6px;
      background: #8b90ff;
      box-shadow: 0 0 0 4px rgba(139,144,255,.18);
    }
    .t-card{
      background: rgba(248,249,255,.9);
      border: 1px solid rgba(120,130,170,.18);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .t-top{
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px;
    }
    .t-name{ font-weight: 900; font-size: 14px; }
    .t-time{ font-size: 12px; opacity: .65; white-space: nowrap; }
    .t-meta{
      margin-top: 6px;
      display:flex; flex-wrap:wrap; gap: 6px;
    }
    .t-note{
      margin-top: 8px;
      font-size: 13px;
      opacity: .85;
      line-height: 1.35;
      white-space: pre-wrap;
    }
    .empty{
      padding: 22px 0;
      text-align:center;
      opacity:.6;
    }

    /* 기사 리스트 관리 */
    .engineer-box{
      border: 1px solid rgba(120,130,170,.18);
      border-radius: 16px;
      padding: 10px;
      background: rgba(255,255,255,.75);
    }
    .engineer-list{
      display:flex;
      flex-wrap:wrap;
      gap: 6px;
      margin-top: 8px;
    }
    .engineer-pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(120,130,170,.18);
      background:#fff;
      font-size: 12.5px;
      font-weight: 800;
    }
    .engineer-pill button{
      border: none;
      background: transparent;
      cursor:pointer;
      color: #d92d4e;
      font-weight: 900;
      font-size: 14px;
      line-height: 1;
      padding: 0 2px;
    }

    /* 하단 고정 바(휴지통 UI는 아예 없음) */
    .bottom-bar{
      position: fixed; left:0; right:0; bottom:0;
      padding: 10px 12px;
      background: rgba(255,255,255,.75);
      border-top: 1px solid rgba(120,130,170,.18);
      backdrop-filter: blur(10px);
      display:flex;
      gap: 10px;
      justify-content:center;
      z-index: 50;
    }
    .bottom-inner{
      width: min(980px, 100%);
      display:flex;
      gap: 10px;
      justify-content:flex-end;
    }
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 86px;
      background: rgba(39,42,63,.92);
      color: #fff;
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 800;
      font-size: 13px;
      box-shadow: 0 14px 40px rgba(0,0,0,.22);
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease;
      z-index: 99999;
    }
    .toast.show{ opacity: 1; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>FILM FIND</h1>
        <p>필름/판 관리 · 판 사용기록 · 기사 선택(공유)</p>
      </div>
      <div class="pill" id="connPill">
        <span class="dot" id="connDot"></span>
        <span id="connText">연결 준비중</span>
      </div>
    </header>

    <div class="toolbar">
      <div class="filters">
        <input id="searchInput" class="input" placeholder="검색 (제품/판명/판번호/메모)" />
        <select id="sortSelect" class="select">
          <option value="updatedDesc">최신수정순</option>
          <option value="createdDesc">최신등록순</option>
          <option value="nameAsc">이름오름차순</option>
        </select>
      </div>
      <button class="btn primary" id="addBtn">+ 추가</button>
    </div>

    <!-- 탭 위치는 그대로: 정렬/검색 옆(상단) -->
    <div class="tabs">
      <button class="tab active" id="tabFilm">필름</button>
      <button class="tab" id="tabPlate">판</button>
    </div>

    <div class="grid" id="listGrid"></div>
  </div>

  <!-- 하단 바 -->
  <div class="bottom-bar">
    <div class="bottom-inner">
      <button class="btn ghost" id="engineerManageBtn">인쇄기사 목록</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- ✅ 추가/수정 모달 -->
  <div id="editModal" class="modal-backdrop hidden" aria-hidden="true">
    <div class="modal-sheet">
      <div class="modal-head">
        <div>
          <div id="editTitle" class="modal-title">추가</div>
          <div id="editSub" class="modal-sub">정보를 입력해줘</div>
        </div>
        <button class="btn-icon" onclick="closeEditModal()" aria-label="닫기">✕</button>
      </div>

      <div class="modal-body" id="editBody">
        <!-- 필드들은 JS에서 탭에 따라 바뀜 -->
      </div>

      <div class="modal-foot">
        <button class="btn ghost" onclick="closeEditModal()">취소</button>
        <button class="btn primary" id="saveBtn">저장</button>
      </div>
    </div>
  </div>

  <!-- ✅ 판 사용등록 모달 (기사 선택 + Firebase 공유 목록) -->
  <div id="useModal" class="modal-backdrop hidden" aria-hidden="true">
    <div class="modal-sheet">
      <div class="modal-head">
        <div>
          <div class="modal-title">판 사용 등록</div>
          <div id="useSub" class="modal-sub">기사 선택 후 등록</div>
        </div>
        <button class="btn-icon" onclick="closeUseModal()" aria-label="닫기">✕</button>
      </div>

      <div class="modal-body">
        <div class="row">
          <div>
            <label class="help">인쇄기사 (선택)</label>
            <select id="engineerSelect" class="select" style="width:100%"></select>
            <div class="help">목록은 Firebase에 저장돼서 어떤 기기에서 봐도 동일하게 떠.</div>
          </div>
          <div>
            <label class="help">수량(선택)</label>
            <input id="useQty" class="input" type="number" min="0" placeholder="예: 1" />
            <div class="help">안 적어도 등록 가능</div>
          </div>
        </div>
        <div>
          <label class="help">메모(선택)</label>
          <textarea id="useNote" class="input" rows="3" style="height:auto; padding:10px 12px; resize:vertical;" placeholder="예: 1색 2회차 / 재세팅 필요"></textarea>
        </div>
      </div>

      <div class="modal-foot">
        <button class="btn ghost" onclick="closeUseModal()">닫기</button>
        <button class="btn primary" id="useSaveBtn">등록</button>
      </div>
    </div>
  </div>

  <!-- ✅ 판 사용 기록 모달 (알람 X, 예쁘게) -->
  <div id="plateHistoryModal" class="modal-backdrop hidden" aria-hidden="true">
    <div class="modal-sheet">
      <div class="modal-head">
        <div>
          <div class="modal-title">판 사용 기록</div>
          <div id="plateHistorySubtitle" class="modal-sub">최근 기록을 시간순으로 보여줘</div>
        </div>
        <button class="btn-icon" onclick="closePlateHistoryModal()" aria-label="닫기">✕</button>
      </div>

      <div class="modal-body">
        <div class="modal-tools">
          <input id="plateHistorySearch" class="input" placeholder="기사명/메모로 검색" />
          <select id="plateHistorySort" class="select">
            <option value="desc">최신순</option>
            <option value="asc">오래된순</option>
          </select>
        </div>
        <div id="plateHistoryList" class="timeline"></div>
      </div>

      <div class="modal-foot">
        <button class="btn ghost" onclick="closePlateHistoryModal()">닫기</button>
      </div>
    </div>
  </div>

  <!-- ✅ 인쇄기사 목록 관리 모달 (추가/삭제 + Firebase 저장/공유) -->
  <div id="engineerModal" class="modal-backdrop hidden" aria-hidden="true">
    <div class="modal-sheet">
      <div class="modal-head">
        <div>
          <div class="modal-title">인쇄기사 목록</div>
          <div class="modal-sub">추가/삭제하면 모든 기기에 공유돼</div>
        </div>
        <button class="btn-icon" onclick="closeEngineerModal()" aria-label="닫기">✕</button>
      </div>

      <div class="modal-body">
        <div class="engineer-box">
          <div class="row" style="margin-bottom:0;">
            <input id="engineerNameInput" class="input" placeholder="기사 이름 입력 (예: 홍길동)" />
            <button class="btn primary" id="engineerAddBtn">추가</button>
          </div>
          <div class="help">동명이인이 있을 수 있으니, 필요하면 “홍길동(1호기)”처럼 적어도 돼.</div>

          <div id="engineerList" class="engineer-list"></div>
        </div>
      </div>

      <div class="modal-foot">
        <button class="btn ghost" onclick="closeEngineerModal()">닫기</button>
      </div>
    </div>
  </div>

  <!-- Firebase (모듈) -->
  <script type="module">
    /******************************************************************
     * ✅ 너 Firebase 프로젝트 설정값으로 교체해줘
     ******************************************************************/
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID",
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, updateDoc, deleteDoc,
      query, orderBy, where, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import {
      getAuth, signInAnonymously, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    /******************************************************************
     * 상태
     ******************************************************************/
    let activeTab = "film"; // "film" | "plate"
    let unsubList = null;

    let editMode = "create"; // create | edit
    let editId = null;

    let usePlateId = null;
    let usePlateLabel = "";

    let plateHistoryUnsub = null;
    let plateHistoryCache = [];
    let plateHistoryPlateId = null;

    let engineerUnsub = null;
    let engineersCache = []; // [{id,name,createdAt}...]

    /******************************************************************
     * 공통 유틸
     ******************************************************************/
    const $ = (id) => document.getElementById(id);

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function toast(msg){
      const el = $("toast");
      el.textContent = msg;
      el.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> el.classList.remove("show"), 1400);
    }

    function formatKoreanDateTime(d){
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return `${yy}.${mm}.${dd} ${hh}:${mi}`;
    }

    function getSortKey(){
      return $("sortSelect").value;
    }

    function getSearch(){
      return ($("searchInput").value || "").trim().toLowerCase();
    }

    /******************************************************************
     * ✅ 휴지통 기능: 아예 없음
     * - 삭제는 “완전 삭제”만 제공 (deleteDoc)
     ******************************************************************/

    /******************************************************************
     * 인증 (익명)
     ******************************************************************/
    updateConn(false, "로그인중...");
    signInAnonymously(auth).catch((e)=> {
      console.error(e);
      updateConn(false, "로그인 실패");
      alert("Firebase Auth 설정(익명 로그인) 허용 필요!");
    });

    onAuthStateChanged(auth, (user)=>{
      if(user){
        updateConn(true, "연결됨");
        startListeners();
        startEngineerListener(); // 기사 목록은 항상 Firebase에서 동기화
      }
    });

    function updateConn(ok, text){
      $("connDot").classList.toggle("ok", ok);
      $("connDot").classList.toggle("bad", !ok);
      $("connText").textContent = text;
    }

    /******************************************************************
     * 탭/리스트
     ******************************************************************/
    $("tabFilm").addEventListener("click", ()=> setTab("film"));
    $("tabPlate").addEventListener("click", ()=> setTab("plate"));

    $("searchInput").addEventListener("input", ()=> refreshRender());
    $("sortSelect").addEventListener("change", ()=> startListeners());

    $("addBtn").addEventListener("click", ()=> openEditModal("create"));

    function setTab(tab){
      activeTab = tab;
      $("tabFilm").classList.toggle("active", tab==="film");
      $("tabPlate").classList.toggle("active", tab==="plate");
      startListeners();
    }

    function startListeners(){
      if(unsubList){ unsubList(); unsubList = null; }

      const sort = getSortKey();

      let colName = activeTab === "film" ? "films" : "plates";
      let colRef = collection(db, colName);

      // 정렬: updatedAt / createdAt / name
      let q;
      if(sort === "updatedDesc"){
        q = query(colRef, orderBy("updatedAt", "desc"));
      } else if(sort === "createdDesc"){
        q = query(colRef, orderBy("createdAt", "desc"));
      } else {
        q = query(colRef, orderBy("name", "asc"));
      }

      unsubList = onSnapshot(q, (snap)=>{
        const items = snap.docs.map(d=> ({ id: d.id, ...d.data() }));
        renderList(items);
      }, (err)=>{
        console.error(err);
        updateConn(false, "리스트 에러");
      });
    }

    function refreshRender(){
      // onSnapshot에서 받은 list를 다시 저장해두는 구조가 아니라
      // 여기선 검색은 renderList에서 처리하도록 간단하게 유지.
      // (검색 입력 시 리스트 갱신은 스냅샷이 또 오진 않으니,
      //  지금 코드에선 그냥 startListeners()로 리프레시하지 않고,
      //  “현재 DOM”을 다시 만들 수 없어서: 검색은 스냅샷 콜백에서만 반영됨)
      // => 그래서 검색이 즉시 반영되게, startListeners() 호출 대신:
      //    마지막 렌더 데이터 캐시를 유지.
      renderList(_lastItemsCache);
    }

    let _lastItemsCache = [];
    function renderList(items){
      _lastItemsCache = items;

      const keyword = getSearch();
      let filtered = items;

      if(keyword){
        filtered = items.filter(x=>{
          const name = (x.name||"").toLowerCase();
          const product = (x.product||"").toLowerCase();
          const plateNo = (x.plateNo||"").toLowerCase();
          const note = (x.note||"").toLowerCase();
          return name.includes(keyword) || product.includes(keyword) || plateNo.includes(keyword) || note.includes(keyword);
        });
      }

      const grid = $("listGrid");
      if(filtered.length === 0){
        grid.innerHTML = `<div class="card" style="grid-column:span 12;"><div class="empty">표시할 항목이 없어</div></div>`;
        return;
      }

      grid.innerHTML = filtered.map(x=>{
        if(activeTab === "film"){
          return filmCard(x);
        } else {
          return plateCard(x);
        }
      }).join("");

      // 카드 버튼 바인딩
      filtered.forEach(x=>{
        if(activeTab === "film"){
          $("edit_"+x.id)?.addEventListener("click", ()=> openEditModal("edit", x.id));
          $("del_"+x.id)?.addEventListener("click", ()=> hardDelete("films", x.id));
        } else {
          $("edit_"+x.id)?.addEventListener("click", ()=> openEditModal("edit", x.id));
          $("del_"+x.id)?.addEventListener("click", ()=> hardDelete("plates", x.id));
          $("use_"+x.id)?.addEventListener("click", ()=> openUseModal(x.id, `${x.name||""} ${x.plateNo||""}`.trim()));
          $("hist_"+x.id)?.addEventListener("click", ()=> openPlateHistoryModal(x.id, `${x.name||""} ${x.plateNo||""}`.trim()));
        }
      });
    }

    function filmCard(x){
      const name = escapeHtml(x.name || "(이름없음)");
      const product = escapeHtml(x.product || "-");
      const note = escapeHtml(x.note || "");
      return `
        <div class="card">
          <div class="card-top">
            <div>
              <p class="title">${name}</p>
              <p class="sub">제품: ${product}</p>
            </div>
          </div>
          <div class="meta">
            ${x.note ? `<span class="chip">메모</span>` : `<span class="chip">메모 없음</span>`}
          </div>
          ${x.note ? `<div class="help" style="margin-top:8px; white-space:pre-wrap;">${note}</div>` : ``}
          <div class="actions">
            <button class="btn ghost" id="edit_${x.id}">수정</button>
            <button class="btn danger" id="del_${x.id}">완전삭제</button>
          </div>
        </div>
      `;
    }

    function plateCard(x){
      const name = escapeHtml(x.name || "(판명없음)");
      const plateNo = escapeHtml(x.plateNo || "-");
      const product = escapeHtml(x.product || "-");
      const note = escapeHtml(x.note || "");
      return `
        <div class="card">
          <div class="card-top">
            <div>
              <p class="title">${name}</p>
              <p class="sub">판번호: ${plateNo} · 제품: ${product}</p>
            </div>
          </div>
          <div class="meta">
            <span class="chip">판</span>
            ${x.note ? `<span class="chip">메모</span>` : `<span class="chip">메모 없음</span>`}
          </div>
          ${x.note ? `<div class="help" style="margin-top:8px; white-space:pre-wrap;">${note}</div>` : ``}
          <div class="actions">
            <button class="btn primary" id="use_${x.id}">사용등록</button>
            <button class="btn ghost" id="hist_${x.id}">사용기록</button>
            <button class="btn ghost" id="edit_${x.id}">수정</button>
            <button class="btn danger" id="del_${x.id}">완전삭제</button>
          </div>
        </div>
      `;
    }

    async function hardDelete(col, id){
      if(!confirm("완전삭제할까? (복구불가)")) return;
      try{
        await deleteDoc(doc(db, col, id));
        toast("삭제 완료");
      }catch(e){
        console.error(e);
        alert("삭제 실패");
      }
    }

    /******************************************************************
     * 추가/수정 모달
     ******************************************************************/
    function openEditModal(mode, id=null){
      editMode = mode;
      editId = id;

      $("editTitle").textContent = (mode==="create") ? (activeTab==="film" ? "새 필름" : "새 판") : "수정";
      $("editSub").textContent = (activeTab==="film") ? "필름 정보를 입력해줘" : "판 정보를 입력해줘";

      const body = $("editBody");
      if(activeTab === "film"){
        body.innerHTML = `
          <div class="row">
            <div>
              <label class="help">필름명</label>
              <input id="f_name" class="input" placeholder="예: 7125J" />
            </div>
            <div>
              <label class="help">제품명</label>
              <input id="f_product" class="input" placeholder="예: 5040EA" />
            </div>
          </div>
          <div>
            <label class="help">메모</label>
            <textarea id="f_note" class="input" rows="3" style="height:auto; padding:10px 12px; resize:vertical;" placeholder="메모"></textarea>
          </div>
        `;
      } else {
        body.innerHTML = `
          <div class="row">
            <div>
              <label class="help">판명</label>
              <input id="p_name" class="input" placeholder="예: 5040EA 전면" />
            </div>
            <div>
              <label class="help">판번호</label>
              <input id="p_no" class="input" placeholder="예: P-0123" />
            </div>
          </div>
          <div class="row">
            <div>
              <label class="help">제품명</label>
              <input id="p_product" class="input" placeholder="예: 5040EA" />
            </div>
            <div>
              <label class="help">메모(짧게)</label>
              <input id="p_note_short" class="input" placeholder="예: 2색/재세팅" />
            </div>
          </div>
          <div>
            <label class="help">상세메모</label>
            <textarea id="p_note" class="input" rows="3" style="height:auto; padding:10px 12px; resize:vertical;" placeholder="상세메모"></textarea>
          </div>
        `;
      }

      $("saveBtn").onclick = saveEdit;
      $("editModal").classList.remove("hidden");
      $("editModal").setAttribute("aria-hidden", "false");

      if(mode === "edit" && id){
        fillEditFields(id);
      }
    }

    function closeEditModal(){
      $("editModal").classList.add("hidden");
      $("editModal").setAttribute("aria-hidden", "true");
      editId = null;
      editMode = "create";
    }

    async function fillEditFields(id){
      const col = activeTab === "film" ? "films" : "plates";
      const ref = doc(db, col, id);
      const snap = await getDoc(ref);
      if(!snap.exists()) return;
      const x = snap.data();

      if(activeTab === "film"){
        $("f_name").value = x.name || "";
        $("f_product").value = x.product || "";
        $("f_note").value = x.note || "";
      } else {
        $("p_name").value = x.name || "";
        $("p_no").value = x.plateNo || "";
        $("p_product").value = x.product || "";
        $("p_note_short").value = x.noteShort || "";
        $("p_note").value = x.note || "";
      }
    }

    async function saveEdit(){
      try{
        if(activeTab === "film"){
          const payload = {
            name: ($("f_name").value || "").trim(),
            product: ($("f_product").value || "").trim(),
            note: ($("f_note").value || "").trim(),
            updatedAt: serverTimestamp(),
          };
          if(!payload.name) return alert("필름명은 필수!");

          if(editMode === "create"){
            payload.createdAt = serverTimestamp();
            await addDoc(collection(db, "films"), payload);
            toast("필름 추가됨");
          }else{
            await updateDoc(doc(db, "films", editId), payload);
            toast("수정됨");
          }
        } else {
          const payload = {
            name: ($("p_name").value || "").trim(),
            plateNo: ($("p_no").value || "").trim(),
            product: ($("p_product").value || "").trim(),
            noteShort: ($("p_note_short").value || "").trim(),
            note: ($("p_note").value || "").trim(),
            updatedAt: serverTimestamp(),
          };
          if(!payload.name) return alert("판명은 필수!");

          if(editMode === "create"){
            payload.createdAt = serverTimestamp();
            await addDoc(collection(db, "plates"), payload);
            toast("판 추가됨");
          }else{
            await updateDoc(doc(db, "plates", editId), payload);
            toast("수정됨");
          }
        }
        closeEditModal();
      }catch(e){
        console.error(e);
        alert("저장 실패");
      }
    }

    /******************************************************************
     * ✅ 인쇄기사 목록 (Firebase에 저장, 공유됨)
     * - 컬렉션: engineers
     * - 필드: name, createdAt
     ******************************************************************/
    function startEngineerListener(){
      if(engineerUnsub){ engineerUnsub(); engineerUnsub = null; }
      const qEng = query(collection(db, "engineers"), orderBy("name", "asc"));
      engineerUnsub = onSnapshot(qEng, (snap)=>{
        engineersCache = snap.docs.map(d=> ({ id: d.id, ...d.data() }));
        renderEngineerSelect();
        renderEngineerManageList();
      }, (err)=>{
        console.error(err);
      });
    }

    function renderEngineerSelect(){
      const sel = $("engineerSelect");
      if(!sel) return;
      const opts = [`<option value="">(선택 안함)</option>`]
        .concat(engineersCache.map(x=> `<option value="${escapeHtml(x.name)}">${escapeHtml(x.name)}</option>`));
      sel.innerHTML = opts.join("");
    }

    function openEngineerModal(){
      $("engineerModal").classList.remove("hidden");
      $("engineerModal").setAttribute("aria-hidden", "false");
      $("engineerNameInput").focus();
    }
    function closeEngineerModal(){
      $("engineerModal").classList.add("hidden");
      $("engineerModal").setAttribute("aria-hidden", "true");
    }

    $("engineerManageBtn").addEventListener("click", openEngineerModal);

    $("engineerAddBtn").addEventListener("click", addEngineer);
    $("engineerNameInput").addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){ e.preventDefault(); addEngineer(); }
    });

    async function addEngineer(){
      const name = ($("engineerNameInput").value || "").trim();
      if(!name) return;

      // 중복 체크(이름 기준)
      const exists = engineersCache.some(x => (x.name || "").trim() === name);
      if(exists){
        toast("이미 있는 이름이야");
        return;
      }

      try{
        await addDoc(collection(db, "engineers"), {
          name,
          createdAt: serverTimestamp(),
        });
        $("engineerNameInput").value = "";
        toast("추가됨");
      }catch(e){
        console.error(e);
        alert("추가 실패");
      }
    }

    function renderEngineerManageList(){
      const wrap = $("engineerList");
      if(!wrap) return;

      if(engineersCache.length === 0){
        wrap.innerHTML = `<div class="empty" style="width:100%;">아직 기사 목록이 없어</div>`;
        return;
      }

      wrap.innerHTML = engineersCache.map(x=> `
        <div class="engineer-pill">
          <span>${escapeHtml(x.name)}</span>
          <button title="삭제" data-id="${escapeHtml(x.id)}">×</button>
        </div>
      `).join("");

      wrap.querySelectorAll("button[data-id]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = btn.getAttribute("data-id");
          const item = engineersCache.find(e=> e.id === id);
          if(!item) return;
          if(!confirm(`"${item.name}" 삭제할까?`)) return;

          try{
            await deleteDoc(doc(db, "engineers", id));
            toast("삭제됨");
          }catch(e){
            console.error(e);
            alert("삭제 실패");
          }
        });
      });
    }

    /******************************************************************
     * ✅ 판 사용등록 (기사 선택 방식)
     * - uses 저장 위치: plates/{plateId}/uses (서브컬렉션)
     * - 필드: engineerName, qty, note, createdAt
     ******************************************************************/
    function openUseModal(plateId, label){
      usePlateId = plateId;
      usePlateLabel = label || "";
      $("useSub").textContent = usePlateLabel ? `${usePlateLabel} · 기사 선택 후 등록` : "기사 선택 후 등록";

      // 초기화
      $("engineerSelect").value = "";
      $("useQty").value = "";
      $("useNote").value = "";

      $("useSaveBtn").onclick = saveUse;
      $("useModal").classList.remove("hidden");
      $("useModal").setAttribute("aria-hidden", "false");
    }

    function closeUseModal(){
      $("useModal").classList.add("hidden");
      $("useModal").setAttribute("aria-hidden", "true");
      usePlateId = null;
      usePlateLabel = "";
    }

    async function saveUse(){
      if(!usePlateId) return;

      const engineerName = ($("engineerSelect").value || "").trim(); // 선택 기반
      const qtyRaw = $("useQty").value;
      const qty = (qtyRaw === "" || qtyRaw === null) ? null : Number(qtyRaw);
      const note = ($("useNote").value || "").trim();

      try{
        await addDoc(collection(db, "plates", usePlateId, "uses"), {
          title: "사용 등록",
          engineerName: engineerName || "", // 선택 안하면 빈값
          qty: (Number.isFinite(qty) ? qty : null),
          note,
          createdAt: serverTimestamp(),
        });
        toast("사용 등록됨");
        closeUseModal();
      }catch(e){
        console.error(e);
        alert("등록 실패");
      }
    }

    /******************************************************************
     * ✅ 판 사용히스토리 (alert X → 예쁜 모달 타임라인)
     ******************************************************************/
    $("plateHistorySearch").addEventListener("input", rerenderPlateHistory);
    $("plateHistorySort").addEventListener("change", rerenderPlateHistory);

    function openPlateHistoryModal(plateId, plateLabelText=""){
      plateHistoryPlateId = plateId;
      $("plateHistorySubtitle").textContent = plateLabelText ? `${plateLabelText} · 시간순 기록` : "최근 기록을 시간순으로 보여줘";

      $("plateHistorySearch").value = "";
      $("plateHistorySort").value = "desc";

      $("plateHistoryModal").classList.remove("hidden");
      $("plateHistoryModal").setAttribute("aria-hidden","false");

      if(plateHistoryUnsub){ plateHistoryUnsub(); plateHistoryUnsub = null; }
      plateHistoryCache = [];
      renderPlateHistory([]);

      const usesRef = collection(db, "plates", plateId, "uses");
      const qUses = query(usesRef, orderBy("createdAt", "desc"));

      plateHistoryUnsub = onSnapshot(qUses, (snap)=>{
        plateHistoryCache = snap.docs.map(d=> ({ id: d.id, ...d.data() }));
        rerenderPlateHistory();
      }, (err)=>{
        console.error(err);
        renderPlateHistory([]);
      });
    }

    function closePlateHistoryModal(){
      $("plateHistoryModal").classList.add("hidden");
      $("plateHistoryModal").setAttribute("aria-hidden","true");

      if(plateHistoryUnsub){ plateHistoryUnsub(); plateHistoryUnsub = null; }
      plateHistoryCache = [];
      plateHistoryPlateId = null;
    }

    function rerenderPlateHistory(){
      const keyword = ($("plateHistorySearch").value || "").trim().toLowerCase();
      const sort = $("plateHistorySort").value;

      let list = [...plateHistoryCache];

      if(keyword){
        list = list.filter(x=>{
          const name = (x.engineerName || "").toLowerCase();
          const note = (x.note || "").toLowerCase();
          return name.includes(keyword) || note.includes(keyword);
        });
      }

      if(sort === "asc"){
        list.sort((a,b)=> (a.createdAt?.seconds||0) - (b.createdAt?.seconds||0));
      } else {
        list.sort((a,b)=> (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
      }

      renderPlateHistory(list);
    }

    function renderPlateHistory(items){
      const wrap = $("plateHistoryList");
      if(!items || items.length === 0){
        wrap.innerHTML = `<div class="empty">아직 사용 기록이 없어</div>`;
        return;
      }

      wrap.innerHTML = items.map(x=>{
        const ts = x.createdAt?.toDate ? x.createdAt.toDate() : null;
        const timeText = ts ? formatKoreanDateTime(ts) : "시간 정보 없음";

        const chips = [
          x.engineerName ? `<span class="chip">기사: ${escapeHtml(x.engineerName)}</span>` : `<span class="chip">기사: -</span>`,
          (x.qty != null && x.qty !== "") ? `<span class="chip">수량: ${escapeHtml(String(x.qty))}</span>` : "",
        ].filter(Boolean).join("");

        const note = x.note ? `<div class="t-note">${escapeHtml(x.note)}</div>` : "";

        return `
          <div class="t-row">
            <div class="t-dot"></div>
            <div class="t-card">
              <div class="t-top">
                <div class="t-name">${escapeHtml(x.title || "사용 등록")}</div>
                <div class="t-time">${escapeHtml(timeText)}</div>
              </div>
              <div class="t-meta">${chips}</div>
              ${note}
            </div>
          </div>
        `;
      }).join("");
    }

    /******************************************************************
     * 초기 UI
     ******************************************************************/
    function startListenersOnceReady(){
      startListeners();
      startEngineerListener();
    }
    function startListeners(){
      // 위에서 이미 정의된 startListeners 사용(중복 방지용)
      // (그대로 둠)
      if(unsubList){ unsubList(); unsubList = null; }

      const sort = getSortKey();

      let colName = activeTab === "film" ? "films" : "plates";
      let colRef = collection(db, colName);

      let q;
      if(sort === "updatedDesc"){
        q = query(colRef, orderBy("updatedAt", "desc"));
      } else if(sort === "createdDesc"){
        q = query(colRef, orderBy("createdAt", "desc"));
      } else {
        q = query(colRef, orderBy("name", "asc"));
      }

      unsubList = onSnapshot(q, (snap)=>{
        const items = snap.docs.map(d=> ({ id: d.id, ...d.data() }));
        renderList(items);
      }, (err)=>{
        console.error(err);
        updateConn(false, "리스트 에러");
      });
    }

    // 초기 탭/버튼
    setTab("film");

  </script>
</body>
</html>
