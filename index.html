<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>필름 관리 프로그램</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(145deg, #f9fafb, #f4f0ff, #fdf2f8);
      padding: 12px;
    }
    h1 {
      font-size: 22px;
      margin: 10px 0 14px;
      text-align: left;
      letter-spacing: 2px;
    }
    .header-row {
      max-width: 720px;
      margin: 0 auto 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .device-badge {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(228,231,255,0.95);
      color: #3f4464;
      white-space: nowrap;
    }

    .app-shell {
      max-width: 720px;
      margin: 0 auto;
    }

    .top-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .top-bar input[type="text"] {
      flex: 1;
      padding: 9px 11px;
      border-radius: 999px;
      border: 1px solid #d6d9ff;
      font-size: 14px;
      min-width: 0;
      background: rgba(255,255,255,0.9);
    }
    .btn {
      padding: 8px 11px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      transition: transform 0.05s ease, box-shadow 0.1s ease, background 0.1s ease;
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    .btn-primary {
      background: linear-gradient(135deg, #7f9dff, #b38cff);
      color: white;
      box-shadow: 0 4px 10px rgba(127,157,255,0.35);
    }
    .btn-secondary {
      background: rgba(228,231,255,0.9);
      color: #283252;
    }
    .btn-danger {
      background: #ff6b81;
      color: white;
    }
    .btn-small {
      font-size: 12px;
      padding: 5px 9px;
      border-radius: 999px;
    }

    .tools-bar {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .form-card {
      background: rgba(255,255,255,0.98);
      border-radius: 18px;
      padding: 12px 14px;
      margin-bottom: 12px;
      box-shadow: 0 8px 20px rgba(167, 173, 208, 0.35);
      border: 1px solid #e3e6ff;
    }
    .form-row {
      display: flex;
      flex-direction: column;
      margin-bottom: 9px;
    }
    .form-row label {
      font-size: 12px;
      margin-bottom: 4px;
      color: #5a5f80;
    }
    .form-row input[type="text"],
    .form-row input[type="date"],
    .form-row input[type="password"],
    .form-row select {
      padding: 7px 10px;
      border-radius: 10px;
      border: 1px solid #d6d9ff;
      font-size: 13px;
      background: #f9f9ff;
    }
    .form-row input[type="file"] {
      font-size: 12px;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 6px;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 40px;
    }

    .card {
      background: rgba(255,255,255,0.96);
      border-radius: 16px;
      padding: 10px;
      display: flex;
      gap: 10px;
      box-shadow: 0 6px 16px rgba(169, 177, 214, 0.35);
      align-items: flex-start;
      border: 1px solid #e3e6ff;
    }
    .card img {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 12px;
      background: #eef1ff;
      flex-shrink: 0;
      cursor: pointer;
    }
    .card-content {
      flex: 1;
      font-size: 13px;
    }
    .card-row-main {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 4px;
      align-items: center;
    }
    .card-title {
      font-weight: 600;
      font-size: 14px;
      color: #2f3559;
    }
    .card-tag {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      background: #f3e8ff;
      color: #5f308c;
      align-self: flex-start;
    }
    .card-row {
      margin-bottom: 2px;
    }
    .label {
      color: #8689a5;
      font-size: 11px;
      margin-right: 4px;
    }
    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
      gap: 6px;
      flex-wrap: wrap;
    }
    .last-used {
      font-size: 11px;
      color: #777b9e;
    }
    .card-buttons {
      display: flex;
      gap: 4px;
    }

    .empty-text {
      text-align: center;
      color: #777;
      font-size: 13px;
      margin-top: 20px;
    }

    .toggle-group {
      display: flex;
      gap: 6px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }
    .toggle-btn {
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid #d6d9ff;
      background: #f5f3ff;
      color: #464b73;
      cursor: pointer;
      transition: background 0.1s ease, color 0.1s ease, border 0.1s ease;
    }
    .toggle-btn.active {
      border-color: #7f9dff;
      background: #7f9dff;
      color: #fff;
    }

    .lock-screen {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(255,255,255,0.95), rgba(203,213,255,0.96));
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 1000;
    }
    .lock-card {
      width: 100%;
      max-width: 360px;
      background: rgba(255,255,255,0.98);
      border-radius: 20px;
      padding: 18px 18px 16px;
      box-shadow: 0 12px 28px rgba(136, 144, 195, 0.55);
      border: 1px solid #dde1ff;
      text-align: center;
    }
    .lock-title {
      font-size: 18px;
      margin-bottom: 8px;
      font-weight: 600;
      color: #303656;
    }
    .lock-sub {
      font-size: 12px;
      color: #7b7f9d;
      margin-bottom: 14px;
    }
    .lock-input-wrap {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    .lock-input-wrap input {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #d6d9ff;
      background: #f7f7ff;
      text-align: center;
      font-size: 14px;
      letter-spacing: 3px;
    }
    .lock-info {
      font-size: 11px;
      color: #9296b8;
    }

    .settings-section-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #3c4266;
    }
    .settings-help {
      font-size: 11px;
      color: #8a8fb0;
      margin-bottom: 6px;
    }

    /* 이미지 전체 보기 */
    .image-viewer {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1500;
    }
    .image-viewer-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.75);
    }
    .image-viewer-inner {
      position: relative;
      max-width: 100%;
      max-height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    #viewerImage {
      max-width: 100%;
      max-height: 100%;
      border-radius: 12px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.5);
      touch-action: none;
    }
    .viewer-close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      border-radius: 999px;
      border: none;
      padding: 6px 10px;
      font-size: 14px;
      cursor: pointer;
      background: rgba(15,23,42,0.8);
      color: #f9fafb;
    }

    @media (min-width: 768px) {
      body { padding-top: 24px; }
    }
  </style>
</head>
<body>
  <!-- 잠금 화면 -->
  <div id="lockScreen" class="lock-screen">
    <div class="lock-card">
      <div class="lock-title">필름 관리 잠금</div>
      <div class="lock-sub">비밀번호를 입력하면<br>탭을 닫기 전까지는 계속 열려 있어.</div>
      <div class="lock-input-wrap">
        <input type="password" id="passwordInput" maxlength="20" placeholder="••••" />
        <button class="btn btn-primary btn-small" id="passwordBtn">입장</button>
      </div>
      <div class="lock-info">※ 비밀번호는 이 기기/브라우저에만 저장되는 간단 잠금이야.</div>
    </div>
  </div>

  <!-- 이미지 전체보기 뷰어 -->
  <div id="imageViewer" class="image-viewer">
    <div class="image-viewer-backdrop" id="viewerBackdrop"></div>
    <div class="image-viewer-inner">
      <img id="viewerImage" src="" alt="필름 이미지" />
      <button id="closeViewerBtn" class="viewer-close-btn">✕</button>
    </div>
  </div>

  <!-- 실제 앱 내용 -->
  <div id="appContainer" style="display:none;">
    <div class="header-row">
      <h1>필름 관리</h1>
      <div id="deviceBadge" class="device-badge"></div>
    </div>

    <div class="app-shell">
      <div class="top-bar">
        <input type="text" id="searchInput" placeholder="제품명 / 필름번호 / 제판방식 / 위치 / 제판방법 검색" />
        <button class="btn btn-primary" id="newFilmBtn">+ 새 필름</button>
      </div>

      <div class="tools-bar">
        <button class="btn btn-secondary btn-small" id="settingsBtn">⚙ 설정</button>
        <button class="btn btn-secondary btn-small" id="exportBtn">데이터 내보내기</button>
        <button class="btn btn-secondary btn-small" id="importBtn">데이터 불러오기</button>
        <input type="file" id="importFile" accept="application/json" style="display:none;" />
      </div>

      <!-- 설정 카드 -->
      <div class="form-card" id="settingsCard" style="display:none;">
        <div class="form-row">
          <div class="settings-section-title">이 기기 이름</div>
          <div class="settings-help">예: 가은폰, 성규폰, 회사컴. 이 기기에서만 표시돼.</div>
          <input type="text" id="deviceNameInput" placeholder="기기 이름을 입력하세요" />
        </div>
        <div class="form-row">
          <div class="settings-section-title">기본 정렬 방식</div>
          <div class="settings-help">리스트를 어떤 기준으로 정렬할지 선택해.</div>
          <select id="sortOptionSelect">
            <option value="updated">최근 수정순</option>
            <option value="name">제품명 가나다순</option>
            <option value="number">필름번호 순</option>
            <option value="lastUsed">마지막 사용일 최신순</option>
          </select>
        </div>
        <div class="form-row">
          <div class="settings-section-title">비밀번호 변경</div>
          <div class="settings-help">현재 비밀번호와 새 비밀번호를 입력해.</div>
          <input type="password" id="currentPwInput" placeholder="현재 비밀번호" />
          <input type="password" id="newPwInput" placeholder="새 비밀번호" style="margin-top:6px;" />
          <input type="password" id="newPwConfirmInput" placeholder="새 비밀번호 확인" style="margin-top:6px;" />
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary btn-small" id="closeSettingsBtn">닫기</button>
          <button type="button" class="btn btn-primary btn-small" id="saveSettingsBtn">저장</button>
        </div>
      </div>

      <!-- 필름 입력 폼 -->
      <div class="form-card" id="formCard" style="display:none;">
        <form id="filmForm">
          <input type="hidden" id="filmId" />
          <div class="form-row">
            <label for="productName">제품 이름 *</label>
            <input type="text" id="productName" required />
          </div>
          <div class="form-row">
            <label for="filmNumber">필름 번호 *</label>
            <input type="text" id="filmNumber" required />
          </div>
          <div class="form-row">
            <label for="method">제판 방식</label>
            <input type="text" id="method" placeholder="예: 바탕, 문자, 스모그 등" />
          </div>

          <div class="form-row">
            <label>필름 제판 방법</label>
            <div class="toggle-group" data-group="frontBack">
              <button type="button" class="toggle-btn" data-value="전면">전면</button>
              <button type="button" class="toggle-btn" data-value="배면">배면</button>
            </div>
            <div class="toggle-group" data-group="leftRight">
              <button type="button" class="toggle-btn" data-value="좌">좌</button>
              <button type="button" class="toggle-btn" data-value="우">우</button>
            </div>
            <div class="toggle-group" data-group="upDown">
              <button type="button" class="toggle-btn" data-value="상">상</button>
              <button type="button" class="toggle-btn" data-value="하">하</button>
            </div>
            <small style="font-size:11px; color:#7b7f9d;">
              전면/배면 + 좌/우 + 상/하 조합 (예: 배면 좌상, 전면 우하 등)
            </small>
          </div>

          <div class="form-row">
            <label for="location">필름 위치</label>
            <input type="text" id="location" placeholder="예: A-3 서랍, 4층 우측 랙 등" />
          </div>
          <div class="form-row">
            <label for="lastUsed">마지막 사용일</label>
            <div style="display:flex; gap:6px;">
              <input type="date" id="lastUsed" style="flex:1;" />
              <button type="button" class="btn btn-secondary btn-small" id="setTodayBtn">오늘</button>
            </div>
          </div>
          <div class="form-row">
            <label for="imageInput">필름 사진 (선택)</label>
            <input type="file" id="imageInput" accept="image/*" />
            <small style="font-size:11px; color:#7b7f9d;">
              · 새 필름에는 사진을 추가하고,<br/>
              · 수정 시 사진을 바꾸고 싶을 때만 다시 선택하세요.
            </small>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="cancelBtn">취소</button>
            <button type="submit" class="btn btn-primary" id="saveBtn">저장</button>
          </div>
        </form>
      </div>

      <div id="list" class="list"></div>
      <div id="emptyText" class="empty-text" style="display:none;">
        등록된 필름이 없습니다.<br/>오른쪽 위 <b>+ 새 필름</b> 버튼으로 추가하세요.
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <script>
    // ---- Firebase 설정 ----
    const firebaseConfig = {
      apiKey: "AIzaSyBrBnVuXca2Ou1oMFOLzq3KGEN8xiK5L_U",
      authDomain: "film-find-5242d.firebaseapp.com",
      projectId: "film-find-5242d",
      storageBucket: "film-find-5242d.firebasestorage.app",
      messagingSenderId: "185123433624",
      appId: "1:185123433624:web:269eb9b4b6437887f2f4ed",
      measurementId: "G-V9KL8XS9KJ"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ---- 키/설정 ----
    const DEFAULT_PASSWORD = "1234";
    const PASSWORD_KEY = "filmAppPassword";
    const UNLOCK_KEY   = "filmAppUnlocked";
    const DEVICE_KEY   = "filmDeviceLabel";
    const SORT_KEY     = "filmSortOption";

    let films = [];
    let editingId = null;
    let currentSearchText = "";

    function getCurrentPassword() {
      return localStorage.getItem(PASSWORD_KEY) || DEFAULT_PASSWORD;
    }
    function setCurrentPassword(pw) {
      localStorage.setItem(PASSWORD_KEY, pw);
    }
    function getSortOption() {
      return localStorage.getItem(SORT_KEY) || "updated";
    }
    function setSortOption(opt) {
      localStorage.setItem(SORT_KEY, opt);
    }
    function getDeviceLabel() {
      return localStorage.getItem(DEVICE_KEY) || "";
    }
    function setDeviceLabel(label) {
      localStorage.setItem(DEVICE_KEY, label);
      const badge = document.getElementById("deviceBadge");
      if (badge) badge.textContent = label || "";
    }

    function formatDate(iso) {
      if (!iso) return "-";
      return iso;
    }

    // ---- Firestore 로딩 ----
    async function loadFilmsFromServer() {
      try {
        const snapshot = await db.collection("films").get(); // 전체 가져오기
        films = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
      } catch (e) {
        console.error("불러오기 실패:", e);
        alert("서버에서 데이터를 불러오는 중 오류가 났어: " + e.message);
      }
    }

    // 최근 수정된 필름 하나
    function getLastFilmForDefaults() {
      if (!films.length) return null;
      return films.reduce((acc, cur) => {
        const a = acc.updatedAt || acc.createdAt || 0;
        const b = cur.updatedAt || cur.createdAt || 0;
        return b > a ? cur : acc;
      });
    }

    // ---- 리스트 렌더 ----
    function renderList(filterText = "") {
      const listEl = document.getElementById("list");
      const emptyText = document.getElementById("emptyText");
      listEl.innerHTML = "";

      const text = (filterText || "").trim().toLowerCase();
      currentSearchText = filterText || "";

      let filtered = films.filter(f => {
        if (!text) return true;
        const combined =
          (f.productName || "") + " " +
          (f.filmNumber || "") + " " +
          (f.method || "") + " " +
          (f.location || "") + " " +
          (f.plateInfo || "");
        return combined.toLowerCase().includes(text);
      });

      const sortOpt = getSortOption();
      filtered = filtered.slice().sort((a, b) => {
        if (sortOpt === "name") {
          return (a.productName || "").localeCompare(b.productName || "", "ko");
        } else if (sortOpt === "number") {
          return (a.filmNumber || "").localeCompare(b.filmNumber || "", "ko");
        } else if (sortOpt === "lastUsed") {
          const la = a.lastUsed || "";
          const lb = b.lastUsed || "";
          return (lb || "").localeCompare(la || "");
        } else {
          const atA = a.updatedAt || a.createdAt || 0;
          const atB = b.updatedAt || b.createdAt || 0;
          return atB - atA;
        }
      });

      if (filtered.length === 0) {
        emptyText.style.display = "block";
        return;
      } else {
        emptyText.style.display = "none";
      }

      filtered.forEach(film => {
        const card = document.createElement("div");
        card.className = "card";

        const img = document.createElement("img");
        if (film.imageDataUrl) {
          img.src = film.imageDataUrl;
          img.addEventListener("click", () => openImageViewer(film.imageDataUrl));
        } else {
          img.alt = "이미지 없음";
        }
        card.appendChild(img);

        const content = document.createElement("div");
        content.className = "card-content";

        const rowMain = document.createElement("div");
        rowMain.className = "card-row-main";
        const title = document.createElement("div");
        title.className = "card-title";
        title.textContent = film.productName || "(제품명 없음)";
        const tag = document.createElement("div");
        tag.className = "card-tag";
        tag.textContent = film.filmNumber || "번호 없음";
        rowMain.appendChild(title);
        rowMain.appendChild(tag);
        content.appendChild(rowMain);

        const rowMethod = document.createElement("div");
        rowMethod.className = "card-row";
        rowMethod.innerHTML = '<span class="label">제판방식</span>' + (film.method || "-");
        content.appendChild(rowMethod);

        const rowPlate = document.createElement("div");
        rowPlate.className = "card-row";
        rowPlate.innerHTML = '<span class="label">제판 방법</span>' + (film.plateInfo || "-");
        content.appendChild(rowPlate);

        const rowLoc = document.createElement("div");
        rowLoc.className = "card-row";
        rowLoc.innerHTML = '<span class="label">필름 위치</span>' + (film.location || "-");
        content.appendChild(rowLoc);

        const footer = document.createElement("div");
        footer.className = "card-footer";

        const lastUsed = document.createElement("div");
        lastUsed.className = "last-used";
        lastUsed.textContent = "마지막 사용일: " + formatDate(film.lastUsed || "");
        footer.appendChild(lastUsed);

        const btnWrap = document.createElement("div");
        btnWrap.className = "card-buttons";

        const useTodayBtn = document.createElement("button");
        useTodayBtn.className = "btn btn-secondary btn-small";
        useTodayBtn.textContent = "오늘 사용";
        useTodayBtn.addEventListener("click", async () => {
          try {
            const today = new Date().toISOString().slice(0, 10);
            await db.collection("films").doc(film.id).set({
              lastUsed: today,
              updatedAt: Date.now()
            }, { merge: true });
            await loadFilmsFromServer();
            renderList(currentSearchText);
          } catch (e) {
            console.error(e);
            alert("업데이트 중 오류: " + e.message);
          }
        });

        const copyBtn = document.createElement("button");
        copyBtn.className = "btn btn-secondary btn-small";
        copyBtn.textContent = "복사";
        copyBtn.addEventListener("click", () => openFormCopyFrom(film.id));

        const editBtn = document.createElement("button");
        editBtn.className = "btn btn-primary btn-small";
        editBtn.textContent = "수정";
        editBtn.addEventListener("click", () => openFormForEdit(film.id));

        const delBtn = document.createElement("button");
        delBtn.className = "btn btn-danger btn-small";
        delBtn.textContent = "삭제";
        delBtn.addEventListener("click", async () => {
          if (!confirm("이 필름 정보를 삭제할까요?")) return;
          try {
            await db.collection("films").doc(film.id).delete();
            await loadFilmsFromServer();
            renderList(currentSearchText);
          } catch (e) {
            console.error(e);
            alert("삭제 중 오류: " + e.message);
          }
        });

        btnWrap.appendChild(useTodayBtn);
        btnWrap.appendChild(copyBtn);
        btnWrap.appendChild(editBtn);
        btnWrap.appendChild(delBtn);

        footer.appendChild(btnWrap);
        content.appendChild(footer);

        card.appendChild(content);
        listEl.appendChild(card);
      });
    }

    // ---- 제판 방법 토글 ----
    function clearPlateInfoForm() {
      document.querySelectorAll(".toggle-btn").forEach(btn => btn.classList.remove("active"));
    }

    function setPlateInfoToForm(str) {
      clearPlateInfoForm();
      if (!str) return;
      const parts = str.split(" ");
      document.querySelectorAll(".toggle-btn").forEach(btn => {
        if (parts.includes(btn.dataset.value)) btn.classList.add("active");
      });
    }

    function getPlateInfoFromForm() {
      const groups = document.querySelectorAll(".toggle-group");
      const values = [];
      groups.forEach(group => {
        const active = group.querySelector(".toggle-btn.active");
        if (active) values.push(active.dataset.value);
      });
      return values.join(" ");
    }

    // ---- 폼 ----
    function resetForm() {
      document.getElementById("filmId").value = "";
      document.getElementById("productName").value = "";
      document.getElementById("filmNumber").value = "";
      document.getElementById("method").value = "";
      document.getElementById("location").value = "";
      document.getElementById("lastUsed").value = "";
      document.getElementById("imageInput").value = "";
      clearPlateInfoForm();
      editingId = null;
    }

    function openFormNew() {
      resetForm();
      const last = getLastFilmForDefaults();
      if (last) {
        document.getElementById("method").value = last.method || "";
        document.getElementById("location").value = last.location || "";
        setPlateInfoToForm(last.plateInfo || "");
      }
      document.getElementById("formCard").style.display = "block";
      document.getElementById("productName").focus();
    }

    function openFormCopyFrom(id) {
      const film = films.find(f => f.id === id);
      if (!film) return;
      resetForm();
      document.getElementById("productName").value = film.productName || "";
      document.getElementById("filmNumber").value = "";
      document.getElementById("method").value = film.method || "";
      document.getElementById("location").value = film.location || "";
      document.getElementById("lastUsed").value = "";
      setPlateInfoToForm(film.plateInfo || "");
      document.getElementById("formCard").style.display = "block";
      document.getElementById("productName").focus();
    }

    function openFormForEdit(id) {
      const film = films.find(f => f.id === id);
      if (!film) return;
      editingId = id;
      document.getElementById("filmId").value = film.id;
      document.getElementById("productName").value = film.productName || "";
      document.getElementById("filmNumber").value = film.filmNumber || "";
      document.getElementById("method").value = film.method || "";
      document.getElementById("location").value = film.location || "";
      document.getElementById("lastUsed").value = film.lastUsed || "";
      document.getElementById("imageInput").value = "";
      setPlateInfoToForm(film.plateInfo || "");
      document.getElementById("formCard").style.display = "block";
      document.getElementById("productName").focus();
    }

    function closeForm() {
      document.getElementById("formCard").style.display = "none";
      resetForm();
    }

    // ---- 이미지 압축 ----
    function compressImage(dataUrl, callback) {
      const img = new Image();
      img.onload = function () {
        const maxSize = 700;
        let w = img.width;
        let h = img.height;
        const ratio = Math.min(maxSize / w, maxSize / h, 1);
        w = Math.round(w * ratio);
        h = Math.round(h * ratio);

        const canvas = document.createElement("canvas");
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, w, h);
        const compressed = canvas.toDataURL("image/jpeg", 0.7);
        callback(compressed);
      };
      img.onerror = () => callback(dataUrl);
      img.src = dataUrl;
    }

    // ---- 저장 ----
    async function saveFilmFromForm(event) {
      if (event) event.preventDefault();

      const id = document.getElementById("filmId").value || null;
      const productName = document.getElementById("productName").value.trim();
      const filmNumber = document.getElementById("filmNumber").value.trim();
      const method = document.getElementById("method").value.trim();
      const location = document.getElementById("location").value.trim();
      const lastUsed = document.getElementById("lastUsed").value || "";
      const plateInfo = getPlateInfoFromForm();
      const imageInput = document.getElementById("imageInput");

      if (!productName || !filmNumber) {
        alert("제품 이름과 필름 번호는 필수입니다.");
        return;
      }

      let existingFilm = null;
      if (id) existingFilm = films.find(f => f.id === id) || null;

      const baseData = { productName, filmNumber, method, location, lastUsed, plateInfo };

      async function finalizeSave(imageDataUrl) {
        try {
          if (id && existingFilm) {
            const payload = {
              ...existingFilm,
              ...baseData,
              updatedAt: Date.now()
            };
            if (imageDataUrl !== null) payload.imageDataUrl = imageDataUrl;
            delete payload.id;
            await db.collection("films").doc(id).set(payload);
          } else {
            const payload = {
              ...baseData,
              imageDataUrl: imageDataUrl || "",
              createdAt: Date.now(),
              updatedAt: Date.now()
            };
            await db.collection("films").add(payload);
          }

          await loadFilmsFromServer();
          alert("저장되었습니다.");
          closeForm();
          renderList(currentSearchText);
        } catch (e) {
          console.error(e);
          alert("저장 중 오류: " + e.message);
        }
      }

      if (imageInput.files && imageInput.files[0]) {
        const file = imageInput.files[0];
        const reader = new FileReader();
        reader.onload = function (e) {
          const originalDataUrl = e.target.result;
          compressImage(originalDataUrl, (compressedDataUrl) => {
            finalizeSave(compressedDataUrl);
          });
        };
        reader.readAsDataURL(file);
      } else {
        finalizeSave(id && existingFilm ? null : "");
      }
    }

    // ---- 데이터 내보내기 / 불러오기 (Firestore와 동기화) ----
    function exportData() {
      const json = JSON.stringify(films, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const date = new Date().toISOString().slice(0,10).replace(/-/g,"");
      a.href = url;
      a.download = "films_" + date + ".json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function importData(file) {
      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (!Array.isArray(data)) {
            alert("형식이 올바르지 않은 파일입니다.");
            return;
          }
          for (const f of data) {
            const docId = f.id || null;
            const payload = { ...f };
            delete payload.id;
            if (!payload.createdAt) payload.createdAt = Date.now();
            if (!payload.updatedAt) payload.updatedAt = Date.now();
            if (docId) {
              await db.collection("films").doc(docId).set(payload, { merge:true });
            } else {
              await db.collection("films").add(payload);
            }
          }
          await loadFilmsFromServer();
          renderList(currentSearchText);
          alert("데이터를 불러왔습니다.");
        } catch (err) {
          console.error(err);
          alert("파일을 읽는 중 오류가 발생했습니다: " + err.message);
        }
      };
      reader.readAsText(file, "utf-8");
    }

    // ---- 설정 처리 ----
    function openSettings() {
      const card = document.getElementById("settingsCard");
      card.style.display = "block";
      document.getElementById("deviceNameInput").value = getDeviceLabel();
      document.getElementById("sortOptionSelect").value = getSortOption();
      document.getElementById("currentPwInput").value = "";
      document.getElementById("newPwInput").value = "";
      document.getElementById("newPwConfirmInput").value = "";
    }
    function closeSettings() {
      document.getElementById("settingsCard").style.display = "none";
    }

    function saveSettings() {
      const deviceName = document.getElementById("deviceNameInput").value.trim();
      const sortOpt = document.getElementById("sortOptionSelect").value;
      const currentPw = document.getElementById("currentPwInput").value;
      const newPw = document.getElementById("newPwInput").value;
      const newPw2 = document.getElementById("newPwConfirmInput").value;

      setDeviceLabel(deviceName);
      setSortOption(sortOpt);

      if (newPw || newPw2 || currentPw) {
        if (currentPw !== getCurrentPassword()) {
          alert("현재 비밀번호가 올바르지 않습니다.");
          return;
        }
        if (!newPw) {
          alert("새 비밀번호를 입력해 주세요.");
          return;
        }
        if (newPw !== newPw2) {
          alert("새 비밀번호가 서로 다릅니다.");
          return;
        }
        if (newPw.length < 4) {
          alert("비밀번호는 4글자 이상으로 설정해 주세요.");
          return;
        }
        setCurrentPassword(newPw);
        alert("비밀번호가 변경되었습니다.");
      } else {
        alert("설정이 저장되었습니다.");
      }

      closeSettings();
      renderList(currentSearchText);
    }

    // ---- 이미지 뷰어 ----
    let viewerScale = 1;
    let viewerStartDist = 0;
    let viewerLastScale = 1;
    let viewerTransX = 0;
    let viewerTransY = 0;
    let panStartX = 0;
    let panStartY = 0;
    let isPanning = false;

    function resetViewerTransform() {
      viewerScale = 1;
      viewerTransX = 0;
      viewerTransY = 0;
      viewerStartDist = 0;
      viewerLastScale = 1;
      isPanning = false;
      const img = document.getElementById("viewerImage");
      img.style.transform = "translate(0px, 0px) scale(1)";
    }

    function updateViewerTransform() {
      const img = document.getElementById("viewerImage");
      img.style.transform = "translate(" + viewerTransX + "px, " + viewerTransY + "px) scale(" + viewerScale + ")";
    }

    function openImageViewer(src) {
      if (!src) return;
      const viewer = document.getElementById("imageViewer");
      const img = document.getElementById("viewerImage");
      img.src = src;
      resetViewerTransform();
      viewer.style.display = "flex";
    }

    function closeImageViewer() {
      const viewer = document.getElementById("imageViewer");
      viewer.style.display = "none";
    }

    function initImageViewerTouch() {
      const img = document.getElementById("viewerImage");
      const viewer = document.getElementById("imageViewer");

      viewer.addEventListener("click", (e) => {
        if (e.target.id === "viewerBackdrop") {
          closeImageViewer();
        }
      });

      img.addEventListener("touchstart", (e) => {
        if (e.touches.length === 2) {
          e.preventDefault();
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          viewerStartDist = Math.sqrt(dx*dx + dy*dy);
          viewerLastScale = viewerScale;
        } else if (e.touches.length === 1 && viewerScale > 1) {
          isPanning = true;
          panStartX = e.touches[0].clientX - viewerTransX;
          panStartY = e.touches[0].clientY - viewerTransY;
        }
      }, { passive: false });

      img.addEventListener("touchmove", (e) => {
        if (e.touches.length === 2) {
          e.preventDefault();
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          const dist = Math.sqrt(dx*dx + dy*dy);
          if (viewerStartDist > 0) {
            let scale = viewerLastScale * (dist / viewerStartDist);
            if (scale < 1) scale = 1;
            if (scale > 4) scale = 4;
            viewerScale = scale;
            updateViewerTransform();
          }
        } else if (e.touches.length === 1 && isPanning) {
          e.preventDefault();
          viewerTransX = e.touches[0].clientX - panStartX;
          viewerTransY = e.touches[0].clientY - panStartY;
          updateViewerTransform();
        }
      }, { passive: false });

      img.addEventListener("touchend", (e) => {
        if (e.touches.length < 2) {
          viewerStartDist = 0;
          viewerLastScale = viewerScale;
        }
        if (e.touches.length === 0) {
          isPanning = false;
        }
      });
    }

    // ---- 앱 초기화 ----
    async function initApp() {
      setDeviceLabel(getDeviceLabel());
      document.getElementById("sortOptionSelect").value = getSortOption();

      await loadFilmsFromServer();
      renderList("");

      document.getElementById("newFilmBtn").addEventListener("click", openFormNew);
      document.getElementById("cancelBtn").addEventListener("click", closeForm);
      document.getElementById("filmForm").addEventListener("submit", saveFilmFromForm);
      document.getElementById("saveBtn").addEventListener("click", saveFilmFromForm);
      document.getElementById("searchInput").addEventListener("input", (e) => {
        renderList(e.target.value);
      });
      document.getElementById("setTodayBtn").addEventListener("click", () => {
        const today = new Date().toISOString().slice(0, 10);
        document.getElementById("lastUsed").value = today;
      });

      document.querySelectorAll(".toggle-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const group = btn.closest(".toggle-group");
          group.querySelectorAll(".toggle-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
        });
      });

      document.getElementById("exportBtn").addEventListener("click", exportData);
      document.getElementById("importBtn").addEventListener("click", () => {
        document.getElementById("importFile").click();
      });
      document.getElementById("importFile").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) importData(file);
        e.target.value = "";
      });

      document.getElementById("settingsBtn").addEventListener("click", openSettings);
      document.getElementById("closeSettingsBtn").addEventListener("click", closeSettings);
      document.getElementById("saveSettingsBtn").addEventListener("click", saveSettings);

      document.getElementById("closeViewerBtn").addEventListener("click", closeImageViewer);
      initImageViewerTouch();
    }

    // ---- 잠금 화면 ----
    document.addEventListener("DOMContentLoaded", () => {
      const lockScreen = document.getElementById("lockScreen");
      const appContainer = document.getElementById("appContainer");
      const pwInput = document.getElementById("passwordInput");
      const pwBtn = document.getElementById("passwordBtn");

      async function unlock() {
        const v = pwInput.value.trim();
        if (v === getCurrentPassword()) {
          sessionStorage.setItem(UNLOCK_KEY, "true");
          lockScreen.style.display = "none";
          appContainer.style.display = "block";
          if (!window._filmAppInitialized) {
            await initApp();
            window._filmAppInitialized = true;
          }
        } else {
          alert("비밀번호가 틀렸어.");
          pwInput.focus();
          pwInput.select();
        }
      }

      const unlocked = sessionStorage.getItem(UNLOCK_KEY) === "true";
      if (unlocked) {
        lockScreen.style.display = "none";
        appContainer.style.display = "block";
        initApp().then(() => { window._filmAppInitialized = true; });
      } else {
        lockScreen.style.display = "flex";
        appContainer.style.display = "none";
      }

      pwBtn.addEventListener("click", unlock);
      pwInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") unlock();
      });
    });
  </script>
</body>
</html>
